import{r as U,j as fo}from"./vendor-react-JYPVbgc1-0.2.11.js";import{$ as Ct}from"./vendor-webrtc-BBsnVRmn-0.2.11.js";import{d as Sa,e as po}from"./vendor-BPR6uEV2-0.2.11.js";var De=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(De||{}),er=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(er||{});const yo={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365235/SYN_IP_DEPT_AGENT_pbvh9e.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_TACTICAL_AGENT_vquxfm.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_PATROL_AGENT_nlyneg.webp",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_RIOT_AGENT_i4lk5m.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_THREAT_ANALYST_uqxbsp.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367440/HERO_Mr._Pearl_Director_of_BioSynch_lsesol.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_RECKLESS_PROVOCATEUR_wvfdcr.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_DATA_LIBERATOR_qeru3j.webp",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_CAUTIOUS_AVENGER_xzk6pd.webp",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_VIGILANT_SPOTTER_xo8ig7.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_INVENTIVE_MAKER_sicb73.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367436/HERO_Finn_c8637x.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_FABER_cr804w.webp",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365250/OPT_CENSOR_w4qijk.webp",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_PRINCEPS_aaqakx.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_IMMUNIS_hvlxhi.webp",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_CENTURION_grztbi.webp",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367435/HERO_Lucius_The_Immortal_irhhaj.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_CODE_KEEPER_yhowqj.webp",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_DEVOUT_SYNTHETIC_nkr1tx.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_UNWAVERING_INTEGRATOR_g1cbag.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_SIGNAL_PROPHET_rmk9me.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_ZEALOUS_MISSIONARY_v7qjhw.webp",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367438/HERO_Reverend_of_The_Choir_njrrih.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365196/CMD_OVERWATCH_djwlqo.webp",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_REPOSITIONING_uhwvrk.webp",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_INSPIRATION_v0bi3l.webp",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_DATA_INTERCEPTION_gen1qw.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_FALSE_ORDERS_aatcmc.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367418/CMD_Experimental_Stimulants_plsnet.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367415/CMD_Logistics_Chain_odmwxq.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367414/CMD_Quick_Response_Team_xff2yt.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367411/CMD_Temporary_Shelter_podjbj.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367413/CMD_Enhanced_Interrogation_legiod.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367446/N_Autonomous_Battle_Robot_Gawain_oni745.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Reclaimed_Gawain_sjmlsp.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Secret_informant_w0w6g5.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367432/HERO_Michael_Falk_sv5i5c.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367434/HERO_Edith_Byron_ny23vb.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367429/HERO_Pinkunoneko_cqhpuy.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367431/HERO_Maria_Eleftheria_Damanaki_cpw12i.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367428/HERO_Zius_xhuyxa.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},ho={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_RECON_DRONE_w3elir.webp",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_WALKING_TURRET_c0mttm.webp",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},mo={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365400/Aim_qzeaqn.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365398/Exploit_pf2zwf.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Revealed_lsan64.webp",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand and face-down cards on board.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board-facedown","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365403/Stun_pbe7ex.webp",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Shield_yilhdt.webp",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365402/Support_hxzufw.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771368527/Threat_dqnnsq.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365394/Resurrected_awaucv.webp",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},Io=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],Ut={cardDatabase:yo,tokenDatabase:ho,countersDatabase:mo,deckFiles:Io};let ya=null,nt=new Map,Jt=new Map,Tt={},kt=[],Xt={};const Ca=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function li(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const a=await fetch("/api/content/database");if(a.ok){const r=await a.json(),n=r.cards.map(([o,s])=>[o,s]),i=r.tokens.map(([o,s])=>[o,s]);e={cardDatabase:Object.fromEntries(n),tokenDatabase:Object.fromEntries(i),countersDatabase:Object.fromEntries(r.counters),deckFiles:r.deckFiles}}else e=Ut}catch{e=Ut}else e=Ut;ya=e,nt=new Map(Object.entries(e.cardDatabase)),Jt=new Map(Object.entries(e.tokenDatabase)),Tt=e.countersDatabase,kt=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(Tt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(a){console.warn("Could not save counters database to localStorage:",a)}Fe=ya,tr=nt,To=Jt,st=Tt,go=kt,Xt=Eo(),wo=Xt}catch(e){throw console.error("Failed to load content database:",e),e}}function Eo(){const e={};for(const t of kt){const a=[];for(const r of t.cards){const n=nt.get(r.cardId);if(!n){console.warn(`Card definition not found for ID: ${r.cardId} in deck: ${t.name}`);continue}const i=Ca.has(r.cardId);for(let o=0;o<r.quantity;o++){const d=r.cardId.replace(/-/g,"--DASH--").toUpperCase();i?a.push({...n,deck:De.Command,id:`CMD_${d}_${o+1}`,baseId:r.cardId,faction:n.faction||"Command"}):a.push({...n,deck:t.id,id:`${t.id.substring(0,3).toUpperCase()}_${d}_${o+1}`,baseId:r.cardId,faction:n.faction||t.id})}}e[t.id]=a}return e[De.Tokens]=Array.from(Jt.entries()).map(([t,a])=>{const r=a.types?[...a.types]:[];return{id:`TKN_${a.name.toUpperCase().replace(/\s/g,"_")}`,baseId:t,deck:De.Tokens,name:a.name,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage,power:a.power,ability:a.ability,color:a.color,types:r,flavorText:a.flavorText,faction:"Tokens"}}),e}let Fe=null,tr=new Map,To=new Map,st={};try{const e=localStorage.getItem("counters_database");e&&(Tt=JSON.parse(e),st=Tt)}catch{}let go=[],wo={};const _o=Ca,ui=()=>kt.filter(e=>e.isSelectable);function Ye(e){return nt.get(e)}function $t(e){return Array.from(nt.values()).find(t=>t.name===e)}function fi(){return Array.from(nt.entries()).map(([e,t])=>({id:e,card:t}))}function pi(){return nt}function Da(){return Xt}const bo=4,yi={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/medal_tavarc.webp"},hi={[De.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[De.Hoods]:{prefix:"HOO",color:"border-purple-500"},[De.Optimates]:{prefix:"OPT",color:"border-red-500"},[De.Fusion]:{prefix:"FUS",color:"border-green-400"},[De.Command]:{prefix:"CMD",color:"border-yellow-500"},[De.Tokens]:{prefix:"TKN",color:"border-gray-400"},[De.Custom]:{prefix:"CUS",color:"border-purple-400"},[De.Neutral]:{prefix:"NEU",color:"border-gray-400"},[De.Random]:{prefix:"RND",color:"border-gray-400"}},mi={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},Ao={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},Ii={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},pt=["blue","purple","red","green","yellow","orange","pink","brown"],Ei=["Setup","Main","Commit","Scoring"],Dt=()=>Object.fromEntries(Object.entries(st).map(([e,t])=>[e,t.imageUrl])),Ti=new Proxy({},{get(e,t){return Dt()[t]},ownKeys(){return Object.keys(Dt())},has(e,t){return t in Dt()},getOwnPropertyDescriptor(e,t){const a=Dt()[t];return a!==void 0?{enumerable:!0,configurable:!0,value:a}:void 0}}),Rt=()=>Object.fromEntries(Object.entries(st).map(([e,t])=>[e,t.description])),gi=new Proxy({},{get(e,t){return Rt()[t]},ownKeys(){return Object.keys(Rt())},has(e,t){return t in Rt()},getOwnPropertyDescriptor(e,t){const a=Rt()[t];return a!==void 0?{enumerable:!0,configurable:!0,value:a}:void 0}}),So=()=>Object.entries(st).filter(([e,t])=>e!=="Resurrected"&&(!t.allowedPanels||t.allowedPanels.includes("COUNTER_PANEL"))).sort(([,e],[,t])=>e.sortOrder-t.sortOrder).map(([e,t])=>({type:e,label:t.name}));So();const Ve="readyDeploy",$e="readySetup",He="readyCommit",Re=(e,t,a)=>e.statuses?e.statuses.some(r=>r.type===t&&(a===void 0||r.addedByPlayerId===a)):!1,xe=(e,t)=>e.statuses?e.statuses.some(a=>a.type===t):!1,Co=(e,t,a)=>a===1&&xe(e,$e),Do=(e,t,a,r,n)=>!!(a&&xe(e,Ve)||t===1&&r&&xe(e,$e)||t===3&&n&&xe(e,He)),Ht=e=>{e.statuses&&(e.statuses=e.statuses.filter(t=>t.type!==Ve&&t.type!==$e&&t.type!==He))},et=(e,t,a,r)=>Math.abs(e-a)+Math.abs(t-r)===1,Ro=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,t,a,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:a})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,t,a,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>{var i;return n.ownerId!==a&&((i=n.statuses)==null?void 0:i.some(o=>o.type==="Threat"))}},sourceCard:e,sourceCoords:r})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.ownerId!==a&&Re(n,"Exploit",a)}})},{baseId:"centurion",activationType:"commit",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(n,i,o)=>{var s;return n.ownerId===a&&((s=n.types)==null?void 0:s.includes("Unit"))&&i!==void 0&&o!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:r,payload:{filter:(n,i,o)=>et(i,o,r.row,r.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.id===e.id?!1:n.ownerId===a}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:r,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,originalOwnerId:a,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:n=>n.ownerId===a}})},{baseId:"censor",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:r,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,t,a,r)=>Re(e,"Support",a)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:r,payload:{filter:(n,i)=>et(n,i,r.row,r.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(n,i,o)=>et(i,o,r.row,r.col)&&n.ownerId!==a&&(Re(n,"Threat",a)||Re(n,"Stun",a))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,t,a,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>n.ownerId===a&&Re(n,"Support",a)},sourceCard:e,sourceCoords:r})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.ownerId===a&&Re(n,"Exploit",a)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:r,payload:{filter:n=>Re(n,"Exploit",a)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"MODIFY_POWER",amount:-1,filter:n=>Re(n,"Aim",a)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:r,payload:{allowSelf:!1,range:1,filter:(n,i,o)=>{const s=et(i,o,r.row,r.col),d=n.ownerId!==a;return s&&d}}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"REVEAL_ENEMY",sourceCard:e,sourceCoords:r,payload:{filter:(n,i,o)=>{var m;const s=et(i,o,r.row,r.col),d=n.ownerId!==a,l=n.deck==="Tokens"||((m=n.types)==null?void 0:m.includes("Token"));return s&&d&&!l}}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(n,i,o)=>et(i,o,r.row,r.col)&&n.ownerId!==a&&(Re(n,"Threat",a)||Re(n,"Stun",a))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,t,a,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:a})},{baseId:"edithByron",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(n,i,o)=>et(i,o,r.row,r.col)&&(Re(n,"Threat",a)||Re(n,"Stun",a)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:r,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,t,a,r)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:r,ownerId:a})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"LUCIUS_SETUP",filter:n=>n.ownerId===a}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.ownerId===a,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,t,a,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:r})}],rr=e=>{const t=e.baseId||"";return Ro.filter(a=>{var r;return a.baseId===t||((r=a.baseIdAlt)==null?void 0:r.includes(t))})},Po=e=>{const a=rr(e).map(r=>r.activationType);return[...new Set(a)]},Ra=(e,t,a,r)=>{var o;if(a!==e.ownerId)return!1;if(r&&e.ownerId!==void 0){const s=r.players.find(d=>d.id===e.ownerId);if(s!=null&&s.isDummy&&r.activePlayerId!==e.ownerId)return!1}if((o=e.statuses)!=null&&o.some(s=>s.type==="Stun"))return!1;const n=rr(e),i=t===1&&n.some(s=>s.activationType==="setup")||t===3&&n.some(s=>s.activationType==="commit");if(t===1){const s=n.find(d=>d.activationType==="setup");if(s&&xe(e,$e))return!(s.supportRequired&&!Re(e,"Support",a))}if(t===3){const s=n.find(d=>d.activationType==="commit");if(s&&xe(e,He))return!(s.supportRequired&&!Re(e,"Support",a))}if(!i){const s=n.find(d=>d.activationType==="deploy");if(s&&xe(e,Ve))return!(s.supportRequired&&!Re(e,"Support",a))}return!1},ko=(e,t,a,r)=>{if(a!==e.ownerId)if(e.ownerId!==void 0){const d=t.players.find(l=>l.id===e.ownerId);if(!(d!=null&&d.isDummy))return null}else return null;const n=rr(e),i=e.ownerId??a??0,o=t.currentPhase,s=o===1&&n.some(d=>d.activationType==="setup")||o===3&&n.some(d=>d.activationType==="commit");if(o===1){const d=n.find(l=>l.activationType==="setup");if(d&&xe(e,$e)){if(d.supportRequired&&!Re(e,"Support",i))return null;const l=d.getAction(e,t,i,r);if(l)return{...l,readyStatusToRemove:$e}}}if(o===3){const d=n.find(l=>l.activationType==="commit");if(d&&xe(e,He)){if(d.supportRequired&&!Re(e,"Support",i))return null;const l=d.getAction(e,t,i,r);if(l)return{...l,readyStatusToRemove:He}}}if(!s){const d=n.find(l=>l.activationType==="deploy");if(d&&xe(e,Ve)){if(d.supportRequired&&!Re(e,"Support",i))return null;const l=d.getAction(e,t,i,r);if(l)return{...l,isDeployAbility:!0,readyStatusToRemove:Ve}}}return null},I={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},Oo=(e,t)=>t===1&&xe(e,$e)?$e:t===3&&xe(e,He)?He:xe(e,Ve)?Ve:null,wi=(e,t)=>{var o;let a,r;typeof t=="object"?(a=t.currentPhase,r=t):a=t;const n=r==null?void 0:r.activePlayerId;return n===void 0||e.ownerId!==n||(o=e.statuses)!=null&&o.some(s=>s.type==="Stun")||!Oo(e,a)?!1:Ra(e,a,e.ownerId,r)},Pa=(e,t,a)=>{var s;let r;if(typeof t=="object"?(r=t.currentPhase,a=t.activePlayerId??void 0):r=t,a===void 0||e.ownerId!==a||(s=e.statuses)!=null&&s.some(d=>d.type==="Stun"))return!1;const n=xe(e,Ve),i=xe(e,$e),o=xe(e,He);return Do(e,r,n,i,o)},ar=(e,t)=>{e.statuses||(e.statuses=[]);const a=Po(e);for(const r of a){let n="";r==="deploy"?n=Ve:r==="setup"?n=$e:r==="commit"&&(n=He),n&&(e.statuses.some(o=>o.type===n)||e.statuses.push({type:n,addedByPlayerId:t}))}},Zt=(e,t)=>{const a=ha("setup"),r=ha("commit");for(let n=0;n<e.board.length;n++)for(let i=0;i<e.board[n].length;i++){const s=e.board[n][i].card;if(!s||s.ownerId!==t)continue;const d=s.baseId||s.id;if(d){if(I.debug(`[resetReadyStatusesForTurn] Processing card: ${s.name} (baseId: ${d}, ownerId: ${s.ownerId})`),s.statuses||(s.statuses=[]),a.includes(d)){const l=s.statuses.some(m=>m.type===$e);s.statuses=s.statuses.filter(m=>m.type!==$e),s.statuses.push({type:$e,addedByPlayerId:t}),l||I.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_SETUP to ${s.name}`)}else s.statuses=s.statuses.filter(l=>l.type!==$e);if(r.includes(d)){const l=s.statuses.some(m=>m.type===He);s.statuses=s.statuses.filter(m=>m.type!==He),s.statuses.push({type:He,addedByPlayerId:t}),l||I.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_COMMIT to ${s.name}`)}else s.statuses=s.statuses.filter(l=>l.type!==He)}}};function ha(e){const t=[];for(const[a,r]of Object.entries(tr))(r.abilities||[]).some(i=>i.activationType===e)&&t.push(a);return t}class vo{constructor(){this.queue=[],this.loading=new Set,this.loaded=new Set,this.maxConcurrent=1,this.minDelayBetweenLoads=1e3,this.lastLoadTime=0,this.isProcessing=!1}preload(t,a="low"){!t||this.loaded.has(t)||this.loading.has(t)||this.queue.some(n=>n.url===t)||(this.queue.push({url:t,priority:a,timestamp:Date.now()}),this.queue.sort((n,i)=>{const o={high:0,normal:1,low:2},s=o[n.priority]-o[i.priority];return s!==0?s:n.timestamp-i.timestamp}),this.processQueue())}preloadMany(t,a="low"){t.forEach(r=>this.preload(r,a))}isLoaded(t){return this.loaded.has(t)}clearQueue(){this.queue=[]}clear(){this.queue=[],this.loading.clear(),this.loaded.clear()}processQueue(){if(this.isProcessing||this.queue.length===0)return;this.isProcessing=!0;const t=()=>{if(this.queue.length===0){this.isProcessing=!1;return}const r=Date.now()-this.lastLoadTime,n=Math.max(0,this.minDelayBetweenLoads-r);setTimeout(()=>{const i=this.queue.shift();if(!i){this.isProcessing=!1;return}this.loadImage(i.url).then(()=>{this.lastLoadTime=Date.now(),t()}).catch(()=>{this.lastLoadTime=Date.now(),t()})},n)};t()}loadImage(t){return new Promise((a,r)=>{this.loading.add(t);const n=new Image;n.onload=()=>{this.loading.delete(t),this.loaded.add(t),a()},n.onerror=()=>{this.loading.delete(t),r(new Error(`Failed to load: ${t}`))},n.src=t})}}const No=new vo;function Mo(e,t){const a=[];for(const r of e)if(r.id!==t){if(r.hand)for(const n of r.hand)n.imageUrl&&!a.includes(n.imageUrl)&&a.push(n.imageUrl);if(r.deck)for(const n of r.deck)n.imageUrl&&!a.includes(n.imageUrl)&&a.push(n.imageUrl);if(r.discard)for(const n of r.discard)n.imageUrl&&!a.includes(n.imageUrl)&&a.push(n.imageUrl)}return a}function Ee(e){const t=e,a=t==null?void 0:t.targetingMode;a&&delete t.targetingMode;let r;return typeof structuredClone<"u"?r=structuredClone(e):r=JSON.parse(JSON.stringify(e)),a&&(r.targetingMode=a,t.targetingMode=a),r}const se={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function _i(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function bi(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}function Ai(e,t){return e?Ao[e]:t}function Oe(){return localStorage.getItem("webrtc_enabled")==="true"}const ka=U.createContext(null),Si=({children:e})=>{const[t,a]=U.useState(null),[r,n]=U.useState({}),[i,o]=U.useState("lg"),s=U.useCallback((y,D={},g="lg")=>{a(y),n(D),o(g)},[]),d=U.useCallback(()=>{a(null),n({}),o("lg")},[]),l=U.useCallback(y=>t===y,[t]),m=U.useCallback(()=>r,[r]),E=U.useCallback(()=>i,[i]),_={openModal:t,modalData:r,modalSize:i,open:s,close:d,isOpen:l,getData:m,getSize:E};return fo.jsx(ka.Provider,{value:_,children:e})},Nt=()=>{const e=U.useContext(ka);if(!e)throw new Error("useModals must be used within ModalsProvider");return e},Ci=()=>{const{open:e,close:t,isOpen:a}=Nt();return{isOpen:a("rules"),open:r=>e("rules",r,"full"),close:t}},Di=()=>{const{open:e,close:t,isOpen:a}=Nt();return{isOpen:a("settings"),open:r=>e("settings",r,"md"),close:t}},Ri=()=>{const{open:e,close:t,isOpen:a,getData:r}=Nt();return{isOpen:a("joinGame"),open:n=>e("joinGame",n,"lg"),close:t,getData:()=>r()}},Pi=()=>{const{open:e,close:t,isOpen:a}=Nt();return{isOpen:a("deckBuilder"),open:r=>e("deckBuilder",r,"full"),close:t}},gt="webrtc_game_state",wt="webrtc_host_data",_t="webrtc_guest_data",Lo="webrtc_current_host_peerId",Go=30*60*1e3;function nr(){return Date.now()}function At(e){return Date.now()-e<Go}function xo(e){try{const t={...e,timestamp:nr()};localStorage.setItem(wt,JSON.stringify(t)),I.info("[WebRTC Persistence] Saved host data:",{peerId:t.peerId})}catch(t){I.error("[WebRTC Persistence] Failed to save host data:",t)}}function Ft(e){try{const t={...e,timestamp:nr()};localStorage.setItem(_t,JSON.stringify(t)),I.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId})}catch(t){I.error("[WebRTC Persistence] Failed to save guest data:",t)}}function mt(e){try{const t={...e,timestamp:nr()};localStorage.setItem(gt,JSON.stringify(t)),I.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(t.timestamp).toISOString())}catch(t){I.error("[WebRTC Persistence] Failed to save game state:",t)}}function Oa(){try{const e=localStorage.getItem(wt);if(!e)return null;const t=JSON.parse(e);return At(t.timestamp)?(I.info("[WebRTC Persistence] Loaded valid host data:",{peerId:t.peerId}),t):(I.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(wt),null)}catch(e){return I.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(wt),null}}function va(){try{const e=localStorage.getItem(_t);if(!e)return null;const t=JSON.parse(e);return At(t.timestamp)?(I.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId}),t):(I.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(_t),null)}catch(e){return I.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(_t),null}}function ma(){try{const e=localStorage.getItem(gt);if(!e)return null;const t=JSON.parse(e);return At(t.timestamp)?(I.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(t.timestamp).toISOString()),t):(I.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(gt),null)}catch(e){return I.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(gt),null}}function tt(){localStorage.removeItem(gt),localStorage.removeItem(wt),localStorage.removeItem(_t),localStorage.removeItem(Lo)}function Qt(e,t){try{const a=`webrtc_host_${t}`,r={peerId:e,gameId:t,timestamp:Date.now()};localStorage.setItem(a,JSON.stringify(r)),I.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${t}:`,e)}catch(a){I.error("[WebRTC Persistence] Failed to broadcast host peerId:",a)}}function Wt(e){try{const t=`webrtc_host_${e}`,a=localStorage.getItem(t);if(!a)return null;const r=JSON.parse(a);return Date.now()-r.timestamp>15e3?null:{peerId:r.peerId,timestamp:r.timestamp}}catch(t){return I.error("[WebRTC Persistence] Failed to get host peerId:",t),null}}function Ia(e){try{const t=`webrtc_host_${e}`;localStorage.removeItem(t),I.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(t){I.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",t)}}function Uo(){const e=sessionStorage.getItem("invite_host_id"),t=sessionStorage.getItem("invite_auto_join");if(e&&t)return"none";const a=Oa();if(a&&At(a.timestamp))return"host";const r=va();return r&&At(r.timestamp)?"guest":"none"}const Ea=7,Bt="mrPearlDoF",$o="reverendOfTheChoir",Ho="threatAnalyst";function Fo(e,t){return e!=null&&e.statuses?e.statuses.some(a=>a.type==="Exploit"&&a.addedByPlayerId!==void 0&&t.has(a.addedByPlayerId)):!1}function Wo(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const Na=()=>Array(Ea).fill(null).map(()=>Array(Ea).fill(null).map(()=>({card:null}))),Ne=e=>{var g,w,f,A,T;const{board:t,activeGridSize:a,players:r}=e,n=Wo(t),i=n.length,o=Math.floor((i-a)/2),s=new Map;r.forEach(u=>s.set(u.id,u.teamId));for(let u=0;u<i;u++)for(let c=0;c<i;c++){const p=n[u][c].card;p&&(p.statuses&&(p.statuses=p.statuses.filter(S=>S.type!=="Support"&&S.type!=="Threat")),delete p.bonusPower)}for(let u=0;u<i;u++)for(let c=0;c<i;c++){const p=n[u][c].card;if((p==null?void 0:p.ownerId)===void 0||p.isFaceDown)continue;const S=p.ownerId,v=s.get(S),M=[{r:u-1,c},{r:u+1,c},{r:u,c:c-1},{r:u,c:c+1}],k={};let C=!1;for(const G of M){const{r:P,c:N}=G;if(P>=0&&P<i&&N>=0&&N<i){const $=n[P][N].card,B=(g=$==null?void 0:$.statuses)==null?void 0:g.some(q=>q.type==="Stun");if(($==null?void 0:$.ownerId)!==void 0&&!$.isFaceDown&&!B){const q=$.ownerId,V=s.get(q);S===q||v!==void 0&&v===V?C=!0:(k[q]||(k[q]=[]),k[q].push({r:P,c:N}))}}}C&&(p.statuses||(p.statuses=[]),p.statuses.some(G=>G.type==="Support")||p.statuses.push({type:"Support",addedByPlayerId:S}));let L=null;for(const G in k){const P=k[G];if(P&&P.length>=2){L=parseInt(G,10);break}}if(L===null&&u>=o&&u<o+a&&c>=o&&c<o+a){const P=u===o||u===o+a-1||c===o||c===o+a-1,N=Object.keys(k).length>0;if(P&&N){const $=Object.keys(k)[0];$&&(L=parseInt($,10))}}L!==null&&(p.statuses||(p.statuses=[]),p.statuses.some(G=>G.type==="Threat")||p.statuses.push({type:"Threat",addedByPlayerId:L}))}const d=new Set;for(let u=0;u<i;u++)for(let c=0;c<i;c++){const p=n[u][c].card,S=(w=p==null?void 0:p.statuses)==null?void 0:w.some(v=>v.type==="Stun");if((p==null?void 0:p.baseId)===Ho&&!p.isFaceDown&&p.ownerId!==void 0&&!S){const v=[{r:u-1,c},{r:u+1,c},{r:u,c:c-1},{r:u,c:c+1}];let M=!1;const k=p.ownerId,C=s.get(k);for(const L of v){const{r:G,c:P}=L;if(G>=0&&G<i&&P>=0&&P<i){const N=n[G][P].card;if((N==null?void 0:N.ownerId)!==void 0&&!N.isFaceDown){const $=N.ownerId,B=s.get($),q=k===$||C!==void 0&&C===B,V=(f=N==null?void 0:N.statuses)==null?void 0:f.some(J=>J.type==="Stun");if(q&&!V){M=!0;break}}}}M&&d.add(k)}}for(let u=0;u<i;u++)for(let c=0;c<i;c++){const p=n[u][c].card;if(!p||p.isFaceDown||p.ownerId===void 0)continue;const S=p.ownerId,v=s.get(S),M=[{r:u-1,c},{r:u+1,c},{r:u,c:c-1},{r:u,c:c+1}],k={};for(const L of M){const{r:G,c:P}=L;if(G>=0&&G<i&&P>=0&&P<i){const N=n[G][P].card,$=(A=N==null?void 0:N.statuses)==null?void 0:A.some(B=>B.type==="Stun");if((N==null?void 0:N.ownerId)!==void 0&&!N.isFaceDown&&!$){const B=N.ownerId,q=s.get(B);if(!(S===B||v!==void 0&&v===q)){const J=d.has(B),H=Fo(p,d);J&&H&&(k[B]||(k[B]=0),k[B]++)}}}}if(Object.keys(k).length>0){p.statuses||(p.statuses=[]);const L=Object.keys(k).map(G=>parseInt(G,10));for(const G of L)p.statuses.some(P=>P.type==="Threat"&&P.addedByPlayerId===G)||p.statuses.push({type:"Threat",addedByPlayerId:G})}}const l=[],m=[];for(let u=0;u<i;u++)for(let c=0;c<i;c++){const p=n[u][c].card,S=(T=p==null?void 0:p.statuses)==null?void 0:T.some(v=>v.type==="Stun");p!=null&&p.baseId&&!p.isFaceDown&&p.ownerId!==void 0&&!S&&(p.baseId===$o?l.push({r:u,c,ownerId:p.ownerId,baseId:p.baseId}):p.baseId===Bt&&m.push({r:u,c,ownerId:p.ownerId,baseId:p.baseId}))}const E=new Set,_=new Set;for(const u of l){const{r:c,c:p,ownerId:S}=u,v=`${c}-${S}`;if(!E.has(v)){E.add(v);for(let k=0;k<i;k++){const C=n[c][k].card;C&&C.ownerId===S&&!C.isFaceDown&&(C.statuses||(C.statuses=[]),C.statuses.some(L=>L.type==="Support")||C.statuses.push({type:"Support",addedByPlayerId:S}))}}const M=`${p}-${S}`;if(!_.has(M)){_.add(M);for(let k=0;k<i;k++){const C=n[k][p].card;C&&C.ownerId===S&&!C.isFaceDown&&(C.statuses||(C.statuses=[]),C.statuses.some(L=>L.type==="Support")||C.statuses.push({type:"Support",addedByPlayerId:S}))}}}const y=new Set,D=new Set;for(const u of m){const{r:c,c:p,ownerId:S}=u,v=`${c}-${S}`;if(!y.has(v)){y.add(v);for(let k=0;k<i;k++){const C=n[c][k].card;C&&C.ownerId===S&&!C.isFaceDown&&C.baseId!==Bt&&(C.bonusPower=(C.bonusPower||0)+1)}}const M=`${p}-${S}`;if(!D.has(M)){D.add(M);for(let k=0;k<i;k++){const C=n[k][p].card;C&&C.ownerId===S&&!C.isFaceDown&&C.baseId!==Bt&&(C.bonusPower=(C.bonusPower||0)+1)}}}return n};var it=(e=>(e[e.CARD_REGISTRY=1]="CARD_REGISTRY",e[e.CARD_STATE=2]="CARD_STATE",e[e.ABILITY_EFFECT=3]="ABILITY_EFFECT",e[e.SESSION_EVENT=4]="SESSION_EVENT",e))(it||{});function Bo(){const e={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},t=new Set,a=Array.from(tr.values());for(const r of a)if(r.baseId&&!t.has(r.baseId)){t.add(r.baseId);const n=e.cardDefinitions.length;e.baseIdToIndex.set(r.baseId,n),e.indexToBaseId.set(n,r.baseId),e.cardDefinitions.push({baseId:r.baseId,name:r.name,imageUrl:r.imageUrl,power:r.power,ability:r.ability||"",types:r.types||[],faction:r.faction||""})}return e.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],I.info(`[CardRegistry] Built registry with ${e.cardDefinitions.length} cards, ${e.statusTypes.length} status types`),e}function Ma(e,t){let a=0;for(const r of e||[]){const n=t.statusTypes.indexOf(r.type);n>=0&&n<32&&(a|=1<<n)}return a>>>0}function La(e,t,a){const r=[];for(let n=0;n<32;n++)if(e&1<<n){const i=a.statusTypes[n];i&&r.push({type:i,addedByPlayerId:t})}return r}function Ga(e){let t=0;return e.isFaceDown&&(t|=1),e.enteredThisTurn&&(t|=2),e.revealedTo==="all"&&(t|=4),t}function Yt(e,t){const a=new Uint8Array(13);let r=0;const n=or(e.id);a[r++]=n>>24&255,a[r++]=n>>16&255,a[r++]=n>>8&255,a[r++]=n&255;const i=e.baseId?t.baseIdToIndex.get(e.baseId)??0:0;a[r++]=i>>8&255,a[r++]=i&255,a[r++]=(e.ownerId??0)&255;const o=Math.round(e.power||0);a[r++]=Math.clamp(o,-128,127)&255,a[r++]=Ga(e);const s=Ma(e.statuses||[],t);return a[r++]=s>>24&255,a[r++]=s>>16&255,a[r++]=s>>8&255,a[r++]=s&255,a}function Yo(e,t,a){const r=new Uint8Array(10);let n=0;const i=or(e.id);r[n++]=i>>24&255,r[n++]=i>>16&255,r[n++]=i>>8&255,r[n++]=i&255,r[n++]=(e.ownerId??a)&255,r[n++]=Ga(e);const o=Ma(e.statuses||[],t);return r[n++]=o>>24&255,r[n++]=o>>16&255,r[n++]=o>>8&255,r[n++]=o&255,r}function or(e){let t=0;for(let a=0;a<e.length;a++){const r=e.charCodeAt(a);t=(t<<5)-t+r,t=t&t}return t>>>0}function Ko(e,t,a){var g;const r=[],n=Date.now(),i=new Uint8Array(7);i[0]=it.CARD_STATE,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,r.push(i);const o=[],s=Math.min(e.players.length,255);o.push(new Uint8Array([s]));for(const w of e.players){o.push(new Uint8Array([w.id&255]));const f=pt.indexOf(w.color);o.push(new Uint8Array([f>=0?f:0]));const A=Math.min(w.deck.length,255),T=Math.min(w.hand.length,255),u=Math.min(w.discard.length,255);o.push(new Uint8Array([A,T,u,w.announcedCard?1:0])),o.push(new Uint8Array([Math.min(w.score,255)]));const c=Math.min(w.hand.length,255);o.push(new Uint8Array([c]));const p=w.id===a;for(const v of w.hand)p?o.push(Yt(v,t)):o.push(Yo(v,t,w.id));const S=Math.min(w.discard.length,255);o.push(new Uint8Array([S]));for(const v of w.discard){const M=or(v.id),k=new Uint8Array(4);k[0]=M>>24&255,k[1]=M>>16&255,k[2]=M>>8&255,k[3]=M&255,o.push(k)}w.announcedCard&&o.push(Yt(w.announcedCard,t))}const d=e.board.length;o.push(new Uint8Array([d,d,d]));const l=[];for(let w=0;w<e.board.length;w++)for(let f=0;f<((g=e.board[w])==null?void 0:g.length);f++){const A=e.board[w][f];A!=null&&A.card&&l.push({row:w,col:f,card:A.card})}const m=l.length,E=new Uint8Array(2);E[0]=m>>8&255,E[1]=m&255,o.push(E);for(const{row:w,col:f,card:A}of l)o.push(new Uint8Array([w,f])),o.push(Yt(A,t));o.push(new Uint8Array([e.currentPhase===void 0?255:Math.clamp(e.currentPhase,0,254),(e.activePlayerId??255)&255,e.currentRound===void 0?255:Math.clamp(e.currentRound,0,254)]));let _=0;for(const w of o)_+=w.length;i[5]=_>>8&255,i[6]=_&255,r.push(...o);const y=new Uint8Array(r.reduce((w,f)=>w+f.length,0));let D=0;for(const w of r)y.set(w,D),D+=w.length;return I.info(`[GameCodec] Encoded card state: ${y.length} bytes (${m} board cards, ${e.players.length} players)`),y}function zo(e,t,a){let r=0;if(e[r++]!==it.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],e[r++]<<8|e[r++];const n=e[r++],i=[];for(let g=0;g<n;g++){const w=e[r++],f=e[r++],A=pt[f]||"blue",T=e[r++];e[r++],e[r++];const u=e[r++]===1,c=e[r++],p=e[r++],S=[],v=w===a;for(let G=0;G<p;G++)if(v)S.push(Kt(e,r,t)),r+=13;else{const P=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],N=e[r++],$=e[r++],B=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];S.push({id:`card_${P}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:N,isFaceDown:($&1)!==0,revealedTo:$&4?"all":void 0,statuses:La(B,w,t),isPlaceholder:!0})}const M=e[r++],k=[];for(let G=0;G<M;G++){const P=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];k.push({id:`discard_${P}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:w,isPlaceholder:!0})}let C=null;u&&(C=Kt(e,r,t),r+=13);const L=[];for(let G=0;G<T;G++)L.push({id:`deck_${w}_${G}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:w,isPlaceholder:!0});i.push({id:w,name:`Player ${w}`,score:c,hand:S,deck:L,discard:k,announcedCard:C,selectedDeck:"Random",color:A,boardHistory:[]})}const o=e[r++];r++,r++;const s=e[r++]<<8|e[r++],d=[];for(let g=0;g<o;g++){const w=[];for(let f=0;f<o;f++)w.push({card:null});d.push(w)}for(let g=0;g<s;g++){const w=e[r++],f=e[r++],A=Kt(e,r,t);r+=13,w<d.length&&f<d[w].length&&(d[w][f]={card:A})}const l=e[r++],m=e[r++],E=e[r++];return{players:i,board:d,currentPhase:l===255?void 0:l,activePlayerId:m===255?null:m,currentRound:E===255?void 0:E}}function Kt(e,t,a){const n=`card_${e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++]}_${Date.now()}`,i=e[t++]<<8|e[t++],o=e[t++];let s=e[t++];s>127&&(s=s-256);const d=e[t++],l=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++],m=a.cardDefinitions[i],E=(m==null?void 0:m.baseId)||"";return{id:n,baseId:E,deck:"Random",name:(m==null?void 0:m.name)||"?",imageUrl:(m==null?void 0:m.imageUrl)||"",power:s,ability:(m==null?void 0:m.ability)||"",types:(m==null?void 0:m.types)||[],faction:(m==null?void 0:m.faction)||"",ownerId:o,isFaceDown:(d&1)!==0,enteredThisTurn:(d&2)!==0,revealedTo:d&4?"all":void 0,statuses:La(l,0,a)}}Math.clamp||(Math.clamp=function(e,t,a){return Math.min(Math.max(e,t),a)});let zt=null;function xa(){return zt||(zt=Bo()),zt}function Ta(e,t){const a=xa();return Ko(e,a,t)}function qo(e,t){const a=xa();return zo(e,a,t)}function jo(e){return Sa(e)}function Ua(e){I.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return po(e)}catch(t){return I.error("[webrtcSerialization] Failed to serialize delta:",t),new Uint8Array(0)}}function $a(e){I.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Sa(e)}catch(t){return I.error("[webrtcSerialization] Failed to deserialize delta:",t),{}}}function Vo(e){const t=Ua(e);let a="";const r=new Uint8Array(t),n=r.byteLength;for(let i=0;i<n;i++)a+=String.fromCharCode(r[i]);return btoa(a)}function Jo(e){const t=atob(e),a=new Uint8Array(t.length);for(let r=0;r<t.length;r++)a[r]=t.charCodeAt(r);return $a(a)}function Xo(e,t){var E;const a=new TextEncoder,r=[],n=Date.now(),i=new Uint8Array(7);i[0]=it.ABILITY_EFFECT,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,r.push(i);const o=[];if(o.push(new Uint8Array([e])),t.sourcePos){const _=(t.sourcePos.row&15)<<4|t.sourcePos.col&15;o.push(new Uint8Array([_]))}else o.push(new Uint8Array([255]));const s=((E=t.targetPositions)==null?void 0:E.length)||0;if(o.push(new Uint8Array([Math.min(s,255)])),t.targetPositions)for(const _ of t.targetPositions.slice(0,255)){const y=(_.row&15)<<4|_.col&15;o.push(new Uint8Array([y]))}if(t.text){const _=a.encode(t.text),y=Math.min(_.length,255);o.push(new Uint8Array([y])),o.push(_.slice(0,y))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(t.value??0)&255])),o.push(new Uint8Array([(t.playerId??0)&255]));let d=0;for(const _ of o)d+=_.length;i[5]=d>>8&255,i[6]=d&255,r.push(...o);const l=new Uint8Array(r.reduce((_,y)=>_+y.length,0));let m=0;for(const _ of r)l.set(_,m),m+=_.length;return I.debug(`[AbilityMessages] Encoded effect type ${e}: ${l.length} bytes`),l}function Zo(e){let t=0;if(e[t++]!==it.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const a=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={effectType:e[t++],timestamp:a,data:{}},n=e[t++];n!==255&&(r.data.sourcePos={row:n>>4&15,col:n&15});const i=e[t++];if(i>0){r.data.targetPositions=[];for(let s=0;s<i;s++){const d=e[t++];r.data.targetPositions.push({row:d>>4&15,col:d&15})}}const o=e[t++];if(o>0){const s=new TextDecoder;r.data.text=s.decode(e.subarray(t,t+o)),t+=o}return r.data.value=e[t++],r.data.playerId=e[t++],r}function Qo(e,t={}){const a=new TextEncoder,r=[],n=Date.now(),i=new Uint8Array(7);i[0]=it.SESSION_EVENT,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,r.push(i);const o=[];if(o.push(new Uint8Array([e])),o.push(new Uint8Array([(t.playerId??0)&255])),t.playerName){const E=a.encode(t.playerName),_=Math.min(E.length,255);o.push(new Uint8Array([_])),o.push(E.slice(0,_))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(t.startingPlayerId??0)&255])),o.push(new Uint8Array([Math.min(t.roundNumber??0,255)])),o.push(new Uint8Array([Math.min(t.newPhase??0,255)])),o.push(new Uint8Array([(t.newActivePlayerId??0)&255])),o.push(new Uint8Array([(t.gameWinner??255)&255]));let s=0;if(t.winners)for(const E of t.winners)E<32&&(s|=1<<E);o.push(new Uint8Array([s>>24&255,s>>16&255,s>>8&255,s&255]));let d=0;for(const E of o)d+=E.length;i[5]=d>>8&255,i[6]=d&255,r.push(...o);const l=new Uint8Array(r.reduce((E,_)=>E+_.length,0));let m=0;for(const E of r)l.set(E,m),m+=E.length;return I.debug(`[SessionMessages] Encoded event type ${e}: ${l.length} bytes`),l}function es(e){let t=0;if(e[t++]!==it.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const a=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={eventType:e[t++],timestamp:a,data:{}};r.data.playerId=e[t++];const n=e[t++];if(n>0){const s=new TextDecoder;r.data.playerName=s.decode(e.subarray(t,t+n)),t+=n}r.data.startingPlayerId=e[t++],r.data.roundNumber=e[t++],r.data.newPhase=e[t++],r.data.newActivePlayerId=e[t++];const i=e[t++];r.data.gameWinner=i===255?null:i;const o=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];if(o!==0){r.data.winners=[];for(let s=0;s<32;s++)o&1<<s&&r.data.winners.push(s)}return r}const ts=!0;class Ke{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,this.guestPlayerIds=new Map,localStorage.getItem("webrtc_enabled")}async initializeAsHost(t){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((a,r)=>{this.peer=t?new Ct(t):new Ct,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),a(n)}),this.peer.on("connection",n=>{I.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{I.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{I.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(t){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((a,r)=>{this.peer=new Ct,this.peer.on("open",n=>{const i=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(i),i.on("open",()=>{this.hostConnection=i,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}});let o=null;try{const s=localStorage.getItem("webrtc_preferred_deck");s&&(o=s,I.info(`[initializeAsGuest] Found deck preference in localStorage: ${o}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(s){I.warn("[initializeAsGuest] Failed to read deck preference:",s)}this.sendMessageToHost({type:"JOIN_REQUEST",senderId:n,data:{preferredDeck:o||void 0},timestamp:Date.now()}),a()}),i.on("error",o=>{I.error("Host connection error:",o),this.emitEvent({type:"error",data:o}),r(o)})}),this.peer.on("error",n=>{I.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)})})}async initializeAsReconnectingGuest(t,a){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((r,n)=>{this.peer=new Ct,this.peer.on("open",i=>{const o=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(o),o.on("open",()=>{this.hostConnection=o,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:i,playerId:a,timestamp:Date.now()}),this.isReconnecting=!1,r()}),o.on("error",s=>{I.error("Host connection error:",s),this.emitEvent({type:"error",data:s}),this.isReconnecting=!1,n(s)})}),this.peer.on("error",i=>{I.error("WebRTC Peer error:",i),this.emitEvent({type:"error",data:i}),this.isReconnecting=!1,n(i)})})}handleGuestConnection(t){this.connections.set(t.peer,t),t.on("open",()=>{I.info(`Guest connected: ${t.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:t.peer}})}),t.on("data",a=>{this.handleMessage(a,t)}),t.on("close",()=>{I.info(`Guest disconnected: ${t.peer}`),this.connections.delete(t.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:t.peer}})}),t.on("error",a=>{I.error(`Guest connection error (${t.peer}):`,a)})}setupHostConnection(t){this.hostConnection=t,t.on("data",a=>{this.handleMessage(a,t)}),t.on("close",()=>{I.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),t.on("error",a=>{I.error("Host connection error:",a)})}handleMessage(t,a){I.debug("Received WebRTC message:",t.type),this.emitEvent({type:"message_received",data:t})}sendMessageToHost(t){var a,r,n,i;if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(t),(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&I.info(`[WebrtcManager] Sent ${t.type} to host`,{hasData:!!t.data,hasTargetingMode:!!((a=t.data)!=null&&a.targetingMode),targetingModePlayerId:(n=(r=t.data)==null?void 0:r.targetingMode)==null?void 0:n.playerId}),!0}catch(o){return I.error("Failed to send message to host:",o),!1}return(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&I.warn(`[WebrtcManager] Could not send ${t.type} to host`,{isHost:this.isHost,hasHostConnection:!!this.hostConnection,isConnectionOpen:((i=this.hostConnection)==null?void 0:i.open)??!1}),!1}broadcastToGuests(t,a){if(!this.isHost)return I.warn("Only host can broadcast to guests"),0;let r=0;return this.connections.forEach((n,i)=>{if(n.open&&i!==a)try{n.send(t),r++}catch(o){I.error(`Failed to send to guest ${i}:`,o)}}),I.debug(`Broadcast to ${r}/${this.connections.size} guests`),r}sendToGuest(t,a){if(!this.isHost)return I.warn("Only host can send to specific guest"),!1;const r=this.connections.get(t);if(!r)return I.error(`[sendToGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!r.open)return I.error(`[sendToGuest] Connection for guest ${t} is not open`),!1;try{return r.send(a),I.debug(`Sent message to guest ${t}`),!0}catch(n){return I.error(`[sendToGuest] Failed to send message to ${t}:`,n),!1}}acceptGuest(t,a,r){var i;const n=this.connections.get(t);if(!n){I.error(`[acceptGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){I.error(`[acceptGuest] Connection for guest ${t} is not open`);return}try{if(ts){const o=Ta(a,null),s={type:"JOIN_ACCEPT_BINARY",senderId:(i=this.peer)==null?void 0:i.id,playerId:r,data:o,timestamp:Date.now()};n.send(s),I.info(`Accepted guest ${t} as player ${r} (BINARY, ${o.byteLength} bytes)`)}}catch(o){I.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${t}:`,o)}}acceptGuestMinimal(t,a,r){var o;const n=this.connections.get(t);if(!n){I.error(`[acceptGuestMinimal] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){I.error(`[acceptGuestMinimal] Connection for guest ${t} is not open`);return}this.guestPlayerIds.set(t,r);const i={type:"JOIN_ACCEPT_MINIMAL",senderId:(o=this.peer)==null?void 0:o.id,playerId:r,data:a,timestamp:Date.now()};try{n.send(i),I.info(`Accepted guest ${t} as player ${r} (minimal)`)}catch(s){I.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${t}:`,s)}}broadcastGameState(t,a){this.broadcastGameStateLegacy(t,a)}broadcastGameStateLegacy(t,a){let r=0;this.connections.forEach((n,i)=>{var l;if(!n.open||i===a)return;const o=this.guestPlayerIds.get(i)??null,s=Ke.createPersonalizedGameState(t,o),d={type:"STATE_UPDATE_COMPACT",senderId:(l=this.peer)==null?void 0:l.id,data:{gameState:s,recipientPlayerId:o},timestamp:Date.now()};try{n.send(d),r++}catch(m){I.error(`[broadcastGameStateLegacy] Failed to send to guest ${i} (player ${o}):`,m)}}),I.debug(`[broadcastGameStateLegacy] Sent to ${r}/${this.connections.size} guests`)}static createPersonalizedGameState(t,a){return{...t,players:t.players.map(r=>{if(a!==null&&r.id===a){const i=r.deck.length??0,o=r.discard.length??0,s=r.hand.length??0;return I.debug(`[createPersonalizedGameState] Player ${r.id} (own): ${s} hand, ${i} deck, ${o} discard`),{...r,handCards:r.hand.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),deckCards:r.deck.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),discardCards:r.discard.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?Ke.optimizeCard(r.announcedCard):null,deckSize:i,discardSize:o,handSize:s}}else{const i=r.deckSize??r.deck.length??0,o=r.hand.filter(s=>!s.isFaceDown).length;return o>0&&I.debug(`[createPersonalizedGameState] Player ${r.id} (other): ${o} revealed, ${r.hand.length-o} face-down`),{...r,hand:r.hand.map(s=>s.isFaceDown?Ke.createCardBack(s):{id:s.id,baseId:s.baseId,power:s.power,powerModifier:s.powerModifier||0,isFaceDown:s.isFaceDown,statuses:s.statuses||[],ownerId:s.ownerId,ownerName:s.ownerName,deck:s.deck}),deck:[],discard:[],announcedCard:r.announcedCard?Ke.createCardBack(r.announcedCard):null,deckSize:i,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}}}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?Ke.optimizeCard(n.card):null})))}}static createCompactStateForHost(t,a){return{...t,players:t.players.map(r=>{if(r.id===a)return I.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),deckCards:r.deck.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),discardCards:r.discard.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),hand:[],deck:[],discard:[],handSize:r.hand.length,deckSize:r.deck.length,discardSize:r.discard.length};{const i=r.hand.filter(o=>o.statuses&&o.statuses.length>0).length>0;return{...r,...i&&{handCards:r.hand.map(o=>({id:o.id,baseId:o.baseId,power:o.power,powerModifier:o.powerModifier||0,isFaceDown:o.isFaceDown,statuses:o.statuses||[]}))},hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}}}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?Ke.optimizeCard(n.card):null})))}}static optimizeCard(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier,ability:t.ability,ownerId:t.ownerId,color:t.color,deck:t.deck,isFaceDown:t.isFaceDown,types:t.types,faction:t.faction,statuses:t.statuses||[],hasRevealToken:t.hasRevealToken||!1,imageUrl:t.imageUrl}}static createCardBack(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,hasRevealToken:t.hasRevealToken||!1,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck}}broadcastStateDelta(t,a){var r,n;{const i=Vo(t),o={type:"STATE_DELTA_BINARY",senderId:(r=this.peer)==null?void 0:r.id,data:i,timestamp:Date.now()};I.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${i.length} chars, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, boardCells=${((n=t.boardCells)==null?void 0:n.length)||0}`),this.broadcastToGuests(o,a),I.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${t.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(t,a,r){var n;try{const i=Ta(t,a),o=btoa(String.fromCharCode(...i)),s={type:"CARD_STATE",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,r);return I.info(`[broadcastCardState] Sent ${i.length} bytes to ${d} guests`),d}catch(i){return I.error("[broadcastCardState] Failed to encode/broadcast state:",i),0}}broadcastAbilityEffect(t,a,r){var n;try{const i=Xo(t,a),o=btoa(String.fromCharCode(...i)),s={type:"ABILITY_EFFECT",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,r);return I.debug(`[broadcastAbilityEffect] Sent effect ${t} to ${d} guests`),d}catch(i){return I.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",i),0}}broadcastSessionEvent(t,a,r){var n;try{const i=Qo(t,a),o=btoa(String.fromCharCode(...i)),s={type:"SESSION_EVENT",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,r);return I.debug(`[broadcastSessionEvent] Sent event ${t} to ${d} guests`),d}catch(i){return I.error("[broadcastSessionEvent] Failed to encode/broadcast event:",i),0}}sendAction(t,a){var n;const r={type:"ACTION",senderId:(n=this.peer)==null?void 0:n.id,data:{actionType:t,actionData:a},timestamp:Date.now()};return this.sendMessageToHost(r)}sendStateDelta(t){var a;{const r=Ua(t),n={type:"STATE_DELTA_BINARY",senderId:(a=this.peer)==null?void 0:a.id,data:r,timestamp:Date.now()};return this.sendMessageToHost(n)}}sendStateToHost(t,a){var o,s,d;if(a===null)return I.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const r=Ke.createCompactStateForHost(t,a),n=t.players.find(l=>l.id===a);n&&I.info(`[sendStateToHost] Player ${a} sending compact state: hand=${((o=n.hand)==null?void 0:o.length)??0}, deck=${((s=n.deck)==null?void 0:s.length)??0}`);const i={type:"STATE_UPDATE_COMPACT",senderId:(d=this.peer)==null?void 0:d.id,playerId:a,data:{gameState:r},timestamp:Date.now()};return this.sendMessageToHost(i)}sendFullDeckToHost(t,a,r){var i;const n={type:"DECK_DATA_UPDATE",senderId:(i=this.peer)==null?void 0:i.id,playerId:t,data:{playerId:t,deck:a.map(o=>Ke.optimizeCard(o)),deckSize:r},timestamp:Date.now()};return this.sendMessageToHost(n)}sendCustomDeckData(t,a,r){var o;if(!r)return!0;I.info(`[sendCustomDeckData] Player ${t} sending ${a.length} custom deck cards to host`);const n=a.map(s=>({id:s.id,baseId:s.baseId,name:s.name,power:s.power,powerModifier:s.powerModifier,ability:s.ability,types:s.types,faction:s.faction,imageUrl:s.imageUrl,color:s.color,deck:s.deck})),i={type:"CUSTOM_DECK_DATA",senderId:(o=this.peer)==null?void 0:o.id,playerId:t,data:{playerId:t,deckCards:n},timestamp:Date.now()};return this.sendMessageToHost(i)}getConnectionInfo(){const t=[];return this.isHost?this.connections.forEach((a,r)=>{t.push({peerId:r,playerId:null,playerName:null,connected:a.open})}):this.hostConnection&&t.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),t}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getHostPeerId(){var t,a;return this.isHost?((t=this.peer)==null?void 0:t.id)||null:((a=this.hostConnection)==null?void 0:a.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var t;return this.isHost?this.connections.size:(t=this.hostConnection)!=null&&t.open?1:0}on(t){return this.eventHandlers.add(t),()=>this.eventHandlers.delete(t)}emitEvent(t){this.eventHandlers.forEach(a=>{try{a(t)}catch(r){I.error("Error in WebRTC event handler:",r)}})}cleanup(){this.connections.forEach(t=>t.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let qt=null;const rs=()=>(qt||(qt=new Ke),qt);function as(e){return 10+e*10}function sr(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const t=e.currentPhase===1,a=e.activePlayerId===e.startingPlayerId;if(!t||!a)return{shouldEnd:!1,roundWinners:[]};const r=e.currentRound||1,n=as(r),i=[];for(const s of e.players)!s.isDummy&&!s.isDisconnected&&s.score>=n&&i.push(s.id);return{shouldEnd:i.length>0,roundWinners:i}}function Ha(e){const{shouldEnd:t,roundWinners:a}=sr(e);if(!t)return e;const r=e.currentRound||1,n={...e.roundWinners,[r]:a},i=new Map;for(const[,s]of Object.entries(n))for(const d of s){const l=i.get(d)||0;i.set(d,l+1)}let o=null;for(const[s,d]of i.entries())if(d>=2){o=s;break}return I.info(`[endRound] Round ${r} ended. Winners: [${a.join(", ")}], Game winner: ${o||"none"}`),{...e,roundWinners:n,gameWinner:o,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function ir(e,t){if(e.currentPhase!==0)return I.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const a=e.players.find(i=>i.id===t);if(!a)return I.error(`[performPreparationPhase] Active player ${t} not found!`),e;I.info(`[performPreparationPhase] Player ${t} has deck size: ${a.deck.length}, hand size: ${a.hand.length}`);const r=e.players.map(i=>{if(i.id===t&&i.deck.length>0){const o=i.deck[0],s=[...i.deck.slice(1)],d=[...i.hand,o];return I.info(`[performPreparationPhase] Player ${t} drew card ${(o==null?void 0:o.id)||"unknown"}, deck now: ${s.length}, hand: ${d.length}`),{...i,deck:s,hand:d,readySetup:!1,readyCommit:!1}}return i});let n={...e,players:r,currentPhase:1};return Zt(n,t),sr(n).shouldEnd?Ha(n):(I.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${n.activePlayerId}`),n)}function Fa(e,t){const a=e.activePlayerId;if(a===t){const s={...e,activePlayerId:null};return t===e.startingPlayerId&&e.currentPhase===1&&sr(s).shouldEnd?Ha(s):s}if(!e.players.filter(s=>!s.isDisconnected).find(s=>s.id===t))return I.warn(`[toggleActivePlayer] Player ${t} not found or disconnected`),e;let i=e.turnNumber||1;t===e.startingPlayerId&&a!==null&&i++;const o={...e,activePlayerId:t,turnNumber:i,currentPhase:0};return ir(o,t)}function ns(e,t){const a=e.players.filter(i=>!i.isDisconnected).sort((i,o)=>i.id-o.id);if(a.length===0)return null;if(t===null)return a[0].id;const r=a.findIndex(i=>i.id===t);if(r===-1)return a[0].id;const n=(r+1)%a.length;return a[n].id}function os(e,t){var a;for(const r of e.board)for(const n of r)if(((a=n.card)==null?void 0:a.ownerId)===t)return!0;return!1}function ft(e){const t=ns(e,e.activePlayerId);if(t===null)return I.warn("[passTurnToNextPlayer] No next player found"),e;I.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${t}`);let a={...e,board:e.board.map(r=>r.map(n=>{var i;return((i=n.card)==null?void 0:i.ownerId)===e.activePlayerId&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(o=>o.type!=="Stun")}}:n}))};return a={...a,board:a.board.map(r=>r.map(n=>n.card&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(i=>i.type!=="enteredThisTurn")}}:n))},a={...a,activePlayerId:t,currentPhase:0,isScoringStep:!1,targetingMode:null},ir(a,t)}function jt(e,t,a){return I.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),e}function ss(e,t){return{type:"RECONNECT_SNAPSHOT",data:e}}function is(e,t,a){var r,n,i,o;try{const s=qo(e,a);I.info(`[WebRTCCodec] Received card state: ${(r=s.board)==null?void 0:r.length}x${((i=(n=s.board)==null?void 0:n[0])==null?void 0:i.length)||0}, ${((o=s.players)==null?void 0:o.length)||0} players`);const d={...t};return s.players&&(d.players=s.players.map(l=>{const m=t.players.find(E=>E.id===l.id);if(m){const E=l.id===a;return{...m,...l,hand:E?m.hand:l.hand,color:m.color}}return l})),s.board&&(d.board=s.board),s.currentPhase!==void 0&&(d.currentPhase=s.currentPhase),s.activePlayerId!==void 0&&(d.activePlayerId=s.activePlayerId),s.currentRound!==void 0&&(d.currentRound=s.currentRound),d}catch(s){return I.error("[WebRTCCodec] Failed to deserialize card state:",s),t}}function ds(e,t){try{const{effectType:a,timestamp:r,data:n}=Zo(e);I.debug(`[WebRTCCodec] Received ability effect: ${a}`);let i=t;switch(a){case 1:return{gameState:i,effectData:{type:"highlight",...n,timestamp:r}};case 2:return{gameState:i,effectData:{type:"floatingText",...n,timestamp:r}};case 3:return{gameState:i,effectData:{type:"noTarget",...n}};case 8:return{gameState:i,effectData:{type:"targetingMode",...n}};case 9:return{gameState:i,effectData:{type:"clearTargeting"}};default:return I.warn(`[WebRTCCodec] Unknown ability effect type: ${a}`),{gameState:i,effectData:null}}}catch(a){return I.error("[WebRTCCodec] Failed to handle ability effect:",a),{gameState:t,effectData:null}}}function cs(e,t){var a;try{const{eventType:r,data:n}=es(e);I.info(`[WebRTCCodec] Received session event: ${r}`);const i={...t};switch(r){case 1:I.info(`[WebRTCCodec] Player connected: ${n.playerName} (ID: ${n.playerId})`);break;case 2:I.info(`[WebRTCCodec] Player disconnected: ID: ${n.playerId}`),i.players=i.players.map(o=>o.id===n.playerId?{...o,isDisconnected:!0}:o);break;case 3:I.info(`[WebRTCCodec] Game starting, first player: ${n.startingPlayerId}`),i.isGameStarted=!0,n.startingPlayerId!==void 0&&(i.activePlayerId=n.startingPlayerId,i.startingPlayerId=n.startingPlayerId);break;case 4:I.info(`[WebRTCCodec] Round ${n.roundNumber} starting`),i.currentRound=n.roundNumber??1;break;case 5:if(I.info(`[WebRTCCodec] Round ${n.roundNumber} ended, winners: ${(a=n.winners)==null?void 0:a.join(", ")}`),i.isRoundEndModalOpen=!0,n.winners&&n.roundNumber!==void 0){const o=i.roundWinners||{};o[n.roundNumber]=n.winners,i.roundWinners=o}break;case 6:I.info(`[WebRTCCodec] Phase change: ${n.newPhase}`),n.newPhase!==void 0&&(i.currentPhase=n.newPhase),n.newActivePlayerId!==void 0&&(i.activePlayerId=n.newActivePlayerId);break;case 7:I.info(`[WebRTCCodec] Turn change: player ${n.newActivePlayerId}`),n.newActivePlayerId!==void 0&&(i.activePlayerId=n.newActivePlayerId);break;case 8:I.info(`[WebRTCCodec] Game ended, winner: ${n.gameWinner}`),n.gameWinner!==void 0&&(i.gameWinner=n.gameWinner===255?null:n.gameWinner);break;default:I.warn(`[WebRTCCodec] Unknown session event type: ${r}`)}return i}catch(r){return I.error("[WebRTCCodec] Failed to handle session event:",r),t}}function lt(e,t,a,r){return e===2?{gameState:is(t,a,r)}:e===3?ds(t,a):e===4?{gameState:cs(t,a)}:(I.warn(`[WebRTCCodec] Unknown codec message type: ${e}`),{gameState:a})}const Ot="avalon_game_state",at="reconnection_data";function Wa(e,t){var r;e.forEach(n=>n.forEach(i=>{var o;(o=i.card)!=null&&o.statuses&&(i.card.statuses=i.card.statuses.filter(s=>!(s.type==="LastPlayed"&&s.addedByPlayerId===t.id)))})),t.boardHistory||(t.boardHistory=[]);let a=!1;for(;t.boardHistory.length>0&&!a;){const n=t.boardHistory[t.boardHistory.length-1];for(let i=0;i<e.length;i++){for(let o=0;o<e[i].length;o++)if(((r=e[i][o].card)==null?void 0:r.id)===n){const s=e[i][o].card;if(!s||s.ownerId!==t.id)continue;s.statuses||(s.statuses=[]),s.statuses.push({type:"LastPlayed",addedByPlayerId:t.id}),a=!0;break}if(a)break}a||t.boardHistory.pop()}}function It(e){var r;if(!e||!Fe)return e;const{cardDatabase:t,tokenDatabase:a}=Fe;if(e.deck===De.Tokens||(r=e.id)!=null&&r.startsWith("TKN_")){if(e.baseId&&a[e.baseId]){const i=a[e.baseId];return{...e,imageUrl:i.imageUrl,fallbackImage:i.fallbackImage}}const n=Object.keys(a).find(i=>a[i].name===e.name);if(n){const i=a[n];return{...e,imageUrl:i.imageUrl,fallbackImage:i.fallbackImage,baseId:n}}}else if(e.baseId&&t[e.baseId]){const n=t[e.baseId];return{...e,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage}}return e}function St(e){var r,n;if(!Fe)return e;const t=((r=e.board)==null?void 0:r.map(i=>i.map(o=>({...o,card:o.card?It(o.card):null}))))||e.board,a=((n=e.players)==null?void 0:n.map(i=>{var o,s,d;return{...i,hand:((o=i.hand)==null?void 0:o.map(It))||[],deck:((s=i.deck)==null?void 0:s.map(It))||[],discard:((d=i.discard)==null?void 0:d.map(It))||[],announcedCard:i.announcedCard?It(i.announcedCard):null}}))||e.players;return{...e,board:t,players:a,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}}function ga(e,t,a){try{const r=St(e),n={gameState:r,localPlayerId:t,playerToken:a,timestamp:Date.now()};localStorage.setItem(Ot,JSON.stringify(n)),r.gameId&&t!==null&&localStorage.setItem(at,JSON.stringify({gameId:r.gameId,playerId:t,playerToken:a||null,timestamp:Date.now()}))}catch(r){console.warn("Failed to save game state:",r)}}function ls(){try{const e=localStorage.getItem(Ot);if(!e)return null;const t=JSON.parse(e),a=24*60*60*1e3;if(Date.now()-t.timestamp>a)return localStorage.removeItem(Ot),localStorage.removeItem(at),null;const r=t.gameState;return{gameState:St(r),localPlayerId:t.localPlayerId,playerToken:t.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}}function ut(){localStorage.removeItem(Ot),localStorage.removeItem(at)}function dr(e){const t=[...e];for(let a=t.length-1;a>0;a--){const r=Math.floor(Math.random()*(a+1));[t[a],t[r]]=[t[r],t[a]]}return t}function Ba(){return Math.random().toString(36).substring(2,18).toUpperCase()}function Ze(e,t,a){const r=Da();let n=e;if(e==="Random"||!r[e]){const s=Object.keys(r);if(s.length===0)return I.error("[createDeck] No decks loaded yet!"),[];n=s[0],e==="Random"||I.warn(`[createDeck] Deck ${e} not found, using ${n} instead`)}const i=r[n];if(!i)return I.error(`Deck data for ${n} not loaded! Returning empty deck. Available decks:`,Object.keys(r)),[];const o=[...i].map(s=>({...s,ownerId:t,ownerName:a}));return dr(o)}function Ya(e,t=!1){const a=Da(),r=Object.keys(a);if(r.length===0)return I.error("[createNewPlayer] No decks loaded yet!"),{id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:pt[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};const n=r[0],i={id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:n,color:pt[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};return i.deck=Ze(n,e,i.name),i}function rt(){return{players:[],spectators:[],board:Na(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:er.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}const wa=-1,us=-2,Et=1,Pt=2,ot=(e,t,a,r)=>{var s,d,l,m,E;const{card:n,ownerId:i,location:o}=e;if(t.targetOwnerId!==void 0&&t.targetOwnerId!==wa&&t.targetOwnerId!==us&&t.targetOwnerId!==i||t.excludeOwnerId!==void 0&&t.excludeOwnerId===i)return!1;if(t.onlyOpponents||t.targetOwnerId===wa){if(i===a)return!1;const _=r.find(D=>D.id===a),y=r.find(D=>D.id===i);if(_&&y&&_.teamId!==void 0&&_.teamId===y.teamId)return!1}if(t.targetType&&!((s=n.types)!=null&&s.includes(t.targetType))||t.onlyFaceDown&&((d=n.statuses)!=null&&d.some(_=>_.type==="Revealed"&&_.addedByPlayerId===a)||o==="board"&&!n.isFaceDown)||t.tokenType==="Revealed"&&(l=n.statuses)!=null&&l.some(_=>_.type==="Revealed"&&_.addedByPlayerId===a)||t.requiredTargetStatus&&(!((m=n.statuses)!=null&&m.some(_=>_.type===t.requiredTargetStatus))||t.requireStatusFromSourceOwner&&a!==null&&!((E=n.statuses)==null?void 0:E.some(y=>y.type===t.requiredTargetStatus&&y.addedByPlayerId===a))))return!1;if(t.mustBeAdjacentToSource&&t.sourceCoords&&e.boardCoords){const{row:_,col:y}=t.sourceCoords,{row:D,col:g}=e.boardCoords;if(Math.abs(_-D)+Math.abs(y-g)!==Et)return!1}if(t.mustBeInLineWithSource&&t.sourceCoords&&e.boardCoords){const{row:_,col:y}=t.sourceCoords,{row:D,col:g}=e.boardCoords;if(_!==D&&y!==g)return!1}if(t.maxDistanceFromSource!==void 0&&t.sourceCoords&&e.boardCoords){const{row:_,col:y}=t.sourceCoords,{row:D,col:g}=e.boardCoords;if(Math.max(Math.abs(_-D),Math.abs(y-g))>t.maxDistanceFromSource)return!1}if(t.maxOrthogonalDistance!==void 0&&t.sourceCoords&&e.boardCoords){const{row:_,col:y}=t.sourceCoords,{row:D,col:g}=e.boardCoords;if(Math.abs(_-D)+Math.abs(y-g)>t.maxOrthogonalDistance)return!1}return!0},vt=(e,t,a,r)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const n=[],i=t.board,o=i.length,s=t.activeGridSize,d=Math.floor((o-s)/2),l=d,m=d+s-1;if(e.type==="CREATE_STACK"){const g={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let w=l;w<=m;w++)for(let f=l;f<=m;f++){const A=i[w][f];A.card&&A.card.ownerId!==void 0&&ot({card:A.card,ownerId:A.card.ownerId,location:"board",boardCoords:{row:w,col:f}},g,a,t.players)&&n.push({row:w,col:f})}return n}const{mode:E,payload:_,sourceCoords:y,contextCheck:D}=e;if(E==="REVEREND_DOUBLE_EXPLOIT"){for(let g=l;g<=m;g++)for(let w=l;w<=m;w++)i[g][w].card&&n.push({row:g,col:w});return n}if((E==="SELECT_TARGET"||E==="CENSOR_SWAP"||E==="ZEALOUS_WEAKEN"||E==="CENTURION_BUFF"||E==="SELECT_UNIT_FOR_MOVE")&&_.filter&&typeof _.filter=="function"){if(_.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||_.actionType==="LUCIUS_SETUP"||_.actionType==="SELECT_HAND_FOR_DEPLOY"||_.handOnly)return[];for(let g=l;g<=m;g++)for(let w=l;w<=m;w++){const f=i[g][w];let A=f.card&&_.filter(f.card,g,w);if(A&&D==="ADJACENT_TO_LAST_MOVE"&&(r!=null&&r.lastMovedCardCoords)){const{row:T,col:u}=r.lastMovedCardCoords;Math.abs(g-T)+Math.abs(w-u)===1||(A=!1)}A&&n.push({row:g,col:w})}}else if(E==="SELECT_TARGET"&&(_.actionType==="ENHANCED_INT_REVEAL"||_.actionType==="ENHANCED_INT_MOVE"))for(let g=l;g<=m;g++)for(let w=l;w<=m;w++)i[g][w].card&&n.push({row:g,col:w});else if(E==="PATROL_MOVE"&&y)for(let g=l;g<=m;g++)for(let w=l;w<=m;w++){const f=g===y.row||w===y.col,A=g===y.row&&w===y.col,T=!i[g][w].card;f&&(T||A)&&n.push({row:g,col:w})}else if(E==="RIOT_PUSH"&&y){const g=[{r:y.row-1,c:y.col},{r:y.row+1,c:y.col},{r:y.row,c:y.col-1},{r:y.row,c:y.col+1}],w=(f,A)=>f>=l&&f<=m&&A>=l&&A<=m;g.forEach(f=>{if(w(f.r,f.c)){const A=i[f.r][f.c].card;if(A&&A.ownerId!==a){const T=t.players.find(p=>p.id===a),u=t.players.find(p=>p.id===A.ownerId);if(!((T==null?void 0:T.teamId)!==void 0&&(u==null?void 0:u.teamId)!==void 0&&T.teamId===u.teamId)){const p=f.r-y.row,S=f.c-y.col,v=f.r+p,M=f.c+S;w(v,M)&&(i[v][M].card||n.push({row:f.r,col:f.c}))}}}})}else if(E==="RIOT_MOVE"&&_.vacatedCoords)n.push(_.vacatedCoords),y&&n.push(y);else if(E==="SWAP_POSITIONS"&&_.filter)for(let g=l;g<=m;g++)for(let w=l;w<=m;w++){const f=i[g][w];f.card&&_.filter(f.card,g,w)&&n.push({row:g,col:w})}else if((E==="TRANSFER_STATUS_SELECT"||E==="TRANSFER_ALL_STATUSES")&&_.filter)for(let g=l;g<=m;g++)for(let w=l;w<=m;w++){const f=i[g][w];f.card&&_.filter(f.card,g,w)&&n.push({row:g,col:w})}else if(E==="SPAWN_TOKEN"||E==="SELECT_CELL"||E==="IMMUNIS_RETRIEVE")for(let g=l;g<=m;g++)for(let w=l;w<=m;w++){const f=!i[g][w].card;if(E==="IMMUNIS_RETRIEVE"&&_.filter){f&&_.filter(g,w)&&n.push({row:g,col:w});continue}if(E==="SELECT_CELL"){if(_.moveFromHand){f&&n.push({row:g,col:w});continue}if(!y)continue;const A=g===y.row&&w===y.col,T=_.range==="global";let u=!1;if(T)u=!0;else if(_.range==="line")u=g===y.row||w===y.col;else if(_.range===Pt){const c=Math.abs(g-y.row),p=Math.abs(w-y.col),S=c+p;if(S===Et)u=!0;else if(S===Pt){const v=[];c===Pt&&p===0?v.push({r:(g+y.row)/2,c:w}):c===0&&p===Pt?v.push({r:g,c:(w+y.col)/2}):c===Et&&p===Et&&(v.push({r:g,c:y.col}),v.push({r:y.row,c:w})),u=v.some(M=>M.r<0||M.r>=o||M.c<0||M.c>=o?!1:!i[M.r][M.c].card)}}else u=Math.abs(g-y.row)+Math.abs(w-y.col)===Et;(f&&u||_.allowSelf&&A)&&n.push({row:g,col:w})}else if(E==="SPAWN_TOKEN"&&y){const A=Math.abs(g-y.row)+Math.abs(w-y.col)===1;f&&A&&n.push({row:g,col:w})}}else if(E==="REVEAL_ENEMY"&&_.filter)for(let g=l;g<=m;g++)for(let w=l;w<=m;w++){const f=i[g][w];f.card&&_.filter(f.card,g,w)&&n.push({row:g,col:w})}else if(E==="SELECT_LINE_START")for(let g=l;g<=m;g++)for(let w=l;w<=m;w++)n.push({row:g,col:w});else if(E==="SELECT_LINE_END"&&_.firstCoords){const{row:g,col:w}=_.firstCoords;for(let f=l;f<=m;f++)n.push({row:g,col:f});for(let f=l;f<=m;f++)n.push({row:f,col:w})}else if(E==="INTEGRATOR_LINE_SELECT"&&y){const{row:g,col:w}=y;for(let f=l;f<=m;f++)n.push({row:g,col:f});for(let f=l;f<=m;f++)n.push({row:f,col:w})}else if(E==="ZIUS_LINE_SELECT"&&y){const{row:g,col:w}=y;for(let f=l;f<=m;f++)n.push({row:g,col:f});for(let f=l;f<=m;f++)n.push({row:f,col:w})}else if(E==="IP_AGENT_THREAT_SCORING"&&y){const{row:g,col:w}=y;for(let f=l;f<=m;f++)n.push({row:g,col:f});for(let f=l;f<=m;f++)n.push({row:f,col:w})}else if(E==="SELECT_DIAGONAL")if(_.firstCoords){const{row:g,col:w}=_.firstCoords;for(let f=l;f<=m;f++)for(let A=l;A<=m;A++)Math.abs(f-g)===Math.abs(A-w)&&n.push({row:f,col:A})}else for(let g=l;g<=m;g++)for(let w=l;w<=m;w++)n.push({row:g,col:w});return n},bt=(e,t,a,r)=>{var i,o,s,d,l;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let m=0;m<t.board.length;m++)for(let E=0;E<t.board[m].length;E++)if(t.board[m][E].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((i=e.payload)!=null&&i.actionType)){const m=e.payload.actionType;if(m==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||m==="LUCIUS_SETUP"||m==="SELECT_HAND_FOR_DEPLOY"){const E=((o=e.sourceCard)==null?void 0:o.ownerId)||a;if(E!==null){const _=t.players.find(y=>y.id===E);if(_&&_.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(vt(e,t,a,r).length>0)return!0;const E=["Aim","Exploit","Stun","Shield"];if(!(e.tokenType&&E.includes(e.tokenType))&&(e.tokenType==="Revealed"||(s=e.tokenType)!=null&&s.startsWith("Power")))for(const y of t.players)for(let D=0;D<y.hand.length;D++){const g={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(ot({card:y.hand[D],ownerId:y.id,location:"hand"},g,a,t.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((d=e.payload)!=null&&d.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const m of t.players)if(m.hand.some(E=>e.payload.filter(E))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return vt(e,t,a,r).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((l=e.payload)!=null&&l.filter),!1)};function fs(e){const{ws:t,webrtcManager:a,gameStateRef:r,localPlayerIdRef:n,webrtcIsHostRef:i,setLatestHighlight:o,setLatestFloatingTexts:s,setLatestNoTarget:d,setLatestDeckSelections:l,setLatestHandCardSelections:m,setClickWaves:E,setGameState:_}=e,y=U.useRef({}),D=500,g=U.useCallback(v=>{var k;const M={...v,timestamp:Date.now()};if(o(M),((k=t.current)==null?void 0:k.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:r.current.gameId,highlightData:M}));else if(a.current){const C={type:"HIGHLIGHT_TRIGGERED",senderId:a.current.getPeerId(),data:M,timestamp:Date.now()};i.current?a.current.broadcastToGuests(C):a.current.sendMessageToHost(C)}},[t,a,r,i,o]),w=U.useCallback(v=>{var L;const M=Array.isArray(v)?v:[v],k=Date.now(),C=M.map((G,P)=>({...G,timestamp:k+P}));if(s(C),((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:r.current.gameId,batch:C}));else if(a.current){const G={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:a.current.getPeerId(),data:{batch:C},timestamp:Date.now()};i.current?a.current.broadcastToGuests(G):a.current.sendMessageToHost(G)}},[t,a,r,i,s]),f=U.useCallback(v=>{var k;const M=Date.now();if(d({coords:v,timestamp:M}),((k=t.current)==null?void 0:k.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:r.current.gameId,coords:v,timestamp:M}));else if(a.current){const C={type:"NO_TARGET_TRIGGERED",senderId:a.current.getPeerId(),data:{coords:v,timestamp:M},timestamp:Date.now()};i.current?a.current.broadcastToGuests(C):a.current.sendMessageToHost(C)}},[t,a,r,i,d]),A=U.useCallback((v,M)=>{var C;const k={playerId:v,selectedByPlayerId:M,timestamp:Date.now()};if(l(L=>[...L,k]),((C=t.current)==null?void 0:C.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:r.current.gameId,deckSelectionData:k}));else if(a.current){const L={type:"DECK_SELECTION_TRIGGERED",senderId:a.current.getPeerId(),data:k,timestamp:Date.now()};i.current?a.current.broadcastToGuests(L):a.current.sendMessageToHost(L)}setTimeout(()=>{l(L=>L.filter(G=>G.timestamp!==k.timestamp))},1e3)},[t,a,r,i,l]),T=U.useCallback((v,M,k)=>{var L;const C={playerId:v,cardIndex:M,selectedByPlayerId:k,timestamp:Date.now()};if(m(G=>[...G,C]),((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:r.current.gameId,handCardSelectionData:C}));else if(a.current){const G={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:a.current.getPeerId(),data:C,timestamp:Date.now()};i.current?a.current.broadcastToGuests(G):a.current.sendMessageToHost(G)}setTimeout(()=>{m(G=>G.filter(P=>P.timestamp!==C.timestamp))},1e3)},[t,a,r,i,m]),u=U.useCallback(v=>{},[]),c=U.useCallback((v,M,k)=>{var $;if(n.current===null)return;const C=n.current,L=Date.now(),G=y.current[C]||0;if(L-G<D)return;y.current[C]=L;const P=r.current.players.find(B=>B.id===C);if(!P)return;const N={timestamp:Date.now(),location:v,boardCoords:M,handTarget:k,clickedByPlayerId:C,playerColor:P.color};if(console.log("[triggerClickWave] Creating wave:",N),E(B=>[...B,N]),(($=t.current)==null?void 0:$.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_CLICK_WAVE",gameId:r.current.gameId,wave:N}));else if(a.current){const B={type:"CLICK_WAVE_TRIGGERED",senderId:a.current.getPeerId(),data:N,timestamp:Date.now()};i.current?a.current.broadcastToGuests(B):a.current.sendMessageToHost(B)}setTimeout(()=>{E(B=>B.filter(q=>q.timestamp!==N.timestamp))},600)},[t,a,r,i,E]),p=U.useCallback((v,M,k,C,L,G)=>{var B;const P=r.current;if(!P||!P.board){console.warn("[setTargetingMode] No game state or board available");return}let N;C?N=C:k&&(N=vt(v,P,M,L));const $={playerId:M,action:v,sourceCoords:k,timestamp:Date.now(),boardTargets:N,handTargets:G};if(_(q=>({...q,targetingMode:$})),((B=t.current)==null?void 0:B.readyState)===WebSocket.OPEN&&P.gameId)t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:P.gameId,targetingMode:$}));else if(a.current){const q={type:"SET_TARGETING_MODE",senderId:a.current.getPeerId(),data:$,timestamp:Date.now()};i.current?a.current.broadcastToGuests(q):a.current.sendMessageToHost(q)}},[t,a,r,i,_]),S=U.useCallback(()=>{var M;const v=r.current;if(_(k=>({...k,targetingMode:null})),((M=t.current)==null?void 0:M.readyState)===WebSocket.OPEN&&(v!=null&&v.gameId))t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:v.gameId}));else if(a.current){const k={type:"CLEAR_TARGETING_MODE",senderId:a.current.getPeerId(),data:{},timestamp:Date.now()};i.current?a.current.broadcastToGuests(k):a.current.sendMessageToHost(k)}},[t,a,r,i,_]);return{triggerHighlight:g,triggerFloatingText:w,triggerNoTarget:f,triggerDeckSelection:A,triggerHandCardSelection:T,syncValidTargets:u,triggerClickWave:c,setTargetingMode:p,clearTargetingMode:S}}function ps(e){const{ws:t,webrtcManager:a,gameStateRef:r,webrtcIsHostRef:n,setGameState:i,updateState:o}=e,s=U.useCallback(_=>{var D;if(Oe()&&a.current&&n.current){i(g=>{const w=g.players.map(f=>{let A=1;for(const[T,u]of Object.entries(_))if(u.includes(f.id)){A=parseInt(T);break}return{...f,teamId:A}});return{...g,players:w}}),a.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:a.current.getPeerId(),data:{assignments:_},timestamp:Date.now()});return}((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:r.current.gameId,assignments:_}))},[t,a,r,n,i]),d=U.useCallback(_=>{var D;if(Oe()&&a.current&&n.current){i(g=>({...g,gameMode:_})),a.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:a.current.getPeerId(),data:{mode:_},timestamp:Date.now()});return}((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:r.current.gameId,mode:_}))},[t,a,r,n,i]),l=U.useCallback(_=>{var D;if(Oe()&&a.current&&n.current){i(g=>({...g,isPrivate:_})),a.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:a.current.getPeerId(),data:{isPrivate:_},timestamp:Date.now()});return}((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:r.current.gameId,isPrivate:_}))},[t,a,r,n,i]),m=U.useCallback(_=>{o(y=>{if(y.isGameStarted)return y;const D={...y,activeGridSize:_};if(y.board.length!==_){D.board=[];for(let w=0;w<_;w++){const f=[];for(let A=0;A<_;A++)f.push({card:null});D.board.push(f)}}return D})},[o]),E=U.useCallback(_=>{o(y=>{if(y.isGameStarted)return y;const D=y.players.filter(f=>!f.isDummy);if(D.length+_>bo)return y;const g=[...D],w=Math.max(...D.map(f=>f.id),0);for(let f=0;f<_;f++){const A=w+f+1,T=Ya(A,!0);T.name=`Dummy ${f+1}`,g.push(T)}return{...y,players:g,dummyPlayerCount:_}})},[o]);return{assignTeams:s,setGameMode:d,setGamePrivacy:l,setActiveGridSize:m,setDummyPlayerCount:E}}function ys(e){const{ws:t,webrtcManager:a,gameStateRef:r,localPlayerIdRef:n,webrtcIsHostRef:i,setGameState:o}=e,s=U.useCallback(()=>{var E;if(Oe()&&a.current&&i.current){o(_=>({..._,isReadyCheckActive:!0,isPrivate:!0})),a.current.broadcastToGuests({type:"START_READY_CHECK",senderId:a.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((E=t.current)==null?void 0:E.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:r.current.gameId}))},[t,a,r,i,o]),d=U.useCallback(()=>{var E;if(Oe()&&a.current&&i.current){o(_=>({..._,isReadyCheckActive:!1})),a.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:a.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((E=t.current)==null?void 0:E.readyState)===WebSocket.OPEN&&r.current.gameId?t.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:r.current.gameId})):o(_=>({..._,isReadyCheckActive:!1}))},[t,a,r,i,o]),l=U.useCallback(()=>{var E;const m=Oe();if(m&&a.current&&i.current&&n.current!==null){o(_=>{const y=_.players.map(f=>f.id===n.current?{...f,isReady:!0}:f),D={..._,players:y},g=D.players.filter(f=>!f.isDummy&&!f.isDisconnected);if(g.length>0&&g.every(f=>f.isReady)&&!D.isGameStarted){const f=D.players.filter(p=>!p.isDisconnected),A=Math.floor(Math.random()*f.length),T=f[A].id,u={...D};u.isReadyCheckActive=!1,u.isGameStarted=!0,u.startingPlayerId=T,u.activePlayerId=T,u.currentPhase=0,u.players=u.players.map(p=>{if(p.hand.length===0&&p.deck.length>0){const v=[...p.hand],M=[...p.deck];for(let k=0;k<6&&k<M.length;k++){const C=M[0];M.splice(0,1),v.push(C)}return I.info(`[playerReady] Drew initial ${v.length} cards for player ${p.id}`),{...p,hand:v,deck:M}}return p});const c=u.players.find(p=>p.id===T);if(c&&c.deck.length>0){const p=c.deck[0],S=[...c.deck.slice(1)],v=[...c.hand,p];u.players=u.players.map(M=>M.id===T?{...M,deck:S,hand:v,readySetup:!1,readyCommit:!1}:M),u.currentPhase=1}return a.current.broadcastGameState(u),a.current.broadcastToGuests({type:"GAME_START",senderId:a.current.getPeerId(),data:{startingPlayerId:T,activePlayerId:T,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),u}return a.current.broadcastToGuests({type:"HOST_READY",senderId:a.current.getPeerId(),playerId:n.current??void 0,timestamp:Date.now()}),D});return}if(m&&a.current&&!i.current&&n.current!==null){a.current.sendMessageToHost({type:"PLAYER_READY",senderId:a.current.getPeerId(),playerId:n.current,timestamp:Date.now()}),o(_=>({..._,players:_.players.map(y=>y.id===n.current?{...y,isReady:!0}:y)}));return}((E=t.current)==null?void 0:E.readyState)===WebSocket.OPEN&&r.current.gameId&&n.current!==null&&t.current.send(JSON.stringify({type:"PLAYER_READY",gameId:r.current.gameId,playerId:n.current}))},[t,a,r,n,i,o]);return{startReadyCheck:s,cancelReadyCheck:d,playerReady:l}}function hs(e){const{updateState:t,sendWebrtcAction:a,webrtcIsHostRef:r,webrtcManagerRef:n}=e,i=U.useCallback((s,d)=>{t(l=>l.isGameStarted?l:{...l,players:l.players.map(m=>m.id===s?{...m,name:d}:m)})},[t]),o=U.useCallback((s,d)=>{t(m=>({...m,players:m.players.map(E=>E.id===s?{...E,color:d}:E)})),a!==null&&(r!=null&&r.current&&(n!=null&&n.current)?n.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:n.current.getPeerId(),data:{playerId:s,color:d},timestamp:Date.now()}):!(r!=null&&r.current)&&a&&a("CHANGE_PLAYER_COLOR",{playerId:s,color:d}))},[t,a,r,n]);return{updatePlayerName:i,changePlayerColor:o}}function ms(e){const{updateState:t}=e,a=U.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const l=d.players.find(y=>y.id===s);if(!l||l.deck.length===0)return d;const m=Ee(d),E=m.players.find(y=>y.id===s),_=E.deck.shift();return _&&E.hand.push(_),m})},[t]),r=U.useCallback((s,d)=>{d<=0||t(l=>{if(!l.isGameStarted)return l;const m=l.players.find(D=>D.id===s);if(!m||m.deck.length===0)return l;const E=Ee(l),_=E.players.find(D=>D.id===s),y=Math.min(d,_.deck.length);for(let D=0;D<y;D++){const g=_.deck.shift();g&&_.hand.push(g)}return E})},[t]),n=U.useCallback(s=>{t(d=>{if(!d.isGameStarted||!d.players.find(_=>_.id===s))return d;const m=Ee(d),E=m.players.find(_=>_.id===s);return E.deck=dr([...E.deck]),m})},[t]),i=U.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const l={...d},m=l.board[s.row][s.col].card;return m&&(m.isFaceDown=!1),{...l,board:Ne(l)}})},[t]),o=U.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const l={...d},m=l.board[s.row][s.col].card;return m&&(m.isFaceDown=!0),{...l,board:Ne(l)}})},[t]);return{drawCard:a,drawCardsBatch:r,shufflePlayerDeck:n,flipBoardCard:i,flipBoardCardFaceDown:o}}function Is(e){const{localPlayerIdRef:t,updateState:a}=e,r=U.useCallback((f,A,T)=>{a(u=>{var S,v;if(!u.isGameStarted)return u;const c=Ee(u),p=c.board[f.row][f.col].card;if(p){if(A==="Stun"&&(p.baseId==="luciusTheImmortal"||p.name.includes("Lucius")&&((S=p.types)!=null&&S.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(A)&&((v=p.statuses)==null?void 0:v.some(k=>k.type===A&&k.addedByPlayerId===T)))return u;p.statuses||(p.statuses=[]),p.statuses.push({type:A,addedByPlayerId:T})}return c})},[a]),n=U.useCallback((f,A)=>{a(T=>{if(!T.isGameStarted)return T;const u=Ee(T),c=u.board[f.row][f.col].card;if(c!=null&&c.statuses){const p=c.statuses.map(S=>S.type).lastIndexOf(A);p>-1&&c.statuses.splice(p,1)}return u.board=Ne(u),u})},[a]),i=U.useCallback((f,A,T)=>{a(u=>{if(!u.isGameStarted)return u;const c=Ee(u),p=c.board[f.row][f.col].card;if(p!=null&&p.statuses){const S=p.statuses.findIndex(v=>v.type===A&&v.addedByPlayerId===T);S>-1&&p.statuses.splice(S,1)}return c.board=Ne(c),c})},[a]),o=U.useCallback((f,A)=>{a(T=>{if(!T.isGameStarted)return T;const u=Ee(T),c=u.board[f.row][f.col].card;return c&&(c.powerModifier===void 0&&(c.powerModifier=0),c.powerModifier+=A),u})},[a]),s=U.useCallback((f,A,T)=>{a(u=>{var S;if(!u.isGameStarted)return u;const c=Ee(u),p=c.players.find(v=>v.id===f);if(p!=null&&p.announcedCard){if(["Support","Threat","Revealed"].includes(A)&&((S=p.announcedCard.statuses)==null?void 0:S.some(M=>M.type===A&&M.addedByPlayerId===T)))return u;p.announcedCard.statuses||(p.announcedCard.statuses=[]),p.announcedCard.statuses.push({type:A,addedByPlayerId:T})}return c})},[a]),d=U.useCallback((f,A)=>{a(T=>{var p;if(!T.isGameStarted)return T;const u=Ee(T),c=u.players.find(S=>S.id===f);if((p=c==null?void 0:c.announcedCard)!=null&&p.statuses){const S=c.announcedCard.statuses.map(v=>v.type).lastIndexOf(A);S>-1&&c.announcedCard.statuses.splice(S,1)}return u})},[a]),l=U.useCallback((f,A)=>{a(T=>{if(!T.isGameStarted)return T;const u=Ee(T),c=u.players.find(p=>p.id===f);return c!=null&&c.announcedCard&&(c.announcedCard.powerModifier===void 0&&(c.announcedCard.powerModifier=0),c.announcedCard.powerModifier+=A),u})},[a]),m=U.useCallback((f,A,T,u)=>{a(c=>{var v;if(!c.isGameStarted)return c;const p=Ee(c),S=p.players.find(M=>M.id===f);if(S!=null&&S.hand[A]){const M=S.hand[A];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(T)&&((v=M.statuses)==null?void 0:v.some(C=>C.type===T&&C.addedByPlayerId===u)))return c;M.statuses||(M.statuses=[]),M.statuses.push({type:T,addedByPlayerId:u})}return p})},[a]),E=U.useCallback((f,A,T)=>{a(u=>{if(!u.isGameStarted)return u;const c=Ee(u),p=c.players.find(v=>v.id===f),S=p==null?void 0:p.hand[A];if(S!=null&&S.statuses){const v=S.statuses.map(M=>M.type).lastIndexOf(T);v>-1&&S.statuses.splice(v,1),T==="Revealed"&&(S.statuses.some(k=>k.type==="Revealed")||delete S.revealedTo)}return c})},[a]),_=U.useCallback((f,A,T)=>{a(u=>{const c=u.players.find(v=>v.id===f);if(!(c!=null&&c.hand[A]))return u;const p=Ee(u),S=p.players.find(v=>v.id===f).hand[A];if(T==="all")S.revealedTo="all",S.statuses||(S.statuses=[]),S.statuses.some(v=>v.type==="Revealed"&&v.addedByPlayerId===f)||S.statuses.push({type:"Revealed",addedByPlayerId:f});else{(!S.revealedTo||S.revealedTo==="all"||!Array.isArray(S.revealedTo))&&(S.revealedTo=[]);const v=T.filter(M=>!S.revealedTo.includes(M));S.revealedTo.push(...v)}return p})},[a]),y=U.useCallback((f,A)=>{a(T=>{if(!T.board[f.row][f.col].card)return T;const c=Ee(T),p=c.board[f.row][f.col].card,S=p.ownerId;if(A==="all")p.revealedTo="all",S!==void 0&&(p.statuses||(p.statuses=[]),p.statuses.some(v=>v.type==="Revealed"&&v.addedByPlayerId===S)||p.statuses.push({type:"Revealed",addedByPlayerId:S}));else{(!p.revealedTo||p.revealedTo==="all"||!Array.isArray(p.revealedTo))&&(p.revealedTo=[]);const v=A.filter(M=>!p.revealedTo.includes(M));p.revealedTo.push(...v)}return c})},[a]),D=U.useCallback((f,A)=>{a(T=>{var S;const u=f.boardCoords?(S=T.board[f.boardCoords.row][f.boardCoords.col].card)==null?void 0:S.ownerId:f.ownerId;if(!u)return T;const c=Ee(T),p=c.revealRequests.find(v=>v.fromPlayerId===A&&v.toPlayerId===u);return p?p.cardIdentifiers.some(M=>JSON.stringify(M)===JSON.stringify(f))||p.cardIdentifiers.push(f):c.revealRequests.push({fromPlayerId:A,toPlayerId:u,cardIdentifiers:[f]}),c})},[a]),g=U.useCallback((f,A)=>{a(T=>{const u=T.revealRequests.findIndex(S=>S.toPlayerId===t.current&&S.fromPlayerId===f);if(u===-1)return T;const c=Ee(T),p=c.revealRequests[u];if(A){const{cardIdentifiers:S}=p;for(const v of S){let M=null;if(v.source==="board"&&v.boardCoords)M=c.board[v.boardCoords.row][v.boardCoords.col].card;else if(v.source==="hand"&&v.ownerId&&v.cardIndex!==void 0){const k=c.players.find(C=>C.id===v.ownerId);k&&(M=k.hand[v.cardIndex])}M&&(M.statuses||(M.statuses=[]),M.statuses.some(k=>k.type==="Revealed"&&k.addedByPlayerId===f)||M.statuses.push({type:"Revealed",addedByPlayerId:f}))}}return c.revealRequests.splice(u,1),c})},[a,t]),w=U.useCallback(f=>{a(A=>{const T=Ee(A);let u=null;if(f.source==="board"&&f.boardCoords)u=T.board[f.boardCoords.row][f.boardCoords.col].card;else if(f.source==="hand"&&f.playerId&&f.cardIndex!==void 0){const c=T.players.find(p=>p.id===f.playerId);c&&(u=c.hand[f.cardIndex])}return u&&(u.statuses&&(u.statuses=u.statuses.filter(c=>c.type!=="Revealed")),delete u.revealedTo),T})},[a]);return{addBoardCardStatus:r,removeBoardCardStatus:n,removeBoardCardStatusByOwner:i,modifyBoardCardPower:o,addAnnouncedCardStatus:s,removeAnnouncedCardStatus:d,modifyAnnouncedCardPower:l,addHandCardStatus:m,removeHandCardStatus:E,revealHandCard:_,revealBoardCard:y,requestCardReveal:D,respondToRevealRequest:g,removeRevealedStatus:w}}function Es(e){const{webrtcIsHostRef:t,sendWebrtcAction:a,webrtcManagerRef:r,localPlayerIdRef:n,getCardDefinition:i,commandCardIds:o,createDeck:s,updateState:d}=e,l=U.useCallback((g,w)=>{const f=Oe();if(f&&!t.current)try{localStorage.setItem("webrtc_preferred_deck",w),I.info(`[changePlayerDeck] Saved deck preference: ${w}`)}catch(u){I.warn("[changePlayerDeck] Failed to save deck preference:",u)}const A=s(w,g,"Player "+g);if(d(u=>u.isGameStarted?u:{...u,players:u.players.map(c=>c.id===g?{...c,deck:A,selectedDeck:w,hand:[],discard:[],announcedCard:null,boardHistory:[]}:c)}),I.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${f}, isHost=${t.current}, hasSendAction=${!!a}, hasManager=${!!(r!=null&&r.current)}`),!f)return;const T=A.map(u=>({id:u.id,baseId:u.baseId,power:u.power,powerModifier:u.powerModifier||0,isFaceDown:u.isFaceDown||!1,statuses:u.statuses||[]}));t.current?r!=null&&r.current?(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:g,deckType:w,deck:T,deckSize:T.length}}),I.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${g}, deck ${w}, ${T.length} cards`)):I.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available"):a?(a("CHANGE_PLAYER_DECK",{playerId:g,deckType:w,deck:T,deckSize:T.length}),I.info(`[changePlayerDeck] Guest sending deck data to host: player ${g}, deck ${w}, ${T.length} cards`)):I.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[d,s,a,t,r,n]),m=U.useCallback((g,w)=>{const f=Oe();let A=[];const T=new Map;for(const{cardId:c,quantity:p}of w.cards){const S=i(c);if(!S)continue;const v=o.has(c),M=v?De.Command:De.Custom,k=v?"CMD":"CUS";for(let C=0;C<p;C++){const L=(T.get(c)||0)+1;T.set(c,L),A.push({...S,id:`${k}_${c.toUpperCase()}_${L}`,baseId:c,deck:M,ownerId:g,ownerName:"Player "+g})}}if(A=dr(A),d(c=>c.isGameStarted||!c.players.find(S=>S.id===g)?c:{...c,players:c.players.map(S=>S.id===g?{...S,deck:A,selectedDeck:De.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:S)}),!f)return;const u=A.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier||0,isFaceDown:c.isFaceDown||!1,statuses:c.statuses||[]}));t.current?r!=null&&r.current&&(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:g,deckType:De.Custom,deck:u,deckSize:u.length}}),I.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${g}, ${u.length} cards`)):a&&(a("CHANGE_PLAYER_DECK",{playerId:g,deckType:De.Custom,deck:u,deckSize:u.length}),I.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${g}, ${u.length} cards`))},[d,i,o,a,t,r,n]),E=U.useCallback((g,w,f,A)=>{d(T=>{if(!T.isGameStarted||T.board[f.row][f.col].card!==null)return T;const u=Ee(T),c=u.players.find(p=>p.id===g);if(c&&c.discard.length>w){const[p]=c.discard.splice(w,1);p.enteredThisTurn=!0,ar(p,g),(p.baseId==="luciusTheImmortal"||p.name.includes("Lucius"))&&(p.powerModifier===void 0&&(p.powerModifier=0),p.powerModifier+=2),p.statuses||(p.statuses=[]),p.statuses.push({type:"Resurrected",addedByPlayerId:g}),A&&A.forEach(S=>{var v;S.type!=="Resurrected"&&((v=p.statuses)==null||v.push({type:S.type,addedByPlayerId:g}))}),c.boardHistory||(c.boardHistory=[]),c.boardHistory.push(p.id),u.board[f.row][f.col].card=p,Wa(u.board,c),u.board=Ne(u)}return u})},[d]),_=U.useCallback((g,w)=>{d(f=>{const A=Ee(f),T=A.players.find(u=>u.id===g);if(T&&w.length>0){const u=new Set(w.map(p=>p.id)),c=T.deck.filter(p=>!u.has(p.id));T.deck=[...w,...c]}return A})},[d]),y=U.useCallback((g,w,f)=>{d(A=>{const T=Ee(A),u=T.players.find(c=>c.id===g);return u&&(f==="deck"?u.deck=w:f==="discard"&&(u.discard=w)),T})},[d]),D=U.useCallback((g,w)=>{d(f=>{if(!f.isGameStarted)return f;const A=Ee(f),T=A.players.find(u=>u.id===g);if(T&&T.discard.length>w){const[u]=T.discard.splice(w,1);T.hand.push(u)}return A})},[d]);return{changePlayerDeck:l,loadCustomDeck:m,resurrectDiscardedCard:E,reorderTopDeck:_,reorderCards:y,recoverDiscardedCard:D}}function Ts(e){const{ws:t,webrtcManagerRef:a,webrtcIsHostRef:r,gameStateRef:n,scoreDeltaAccumulator:i,setGameState:o,updateState:s,abilityMode:d,setAbilityMode:l,createDeck:m}=e,E=U.useCallback(T=>{Oe()&&a.current?r.current?o(c=>{const p=Fa(c,T);return a.current&&a.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:a.current.getPeerId(),data:{activePlayerId:p.activePlayerId,currentPhase:p.currentPhase,turnNumber:p.turnNumber},timestamp:Date.now()}),p}):a.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:T},timestamp:Date.now()}):t.current&&t.current.readyState===WebSocket.OPEN&&(i.forEach((c,p)=>{clearTimeout(c.timerId),I.info(`[ScoreFlush] Flushing on toggle: player=${p}, delta=${c.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:n.current.gameId,playerId:p,delta:c.delta}))}),i.clear(),t.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:n.current.gameId,playerId:T})))},[t,a,r,n,i,o]),_=U.useCallback((T,u)=>{t.current&&t.current.readyState===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:n.current.gameId,playerId:T,enabled:u}))},[]),y=U.useCallback(T=>{const u=d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode);u&&l(null),s(c=>{if(!c.isGameStarted)return c;const p=Math.max(1,Math.min(T,4));return{...c,currentPhase:p,...p===4&&!u?{isScoringStep:!0}:{},...u?{isScoringStep:!1}:{}}})},[s,d,l]),D=U.useCallback(()=>{var c;d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&l(null);const T=n.current,u=Oe();if(T.isGameStarted&&T.currentPhase===4&&T.isScoringStep&&!u){((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&(i.forEach((p,S)=>{clearTimeout(p.timerId),I.info(`[ScoreFlush] Flushing pending score: player=${S}, delta=${p.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:T.gameId,playerId:S,delta:p.delta}))}),i.clear(),t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:T.gameId})));return}if(u&&T.isGameStarted&&T.currentPhase===4&&T.isScoringStep){s(p=>ft(p));return}s(p=>{if(!p.isGameStarted)return p;const S=Ee(p),v=p.currentPhase+1;return p.preserveDeployAbilities||S.board.forEach(M=>{M.forEach(k=>{var C;(C=k.card)!=null&&C.statuses&&(k.card.statuses=k.card.statuses.filter(L=>L.type!=="readyDeploy"))})}),u&&v===4&&p.currentPhase===3?os(p,p.activePlayerId)?(S.isScoringStep=!0,S.currentPhase=4,S):(I.info(`[nextPhase] Player ${p.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),ft(p)):v===4&&p.currentPhase===3?(S.isScoringStep=!0,S.currentPhase=4,S):(S.board.forEach(M=>{M.forEach(k=>{var C;if((C=k.card)!=null&&C.statuses){const L=k.card.statuses.findIndex(G=>G.type==="Resurrected");if(L!==-1){const G=k.card.statuses[L].addedByPlayerId;k.card.statuses.splice(L,1),k.card.baseId!=="luciusTheImmortal"&&(k.card.statuses.push({type:"Stun",addedByPlayerId:G}),k.card.statuses.push({type:"Stun",addedByPlayerId:G}))}}})}),S.board=Ne(S),S.currentPhase=v,S)})},[s,d,l,n,t,i]),g=U.useCallback(()=>{s(T=>T.isGameStarted?(d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&l(null),T.isScoringStep?{...T,isScoringStep:!1,currentPhase:Math.max(1,T.currentPhase-1)}:{...T,currentPhase:Math.max(1,T.currentPhase-1)}):T)},[s,d,l]),w=U.useCallback(()=>{var u;Oe()?s(c=>({...c,isRoundEndModalOpen:!1,currentRound:(c.currentRound||1)+1,players:c.players.map(p=>({...p,score:0}))})):((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&n.current.gameId&&(o(c=>({...c,isRoundEndModalOpen:!1,currentRound:(c.currentRound||1)+1,players:c.players.map(p=>({...p,score:0}))})),t.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:n.current.gameId})))},[o,s,t,n]),f=U.useCallback(()=>{o(T=>({...T,isRoundEndModalOpen:!1}))},[o]),A=U.useCallback(()=>{var u;if(Oe()){const c=n.current,p=c.players.map(k=>{const C=k.selectedDeck||"SynchroTech";return{...k,hand:[],deck:m(C,k.id,k.name),discard:[],score:0,isReady:!1,announcedCard:null,boardHistory:[]}}),S=c.activeGridSize||8,v=[];for(let k=0;k<S;k++){const C=[];for(let L=0;L<S;L++)C.push({card:null});v.push(C)}const M={...c,players:p,board:v,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};o(M),n.current=M,a.current&&a.current.broadcastToGuests({type:"GAME_RESET",senderId:a.current.getPeerId(),data:{players:p.map(k=>({id:k.id,name:k.name,color:k.color,selectedDeck:k.selectedDeck,isDummy:k.isDummy,isDisconnected:k.isDisconnected,autoDrawEnabled:k.autoDrawEnabled,handSize:k.hand.length,deckSize:k.deck.length,discardSize:k.discard.length,...k.isDummy&&{hand:k.hand.map(C=>({id:C.id,baseId:C.baseId,name:C.name,imageUrl:C.imageUrl,power:C.power,powerModifier:C.powerModifier,ability:C.ability,ownerId:C.ownerId,color:C.color,deck:C.deck,isFaceDown:C.isFaceDown,types:C.types,faction:C.faction,statuses:C.statuses})),deck:k.deck.map(C=>({id:C.id,baseId:C.baseId,name:C.name,imageUrl:C.imageUrl,power:C.power,powerModifier:C.powerModifier,ability:C.ability,ownerId:C.ownerId,color:C.color,deck:C.deck,isFaceDown:C.isFaceDown,types:C.types,faction:C.faction,statuses:C.statuses})),discard:k.discard.map(C=>({id:C.id,baseId:C.baseId,name:C.name,imageUrl:C.imageUrl,power:C.power,powerModifier:C.powerModifier,ability:C.ability,ownerId:C.ownerId,color:C.color,deck:C.deck,isFaceDown:C.isFaceDown,types:C.types,faction:C.faction,statuses:C.statuses}))},score:k.score,isReady:k.isReady,announcedCard:k.announcedCard})),gameMode:M.gameMode,isPrivate:M.isPrivate,activeGridSize:M.activeGridSize,dummyPlayerCount:M.dummyPlayerCount,autoAbilitiesEnabled:M.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"RESET_GAME",gameId:n.current.gameId}))},[t,a,n,o,m]);return{toggleActivePlayer:E,toggleAutoDraw:_,setPhase:y,nextPhase:D,prevPhase:g,closeRoundEndModal:w,closeRoundEndModalOnly:f,resetGame:A}}function gs(e){const{ws:t,gameStateRef:a,updateState:r,updatePlayerScore:n,triggerFloatingText:i,clearTargetingMode:o}=e,s=U.useCallback((l,m,E,_,y)=>{var v,M;const D=a.current;if(!D.isGameStarted||D.isRoundEndModalOpen)return;const g=D.board.some(k=>k.some(C=>{var L,G;return((L=C.card)==null?void 0:L.ownerId)===y&&C.card.name.toLowerCase().includes("data liberator")&&((G=C.card.statuses)==null?void 0:G.some(P=>P.type==="Support"))})),w=D.board.length;let f=l,A=l,T=m,u=m;if(l===E)f=l,A=l,T=0,u=w-1;else if(m===_)T=m,u=m,f=0,A=w-1;else return;let c=0;const p=[];for(let k=f;k<=A;k++)for(let C=T;C<=u;C++){const G=D.board[k][C].card;if(G&&!((v=G.statuses)!=null&&v.some(P=>P.type==="Stun"))){const P=G.ownerId===y,N=(M=G.statuses)==null?void 0:M.some($=>$.type==="Exploit"&&$.addedByPlayerId===y);if(P||g&&N&&G.ownerId!==y){const $=Math.max(0,G.power+(G.powerModifier||0)+(G.bonusPower||0));$>0&&(c+=$,p.push({row:k,col:C,text:`+${$}`,playerId:y}))}}}p.length>0&&i(p);const S=Oe();if(S?r(k=>({...k,players:k.players.map(C=>C.id===y?{...C,score:Math.max(0,(C.score||0)+c)}:C)})):n(y,c),S||n(y,c),c>0&&D.currentPhase===4&&D.activePlayerId===y){const k=D.gameId;setTimeout(()=>{var C;o==null||o(),S?r(L=>ft(L)):((C=t.current)==null?void 0:C.readyState)===WebSocket.OPEN&&k&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:k}))},100)}},[i,n,r,t,a,o,ft]),d=U.useCallback((l,m,E,_,y,D)=>{var S,v;const g=a.current;if(!g.isGameStarted||g.isRoundEndModalOpen)return;const w=E>l?1:-1,f=_>m?1:-1,A=Math.abs(l-E);let T=0,u=0;const c=[];for(let M=0;M<=A;M++){const k=l+M*w,C=m+M*f;if(k<0||k>=g.board.length||C<0||C>=g.board.length)continue;const G=g.board[k][C].card;if(G&&!((S=G.statuses)!=null&&S.some(P=>P.type==="Stun"))&&G.ownerId===y){const N=Math.max(0,G.power+(G.powerModifier||0)+(G.bonusPower||0));N>0&&(T+=N,c.push({row:k,col:C,text:`+${N}`,playerId:y})),D&&((v=G.statuses)!=null&&v.some($=>$.type==="Support"&&$.addedByPlayerId===y))&&(u+=1)}}D==="point_per_support"&&u>0&&(T+=u),c.length>0&&i(c);const p=Oe();if(p?r(M=>({...M,players:M.players.map(k=>k.id===y?{...k,score:Math.max(0,(k.score||0)+T)}:k)})):n(y,T),p||n(y,T),D==="draw_per_support"&&u>0&&r(M=>{const k=Ee(M),C=k.players.find(L=>L.id===y);if(C&&C.deck.length>0)for(let L=0;L<u;L++)C.deck.length>0&&C.hand.push(C.deck.shift());return k}),T>0&&g.currentPhase===4&&g.activePlayerId===y){const M=g.gameId;setTimeout(()=>{var k;o==null||o(),p?r(C=>ft(C)):((k=t.current)==null?void 0:k.readyState)===WebSocket.OPEN&&M&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:M}))},500)}},[i,n,r,t,a,o,ft]);return{scoreLine:s,scoreDiagonal:d}}const ws=e=>{const{updateState:t,rawJsonData:a}=e,r=U.useCallback((E,_,y,D)=>{t(g=>{var A,T;if(!g.isGameStarted||E.row<0||E.col<0)return g;const w=Ee(g),f=(T=(A=w.board[E.row])==null?void 0:A[E.col])==null?void 0:T.card;if(f){const u=f.statuses?f.statuses.map(c=>c.type):[];if(D&&f.statuses){f.statuses=f.statuses.filter(p=>p.type!==D);const c=f.statuses.map(p=>p.type);I.debug(`[markAbilityUsed] Removed status '${D}' from ${f.name} at [${E.row},${E.col}]: [${u.join(", ")}] -> [${c.join(", ")}]`)}else I.debug(`[markAbilityUsed] Called for ${f.name} at [${E.row},${E.col}] but no readyStatusToRemove specified. Current statuses: [${u.join(", ")}]`)}return w})},[t]),n=U.useCallback(E=>{t(_=>{var g,w;if(!_.isGameStarted||E.row<0||E.col<0)return _;const y=Ee(_),D=(w=(g=y.board[E.row])==null?void 0:g[E.col])==null?void 0:w.card;if(D&&(D.statuses||(D.statuses=[]),(D.ability||"").toLowerCase().includes("deploy:")&&!D.statuses.some(A=>A.type==="readyDeploy"))){const A=D.ownerId;if(A==null||A===0)return _;D.statuses.push({type:"readyDeploy",addedByPlayerId:A})}return y})},[t]),i=U.useCallback((E,_)=>{t(y=>{if(!y.isGameStarted)return y;const D=Ee(y),g=D.board[E.row][E.col].card;return g!=null&&g.statuses&&(g.statuses=g.statuses.filter(w=>w.type!==_)),D.board=Ne(D),D})},[t]),o=U.useCallback((E,_,y,D,g)=>{t(w=>{if(!w.isGameStarted)return w;const f=Ee(w);return _.forEach(({row:A,col:T})=>{var c;const u=f.board[A][T].card;if(u){if(y==="Stun"&&(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius")&&((c=u.types)!=null&&c.includes("Hero"))))return;u.statuses||(u.statuses=[]),["Support","Threat","Revealed"].includes(y)?u.statuses.some(S=>S.type===y&&S.addedByPlayerId===D)||u.statuses.push({type:y,addedByPlayerId:D}):u.statuses.push({type:y,addedByPlayerId:D})}}),f})},[t]),s=U.useCallback((E,_)=>{t(y=>{if(!y.isGameStarted)return y;const D=Ee(y),g=D.board[E.row][E.col].card,w=D.board[_.row][_.col].card;return D.board[E.row][E.col].card=w,D.board[_.row][_.col].card=g,D.board=Ne(D),D})},[t]),d=U.useCallback((E,_,y)=>{t(D=>{if(!D.isGameStarted)return D;const g=Ee(D),w=g.board[E.row][E.col].card,f=g.board[_.row][_.col].card;if(w&&f&&w.statuses){const A=w.statuses.findIndex(T=>T.type===y);if(A>-1){const[T]=w.statuses.splice(A,1);f.statuses||(f.statuses=[]),f.statuses.push(T)}}return g.board=Ne(g),g})},[t]),l=U.useCallback((E,_)=>{t(y=>{if(!y.isGameStarted)return y;const D=Ee(y),g=D.board[E.row][E.col].card,w=D.board[_.row][_.col].card,f=["Support","Threat","LastPlayed"];if(g&&w&&g.statuses){const A=g.statuses.filter(u=>!f.includes(u.type)),T=g.statuses.filter(u=>f.includes(u.type));A.length>0&&(w.statuses||(w.statuses=[]),w.statuses.push(...A),g.statuses=T)}return D.board=Ne(D),D})},[t]),m=U.useCallback((E,_,y)=>{t(D=>{if(!D.isGameStarted)return D;const g=Ee(D);if(!a)return D;const w=a.tokenDatabase,f=Object.keys(w).find(u=>w[u].name===_);if(!f)return D;const A=w[f],T=g.players.find(u=>u.id===y);if(A&&g.board[E.row][E.col].card===null){const u={id:`TKN_${_.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:De.Tokens,name:_,baseId:A.baseId||f,imageUrl:A.imageUrl,fallbackImage:A.fallbackImage,power:A.power,ability:A.ability,flavorText:A.flavorText,color:A.color,types:A.types||["Unit"],faction:"Tokens",ownerId:y,ownerName:T==null?void 0:T.name,enteredThisTurn:!0,statuses:[]};ar(u,y),g.board[E.row][E.col].card=u}return g.board=Ne(g),g})},[t,a]);return{markAbilityUsed:r,applyGlobalEffect:o,swapCards:s,transferStatus:d,transferAllCounters:l,spawnToken:m,resetDeployStatus:n,removeStatusByType:i}};function _s(e){const{updateState:t,localPlayerIdRef:a,updatePlayerScore:r}=e,n=U.useCallback((o,s)=>{t(d=>{var g,w,f,A,T,u;if(!d.isGameStarted||s.target==="board"&&s.boardCoords&&d.board[s.boardCoords.row][s.boardCoords.col].card!==null&&o.source!=="counter_panel")return d;let l=!1;try{const c=localStorage.getItem("auto_abilities_enabled");l=c===null?!0:c==="true"}catch{l=!0}const m=l&&d.currentPhase===1&&o.source==="hand"&&s.target==="board"&&(((g=o.card.types)==null?void 0:g.includes("Unit"))||((w=o.card.types)==null?void 0:w.includes("Command"))),E=Ee(d);if(o.source==="board"&&["hand","deck","discard"].includes(s.target)&&!o.bypassOwnershipCheck){const c=o.card.ownerId,p=E.players.find(M=>M.id===c),S=c===a.current,v=!!(p!=null&&p.isDummy);if(!S&&!v)return d}let _=null;if(o.source==="board"&&s.target==="board"&&o.boardCoords){const c=E.board[o.boardCoords.row][o.boardCoords.col];c.card&&(_=c.card);const S=d.board[o.boardCoords.row][o.boardCoords.col].card||_;if(S&&((f=S.statuses)==null?void 0:f.some(M=>M.type==="Stun"))){const M=a.current,k=S.ownerId,C=d.players.find(N=>N.id===M),L=d.players.find(N=>N.id===k),G=M===k,P=(C==null?void 0:C.teamId)!==void 0&&(L==null?void 0:L.teamId)!==void 0&&C.teamId===L.teamId;if((G||P)&&!o.isManual)return d}}if(o.source==="counter_panel"&&o.statusType){const c=st[o.statusType],p=(c==null?void 0:c.allowedTargets)??["board","hand"];if(!p.includes(s.target)&&!p.includes("board-facedown"))return d;let S=null;if(s.target==="board"&&s.boardCoords){if(S=E.board[s.boardCoords.row][s.boardCoords.col].card,p.includes("board-facedown")&&S&&!S.isFaceDown)return d}else if(s.playerId!==void 0){const v=E.players.find(M=>M.id===s.playerId);v&&(s.target==="hand"&&s.cardIndex!==void 0&&(S=v.hand[s.cardIndex]),s.target==="announced"&&(S=v.announcedCard||null),s.target==="deck"&&v.deck.length>0?s.deckPosition==="top"||!s.deckPosition?S=v.deck[0]:S=v.deck[v.deck.length-1]:s.target==="discard"&&v.discard.length>0&&(S=v.discard[v.discard.length-1]))}if(S){if(o.statusType==="Revealed"){const k=a.current;if(s.target==="board"&&S.ownerId===k||s.target==="hand"&&s.playerId===k)return d}if(o.statusType==="Stun"&&(S.baseId==="luciusTheImmortal"||S.name.includes("Lucius")&&((A=S.types)!=null&&A.includes("Hero"))))return E;const v=o.count||1;let M;if(o.ownerId!==void 0)M=o.ownerId;else if(o.card.ownerId!==void 0)M=o.card.ownerId;else{const k=E.players.find(C=>C.id===E.activePlayerId);M=k!=null&&k.isDummy?k.id:a.current!==null?a.current:0}if(o.statusType==="Power+")S.powerModifier===void 0&&(S.powerModifier=0),S.powerModifier+=1*v;else if(o.statusType==="Power-")S.powerModifier===void 0&&(S.powerModifier=0),S.powerModifier-=1*v;else if(o.statusType==="Revealed"&&s.target==="hand"){if(S.revealedTo||(S.revealedTo=[]),S.revealedTo!=="all"){const k=Array.isArray(S.revealedTo)?S.revealedTo:[];k.includes(M)||k.push(M),S.revealedTo=k}}else if(S.statuses||(S.statuses=[]),o.replaceStatusType&&o.statusType)for(let k=0;k<v;k++){const C=S.statuses.findIndex(L=>L.type===o.replaceStatusType&&L.addedByPlayerId===M);C!==-1?S.statuses[C]={type:o.statusType,addedByPlayerId:M}:S.statuses.push({type:o.statusType,addedByPlayerId:M})}else for(let k=0;k<v;k++)["Support","Threat","Revealed"].includes(o.statusType)?S.statuses.some(L=>L.type===o.statusType&&L.addedByPlayerId===M)||S.statuses.push({type:o.statusType,addedByPlayerId:M}):S.statuses.push({type:o.statusType,addedByPlayerId:M});return s.target==="board"&&(E.board=Ne(E)),E}return d}const y=_?{..._}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const c=E.players.find(p=>p.id===o.playerId);if(c){const p=c.hand[o.cardIndex];if(p&&p.id===o.card.id&&p.ownerId===o.card.ownerId)c.hand.splice(o.cardIndex,1);else{const S=c.hand.findIndex(v=>v.id===o.card.id&&v.ownerId===o.card.ownerId);if(S!==-1)c.hand.splice(S,1);else return d}}}else if(o.source==="board"&&o.boardCoords){const c=E.board[o.boardCoords.row][o.boardCoords.col];if(c.card&&c.card.id===o.card.id&&c.card.ownerId===o.card.ownerId)E.board[o.boardCoords.row][o.boardCoords.col].card=null;else return d}else if(o.source==="discard"&&o.playerId!==void 0){const c=E.players.find(p=>p.id===o.playerId);if(c){let p=!1;if(o.cardIndex!==void 0){const S=c.discard[o.cardIndex];S&&S.id===o.card.id&&S.ownerId===o.card.ownerId&&(c.discard.splice(o.cardIndex,1),p=!0)}if(!p){const S=c.discard.findIndex(v=>v.id===o.card.id&&v.ownerId===o.card.ownerId);if(S!==-1)c.discard.splice(S,1);else return d}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const c=E.players.find(p=>p.id===o.playerId);if(c){const p=c.deck[o.cardIndex];if(p&&p.id===o.card.id&&p.ownerId===o.card.ownerId)c.deck.splice(o.cardIndex,1);else{const S=c.deck.findIndex(v=>v.id===o.card.id&&v.ownerId===o.card.ownerId);if(S!==-1)c.deck.splice(S,1);else return d}}}else if(o.source==="announced"&&o.playerId!==void 0){const c=E.players.find(p=>p.id===o.playerId);if(c)if(c.announcedCard&&c.announcedCard.id===o.card.id)c.announcedCard=null;else return d}if(["hand","deck","discard"].includes(s.target))y.statuses&&(y.statuses=y.statuses.filter(c=>c.type==="Revealed")),y.isFaceDown=!1,delete y.powerModifier,delete y.bonusPower,delete y.enteredThisTurn;else if(s.target==="board"&&(y.statuses||(y.statuses=[]),o.source!=="board"&&y.isFaceDown===void 0&&(y.isFaceDown=!1),o.source!=="board")){y.enteredThisTurn=!0;let c=y.ownerId;if(c===void 0){if(o.source==="token_panel"){const p=E.players.find(S=>S.id===E.activePlayerId);p!=null&&p.isDummy&&a.current!==null?c=a.current:o.ownerId!==void 0?c=o.ownerId:c=E.activePlayerId??a.current??0}else o.playerId!==void 0?c=o.playerId:c=a.current??0;y.ownerId=c}ar(y,c),o.source==="discard"&&(y.baseId==="luciusTheImmortal"||y.name.includes("Lucius"))&&(y.powerModifier===void 0&&(y.powerModifier=0),y.powerModifier+=2)}if(s.target==="hand"&&s.playerId!==void 0){if(y.deck===De.Tokens)return E.board[o.sourceBoardCoords.row][o.sourceBoardCoords.col].card=null,E;Ht(y);const p=E.players.find(v=>v.id===s.playerId);if(!p)return d;let S=s.cardIndex!==void 0?s.cardIndex:p.hand.length;if(o.source==="hand"&&o.playerId===s.playerId&&o.cardIndex!==void 0&&(o.cardIndex<S&&(S-=1),o.cardIndex===S))return d;p.hand.splice(S,0,y)}else if(s.target==="board"&&s.boardCoords){if(E.board[s.boardCoords.row][s.boardCoords.col].card===null){if(y.ownerId===void 0&&a.current!==null){const c=E.players.find(p=>p.id===a.current);c&&(y.ownerId=c.id,y.ownerName=c.name)}if(o.source!=="board"&&y.ownerId!==void 0){const c=E.players.find(p=>p.id===y.ownerId);c&&(c.boardHistory||(c.boardHistory=[]),c.boardHistory.push(y.id))}E.board[s.boardCoords.row][s.boardCoords.col].card=y}}else if(s.target==="discard"&&s.playerId!==void 0){if(y.deck===De.Tokens)return E.board[o.sourceBoardCoords.row][o.sourceBoardCoords.col].card=null,E;Ht(y),y.statuses&&(y.statuses=y.statuses.filter(S=>S.type!=="Revealed"));const p=E.players.find(S=>S.id===s.playerId);p&&(y.ownerId===void 0&&(y.ownerId=s.playerId,y.ownerName=p.name),p.discard.some(v=>v.id===y.id)||p.discard.push(y))}else if(s.target==="deck"&&s.playerId!==void 0){if(y.deck===De.Tokens)return E.board[o.sourceBoardCoords.row][o.sourceBoardCoords.col].card=null,E;Ht(y),y.statuses&&(y.statuses=y.statuses.filter(S=>S.type!=="Revealed"));const p=E.players.find(S=>S.id===s.playerId);if(!p)return d;y.ownerId===void 0&&(y.ownerId=s.playerId,y.ownerName=p.name),s.deckPosition==="top"||!s.deckPosition?p.deck.unshift(y):p.deck.push(y)}else if(s.target==="announced"&&s.playerId!==void 0){const c=E.players.find(p=>p.id===s.playerId);c&&(c.announcedCard&&(c.announcedCard.statuses&&(c.announcedCard.statuses=c.announcedCard.statuses.filter(p=>p.type==="Revealed")),delete c.announcedCard.enteredThisTurn,delete c.announcedCard.powerModifier,delete c.announcedCard.bonusPower,c.hand.push(c.announcedCard)),c.announcedCard=y)}if(o.source==="board"&&s.target!=="board"&&y.ownerId!==void 0){const c=E.players.find(p=>p.id===y.ownerId);c&&(c.boardHistory||(c.boardHistory=[]),c.boardHistory=c.boardHistory.filter(p=>p!==y.id))}if((o.source==="board"||s.target==="board")&&y.ownerId!==void 0){const c=E.players.find(p=>p.id===y.ownerId);c&&Wa(E.board,c)}if(o.source==="hand"&&s.target==="board"){const c=y;if(c.revealedTo==="all"||((T=c.statuses)==null?void 0:T.some(S=>S.type==="Revealed"))){const S=E.board.length;for(let v=0;v<S;v++)for(let M=0;M<S;M++){const k=E.board[v][M].card;if(k&&k.name.toLowerCase().includes("vigilant spotter")&&k.ownerId!==c.ownerId&&(E.board=Ne(E),(u=E.board[v][M].card.statuses)!=null&&u.some(L=>L.type==="Support"))){const L=E.players.find(G=>G.id===k.ownerId);L&&setTimeout(()=>{r(L.id,2)},0)}}}}return(o.source==="board"||s.target==="board")&&(E.board=Ne(E)),m&&(E.currentPhase=2),E})},[t,a,r]),i=U.useCallback((o,s)=>{t(d=>{if(!d.isGameStarted)return d;const l=Ee(d),m=l.board.length;if(o.row<0||o.row>=m||o.col<0||o.col>=m||s.row<0||s.row>=m||s.col<0||s.col>=m)return d;const E=l.board[o.row][o.col],_=l.board[s.row][s.col],y=E.card,D=_.card;return!y||!D?d:(l.board[o.row][o.col].card=D,l.board[s.row][s.col].card=y,l.board=Ne(l),l)})},[t]);return{moveItem:n,swapBoardCards:i}}function bs(e){const{ws:t,webrtcManager:a,gameStateRef:r,webrtcIsHostRef:n,setGameState:i}=e,o=U.useCallback((d,l,m,E,_,y)=>{var T,u,c,p,S,v,M;const D=r.current;if(typeof l!="number"){I.error(`[TargetingMode] Invalid playerId type: ${typeof l}, value:`,l);return}let g=[];E?g=E:g=vt(d,D,l,_);let w=[];if(y)w=y;else if(w=[],d.mode,(T=d.payload)!=null&&T.filter&&d.mode==="SELECT_TARGET"){I.info("[TargetingMode] Calculating hand targets for action",{actionMode:d.mode,filterType:typeof d.payload.filter,hasActionType:!!d.payload.actionType});for(const k of D.players)k.hand&&k.hand.forEach((C,L)=>{try{d.payload.filter(C)&&(w.push({playerId:k.id,cardIndex:L}),I.debug(`[TargetingMode] Found hand target: player ${k.id}, card ${L}, card ${C.name}`))}catch(G){I.warn(`[TargetingMode] Filter failed for card ${C.name}:`,G)}});I.info(`[TargetingMode] Hand targets calculated: ${w.length} targets`)}else I.info("[TargetingMode] No hand targets calculated - no filter or wrong mode",{hasFilter:!!((u=d.payload)!=null&&u.filter),mode:d.mode});const f=d.mode==="SELECT_DECK",A={playerId:l,action:d,sourceCoords:m,timestamp:Date.now(),boardTargets:g,handTargets:w.length>0?w:void 0,isDeckSelectable:f||void 0,originalOwnerId:d.originalOwnerId};if(i(k=>({...k,targetingMode:A})),r.current.targetingMode=A,((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&D.gameId&&t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:D.gameId,targetingMode:A})),a.current)if(n.current)a.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((S=(p=a.current).getPeerId)==null?void 0:S.call(p))??void 0,data:{targetingMode:A},timestamp:Date.now()});else{const k=a.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((M=(v=a.current).getPeerId)==null?void 0:M.call(v))??void 0,data:{targetingMode:A},timestamp:Date.now()});I.info("[TargetingMode] Guest sent SET_TARGETING_MODE to host",{success:k,playerId:l,boardTargetsCount:g.length,handTargetsCount:w.length})}I.info(`[TargetingMode] Player ${l} (type: ${typeof l}) activated targeting mode`,{mode:d.mode,boardTargetsCount:g.length,handTargetsCount:w.length,isDeckSelectable:f||!1})},[t,a,r,n,i]),s=U.useCallback(()=>{var l,m,E,_,y;const d=r.current;i(D=>({...D,targetingMode:null})),r.current.targetingMode=null,((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&d.gameId&&t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:d.gameId})),a.current&&(n.current?a.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((E=(m=a.current).getPeerId)==null?void 0:E.call(m))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):a.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((y=(_=a.current).getPeerId)==null?void 0:y.call(_))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[t,a,r,n,i]);return{setTargetingMode:o,clearTargetingMode:s}}function As(e){const{webrtcManagerRef:t,webrtcIsHostRef:a,setWebrtcIsHost:r,setConnectionStatus:n,setWebrtcHostId:i,gameStateRef:o,localPlayerIdRef:s}=e,d=U.useCallback(async()=>{var y;if(!t.current)return I.error("WebRTC manager not initialized"),null;try{r(!0),n("Connecting");const D=await t.current.initializeAsHost();i(D),n("Connected");const g=o.current.gameId;g&&Qt(D,g);const w=(y=o.current.players)==null?void 0:y.find(f=>f.id===s.current);return xo({peerId:D,isHost:!0,playerName:(w==null?void 0:w.name)||null}),I.info("[initializeWebrtcHost] Saved host data for auto-restore"),D}catch(D){return I.error("Failed to initialize WebRTC host:",D),n("Disconnected"),null}},[t,r,n,i,o,s]),l=U.useCallback(async y=>{if(!t.current)return I.error("WebRTC manager not initialized"),!1;try{return r(!1),i(y),n("Connecting"),await t.current.initializeAsGuest(y),!0}catch(D){return I.error("Failed to connect as guest:",D),n("Disconnected"),!1}},[t,r,n,i]),m=U.useCallback((y,D)=>t.current?a.current?(I.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):t.current.sendAction(y,D):(I.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[t,a]),E=U.useCallback(y=>{var g,w;if(!t.current||a.current)return I.warn("[requestDeckView] Only guests can request deck view from host"),!1;const D={type:"REQUEST_DECK_VIEW",senderId:t.current.getPeerId(),playerId:a.current||(w=(g=t.current).getLocalPlayerId)==null?void 0:w.call(g),data:{targetPlayerId:y},timestamp:Date.now()};return t.current.sendMessageToHost(D)},[t,a]),_=U.useCallback((y,D,g)=>!t.current||a.current?(I.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):t.current.sendFullDeckToHost(y,D,g),[t,a]);return{initializeWebrtcHost:d,connectAsGuest:l,sendWebrtcAction:m,requestDeckView:E,sendFullDeckToHost:_}}function Ss(){const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return I.warn("No custom WebSocket URL configured in settings."),null;let t=e.trim();return t.endsWith("/")&&(t=t.slice(0,-1)),t.startsWith("https://")?t=t.replace("https://","wss://"):t.startsWith("http://")&&(t=t.replace("http://","ws://")),!t.startsWith("ws://")&&!t.startsWith("wss://")?(I.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",t),t)}function Cs(e){const{gameStateRef:t,localPlayerIdRef:a,setGameState:r,setLocalPlayerId:n,setConnectionStatus:i,setGamesList:o,setLatestHighlight:s,setLatestNoTarget:d,setLatestDeckSelections:l,setLatestHandCardSelections:m,setClickWaves:E,setLatestFloatingTexts:_,setRemoteValidTargets:y,isManualExitRef:D,joiningGameIdRef:g,playerTokenRef:w,receivedServerStateRef:f,isJoinAttemptRef:A}=e,T=U.useRef(null),u=U.useRef(null),c=U.useCallback(()=>{if(Oe()){i("Connected");return}if(D.current||T.current&&(T.current.readyState===WebSocket.OPEN||T.current.readyState===WebSocket.CONNECTING))return;const L=Ss();if(!L){I.warn("No WebSocket URL configured in settings. Waiting for user input."),i("Disconnected"),u.current&&clearTimeout(u.current);return}try{T.current=new WebSocket(L)}catch(G){I.error("Failed to create WebSocket:",G),i("Disconnected"),u.current&&clearTimeout(u.current),u.current=window.setTimeout(c,se.RECONNECT_DELAY);return}i("Connecting"),T.current.onopen=()=>{var N;f.current=!1,i("Connected");const G=localStorage.getItem("custom_ws_url");G&&G.trim()!==""&&localStorage.setItem("websocket_url",G.trim());const P=t.current;if(I.info("Current gameState on open:",P?`gameId=${P.gameId}`:"null"),I.info("playerTokenRef.current on open:",w.current?"YES":"NO"),P&&P.gameId&&((N=T.current)==null?void 0:N.readyState)===WebSocket.OPEN){let $=w.current;if(!$){try{const B=localStorage.getItem(at);if(B){const q=JSON.parse(B);I.info("RECONNECTION_DATA_KEY:",q==null?void 0:q.gameId,P.gameId),q!=null&&q.playerToken&&($=q.playerToken,w.current=$,I.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(B){console.warn("Failed to parse reconnection data:",B instanceof Error?B.message:String(B))}if(!$&&P.players&&a.current){const B=P.players.find(q=>q.id===a.current);B!=null&&B.playerToken&&($=B.playerToken,w.current=$)}}I.info("JoinGame: Sending reconnection with token:",$?"YES":"NO","gameId:",P.gameId),T.current.send(JSON.stringify({type:"JOIN_GAME",gameId:P.gameId,playerToken:$}))}},T.current.onmessage=G=>{try{const P=JSON.parse(G.data);if(P.type==="GAMES_LIST")o(P.games);else if(P.type==="JOIN_SUCCESS"){if(P.isSpectator){n(null),I.info("Joined as spectator:",P.message||"Spectator mode"),g.current=null;return}n(P.playerId);const N=g.current||t.current.gameId;N&&P.playerId!==null&&P.playerToken?(w.current=P.playerToken,localStorage.setItem(at,JSON.stringify({gameId:N,playerId:P.playerId,playerToken:P.playerToken,timestamp:Date.now()})),t.current.gameId===N&&ga(t.current,P.playerId,P.playerToken)):P.playerId===null&&(ut(),w.current=void 0),g.current=null,P.playerId===1&&setTimeout(()=>{var $;(($=T.current)==null?void 0:$.readyState)===WebSocket.OPEN&&T.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe}))},se.DECK_SYNC_DELAY)}else if(P.type==="CONNECTION_ESTABLISHED"){I.info("Connection acknowledged by server");const N=sessionStorage.getItem("pending_invite_game"),$=sessionStorage.getItem("pending_invite_name");N&&T.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),I.info("Auto-joining invite game:",N),T.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:N,playerName:$||"Player"})))}else if(P.type==="DECK_DATA_UPDATED")I.info("Deck data synced with server");else if(P.type==="ERROR")if(P.message.includes("not found")||P.message.includes("Dummy")){I.info("Game not found error - clearing state");const N=rt();r(N),t.current=N,n(null),ut(),g.current=null}else if(P.message.includes("already started")&&A.current){I.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const N=rt();r(N),t.current=N,n(null),ut(),g.current=null,A.current=!1}else console.warn("Server Error:",P.message);else if(P.type==="HIGHLIGHT_TRIGGERED")s(P.highlightData);else if(P.type==="NO_TARGET_TRIGGERED")d({coords:P.coords,timestamp:P.timestamp});else if(P.type==="DECK_SELECTION_TRIGGERED")l(N=>[...N,P.deckSelectionData]),setTimeout(()=>{l(N=>N.filter($=>$.timestamp!==P.deckSelectionData.timestamp))},1e3);else if(P.type==="HAND_CARD_SELECTION_TRIGGERED")m(N=>[...N,P.handCardSelectionData]),setTimeout(()=>{m(N=>N.filter($=>$.timestamp!==P.handCardSelectionData.timestamp))},1e3);else if(P.type==="FLOATING_TEXT_TRIGGERED")r(N=>({...N,floatingTexts:[...N.floatingTexts,P.floatingTextData].filter($=>Date.now()-$.timestamp<se.FLOATING_TEXT_DURATION)}));else if(P.type==="FLOATING_TEXT_BATCH_TRIGGERED")r(N=>({...N,floatingTexts:[...N.floatingTexts,...P.batch].filter($=>Date.now()-$.timestamp<se.FLOATING_TEXT_DURATION)}));else if(P.type==="CLICK_WAVE_TRIGGERED")P.wave&&P.wave.clickedByPlayerId!==a.current&&(E(N=>[...N,P.wave]),setTimeout(()=>{E(N=>N.filter($=>$.timestamp!==P.wave.timestamp))},600));else if(P.type==="TARGETING_MODE_SET"){const N=P.targetingMode;N&&(r($=>({...$,targetingMode:N})),t.current.targetingMode=N,I.info("[TargetingMode] Received targeting mode from server",{playerId:N.playerId,mode:N.action.mode}))}else if(P.type==="TARGETING_MODE_CLEARED")r(N=>({...N,targetingMode:null})),t.current.targetingMode=null,I.debug("[TargetingMode] Cleared targeting mode from server");else if(P.type==="ABILITY_MODE_SET")P.abilityMode&&(r(N=>({...N,abilityMode:P.abilityMode})),I.info("[AbilityMode] Received ability mode from host",{playerId:P.abilityMode.playerId,mode:P.abilityMode.mode,sourceCard:P.abilityMode.sourceCardName}));else if(P.type==="ABILITY_TARGET_SELECTED")I.info("[Ability] Target selected",P.data);else if(P.type==="ABILITY_COMPLETED")r(N=>({...N,abilityMode:null})),I.info("[Ability] Ability completed",P.data);else if(P.type==="ABILITY_CANCELLED")r(N=>({...N,abilityMode:null})),I.info("[Ability] Ability cancelled");else if(P.type==="GAME_RESET")I.info("[GameReset] Received GAME_RESET message from server"),r(N=>{const $=P.activeGridSize||8,B=[];for(let V=0;V<$;V++){const J=[];for(let H=0;H<$;H++)J.push({card:null});B.push(J)}const q={...N,players:P.players||[],gameMode:P.gameMode,isPrivate:P.isPrivate,activeGridSize:P.activeGridSize,dummyPlayerCount:P.dummyPlayerCount,autoAbilitiesEnabled:P.autoAbilitiesEnabled,isGameStarted:P.isGameStarted,currentPhase:P.currentPhase,currentRound:P.currentRound,turnNumber:P.turnNumber,activePlayerId:P.activePlayerId,startingPlayerId:P.startingPlayerId,roundWinners:P.roundWinners||{},gameWinner:P.gameWinner,isRoundEndModalOpen:P.isRoundEndModalOpen,isReadyCheckActive:P.isReadyCheckActive,board:B,targetingMode:null,floatingTexts:[]};return t.current=q,q});else if(!P.type&&P.players&&P.board){const N=St(P),$=t.current;if(!$.isScoringStep&&N.isScoringStep&&N.currentPhase!==2){I.debug("Ignoring delayed scoring state update");return}if($.isScoringStep&&(N.currentPhase!==$.currentPhase||N.activePlayerId!==$.activePlayerId||N.currentPhase!==4)&&(N.isScoringStep=!1),r(N),t.current=N,a.current!==null&&N.gameId){let q;try{const V=localStorage.getItem(at);V&&(q=JSON.parse(V).playerToken)}catch{}if(!q&&N.players){const V=N.players.find(J=>J.id===a.current);V!=null&&V.playerToken&&(q=V.playerToken,w.current=q)}ga(N,a.current,q)}}else console.warn("Unknown message type:",P.type,"keys:",Object.keys(P),"data:",P)}catch(P){I.error("Failed to parse message from server:",G.data,P)}},T.current.onclose=()=>{i("Disconnected"),D.current||(u.current&&clearTimeout(u.current),u.current=window.setTimeout(c,se.RECONNECT_DELAY))},T.current.onerror=G=>I.error("WebSocket error event:",G)},[r,i,o,s,d,l,m,E,_,y,n,rt,D,t,a,w,f,g]),p=U.useCallback(()=>{T.current&&(T.current.readyState===WebSocket.OPEN||T.current.readyState===WebSocket.CONNECTING)?T.current.close():c()},[T,c]),S=U.useCallback(L=>{var G;if(D.current=!1,((G=T.current)==null?void 0:G.readyState)===WebSocket.OPEN){g.current=L;let P=null;try{const $=localStorage.getItem(at);$&&(P=JSON.parse($))}catch{ut()}const N={type:"JOIN_GAME",gameId:L};(P==null?void 0:P.gameId)===L&&P.playerToken?(N.playerToken=P.playerToken,I.info(`JoinGame: Sending reconnection with token ${P.playerToken.substring(0,8)}... for player ${P.playerId}`)):I.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${P==null?void 0:P.gameId}, requestedGameId=${L}`),T.current.send(JSON.stringify(N))}else c(),g.current=L},[T,D,g,c]),v=U.useCallback((L,G="Player")=>{var P;D.current=!1,((P=T.current)==null?void 0:P.readyState)===WebSocket.OPEN?T.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:L,playerName:G})):(sessionStorage.setItem("pending_invite_game",L),sessionStorage.setItem("pending_invite_name",G),c())},[c]),M=U.useCallback(()=>{D.current=!1,ut();const L=Ba(),G={...rt(),gameId:L,players:[Ya(1)]};return f.current=!0,setTimeout(()=>{var P;((P=T.current)==null?void 0:P.readyState)===WebSocket.OPEN&&(T.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:L})),T.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe})))},se.DECK_SYNC_DELAY),{gameId:L,initialState:G}},[D,f]),k=U.useCallback(()=>{var L;((L=T.current)==null?void 0:L.readyState)===WebSocket.OPEN&&T.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[T]),C=U.useCallback((L,G,P,N)=>{var q;if(L.current)return;D.current=!0;const $=t.current.gameId,B=a.current;$&&G.current&&P($);try{N(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),I.info("[exitGame] Cleared WebRTC persistence data")}catch(V){I.warn("[exitGame] Failed to clear WebRTC data:",V)}r(rt()),n(null),ut(),T.current&&(T.current.onclose=null),((q=T.current)==null?void 0:q.readyState)===WebSocket.OPEN&&$&&B!==null&&T.current.send(JSON.stringify({type:"EXIT_GAME",gameId:$,playerId:B})),T.current&&T.current.close(),setTimeout(()=>{D.current=!1,c()},se.RECONNECT_DELAY)},[t,a,D,r,n,T,c]);return{ws:T,reconnectTimeoutRef:u,connectWebSocket:c,forceReconnect:p,createGame:M,joinGame:S,joinAsInvite:v,exitGame:C,requestGamesList:k}}const Xe=new Map,ki=(e={})=>{const{abilityMode:t,setAbilityMode:a}=e,[r,n]=U.useState(rt()),i=U.useRef(rt()),o=U.useCallback(h=>{n(te=>{const Q=typeof h=="function"?h(te):h;return i.current=te,Oe()&&H.current&&setTimeout(()=>{z.current&&(z.current.broadcastGameState(Q),I.debug(`[setGameStateWithDelta] Broadcast state: phase=${Q.currentPhase}, round=${Q.currentRound}`))},0),Q})},[]),[s,d]=U.useState(null),l=U.useRef(r),m=U.useRef(s),[E,_]=U.useState(null),[y,D]=U.useState("Connecting"),[g,w]=U.useState([]),[f,A]=U.useState(null),[T,u]=U.useState(null),[c,p]=U.useState(null),[S,v]=U.useState([]),[M,k]=U.useState([]),[C,L]=U.useState([]),[G,P]=U.useState(!!Fe),[N,$]=U.useState(!1),[B,q]=U.useState(null),[V,J]=U.useState(!1),H=U.useRef(!1),[ae,ne]=U.useState(!1),[_e,we]=U.useState(null),me=U.useRef(!1),ve=U.useRef(null),ke=U.useRef(!1),be=U.useRef(!1),ze=U.useRef(),qe=U.useRef(!1),z=U.useRef(null),Mt=U.useRef(()=>{}),Lt=As({webrtcManagerRef:z,webrtcIsHostRef:H,setWebrtcIsHost:J,setConnectionStatus:D,setWebrtcHostId:q,gameStateRef:l,localPlayerIdRef:m}),{initializeWebrtcHost:Pe,connectAsGuest:Me,sendWebrtcAction:We,requestDeckView:dt,sendFullDeckToHost:yt}=Lt,ct=Cs({gameStateRef:l,localPlayerIdRef:m,setGameState:n,setLocalPlayerId:d,setConnectionStatus:D,setGamesList:w,setLatestHighlight:A,setLatestNoTarget:p,setLatestDeckSelections:v,setLatestHandCardSelections:k,setClickWaves:L,setLatestFloatingTexts:u,isManualExitRef:ke,joiningGameIdRef:ve,playerTokenRef:ze,receivedServerStateRef:qe,isJoinAttemptRef:be}),{ws:Te,reconnectTimeoutRef:Qe,connectWebSocket:ht,forceReconnect:Ka,joinGame:lr,joinAsInvite:za,requestGamesList:qa}=ct;U.useEffect(()=>{Mt.current=o},[o]),U.useEffect(()=>{H.current=V},[V]),U.useEffect(()=>{const h=Oe();if($(h),h){z.current=rs();const te=z.current.on(Q=>{tn(Q)});return()=>{te()}}},[]),U.useEffect(()=>{if(!Oe())return;const te=window.location.hash.slice(1);if(te&&new URLSearchParams(te).get("hostId"))return;const Q="webrtc_auto_restore_attempted";if(sessionStorage.getItem(Q))return;sessionStorage.setItem(Q,"true");const ee=Uo();if(ee==="none"){sessionStorage.removeItem(Q);return}setTimeout(async()=>{var ce,oe;if(!z.current){I.warn("[Auto-restore] WebRTC manager not ready");return}try{if(ee==="host"){Be.current=!0,I.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ue=Oa(),X=ma();if(!ue||!X){I.warn("[Auto-restore] Missing host data or state data"),tt(),Be.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}I.info(`[Auto-restore] Restoring host session: old peerId=${ue.peerId}`);const ge=await z.current.initializeAsHost();H.current=!0,J(!0),q(ge),D("Connected"),(ce=X.gameState)!=null&&ce.gameId&&(Qt(ge,X.gameState.gameId),I.info(`[Auto-restore] Broadcasted NEW host peerId ${ge} for game ${X.gameState.gameId}`)),(X.gameState||X.localPlayerId!==null)&&(X.gameState&&(l.current=X.gameState),X.localPlayerId!==null&&(m.current=X.localPlayerId),me.current=!0,setTimeout(()=>{me.current=!1},1e4),setTimeout(()=>{var Ae;X.gameState&&(n(X.gameState),I.info(`[Auto-restore] Restored game state with ${((Ae=X.gameState.players)==null?void 0:Ae.length)||0} players, gameId=${X.gameState.gameId}`)),X.localPlayerId!==null&&(d(X.localPlayerId),I.info(`[Auto-restore] Restored local player ID: ${X.localPlayerId}`))},0)),setTimeout(()=>{if(Be.current=!1,I.info("[Auto-restore] Cleared restoration flag"),z.current&&X.gameState){const Ae=X.gameState.players.filter(Le=>!Le.isDummy&&Le.id!==X.localPlayerId);Ae.length>0&&(I.info(`[Auto-restore] Requesting deck data from ${Ae.length} guest players`),z.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:z.current.getPeerId(),timestamp:Date.now()}))}},500),I.info("[Auto-restore] Host session restoration initiated")}else if(ee==="guest"){Be.current=!0,I.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ue=va(),X=ma();if(!ue||!X){I.warn("[Auto-restore] Missing guest data or state data"),tt(),Be.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}I.info(`[Auto-restore] Restoring guest session: old hostPeerId=${ue.hostPeerId}, playerId=${ue.playerId}`),H.current=!1,J(!1),D("Connecting");let ge=ue.hostPeerId;if((oe=X.gameState)!=null&&oe.gameId){const Ae=Wt(X.gameState.gameId);Ae&&Ae.peerId&&(ge=Ae.peerId,I.info(`[Auto-restore] Found NEW host peerId in localStorage: ${ge}`))}if(q(ge),ue.playerId!==null){I.info(`[Auto-restore] Reconnecting as existing player ${ue.playerId} to host ${ge}`);try{await z.current.initializeAsReconnectingGuest(ge,ue.playerId),D("Connected"),I.info("[Auto-restore] Successfully reconnected to host")}catch(Ae){I.error("[Auto-restore] Failed to reconnect to host:",Ae),D("Disconnected"),tt(),I.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),Be.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else I.info("[Auto-restore] Connecting as new player"),await z.current.initializeAsGuest(ge),D("Connected");(X.gameState||X.localPlayerId!==null)&&(X.gameState&&(l.current=X.gameState),X.localPlayerId!==null&&(m.current=X.localPlayerId),me.current=!0,setTimeout(()=>{me.current=!1},1e4),setTimeout(()=>{var Ae,Le;if(X.gameState&&(n(X.gameState),I.info(`[Auto-restore] Restored game state with ${((Ae=X.gameState.players)==null?void 0:Ae.length)||0} players, gameId=${X.gameState.gameId}, isGameStarted=${X.gameState.isGameStarted}`),X.localPlayerId!==null)){const fe=(Le=X.gameState.players)==null?void 0:Le.some(ye=>ye.id===X.localPlayerId);I.info(`[Auto-restore] Player ${X.localPlayerId} exists in restored state: ${fe}`)}X.localPlayerId!==null&&(d(X.localPlayerId),I.info(`[Auto-restore] Restored local player ID: ${X.localPlayerId}`))},0)),setTimeout(()=>{Be.current=!1,I.info("[Auto-restore] Cleared restoration flag")},100),I.info("[Auto-restore] Guest session restoration initiated")}}catch(ue){I.error("[Auto-restore] Failed to restore session:",ue),tt(),Be.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),U.useEffect(()=>{if(!N||!z.current)return;const h=window.location.hash.slice(1);if(!h)return;const Q=new URLSearchParams(h).get("hostId");Q&&Me(Q)},[N]),U.useEffect(()=>{l.current=r},[r]),U.useEffect(()=>{m.current=s},[s]),U.useEffect(()=>{if(!r||!r.players||!s)return;const h=Mo(r.players,s);No.preloadMany(h,"low")},[r==null?void 0:r.players,s]);const ja=fs({ws:Te,webrtcManager:z,gameStateRef:l,localPlayerIdRef:m,webrtcIsHostRef:H,setLatestHighlight:A,setLatestFloatingTexts:u,setLatestNoTarget:p,setLatestDeckSelections:v,setLatestHandCardSelections:k,setClickWaves:L,setGameState:n}),{triggerHighlight:Va,triggerFloatingText:ur,triggerNoTarget:Ja,triggerDeckSelection:Xa,triggerHandCardSelection:Za,syncValidTargets:Qa,triggerClickWave:en}=ja,Be=U.useRef(!1);U.useEffect(()=>{if(!N||!H.current||!(r!=null&&r.gameId))return;const h=r.gameId,te=()=>{var ce;const ee=(ce=z.current)==null?void 0:ce.getPeerId();ee&&h&&Qt(ee,h)};te();const Q=setInterval(te,2e3);return()=>clearInterval(Q)},[N,r==null?void 0:r.gameId]),U.useEffect(()=>{if(!N||H.current||!(r!=null&&r.gameId))return;const h=r.gameId,te=ce=>{var oe;q(ce),D("Connecting"),(oe=z.current)==null||oe.initializeAsReconnectingGuest(ce,m.current||0).then(()=>{D("Connected")}).catch(ue=>{I.error("[Guest Auto-Reconnect] Failed to reconnect:",ue),D("Disconnected")})},Q=ce=>{const oe=`webrtc_host_${h}`;if(!(ce.key!==oe||!ce.newValue))try{const X=JSON.parse(ce.newValue).peerId;X&&X!==B&&te(X)}catch(ue){I.error("[Guest Auto-Reconnect] Failed to parse storage event:",ue)}},ee=setInterval(()=>{const ce=Wt(h);ce&&ce.peerId!==B&&(I.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${ce.peerId}`),te(ce.peerId))},2e3);return window.addEventListener("storage",Q),()=>{window.removeEventListener("storage",Q),clearInterval(ee)}},[N,r==null?void 0:r.gameId,B]),U.useEffect(()=>{const h=setInterval(()=>{n(te=>{const Q=Date.now(),ee=te.floatingTexts||[],ce=ee.filter(oe=>Q-oe.timestamp<se.FLOATING_TEXT_DURATION);return ce.length!==ee.length?{...te,floatingTexts:ce}:te})},se.DECK_SYNC_DELAY);return()=>clearInterval(h)},[]);const tn=U.useCallback(h=>{var te,Q,ee;switch(h.type){case"peer_open":(te=h.data)!=null&&te.peerId&&(q(h.data.peerId),I.info(`WebRTC peer opened with ID: ${h.data.peerId}`));break;case"guest_connected":I.info("Guest connected via WebRTC:",(Q=h.data)==null?void 0:Q.peerId);break;case"connected_to_host":(ee=h.data)!=null&&ee.hostPeerId&&B!==h.data.hostPeerId&&(q(h.data.hostPeerId),I.info(`Updated webrtcHostId to: ${h.data.hostPeerId}`)),D("Connected"),ne(!1),we(null),me.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(I.warn("WebRTC peer disconnected"),D("Disconnected"),ne(!0),!H.current&&B&&r)try{const ce={hostPeerId:B,playerId:s,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ce)),I.info("[Reconnection] Stored reconnection data before disconnect"),nn(B)}catch(ce){I.error("[Reconnection] Failed to store data:",ce)}break;case"message_received":an(h.data);break;case"error":I.error("WebRTC error:",h.data);break}},[r,s,B,V]),rn=U.useCallback((h,te)=>{if(I.info(`[handleWebrtcGuestJoin] Called for guest ${h}, isHost: ${H.current}`),!H.current||!z.current){I.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const Q=(te==null?void 0:te.preferredDeck)||"Random";n(ee=>{if(!ee)return I.error("[handleWebrtcGuestJoin] No previous state"),ee;I.info(`[handleWebrtcGuestJoin] Current state has ${ee.players.length} players`);const ce=ee.players.map(fe=>fe.id);let oe=1;for(;ce.includes(oe);)oe++;const ue={id:oe,name:`Player ${oe}`,color:pt[(oe-1)%pt.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:Q,boardHistory:[],autoDrawEnabled:!0},X={...ee,players:[...ee.players,ue]},ge=ee.board.map(fe=>fe.map(ye=>({...ye,card:ye.card?{id:ye.card.id,baseId:ye.card.baseId,ownerId:ye.card.ownerId,name:ye.card.name,imageUrl:ye.card.imageUrl,power:ye.card.power,ability:ye.card.ability,isFaceDown:ye.card.isFaceDown,statuses:ye.card.statuses||[]}:null}))),Ae=fe=>fe.map(ye=>({id:ye.id,baseId:ye.baseId,name:ye.name,imageUrl:ye.imageUrl,power:ye.power,powerModifier:ye.powerModifier,ability:ye.ability,ownerId:ye.ownerId,color:ye.color,deck:ye.deck,isFaceDown:ye.isFaceDown,types:ye.types,faction:ye.faction,statuses:ye.statuses}));z.current.acceptGuestMinimal(h,{playerId:oe,gameId:ee.gameId,isGameStarted:ee.isGameStarted,players:X.players.map(fe=>fe.isDummy?{id:fe.id,name:fe.name,color:fe.color,isDummy:fe.isDummy,isReady:fe.isReady,score:fe.score,selectedDeck:fe.selectedDeck,hand:Ae(fe.hand||[]),deck:Ae(fe.deck||[]),discard:Ae(fe.discard||[]),handSize:fe.hand.length,deckSize:fe.deck.length,discardSize:fe.discard.length}:{id:fe.id,name:fe.name,color:fe.color,isDummy:fe.isDummy,isReady:fe.isReady,score:fe.score,selectedDeck:fe.selectedDeck,deckSize:fe.deck.length,handSize:fe.hand.length,discardSize:fe.discard.length}),deckSelections:X.players.map(fe=>({id:fe.id,selectedDeck:fe.selectedDeck})),gameMode:ee.gameMode,currentRound:ee.currentRound,currentPhase:ee.currentPhase,activePlayerId:ee.activePlayerId,startingPlayerId:ee.startingPlayerId,activeGridSize:ee.activeGridSize,board:ge},oe),z.current.broadcastGameState(X,h),z.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:z.current.getPeerId(),data:{playerId:oe,selectedDeck:Q},timestamp:Date.now()});const Le=X.players.find(fe=>fe.id===m.current);if(Le&&Le.deck.length>0){const fe=Le.deck.map(ye=>({id:ye.id,baseId:ye.baseId,power:ye.power,powerModifier:ye.powerModifier||0,isFaceDown:ye.isFaceDown||!1,statuses:ye.statuses||[]}));z.current.sendToGuest(h,{type:"CHANGE_PLAYER_DECK",senderId:z.current.getPeerId(),playerId:Le.id,data:{playerId:Le.id,deckType:Le.selectedDeck,deck:fe,deckSize:fe.length},timestamp:Date.now()}),I.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${Le.selectedDeck}, ${fe.length} cards`)}return X})},[]),Gt=U.useCallback(h=>{const te=H.current;if(I.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!z.current}, webrtcIsHostRef.current=${te}`),!z.current||!te){I.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}z.current.broadcastGameState(h)},[]),an=U.useCallback(h=>{var te,Q,ee,ce,oe,ue,X,ge,Ae,Le,fe,ye,yr,hr,mr,Ir,Er,Tr,gr,wr,_r,br,Ar,Sr,Cr,Dr,Rr,Pr,kr,Or,vr,Nr,Mr,Lr,Gr,xr,Ur,$r,Hr,Fr,Wr,Br,Yr,Kr,zr,qr,jr,Vr,Jr,Xr,Zr,Qr,ea,ta,ra,aa,na,oa,sa,ia,da,ca,la,ua,fa,pa;if(!(!h||!h.type))switch(I.info(`[handleWebrtcMessage] Received: ${h.type}`),h.type){case"JOIN_ACCEPT_MINIMAL":if(I.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${h.playerId}`),h.data){const b=h.data;I.info(`[handleWebrtcMessage] Creating minimal state with ${((te=b.players)==null?void 0:te.length)||0} players`);const R={gameId:b.gameId||Ba(),isGameStarted:b.isGameStarted||!1,isPrivate:!1,activeGridSize:b.activeGridSize||4,gameMode:b.gameMode||er.FreeForAll,dummyPlayerCount:0,players:((Q=b.players)==null?void 0:Q.map(O=>{if((O.isDummy||!1)&&O.hand&&O.deck&&O.discard)return{id:O.id,name:O.name,color:O.color,isDummy:!0,isReady:O.isReady||!1,score:O.score||0,hand:O.hand||[],deck:O.deck||[],discard:O.discard||[],announcedCard:null,selectedDeck:O.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const K=[],x=[],Y=[];for(let F=0;F<(O.handSize||0);F++)K.push({id:`placeholder_${O.id}_hand_${F}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});for(let F=0;F<(O.deckSize||0);F++)x.push({id:`placeholder_${O.id}_deck_${F}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});for(let F=0;F<(O.discardSize||0);F++)Y.push({id:`placeholder_${O.id}_discard_${F}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});return{id:O.id,name:O.name,color:O.color,isDummy:!1,isReady:O.isReady||!1,score:O.score||0,hand:K,deck:x,discard:Y,announcedCard:null,selectedDeck:O.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:b.board||Na(),hostId:1,currentPhase:b.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:b.currentRound||1,turnNumber:b.turnNumber||1,activePlayerId:b.activePlayerId??null,startingPlayerId:b.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};n(R),h.playerId!==void 0&&(d(h.playerId),I.info(`[handleWebrtcMessage] Set local player ID to ${h.playerId}`)),n(O=>{const W=O.players.map(K=>{var Y;const x=(Y=b.players)==null?void 0:Y.find(F=>F.id===K.id);if(K.id===h.playerId){const j=K.deck.length===0||K.deck.some(Z=>Z.isPlaceholder)||K.deck.length!==30;if(x!=null&&x.selectedDeck&&j){const Z=Ze(x.selectedDeck,K.id,K.name);I.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${Z.length} cards from ${x.selectedDeck}`),z.current&&Z.length>0&&setTimeout(()=>{const pe=Z.map(ie=>({id:ie.id,baseId:ie.baseId,power:ie.power,powerModifier:ie.powerModifier||0,isFaceDown:ie.isFaceDown||!1,statuses:ie.statuses||[]}));z.current.sendAction("DECK_DATA_UPDATE",{playerId:h.playerId,deck:pe,deckSize:pe.length}),I.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${x.selectedDeck}, ${pe.length} cards`)},0);const re=[...K.hand],le=[...Z];if(b.isGameStarted&&re.length===0&&le.length>0){for(let ie=0;ie<6&&ie<le.length;ie++){const Se=le[0];le.splice(0,1),re.push(Se)}I.info(`[JOIN_ACCEPT_MINIMAL] Drew ${re.length} cards, deck now has ${le.length} cards`)}return{...K,deck:le,hand:re,selectedDeck:x.selectedDeck}}}return K});return{...O,players:W}});try{const O=(ee=z.current)==null?void 0:ee.getHostPeerId();O&&Ft({hostPeerId:O,playerId:h.playerId,playerName:((ce=R.players.find(W=>W.id===h.playerId))==null?void 0:ce.name)||null,isHost:!1})}catch(O){I.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",O)}}break;case"JOIN_ACCEPT":if(I.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${h.playerId}, hasState: ${!!((oe=h.data)!=null&&oe.gameState)}`),(ue=h.data)!=null&&ue.gameState){const b=h.data.gameState;if(I.info(`[handleWebrtcMessage] Setting game state with ${((X=b.players)==null?void 0:X.length)||0} players`),n(b),h.playerId!==void 0){d(h.playerId),I.info(`[handleWebrtcMessage] Set local player ID to ${h.playerId}`);try{const R=(ge=z.current)==null?void 0:ge.getHostPeerId(),O=b.players.find(W=>W.id===h.playerId);R&&Ft({hostPeerId:R,playerId:h.playerId,playerName:(O==null?void 0:O.name)||null,isHost:!1})}catch(R){I.warn("[JOIN_ACCEPT] Failed to save guest data:",R)}}}break;case"JOIN_ACCEPT_BINARY":if(I.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${h.playerId}`),h.data instanceof Uint8Array)try{const b=jo(h.data),R=b;if(I.info(`[handleWebrtcMessage] Expanded binary state with ${((Ae=R.players)==null?void 0:Ae.length)||0} players`),n(R),h.playerId!==void 0){d(h.playerId),I.info(`[handleWebrtcMessage] Set local player ID to ${h.playerId}`);try{const O=(Le=z.current)==null?void 0:Le.getHostPeerId(),W=R.players.find(K=>K.id===h.playerId);O&&Ft({hostPeerId:O,playerId:h.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(O){I.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",O)}}I.info(`[handleWebrtcMessage] Received optimized binary game state: ${h.data.byteLength} bytes`)}catch(b){I.error("[handleWebrtcMessage] Failed to deserialize binary game state:",b)}break;case"STATE_UPDATE_COMPACT":if(H.current){if(h.senderId&&h.senderId!==((fe=z.current)==null?void 0:fe.getPeerId())&&(I.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${h.senderId}`),(ye=h.data)!=null&&ye.gameState)){const b=h.data.gameState;n(R=>{const O=h.playerId;if(O===void 0)return I.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),R;const W=R.players.map(Y=>{if(Y.id===O){const F=b.players.find(j=>j.id===O);if(F){const j=pe=>{const ie=Ye(pe.baseId);return ie?{...ie,id:pe.id,baseId:pe.baseId,ownerId:O,power:pe.power,powerModifier:pe.powerModifier,isFaceDown:pe.isFaceDown,statuses:pe.statuses||[]}:{id:pe.id,baseId:pe.baseId,name:"Unknown",power:0}},Z=(F.handCards||[]).map(j),re=(F.deckCards||[]).map(j),le=(F.discardCards||[]).map(j);return I.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${O}: hand=${Z.length}, deck=${re.length}, discard=${le.length}`),{...Y,hand:Z,deck:re,discard:le,handSize:Z.length,deckSize:re.length,discardSize:le.length}}}else{const F=b.players.find(j=>j.id===Y.id);if(F&&(F.handCards||[]).length>0&&Y.hand){const j=F.handCards||[],Z=Y.hand.map(re=>{const le=j.find(pe=>pe.id===re.id);return le&&le.statuses?{...re,statuses:le.statuses,isFaceDown:le.isFaceDown}:re});return{...Y,hand:Z,handSize:Z.length}}}return Y}),K=b.board?b.board.map(Y=>Y.map(F=>{if(!F||!F.card)return F;const j=Ye(F.card.baseId||F.card.id);if(j){const Z=F.card.ownerId;return{...F,card:{...j,id:F.card.id,baseId:F.card.baseId||F.card.id,ownerId:Z,ownerName:F.card.ownerName,power:F.card.power,powerModifier:F.card.powerModifier,isFaceDown:F.card.isFaceDown||!1,statuses:F.card.statuses||[],enteredThisTurn:F.card.enteredThisTurn,deck:F.card.deck}}}return F})):R.board,x={...R,...b,players:W,board:K};return z.current&&setTimeout(()=>{z.current.broadcastGameState(x,h.senderId)},0),x})}}else if(!H.current&&((yr=h.data)!=null&&yr.gameState)){const b=h.data.recipientPlayerId??null,R=h.data.gameState;if(me.current){n(O=>({...O,currentPhase:R.currentPhase,activePlayerId:R.activePlayerId,startingPlayerId:R.startingPlayerId,isReadyCheckActive:R.isReadyCheckActive,isGameStarted:R.isGameStarted}));return}n(O=>{const W=b===null||b===m.current;I.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${b}, local=${m.current}, isForLocal=${W}`);const K=R.players.map(F=>{var Z,re;const j=O.players.find(le=>le.id===F.id);if(F.id===m.current&&j){const le=ie=>{if(ie.baseId){const Ce=Ye(ie.baseId);if(Ce)return{...Ce,id:ie.id,ownerId:m.current,power:ie.power,powerModifier:ie.powerModifier,isFaceDown:ie.isFaceDown,statuses:ie.statuses||[]}}return j.hand.find(Ce=>Ce.id===ie.id)||j.deck.find(Ce=>Ce.id===ie.id)||j.discard.find(Ce=>Ce.id===ie.id)||{id:ie.id,name:"Unknown",power:0}};if(F.handCards&&F.handCards.length>0||F.deckCards&&F.deckCards.length>0||F.discardCards&&F.discardCards.length>0){const ie=(F.handCards||[]).map(le),Se=(F.deckCards||[]).map(le),Ce=(F.discardCards||[]).map(le);return ie.forEach((Ie,he)=>{var de,Ge;(Ge=(de=F.handCards)==null?void 0:de[he])!=null&&Ge.baseId&&!Ie.baseId&&(Ie.baseId=F.handCards[he].baseId)}),Se.forEach((Ie,he)=>{var de,Ge;(Ge=(de=F.deckCards)==null?void 0:de[he])!=null&&Ge.baseId&&!Ie.baseId&&(Ie.baseId=F.deckCards[he].baseId)}),Ce.forEach((Ie,he)=>{var de,Ge;(Ge=(de=F.discardCards)==null?void 0:de[he])!=null&&Ge.baseId&&!Ie.baseId&&(Ie.baseId=F.discardCards[he].baseId)}),I.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${ie.length} hand, ${Se.length} deck, ${Ce.length} discard`),{...F,hand:ie,deck:Se,discard:Ce}}else{const ie=(F.handIds||[]).map(Ie=>j.hand.find(de=>de.id===Ie)||j.deck.find(de=>de.id===Ie)||j.discard.find(de=>de.id===Ie)||{id:Ie,name:"?",isPlaceholder:!1}),Se=(F.deckIds||[]).map(Ie=>j.deck.find(de=>de.id===Ie)||j.hand.find(de=>de.id===Ie)||j.discard.find(de=>de.id===Ie)||{id:Ie,name:"?",isPlaceholder:!1}),Ce=(F.discardIds||[]).map(Ie=>j.discard.find(de=>de.id===Ie)||j.hand.find(de=>de.id===Ie)||j.deck.find(de=>de.id===Ie)||{id:Ie,name:"?",isPlaceholder:!1});return I.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${ie.length} hand, ${Se.length} deck, ${Ce.length} discard`),{...F,hand:ie,deck:Se,discard:Ce}}}else{const le=F.deckSize??((Z=F.deck)==null?void 0:Z.length)??0,pe=F.handSize??((re=F.hand)==null?void 0:re.length)??0,ie=F.deckCards&&F.deckCards.length>0;let Se;if(ie){const he=de=>{if(de.baseId){const Ge=Ye(de.baseId);if(Ge)return{...Ge,id:de.id,baseId:de.baseId,ownerId:F.id,power:de.power,powerModifier:de.powerModifier,isFaceDown:de.isFaceDown,statuses:de.statuses||[]}}return{id:de.id,name:"Unknown",power:0}};Se=F.deckCards.map(he),I.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${F.id}: ${Se.length} cards`)}else if(j&&j.deck.length>0&&j.deck.some(de=>!de.isPlaceholder))Se=j.deck.slice(0,le),I.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${F.id}: ${Se.length} cards`);else{Se=[];for(let de=0;de<le;de++)Se.push({id:`placeholder_${F.id}_deck_${de}`,name:"?",isPlaceholder:!0,ownerId:F.id,deck:F.selectedDeck||"Random",color:F.color})}const Ce=(he,de)=>{if(he.baseId&&!he.isPlaceholder&&!he.isCardBack){const Ge=Ye(he.baseId);if(Ge)return{...Ge,id:he.id,baseId:he.baseId,ownerId:F.id,power:he.power,powerModifier:he.powerModifier||0,isFaceDown:he.isFaceDown||!1,statuses:he.statuses||[]}}return{id:he.id||`placeholder_${F.id}_hand_${de}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:F.id,deck:F.selectedDeck||"Random",color:F.color}};let Ie;if(F.hand&&F.hand.length>0){Ie=F.hand.map((de,Ge)=>Ce(de,Ge));const he=Ie.filter(de=>!de.isPlaceholder).length;he>0&&I.info(`[STATE_UPDATE_COMPACT] Reconstructed ${he}/${Ie.length} revealed hand cards for player ${F.id}`)}else{Ie=[];for(let he=0;he<pe;he++)Ie.push({id:`placeholder_${F.id}_hand_${he}`,name:"?",isPlaceholder:!0,ownerId:F.id,deck:F.selectedDeck||"Random",color:F.color})}return{...F,hand:Ie,deck:Se,discard:(j==null?void 0:j.discard)||[]}}}),x=R.board?R.board.map(F=>F.map(j=>{if(!j||!j.card)return j;const Z=Ye(j.card.baseId||j.card.id);return Z?{...j,card:{...Z,id:j.card.id,baseId:j.card.baseId||j.card.id,ownerId:j.card.ownerId,ownerName:j.card.ownerName,power:j.card.power,powerModifier:j.card.powerModifier,isFaceDown:j.card.isFaceDown||!1,statuses:j.card.statuses||[],enteredThisTurn:j.card.enteredThisTurn,deck:j.card.deck}}:j})):O.board,Y=Ne({...R,players:K,board:x});return{...R,players:K,board:Y}})}break;case"STATE_UPDATE":if(H.current&&h.senderId&&h.senderId!==((hr=z.current)==null?void 0:hr.getPeerId())){if(I.info(`[STATE_UPDATE] Host received state from guest ${h.senderId}`),(mr=h.data)!=null&&mr.gameState){const b=h.data.gameState;n(R=>{const O=h.playerId;if(O===void 0)return I.warn("[STATE_UPDATE] Guest state missing playerId"),R;const W=R.players.map(Y=>{if(Y.id===O){const F=b.players.find(j=>j.id===O);if(F){const j=ie=>({...ie,ownerId:O}),Z=(F.hand||[]).map(j),re=(F.deck||[]).map(j),le=(F.discard||[]).map(j);I.info(`[STATE_UPDATE] Merging guest ${O} state: hand=${Z.length}, deck=${re.length}, discard=${le.length}`);const pe={...Y,hand:Z,deck:re,discard:le,handSize:Z.length,deckSize:re.length,discardSize:le.length};return I.info(`[STATE_UPDATE] After merge - player ${O}: deckSize=${pe.deckSize}, handSize=${pe.handSize}`),pe}}return Y}),K=b.board?b.board.map(Y=>Y.map(F=>!F||!F.card?F:{...F,card:{...F.card,ownerId:F.card.ownerId}})):R.board,x={...R,players:W,board:K};return z.current&&setTimeout(()=>{z.current.broadcastGameState(x,h.senderId)},0),x})}break}if(qe.current=!0,(Ir=h.data)!=null&&Ir.gameState){const b=h.data.gameState;if(me.current){n(R=>({...R,currentPhase:b.currentPhase,activePlayerId:b.activePlayerId,startingPlayerId:b.startingPlayerId,isReadyCheckActive:b.isReadyCheckActive,isGameStarted:b.isGameStarted}));return}n(R=>{var K;const O=b.players.map(x=>{var F,j,Z;const Y=R.players.find(re=>re.id===x.id);if(x.id===m.current&&Y){const re=Y.hand.every(pe=>pe.isPlaceholder)||Y.hand.length===0,le=x.handSize??((F=x.hand)==null?void 0:F.length)??0;if(re&&x.hand&&x.hand.length>0)return{...x,hand:x.hand,deck:x.deck||Y.deck,discard:x.discard||Y.discard};{let pe=Y.hand,ie=Y.deck;if(le>Y.hand.length&&ie.length>0){const Se=le-Y.hand.length,Ce=[...Y.hand],Ie=[...Y.deck];for(let he=0;he<Se&&he<Ie.length;he++){const de=Ie[0];Ie.splice(0,1),Ce.push(de)}pe=Ce,ie=Ie}return{...x,hand:pe,deck:ie,discard:x.discard||Y.discard}}}else{if(x.isDummy||!1)return I.info(`[STATE_UPDATE] Using real cards for dummy player ${x.id}`),{...x,hand:x.hand||[],deck:x.deck||[],discard:x.discard||[]};const le=x.deckSize??((j=x.deck)==null?void 0:j.length)??0,pe=x.handSize??((Z=x.hand)==null?void 0:Z.length)??0;I.info(`[STATE_UPDATE] Player ${x.id}: deckSize=${le}, handSize=${pe}`);const ie=[];for(let Ce=0;Ce<le;Ce++)ie.push({id:`placeholder_${x.id}_deck_${Ce}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const Se=[];for(let Ce=0;Ce<pe;Ce++)Se.push({id:`placeholder_${x.id}_hand_${Ce}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});return I.info(`[STATE_UPDATE] Created ${ie.length} deck placeholders and ${Se.length} hand placeholders for player ${x.id}`),{...x,hand:Se,deck:ie,discard:x.discard||[]}}}),W={...b,players:O};if(!H.current)try{((K=z.current)==null?void 0:K.getHostPeerId())&&m.current!==null&&(mt({gameState:W,localPlayerId:m.current,isHost:!1}),I.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(x){I.warn("[STATE_UPDATE] Failed to persist guest state:",x)}return W})}break;case"RECONNECT_SNAPSHOT":if(qe.current=!0,h.data){const b=h.data;n(R=>{const O=m.current,W=b.players.map(x=>{const Y=R.players.find(re=>re.id===x.id);if(x.id===O&&Y&&Y.hand.some(le=>!le.isPlaceholder)){let le=[...Y.hand];const pe=[...Y.deck];if(x.handSize>le.length){const ie=x.handSize-le.length;for(let Se=0;Se<ie&&pe.length>0;Se++)le.push(pe.shift())}else x.handSize<le.length&&(le=le.slice(0,x.handSize));return{...x,hand:le,deck:pe,discard:Y.discard}}const F=[];for(let re=0;re<x.handSize;re++)F.push({id:`placeholder_${x.id}_hand_${re}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const j=[];for(let re=0;re<x.deckSize;re++)j.push({id:`placeholder_${x.id}_deck_${re}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const Z=[];for(let re=0;re<x.discardSize;re++)Z.push({id:`placeholder_${x.id}_discard_${re}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});return{...x,hand:F,deck:j,discard:Z}}),K={gameId:b.gameId,gameMode:b.gameMode,isPrivate:b.isPrivate,isGameStarted:b.isGameStarted,isReadyCheckActive:b.isReadyCheckActive,activeGridSize:b.activeGridSize,currentPhase:b.currentPhase,isScoringStep:b.isScoringStep,activePlayerId:b.activePlayerId,startingPlayerId:b.startingPlayerId,currentRound:b.currentRound,turnNumber:b.turnNumber,roundWinners:b.roundWinners||{},gameWinner:b.gameWinner,isRoundEndModalOpen:b.isRoundEndModalOpen,dummyPlayerCount:b.dummyPlayerCount,players:W,board:b.board,spectators:R.spectators,hostId:R.hostId,revealRequests:R.revealRequests,preserveDeployAbilities:R.preserveDeployAbilities,highlights:R.highlights,floatingTexts:R.floatingTexts,targetingMode:R.targetingMode,abilityMode:R.abilityMode};if(!H.current&&O!==null)try{mt({gameState:K,localPlayerId:O,isHost:!1}),I.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(x){I.warn("[RECONNECT_SNAPSHOT] Failed to save state:",x)}return I.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${K.currentPhase}, players=${K.players.length}`),K})}break;case"STATE_DELTA":if(H.current||(qe.current=!0),I.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${H.current}, senderId: ${h.senderId}`),(Er=h.data)!=null&&Er.delta){const b=h.data.delta;I.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(b.playerDeltas||{}).length}, boardCells=${((Tr=b.boardCells)==null?void 0:Tr.length)||0}, phaseDelta=${!!b.phaseDelta}`),b.boardCells&&b.boardCells.length>0&&b.boardCells.forEach(R=>{var O,W;I.info(`[STATE_DELTA] Board cell [${R.row},${R.col}]: card=${((O=R.card)==null?void 0:O.name)||"(empty)"}, owner=${(W=R.card)==null?void 0:W.ownerId}`)}),H.current&&h.senderId&&z.current&&(I.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${h.senderId} to other guests`),z.current.broadcastStateDelta(b,h.senderId)),b.phaseDelta&&I.info("[STATE_DELTA] phaseDelta:",JSON.stringify(b.phaseDelta)),b.playerDeltas&&Object.entries(b.playerDeltas).forEach(([R,O])=>{I.info(`[STATE_DELTA] Player ${R} delta: handSizeDelta=${O.handSizeDelta}, deckSizeDelta=${O.deckSizeDelta}`)}),n(R=>{const O=m.current||R.localPlayerId;I.info(`[STATE_DELTA] Applying delta with localPlayerId=${O}, currentPhase before=${R.currentPhase}`);const W=jt(R);I.info(`[STATE_DELTA] Applying delta with localPlayerId=${O}, currentPhase after=${W.currentPhase}`);try{W.gameId&&O!==null&&(mt({gameState:W,localPlayerId:O,isHost:H.current}),I.debug(`[STATE_DELTA] Saved state for ${H.current?"host":"guest"} auto-restore`))}catch(K){I.warn("[STATE_DELTA] Failed to persist state:",K)}return W})}break;case"STATE_DELTA_BINARY":{H.current||(qe.current=!0),I.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${H.current}, senderId: ${h.senderId}, dataType=${(wr=(gr=h.data)==null?void 0:gr.constructor)==null?void 0:wr.name}, typeof=${typeof h.data}`);let b=null;if(h.data instanceof Uint8Array)try{b=$a(h.data),b&&I.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(b.playerDeltas||{}).length}, boardCells=${((_r=b.boardCells)==null?void 0:_r.length)||0}`)}catch(R){I.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",R)}else if(typeof h.data=="string")try{b=Jo(h.data),b&&I.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${h.data.length} chars): playerDeltas=${Object.keys(b.playerDeltas||{}).length}, boardCells=${((br=b.boardCells)==null?void 0:br.length)||0}, phaseDelta=${!!b.phaseDelta}`)}catch(R){I.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",R)}else I.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof h.data}, constructor: ${(Sr=(Ar=h.data)==null?void 0:Ar.constructor)==null?void 0:Sr.name}`);b&&(H.current&&h.senderId&&z.current&&(I.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${h.senderId} to other guests`),z.current.broadcastStateDelta(b,h.senderId)),n(R=>{const O=m.current||R.localPlayerId;I.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${O}, currentPhase before=${R.currentPhase}`);const W=jt(R);I.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${W.currentPhase}, board has ${W.board.flat().filter(K=>K==null?void 0:K.card).length} cards`);try{W.gameId&&O!==null&&(mt({gameState:W,localPlayerId:O,isHost:H.current}),I.debug(`[STATE_DELTA_BINARY] Saved state for ${H.current?"host":"guest"} auto-restore`))}catch(K){I.warn("[STATE_DELTA_BINARY] Failed to persist state:",K)}return W}));break}case"CARD_STATE":if(typeof h.data=="string")try{const b=atob(h.data),R=new Uint8Array(b.length);for(let O=0;O<b.length;O++)R[O]=b.charCodeAt(O);n(O=>lt(2,R,O,m.current||O.localPlayerId).gameState)}catch(b){I.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",b)}else h.data instanceof Uint8Array&&n(b=>lt(2,h.data,b,m.current||b.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof h.data=="string")try{const b=atob(h.data),R=new Uint8Array(b.length);for(let O=0;O<b.length;O++)R[O]=b.charCodeAt(O);n(O=>{const{gameState:W}=lt(3,R,O,m.current||O.localPlayerId);return W})}catch(b){I.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",b)}else h.data instanceof Uint8Array&&n(b=>{const{gameState:R}=lt(3,h.data,b,m.current||b.localPlayerId);return R});break;case"SESSION_EVENT":if(typeof h.data=="string")try{const b=atob(h.data),R=new Uint8Array(b.length);for(let O=0;O<b.length;O++)R[O]=b.charCodeAt(O);n(O=>lt(4,R,O,m.current||O.localPlayerId).gameState)}catch(b){I.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",b)}else h.data instanceof Uint8Array&&n(b=>lt(4,h.data,b,m.current||b.localPlayerId).gameState);break;case"JOIN_REQUEST":I.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${h.senderId}, isHost: ${H.current}`),H.current&&h.senderId?(I.info(`Host received JOIN_REQUEST from ${h.senderId}, data:`,h.data),rn(h.senderId,h.data)):I.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${H.current}, senderId: ${h.senderId}`);break;case"ACTION":if(H.current&&h.data){const{actionType:b,actionData:R}=h.data;if(b==="STATE_UPDATE"&&(R!=null&&R.gameState)){if(me.current){z.current&&h.senderId&&z.current.sendToGuest(h.senderId,{type:"STATE_UPDATE",senderId:z.current.getPeerId(),data:{gameState:l.current},timestamp:Date.now()});break}n(O=>{const W=R.gameState,K=W.players.map(Y=>{const F=O.players.find(j=>j.id===Y.id);return F&&Y.id!==m.current?{...Y,deck:F.deck||Y.deck,discard:F.discard||Y.discard,score:F.score}:Y}),x={...W,players:K};return z.current&&z.current.broadcastToGuests({type:"STATE_UPDATE",senderId:z.current.getPeerId(),data:{gameState:x},timestamp:Date.now()}),x})}else if(b==="STATE_DELTA"&&(R!=null&&R.delta))n(O=>{const W=R.delta;let K=W;me.current&&W.playerDeltas&&(K={...W,playerDeltas:Object.fromEntries(Object.entries(W.playerDeltas).map(([Y,F])=>{const j={...F};return delete j.scoreDelta,[Y,j]}))}),m.current||O.localPlayerId;const x=jt(O);return z.current&&z.current.broadcastStateDelta(K),x});else if(b==="NEXT_PHASE")n(O=>{const W=O,K=W.currentPhase,x=K===2&&!W.isScoringStep,Y=K+1;return{...W,currentPhase:Y,...x&&{isScoringStep:!0}}});else if(b==="PREV_PHASE")n(O=>{const W=O;return W.isScoringStep?{...W,isScoringStep:!1,currentPhase:Math.max(1,W.currentPhase-1)}:{...W,currentPhase:Math.max(1,W.currentPhase-1)}});else if(b==="SET_PHASE"&&(R==null?void 0:R.phaseIndex)!==void 0)n(O=>({...O,currentPhase:R.phaseIndex}));else if(b==="UPDATE_PLAYER_NAME"&&(R==null?void 0:R.playerId)!==void 0&&(R==null?void 0:R.name)!==void 0)n(O=>({...O,players:O.players.map(W=>W.id===R.playerId?{...W,name:R.name}:W)}));else if(b==="CHANGE_PLAYER_COLOR"&&(R==null?void 0:R.playerId)!==void 0&&(R==null?void 0:R.color)!==void 0){const O=R.playerId,W=R.color;n(K=>{const x={...K,players:K.players.map(Y=>Y.id===O?{...Y,color:W}:Y)};return z.current&&z.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:z.current.getPeerId(),data:{playerId:O,color:W},timestamp:Date.now()}),x})}else if(b==="UPDATE_PLAYER_SCORE"&&(R==null?void 0:R.playerId)!==void 0&&(R==null?void 0:R.delta)!==void 0){const O=R.playerId,W=R.delta;n(K=>{const x={...K,players:K.players.map(Y=>Y.id===O?{...Y,score:Math.max(0,Y.score+W)}:Y)};return z.current&&z.current.broadcastToGuests({type:"UPDATE_PLAYER_SCORE",senderId:z.current.getPeerId(),data:{playerId:O,delta:W},timestamp:Date.now()}),x})}else if(b==="CHANGE_PLAYER_DECK"&&(R==null?void 0:R.playerId)!==void 0){const O=R.playerId,W=R.deckType,K=R.deck;n(x=>{const Y=x.players.find(Z=>Z.id===O);if(!Y)return x;let F;K&&K.length>0?(I.info(`[CHANGE_PLAYER_DECK] Host received ${K.length} cards for player ${O}`),F=K.map(Z=>{if(Z.baseId){const re=Ye(Z.baseId);if(re)return{...re,id:Z.id,baseId:Z.baseId,deck:W,ownerId:O,ownerName:Y.name,power:Z.power,powerModifier:Z.powerModifier||0,isFaceDown:Z.isFaceDown||!1,statuses:Z.statuses||[]}}return{id:Z.id,baseId:Z.id,name:"Unknown",deck:W,ownerId:O,ownerName:Y.name,power:Z.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(F=Ze(W,O,Y.name),I.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${O} with ${F.length} cards from ${W}`));const j={...x,players:x.players.map(Z=>Z.id===O?{...Z,selectedDeck:W,deck:F,hand:[],discard:[],announcedCard:null,boardHistory:[]}:Z)};if(z.current){const Z=F.map(re=>({id:re.id,baseId:re.baseId,power:re.power,powerModifier:re.powerModifier||0,isFaceDown:re.isFaceDown||!1,statuses:re.statuses||[]}));z.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:z.current.getPeerId(),playerId:O,data:{playerId:O,deckType:W,deck:Z,deckSize:Z.length},timestamp:Date.now()})}return j})}else if(b==="TOGGLE_ACTIVE_PLAYER"&&(R==null?void 0:R.playerId)!==void 0)n(O=>{if(!O.players.find(x=>x.id===R.playerId))return O;const K=Fa(O,R.playerId);return z.current&&z.current.broadcastGameState(K),K});else if(b==="TOGGLE_AUTO_DRAW"&&(R==null?void 0:R.playerId)!==void 0)n(O=>({...O,players:O.players.map(W=>W.id===R.playerId?{...W,autoDrawEnabled:!W.autoDrawEnabled}:W)}));else if(b==="START_NEXT_ROUND")n(O=>({...O,isRoundEndModalOpen:!1,currentRound:(O.currentRound||1)+1,players:O.players.map(W=>({...W,score:0}))}));else if(b==="RESET_DEPLOY_STATUS")n(O=>{const W=O.board.map(K=>K.map(x=>{var Y;return(Y=x.card)!=null&&Y.statuses?{...x,card:{...x.card,statuses:x.card.statuses.filter(F=>F.type!=="DeployAbilityUsed")}}:x}));return{...O,board:W,preserveDeployAbilities:!1}});else if(b==="DECK_DATA_UPDATE"&&(R==null?void 0:R.playerId)!==void 0&&(R!=null&&R.deck)){const O=R.playerId,W=R.deck,K=R.deckSize;I.info(`[ACTION] DECK_DATA_UPDATE: Received ${W.length} cards for guest ${O}`),n(x=>({...x,players:x.players.map(Y=>Y.id===O?{...Y,deck:[...W],deckSize:K||W.length}:Y)}))}else I.warn(`[ACTION] Unknown action type: ${b}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(I.info(`[PLAYER_RECONNECT] Guest ${h.playerId} reconnecting from ${h.senderId}`),H.current&&h.playerId!==void 0&&h.senderId){const b=l.current;if(I.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(b!=null&&b.gameId)}, gameId=${b==null?void 0:b.gameId}, hasPlayers=${((Cr=b==null?void 0:b.players)==null?void 0:Cr.length)||0}`),b&&b.gameId){I.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${h.playerId}`);const R=ss(b,h.playerId);(Dr=z.current)==null||Dr.sendToGuest(h.senderId,{type:"RECONNECT_SNAPSHOT",senderId:z.current.getPeerId(),data:R.data,timestamp:Date.now()}),I.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${h.playerId}`)}else I.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((Rr=h.data)==null?void 0:Rr.isReadyCheckActive)!==void 0||((Pr=h.data)==null?void 0:Pr.isPrivate)!==void 0)&&n(b=>({...b,isReadyCheckActive:h.data.isReadyCheckActive??!0,isPrivate:h.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((kr=h.data)==null?void 0:kr.isReadyCheckActive)!==void 0&&n(b=>({...b,isReadyCheckActive:h.data.isReadyCheckActive}));break;case"PLAYER_READY":H.current&&h.playerId!==void 0?n(b=>{const R=b.players.map(x=>x.id===h.playerId?{...x,isReady:!0}:x),O={...b,players:R};I.info(`Player ${h.playerId} is ready via WebRTC`),z.current&&(z.current.broadcastGameState(O),I.info(`[PLAYER_READY] Broadcasted ready status for player ${h.playerId}`));const W=O.players.filter(x=>!x.isDummy&&!x.isDisconnected);if(W.length>0&&W.every(x=>x.isReady)&&!O.isGameStarted){const x=O.players.filter(Z=>!Z.isDisconnected),Y=Math.floor(Math.random()*x.length),F=x[Y].id;let j={...O};return j.isReadyCheckActive=!1,j.isGameStarted=!0,j.startingPlayerId=F,j.activePlayerId=F,j.currentPhase=0,j.players=j.players.map(Z=>{if(Z.hand.length===0&&Z.deck.length>0){const le=[...Z.hand],pe=[...Z.deck];for(let ie=0;ie<6&&ie<pe.length;ie++){const Se=pe[0];pe.splice(0,1),le.push(Se)}return I.info(`[PLAYER_READY] Drew ${le.length} cards for player ${Z.id}`),{...Z,hand:le,deck:pe}}return Z}),j=ir(j,F),I.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${j.currentPhase}`),z.current&&(z.current.broadcastToGuests({type:"GAME_START",senderId:z.current.getPeerId(),data:{startingPlayerId:F,activePlayerId:F,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var Z,re;I.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(Z=j.players[0])==null?void 0:Z.deck.length}, hand=${(re=j.players[0])==null?void 0:re.hand.length}`),I.info(`[PLAYER_READY] Broadcasting state with currentPhase=${j.currentPhase}`),Gt(j)},100)),j}return O}):H.current;break;case"ASSIGN_TEAMS":(Or=h.data)!=null&&Or.assignments&&n(b=>{const R=b.players.map(O=>{let W=O.teamId||1;for(const[K,x]of Object.entries(h.data.assignments))if(x.includes(O.id)){W=parseInt(K);break}return{...O,teamId:W}});return{...b,players:R}});break;case"SET_GAME_MODE":((vr=h.data)==null?void 0:vr.mode)!==void 0&&n(b=>({...b,gameMode:h.data.mode}));break;case"SET_GAME_PRIVACY":((Nr=h.data)==null?void 0:Nr.isPrivate)!==void 0&&n(b=>({...b,isPrivate:h.data.isPrivate}));break;case"SET_GRID_SIZE":((Mr=h.data)==null?void 0:Mr.size)!==void 0&&n(b=>{const R=h.data.size,O=[];for(let W=0;W<R;W++){const K=[];for(let x=0;x<R;x++)K.push({card:null});O.push(K)}return{...b,activeGridSize:R,board:O}});break;case"SET_DUMMY_PLAYER_COUNT":((Lr=h.data)==null?void 0:Lr.count)!==void 0&&n(b=>({...b,dummyPlayerCount:h.data.count}));break;case"HOST_READY":h.playerId!==void 0&&(I.info(`[handleWebrtcMessage] Host (player ${h.playerId}) is ready`),n(b=>{const R=b.players.map(O=>O.id===h.playerId?{...O,isReady:!0}:O);return{...b,players:R}}));break;case"GAME_START":qe.current=!0,I.info("[handleWebrtcMessage] Game starting!",h.data),l.current&&(I.info(`[GAME_START] Current phase before: ${l.current.currentPhase}`),l.current.players.forEach(b=>{I.info(`[GAME_START] Before: Player ${b.id} - deck: ${b.deck.length}, hand: ${b.hand.length}`)})),h.data&&n(b=>{I.info(`[GAME_START] Processing for localPlayerId=${m.current}`),b.players.forEach(K=>{I.info(`[GAME_START] Player ${K.id} before: deck=${K.deck.length}, hand=${K.hand.length}`)});const R=h.data.startingPlayerId??h.data.activePlayerId,O={...b,isGameStarted:h.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:R,activePlayerId:h.data.activePlayerId,currentPhase:b.currentPhase},W=O.players.find(K=>K.id===m.current);if(W&&W.hand.length===0&&W.deck.length>0){const x=[...W.hand],Y=[...W.deck];for(let F=0;F<6&&F<Y.length;F++){const j=Y[0];Y.splice(0,1),x.push(j)}O.players=O.players.map(F=>F.id===m.current?{...F,hand:x,deck:Y}:F),I.info(`[GAME_START] Drew ${x.length} cards for local player ${m.current}, deck now has ${Y.length} cards`)}return O.players.forEach(K=>{I.info(`[GAME_START] Player ${K.id} after: deck=${K.deck.length}, hand=${K.hand.length}`)}),I.info(`[GAME_START] Final state: currentPhase=${O.currentPhase}, activePlayerId=${O.activePlayerId}, startingPlayerId=${O.startingPlayerId}`),O});break;case"ACTIVE_PLAYER_CHANGED":I.info("[handleWebrtcMessage] Active player changed!",h.data),h.data&&n(b=>{const R={...b,activePlayerId:h.data.activePlayerId};if(h.data.currentPhase!==void 0&&(R.currentPhase=h.data.currentPhase),h.data.turnNumber!==void 0&&(R.turnNumber=h.data.turnNumber),R.currentPhase===0&&R.activePlayerId===m.current){const O=R.players.find(W=>W.id===m.current);if(O&&O.deck.length>0){const W=O.deck[0],K=[...O.deck.slice(1)],x=[...O.hand,W];R.players=R.players.map(Y=>Y.id===m.current?{...Y,deck:K,hand:x}:Y)}R.currentPhase=1,Zt(R,R.activePlayerId)}return R.activePlayerId&&R.activePlayerId!==b.activePlayerId&&Zt(R,R.activePlayerId),R});break;case"SYNC_DECK_SELECTIONS":I.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",h.data),h.data&&n(b=>h.data.playerId!==void 0&&h.data.selectedDeck!==void 0?h.data.playerId===m.current?(I.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${h.data.playerId}`),b):{...b,players:b.players.map(R=>R.id===h.data.playerId?{...R,selectedDeck:h.data.selectedDeck}:R)}:h.data.deckSelections&&Array.isArray(h.data.deckSelections)?{...b,players:b.players.map(R=>{if(R.id===m.current)return R;const O=h.data.deckSelections.find(W=>W.id===R.id);return O?{...R,selectedDeck:O.selectedDeck}:R})}:b);break;case"CHANGE_PLAYER_DECK":if(I.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",h.data),!h.data||h.data.playerId===void 0)break;{const b=h.data.playerId,R=h.data.deckType,O=h.data.deck;if(b===m.current)break;n(W=>{const K=W.players.find(Y=>Y.id===b);if(!K)return W;let x;return O&&O.length>0?x=O.map(Y=>{if(Y.baseId){const F=Ye(Y.baseId);return F?{...F,id:Y.id,baseId:Y.baseId,deck:R,ownerId:b,ownerName:K.name,power:Y.power,powerModifier:Y.powerModifier||0,isFaceDown:Y.isFaceDown||!1,statuses:Y.statuses||[]}:{id:Y.id,baseId:Y.baseId,name:"Unknown",deck:R,ownerId:b,ownerName:K.name,power:Y.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}return{id:Y.id,baseId:Y.id,name:"Unknown",deck:R,ownerId:b,ownerName:K.name,power:Y.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}):x=Ze(R,b,K.name),{...W,players:W.players.map(Y=>Y.id===b?{...Y,selectedDeck:R,deck:x,hand:[],discard:[],announcedCard:null,boardHistory:[]}:Y)}})}break;case"GAME_RESET":n(b=>{const R=h.data.activeGridSize||8,O=[];for(let x=0;x<R;x++){const Y=[];for(let F=0;F<R;F++)Y.push({card:null});O.push(Y)}const W=(h.data.players||[]).map(x=>{if(x.isDummy&&x.hand&&x.deck&&x.discard)return{...x,boardHistory:[]};{const Y=x.selectedDeck||"SynchroTech";return{...x,hand:[],deck:Ze(Y,x.id,x.name),discard:[],boardHistory:[]}}}),K={...b,players:W,gameMode:h.data.gameMode,isPrivate:h.data.isPrivate,activeGridSize:h.data.activeGridSize,dummyPlayerCount:h.data.dummyPlayerCount,autoAbilitiesEnabled:h.data.autoAbilitiesEnabled,isGameStarted:h.data.isGameStarted,currentPhase:h.data.currentPhase,currentRound:h.data.currentRound,turnNumber:h.data.turnNumber,activePlayerId:h.data.activePlayerId,startingPlayerId:h.data.startingPlayerId,roundWinners:h.data.roundWinners||{},gameWinner:h.data.gameWinner,isRoundEndModalOpen:h.data.isRoundEndModalOpen,isReadyCheckActive:h.data.isReadyCheckActive,board:O,targetingMode:null,floatingTexts:[]};return l.current=K,K});break;case"ABILITY_MODE_SET":(Gr=h.data)!=null&&Gr.abilityMode&&(n(b=>({...b,abilityMode:h.data.abilityMode})),I.info("[AbilityMode] Received ability mode from host",{playerId:h.data.abilityMode.playerId,mode:h.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":I.info("[Ability] Target selected",h.data);break;case"ABILITY_COMPLETED":n(b=>({...b,abilityMode:null})),I.info("[Ability] Ability completed",h.data);break;case"ABILITY_CANCELLED":n(b=>({...b,abilityMode:null}));break;case"CHANGE_PLAYER_COLOR":if(I.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",h.data),!h.data||h.data.playerId===void 0)break;{const b=h.data.playerId,R=h.data.color;if(b===m.current)break;n(O=>({...O,players:O.players.map(W=>W.id===b?{...W,color:R}:W)}))}break;case"UPDATE_PLAYER_SCORE":if(I.info("[UPDATE_PLAYER_SCORE] Received score update broadcast",h.data),!h.data||h.data.playerId===void 0)break;{const b=h.data.playerId,R=h.data.delta;if(b===m.current)break;n(O=>({...O,players:O.players.map(W=>W.id===b?{...W,score:Math.max(0,W.score+R)}:W)}))}break;case"TRIGGER_HIGHLIGHT":if((xr=h.data)!=null&&xr.highlightData){const b=h.data.highlightData;A(b),H.current&&z.current&&h.senderId&&z.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(h.data){const b=(Ur=z.current)==null?void 0:Ur.getPeerId();h.senderId!==b&&A(h.data)}break;case"TRIGGER_FLOATING_TEXT":if(($r=h.data)!=null&&$r.textData){const b=h.data.textData;n(R=>({...R,floatingTexts:[...R.floatingTexts,b].filter(O=>Date.now()-O.timestamp<se.FLOATING_TEXT_DURATION)})),H.current&&z.current&&h.senderId&&z.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((Hr=h.data)!=null&&Hr.batch){const b=h.data.batch;n(R=>({...R,floatingTexts:[...R.floatingTexts,...b].filter(O=>Date.now()-O.timestamp<se.FLOATING_TEXT_DURATION)})),H.current&&z.current&&h.senderId&&z.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:h.senderId,data:{batch:b},timestamp:Date.now()},h.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const b=(Fr=z.current)==null?void 0:Fr.getPeerId();(Wr=h.data)!=null&&Wr.batch&&h.senderId!==b?n(R=>({...R,floatingTexts:[...R.floatingTexts,...h.data.batch].filter(O=>Date.now()-O.timestamp<se.FLOATING_TEXT_DURATION)})):(Br=h.data)!=null&&Br.textData&&h.senderId!==b&&n(R=>({...R,floatingTexts:[...R.floatingTexts,h.data.textData].filter(O=>Date.now()-O.timestamp<se.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((Yr=h.data)!=null&&Yr.coords){const b=h.data.coords,R=h.data.timestamp;p({coords:b,timestamp:R}),H.current&&z.current&&h.senderId&&z.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:h.senderId,data:{coords:b,timestamp:R},timestamp:Date.now()},h.senderId)}break;case"NO_TARGET_TRIGGERED":if((Kr=h.data)!=null&&Kr.coords){const b=(zr=z.current)==null?void 0:zr.getPeerId();h.senderId!==b&&p({coords:h.data.coords,timestamp:h.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(h.data){const b=h.data;v(R=>[...R,b]),setTimeout(()=>{v(R=>R.filter(O=>O.timestamp!==b.timestamp))},1e3),H.current&&z.current&&h.senderId&&z.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(h.data){const b=h.data;k(R=>[...R,b]),setTimeout(()=>{k(R=>R.filter(O=>O.timestamp!==b.timestamp))},1e3),H.current&&z.current&&h.senderId&&z.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"TRIGGER_CLICK_WAVE":if(h.data){const b=h.data;L(R=>[...R,b]),setTimeout(()=>{L(R=>R.filter(O=>O.timestamp!==b.timestamp))},600),H.current&&z.current&&h.senderId&&z.current.broadcastToGuests({type:"CLICK_WAVE_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"CLICK_WAVE_TRIGGERED":h.data&&h.senderId!==((qr=z.current)==null?void 0:qr.getPeerId())&&(L(b=>[...b,h.data]),setTimeout(()=>{L(b=>b.filter(R=>R.timestamp!==h.data.timestamp))},600));break;case"DECK_SELECTION_TRIGGERED":h.data&&h.senderId!==((jr=z.current)==null?void 0:jr.getPeerId())&&(v(b=>[...b,h.data]),setTimeout(()=>{v(b=>b.filter(R=>R.timestamp!==h.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":h.data&&h.senderId!==((Vr=z.current)==null?void 0:Vr.getPeerId())&&(k(b=>[...b,h.data]),setTimeout(()=>{k(b=>b.filter(R=>R.timestamp!==h.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((Jr=h.data)!=null&&Jr.targetingMode){const b=h.data.targetingMode;I.info("[TargetingMode] Received SET_TARGETING_MODE via WebRTC",{playerId:b.playerId,mode:b.action.mode,boardTargetsCount:((Xr=b.boardTargets)==null?void 0:Xr.length)||0,handTargetsCount:((Zr=b.handTargets)==null?void 0:Zr.length)||0,isDeckSelectable:b.isDeckSelectable||!1,timestamp:b.timestamp,isHost:H.current}),n(R=>({...R,targetingMode:b})),l.current.targetingMode=b,H.current&&z.current&&z.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((ea=(Qr=z.current).getPeerId)==null?void 0:ea.call(Qr))??void 0,data:{targetingMode:b},timestamp:Date.now()})}break;case"CLEAR_TARGETING_MODE":I.info("[TargetingMode] Received CLEAR_TARGETING_MODE via WebRTC",{isHost:H.current}),n(b=>({...b,targetingMode:null})),l.current.targetingMode=null,H.current&&z.current&&z.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((ra=(ta=z.current).getPeerId)==null?void 0:ra.call(ta))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()});break;case"RECONNECT_ACCEPT":if((aa=h.data)!=null&&aa.gameState){const b=h.data.gameState;n(b),D("Connected"),I.info(`[Reconnection] State restored with ${((na=b.players)==null?void 0:na.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(R){I.warn("[Reconnection] Failed to clear stored data:",R)}}break;case"RECONNECT_REJECT":{const b=((oa=h.data)==null?void 0:oa.reason)||"unknown";I.warn(`[Reconnection] Reconnection rejected: ${b}`),D("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((sa=h.data)==null?void 0:sa.playerId)!==void 0&&(I.info(`[Reconnection] Player ${h.data.playerId} disconnected, reconnection window open`),n(b=>({...b,players:b.players.map(R=>R.id===h.data.playerId?{...R,isDisconnected:!0}:R)})));break;case"PLAYER_RECONNECTED":((ia=h.data)==null?void 0:ia.playerId)!==void 0&&(I.info(`[Reconnection] Player ${h.data.playerId} reconnected`),n(b=>({...b,players:b.players.map(R=>R.id===h.data.playerId?{...R,isDisconnected:!1}:R)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((da=h.data)==null?void 0:da.playerId)!==void 0&&(I.info(`[Reconnection] Player ${h.data.playerId} converted to dummy`),n(b=>({...b,players:b.players.map(R=>R.id===h.data.playerId?{...R,isDummy:!0,isDisconnected:!0}:R)})));break;case"REQUEST_DECK_VIEW":if(H.current&&((ca=h.data)==null?void 0:ca.targetPlayerId)!==void 0){const b=h.data.targetPlayerId;h.playerId;const R=r.players.find(O=>O.id===b);if(R&&z.current){let O=[];b===m.current||R.isDummy?(I.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${R.deck.length} cards, first card baseId: ${(la=R.deck[0])==null?void 0:la.baseId}`),O=R.deck.map(x=>({id:x.id,baseId:x.baseId,deck:x.deck,power:x.power,powerModifier:x.powerModifier,isFaceDown:x.isFaceDown,statuses:x.statuses||[]}))):R.deckCards&&R.deckCards.length>0?O=R.deckCards:O=R.deck.map(x=>({id:x.id,baseId:x.baseId,power:x.power,powerModifier:x.powerModifier,isFaceDown:x.isFaceDown,statuses:x.statuses||[]}));const W={targetPlayerId:b,deckCards:O,deckSize:O.length},K={type:"DECK_VIEW_DATA",senderId:z.current.getPeerId(),data:W,timestamp:Date.now()};z.current.sendToGuest(h.senderId||"",K),I.info(`[REQUEST_DECK_VIEW] Sent ${W.deckCards.length} cards for player ${b}`)}}break;case"DECK_VIEW_DATA":if(((ua=h.data)==null?void 0:ua.targetPlayerId)!==void 0&&((fa=h.data)!=null&&fa.deckCards)){const b=h.data.targetPlayerId,R=h.data.deckCards;I.info(`[DECK_VIEW_DATA] Received ${R.length} deck cards for player ${b}`);const O=K=>{if(K.baseId){const Y=Ye(K.baseId);if(Y)return{...Y,id:K.id,baseId:K.baseId,deck:K.deck||De.SynchroTech,ownerId:b,power:K.power,powerModifier:K.powerModifier,isFaceDown:K.isFaceDown,statuses:K.statuses||[]};I.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${K.baseId}`)}else I.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${K.id}`);return{id:K.id,baseId:K.baseId||K.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:K.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:De.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}},W=R.map(O);n(K=>({...K,players:K.players.map(x=>x.id===b?{...x,deck:W}:x)}))}break;case"DECK_DATA_UPDATE":if(H.current&&h.playerId!==void 0&&((pa=h.data)!=null&&pa.deck)){const b=h.playerId,R=h.data.deck,O=h.data.deckSize;I.info(`[DECK_DATA_UPDATE] Received ${R.length} cards for guest ${b}, deckSize=${O}`),n(W=>({...W,players:W.players.map(K=>{if(K.id===b){const x=R.map(Y=>({...Y,ownerId:Y.ownerId??b}));return{...K,deck:x,deckSize:O}}return K})}))}break;case"REQUEST_DECK_DATA":if(!H.current&&z.current){const b=r.players.find(R=>R.id===m.current);if(b&&b.deck.length>0){I.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${b.deck.length} cards`);const R=b.deck.map(O=>({id:O.id,baseId:O.baseId,ownerId:O.ownerId??m.current,power:O.power,powerModifier:O.powerModifier||0,isFaceDown:O.isFaceDown||!1,statuses:O.statuses||[]}));z.current.sendAction("DECK_DATA_UPDATE",{playerId:m.current,deck:R,deckSize:R.length})}}break;default:I.warn(`[handleWebrtcMessage] Unknown message type: ${h.type}`,h);break}},[V,Ze,Gt,r,s]),nn=U.useCallback(h=>{if(!z.current||ae)return;ne(!0),D("Connecting");const te=3e4,Q=1e3;let ee=0;const ce=te/Q;try{const ue={hostPeerId:h,playerId:s,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ue))}catch(ue){I.error("[Reconnection] Failed to store data:",ue)}const oe=async()=>{ee++;const ue=Math.max(0,te-ee*Q);if(we({attempt:ee,maxAttempts:ce,timeRemaining:ue}),ue<=0){I.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),ne(!1),we(null),tt();return}let X=h;if(r!=null&&r.gameId){const ge=Wt(r.gameId);if(ge&&ge.peerId!==h){X=ge.peerId;try{const Ae={hostPeerId:X,playerId:s,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(Ae))}catch(Ae){I.error("[Reconnection] Failed to update reconnection data:",Ae)}}}try{const ge=s||m.current;ge!==null?(I.info(`[Reconnection] Reconnecting as existing player ${ge} to host ${X}`),await z.current.initializeAsReconnectingGuest(X,ge)):(I.info("[Reconnection] No playerId, connecting as new player"),await z.current.initializeAsGuest(X)),I.info("[Reconnection] Successfully reconnected!"),ne(!1),we(null)}catch(ge){I.warn("[Reconnection] Reconnection attempt failed:",ge),setTimeout(oe,Q)}};oe()},[ae,r,s]),Ue=U.useCallback(h=>{n(te=>{if(!te)return I.error("[updateState] prevState is undefined, skipping update"),te;const Q=typeof h=="function"?h(te):h;if(!Q)return I.error("[updateState] newState is undefined, skipping update"),te;const ee=!te.gameId&&Q.gameId;if(!qe.current&&!ee)return Q;if(N&&z.current){if(H.current){if(z.current.broadcastGameState(Q),I.info(`[updateState] Host broadcast state: phase=${Q.currentPhase}, activePlayer=${Q.activePlayerId}`),Q.gameId&&m.current!==null)try{mt({gameState:Q,localPlayerId:m.current,isHost:!0}),I.debug("[updateState] Saved game state for host auto-restore")}catch(ce){I.warn("[updateState] Failed to save game state:",ce)}}else z.current&&(z.current.sendStateToHost(Q,m.current),I.info(`[updateState] Guest sent state to host: phase=${Q.currentPhase}, activePlayer=${Q.activePlayerId}`));return Q}if(Te.current&&Te.current.readyState===WebSocket.OPEN){const ce={type:"UPDATE_STATE",gameState:Q};ze.current&&(ce.playerToken=ze.current),Te.current.send(JSON.stringify(ce))}return Q})},[N,V,Gt]),on=U.useCallback(()=>{const{initialState:h}=ct.createGame();Ue(h)},[ct,Ue]),sn=U.useCallback(()=>{ct.exitGame(Be,H,Ia,tt)},[ct,Be,H,Ia,tt]),dn=ps({ws:Te,webrtcManager:z,gameStateRef:l,webrtcIsHostRef:H,setGameState:n,updateState:Ue}),cn=ys({ws:Te,webrtcManager:z,gameStateRef:l,localPlayerIdRef:m,webrtcIsHostRef:H,setGameState:n}),ln=hs({updateState:Ue,sendWebrtcAction:We,webrtcIsHostRef:H,webrtcManagerRef:z}),un=ms({updateState:Ue}),fn=Is({localPlayerIdRef:m,updateState:Ue}),{addBoardCardStatus:pn,removeBoardCardStatus:yn,removeBoardCardStatusByOwner:hn,modifyBoardCardPower:mn,addAnnouncedCardStatus:In,removeAnnouncedCardStatus:En,modifyAnnouncedCardPower:Tn,addHandCardStatus:gn,removeHandCardStatus:wn,revealHandCard:_n,revealBoardCard:bn,requestCardReveal:An,respondToRevealRequest:Sn,removeRevealedStatus:Cn}=fn,Dn=Es({webrtcIsHostRef:H,sendWebrtcAction:We,webrtcManagerRef:z,localPlayerIdRef:m,getCardDefinition:Ye,commandCardIds:_o,createDeck:Ze,updateState:Ue}),{changePlayerDeck:Rn,loadCustomDeck:Pn,resurrectDiscardedCard:kn,reorderTopDeck:On,reorderCards:vn,recoverDiscardedCard:Nn}=Dn,Mn=Ts({ws:Te,webrtcManagerRef:z,webrtcIsHostRef:H,gameStateRef:l,scoreDeltaAccumulator:Xe,setGameState:n,updateState:Ue,abilityMode:t,setAbilityMode:a,createDeck:Ze}),{toggleActivePlayer:Ln,toggleAutoDraw:Gn,setPhase:xn,nextPhase:Un,prevPhase:$n,closeRoundEndModal:Hn,closeRoundEndModalOnly:Fn,resetGame:Wn}=Mn;U.useEffect(()=>{ke.current=!1;const h=sessionStorage.getItem("invite_game_id"),te=sessionStorage.getItem("invite_host_id");if(h&&!te)return ht(),()=>{ke.current=!0,Qe.current&&clearTimeout(Qe.current),Te.current&&(Te.current.onclose=null,Te.current.close())};if(h&&te)return()=>{ke.current=!0,Qe.current&&clearTimeout(Qe.current),Te.current&&(Te.current.onclose=null,Te.current.close())};const Q=performance.getEntriesByType("navigation"),ee=Q.length>0?Q[0]:null,ce=(ee==null?void 0:ee.type)??0,oe=ls();return oe&&(I.info(`Restoring saved game state (nav type: ${ce}):`,oe.gameState.gameId),n(oe.gameState),d(oe.localPlayerId),l.current=oe.gameState,m.current=oe.localPlayerId,ze.current=oe.playerToken),ht(),()=>{ke.current=!0,Qe.current&&clearTimeout(Qe.current),Te.current&&(Te.current.onclose=null,Te.current.close())}},[]),U.useEffect(()=>{if(Fe&&l.current&&l.current.gameId){const h=St(l.current);h!==l.current&&(n(h),l.current=h)}},[]),U.useEffect(()=>{if(G)return;const h=setInterval(()=>{if(Fe&&l.current&&l.current.gameId){const te=St(l.current);n({...te}),l.current=te,P(!0),clearInterval(h)}},100);return()=>clearInterval(h)},[G]);const{startReadyCheck:Bn,cancelReadyCheck:Yn,playerReady:Kn}=cn,{updatePlayerName:zn,changePlayerColor:qn}=ln,{drawCard:jn,drawCardsBatch:Vn,shufflePlayerDeck:Jn,flipBoardCard:Xn,flipBoardCardFaceDown:Zn}=un,{assignTeams:Qn,setGameMode:eo,setGamePrivacy:to,setActiveGridSize:ro,setDummyPlayerCount:ao}=dn,no=U.useCallback(()=>{var h;if(((h=Te.current)==null?void 0:h.readyState)===WebSocket.OPEN&&l.current.gameId&&m.current===1){Te.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe}));const te=l.current,Q=Ee(te);Q.players.forEach(ee=>{if(["hand","deck","discard"].forEach(oe=>{ee[oe]&&(ee[oe]=ee[oe].map(ue=>{const X=$t(ue.name);return X?{...ue,...X}:ue}))}),ee.announcedCard){const oe=$t(ee.announcedCard.name);oe&&(ee.announcedCard={...ee.announcedCard,...oe})}}),Q.board.forEach(ee=>{ee.forEach(ce=>{if(ce.card){const oe=$t(ce.card.name);oe&&(ce.card={...ce.card,...oe})}})}),Te.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:Q})),n(Q)}},[]),xt=U.useCallback((h,te)=>{var ce;const Q=l.current;if(!Q.isGameStarted){I.warn("[ScoreUpdate] Blocked: game not started");return}if(Q.isRoundEndModalOpen){I.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(te===0)return;const ee=Oe();if(ee?Ue(oe=>({...oe,players:oe.players.map(ue=>ue.id===h?{...ue,score:Math.max(0,(ue.score||0)+te)}:ue)})):n(oe=>({...oe,players:oe.players.map(ue=>ue.id===h?{...ue,score:Math.max(0,(ue.score||0)+te)}:ue)})),!ee){if(((ce=Te.current)==null?void 0:ce.readyState)!==WebSocket.OPEN){I.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const oe=Xe.get(h);if(oe){clearTimeout(oe.timerId);const ue=oe.delta+te,X=setTimeout(()=>{var Ae;const ge=Xe.get(h);ge&&((Ae=Te.current)==null?void 0:Ae.readyState)===WebSocket.OPEN&&(I.info(`[ScoreUpdate] Sending accumulated delta: player=${h}, delta=${ge.delta}`),Te.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:l.current.gameId,playerId:h,delta:ge.delta}))),Xe.delete(h)},500);Xe.set(h,{delta:ue,timerId:X})}else{const ue=setTimeout(()=>{var ge;const X=Xe.get(h);X&&((ge=Te.current)==null?void 0:ge.readyState)===WebSocket.OPEN&&(I.info(`[ScoreUpdate] Sending delta: player=${h}, delta=${X.delta}`),Te.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:l.current.gameId,playerId:h,delta:X.delta}))),Xe.delete(h)},500);Xe.set(h,{delta:te,timerId:ue})}}},[n,Ue]),oo=bs({ws:Te,webrtcManager:z,gameStateRef:l,webrtcIsHostRef:H,setGameState:n}),{setTargetingMode:so,clearTargetingMode:fr}=oo,io=gs({ws:Te,gameStateRef:l,updateState:Ue,updatePlayerScore:xt,triggerFloatingText:ur,clearTargetingMode:fr}),{scoreLine:co,scoreDiagonal:lo}=io,Je=ws({updateState:Ue,rawJsonData:Fe}),uo=_s({updateState:Ue,localPlayerIdRef:m,updatePlayerScore:xt}),{moveItem:pr}=uo;return{gameState:r,localPlayerId:s,setLocalPlayerId:d,draggedItem:E,setDraggedItem:_,connectionStatus:y,gamesList:g,latestHighlight:f,latestFloatingTexts:T,latestNoTarget:c,latestDeckSelections:S,latestHandCardSelections:M,joinAsInvite:za,startReadyCheck:Bn,cancelReadyCheck:Yn,playerReady:Kn,assignTeams:Qn,setGameMode:eo,setGamePrivacy:to,setActiveGridSize:ro,setDummyPlayerCount:ao,updatePlayerName:zn,changePlayerColor:qn,updatePlayerScore:xt,changePlayerDeck:Rn,loadCustomDeck:Pn,drawCard:jn,drawCardsBatch:Vn,shufflePlayerDeck:Jn,moveItem:pr,handleDrop:pr,addBoardCardStatus:pn,removeBoardCardStatus:yn,removeBoardCardStatusByOwner:hn,modifyBoardCardPower:mn,addAnnouncedCardStatus:In,removeAnnouncedCardStatus:En,modifyAnnouncedCardPower:Tn,addHandCardStatus:gn,removeHandCardStatus:wn,flipBoardCard:Xn,flipBoardCardFaceDown:Zn,revealHandCard:_n,revealBoardCard:bn,requestCardReveal:An,respondToRevealRequest:Sn,syncGame:no,removeRevealedStatus:Cn,toggleActivePlayer:Ln,toggleAutoDraw:Gn,triggerHighlight:Va,triggerFloatingText:ur,triggerNoTarget:Ja,triggerDeckSelection:Xa,triggerHandCardSelection:Za,triggerClickWave:en,clickWaves:C,syncValidTargets:Qa,setTargetingMode:so,clearTargetingMode:fr,nextPhase:Un,prevPhase:$n,setPhase:xn,markAbilityUsed:Je.markAbilityUsed,applyGlobalEffect:Je.applyGlobalEffect,swapCards:Je.swapCards,transferStatus:Je.transferStatus,transferAllCounters:Je.transferAllCounters,spawnToken:Je.spawnToken,resetDeployStatus:Je.resetDeployStatus,removeStatusByType:Je.removeStatusByType,recoverDiscardedCard:Nn,resurrectDiscardedCard:kn,scoreLine:co,closeRoundEndModal:Hn,closeRoundEndModalOnly:Fn,resetGame:Wn,scoreDiagonal:lo,reorderTopDeck:On,reorderCards:vn,updateState:Ue,requestDeckView:dt,sendFullDeckToHost:yt,createGame:on,joinGame:lr,joinGameViaModal:lr,exitGame:sn,requestGamesList:qa,forceReconnect:Ka,webrtcHostId:B,webrtcIsHost:V,initializeWebrtcHost:Pe,connectAsGuest:Me,sendWebrtcAction:We,isReconnecting:ae,reconnectProgress:_e}};function _a(e,t,a){const{gameState:r,localPlayerId:n,abilityMode:i,cursorStack:o,handleActionExecution:s,markAbilityUsed:d}=a;if(i||o||!r.isGameStarted||n===null)return null;const l=r.players.find(_=>_.id===e.ownerId),m=n===e.ownerId||(l==null?void 0:l.isDummy)&&n===1;if(r.activePlayerId!==e.ownerId||!m||!Pa(e,r)||!Ra(e,r.currentPhase,r.activePlayerId,r))return null;const E=ko(e,r,e.ownerId,t);if(E){E.readyStatusToRemove&&d(t,!!E.isDeployAbility,!1,E.readyStatusToRemove);const _={...E,chainedAction:E.chainedAction?{...E.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};return s(_,t),_}return null}function Ds(e){const t=st[e],a=(t==null?void 0:t.allowedTargets)||[];return{allowedTargets:a,allowHand:a.includes("hand"),allowBoard:a.includes("board"),allowBoardFaceDown:a.includes("board-facedown"),allowDeck:a.includes("deck"),allowDiscard:a.includes("discard")}}function cr(e,t,a,r){Ds(e);const n={type:e,count:a?a.count+1:1,isDragging:!0,originalOwnerId:t,sourceCoords:a==null?void 0:a.sourceCoords},i={};return e==="Revealed"&&(i.excludeOwnerId=t,i.onlyFaceDown=!0),{...n,...i,...r,...a&&{chainedAction:a.chainedAction,isDeployAbility:a.isDeployAbility,readyStatusToRemove:a.readyStatusToRemove}}}function je(e,t){var r;const a=(r=e.sourceCard)==null?void 0:r.ownerId;return typeof a=="number"?a:typeof t=="number"?t:0}function Rs(e,t,a){var m;const{gameState:r,localPlayerId:n,commandContext:i,triggerNoTarget:o,onAbilityComplete:s,handleActionExecution:d}=a;if(e.type==="ABILITY_COMPLETE"){s==null||s();return}if(e.type==="REVEREND_SETUP_SCORE"){Ps(e,t,a);return}if(e.type==="GLOBAL_AUTO_APPLY"){ks(e,t,a);return}if(!bt(e,r,((m=e.sourceCard)==null?void 0:m.ownerId)||n,i)){o(t),e.chainedAction&&setTimeout(()=>{d(e.chainedAction,t)},500);return}if(e.type==="CREATE_STACK"){Os(e,t,a);return}if(e.type==="OPEN_MODAL"){vs(e,t,a);return}if(e.type==="ENTER_MODE"){Ns(e,t,a);return}I.warn("[handleActionExecution] Unknown action type:",e.type)}function Ps(e,t,a){var l,m;const{gameState:r,updatePlayerScore:n,triggerFloatingText:i,markAbilityUsed:o}=a,s=((l=e.sourceCard)==null?void 0:l.ownerId)??0;let d=0;for(let E=0;E<r.board.length;E++)for(let _=0;_<r.board[E].length;_++){const y=(m=r.board[E][_])==null?void 0:m.card;if(y!=null&&y.statuses){const D=y.statuses.filter(g=>g.type==="Exploit"&&g.addedByPlayerId===s);d+=D.length}}d>0&&n(s,d),i([{row:t.row,col:t.col,text:`+${d}`,playerId:s}]),o(t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function ks(e,t,a){var D,g,w,f,A,T;const{gameState:r,localPlayerId:n,commandContext:i,markAbilityUsed:o,triggerNoTarget:s,triggerFloatingText:d,updatePlayerScore:l,applyGlobalEffect:m,addBoardCardStatus:E,removeStatusByType:_,handleActionExecution:y}=a;if(((D=e.payload)==null?void 0:D.customAction)==="FINN_SCORING"){const u=(g=e.sourceCard)==null?void 0:g.ownerId;if(u===void 0){I.warn("[FINN_SCORING] Source card missing ownerId"),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}let c=0;if(r.players.forEach(p=>{p.id!==u&&p.hand.forEach(S=>{var v;(v=S.statuses)!=null&&v.some(M=>M.type==="Revealed"&&M.addedByPlayerId===u)&&c++})}),r.board.forEach(p=>{p.forEach(S=>{var M;const v=S.card;if(v&&v.ownerId!==u){const k=((M=v.statuses)==null?void 0:M.filter(C=>C.type==="Revealed"&&C.addedByPlayerId===u).length)||0;c+=k}})}),c>0){const p=e.sourceCoords||t;d({row:p.row,col:p.col,text:`+${c}`,playerId:u}),l(u,c)}o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(((w=e.payload)==null?void 0:w.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){e.sourceCoords&&e.sourceCoords.row>=0?_(e.sourceCoords,"Aim"):i.lastMovedCardCoords&&_(i.lastMovedCardCoords,"Aim");return}if((f=e.payload)!=null&&f.tokenType&&e.payload.filter){const{tokenType:u,filter:c}=e.payload,p=[],S=r.board.length;for(let v=0;v<S;v++)for(let M=0;M<S;M++){const k=r.board[v][M].card;k&&c(k,v,M)&&p.push({row:v,col:M})}if(p.length===0){s(e.sourceCoords||t),e.chainedAction&&setTimeout(()=>y(e.chainedAction,t),500),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}p.forEach(v=>{var M;E(v,u,((M=e.sourceCard)==null?void 0:M.ownerId)||0)}),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove),e.chainedAction&&setTimeout(()=>y(e.chainedAction,t),se.MODE_CLEAR_DELAY);return}if((A=e.payload)!=null&&A.contextReward){ba(e,t,a);return}if(e.payload&&!e.payload.cleanupCommand){const{tokenType:u,filter:c}=e.payload,p=[],S=r.board.length;if(e.payload.contextReward&&e.sourceCard){ba(e,t,a);return}if(c)for(let v=0;v<S;v++)for(let M=0;M<S;M++){const k=r.board[v][M].card;k&&c(k)&&p.push({row:v,col:M})}else e.sourceCoords&&e.sourceCoords.row>=0?p.push(e.sourceCoords):t&&t.row>=0?p.push(t):i.lastMovedCardCoords&&p.push(i.lastMovedCardCoords);if(p.length>0){if(u){const v=e.payload.count||1,M=e.payload.ownerId!==void 0?e.payload.ownerId:((T=e.sourceCard)==null?void 0:T.ownerId)??n??0;for(let k=0;k<v;k++)m(t,p,u,M,!!e.isDeployAbility)}}else s(t),o(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}}function Os(e,t,a){var l;const{gameState:r,setAbilityMode:n,setCursorStack:i,triggerNoTarget:o,localPlayerId:s}=a;let d=e.count||0;if(e.dynamicCount){const{factor:m,ownerId:E}=e.dynamicCount;let _=0;r.board.forEach(y=>{y.forEach(D=>{var g;if((g=D.card)!=null&&g.statuses){const w=D.card.statuses.filter(f=>f.type===m&&f.addedByPlayerId===E);_+=w.length}})}),d=_}if(d>0){n(null);const m=r.players.find(y=>y.id===r.activePlayerId);let E=((l=e.sourceCard)==null?void 0:l.ownerId)??s??0;m!=null&&m.isDummy&&s!==null&&(E=s);const _={count:d,sourceCoords:e.sourceCoords||t,sourceCard:e.sourceCard,isDeployAbility:e.isDeployAbility,readyStatusToRemove:e.readyStatusToRemove,targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,placeAllAtOnce:e.placeAllAtOnce,replaceStatus:e.replaceStatus,chainedAction:e.chainedAction,recordContext:e.recordContext};i(cr(e.tokenType||"Aim",E,null,_))}else o(t)}function vs(e,t,a){var l,m;const{gameState:r,localPlayerId:n,commandContext:i,setViewingDiscard:o,markAbilityUsed:s}=a;if(!bt(e,r,((l=e.sourceCard)==null?void 0:l.ownerId)||n,i)){s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(e.mode==="RETRIEVE_DEVICE"){const E=r.players.find(_=>{var y;return _.id===((y=e.sourceCard)==null?void 0:y.ownerId)});E&&(o({player:E,pickConfig:{filterType:"Device",action:"recover"}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}else if(e.mode==="IMMUNIS_RETRIEVE"){const E=r.players.find(_=>{var y;return _.id===((y=e.sourceCard)==null?void 0:y.ownerId)});E&&o({player:E,pickConfig:{filterType:"Optimates",action:"resurrect"}})}else if(e.mode==="SEARCH_DECK"){const E=r.players.find(_=>{var y;return _.id===((y=e.sourceCard)==null?void 0:y.ownerId)});E&&(o({player:E,pickConfig:{filterType:((m=e.payload)==null?void 0:m.filterType)||"Unit",action:"recover",isDeck:!0}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Ns(e,t,a){var y,D;const{gameState:r,localPlayerId:n,commandContext:i,triggerNoTarget:o,setAbilityMode:s,markAbilityUsed:d,addBoardCardStatus:l,setTargetingMode:m,handleActionExecution:E}=a,_=e.mode;if(_==="SHIELD_SELF_THEN_RIOT_PUSH"){const g=e.sourceCard.ownerId;if(l(t,"Shield",g),!bt(e,r,g,i)){o(t),d(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),m(e,je(e,n),t,void 0,i);return}if(_==="SHIELD_SELF_THEN_SPAWN"){const g=je(e,n);l(t,"Shield",g),s({...e,payload:{...e.payload,shieldApplied:!0}}),m(e,g,t);return}if(_==="PRINCEPS_SHIELD_THEN_AIM"){const g=je(e,n);l(t,"Shield",g);const w={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};E(w,t);return}if(_==="GAWAIN_DEPLOY_SHIELD_AIM"){const g=e.sourceCard.ownerId;l(t,"Shield",g);const w={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};E(w,t);return}if(_==="ABR_DEPLOY_SHIELD_AIM"){const g=e.sourceCard.ownerId;l(t,"Shield",g);const w={type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};E(w,t);return}if(_==="RIOT_PUSH"){if(e.isDeployAbility){s(e),m(e,je(e,n),t);return}if(!bt(e,r,((y=e.sourceCard)==null?void 0:y.ownerId)||n,i)){o(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),m(e,je(e,n),t);return}if(_==="PATROL_MOVE"){s(e),m(e,je(e,n),t);return}if(_==="SELECT_TARGET"){if(e.isDeployAbility){s(e),m(e,je(e,n),t,void 0,i);return}if(!bt(e,r,((D=e.sourceCard)==null?void 0:D.ownerId)||n,i)){o(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),m(e,je(e,n),t,void 0,i);return}s(e),m(e,je(e,n),t)}function ba(e,t,a){var f,A,T,u,c,p,S;const{gameState:r,commandContext:n,updatePlayerScore:i,triggerFloatingText:o,drawCardsBatch:s,removeBoardCardStatus:d,addBoardCardStatus:l,modifyBoardCardPower:m,markAbilityUsed:E}=a,_=(f=e.payload)==null?void 0:f.contextReward,y=n.lastMovedCardCoords||t;if(!y||y.row<0)return;let D=r.board[y.row][y.col].card;const g=((A=e.payload)==null?void 0:A._tempContextId)||n.lastMovedCardId;if((!D||g&&D.id!==g)&&g)for(let v=0;v<r.board.length;v++){for(let M=0;M<r.board[v].length;M++)if(((T=r.board[v][M].card)==null?void 0:T.id)===g){D=r.board[v][M].card;break}if(D)break}if(!D){I.warn("[ContextReward] No card at coords");return}const w=Math.max(0,D.power+(D.powerModifier||0)+(D.bonusPower||0));_==="DRAW_MOVED_POWER"||_==="DRAW_EQUAL_POWER"?s(((u=e.sourceCard)==null?void 0:u.ownerId)||0,w):_==="SCORE_MOVED_POWER"?(o({row:y.row,col:y.col,text:`+${w}`,playerId:((c=e.sourceCard)==null?void 0:c.ownerId)||0}),i(((p=e.sourceCard)==null?void 0:p.ownerId)||0,w)):_==="STUN_MOVED_UNIT"?l(y,"Stun",((S=e.sourceCard)==null?void 0:S.ownerId)||0):_==="REMOVE_AIM"?d(y,"Aim"):_==="WEAKEN"&&m(y,-1),E(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Ms(e,t){var k;const{gameState:a,localPlayerId:r,abilityMode:n,setAbilityMode:i,cursorStack:o,commandContext:s,setCommandContext:d,playMode:l,draggedItem:m,interactionLock:E,handleActionExecution:_,handleDrop:y,moveItem:D,setCursorStack:g,triggerNoTarget:w,markAbilityUsed:f,spawnToken:A,resurrectDiscardedCard:T,updatePlayerScore:u,triggerFloatingText:c,handleLineSelection:p,openContextMenu:S,triggerDeckSelection:v}=t;if(E.current)return!1;const M=a.board.length;if(m)return e.row>=0&&e.row<M&&e.col>=0&&e.col<a.board[e.row].length?(y(m,{location:"board",row:e.row,col:e.col}),!0):!1;if(o&&o.isDragging){if(ot({location:"board",row:e.row,col:e.col},{...o.targetOwnerId!==void 0&&{targetOwnerId:o.targetOwnerId},...o.excludeOwnerId!==void 0&&{excludeOwnerId:o.excludeOwnerId},onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.targetType&&{targetType:o.targetType},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},...o.requireStatusFromSourceOwner!==void 0&&{requireStatusFromSourceOwner:o.requireStatusFromSourceOwner},...o.mustBeAdjacentToSource&&o.sourceCoords&&{mustBeAdjacentTo:o.sourceCoords},...o.mustBeInLineWithSource&&o.sourceCoords&&{mustBeInLineWith:o.sourceCoords},...o.maxDistanceFromSource!==void 0&&{maxDistance:o.maxDistanceFromSource},...o.range&&{range:o.range}},r??0,a.players)){let L=null;if(o.sourceCoords){const{row:G,col:P}=o.sourceCoords;G>=0&&G<M&&P>=0&&P<a.board[G].length&&(L=a.board[G][P].card)}if(L)return _({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:o.type,count:o.count,targetOwnerId:o.targetOwnerId,onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.range&&{range:o.range},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},cleanupCommand:!0},sourceCard:L,sourceCoords:o.sourceCoords},e),!0}return!1}if(n&&n.mode==="SPAWN_TOKEN"){const{sourceCoords:C,payload:L,sourceCard:G,isDeployAbility:P,readyStatusToRemove:N}=n;if(!C||!(L!=null&&L.tokenName)||!(Math.abs(e.row-C.row)+Math.abs(e.col-C.col)===1))return!1;const B=(G==null?void 0:G.ownerId)??((k=n.sourceCard)==null?void 0:k.ownerId);return A(e,L.tokenName,B),f(C,P,!1,N),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="SELECT_CELL"){const{sourceCoords:C,sourceCard:L,isDeployAbility:G,readyStatusToRemove:P,payload:N}=n,$=(()=>{var V;if(C&&C.row>=0)return C;if(!L)return null;for(let J=0;J<a.board.length;J++)for(let H=0;H<a.board.length;H++)if(((V=a.board[J][H].card)==null?void 0:V.id)===L.id)return{row:J,col:H};return null})();if(!$||!L)return!1;let B=!1;if((N==null?void 0:N.range)==="line")B=e.row===$.row||e.col===$.col;else if((N==null?void 0:N.range)==="global")B=!0;else if((N==null?void 0:N.range)===2){const V=Math.abs(e.row-$.row)+Math.abs(e.col-$.col);if(V===1)B=!0;else if(V===2){const J=$.row,H=$.col,ae=e.row,ne=e.col;B=[{r:ae,c:H},{r:J,c:ne},{r:(J+ae)/2,c:(H+ne)/2}].some(we=>{if(!Number.isInteger(we.r)||!Number.isInteger(we.c))return!1;const me=Math.floor((a.board.length-a.activeGridSize)/2),ve=me,ke=me+a.activeGridSize-1;return we.r<ve||we.r>ke||we.c<ve||we.c>ke||Math.abs(we.r-J)+Math.abs(we.c-H)!==1?!1:!a.board[we.r][we.c].card})}}else N!=null&&N.filter?B=N.filter(null,e.row,e.col):B=Math.abs(e.row-$.row)+Math.abs(e.col-$.col)===1;if(!B)return!1;if(N!=null&&N.moveFromHand&&s.selectedHandCard){const{playerId:V,cardIndex:J}=s.selectedHandCard,H=a.players.find(ne=>ne.id===V),ae=H==null?void 0:H.hand[J];if(ae)return D({card:ae,source:"hand",playerId:V,cardIndex:J,isManual:!0},{target:"board",boardCoords:e}),f(C||e,G,!1,P),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0}if(!((N==null?void 0:N.allowSelf)&&e.row===$.row&&e.col===$.col)){const V=a.board[$.row][$.col].card;V&&D({card:V,source:"board",boardCoords:$,bypassOwnershipCheck:!0},{target:"board",boardCoords:e})}if(N!=null&&N.recordContext&&d({lastMovedCardCoords:e,lastMovedCardId:L.id}),f(C||e,G,!1,P),N!=null&&N.chainedAction){const V={...N.chainedAction};V.targetOwnerId===-2&&(V.targetOwnerId=L.ownerId),N.recordContext&&(V.payload||(V.payload={}),V.payload._tempContextId=L.id),i(null),setTimeout(()=>{_(V,e)},se.MODE_CLEAR_DELAY)}else setTimeout(()=>i(null),se.MODE_CLEAR_DELAY);return!0}if(n&&n.mode==="PATROL_MOVE"){const{sourceCoords:C,sourceCard:L,isDeployAbility:G,readyStatusToRemove:P}=n;if(!C||!L)return!1;if(e.row===C.row&&e.col===C.col)return f(C,G,!1,P),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0;const N=e.row===C.row,$=e.col===C.col;return!N&&!$||a.board[e.row][e.col].card!==null?!1:(D({card:L,source:"board",boardCoords:C},{target:"board",boardCoords:e}),f(e,G,!1,P),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0)}if(n&&n.mode==="RIOT_MOVE"){const{sourceCoords:C,sourceCard:L,isDeployAbility:G,readyStatusToRemove:P,payload:N}=n;return!C||!L||!(N!=null&&N.vacatedCoords)?!1:e.row===N.vacatedCoords.row&&e.col===N.vacatedCoords.col?(D({card:L,source:"board",boardCoords:C},{target:"board",boardCoords:e}),f(e,G,!1,P),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0):(f(C,G,!1,P),i(null),!0)}if(n&&n.mode==="IMMUNIS_RETRIEVE"){const{sourceCoords:C,payload:L,isDeployAbility:G,readyStatusToRemove:P,sourceCard:N}=n;if(!C||!(Math.abs(e.row-C.row)+Math.abs(e.col-C.col)===1))return!1;if((L==null?void 0:L.selectedCardIndex)!==void 0){const B=(N==null?void 0:N.ownerId)||0;return T(B,L.selectedCardIndex,e),f(C,G,!1,P),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0}return!1}if(n&&n.mode==="INTEGRATOR_LINE_SELECT"){const{sourceCoords:C,sourceCard:L,isDeployAbility:G,readyStatusToRemove:P}=n;if(!C||C.row<0)return!1;const N=e.row===C.row,$=e.col===C.col;if(!N&&!$)return!1;const B=(L==null?void 0:L.ownerId)||0;let q=0;if(N)for(let V=0;V<M;V++){const J=a.board[e.row][V].card;J!=null&&J.statuses&&(q+=J.statuses.filter(H=>H.type==="Exploit"&&H.addedByPlayerId===B).length)}else for(let V=0;V<M;V++){const J=a.board[V][e.col].card;V!==C.row&&J!=null&&J.statuses&&(q+=J.statuses.filter(H=>H.type==="Exploit"&&H.addedByPlayerId===B).length)}return q>0&&(u(B,q),c({row:C.row,col:C.col,text:`+${q}`,playerId:B})),f(C,G,!1,P),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="IP_AGENT_THREAT_SCORING"){const{sourceCoords:C,sourceCard:L,isDeployAbility:G,readyStatusToRemove:P}=n;if(!C)return!1;const N=e.row===C.row,$=e.col===C.col;if(!N&&!$)return!1;const B=(L==null?void 0:L.ownerId)||0;let q=0;if(N)for(let J=0;J<M;J++){const H=a.board[e.row][J].card;H!=null&&H.statuses&&(q+=H.statuses.filter(ae=>ae.type==="Threat"&&ae.addedByPlayerId===B).length)}else for(let J=0;J<M;J++){const H=a.board[J][e.col].card;J!==C.row&&H!=null&&H.statuses&&(q+=H.statuses.filter(ae=>ae.type==="Threat"&&ae.addedByPlayerId===B).length)}const V=q*2;return V>0&&(u(B,V),c({row:C.row,col:C.col,text:`+${V}`,playerId:B})),f(C,G,!1,P),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="ZIUS_LINE_SELECT"){const{sourceCoords:C,sourceCard:L,isDeployAbility:G,readyStatusToRemove:P}=n,N=s.lastMovedCardCoords||C;if(!N)return!1;const $=e.row===N.row,B=e.col===N.col;if(!$&&!B)return!1;const q=(L==null?void 0:L.ownerId)||0;let V=0;const J=[];if($)for(let H=0;H<M;H++){const ae=a.board[e.row][H].card;if(ae!=null&&ae.statuses){const ne=ae.statuses.filter(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===q);V+=ne.length,ne.length>0&&J.push({row:e.row,col:H})}}else for(let H=0;H<M;H++){const ae=a.board[H][e.col].card;if(H!==N.row&&ae!=null&&ae.statuses){const ne=ae.statuses.filter(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===q);V+=ne.length,ne.length>0&&J.push({row:H,col:e.col})}}return V>0&&(u(q,V),J.forEach(H=>{c({row:H.row,col:H.col,text:"+1",playerId:q})})),f(C||N,G,!1,P),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0}return n&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","SELECT_LINE_START","SELECT_DIAGONAL"].includes(n.mode)?(p(e),!0):l!=null&&l.card&&l.sourceCoords?(y({card:l.card,source:"hand",playerId:l.playerId,cardIndex:l.cardIndex},{location:"board",row:e.row,col:e.col}),!0):!1}function Ls(e,t,a,r){var f;const{gameState:n,localPlayerId:i,abilityMode:o,cursorStack:s,interactionLock:d,setCommandContext:l,setAbilityMode:m,moveItem:E,markAbilityUsed:_,handleActionExecution:y,triggerHandCardSelection:D,setCursorStack:g,clearTargetingMode:w}=r;if(!d.current){if(s){if(["Aim","Exploit","Stun","Shield"].includes(s.type))return;const T={targetOwnerId:s.targetOwnerId,excludeOwnerId:s.excludeOwnerId,onlyOpponents:s.onlyOpponents||s.targetOwnerId===-1,onlyFaceDown:s.onlyFaceDown,targetType:s.targetType,requiredTargetStatus:s.requiredTargetStatus,tokenType:s.type};if(ot({card:t,ownerId:e.id,location:"hand"},T,n.activePlayerId,n.players)&&s.type==="Revealed"){const c=((f=s.sourceCard)==null?void 0:f.ownerId)??n.activePlayerId??i??1;t.statuses||(t.statuses=[]),t.statuses.some(S=>S.type==="Revealed"&&S.addedByPlayerId===c)||(t.statuses.push({type:"Revealed",addedByPlayerId:c}),E({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:e.id,cardIndex:a}),s.sourceCoords&&s.sourceCoords.row>=0&&_(s.sourceCoords,s.isDeployAbility,!1,s.readyStatusToRemove),s.count>1?g(S=>S?{...S,count:S.count-1}:null):(w(),clearValidTargets==null||clearValidTargets(),s.chainedAction&&y(s.chainedAction,s.sourceCoords||{row:-1,col:-1}),g(null)))}return}if((o==null?void 0:o.type)==="ENTER_MODE"&&o.mode==="SELECT_TARGET"){const{payload:A,sourceCoords:T,isDeployAbility:u,sourceCard:c,readyStatusToRemove:p}=o;if(D(e.id,a,n.activePlayerId??i??1),A.actionType==="SELECT_HAND_FOR_DEPLOY"){if(A.filter&&!A.filter(t))return;l(S=>({...S,selectedHandCard:{playerId:e.id,cardIndex:a}})),m({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,payload:{range:"global",moveFromHand:!0}});return}if(A.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(A.filter&&!A.filter(t)||e.id!==(c==null?void 0:c.ownerId))return;E({card:t,source:"hand",playerId:e.id,cardIndex:a,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),m({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:c,sourceCoords:T,isDeployAbility:u,payload:{tokenName:A.tokenName}});return}if(A.actionType==="LUCIUS_SETUP"){if(e.id!==(c==null?void 0:c.ownerId))return;E({card:t,source:"hand",playerId:e.id,cardIndex:a,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),y({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:c,sourceCoords:T,isDeployAbility:u,payload:{filterType:"Command"}},T||{row:-1,col:-1}),m(null);return}if(A.actionType==="DESTROY"){if(A.filter&&!A.filter(t))return;E({card:t,source:"hand",playerId:e.id,cardIndex:a,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),T&&T.row>=0&&_(T,u,!1,p),setTimeout(()=>m(null),se.MODE_CLEAR_DELAY)}}}}function Gs(e,t,a){const{abilityMode:r,cursorStack:n,interactionLock:i,gameState:o,activateAbility:s}=a;r||n||i.current||o.isGameStarted&&o.activePlayerId===e.id&&Co(t,"setup",o.currentPhase)&&s(t,{row:-1,col:-1})}function xs(e,t){var c,p,S,v,M;const{gameState:a,localPlayerId:r,abilityMode:n,interactionLock:i,setAbilityMode:o,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:l,nextPhase:m,modifyBoardCardPower:E,scoreLine:_,scoreDiagonal:y,commandContext:D}=t;if(!n)return!1;const{mode:g,sourceCard:w,sourceCoords:f,payload:A,isDeployAbility:T,readyStatusToRemove:u}=n;if(g==="SCORE_LAST_PLAYED_LINE"&&n.sourceCoords){if(i.current)return!0;const{row:k,col:C}=n.sourceCoords,{row:L,col:G}=e;if(k!==L&&C!==G)return!0;i.current=!0;const P=a.activePlayerId,N=a.board.length;let $=k,B=k,q=C,V=C;if(k===L)$=k,B=k,q=0,V=N-1;else if(C===G)q=G,V=G,$=0,B=N-1;else return i.current=!1,!0;const J=a.board.some(ne=>ne.some(_e=>{var we,me;return((we=_e.card)==null?void 0:we.ownerId)===P&&_e.card.name.toLowerCase().includes("data liberator")&&((me=_e.card.statuses)==null?void 0:me.some(ve=>ve.type==="Support"))}));let H=0;const ae=[];for(let ne=$;ne<=B;ne++)for(let _e=q;_e<=V;_e++){const me=a.board[ne][_e].card;if(me&&!((c=me.statuses)!=null&&c.some(ve=>ve.type==="Stun"))){const ve=me.ownerId===P,ke=(p=me.statuses)==null?void 0:p.some(be=>be.type==="Exploit"&&be.addedByPlayerId===P);if(ve||J&&ke&&me.ownerId!==P){const be=Math.max(0,me.power+(me.powerModifier||0)+(me.bonusPower||0));be>0&&(H+=be,ae.push({row:ne,col:_e,text:`+${be}`,playerId:P}))}}}return o(null),ae.length>0&&l(ae),H>0&&d(P,H),m(),setTimeout(()=>{i.current=!1},200),!0}if(g==="SELECT_LINE_START")return o({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:w,sourceCoords:f,isDeployAbility:T,payload:{...A,firstCoords:e}}),!0;if(g==="SELECT_LINE_END"&&(A!=null&&A.firstCoords)){const{row:k,col:C}=A.firstCoords,{row:L,col:G}=e;if(k!==L&&C!==G)return!0;const P=A.actionType,N=(w==null?void 0:w.ownerId)??((S=a.players.find($=>$.id===a.activePlayerId))!=null&&S.isDummy?a.activePlayerId:r||a.activePlayerId);if(P==="ZIUS_SCORING"){const $=D.lastMovedCardCoords;if($){const ne=k===L&&$.row===k,_e=C===G&&$.col===C;if(!ne&&!_e)return!0}const B=a.board.length;let q=0,V=B-1,J=0,H=B-1;if(k===L)q=V=k;else if(C===G)J=H=C;else return!0;let ae=0;for(let ne=q;ne<=V;ne++)for(let _e=J;_e<=H;_e++){const we=a.board[ne][_e];we.card&&(ae+=((v=we.card.statuses)==null?void 0:v.filter(me=>me.type==="Exploit"&&me.addedByPlayerId===N).length)||0)}ae>0&&N&&(f&&l({row:f.row,col:f.col,text:`+${ae}`,playerId:N}),d(N,ae)),f&&f.row>=0&&s(f,T,!1,u)}else if(P==="CENTURION_BUFF"&&w&&f&&N){const $=a.board.length;let B=0,q=$-1,V=0,J=$-1;k===L?B=q=k:V=J=C;for(let H=B;H<=q;H++)for(let ae=V;ae<=J;ae++){const ne=a.board[H][ae].card;if(ne){const _e=ne.id===w.id,we=ne.ownerId===N,me=a.players.find(be=>be.id===N),ve=a.players.find(be=>be.id===ne.ownerId),ke=(me==null?void 0:me.teamId)!==void 0&&(ve==null?void 0:ve.teamId)!==void 0&&me.teamId===ve.teamId;!_e&&(we||ke)&&E({row:H,col:ae},1)}}s(f,T,!1,u)}else(P==="SCORE_LINE"||!P)&&(_(k,C,L,G,N),A.skipNextPhase||m());return setTimeout(()=>o(null),se.MODE_CLEAR_DELAY),!0}if(g==="SELECT_DIAGONAL"&&A.actionType==="SCORE_DIAGONAL"){const k=(w==null?void 0:w.ownerId)??((M=a.players.find(C=>C.id===a.activePlayerId))!=null&&M.isDummy?a.activePlayerId:r||a.activePlayerId);if(A.firstCoords){const{row:C,col:L}=A.firstCoords,{row:G,col:P}=e;return Math.abs(C-G)!==Math.abs(L-P)?(o(null),!0):(y(C,L,G,P,k,A.bonusType),A.skipNextPhase||m(),o(null),!0)}else return o({...n,payload:{...A,firstCoords:e}}),!0}return!1}function Us(e,t,a){var H;const{gameState:r,localPlayerId:n,abilityMode:i,commandContext:o,markAbilityUsed:s,triggerNoTarget:d,handleActionExecution:l,interactionLock:m,moveItem:E,swapCards:_,transferStatus:y,transferAllCounters:D,spawnToken:g,modifyBoardCardPower:w,addBoardCardStatus:f,removeBoardCardStatus:A,removeBoardCardStatusByOwner:T,removeStatusByType:u,resetDeployStatus:c,updatePlayerScore:p,triggerFloatingText:S,setCounterSelectionData:v,validTargets:M,handleLineSelection:k,setAbilityMode:C,setCommandContext:L,triggerClickWave:G}=a;if(!i||i.type!=="ENTER_MODE"||m.current||i.sourceCard&&i.sourceCard.id===e.id&&i.mode!=="SELECT_LINE_START"&&i.mode!=="INTEGRATOR_LINE_SELECT"&&i.mode!=="ZIUS_LINE_SELECT"&&i.mode!=="IP_AGENT_THREAT_SCORING"&&i.mode!=="SELECT_UNIT_FOR_MOVE"&&i.mode!=="SELECT_TARGET"&&i.mode!=="RIOT_PUSH"&&i.mode!=="RIOT_MOVE"&&i.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{mode:P,payload:N,sourceCard:$,sourceCoords:B,isDeployAbility:q,readyStatusToRemove:V,recordContext:J}=i;return P==="SELECT_LINE_START"||P==="SELECT_LINE_END"?(k(t),!0):(($==null?void 0:$.ownerId)??((H=r.players.find(ae=>ae.id===r.activePlayerId))!=null&&H.isDummy?r.activePlayerId:n||r.activePlayerId),P==="SELECT_TARGET"&&N.tokenType?$s(e,t,a):P==="SELECT_TARGET"?Hs(e,t,a):P==="RIOT_PUSH"?Fs(e,t,a):P==="RIOT_MOVE"?Ws(e,t,a):P==="SWAP_POSITIONS"?Bs(e,t,a):P==="TRANSFER_STATUS_SELECT"?Ys(e,t,a):P==="ZEALOUS_WEAKEN"?Ks(e,t,a):P==="REVEREND_DOUBLE_EXPLOIT"?zs(e,t,a):P==="SELECT_UNIT_FOR_MOVE"?qs(e,t,a):P==="PATROL_MOVE"?js(e,t,a):P==="SPAWN_TOKEN"?Vs(e,t,a):P==="REVEAL_ENEMY"?Js(e,t,a):P==="SELECT_CELL"?Xs(e,t,a):P==="IMMUNIS_RETRIEVE"?Zs(e,t,a):P==="INTEGRATOR_LINE_SELECT"?Qs(e,t,a):P==="IP_AGENT_THREAT_SCORING"?ei(e,t,a):P==="ZIUS_LINE_SELECT"?ti(e,t,a):P==="SELECT_DIAGONAL"?ri(e,t,a):P==="SCORE_LAST_PLAYED_LINE"?ai(e,t,a):P==="SEARCH_DECK"?ni(e,t,a):P==="RETRIEVE_DEVICE"?oi(e,t,a):P==="SELECT_DECK"?si(e,t,a):!1)}function $s(e,t,a){const{abilityMode:r,triggerClickWave:n,moveItem:i,markAbilityUsed:o,setAbilityMode:s,setCommandContext:d,handleActionExecution:l,clearValidTargets:m}=a,{payload:E,sourceCoords:_,isDeployAbility:y,readyStatusToRemove:D}=r;if(E.filter&&!E.filter(e,t.row,t.col))return!1;if(i({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:E.tokenType,count:E.count||1},{target:"board",boardCoords:t}),n("board",t),E.recordContext&&d({lastMovedCardCoords:t,lastMovedCardId:e.id}),E.chainedAction){const g={...E.chainedAction,sourceCard:E.chainedAction.sourceCard??e,sourceCoords:E.chainedAction.sourceCoords??t,isDeployAbility:y,recordContext:!0};l(g,t),setTimeout(()=>n("board",t),100),g.type!=="ENTER_MODE"&&(s(null),m())}else _&&_.row>=0&&o(_,y,!1,D),setTimeout(()=>{s(null),m()},se.MODE_CLEAR_DELAY);return!0}function Hs(e,t,a){var v,M,k,C;const{abilityMode:r,markAbilityUsed:n,setAbilityMode:i,moveItem:o,modifyBoardCardPower:s,addBoardCardStatus:d,removeBoardCardStatus:l,removeBoardCardStatusByOwner:m,removeStatusByType:E,resetDeployStatus:_,updatePlayerScore:y,triggerFloatingText:D,setCounterSelectionData:g,handleActionExecution:w,gameState:f}=a,{mode:A,payload:T,sourceCoords:u,isDeployAbility:c,readyStatusToRemove:p}=r,S=((v=r.sourceCard)==null?void 0:v.ownerId)??((M=f.players.find(L=>L.id===f.activePlayerId))!=null&&M.isDummy?f.activePlayerId:a.localPlayerId||f.activePlayerId);if(T.actionType==="OPEN_COUNTER_MODAL")return T.filter&&!T.filter(e)?!1:(g({card:e,callbackAction:T.rewardType}),i(null),!0);if(T.actionType==="SACRIFICE_AND_BUFF_LINES"){if(T.filter&&!T.filter(e,t.row,t.col))return!1;o({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"discard",playerId:e.ownerId});const L=f.board.length,{row:G,col:P}=t;for(let N=0;N<L;N++){if(N===P)continue;const B=f.board[G][N].card;B&&Aa(f,B.ownerId,S)&&s({row:G,col:N},1)}for(let N=0;N<L;N++){if(N===G)continue;const B=f.board[N][P].card;B&&Aa(f,B.ownerId,S)&&s({row:N,col:P},1)}return n(u||t,c,!1,p),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0}if(T.actionType==="SHIELD_AND_REMOVE_AIM")return T.filter&&!T.filter(e)?!1:(d(t,"Shield",S),E(t,"Aim"),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0);if(T.actionType==="RESET_DEPLOY")return T.filter&&!T.filter(e)?!1:(_(t),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0);if(T.actionType==="MODIFY_POWER")return T.filter&&!T.filter(e)?!1:(T.amount&&s(t,T.amount),u&&u.row>=0&&n(u,c,!1,p),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0);if(T.actionType==="DESTROY")return T.filter&&!T.filter(e)?!1:(((k=e.statuses)==null?void 0:k.some(G=>G.type==="Shield"))?l(t,"Shield"):o({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),n(u||t,c,!1,p),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0);if(T.actionType==="LUCIUS_SETUP")return T.filter&&!T.filter(e)?!1:(o({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),T.chainedAction&&w(T.chainedAction,t),!0);if(T.actionType==="CENSOR_SWAP"){if(T.filter&&!T.filter(e))return!1;const L=((C=e.statuses)==null?void 0:C.filter(G=>G.type==="Exploit"&&G.addedByPlayerId===S).length)||0;if(L>0){m(t,"Exploit",S);for(let G=0;G<L;G++)d(t,"Stun",S)}return n(u||t,c,!1,p),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0}return!1}function Fs(e,t,a){const{abilityMode:r,gameState:n,setAbilityMode:i,moveItem:o,markAbilityUsed:s,interactionLock:d}=a;if(d.current)return!1;const{sourceCoords:l,isDeployAbility:m,readyStatusToRemove:E,sourceCard:_}=r;if(!l||l.row<0)return!1;if(t.row===l.row&&t.col===l.col)return s(l,m,!1,E),setTimeout(()=>i(null),se.MODE_CLEAR_DELAY),!0;const y=Math.abs(t.row-l.row)+Math.abs(t.col-l.col)===1,D=n.players.find(M=>M.id===e.ownerId),g=n.players.find(M=>M.id===(_==null?void 0:_.ownerId)),w=(D==null?void 0:D.teamId)!==void 0&&(g==null?void 0:g.teamId)!==void 0&&D.teamId===g.teamId;if(!y||e.ownerId===(_==null?void 0:_.ownerId)||w)return!1;const f=t.row-l.row,A=t.col-l.col,T=t.row+f,u=t.col+A,c=n.board.length,p=Math.floor((c-n.activeGridSize)/2),S=p,v=p+n.activeGridSize-1;return T<S||T>v||u<S||u>v||n.board[T][u].card!==null?!1:(o({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:T,col:u}}),i({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:_,sourceCoords:l,isDeployAbility:m,payload:{vacatedCoords:t}}),!0)}function Ws(e,t,a){const{abilityMode:r,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="RIOT_MOVE")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:l,readyStatusToRemove:m,payload:E}=r;return!s||!d||!(E!=null&&E.vacatedCoords)?!1:t.row===E.vacatedCoords.row&&t.col===E.vacatedCoords.col?(n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),i(t,l,!1,m),setTimeout(()=>o(null),se.MODE_CLEAR_DELAY),!0):(i(s,l,!1,m),o(null),!0)}function Bs(e,t,a){const{abilityMode:r,gameState:n,swapCards:i,markAbilityUsed:o,setAbilityMode:s,validTargets:d}=a;if(!r||r.mode!=="SWAP_POSITIONS")return!1;const{sourceCoords:l,sourceCard:m,isDeployAbility:E,readyStatusToRemove:_,payload:y}=r;if(!l||l.row<0)return!1;const D=n.board[l.row][l.col].card;return!D||D.id!==(m==null?void 0:m.id)?(s(null),!1):m&&m.id===e.id||y.filter&&!y.filter(e,t.row,t.col)||!y.filter&&d&&!d.some(w=>w.row===t.row&&w.col===t.col)?!1:(i(l,t),o(t,E,!1,_),setTimeout(()=>s(null),se.MODE_CLEAR_DELAY),!0)}function Ys(e,t,a){const{abilityMode:r,transferStatus:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="TRANSFER_STATUS_SELECT")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:l,readyStatusToRemove:m}=r;return!s||s.row<0||d&&d.id===e.id||!e.statuses||e.statuses.length===0?!1:(n(t,s,e.statuses[0].type),i(s,l,!1,m),setTimeout(()=>o(null),se.MODE_CLEAR_DELAY),!0)}function Ks(e,t,a){const{abilityMode:r,modifyBoardCardPower:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="ZEALOUS_WEAKEN")return!1;const{payload:s,sourceCoords:d,isDeployAbility:l,readyStatusToRemove:m}=r;return s.filter&&!s.filter(e)?!1:(n(t,-1),i(d||t,l,!1,m),setTimeout(()=>o(null),se.MODE_CLEAR_DELAY),!0)}function zs(e,t,a){const{abilityMode:r,gameState:n,addBoardCardStatus:i,markAbilityUsed:o,triggerFloatingText:s,setAbilityMode:d}=a;if(!r||r.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{sourceCoords:l,sourceCard:m,isDeployAbility:E,readyStatusToRemove:_}=r,y=(m==null?void 0:m.ownerId)||0,D=(e.statuses||[]).filter(g=>g.type==="Exploit"&&g.addedByPlayerId===y).length;if(D>0){for(let g=0;g<D;g++)i(t,"Exploit",y);s([{row:t.row,col:t.col,text:`+${D}`,playerId:y}])}return o(l||t,E,!1,_),setTimeout(()=>d(null),se.MODE_CLEAR_DELAY),!0}function qs(e,t,a){const{abilityMode:r,setAbilityMode:n}=a;if(!r||r.mode!=="SELECT_UNIT_FOR_MOVE")return!1;const{sourceCard:i,payload:o,isDeployAbility:s,readyStatusToRemove:d}=r;return i&&i.id===e.id||o.filter&&!o.filter(e,t.row,t.col)?!1:(n({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:t,isDeployAbility:s,readyStatusToRemove:d,payload:{range:o.range||2,moveFromHand:o.moveFromHand||!1,selectedCard:e,allowSelf:!1}}),!0)}function js(e,t,a){const{abilityMode:r,gameState:n,moveItem:i,markAbilityUsed:o,setAbilityMode:s}=a;if(!r||r.mode!=="PATROL_MOVE")return!1;const{sourceCoords:d,sourceCard:l,isDeployAbility:m,readyStatusToRemove:E}=r;if(!d||!l)return!1;if(t.row===d.row&&t.col===d.col)return o(d,m,!1,E),setTimeout(()=>s(null),se.MODE_CLEAR_DELAY),!0;const _=t.row===d.row,y=t.col===d.col;return!_&&!y||n.board[t.row][t.col].card!==null?!1:(i({card:l,source:"board",boardCoords:d},{target:"board",boardCoords:t}),o(t,m,!1,E),setTimeout(()=>s(null),se.MODE_CLEAR_DELAY),!0)}function Vs(e,t,a){var D;const{abilityMode:r,spawnToken:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SPAWN_TOKEN")return!1;const{sourceCoords:s,payload:d,isDeployAbility:l,readyStatusToRemove:m,sourceCard:E}=r;if(!s||!(d!=null&&d.tokenName)||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1))return!1;const y=(E==null?void 0:E.ownerId)??((D=r.sourceCard)==null?void 0:D.ownerId);return n(t,d.tokenName,y),i(s,l,!1,m),setTimeout(()=>o(null),se.MODE_CLEAR_DELAY),!0}function Js(e,t,a){var c;const{abilityMode:r,setAbilityMode:n,setCursorStack:i,moveItem:o,markAbilityUsed:s,gameState:d,localPlayerId:l}=a;if(!r||r.mode!=="REVEAL_ENEMY")return!1;const{sourceCoords:m,sourceCard:E,isDeployAbility:_,readyStatusToRemove:y,payload:D}=r;if(!m||!E||!(Math.abs(t.row-m.row)+Math.abs(t.col-m.col)===1)||e.deck==="Tokens"||((c=e.types)==null?void 0:c.includes("Token")))return!1;const f=e.ownerId,A=d.players.find(p=>p.id===d.activePlayerId),T=A!=null&&A.isDummy&&d.activePlayerId!==null?d.activePlayerId:l??0;return i(cr("Revealed",T,null,{targetOwnerId:f,onlyFaceDown:!0,sourceCoords:t,sourceCard:e,isDeployAbility:_,readyStatusToRemove:y})),s(m,_,!1,y),setTimeout(()=>n(null),se.MODE_CLEAR_DELAY),!0}function Xs(e,t,a){const{abilityMode:r,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SELECT_CELL")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:l,readyStatusToRemove:m,payload:E}=r;return E!=null&&E.filter&&!E.filter(null,t.row,t.col)?!1:(E!=null&&E.moveFromHand&&(E!=null&&E.selectedCard)?n({card:E.selectedCard,source:"hand"},{target:"board",boardCoords:t}):s&&s.row>=0&&n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),i(s||t,l,!1,m),setTimeout(()=>o(null),se.MODE_CLEAR_DELAY),!0)}function Zs(e,t,a){const{abilityMode:r,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="IMMUNIS_RETRIEVE")return!1;const{sourceCoords:s,payload:d,isDeployAbility:l,readyStatusToRemove:m}=r;return!s||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1)?!1:d!=null&&d.selectedCard?(n({card:d.selectedCard,source:"discard"},{target:"board",boardCoords:t}),i(s,l,!1,m),setTimeout(()=>o(null),se.MODE_CLEAR_DELAY),!0):!1}function Qs(e,t,a){const{abilityMode:r,gameState:n,moveItem:i,markAbilityUsed:o,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:l}=a;if(!r||r.mode!=="INTEGRATOR_LINE_SELECT")return!1;const{sourceCoords:m,sourceCard:E,isDeployAbility:_,readyStatusToRemove:y}=r,D=(E==null?void 0:E.ownerId)||0,g=t.row===m.row,w=t.col===m.col;if(!g&&!w)return!1;let f=0;if(g)for(let A=0;A<n.board.length;A++){const T=n.board[t.row][A].card;T!=null&&T.statuses&&(f+=T.statuses.filter(u=>u.type==="Exploit"&&u.addedByPlayerId===D).length)}else for(let A=0;A<n.board.length;A++){const T=n.board[A][t.col].card;A!==m.row&&T!=null&&T.statuses&&(f+=T.statuses.filter(u=>u.type==="Exploit"&&u.addedByPlayerId===D).length)}return f>0&&(s(D,f),d({row:m.row,col:m.col,text:`+${f}`,playerId:D})),o(m||t,_,!1,y),setTimeout(()=>l(null),se.MODE_CLEAR_DELAY),!0}function ei(e,t,a){const{abilityMode:r,gameState:n,updatePlayerScore:i,triggerFloatingText:o,markAbilityUsed:s,setAbilityMode:d}=a;if(!r||r.mode!=="IP_AGENT_THREAT_SCORING")return!1;const{sourceCoords:l,sourceCard:m,isDeployAbility:E,readyStatusToRemove:_}=r,y=(m==null?void 0:m.ownerId)||0,D=t.row===l.row,g=t.col===l.col;if(!D&&!g)return!1;let w=0;if(D)for(let A=0;A<n.board.length;A++){const T=n.board[t.row][A].card;T!=null&&T.statuses&&(w+=T.statuses.filter(u=>u.type==="Threat"&&u.addedByPlayerId===y).length)}else for(let A=0;A<n.board.length;A++){const T=n.board[A][t.col].card;A!==l.row&&T!=null&&T.statuses&&(w+=T.statuses.filter(u=>u.type==="Threat"&&u.addedByPlayerId===y).length)}const f=w*2;return f>0&&(i(y,f),o({row:l.row,col:l.col,text:`+${f}`,playerId:y})),s(l||t,E,!1,_),setTimeout(()=>d(null),se.MODE_CLEAR_DELAY),!0}function ti(e,t,a){const{abilityMode:r,gameState:n,commandContext:i,updatePlayerScore:o,triggerFloatingText:s,markAbilityUsed:d,setAbilityMode:l}=a;if(!r||r.mode!=="ZIUS_LINE_SELECT")return!1;const{sourceCoords:m,sourceCard:E,isDeployAbility:_,readyStatusToRemove:y}=r,D=(E==null?void 0:E.ownerId)||0,g=i.lastMovedCardCoords||m,w=t.row===g.row,f=t.col===g.col;if(!w&&!f)return!1;let A=0;const T=[];if(w)for(let u=0;u<n.board.length;u++){const c=n.board[t.row][u].card;if(c!=null&&c.statuses){const p=c.statuses.filter(S=>S.type==="Exploit"&&S.addedByPlayerId===D);A+=p.length,p.length>0&&T.push({row:t.row,col:u})}}else for(let u=0;u<n.board.length;u++){const c=n.board[u][t.col].card;if(u!==g.row&&c!=null&&c.statuses){const p=c.statuses.filter(S=>S.type==="Exploit"&&S.addedByPlayerId===D);A+=p.length,p.length>0&&T.push({row:u,col:t.col})}}return A>0&&(o(D,A),T.forEach(u=>{s({row:u.row,col:u.col,text:"+1",playerId:D})})),d(m||t,_,!1,y),setTimeout(()=>l(null),se.MODE_CLEAR_DELAY),!0}function ri(e,t,a){var v;const{abilityMode:r,gameState:n,moveItem:i,markAbilityUsed:o,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:l,payload:m}=a;if(!r||r.mode!=="SELECT_DIAGONAL")return!1;const{sourceCoords:E,sourceCard:_,isDeployAbility:y,readyStatusToRemove:D}=r,g=(_==null?void 0:_.ownerId)||0,{row:w,col:f}=t,{row:A,col:T}=E||{row:0,col:0},u=w-f===A-T,c=w+f===A+T;if(!u&&!c)return!1;if(m!=null&&m.selectForMove&&e)return m.chainedAction&&a.handleActionExecution(m.chainedAction,t),!0;let p=0;const S=n.board.length;if(u){const M=A-T;for(let k=0;k<S;k++){const C=M+k,L=k;if(C>=0&&C<S&&L>=0&&L<S){const G=n.board[C][L].card;G!=null&&G.statuses&&(p+=G.statuses.filter(P=>P.type==="Exploit"&&P.addedByPlayerId===g).length)}}}if(c){const M=A+T;for(let k=0;k<S;k++){const C=k,L=M-C;if(C>=0&&C<S&&L>=0&&L<S){const G=n.board[C][L].card;G!=null&&G.statuses&&(p+=G.statuses.filter(P=>P.type==="Exploit"&&P.addedByPlayerId===g).length)}}}return m!=null&&m.bonusForSupport&&((v=_==null?void 0:_.statuses)!=null&&v.some(M=>M.type==="Support"))&&(p+=m.bonusForSupport),p>0&&(s(g,p),d({row:(E==null?void 0:E.row)||t.row,col:(E==null?void 0:E.col)||t.col,text:`+${p}`,playerId:g})),o(E||t,y,!1,D),setTimeout(()=>l(null),se.MODE_CLEAR_DELAY),!0}function ai(e,t,a){const{abilityMode:r,gameState:n,commandContext:i,moveItem:o,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:l,setAbilityMode:m}=a;if(!r||r.mode!=="SCORE_LAST_PLAYED_LINE")return!1;const{sourceCoords:E,sourceCard:_,isDeployAbility:y,readyStatusToRemove:D,payload:g}=r,w=(_==null?void 0:_.ownerId)||0,f=i.lastMovedCardCoords;if(!f)return!1;const A=n.board[f.row][f.col].card;if(!A)return!1;const T=t.row===f.row,u=t.col===f.col;if(!T&&!u)return!1;const c=Math.max(0,A.power+(A.powerModifier||0));return(g==null?void 0:g.rewardType)==="SCORE"?(d(w,c),l({row:f.row,col:f.col,text:`+${c}`,playerId:w})):g==null||g.rewardType,s(E||t,y,!1,D),setTimeout(()=>m(null),se.MODE_CLEAR_DELAY),!0}function ni(e,t,a){const{abilityMode:r,setViewingDiscard:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SEARCH_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:l}=r;return n(!0),i(s||t,d,!1,l),o(null),!0}function oi(e,t,a){const{abilityMode:r,setViewingDiscard:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="RETRIEVE_DEVICE")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:l}=r;return n(!0),i(s||t,d,!1,l),o(null),!0}function si(e,t,a){const{abilityMode:r,triggerDeckSelection:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SELECT_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:l}=r;return n(e.ownerId),i(s||t,d,!1,l),setTimeout(()=>o(null),se.MODE_CLEAR_DELAY),!0}function Aa(e,t,a){const r=e.players.find(i=>i.id===t),n=e.players.find(i=>i.id===a);return!r||!n?!1:r.teamId!==void 0&&n.teamId!==void 0&&r.teamId===n.teamId}const Oi=({gameState:e,localPlayerId:t,abilityMode:a,setAbilityMode:r,cursorStack:n,setCursorStack:i,commandContext:o,setCommandContext:s,setViewingDiscard:d,triggerNoTarget:l,triggerClickWave:m,playMode:E,setPlayMode:_,setCounterSelectionData:y,interactionLock:D,onAbilityComplete:g,updateState:w,moveItem:f,drawCard:A,drawCardsBatch:T,updatePlayerScore:u,markAbilityUsed:c,applyGlobalEffect:p,swapCards:S,transferStatus:v,transferAllCounters:M,resurrectDiscardedCard:k,spawnToken:C,scoreLine:L,nextPhase:G,modifyBoardCardPower:P,addBoardCardStatus:N,removeBoardCardStatus:$,removeBoardCardStatusByOwner:B,resetDeployStatus:q,scoreDiagonal:V,removeStatusByType:J,triggerFloatingText:H,triggerHandCardSelection:ae,clearValidTargets:ne,setTargetingMode:_e,clearTargetingMode:we,validTargets:me})=>{const ve=U.useRef(()=>{}),ke=U.useCallback(Pe=>{xs(Pe,{gameState:e,localPlayerId:t,abilityMode:a,interactionLock:D,setAbilityMode:r,markAbilityUsed:c,updatePlayerScore:u,triggerFloatingText:H,nextPhase:G,modifyBoardCardPower:P,scoreLine:L,scoreDiagonal:V,commandContext:o})},[a,e,t,D,r,c,u,H,G,P,L,V,o]);ve.current=ke;const be=U.useCallback((Pe,Me)=>{Rs(Pe,Me,{gameState:e,localPlayerId:t,setAbilityMode:r,setCursorStack:i,commandContext:o,markAbilityUsed:c,triggerNoTarget:l,handleActionExecution:be,modifyBoardCardPower:P,addBoardCardStatus:N,removeBoardCardStatus:$,removeStatusByType:J,updatePlayerScore:u,triggerFloatingText:H,setViewingDiscard:d,handleLineSelection:ve.current,onAbilityComplete:g,applyGlobalEffect:p,drawCardsBatch:T,setTargetingMode:_e})},[e,t,a,r,n,i,o,s,_,c,l,D,f,S,v,M,C,P,N,$,B,J,q,u,H,y,d,me,g,p,T,_e]);U.useEffect(()=>{(a==null?void 0:a.type)==="GLOBAL_AUTO_APPLY"&&(be(a,a.sourceCoords||{row:-1,col:-1}),r(null))},[a,be,r]),U.useEffect(()=>{a||we()},[a,we]);const ze=U.useCallback((Pe,Me)=>{_a(Pe,Me,{gameState:e,localPlayerId:t,abilityMode:a,cursorStack:n,handleActionExecution:be,markAbilityUsed:c})},[e,t,a,n,be,c]),qe=U.useCallback((Pe,Me)=>{var We,dt;if(n&&_!==null&&_!==void 0){const yt={targetOwnerId:n.targetOwnerId,excludeOwnerId:n.excludeOwnerId,onlyOpponents:n.onlyOpponents||n.targetOwnerId===-1,onlyFaceDown:n.onlyFaceDown,targetType:n.targetType,requiredTargetStatus:n.requiredTargetStatus,tokenType:n.type};if(ot({card:Pe,ownerId:Pe.ownerId??0,location:"board"},yt,e.activePlayerId,e.players)){if(n.type==="Revealed"){const Te=((We=n.sourceCard)==null?void 0:We.ownerId)??e.activePlayerId??t??1;if((dt=Pe.statuses)==null?void 0:dt.some(ht=>ht.type==="Revealed"&&ht.addedByPlayerId===Te))return}f({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:n.type,count:1},{target:"board",boardCoords:Me}),n.sourceCoords&&n.sourceCoords.row>=0&&c(n.sourceCoords,n.isDeployAbility,!1,n.readyStatusToRemove),n.count>1?i(Te=>Te?{...Te,count:Te.count-1}:null):(we(),ne(),n.chainedAction&&be(n.chainedAction,n.sourceCoords||{row:-1,col:-1}),i(null))}return}if(!D.current){if(!a&&!n&&e.isGameStarted&&Pa(Pe,e)){ze(Pe,Me);return}if(a&&(a.mode==="SCORE_LAST_PLAYED_LINE"||a.mode==="SELECT_LINE_END")){ke(Me);return}(a==null?void 0:a.type)==="ENTER_MODE"&&Us(Pe,Me,{gameState:e,localPlayerId:t,abilityMode:a,setAbilityMode:r,cursorStack:n,setCursorStack:i,commandContext:o,setCommandContext:s,playMode:null,setPlayMode:_,draggedItem:null,setDraggedItem:()=>{},openContextMenu:()=>{},markAbilityUsed:c,triggerNoTarget:l,triggerClickWave:m,handleActionExecution:be,interactionLock:D,moveItem:f,swapCards:S,transferStatus:v,transferAllCounters:M,spawnToken:C,modifyBoardCardPower:P,addBoardCardStatus:N,removeBoardCardStatus:$,removeBoardCardStatusByOwner:B,removeStatusByType:J,resetDeployStatus:q,updatePlayerScore:u,triggerFloatingText:H,setCounterSelectionData:y,setViewingDiscard:d,clearValidTargets:ne,validTargets:me,handleLineSelection:ke})||!a&&!n&&ze(Pe,Me)}},[n,_,e,t,D,a,ke,f,c,i,be,r,s,y,d,C,S,v,M,P,N,$,B,J,q,u,H,l,m,me,we,ze]),z=U.useCallback(Pe=>{Ms(Pe,{gameState:e,localPlayerId:t,abilityMode:a,setAbilityMode:r,cursorStack:n,commandContext:o,setCommandContext:s,playMode:E,draggedItem:null,interactionLock:D,handleActionExecution:be,handleDrop:f,moveItem:f,setCursorStack:i,triggerNoTarget:l,markAbilityUsed:c,spawnToken:C,resurrectDiscardedCard:k,updatePlayerScore:u,triggerFloatingText:H,handleLineSelection:ke,openContextMenu:()=>{},triggerDeckSelection:()=>{}})},[e,t,a,r,n,o,s,E,D,be,f,i,l,c,C,k,u,H,ke]),Mt=U.useCallback((Pe,Me,We)=>{Ls(Pe,Me,We,{gameState:e,localPlayerId:t,abilityMode:a,cursorStack:n,interactionLock:D,setCommandContext:s,setAbilityMode:r,moveItem:f,markAbilityUsed:c,handleActionExecution:be,triggerHandCardSelection:ae,setCursorStack:i,clearTargetingMode:we})},[a,n,e,t,be,c,r,s,ae,f,i,we,ne,D]),Lt=U.useCallback((Pe,Me)=>{Gs(Pe,Me,{abilityMode:a,cursorStack:n,gameState:e,activateAbility:(We,dt)=>_a(We,dt,{gameState:e,localPlayerId:t,abilityMode:a,cursorStack:n,handleActionExecution:be,markAbilityUsed:c})})},[a,n,e,t,be,c]);return{activateAbility:ze,executeAction:be,handleLineSelection:ke,handleBoardCardClick:qe,handleEmptyCellClick:z,handleHandCardClick:Mt,handleAnnouncedCardDoubleClick:Lt}},Vt=(e,t,a,r,n)=>{const i=(a.baseId||e.split("_")[1]||e).toLowerCase(),o=t===-1,s=[];i==="overwatch"?o?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:a}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},targetOwnerId:-1,onlyOpponents:!0,sourceCard:a}):t===1&&s.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:n,baseCount:0}},sourceCard:a}):i==="tacticalmaneuver"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:a,payload:{range:"line",filter:l=>l.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:a}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:a,payload:{range:"line",filter:l=>l.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:a}}}):i==="inspiration"?o&&s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:a,payload:{actionType:"OPEN_COUNTER_MODAL",filter:l=>l.ownerId===n}}):i==="datainterception"?o?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:a}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:a}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:a,payload:{range:2,filter:l=>{var m;return((m=l.statuses)==null?void 0:m.some(E=>E.type==="Exploit"&&E.addedByPlayerId===n))||!1}}}):i==="falseorders"?o?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:a,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):t===0?s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:a,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:n,sourceCard:a,originalOwnerId:a.ownerId}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:a,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:n}}}}):i==="experimentalstimulants"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:a,payload:{actionType:"RESET_DEPLOY",filter:l=>{var m;return l.ownerId===n&&((m=l.types)==null?void 0:m.includes("Unit"))}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:a,payload:{range:"line",filter:l=>l.ownerId===n}}):i==="logisticschain"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:a,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:a,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):i==="quickresponseteam"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:a,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:l=>{var m;return l.ownerId===n&&((m=l.types)==null?void 0:m.includes("Unit"))}}}):t===1&&s.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:a,payload:{filterType:"Unit"}}):i==="temporaryshelter"?t===0?s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):t===1&&s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:a,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):i==="enhancedinterrogation"?o?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:a}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:a}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:a,payload:{range:2,filter:l=>{var m;return((m=l.statuses)==null?void 0:m.some(E=>E.type==="Aim"&&E.addedByPlayerId===n))||!1}}}):(i==="mobilization1"||i==="linebreach")&&o&&s.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:a,payload:{actionType:"SCORE_LINE"}});const d=a.ownerId||n;return s.forEach(l=>{l.originalOwnerId=d,l.sourceCard&&!l.sourceCard.ownerId&&(l.sourceCard.ownerId=d)}),s},vi=({gameState:e,localPlayerId:t,setActionQueue:a,setCommandContext:r,setCommandModalCard:n,setCounterSelectionData:i,moveItem:o,updatePlayerScore:s,updateState:d})=>{const l=U.useCallback((_,y)=>{if(t===null)return;const D=e.players.find(A=>A.id===y.playerId);if(!(y.playerId===t||(D==null?void 0:D.isDummy)))return;o(y,{target:"announced",playerId:y.playerId}),r({});const w=(_.baseId||_.id.split("_")[1]||_.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(A=>w.includes(A)))n(_);else{const A=Vt(_.id,-1,_,e,y.playerId);A.length>0?a([...A,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:_,ownerId:y.playerId},sourceCard:_}]):a([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:_,ownerId:y.playerId},sourceCard:_}])}},[e,t,o,a,r,n]),m=U.useCallback((_,y)=>{var T,u;if(!y||t===null)return;const D=y.ownerId||t,g=[],w=Vt(y.id,-1,y,e,D);let f;(T=y.baseId)!=null&&T.toLowerCase().includes("inspiration")&&(f=_===0?"DRAW_REMOVED":"SCORE_REMOVED",w.length>0&&w[0].type==="ENTER_MODE"&&(w[0]={...w[0],payload:{...w[0].payload,rewardType:f}})),w.forEach(c=>{g.push(c)}),Vt(y.id,_,y,e,D).forEach(c=>{g.push(c)}),(u=y.baseId)!=null&&u.toLowerCase().includes("inspiration")||g.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:y,ownerId:D},sourceCard:y}),a(g),n(null)},[e,t,a,n]),E=U.useCallback((_,y)=>{var f;if(t===null)return;const D=y.card.ownerId||t;let g=null;for(let A=0;A<e.board.length;A++){for(let T=0;T<e.board[A].length;T++)if(((f=e.board[A][T].card)==null?void 0:f.id)===y.card.id){g={row:A,col:T};break}if(g)break}if(!g){I.warn(`Card ${y.card.id} not found on board during counter removal`),i(null);return}if(d(A=>{if(!A.isGameStarted)return A;const T=Ee(A),u=T.board[g.row][g.col].card;let c=0;const p=(u==null?void 0:u.statuses)??[];if(Object.entries(_).forEach(([S,v])=>{for(let M=0;M<v;M++){const k=p.map(C=>C.type).lastIndexOf(S);k>-1&&(u!=null&&u.statuses)&&(u.statuses.splice(k,1),c++)}}),!(u!=null&&u.statuses)&&u&&(u.statuses=[]),T.board=Ne(T),c>0&&y.callbackAction==="DRAW_REMOVED"){const S=T.players.find(v=>v.id===D);if(S){const v=Math.min(c,S.deck.length);for(let M=0;M<v;M++){const k=S.deck.shift();k&&S.hand.push(k)}}}return T}),y.callbackAction==="SCORE_REMOVED"){const A=Object.values(_).reduce((T,u)=>T+u,0);A>0&&s(D,A)}const w=e.players.find(A=>A.id===D);w!=null&&w.announcedCard&&a([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:w.announcedCard,ownerId:D},sourceCard:w.announcedCard}]),i(null)},[t,s,a,i,e,d]);return{playCommandCard:l,handleCommandConfirm:m,handleCounterSelectionConfirm:E}},Ni=({gameState:e,localPlayerId:t,handleDrop:a,markAbilityUsed:r,requestCardReveal:n,interactionLock:i,setCommandContext:o,onAction:s,cursorStack:d,setCursorStack:l,setAbilityMode:m,triggerClickWave:E,clearTargetingMode:_})=>{const y=U.useRef(null),D=U.useRef({x:0,y:0});return U.useLayoutEffect(()=>{if(d&&y.current){const{x:w,y:f}=D.current;y.current.style.transform=`translate(${w-24}px, ${f-24}px)`}},[d]),U.useEffect(()=>{const w=f=>{D.current={x:f.clientX,y:f.clientY},y.current&&(y.current.style.transform=`translate(${f.clientX-24}px, ${f.clientY-24}px)`)};return window.addEventListener("mousemove",w),()=>window.removeEventListener("mousemove",w)},[]),U.useEffect(()=>{const w=f=>{var c,p,S,v,M,k,C;if(f.button!==0||!d)return;const A=document.elementFromPoint(f.clientX,f.clientY);let T=t;if(d.originalOwnerId!==void 0)T=d.originalOwnerId;else if((c=d.sourceCard)!=null&&c.ownerId)T=d.sourceCard.ownerId;else if(d.sourceCoords&&d.sourceCoords.row>=0){const{row:L,col:G}=d.sourceCoords;if(L>=0&&L<e.board.length&&G>=0&&G<((p=e.board[L])==null?void 0:p.length)){const P=e.board[L][G].card;P&&(T=P.ownerId||t)}}else if(e.activePlayerId){const L=e.players.find(G=>G.id===e.activePlayerId);L!=null&&L.isDummy&&(T=L.id)}let u=A==null?void 0:A.closest("[data-hand-card]");if(!u&&A)if(A.getAttribute("data-hand-card"))u=A;else{const L=A.querySelectorAll("[data-hand-card]");if(L.length>0){let G=1/0,P=null;const N=f.clientX,$=f.clientY;for(const B of Array.from(L)){const q=B.getBoundingClientRect();if(N>=q.left&&N<=q.right&&$>=q.top&&$<=q.bottom){const V=q.left+q.width/2,J=q.top+q.height/2,H=Math.hypot(N-V,$-J);H<G&&(G=H,P=B)}}u=P}}if(u){const L=u.getAttribute("data-hand-card");if(L){const[G,P]=L.split(","),N=parseInt(G,10),$=parseInt(P,10),B=e.players.find(V=>V.id===N),q=B==null?void 0:B.hand[$];if(B&&q){if(d.type==="Revealed"&&!B.isDummy){if((S=q.statuses)==null?void 0:S.some(ne=>ne.type==="Revealed"&&ne.addedByPlayerId===T))return;d.count===1&&(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),_()),a({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((v=d.sourceCard)==null?void 0:v.ownerId)??T??void 0,statusType:d.type,count:1},{target:"hand",playerId:N,cardIndex:$,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?l(ne=>ne?{...ne,count:ne.count-1}:null):l(null),i.current=!0,setTimeout(()=>{i.current=!1},300);return}const J={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,tokenType:d.type};if(!ot({card:q,ownerId:N,location:"hand"},J,T,e.players))return;d.count===1&&(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),_()),a({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((M=d.sourceCard)==null?void 0:M.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:N,cardIndex:$,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?l(ae=>ae?{...ae,count:ae.count-1}:null):l(null),i.current=!0,setTimeout(()=>{i.current=!1},300);return}}}if(!u){const L=A==null?void 0:A.closest("[data-board-coords]");if(L){const G=L.getAttribute("data-board-coords");if(G){const[P,N]=G.split(","),$=parseInt(P,10),B=parseInt(N,10);if(!isNaN($)&&!isNaN(B)&&$>=0&&$<e.board.length&&e.board[$]&&B>=0&&B<e.board[$].length&&e.board[$][B]){const q=e.board[$][B].card;if((q==null?void 0:q.ownerId)!==void 0){const V={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,mustBeAdjacentToSource:d.mustBeAdjacentToSource,mustBeInLineWithSource:d.mustBeInLineWithSource,sourceCoords:d.sourceCoords,tokenType:d.type};if(!ot({card:q,ownerId:q.ownerId,location:"board",boardCoords:{row:$,col:B}},V,T,e.players))return;const H=e.players.find(ae=>ae.id===q.ownerId);if(d.type==="Revealed"&&!(H!=null&&H.isDummy)){if(q.ownerId===t||!q.isFaceDown||((k=q.statuses)==null?void 0:k.some(ne=>ne.type==="Revealed"&&ne.addedByPlayerId===T)))return;t!==null&&n({source:"board",ownerId:q.ownerId,boardCoords:{row:$,col:B}},t),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?l(ne=>ne?{...ne,count:ne.count-1}:null):(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),l(null)),i.current=!0,setTimeout(()=>{i.current=!1},300);return}}if(q){const V=d.placeAllAtOnce?d.count:1;a({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((C=d.sourceCard)==null?void 0:C.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:V},{target:"board",boardCoords:{row:$,col:B}}),E("board",{row:$,col:B}),d.recordContext&&o(H=>({...H,lastMovedCardCoords:{row:$,col:B},lastMovedCardId:q.id})),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility);const J=d.count-V;if(J>0)l(H=>H?{...H,count:J}:null);else{if(d.chainedAction){const H={...d.chainedAction};d.recordContext&&(H.mode==="SELECT_CELL"&&(H.sourceCard=q,H.sourceCoords={row:$,col:B},H.recordContext=!0),H.type==="GLOBAL_AUTO_APPLY"&&(H.sourceCoords={row:$,col:B}),H.type==="CREATE_STACK"&&(H.sourceCoords={row:$,col:B},H.originalOwnerId||(H.sourceCard=q)),H.mode==="ZIUS_LINE_SELECT"&&(H.sourceCoords={row:$,col:B})),H.type==="CREATE_STACK"&&m(null),s(H,{row:$,col:B})}_(),l(null)}i.current=!0,setTimeout(()=>{i.current=!1},300)}}}}else{const G=A==null?void 0:A.closest(".counter-modal-content"),P=(A==null?void 0:A.closest("[data-board-coords]"))!==null,N=(A==null?void 0:A.closest("[data-hand-card]"))!==null;d.isDragging?G?l($=>$?{...$,isDragging:!1}:null):!P&&!N&&(_(),l(null)):!G&&!P&&!N&&(_(),l(null))}}};return window.addEventListener("mouseup",w),()=>{window.removeEventListener("mouseup",w)}},[d,a,e,t,n,r,i,o,s,l,m,E]),U.useEffect(()=>{const w=f=>{d&&(f.preventDefault(),_(),l(null))};return window.addEventListener("contextmenu",w),()=>{window.removeEventListener("contextmenu",w)}},[d,l,_]),{cursorFollowerRef:y,handleCounterMouseDown:(w,f)=>{D.current={x:f.clientX,y:f.clientY};const A=e.players.find(u=>u.id===e.activePlayerId),T=A!=null&&A.isDummy&&e.activePlayerId!==null?e.activePlayerId:t??0;l(u=>cr(w,T,u))}}};export{tt as A,Nt as B,Ds as C,hi as D,Si as E,Ii as F,yi as G,ki as H,vi as I,Oi as J,Ni as K,li as L,bo as M,vt as N,Vt as O,Ao as P,ot as Q,bt as R,Ti as S,se as T,dr as U,ui as V,_o as W,st as a,mi as b,tr as c,No as d,wi as e,De as f,_i as g,Pa as h,Ye as i,fi as j,go as k,Ai as l,I as m,er as n,Oe as o,Ei as p,wo as q,bi as r,So as s,To as t,pi as u,gi as v,Ri as w,Pi as x,Di as y,Ci as z};
