import{r as $,j as ao}from"./vendor-react-CfNVJRhB.js";import{$ as er}from"./vendor-webrtc-lnxn2S2z.js";import{d as Wn,e as oo}from"./vendor-BPR6uEV2.js";var Ke=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(Ke||{}),Or=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(Or||{});const so={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253319/SYN_IP_DEPT_AGENT_mhwphu.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253342/SYN_TACTICAL_AGENT_xbb7i0.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253325/SYN_PATROL_AGENT_ioetlu.png",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253337/SYN_RIOT_AGENT_jurf4t.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253338/SYN_THREAT_ANALYST_sqnpgw.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678622/Mr._Pearl_Director_of_BioSynch_mo0cil.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253315/HOO_RECKLESS_PROVOCATEUR_hi7a9z.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253317/HOO_DATA_LIBERATOR_lbtqa2.png",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253309/HOO_CAUTIOUS_AVENGER_x4g4g3.png",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253311/HOO_VIGILANT_SPOTTER_eiephm.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253313/HOO_INVENTIVE_MAKER_uzrbg1.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764637482/Finn_nehk0r.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253324/OPT_FABER_d7uxew.png",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253321/OPT_CENSOR_wtxtc2.png",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253332/OPT_PRINCEPS_w3o5lq.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253327/OPT_IMMUNIS_bjlncl.png",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253330/OPT_CENTURION_aaushl.png",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678954/Lucius_The_Immortal_z0lemw.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253298/FUS_CODE_KEEPER_qotsym.png",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253305/FUS_DEVOUT_SYNTHETIC_bavg9k.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253303/FUS_UNWAVERING_INTEGRATOR_emret1.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253299/FUS_SIGNAL_PROPHET_nzd7w3.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253301/FUS_ZEALOUS_MISSIONARY_mfv9xl.png",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678937/Reverend_of_The_Choir_vts8im.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253291/CMD_OVERWATCH_hrba9x.png",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253296/CMD_REPOSITIONING_m7k4kf.png",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763260942/CMD_INSPIRATION_nxifhu.png",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253290/CMD_DATA_INTERCEPTION_ks4lcv.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763640484/CMD_FALSE_ORDERS_ghi01y.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Experimental_Stimulants_x8ns1g.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Logistics_Chain_d4irtq.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507609/Quick_Response_Team_rw2cut.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Temporary_Shelter_o0embx.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Enhanced_Interrogation_suzvxe.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764626980/Autonomous_Battle_Robot_Gawain_uoyjm5.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Reclaimed_Gawain_sg6257.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764767153/Secret_informant_eb0nkm.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Michael_Falk_wcxjnp.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Edith_Byron_v6691r.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Pinkunoneko_nhmjfv.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Maria_Eleftheria_Damanaki_bmx6xv.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Zius_cwd92f.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},io={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253333/TKN_RECON_DRONE_esfknf.png",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253307/TKN_WALKING_TURRET_uq6owm.png",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},co={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Aim_dcct45.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Exploit_foomty.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Revealed_w1gbe7.png",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Stun_cwqroz.png",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Shield_z9sjr1.png",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Support_ui9qpl.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Threat_i1pbko.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1768321040/Resurrected_tscgk9.png",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},lo=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],pr={cardDatabase:so,tokenDatabase:io,countersDatabase:co,deckFiles:lo};let Gn=null,kt=new Map,Ar=new Map,Bt={},or=[],Sr={};const Bn=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function ms(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const n=await fetch("/api/content/database");if(n.ok){const r=await n.json(),a=r.cards.map(([s,c])=>[s,c]),o=r.tokens.map(([s,c])=>[s,c]);e={cardDatabase:Object.fromEntries(a),tokenDatabase:Object.fromEntries(o),countersDatabase:Object.fromEntries(r.counters),deckFiles:r.deckFiles}}else e=pr}catch{e=pr}else e=pr;Gn=e,kt=new Map(Object.entries(e.cardDatabase)),Ar=new Map(Object.entries(e.tokenDatabase)),Bt=e.countersDatabase,or=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(Bt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(n){console.warn("Could not save counters database to localStorage:",n)}It=Gn,Yn=kt,fo=Ar,$t=Bt,po=or,Sr=uo(),yo=Sr}catch(e){throw console.error("Failed to load content database:",e),e}}function uo(){const e={};for(const t of or){const n=[];for(const r of t.cards){const a=kt.get(r.cardId);if(!a){console.warn(`Card definition not found for ID: ${r.cardId} in deck: ${t.name}`);continue}const o=Bn.has(r.cardId);for(let s=0;s<r.quantity;s++){const u=r.cardId.replace(/-/g,"--DASH--").toUpperCase();o?n.push({...a,deck:Ke.Command,id:`CMD_${u}_${s+1}`,baseId:r.cardId,faction:a.faction||"Command"}):n.push({...a,deck:t.id,id:`${t.id.substring(0,3).toUpperCase()}_${u}_${s+1}`,baseId:r.cardId,faction:a.faction||t.id})}}e[t.id]=n}return e[Ke.Tokens]=Array.from(Ar.entries()).map(([t,n])=>{const r=n.types?[...n.types]:[];return{id:`TKN_${n.name.toUpperCase().replace(/\s/g,"_")}`,baseId:t,deck:Ke.Tokens,name:n.name,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage,power:n.power,ability:n.ability,color:n.color,types:r,flavorText:n.flavorText,faction:"Tokens"}}),e}let It=null,Yn=new Map,fo=new Map,$t={};try{const e=localStorage.getItem("counters_database");e&&(Bt=JSON.parse(e),$t=Bt)}catch{}let po=[],yo={};const ho=Bn,gs=()=>or.filter(e=>e.isSelectable);function _t(e){return kt.get(e)}function yr(e){return Array.from(kt.values()).find(t=>t.name===e)}function ws(){return Array.from(kt.entries()).map(([e,t])=>({id:e,card:t}))}function _s(){return kt}function zn(){return Sr}const Io=4,Cs={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764252181/medal_rgbw8d.png"},bs={[Ke.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[Ke.Hoods]:{prefix:"HOO",color:"border-purple-500"},[Ke.Optimates]:{prefix:"OPT",color:"border-red-500"},[Ke.Fusion]:{prefix:"FUS",color:"border-green-400"},[Ke.Command]:{prefix:"CMD",color:"border-yellow-500"},[Ke.Tokens]:{prefix:"TKN",color:"border-gray-400"},[Ke.Custom]:{prefix:"CUS",color:"border-purple-400"},[Ke.Neutral]:{prefix:"NEU",color:"border-gray-400"},[Ke.Random]:{prefix:"RND",color:"border-gray-400"}},As={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},Eo={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},Ss={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},sr=["blue","purple","red","green","yellow","orange","pink","brown"],Ds=["Setup","Main","Commit","Scoring"],tr=()=>Object.fromEntries(Object.entries($t).map(([e,t])=>[e,t.imageUrl])),Rs=new Proxy({},{get(e,t){return tr()[t]},ownKeys(){return Object.keys(tr())},has(e,t){return t in tr()},getOwnPropertyDescriptor(e,t){const n=tr()[t];return n!==void 0?{enumerable:!0,configurable:!0,value:n}:void 0}}),rr=()=>Object.fromEntries(Object.entries($t).map(([e,t])=>[e,t.description])),Os=new Proxy({},{get(e,t){return rr()[t]},ownKeys(){return Object.keys(rr())},has(e,t){return t in rr()},getOwnPropertyDescriptor(e,t){const n=rr()[t];return n!==void 0?{enumerable:!0,configurable:!0,value:n}:void 0}}),To=()=>Object.entries($t).filter(([,e])=>!e.allowedPanels||e.allowedPanels.includes("COUNTER_PANEL")).sort(([,e],[,t])=>e.sortOrder-t.sortOrder).map(([e,t])=>({type:e,label:t.name}));To();const jt="readyDeploy",Vt="readySetup",Jt="readyCommit",Lt=(e,t,n,r)=>Math.abs(e-n)+Math.abs(t-r)===1,Ve=(e,t,n)=>e.statuses?e.statuses.some(r=>r.type===t&&(n===void 0||r.addedByPlayerId===n)):!1,xt=(e,t)=>e.statuses?e.statuses.some(n=>n.type===t):!1,mo=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Ve(a,"Aim",n)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"threatAnalyst",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>{let a=0;return t.board.forEach(o=>{o.forEach(s=>{var c;(c=s.card)!=null&&c.statuses&&(a+=s.card.statuses.filter(u=>u.type==="Exploit"&&u.addedByPlayerId===n).length)})}),a===0?null:{type:"CREATE_STACK",tokenType:"Revealed",count:a,onlyFaceDown:!0}}},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,t,n,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:n})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,t,n,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>{var o;return a.ownerId!==n&&((o=a.statuses)==null?void 0:o.some(s=>s.type==="Threat"))}},sourceCard:e,sourceCoords:r})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.ownerId!==n&&Ve(a,"Exploit",n)}})},{baseId:"centurion",activationType:"commit",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(a,o,s)=>{var c;return a.ownerId===n&&((c=a.types)==null?void 0:c.includes("Unit"))&&o!==void 0&&s!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:r,payload:{filter:(a,o,s)=>Lt(o,s,r.row,r.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.id===e.id?!1:a.ownerId===n}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:r,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Ve(a,"Aim",n)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,originalOwnerId:n,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:a=>a.ownerId===n}})},{baseId:"censor",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:r,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Ve(a,"Aim",n)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,t,n,r)=>Ve(e,"Support",n)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:r,payload:{filter:(a,o)=>Lt(a,o,r.row,r.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(a,o,s)=>Lt(o,s,r.row,r.col)&&a.ownerId!==n&&(Ve(a,"Threat",n)||Ve(a,"Stun",n))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,t,n,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>a.ownerId===n&&Ve(a,"Support",n)},sourceCard:e,sourceCoords:r})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.ownerId===n&&Ve(a,"Exploit",n)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:r,payload:{filter:a=>Ve(a,"Exploit",n)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"MODIFY_POWER",amount:-1,filter:a=>Ve(a,"Aim",n)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:r,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"REVEAL_ENEMY",sourceCard:e,sourceCoords:r,payload:{filter:(a,o,s)=>Lt(o,s,r.row,r.col)&&a.ownerId!==n}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Ve(a,"Aim",n)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(a,o,s)=>Lt(o,s,r.row,r.col)&&a.ownerId!==n&&(Ve(a,"Threat",n)||Ve(a,"Stun",n))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,t,n,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:n})},{baseId:"edithByron",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(a,o,s)=>Lt(o,s,r.row,r.col)&&(Ve(a,"Threat",n)||Ve(a,"Stun",n)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Ve(a,"Aim",n)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:r,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,t,n,r)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:r,ownerId:n})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"LUCIUS_SETUP",filter:a=>a.ownerId===n}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.ownerId===n,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,t,n,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:r})}],Pr=e=>{const t=e.baseId||"";return mo.filter(n=>{var r;return n.baseId===t||((r=n.baseIdAlt)==null?void 0:r.includes(t))})},go=e=>{const n=Pr(e).map(r=>r.activationType);return[...new Set(n)]},Dr=(e,t,n,r)=>{var s;if(n!==e.ownerId)return!1;if(r&&e.ownerId!==void 0){const c=r.players.find(u=>u.id===e.ownerId);if(c!=null&&c.isDummy&&r.activePlayerId!==e.ownerId)return!1}if((s=e.statuses)!=null&&s.some(c=>c.type==="Stun"))return!1;const a=Pr(e),o=t===1&&a.some(c=>c.activationType==="setup")||t===3&&a.some(c=>c.activationType==="commit");if(t===1){const c=a.find(u=>u.activationType==="setup");if(c&&xt(e,Vt))return!(c.supportRequired&&!Ve(e,"Support",n))}if(t===3){const c=a.find(u=>u.activationType==="commit");if(c&&xt(e,Jt))return!(c.supportRequired&&!Ve(e,"Support",n))}if(!o){const c=a.find(u=>u.activationType==="deploy");if(c&&xt(e,jt))return!(c.supportRequired&&!Ve(e,"Support",n))}return!1},wo=(e,t,n,r)=>{if(n!==e.ownerId)if(e.ownerId!==void 0){const u=t.players.find(m=>m.id===e.ownerId);if(!(u!=null&&u.isDummy))return null}else return null;const a=Pr(e),o=e.ownerId??n??0,s=t.currentPhase,c=s===1&&a.some(u=>u.activationType==="setup")||s===3&&a.some(u=>u.activationType==="commit");if(s===1){const u=a.find(m=>m.activationType==="setup");if(u&&xt(e,Vt)){if(u.supportRequired&&!Ve(e,"Support",o))return null;const m=u.getAction(e,t,o,r);if(m)return{...m,readyStatusToRemove:Vt}}}if(s===3){const u=a.find(m=>m.activationType==="commit");if(u&&xt(e,Jt)){if(u.supportRequired&&!Ve(e,"Support",o))return null;const m=u.getAction(e,t,o,r);if(m)return{...m,readyStatusToRemove:Jt}}}if(!c){const u=a.find(m=>m.activationType==="deploy");if(u&&xt(e,jt)){if(u.supportRequired&&!Ve(e,"Support",o))return null;const m=u.getAction(e,t,o,r);if(m)return{...m,isDeployAbility:!0,readyStatusToRemove:jt}}}return null},_o=(e,t,n)=>{let r,a;return typeof t=="object"?(r=t.currentPhase,n=t.activePlayerId??void 0,a=t):r=t,Dr(e,r,n??void 0,a)},kr=(e,t)=>{e.statuses||(e.statuses=[]);const n=e.statuses.length,r=e.statuses.map(o=>o.type),a=go(e);console.log(`[initializeReadyStatuses] Card: ${e.name} (${e.id}), ownerId: ${t}, abilities: [${a.join(", ")}]`);for(const o of a){let s="";o==="deploy"?s=jt:o==="setup"?s=Vt:o==="commit"&&(s=Jt),s&&!e.statuses.some(c=>c.type===s)&&(e.statuses.push({type:s,addedByPlayerId:t}),console.log(`[initializeReadyStatuses] Added status: ${s} to ${e.name}`))}e.statuses.length!==n&&console.log(`[initializeReadyStatuses] Card ${e.name}: statuses changed from [${r.join(", ")}] to [${e.statuses.map(o=>o.type).join(", ")}]`)},hr=e=>{e.statuses&&(e.statuses=e.statuses.filter(t=>t.type!==jt&&t.type!==Vt&&t.type!==Jt))};function Ue(e){const t=e,n=t==null?void 0:t.targetingMode;n&&delete t.targetingMode;let r;return typeof structuredClone<"u"?r=structuredClone(e):r=JSON.parse(JSON.stringify(e)),n&&(r.targetingMode=n,t.targetingMode=n),r}const be={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function Ps(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function ks(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}function vs(e,t){return e?Eo[e]:t}const Kn=$.createContext(null),Ns=({children:e})=>{const[t,n]=$.useState(null),[r,a]=$.useState({}),[o,s]=$.useState("lg"),c=$.useCallback((A,N={},_="lg")=>{n(A),a(N),s(_)},[]),u=$.useCallback(()=>{n(null),a({}),s("lg")},[]),m=$.useCallback(A=>t===A,[t]),f=$.useCallback(()=>r,[r]),v=$.useCallback(()=>o,[o]),y={openModal:t,modalData:r,modalSize:o,open:c,close:u,isOpen:m,getData:f,getSize:v};return ao.jsx(Kn.Provider,{value:y,children:e})},lr=()=>{const e=$.useContext(Kn);if(!e)throw new Error("useModals must be used within ModalsProvider");return e},Ls=()=>{const{open:e,close:t,isOpen:n}=lr();return{isOpen:n("rules"),open:r=>e("rules",r,"full"),close:t}},Ms=()=>{const{open:e,close:t,isOpen:n}=lr();return{isOpen:n("settings"),open:r=>e("settings",r,"md"),close:t}},Gs=()=>{const{open:e,close:t,isOpen:n,getData:r}=lr();return{isOpen:n("joinGame"),open:a=>e("joinGame",a,"lg"),close:t,getData:()=>r()}},xs=()=>{const{open:e,close:t,isOpen:n}=lr();return{isOpen:n("deckBuilder"),open:r=>e("deckBuilder",r,"full"),close:t}},d={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},Yt="webrtc_game_state",zt="webrtc_host_data",Kt="webrtc_guest_data",Co="webrtc_current_host_peerId",bo=30*60*1e3;function vr(){return Date.now()}function Xt(e){return Date.now()-e<bo}function Ao(e){try{const t={...e,timestamp:vr()};localStorage.setItem(zt,JSON.stringify(t)),d.info("[WebRTC Persistence] Saved host data:",{peerId:t.peerId})}catch(t){d.error("[WebRTC Persistence] Failed to save host data:",t)}}function Ir(e){try{const t={...e,timestamp:vr()};localStorage.setItem(Kt,JSON.stringify(t)),d.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId})}catch(t){d.error("[WebRTC Persistence] Failed to save guest data:",t)}}function Ht(e){try{const t={...e,timestamp:vr()};localStorage.setItem(Yt,JSON.stringify(t)),d.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(t.timestamp).toISOString())}catch(t){d.error("[WebRTC Persistence] Failed to save game state:",t)}}function qn(){try{const e=localStorage.getItem(zt);if(!e)return null;const t=JSON.parse(e);return Xt(t.timestamp)?(d.info("[WebRTC Persistence] Loaded valid host data:",{peerId:t.peerId}),t):(d.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(zt),null)}catch(e){return d.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(zt),null}}function jn(){try{const e=localStorage.getItem(Kt);if(!e)return null;const t=JSON.parse(e);return Xt(t.timestamp)?(d.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId}),t):(d.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(Kt),null)}catch(e){return d.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(Kt),null}}function xn(){try{const e=localStorage.getItem(Yt);if(!e)return null;const t=JSON.parse(e);return Xt(t.timestamp)?(d.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(t.timestamp).toISOString()),t):(d.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(Yt),null)}catch(e){return d.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(Yt),null}}function Gt(){localStorage.removeItem(Yt),localStorage.removeItem(zt),localStorage.removeItem(Kt),localStorage.removeItem(Co)}function Rr(e,t){try{const n=`webrtc_host_${t}`,r={peerId:e,gameId:t,timestamp:Date.now()};localStorage.setItem(n,JSON.stringify(r)),d.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${t}:`,e)}catch(n){d.error("[WebRTC Persistence] Failed to broadcast host peerId:",n)}}function Er(e){try{const t=`webrtc_host_${e}`,n=localStorage.getItem(t);if(!n)return null;const r=JSON.parse(n);return Date.now()-r.timestamp>15e3?null:{peerId:r.peerId,timestamp:r.timestamp}}catch(t){return d.error("[WebRTC Persistence] Failed to get host peerId:",t),null}}function So(e){try{const t=`webrtc_host_${e}`;localStorage.removeItem(t),d.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(t){d.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",t)}}function Do(){const e=sessionStorage.getItem("invite_host_id"),t=sessionStorage.getItem("invite_auto_join");if(e&&t)return"none";const n=qn();if(n&&Xt(n.timestamp))return"host";const r=jn();return r&&Xt(r.timestamp)?"guest":"none"}const Un=7,Tr="mrPearlDoF",Ro="reverendOfTheChoir",Oo="threatAnalyst";function Po(e,t){return e!=null&&e.statuses?e.statuses.some(n=>n.type==="Exploit"&&n.addedByPlayerId!==void 0&&t.has(n.addedByPlayerId)):!1}function ko(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const Vn=()=>Array(Un).fill(null).map(()=>Array(Un).fill(null).map(()=>({card:null}))),ot=e=>{var _,E,h,P,D;const{board:t,activeGridSize:n,players:r}=e,a=ko(t),o=a.length,s=Math.floor((o-n)/2),c=new Map;r.forEach(l=>c.set(l.id,l.teamId));for(let l=0;l<o;l++)for(let b=0;b<o;b++){const T=a[l][b].card;T&&(T.statuses&&(T.statuses=T.statuses.filter(L=>L.type!=="Support"&&L.type!=="Threat")),delete T.bonusPower)}for(let l=0;l<o;l++)for(let b=0;b<o;b++){const T=a[l][b].card;if((T==null?void 0:T.ownerId)===void 0||T.isFaceDown)continue;const L=T.ownerId,g=c.get(L),O=[{r:l-1,c:b},{r:l+1,c:b},{r:l,c:b-1},{r:l,c:b+1}],S={};let k=!1;for(const V of O){const{r:te,c:ee}=V;if(te>=0&&te<o&&ee>=0&&ee<o){const pe=a[te][ee].card,ye=(_=pe==null?void 0:pe.statuses)==null?void 0:_.some(Te=>Te.type==="Stun");if((pe==null?void 0:pe.ownerId)!==void 0&&!pe.isFaceDown&&!ye){const Te=pe.ownerId,Fe=c.get(Te);L===Te||g!==void 0&&g===Fe?k=!0:(S[Te]||(S[Te]=[]),S[Te].push({r:te,c:ee}))}}}k&&(T.statuses||(T.statuses=[]),T.statuses.some(V=>V.type==="Support")||T.statuses.push({type:"Support",addedByPlayerId:L}));let Y=null;for(const V in S){const te=S[V];if(te&&te.length>=2){Y=parseInt(V,10);break}}if(Y===null&&l>=s&&l<s+n&&b>=s&&b<s+n){const te=l===s||l===s+n-1||b===s||b===s+n-1,ee=Object.keys(S).length>0;if(te&&ee){const pe=Object.keys(S)[0];pe&&(Y=parseInt(pe,10))}}Y!==null&&(T.statuses||(T.statuses=[]),T.statuses.some(V=>V.type==="Threat")||T.statuses.push({type:"Threat",addedByPlayerId:Y}))}const u=new Set;for(let l=0;l<o;l++)for(let b=0;b<o;b++){const T=a[l][b].card,L=(E=T==null?void 0:T.statuses)==null?void 0:E.some(g=>g.type==="Stun");if((T==null?void 0:T.baseId)===Oo&&!T.isFaceDown&&T.ownerId!==void 0&&!L){const g=[{r:l-1,c:b},{r:l+1,c:b},{r:l,c:b-1},{r:l,c:b+1}];let O=!1;const S=T.ownerId,k=c.get(S);for(const Y of g){const{r:V,c:te}=Y;if(V>=0&&V<o&&te>=0&&te<o){const ee=a[V][te].card;if((ee==null?void 0:ee.ownerId)!==void 0&&!ee.isFaceDown){const pe=ee.ownerId,ye=c.get(pe),Te=S===pe||k!==void 0&&k===ye,Fe=(h=ee==null?void 0:ee.statuses)==null?void 0:h.some(ve=>ve.type==="Stun");if(Te&&!Fe){O=!0;break}}}}O&&u.add(S)}}for(let l=0;l<o;l++)for(let b=0;b<o;b++){const T=a[l][b].card;if(!T||T.isFaceDown||T.ownerId===void 0)continue;const L=T.ownerId,g=c.get(L),O=[{r:l-1,c:b},{r:l+1,c:b},{r:l,c:b-1},{r:l,c:b+1}],S={};for(const Y of O){const{r:V,c:te}=Y;if(V>=0&&V<o&&te>=0&&te<o){const ee=a[V][te].card,pe=(P=ee==null?void 0:ee.statuses)==null?void 0:P.some(ye=>ye.type==="Stun");if((ee==null?void 0:ee.ownerId)!==void 0&&!ee.isFaceDown&&!pe){const ye=ee.ownerId,Te=c.get(ye);if(!(L===ye||g!==void 0&&g===Te)){const ve=u.has(ye),Re=Po(T,u);ve&&Re&&(S[ye]||(S[ye]=0),S[ye]++)}}}}if(Object.keys(S).length>0){T.statuses||(T.statuses=[]);const Y=Object.keys(S).map(V=>parseInt(V,10));for(const V of Y)T.statuses.some(te=>te.type==="Threat"&&te.addedByPlayerId===V)||T.statuses.push({type:"Threat",addedByPlayerId:V})}}const m=[],f=[];for(let l=0;l<o;l++)for(let b=0;b<o;b++){const T=a[l][b].card,L=(D=T==null?void 0:T.statuses)==null?void 0:D.some(g=>g.type==="Stun");T!=null&&T.baseId&&!T.isFaceDown&&T.ownerId!==void 0&&!L&&(T.baseId===Ro?m.push({r:l,c:b,ownerId:T.ownerId,baseId:T.baseId}):T.baseId===Tr&&f.push({r:l,c:b,ownerId:T.ownerId,baseId:T.baseId}))}const v=new Set,y=new Set;for(const l of m){const{r:b,c:T,ownerId:L}=l,g=`${b}-${L}`;if(!v.has(g)){v.add(g);for(let S=0;S<o;S++){const k=a[b][S].card;k&&k.ownerId===L&&!k.isFaceDown&&(k.statuses||(k.statuses=[]),k.statuses.some(Y=>Y.type==="Support")||k.statuses.push({type:"Support",addedByPlayerId:L}))}}const O=`${T}-${L}`;if(!y.has(O)){y.add(O);for(let S=0;S<o;S++){const k=a[S][T].card;k&&k.ownerId===L&&!k.isFaceDown&&(k.statuses||(k.statuses=[]),k.statuses.some(Y=>Y.type==="Support")||k.statuses.push({type:"Support",addedByPlayerId:L}))}}}const A=new Set,N=new Set;for(const l of f){const{r:b,c:T,ownerId:L}=l,g=`${b}-${L}`;if(!A.has(g)){A.add(g);for(let S=0;S<o;S++){const k=a[b][S].card;k&&k.ownerId===L&&!k.isFaceDown&&k.baseId!==Tr&&(k.bonusPower=(k.bonusPower||0)+1)}}const O=`${T}-${L}`;if(!N.has(O)){N.add(O);for(let S=0;S<o;S++){const k=a[S][T].card;k&&k.ownerId===L&&!k.isFaceDown&&k.baseId!==Tr&&(k.bonusPower=(k.bonusPower||0)+1)}}}return a};var vt=(e=>(e[e.CARD_REGISTRY=1]="CARD_REGISTRY",e[e.CARD_STATE=2]="CARD_STATE",e[e.ABILITY_EFFECT=3]="ABILITY_EFFECT",e[e.SESSION_EVENT=4]="SESSION_EVENT",e))(vt||{});function Jn(){const e={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},t=new Set,n=Array.from(Yn.values());for(const r of n)if(r.baseId&&!t.has(r.baseId)){t.add(r.baseId);const a=e.cardDefinitions.length;e.baseIdToIndex.set(r.baseId,a),e.indexToBaseId.set(a,r.baseId),e.cardDefinitions.push({baseId:r.baseId,name:r.name,imageUrl:r.imageUrl,power:r.power,ability:r.ability||"",types:r.types||[],faction:r.faction||""})}return e.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],d.info(`[CardRegistry] Built registry with ${e.cardDefinitions.length} cards, ${e.statusTypes.length} status types`),e}function vo(e){var o,s,c,u,m;const t=new TextEncoder;let n=3;for(const f of e.cardDefinitions){n+=1+f.baseId.length,n+=1+(((o=f.name)==null?void 0:o.length)||0),n+=2+(((s=f.imageUrl)==null?void 0:s.length)||0),n+=1,n+=2+(((c=f.ability)==null?void 0:c.length)||0),n+=1+(((u=f.types)==null?void 0:u.length)||0);for(const v of f.types||[])n+=1+v.length;n+=1+(((m=f.faction)==null?void 0:m.length)||0)}for(const f of e.statusTypes)n+=1+f.length;const r=new Uint8Array(n);let a=0;r[a++]=e.cardDefinitions.length>>8&255,r[a++]=e.cardDefinitions.length&255,r[a++]=e.statusTypes.length&255;for(const f of e.cardDefinitions){r[a++]=f.baseId.length,t.encodeInto(f.baseId,r.subarray(a,a+f.baseId.length)),a+=f.baseId.length;const v=f.name||"";r[a++]=v.length,t.encodeInto(v,r.subarray(a,a+v.length)),a+=v.length;const y=f.imageUrl||"";r[a++]=y.length>>8&255,r[a++]=y.length&255,t.encodeInto(y,r.subarray(a,a+y.length)),a+=y.length,r[a++]=Math.clamp(f.power,-128,127);const A=f.ability||"";r[a++]=A.length>>8&255,r[a++]=A.length&255,t.encodeInto(A,r.subarray(a,a+A.length)),a+=A.length;const N=f.types||[];r[a++]=N.length;for(const E of N)r[a++]=E.length,t.encodeInto(E,r.subarray(a,a+E.length)),a+=E.length;const _=f.faction||"";r[a++]=_.length,t.encodeInto(_,r.subarray(a,a+_.length)),a+=_.length}for(const f of e.statusTypes)r[a++]=f.length,t.encodeInto(f,r.subarray(a,a+f.length)),a+=f.length;return d.info(`[CardRegistry] Serialized registry: ${r.length} bytes`),r}function Xn(e,t){let n=0;for(const r of e||[]){const a=t.statusTypes.indexOf(r.type);a>=0&&a<32&&(n|=1<<a)}return n>>>0}function Zn(e,t,n){const r=[];for(let a=0;a<32;a++)if(e&1<<a){const o=n.statusTypes[a];o&&r.push({type:o,addedByPlayerId:t})}return r}function Qn(e){let t=0;return e.isFaceDown&&(t|=1),e.enteredThisTurn&&(t|=2),e.revealedTo==="all"&&(t|=4),t}function mr(e,t){const n=new Uint8Array(13);let r=0;const a=Nr(e.id);n[r++]=a>>24&255,n[r++]=a>>16&255,n[r++]=a>>8&255,n[r++]=a&255;const o=e.baseId?t.baseIdToIndex.get(e.baseId)??0:0;n[r++]=o>>8&255,n[r++]=o&255,n[r++]=(e.ownerId??0)&255;const s=Math.round(e.power||0);n[r++]=Math.clamp(s,-128,127)&255,n[r++]=Qn(e);const c=Xn(e.statuses||[],t);return n[r++]=c>>24&255,n[r++]=c>>16&255,n[r++]=c>>8&255,n[r++]=c&255,n}function No(e,t){const n=new Uint8Array(9);let r=0;const a=Nr(e.id);n[r++]=a>>24&255,n[r++]=a>>16&255,n[r++]=a>>8&255,n[r++]=a&255,n[r++]=Qn(e);const o=Xn(e.statuses||[],t);return n[r++]=o>>24&255,n[r++]=o>>16&255,n[r++]=o>>8&255,n[r++]=o&255,n}function Nr(e){let t=0;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);t=(t<<5)-t+r,t=t&t}return t>>>0}function Lo(e,t,n){var _;const r=[],a=Date.now(),o=new Uint8Array(7);o[0]=vt.CARD_STATE,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,r.push(o);const s=[],c=Math.min(e.players.length,255);s.push(new Uint8Array([c]));for(const E of e.players){s.push(new Uint8Array([E.id&255]));const h=Math.min(E.deck.length,255),P=Math.min(E.hand.length,255),D=Math.min(E.discard.length,255);s.push(new Uint8Array([h,P,D,E.announcedCard?1:0])),s.push(new Uint8Array([Math.min(E.score,255)]));const l=Math.min(E.hand.length,255);s.push(new Uint8Array([l]));const b=E.id===n;for(const L of E.hand)b?s.push(mr(L,t)):s.push(No(L,t));const T=Math.min(E.discard.length,255);s.push(new Uint8Array([T]));for(const L of E.discard){const g=Nr(L.id),O=new Uint8Array(4);O[0]=g>>24&255,O[1]=g>>16&255,O[2]=g>>8&255,O[3]=g&255,s.push(O)}E.announcedCard&&s.push(mr(E.announcedCard,t))}const u=e.board.length;s.push(new Uint8Array([u,u,u]));const m=[];for(let E=0;E<e.board.length;E++)for(let h=0;h<((_=e.board[E])==null?void 0:_.length);h++){const P=e.board[E][h];P!=null&&P.card&&m.push({row:E,col:h,card:P.card})}const f=m.length,v=new Uint8Array(2);v[0]=f>>8&255,v[1]=f&255,s.push(v);for(const{row:E,col:h,card:P}of m)s.push(new Uint8Array([E,h])),s.push(mr(P,t));s.push(new Uint8Array([e.currentPhase===void 0?255:Math.clamp(e.currentPhase,0,254),(e.activePlayerId??255)&255,e.currentRound===void 0?255:Math.clamp(e.currentRound,0,254)]));let y=0;for(const E of s)y+=E.length;o[5]=y>>8&255,o[6]=y&255,r.push(...s);const A=new Uint8Array(r.reduce((E,h)=>E+h.length,0));let N=0;for(const E of r)A.set(E,N),N+=E.length;return d.info(`[GameCodec] Encoded card state: ${A.length} bytes (${f} board cards, ${e.players.length} players)`),A}function Mo(e,t,n){let r=0;if(e[r++]!==vt.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],e[r++]<<8|e[r++];const a=e[r++],o=[];for(let _=0;_<a;_++){const E=e[r++],h=e[r++];e[r++],e[r++];const P=e[r++]===1,D=e[r++],l=e[r++],b=[],T=E===n;for(let k=0;k<l;k++)if(T)b.push(gr(e,r,t)),r+=13;else{const Y=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],V=e[r++],te=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];b.push({id:`card_${Y}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isFaceDown:(V&1)!==0,revealedTo:V&4?"all":void 0,statuses:Zn(te,E,t),isPlaceholder:!0})}const L=e[r++],g=[];for(let k=0;k<L;k++){const Y=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];g.push({id:`discard_${Y}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isPlaceholder:!0})}let O=null;P&&(O=gr(e,r,t),r+=13);const S=[];for(let k=0;k<h;k++)S.push({id:`deck_${E}_${k}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isPlaceholder:!0});o.push({id:E,name:`Player ${E}`,score:D,hand:b,deck:S,discard:g,announcedCard:O,selectedDeck:"Random",color:"blue",boardHistory:[]})}const s=e[r++];e[r++],e[r++];const c=e[r++]<<8|e[r++],u=[];for(let _=0;_<s;_++){const E=[];for(let h=0;h<s;h++)E.push({card:null});u.push(E)}for(let _=0;_<c;_++){const E=e[r++],h=e[r++],P=gr(e,r,t);r+=13,E<u.length&&h<u[E].length&&(u[E][h]={card:P})}const m=e[r++],f=e[r++],v=e[r++];return{players:o,board:u,currentPhase:m===255?void 0:m,activePlayerId:f===255?null:f,currentRound:v===255?void 0:v}}function gr(e,t,n){const a=`card_${e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++]}_${Date.now()}`,o=e[t++]<<8|e[t++],s=e[t++];let c=e[t++];c>127&&(c=c-256);const u=e[t++],m=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++],f=n.cardDefinitions[o],v=(f==null?void 0:f.baseId)||"";return{id:a,baseId:v,deck:"Random",name:(f==null?void 0:f.name)||"?",imageUrl:(f==null?void 0:f.imageUrl)||"",power:c,ability:(f==null?void 0:f.ability)||"",types:(f==null?void 0:f.types)||[],faction:(f==null?void 0:f.faction)||"",ownerId:s,isFaceDown:(u&1)!==0,enteredThisTurn:(u&2)!==0,revealedTo:u&4?"all":void 0,statuses:Zn(m,0,n)}}Math.clamp||(Math.clamp=function(e,t,n){return Math.min(Math.max(e,t),n)});let wr=null;function ea(){return wr||(wr=Jn()),wr}function $n(e,t){const n=ea();return Lo(e,n,t)}function Go(e,t){const n=ea();return Mo(e,n,t)}function xo(e){return Wn(e)}function ta(e){d.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return oo(e)}catch(t){return d.error("[webrtcSerialization] Failed to serialize delta:",t),new Uint8Array(0)}}function ra(e){d.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Wn(e)}catch(t){return d.error("[webrtcSerialization] Failed to deserialize delta:",t),{}}}function Uo(e){const t=ta(e);let n="";const r=new Uint8Array(t),a=r.byteLength;for(let o=0;o<a;o++)n+=String.fromCharCode(r[o]);return btoa(n)}function $o(e){const t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return ra(n)}function Ho(e,t){var v;const n=new TextEncoder,r=[],a=Date.now(),o=new Uint8Array(7);o[0]=vt.ABILITY_EFFECT,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,r.push(o);const s=[];if(s.push(new Uint8Array([e])),t.sourcePos){const y=(t.sourcePos.row&15)<<4|t.sourcePos.col&15;s.push(new Uint8Array([y]))}else s.push(new Uint8Array([255]));const c=((v=t.targetPositions)==null?void 0:v.length)||0;if(s.push(new Uint8Array([Math.min(c,255)])),t.targetPositions)for(const y of t.targetPositions.slice(0,255)){const A=(y.row&15)<<4|y.col&15;s.push(new Uint8Array([A]))}if(t.text){const y=n.encode(t.text),A=Math.min(y.length,255);s.push(new Uint8Array([A])),s.push(y.slice(0,A))}else s.push(new Uint8Array([0]));s.push(new Uint8Array([(t.value??0)&255])),s.push(new Uint8Array([(t.playerId??0)&255]));let u=0;for(const y of s)u+=y.length;o[5]=u>>8&255,o[6]=u&255,r.push(...s);const m=new Uint8Array(r.reduce((y,A)=>y+A.length,0));let f=0;for(const y of r)m.set(y,f),f+=y.length;return d.debug(`[AbilityMessages] Encoded effect type ${e}: ${m.length} bytes`),m}function Fo(e){let t=0;if(e[t++]!==vt.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const n=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={effectType:e[t++],timestamp:n,data:{}},a=e[t++];a!==255&&(r.data.sourcePos={row:a>>4&15,col:a&15});const o=e[t++];if(o>0){r.data.targetPositions=[];for(let c=0;c<o;c++){const u=e[t++];r.data.targetPositions.push({row:u>>4&15,col:u&15})}}const s=e[t++];if(s>0){const c=new TextDecoder;r.data.text=c.decode(e.subarray(t,t+s)),t+=s}return r.data.value=e[t++],r.data.playerId=e[t++],r}function Wo(e,t={}){const n=new TextEncoder,r=[],a=Date.now(),o=new Uint8Array(7);o[0]=vt.SESSION_EVENT,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,r.push(o);const s=[];if(s.push(new Uint8Array([e])),s.push(new Uint8Array([(t.playerId??0)&255])),t.playerName){const v=n.encode(t.playerName),y=Math.min(v.length,255);s.push(new Uint8Array([y])),s.push(v.slice(0,y))}else s.push(new Uint8Array([0]));s.push(new Uint8Array([(t.startingPlayerId??0)&255])),s.push(new Uint8Array([Math.min(t.roundNumber??0,255)])),s.push(new Uint8Array([Math.min(t.newPhase??0,255)])),s.push(new Uint8Array([(t.newActivePlayerId??0)&255])),s.push(new Uint8Array([(t.gameWinner??255)&255]));let c=0;if(t.winners)for(const v of t.winners)v<32&&(c|=1<<v);s.push(new Uint8Array([c>>24&255,c>>16&255,c>>8&255,c&255]));let u=0;for(const v of s)u+=v.length;o[5]=u>>8&255,o[6]=u&255,r.push(...s);const m=new Uint8Array(r.reduce((v,y)=>v+y.length,0));let f=0;for(const v of r)m.set(v,f),f+=v.length;return d.debug(`[SessionMessages] Encoded event type ${e}: ${m.length} bytes`),m}function Bo(e){let t=0;if(e[t++]!==vt.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const n=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={eventType:e[t++],timestamp:n,data:{}};r.data.playerId=e[t++];const a=e[t++];if(a>0){const c=new TextDecoder;r.data.playerName=c.decode(e.subarray(t,t+a)),t+=a}r.data.startingPlayerId=e[t++],r.data.roundNumber=e[t++],r.data.newPhase=e[t++],r.data.newActivePlayerId=e[t++];const o=e[t++];r.data.gameWinner=o===255?null:o;const s=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];if(s!==0){r.data.winners=[];for(let c=0;c<32;c++)s&1<<c&&r.data.winners.push(c)}return r}const Yo=!0;class Et{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,this.guestPlayerIds=new Map,localStorage.getItem("webrtc_enabled")}async initializeAsHost(t){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((n,r)=>{this.peer=t?new er(t):new er,this.peer.on("open",a=>{this.emitEvent({type:"peer_open",data:{peerId:a}}),n(a)}),this.peer.on("connection",a=>{d.info(`Guest connection request from: ${a.peer}`),this.handleGuestConnection(a)}),this.peer.on("error",a=>{d.error("WebRTC Peer error:",a),this.emitEvent({type:"error",data:a}),r(a)}),this.peer.on("close",()=>{d.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(t){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((n,r)=>{this.peer=new er,this.peer.on("open",a=>{const o=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(o),o.on("open",()=>{this.hostConnection=o,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}});let s=null;try{const c=localStorage.getItem("webrtc_preferred_deck");c&&(s=c,d.info(`[initializeAsGuest] Found deck preference in localStorage: ${s}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(c){d.warn("[initializeAsGuest] Failed to read deck preference:",c)}this.sendMessageToHost({type:"JOIN_REQUEST",senderId:a,data:{preferredDeck:s||void 0},timestamp:Date.now()}),n()}),o.on("error",s=>{d.error("Host connection error:",s),this.emitEvent({type:"error",data:s}),r(s)})}),this.peer.on("error",a=>{d.error("WebRTC Peer error:",a),this.emitEvent({type:"error",data:a}),r(a)})})}async initializeAsReconnectingGuest(t,n){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((r,a)=>{this.peer=new er,this.peer.on("open",o=>{const s=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(s),s.on("open",()=>{this.hostConnection=s,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:o,playerId:n,timestamp:Date.now()}),this.isReconnecting=!1,r()}),s.on("error",c=>{d.error("Host connection error:",c),this.emitEvent({type:"error",data:c}),this.isReconnecting=!1,a(c)})}),this.peer.on("error",o=>{d.error("WebRTC Peer error:",o),this.emitEvent({type:"error",data:o}),this.isReconnecting=!1,a(o)})})}handleGuestConnection(t){this.connections.set(t.peer,t),t.on("open",()=>{d.info(`Guest connected: ${t.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:t.peer}})}),t.on("data",n=>{this.handleMessage(n,t)}),t.on("close",()=>{d.info(`Guest disconnected: ${t.peer}`),this.connections.delete(t.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:t.peer}})}),t.on("error",n=>{d.error(`Guest connection error (${t.peer}):`,n)})}setupHostConnection(t){this.hostConnection=t,t.on("data",n=>{this.handleMessage(n,t)}),t.on("close",()=>{d.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),t.on("error",n=>{d.error("Host connection error:",n)})}handleMessage(t,n){d.debug("Received WebRTC message:",t.type),this.emitEvent({type:"message_received",data:t})}sendMessageToHost(t){if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(t),!0}catch(n){return d.error("Failed to send message to host:",n),!1}return!1}broadcastToGuests(t,n){if(!this.isHost)return d.warn("Only host can broadcast to guests"),0;let r=0;return this.connections.forEach((a,o)=>{if(a.open&&o!==n)try{a.send(t),r++}catch(s){d.error(`Failed to send to guest ${o}:`,s)}}),d.debug(`Broadcast to ${r}/${this.connections.size} guests`),r}sendToGuest(t,n){if(!this.isHost)return d.warn("Only host can send to specific guest"),!1;const r=this.connections.get(t);if(!r)return d.error(`[sendToGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!r.open)return d.error(`[sendToGuest] Connection for guest ${t} is not open`),!1;try{return r.send(n),d.debug(`Sent message to guest ${t}`),!0}catch(a){return d.error(`[sendToGuest] Failed to send message to ${t}:`,a),!1}}acceptGuest(t,n,r){var o;const a=this.connections.get(t);if(!a){d.error(`[acceptGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!a.open){d.error(`[acceptGuest] Connection for guest ${t} is not open`);return}try{if(Yo){const s=$n(n,null),c={type:"JOIN_ACCEPT_BINARY",senderId:(o=this.peer)==null?void 0:o.id,playerId:r,data:s,timestamp:Date.now()};a.send(c),d.info(`Accepted guest ${t} as player ${r} (BINARY, ${s.byteLength} bytes)`)}}catch(s){d.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${t}:`,s)}}acceptGuestMinimal(t,n,r){var s;const a=this.connections.get(t);if(!a){d.error(`[acceptGuestMinimal] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!a.open){d.error(`[acceptGuestMinimal] Connection for guest ${t} is not open`);return}this.guestPlayerIds.set(t,r);const o={type:"JOIN_ACCEPT_MINIMAL",senderId:(s=this.peer)==null?void 0:s.id,playerId:r,data:n,timestamp:Date.now()};try{a.send(o),d.info(`Accepted guest ${t} as player ${r} (minimal)`)}catch(c){d.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${t}:`,c)}}broadcastGameState(t,n){let r=0;this.connections.forEach((a,o)=>{var m;if(!a.open||o===n)return;const s=this.guestPlayerIds.get(o)??null,c=Et.createPersonalizedGameState(t,s),u={type:"STATE_UPDATE_COMPACT",senderId:(m=this.peer)==null?void 0:m.id,data:{gameState:c,recipientPlayerId:s},timestamp:Date.now()};try{a.send(u),r++}catch(f){d.error(`[broadcastGameState] Failed to send to guest ${o} (player ${s}):`,f)}}),d.debug(`[broadcastGameState] Sent to ${r}/${this.connections.size} guests`)}static createPersonalizedGameState(t,n){return{...t,players:t.players.map(r=>{if(n!==null&&r.id===n){const o=r.deck.length??0,s=r.discard.length??0,c=r.hand.length??0,u=r.hand[0],m=r.deck[0];return d.info(`[createPersonalizedGameState] Player ${r.id} (own): sending ${c} hand cards, ${o} deck cards, ${s} discard cards`),u&&d.info(`[createPersonalizedGameState] First hand card: id=${u.id}, baseId=${u.baseId}, name=${u.name}`),m&&d.info(`[createPersonalizedGameState] First deck card: id=${m.id}, baseId=${m.baseId}, name=${m.name}`),{...r,handCards:r.hand.map(f=>({id:f.id,baseId:f.baseId,power:f.power,powerModifier:f.powerModifier,isFaceDown:f.isFaceDown,statuses:f.statuses||[]})),deckCards:r.deck.map(f=>({id:f.id,baseId:f.baseId,power:f.power,powerModifier:f.powerModifier,isFaceDown:f.isFaceDown,statuses:f.statuses||[]})),discardCards:r.discard.map(f=>({id:f.id,baseId:f.baseId,power:f.power,powerModifier:f.powerModifier,isFaceDown:f.isFaceDown,statuses:f.statuses||[]})),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?Et.optimizeCard(r.announcedCard):null,deckSize:o,discardSize:s,handSize:c}}else{const o=r.deckSize??r.deck.length??0;d.debug(`[createPersonalizedGameState] Player ${r.id} (other): deckSize=${o}, deck.length=${r.deck.length}`);const s=r.hand.filter(c=>!c.isFaceDown).length;return s>0&&d.info(`[createPersonalizedGameState] Player ${r.id} (other): sending ${s} revealed cards, ${r.hand.length-s} face-down`),{...r,hand:r.hand.map(c=>c.isFaceDown?Et.createCardBack(c):{id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier||0,isFaceDown:c.isFaceDown,statuses:c.statuses||[],ownerId:c.ownerId,ownerName:c.ownerName,deck:c.deck}),deck:[],discard:[],announcedCard:r.announcedCard?Et.createCardBack(r.announcedCard):null,deckSize:o,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}}}),board:t.board.map(r=>r.map(a=>({...a,card:a.card?Et.optimizeCard(a.card):null})))}}static createCompactStateForHost(t,n){return{...t,players:t.players.map(r=>r.id===n?(d.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(a=>({id:a.id,baseId:a.baseId,power:a.power,powerModifier:a.powerModifier,isFaceDown:a.isFaceDown,statuses:a.statuses||[]})),deckCards:r.deck.map(a=>({id:a.id,baseId:a.baseId,power:a.power,powerModifier:a.powerModifier,isFaceDown:a.isFaceDown,statuses:a.statuses||[]})),discardCards:r.discard.map(a=>({id:a.id,baseId:a.baseId,power:a.power,powerModifier:a.powerModifier,isFaceDown:a.isFaceDown,statuses:a.statuses||[]})),hand:[],deck:[],discard:[],handSize:r.hand.length,deckSize:r.deck.length,discardSize:r.discard.length}):{...r,hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}),board:t.board.map(r=>r.map(a=>({...a,card:a.card?Et.optimizeCard(a.card):null})))}}static optimizeCard(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier,ability:t.ability,ownerId:t.ownerId,color:t.color,deck:t.deck,isFaceDown:t.isFaceDown,types:t.types,faction:t.faction,statuses:t.statuses||[],hasRevealToken:t.hasRevealToken||!1,imageUrl:t.imageUrl}}static createCardBack(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,hasRevealToken:t.hasRevealToken||!1,statuses:t.statuses||[]}}broadcastStateDelta(t,n){var r,a;{const o=Uo(t),s={type:"STATE_DELTA_BINARY",senderId:(r=this.peer)==null?void 0:r.id,data:o,timestamp:Date.now()};d.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${o.length} chars, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, boardCells=${((a=t.boardCells)==null?void 0:a.length)||0}`),this.broadcastToGuests(s,n),d.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${t.sourcePlayerId} to ${this.connections.size} guests`)}}sendCardRegistry(t){var r;const n=this.connections.get(t);if(!n||!n.open)return d.error(`[sendCardRegistry] No valid connection for ${t}`),!1;try{const a=Jn(),o=vo(a),s=btoa(String.fromCharCode(...o)),c={type:"CARD_REGISTRY",senderId:(r=this.peer)==null?void 0:r.id,data:s,timestamp:Date.now()};return n.send(c),d.info(`[sendCardRegistry] Sent card registry to ${t}: ${o.length} bytes`),!0}catch(a){return d.error(`[sendCardRegistry] Failed to send registry to ${t}:`,a),!1}}broadcastCardState(t,n,r){var a;try{const o=$n(t,n),s=btoa(String.fromCharCode(...o)),c={type:"CARD_STATE",senderId:(a=this.peer)==null?void 0:a.id,data:s,timestamp:Date.now()},u=this.broadcastToGuests(c,r);return d.info(`[broadcastCardState] Sent ${o.length} bytes to ${u} guests`),u}catch(o){return d.error("[broadcastCardState] Failed to encode/broadcast state:",o),0}}broadcastAbilityEffect(t,n,r){var a;try{const o=Ho(t,n),s=btoa(String.fromCharCode(...o)),c={type:"ABILITY_EFFECT",senderId:(a=this.peer)==null?void 0:a.id,data:s,timestamp:Date.now()},u=this.broadcastToGuests(c,r);return d.debug(`[broadcastAbilityEffect] Sent effect ${t} to ${u} guests`),u}catch(o){return d.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",o),0}}broadcastSessionEvent(t,n,r){var a;try{const o=Wo(t,n),s=btoa(String.fromCharCode(...o)),c={type:"SESSION_EVENT",senderId:(a=this.peer)==null?void 0:a.id,data:s,timestamp:Date.now()},u=this.broadcastToGuests(c,r);return d.debug(`[broadcastSessionEvent] Sent event ${t} to ${u} guests`),u}catch(o){return d.error("[broadcastSessionEvent] Failed to encode/broadcast event:",o),0}}sendAction(t,n){var a;const r={type:"ACTION",senderId:(a=this.peer)==null?void 0:a.id,data:{actionType:t,actionData:n},timestamp:Date.now()};return this.sendMessageToHost(r)}sendStateDelta(t){var n;{const r=ta(t),a={type:"STATE_DELTA_BINARY",senderId:(n=this.peer)==null?void 0:n.id,data:r,timestamp:Date.now()};return this.sendMessageToHost(a)}}sendStateToHost(t,n){var s,c,u;if(n===null)return d.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const r=Et.createCompactStateForHost(t,n),a=t.players.find(m=>m.id===n);a&&d.info(`[sendStateToHost] Player ${n} sending compact state: hand=${((s=a.hand)==null?void 0:s.length)??0}, deck=${((c=a.deck)==null?void 0:c.length)??0}`);const o={type:"STATE_UPDATE_COMPACT",senderId:(u=this.peer)==null?void 0:u.id,playerId:n,data:{gameState:r},timestamp:Date.now()};return this.sendMessageToHost(o)}sendFullDeckToHost(t,n,r){var o;const a={type:"DECK_DATA_UPDATE",senderId:(o=this.peer)==null?void 0:o.id,playerId:t,data:{playerId:t,deck:n.map(s=>Et.optimizeCard(s)),deckSize:r},timestamp:Date.now()};return this.sendMessageToHost(a)}sendCustomDeckData(t,n,r){var s;if(!r)return!0;d.info(`[sendCustomDeckData] Player ${t} sending ${n.length} custom deck cards to host`);const a=n.map(c=>({id:c.id,baseId:c.baseId,name:c.name,power:c.power,powerModifier:c.powerModifier,ability:c.ability,types:c.types,faction:c.faction,imageUrl:c.imageUrl,color:c.color,deck:c.deck})),o={type:"CUSTOM_DECK_DATA",senderId:(s=this.peer)==null?void 0:s.id,playerId:t,data:{playerId:t,deckCards:a},timestamp:Date.now()};return this.sendMessageToHost(o)}getConnectionInfo(){const t=[];return this.isHost?this.connections.forEach((n,r)=>{t.push({peerId:r,playerId:null,playerName:null,connected:n.open})}):this.hostConnection&&t.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),t}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getHostPeerId(){var t,n;return this.isHost?((t=this.peer)==null?void 0:t.id)||null:((n=this.hostConnection)==null?void 0:n.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var t;return this.isHost?this.connections.size:(t=this.hostConnection)!=null&&t.open?1:0}on(t){return this.eventHandlers.add(t),()=>this.eventHandlers.delete(t)}emitEvent(t){this.eventHandlers.forEach(n=>{try{n(t)}catch(r){d.error("Error in WebRTC event handler:",r)}})}cleanup(){this.connections.forEach(t=>t.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let _r=null;const zo=()=>(_r||(_r=new Et),_r);function Ko(e){return 10+e*10}function Lr(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const t=e.currentPhase===1,n=e.activePlayerId===e.startingPlayerId;if(!t||!n)return{shouldEnd:!1,roundWinners:[]};const r=e.currentRound||1,a=Ko(r),o=[];for(const c of e.players)!c.isDummy&&!c.isDisconnected&&c.score>=a&&o.push(c.id);return{shouldEnd:o.length>0,roundWinners:o}}function na(e){const{shouldEnd:t,roundWinners:n}=Lr(e);if(!t)return e;const r=e.currentRound||1,a={...e.roundWinners,[r]:n},o=new Map;for(const[,c]of Object.entries(a))for(const u of c){const m=o.get(u)||0;o.set(u,m+1)}let s=null;for(const[c,u]of o.entries())if(u>=2){s=c;break}return d.info(`[endRound] Round ${r} ended. Winners: [${n.join(", ")}], Game winner: ${s||"none"}`),{...e,roundWinners:a,gameWinner:s,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function Mr(e,t){if(e.currentPhase!==0)return d.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const n=e.players.find(o=>o.id===t);if(!n)return d.error(`[performPreparationPhase] Active player ${t} not found!`),e;d.info(`[performPreparationPhase] Player ${t} has deck size: ${n.deck.length}, hand size: ${n.hand.length}`);const r=e.players.map(o=>{if(o.id===t&&o.deck.length>0){const s=o.deck[0],c=[...o.deck.slice(1)],u=[...o.hand,s];return d.info(`[performPreparationPhase] Player ${t} drew card ${(s==null?void 0:s.id)||"unknown"}, deck now: ${c.length}, hand: ${u.length}`),{...o,deck:c,hand:u,readySetup:!1,readyCommit:!1}}return o}),a={...e,players:r,currentPhase:1};return Lr(a).shouldEnd?na(a):(d.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${a.activePlayerId}`),a)}function aa(e,t){const n=e.activePlayerId;if(n===t){const c={...e,activePlayerId:null};return t===e.startingPlayerId&&e.currentPhase===1&&Lr(c).shouldEnd?na(c):c}if(!e.players.filter(c=>!c.isDisconnected).find(c=>c.id===t))return d.warn(`[toggleActivePlayer] Player ${t} not found or disconnected`),e;let o=e.turnNumber||1;t===e.startingPlayerId&&n!==null&&o++;const s={...e,activePlayerId:t,turnNumber:o,currentPhase:0};return Mr(s,t)}function qo(e,t){const n=e.players.filter(o=>!o.isDisconnected).sort((o,s)=>o.id-s.id);if(n.length===0)return null;if(t===null)return n[0].id;const r=n.findIndex(o=>o.id===t);if(r===-1)return n[0].id;const a=(r+1)%n.length;return n[a].id}function jo(e,t){var n;for(const r of e.board)for(const a of r)if(((n=a.card)==null?void 0:n.ownerId)===t)return!0;return!1}function ir(e){const t=qo(e,e.activePlayerId);if(t===null)return d.warn("[passTurnToNextPlayer] No next player found"),e;d.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${t}`);let n={...e,board:e.board.map(r=>r.map(a=>{var o;return((o=a.card)==null?void 0:o.ownerId)===e.activePlayerId&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(s=>s.type!=="Stun")}}:a}))};return n={...n,board:n.board.map(r=>r.map(a=>a.card&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(o=>o.type!=="enteredThisTurn")}}:a))},n={...n,activePlayerId:t,currentPhase:0,isScoringStep:!1},Mr(n,t)}function Cr(e,t,n){return d.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),e}function Vo(e,t){return{type:"RECONNECT_SNAPSHOT",data:e}}function Jo(e,t,n){var r,a,o,s;try{const c=Go(e,n);d.info(`[WebRTCCodec] Received card state: ${(r=c.board)==null?void 0:r.length}x${((o=(a=c.board)==null?void 0:a[0])==null?void 0:o.length)||0}, ${((s=c.players)==null?void 0:s.length)||0} players`);const u={...t};return c.players&&(u.players=c.players.map(m=>{const f=t.players.find(v=>v.id===m.id);if(f){const v=m.id===n;return{...f,...m,hand:v?f.hand:m.hand}}return m})),c.board&&(u.board=c.board),c.currentPhase!==void 0&&(u.currentPhase=c.currentPhase),c.activePlayerId!==void 0&&(u.activePlayerId=c.activePlayerId),c.currentRound!==void 0&&(u.currentRound=c.currentRound),u}catch(c){return d.error("[WebRTCCodec] Failed to deserialize card state:",c),t}}function Xo(e,t){try{const{effectType:n,timestamp:r,data:a}=Fo(e);d.debug(`[WebRTCCodec] Received ability effect: ${n}`);let o=t;switch(n){case 1:return{gameState:o,effectData:{type:"highlight",...a,timestamp:r}};case 2:return{gameState:o,effectData:{type:"floatingText",...a,timestamp:r}};case 3:return{gameState:o,effectData:{type:"noTarget",...a}};case 8:return{gameState:o,effectData:{type:"targetingMode",...a}};case 9:return{gameState:o,effectData:{type:"clearTargeting"}};default:return d.warn(`[WebRTCCodec] Unknown ability effect type: ${n}`),{gameState:o,effectData:null}}}catch(n){return d.error("[WebRTCCodec] Failed to handle ability effect:",n),{gameState:t,effectData:null}}}function Zo(e,t){var n;try{const{eventType:r,data:a}=Bo(e);d.info(`[WebRTCCodec] Received session event: ${r}`);const o={...t};switch(r){case 1:d.info(`[WebRTCCodec] Player connected: ${a.playerName} (ID: ${a.playerId})`);break;case 2:d.info(`[WebRTCCodec] Player disconnected: ID: ${a.playerId}`),o.players=o.players.map(s=>s.id===a.playerId?{...s,isDisconnected:!0}:s);break;case 3:d.info(`[WebRTCCodec] Game starting, first player: ${a.startingPlayerId}`),o.isGameStarted=!0,a.startingPlayerId!==void 0&&(o.activePlayerId=a.startingPlayerId,o.startingPlayerId=a.startingPlayerId);break;case 4:d.info(`[WebRTCCodec] Round ${a.roundNumber} starting`),o.currentRound=a.roundNumber??1;break;case 5:if(d.info(`[WebRTCCodec] Round ${a.roundNumber} ended, winners: ${(n=a.winners)==null?void 0:n.join(", ")}`),o.isRoundEndModalOpen=!0,a.winners&&a.roundNumber!==void 0){const s=o.roundWinners||{};s[a.roundNumber]=a.winners,o.roundWinners=s}break;case 6:d.info(`[WebRTCCodec] Phase change: ${a.newPhase}`),a.newPhase!==void 0&&(o.currentPhase=a.newPhase),a.newActivePlayerId!==void 0&&(o.activePlayerId=a.newActivePlayerId);break;case 7:d.info(`[WebRTCCodec] Turn change: player ${a.newActivePlayerId}`),a.newActivePlayerId!==void 0&&(o.activePlayerId=a.newActivePlayerId);break;case 8:d.info(`[WebRTCCodec] Game ended, winner: ${a.gameWinner}`),a.gameWinner!==void 0&&(o.gameWinner=a.gameWinner===255?null:a.gameWinner);break;default:d.warn(`[WebRTCCodec] Unknown session event type: ${r}`)}return o}catch(r){return d.error("[WebRTCCodec] Failed to handle session event:",r),t}}function Mt(e,t,n,r){return e===2?{gameState:Jo(t,n,r)}:e===3?Xo(t,n):e===4?{gameState:Zo(t,n)}:(d.warn(`[WebRTCCodec] Unknown codec message type: ${e}`),{gameState:n})}const dr="avalon_game_state",Ot="reconnection_data";function oa(e,t){var r;e.forEach(a=>a.forEach(o=>{var s;(s=o.card)!=null&&s.statuses&&(o.card.statuses=o.card.statuses.filter(c=>!(c.type==="LastPlayed"&&c.addedByPlayerId===t.id)))})),t.boardHistory||(t.boardHistory=[]);let n=!1;for(;t.boardHistory.length>0&&!n;){const a=t.boardHistory[t.boardHistory.length-1];for(let o=0;o<e.length;o++){for(let s=0;s<e[o].length;s++)if(((r=e[o][s].card)==null?void 0:r.id)===a){const c=e[o][s].card;if(!c||c.ownerId!==t.id)continue;c.statuses||(c.statuses=[]),c.statuses.push({type:"LastPlayed",addedByPlayerId:t.id}),n=!0;break}if(n)break}n||t.boardHistory.pop()}}function Ft(e){var r;if(!e||!It)return e;const{cardDatabase:t,tokenDatabase:n}=It;if(e.deck===Ke.Tokens||(r=e.id)!=null&&r.startsWith("TKN_")){if(e.baseId&&n[e.baseId]){const o=n[e.baseId];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage}}const a=Object.keys(n).find(o=>n[o].name===e.name);if(a){const o=n[a];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage,baseId:a}}}else if(e.baseId&&t[e.baseId]){const a=t[e.baseId];return{...e,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage}}return e}function qt(e){var r,a;if(!It)return e;const t=((r=e.board)==null?void 0:r.map(o=>o.map(s=>({...s,card:s.card?Ft(s.card):null}))))||e.board,n=((a=e.players)==null?void 0:a.map(o=>{var s,c,u;return{...o,hand:((s=o.hand)==null?void 0:s.map(Ft))||[],deck:((c=o.deck)==null?void 0:c.map(Ft))||[],discard:((u=o.discard)==null?void 0:u.map(Ft))||[],announcedCard:o.announcedCard?Ft(o.announcedCard):null}}))||e.players;return{...e,board:t,players:n,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}}function Hn(e,t,n){try{const r=qt(e),a={gameState:r,localPlayerId:t,playerToken:n,timestamp:Date.now()};localStorage.setItem(dr,JSON.stringify(a)),r.gameId&&t!==null&&localStorage.setItem(Ot,JSON.stringify({gameId:r.gameId,playerId:t,playerToken:n||null,timestamp:Date.now()}))}catch(r){console.warn("Failed to save game state:",r)}}function Qo(){try{const e=localStorage.getItem(dr);if(!e)return null;const t=JSON.parse(e),n=24*60*60*1e3;if(Date.now()-t.timestamp>n)return localStorage.removeItem(dr),localStorage.removeItem(Ot),null;const r=t.gameState;return{gameState:qt(r),localPlayerId:t.localPlayerId,playerToken:t.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}}function Ut(){localStorage.removeItem(dr),localStorage.removeItem(Ot)}function Gr(e){const t=[...e];for(let n=t.length-1;n>0;n--){const r=Math.floor(Math.random()*(n+1));[t[n],t[r]]=[t[r],t[n]]}return t}function sa(){return Math.random().toString(36).substring(2,18).toUpperCase()}function bt(e,t,n){const r=zn();let a=e;if(e==="Random"||!r[e]){const c=Object.keys(r);if(c.length===0)return console.error("[createDeck] No decks loaded yet!"),[];a=c[0],e==="Random"?console.log(`[createDeck] Random deck selected, using ${a} instead`):console.warn(`[createDeck] Deck ${e} not found, using ${a} instead`)}const o=r[a];if(!o)return console.error(`Deck data for ${a} not loaded! Returning empty deck. Available decks:`,Object.keys(r)),[];const s=[...o].map(c=>({...c,ownerId:t,ownerName:n}));return Gr(s)}function ia(e,t=!1){const n=zn(),r=Object.keys(n);if(r.length===0)return console.error("[createNewPlayer] No decks loaded yet!"),{id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:sr[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};const a=r[0],o={id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:a,color:sr[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};return o.deck=bt(a,e,o.name),o}function Rt(){return{players:[],spectators:[],board:Vn(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:Or.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}function es(){const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return d.warn("No custom WebSocket URL configured in settings."),null;let t=e.trim();return t.endsWith("/")&&(t=t.slice(0,-1)),t.startsWith("https://")?t=t.replace("https://","wss://"):t.startsWith("http://")&&(t=t.replace("http://","ws://")),!t.startsWith("ws://")&&!t.startsWith("wss://")?(d.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",t),t)}const Fn=-1,ts=-2,Wt=1,nr=2,Pt=(e,t,n,r)=>{var c,u,m,f,v;const{card:a,ownerId:o,location:s}=e;if(t.targetOwnerId!==void 0&&t.targetOwnerId!==Fn&&t.targetOwnerId!==ts&&t.targetOwnerId!==o||t.excludeOwnerId!==void 0&&t.excludeOwnerId===o)return!1;if(t.onlyOpponents||t.targetOwnerId===Fn){if(o===n)return!1;const y=r.find(N=>N.id===n),A=r.find(N=>N.id===o);if(y&&A&&y.teamId!==void 0&&y.teamId===A.teamId)return!1}if(t.targetType&&!((c=a.types)!=null&&c.includes(t.targetType))||t.onlyFaceDown&&((u=a.statuses)!=null&&u.some(y=>y.type==="Revealed"&&y.addedByPlayerId===n)||s==="board"&&!a.isFaceDown)||t.tokenType==="Revealed"&&(m=a.statuses)!=null&&m.some(y=>y.type==="Revealed"&&y.addedByPlayerId===n)||t.requiredTargetStatus&&(!((f=a.statuses)!=null&&f.some(y=>y.type===t.requiredTargetStatus))||t.requireStatusFromSourceOwner&&n!==null&&!((v=a.statuses)==null?void 0:v.some(A=>A.type===t.requiredTargetStatus&&A.addedByPlayerId===n))))return!1;if(t.mustBeAdjacentToSource&&t.sourceCoords&&e.boardCoords){const{row:y,col:A}=t.sourceCoords,{row:N,col:_}=e.boardCoords;if(Math.abs(y-N)+Math.abs(A-_)!==Wt)return!1}if(t.mustBeInLineWithSource&&t.sourceCoords&&e.boardCoords){const{row:y,col:A}=t.sourceCoords,{row:N,col:_}=e.boardCoords;if(y!==N&&A!==_)return!1}if(t.maxDistanceFromSource!==void 0&&t.sourceCoords&&e.boardCoords){const{row:y,col:A}=t.sourceCoords,{row:N,col:_}=e.boardCoords;if(Math.max(Math.abs(y-N),Math.abs(A-_))>t.maxDistanceFromSource)return!1}if(t.maxOrthogonalDistance!==void 0&&t.sourceCoords&&e.boardCoords){const{row:y,col:A}=t.sourceCoords,{row:N,col:_}=e.boardCoords;if(Math.abs(y-N)+Math.abs(A-_)>t.maxOrthogonalDistance)return!1}return!0},cr=(e,t,n,r)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const a=[],o=t.board,s=o.length,c=t.activeGridSize,u=Math.floor((s-c)/2),m=u,f=u+c-1;if(e.type==="CREATE_STACK"){const _={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let E=m;E<=f;E++)for(let h=m;h<=f;h++){const P=o[E][h];P.card&&P.card.ownerId!==void 0&&Pt({card:P.card,ownerId:P.card.ownerId,location:"board",boardCoords:{row:E,col:h}},_,n,t.players)&&a.push({row:E,col:h})}return a}const{mode:v,payload:y,sourceCoords:A,contextCheck:N}=e;if(v==="REVEREND_DOUBLE_EXPLOIT"){for(let _=m;_<=f;_++)for(let E=m;E<=f;E++)o[_][E].card&&a.push({row:_,col:E});return a}if((v==="SELECT_TARGET"||v==="CENSOR_SWAP"||v==="ZEALOUS_WEAKEN"||v==="CENTURION_BUFF"||v==="SELECT_UNIT_FOR_MOVE")&&y.filter&&typeof y.filter=="function"){if(y.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||y.actionType==="LUCIUS_SETUP"||y.actionType==="SELECT_HAND_FOR_DEPLOY"||y.handOnly)return[];for(let _=m;_<=f;_++)for(let E=m;E<=f;E++){const h=o[_][E];let P=h.card&&y.filter(h.card,_,E);if(P&&N==="ADJACENT_TO_LAST_MOVE"&&(r!=null&&r.lastMovedCardCoords)){const{row:D,col:l}=r.lastMovedCardCoords;Math.abs(_-D)+Math.abs(E-l)===1||(P=!1)}P&&a.push({row:_,col:E})}}else if(v==="SELECT_TARGET"&&(y.actionType==="ENHANCED_INT_REVEAL"||y.actionType==="ENHANCED_INT_MOVE"))for(let _=m;_<=f;_++)for(let E=m;E<=f;E++)o[_][E].card&&a.push({row:_,col:E});else if(v==="PATROL_MOVE"&&A)for(let _=m;_<=f;_++)for(let E=m;E<=f;E++){const h=_===A.row||E===A.col,P=_===A.row&&E===A.col,D=!o[_][E].card;h&&(D||P)&&a.push({row:_,col:E})}else if(v==="RIOT_PUSH"&&A){const _=[{r:A.row-1,c:A.col},{r:A.row+1,c:A.col},{r:A.row,c:A.col-1},{r:A.row,c:A.col+1}],E=(h,P)=>h>=m&&h<=f&&P>=m&&P<=f;_.forEach(h=>{if(E(h.r,h.c)){const P=o[h.r][h.c].card;if(P&&P.ownerId!==n){const D=t.players.find(T=>T.id===n),l=t.players.find(T=>T.id===P.ownerId);if(!((D==null?void 0:D.teamId)!==void 0&&(l==null?void 0:l.teamId)!==void 0&&D.teamId===l.teamId)){const T=h.r-A.row,L=h.c-A.col,g=h.r+T,O=h.c+L;E(g,O)&&(o[g][O].card||a.push({row:h.r,col:h.c}))}}}})}else if(v==="RIOT_MOVE"&&y.vacatedCoords)a.push(y.vacatedCoords),A&&a.push(A);else if(v==="SWAP_POSITIONS"&&y.filter)for(let _=m;_<=f;_++)for(let E=m;E<=f;E++){const h=o[_][E];h.card&&y.filter(h.card,_,E)&&a.push({row:_,col:E})}else if((v==="TRANSFER_STATUS_SELECT"||v==="TRANSFER_ALL_STATUSES")&&y.filter)for(let _=m;_<=f;_++)for(let E=m;E<=f;E++){const h=o[_][E];h.card&&y.filter(h.card,_,E)&&a.push({row:_,col:E})}else if(v==="SPAWN_TOKEN"||v==="SELECT_CELL"||v==="IMMUNIS_RETRIEVE")for(let _=m;_<=f;_++)for(let E=m;E<=f;E++){const h=!o[_][E].card;if(v==="IMMUNIS_RETRIEVE"&&y.filter){h&&y.filter(_,E)&&a.push({row:_,col:E});continue}if(v==="SELECT_CELL"){if(y.moveFromHand){h&&a.push({row:_,col:E});continue}if(!A)continue;const P=_===A.row&&E===A.col,D=y.range==="global";let l=!1;if(D)l=!0;else if(y.range==="line")l=_===A.row||E===A.col;else if(y.range===nr){const b=Math.abs(_-A.row),T=Math.abs(E-A.col),L=b+T;if(L===Wt)l=!0;else if(L===nr){const g=[];b===nr&&T===0?g.push({r:(_+A.row)/2,c:E}):b===0&&T===nr?g.push({r:_,c:(E+A.col)/2}):b===Wt&&T===Wt&&(g.push({r:_,c:A.col}),g.push({r:A.row,c:E})),l=g.some(O=>O.r<0||O.r>=s||O.c<0||O.c>=s?!1:!o[O.r][O.c].card)}}else l=Math.abs(_-A.row)+Math.abs(E-A.col)===Wt;(h&&l||y.allowSelf&&P)&&a.push({row:_,col:E})}else if(v==="SPAWN_TOKEN"&&A){const P=Math.abs(_-A.row)+Math.abs(E-A.col)===1;h&&P&&a.push({row:_,col:E})}}else if(v==="REVEAL_ENEMY"&&y.filter)for(let _=m;_<=f;_++)for(let E=m;E<=f;E++){const h=o[_][E];h.card&&y.filter(h.card,_,E)&&a.push({row:_,col:E})}else if(v==="SELECT_LINE_START")for(let _=m;_<=f;_++)for(let E=m;E<=f;E++)a.push({row:_,col:E});else if(v==="SELECT_LINE_END"&&y.firstCoords){const{row:_,col:E}=y.firstCoords;for(let h=m;h<=f;h++)a.push({row:_,col:h});for(let h=m;h<=f;h++)a.push({row:h,col:E})}else if(v==="INTEGRATOR_LINE_SELECT"&&A){const{row:_,col:E}=A;for(let h=m;h<=f;h++)a.push({row:_,col:h});for(let h=m;h<=f;h++)a.push({row:h,col:E})}else if(v==="ZIUS_LINE_SELECT"&&A){const{row:_,col:E}=A;for(let h=m;h<=f;h++)a.push({row:_,col:h});for(let h=m;h<=f;h++)a.push({row:h,col:E})}else if(v==="IP_AGENT_THREAT_SCORING"&&A){const{row:_,col:E}=A;for(let h=m;h<=f;h++)a.push({row:_,col:h});for(let h=m;h<=f;h++)a.push({row:h,col:E})}else if(v==="SELECT_DIAGONAL")if(y.firstCoords){const{row:_,col:E}=y.firstCoords;for(let h=m;h<=f;h++)for(let P=m;P<=f;P++)Math.abs(h-_)===Math.abs(P-E)&&a.push({row:h,col:P})}else for(let _=m;_<=f;_++)for(let E=m;E<=f;E++)a.push({row:_,col:E});return a},ar=(e,t,n,r)=>{var o,s,c,u,m;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let f=0;f<t.board.length;f++)for(let v=0;v<t.board[f].length;v++)if(t.board[f][v].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((o=e.payload)!=null&&o.actionType)){const f=e.payload.actionType;if(f==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||f==="LUCIUS_SETUP"||f==="SELECT_HAND_FOR_DEPLOY"){const v=((s=e.sourceCard)==null?void 0:s.ownerId)||n;if(v!==null){const y=t.players.find(A=>A.id===v);if(y&&y.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(cr(e,t,n,r).length>0)return!0;if(e.tokenType==="Revealed"||(c=e.tokenType)!=null&&c.startsWith("Power"))for(const v of t.players)for(let y=0;y<v.hand.length;y++){const A={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(Pt({card:v.hand[y],ownerId:v.id,location:"hand"},A,n,t.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((u=e.payload)!=null&&u.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const f of t.players)if(f.hand.some(v=>e.payload.filter(v))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return cr(e,t,n,r).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((m=e.payload)!=null&&m.filter),!1)};function rs(e){const{ws:t,webrtcManager:n,gameStateRef:r,localPlayerIdRef:a,webrtcIsHostRef:o,setLatestHighlight:s,setLatestFloatingTexts:c,setLatestNoTarget:u,setLatestDeckSelections:m,setLatestHandCardSelections:f,setTargetSelectionEffects:v,setGameState:y}=e,A=$.useCallback(T=>{var g;const L={...T,timestamp:Date.now()};if(s(L),((g=t.current)==null?void 0:g.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:r.current.gameId,highlightData:L}));else if(n.current){const O={type:"HIGHLIGHT_TRIGGERED",senderId:n.current.getPeerId(),data:L,timestamp:Date.now()};o.current?n.current.broadcastToGuests(O):n.current.sendMessageToHost(O)}},[t,n,r,o,s]),N=$.useCallback(T=>{var S;const L=Array.isArray(T)?T:[T],g=Date.now(),O=L.map((k,Y)=>({...k,timestamp:g+Y}));if(c(O),((S=t.current)==null?void 0:S.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:r.current.gameId,batch:O}));else if(n.current){const k={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:n.current.getPeerId(),data:{batch:O},timestamp:Date.now()};o.current?n.current.broadcastToGuests(k):n.current.sendMessageToHost(k)}},[t,n,r,o,c]),_=$.useCallback(T=>{var g;const L=Date.now();if(u({coords:T,timestamp:L}),((g=t.current)==null?void 0:g.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:r.current.gameId,coords:T,timestamp:L}));else if(n.current){const O={type:"NO_TARGET_TRIGGERED",senderId:n.current.getPeerId(),data:{coords:T,timestamp:L},timestamp:Date.now()};o.current?n.current.broadcastToGuests(O):n.current.sendMessageToHost(O)}},[t,n,r,o,u]),E=$.useCallback((T,L)=>{var O;const g={playerId:T,selectedByPlayerId:L,timestamp:Date.now()};if(m(S=>[...S,g]),((O=t.current)==null?void 0:O.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:r.current.gameId,deckSelectionData:g}));else if(n.current){const S={type:"DECK_SELECTION_TRIGGERED",senderId:n.current.getPeerId(),data:g,timestamp:Date.now()};o.current?n.current.broadcastToGuests(S):n.current.sendMessageToHost(S)}setTimeout(()=>{m(S=>S.filter(k=>k.timestamp!==g.timestamp))},1e3)},[t,n,r,o,m]),h=$.useCallback((T,L,g)=>{var S;const O={playerId:T,cardIndex:L,selectedByPlayerId:g,timestamp:Date.now()};if(f(k=>[...k,O]),((S=t.current)==null?void 0:S.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:r.current.gameId,handCardSelectionData:O}));else if(n.current){const k={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:n.current.getPeerId(),data:O,timestamp:Date.now()};o.current?n.current.broadcastToGuests(k):n.current.sendMessageToHost(k)}setTimeout(()=>{f(k=>k.filter(Y=>Y.timestamp!==O.timestamp))},1e3)},[t,n,r,o,f]),P=$.useCallback(T=>{var L;if(((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"SYNC_VALID_TARGETS",gameId:r.current.gameId,playerId:a.current,...T}));else if(n.current){const g={type:"SYNC_VALID_TARGETS",senderId:n.current.getPeerId(),data:{playerId:a.current,...T},timestamp:Date.now()};o.current?n.current.broadcastToGuests(g):n.current.sendMessageToHost(g)}},[t,n,r,o,a]),D=$.useCallback((T,L,g)=>{var S;if(a.current===null)return;const O={timestamp:Date.now(),location:T,boardCoords:L,handTarget:g,selectedByPlayerId:a.current};if(v(k=>[...k,O]),((S=t.current)==null?void 0:S.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_TARGET_SELECTION",gameId:r.current.gameId,effect:O}));else if(n.current)if(o.current){const k={type:"TARGET_SELECTION_TRIGGERED",senderId:n.current.getPeerId(),data:O,timestamp:Date.now()};n.current.broadcastToGuests(k)}else{const k={type:"SET_TARGETING_MODE",senderId:n.current.getPeerId(),data:O,timestamp:Date.now()};n.current.sendMessageToHost(k)}setTimeout(()=>{v(k=>k.filter(Y=>Y.timestamp!==O.timestamp))},1e3)},[t,n,r,o,a,v]),l=$.useCallback((T,L,g,O,S)=>{var te;const k=r.current;if(!k||!k.board){console.warn("[setTargetingMode] No game state or board available");return}let Y;O?Y=O:g&&(Y=cr(T,k,L,S));const V={playerId:L,action:T,sourceCoords:g,timestamp:Date.now(),boardTargets:Y};if(y(ee=>({...ee,targetingMode:V})),((te=t.current)==null?void 0:te.readyState)===WebSocket.OPEN&&k.gameId)t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:k.gameId,targetingMode:V}));else if(n.current){const ee={type:"SET_TARGETING_MODE",senderId:n.current.getPeerId(),data:V,timestamp:Date.now()};o.current?n.current.broadcastToGuests(ee):n.current.sendMessageToHost(ee)}},[t,n,r,o,y]),b=$.useCallback(()=>{var L;const T=r.current;if(y(g=>({...g,targetingMode:null})),((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&(T!=null&&T.gameId))t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:T.gameId}));else if(n.current){const g={type:"CLEAR_TARGETING_MODE",senderId:n.current.getPeerId(),data:{},timestamp:Date.now()};o.current?n.current.broadcastToGuests(g):n.current.sendMessageToHost(g)}},[t,n,r,o,y]);return{triggerHighlight:A,triggerFloatingText:N,triggerNoTarget:_,triggerDeckSelection:E,triggerHandCardSelection:h,syncValidTargets:P,triggerTargetSelection:D,setTargetingMode:l,clearTargetingMode:b}}function ns(e){const{ws:t,webrtcManager:n,gameStateRef:r,webrtcIsHostRef:a,setGameState:o,updateState:s}=e,c=$.useCallback(y=>{var N;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&a.current){o(_=>{const E=_.players.map(h=>{let P=1;for(const[D,l]of Object.entries(y))if(l.includes(h.id)){P=parseInt(D);break}return{...h,teamId:P}});return{..._,players:E}}),n.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:n.current.getPeerId(),data:{assignments:y},timestamp:Date.now()});return}((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:r.current.gameId,assignments:y}))},[t,n,r,a,o]),u=$.useCallback(y=>{var N;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&a.current){o(_=>({..._,gameMode:y})),n.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:n.current.getPeerId(),data:{mode:y},timestamp:Date.now()});return}((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:r.current.gameId,mode:y}))},[t,n,r,a,o]),m=$.useCallback(y=>{var N;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&a.current){o(_=>({..._,isPrivate:y})),n.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:n.current.getPeerId(),data:{isPrivate:y},timestamp:Date.now()});return}((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:r.current.gameId,isPrivate:y}))},[t,n,r,a,o]),f=$.useCallback(y=>{s(A=>{if(A.isGameStarted)return A;const N={...A,activeGridSize:y};if(A.board.length!==y){N.board=[];for(let E=0;E<y;E++){const h=[];for(let P=0;P<y;P++)h.push({card:null});N.board.push(h)}}return N})},[s]),v=$.useCallback(y=>{s(A=>{if(A.isGameStarted)return A;const N=A.players.filter(h=>!h.isDummy);if(N.length+y>Io)return A;const _=[...N],E=Math.max(...N.map(h=>h.id),0);for(let h=0;h<y;h++){const P=E+h+1,D=ia(P,!0);D.name=`Dummy ${h+1}`,_.push(D)}return{...A,players:_,dummyPlayerCount:y}})},[s]);return{assignTeams:c,setGameMode:u,setGamePrivacy:m,setActiveGridSize:f,setDummyPlayerCount:v}}function as(e){const{ws:t,webrtcManager:n,gameStateRef:r,localPlayerIdRef:a,webrtcIsHostRef:o,setGameState:s}=e,c=$.useCallback(()=>{var v;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&o.current){s(y=>({...y,isReadyCheckActive:!0,isPrivate:!0})),n.current.broadcastToGuests({type:"START_READY_CHECK",senderId:n.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:r.current.gameId}))},[t,n,r,o,s]),u=$.useCallback(()=>{var v;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&o.current){s(y=>({...y,isReadyCheckActive:!1})),n.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:n.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&r.current.gameId?t.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:r.current.gameId})):s(y=>({...y,isReadyCheckActive:!1}))},[t,n,r,o,s]),m=$.useCallback(()=>{var v;const f=localStorage.getItem("webrtc_enabled")==="true";if(f&&n.current&&o.current&&a.current!==null){s(y=>{const A=y.players.map(h=>h.id===a.current?{...h,isReady:!0}:h),N={...y,players:A},_=N.players.filter(h=>!h.isDummy&&!h.isDisconnected);if(_.length>0&&_.every(h=>h.isReady)&&N.isReadyCheckActive&&!N.isGameStarted){const h=N.players.filter(T=>!T.isDisconnected),P=Math.floor(Math.random()*h.length),D=h[P].id,l={...N};l.isReadyCheckActive=!1,l.isGameStarted=!0,l.startingPlayerId=D,l.activePlayerId=D,l.currentPhase=0,l.players=l.players.map(T=>{if(T.hand.length===0&&T.deck.length>0){const g=[...T.hand],O=[...T.deck];for(let S=0;S<6&&S<O.length;S++){const k=O[0];O.splice(0,1),g.push(k)}return d.info(`[playerReady] Drew initial ${g.length} cards for player ${T.id}`),{...T,hand:g,deck:O}}return T});const b=l.players.find(T=>T.id===D);if(b&&b.deck.length>0){const T=b.deck[0],L=[...b.deck.slice(1)],g=[...b.hand,T];l.players=l.players.map(O=>O.id===D?{...O,deck:L,hand:g,readySetup:!1,readyCommit:!1}:O),l.currentPhase=1}return n.current.broadcastGameState(l),n.current.broadcastToGuests({type:"GAME_START",senderId:n.current.getPeerId(),data:{startingPlayerId:D,activePlayerId:D,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),l}return n.current.broadcastToGuests({type:"HOST_READY",senderId:n.current.getPeerId(),playerId:a.current??void 0,timestamp:Date.now()}),N});return}if(f&&n.current&&!o.current&&a.current!==null){n.current.sendMessageToHost({type:"PLAYER_READY",senderId:n.current.getPeerId(),playerId:a.current,timestamp:Date.now()}),s(y=>({...y,players:y.players.map(A=>A.id===a.current?{...A,isReady:!0}:A)}));return}((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&r.current.gameId&&a.current!==null&&t.current.send(JSON.stringify({type:"PLAYER_READY",gameId:r.current.gameId,playerId:a.current}))},[t,n,r,a,o,s]);return{startReadyCheck:c,cancelReadyCheck:u,playerReady:m}}function os(e){const{updateState:t}=e,n=$.useCallback((a,o)=>{t(s=>s.isGameStarted?s:{...s,players:s.players.map(c=>c.id===a?{...c,name:o}:c)})},[t]),r=$.useCallback((a,o)=>{t(s=>({...s,players:s.players.map(c=>c.id===a?{...c,color:o}:c)}))},[t]);return{updatePlayerName:n,changePlayerColor:r}}function ss(e){const{updateState:t}=e,n=$.useCallback(c=>{t(u=>{if(!u.isGameStarted)return u;const m=u.players.find(A=>A.id===c);if(!m||m.deck.length===0)return u;const f=Ue(u),v=f.players.find(A=>A.id===c),y=v.deck.shift();return y&&v.hand.push(y),f})},[t]),r=$.useCallback((c,u)=>{u<=0||t(m=>{if(!m.isGameStarted)return m;const f=m.players.find(N=>N.id===c);if(!f||f.deck.length===0)return m;const v=Ue(m),y=v.players.find(N=>N.id===c),A=Math.min(u,y.deck.length);for(let N=0;N<A;N++){const _=y.deck.shift();_&&y.hand.push(_)}return v})},[t]),a=$.useCallback(c=>{t(u=>{if(!u.isGameStarted||!u.players.find(y=>y.id===c))return u;const f=Ue(u),v=f.players.find(y=>y.id===c);return v.deck=Gr([...v.deck]),f})},[t]),o=$.useCallback(c=>{t(u=>{if(!u.isGameStarted)return u;const m={...u},f=m.board[c.row][c.col].card;return f&&(f.isFaceDown=!1),{...m,board:ot(m)}})},[t]),s=$.useCallback(c=>{t(u=>{if(!u.isGameStarted)return u;const m={...u},f=m.board[c.row][c.col].card;return f&&(f.isFaceDown=!0),{...m,board:ot(m)}})},[t]);return{drawCard:n,drawCardsBatch:r,shufflePlayerDeck:a,flipBoardCard:o,flipBoardCardFaceDown:s}}function is(e){const{localPlayerIdRef:t,updateState:n}=e,r=$.useCallback((h,P,D)=>{n(l=>{var L,g;if(!l.isGameStarted)return l;const b=Ue(l),T=b.board[h.row][h.col].card;if(T){if(P==="Stun"&&(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius")&&((L=T.types)!=null&&L.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(P)&&((g=T.statuses)==null?void 0:g.some(S=>S.type===P&&S.addedByPlayerId===D)))return l;T.statuses||(T.statuses=[]),T.statuses.push({type:P,addedByPlayerId:D})}return b})},[n]),a=$.useCallback((h,P)=>{n(D=>{if(!D.isGameStarted)return D;const l=Ue(D),b=l.board[h.row][h.col].card;if(b!=null&&b.statuses){const T=b.statuses.map(L=>L.type).lastIndexOf(P);T>-1&&b.statuses.splice(T,1)}return l.board=ot(l),l})},[n]),o=$.useCallback((h,P,D)=>{n(l=>{if(!l.isGameStarted)return l;const b=Ue(l),T=b.board[h.row][h.col].card;if(T!=null&&T.statuses){const L=T.statuses.findIndex(g=>g.type===P&&g.addedByPlayerId===D);L>-1&&T.statuses.splice(L,1)}return b.board=ot(b),b})},[n]),s=$.useCallback((h,P)=>{n(D=>{if(!D.isGameStarted)return D;const l=Ue(D),b=l.board[h.row][h.col].card;return b&&(b.powerModifier===void 0&&(b.powerModifier=0),b.powerModifier+=P),l})},[n]),c=$.useCallback((h,P,D)=>{n(l=>{var L;if(!l.isGameStarted)return l;const b=Ue(l),T=b.players.find(g=>g.id===h);if(T!=null&&T.announcedCard){if(["Support","Threat","Revealed"].includes(P)&&((L=T.announcedCard.statuses)==null?void 0:L.some(O=>O.type===P&&O.addedByPlayerId===D)))return l;T.announcedCard.statuses||(T.announcedCard.statuses=[]),T.announcedCard.statuses.push({type:P,addedByPlayerId:D})}return b})},[n]),u=$.useCallback((h,P)=>{n(D=>{var T;if(!D.isGameStarted)return D;const l=Ue(D),b=l.players.find(L=>L.id===h);if((T=b==null?void 0:b.announcedCard)!=null&&T.statuses){const L=b.announcedCard.statuses.map(g=>g.type).lastIndexOf(P);L>-1&&b.announcedCard.statuses.splice(L,1)}return l})},[n]),m=$.useCallback((h,P)=>{n(D=>{if(!D.isGameStarted)return D;const l=Ue(D),b=l.players.find(T=>T.id===h);return b!=null&&b.announcedCard&&(b.announcedCard.powerModifier===void 0&&(b.announcedCard.powerModifier=0),b.announcedCard.powerModifier+=P),l})},[n]),f=$.useCallback((h,P,D,l)=>{n(b=>{var g;if(!b.isGameStarted)return b;const T=Ue(b),L=T.players.find(O=>O.id===h);if(L!=null&&L.hand[P]){const O=L.hand[P];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(D)&&((g=O.statuses)==null?void 0:g.some(k=>k.type===D&&k.addedByPlayerId===l)))return b;O.statuses||(O.statuses=[]),O.statuses.push({type:D,addedByPlayerId:l})}return T})},[n]),v=$.useCallback((h,P,D)=>{n(l=>{if(!l.isGameStarted)return l;const b=Ue(l),T=b.players.find(g=>g.id===h),L=T==null?void 0:T.hand[P];if(L!=null&&L.statuses){const g=L.statuses.map(O=>O.type).lastIndexOf(D);g>-1&&L.statuses.splice(g,1),D==="Revealed"&&(L.statuses.some(S=>S.type==="Revealed")||delete L.revealedTo)}return b})},[n]),y=$.useCallback((h,P,D)=>{n(l=>{const b=l.players.find(g=>g.id===h);if(!(b!=null&&b.hand[P]))return l;const T=Ue(l),L=T.players.find(g=>g.id===h).hand[P];if(D==="all")L.revealedTo="all",L.statuses||(L.statuses=[]),L.statuses.some(g=>g.type==="Revealed"&&g.addedByPlayerId===h)||L.statuses.push({type:"Revealed",addedByPlayerId:h});else{(!L.revealedTo||L.revealedTo==="all"||!Array.isArray(L.revealedTo))&&(L.revealedTo=[]);const g=D.filter(O=>!L.revealedTo.includes(O));L.revealedTo.push(...g)}return T})},[n]),A=$.useCallback((h,P)=>{n(D=>{if(!D.board[h.row][h.col].card)return D;const b=Ue(D),T=b.board[h.row][h.col].card,L=T.ownerId;if(P==="all")T.revealedTo="all",L!==void 0&&(T.statuses||(T.statuses=[]),T.statuses.some(g=>g.type==="Revealed"&&g.addedByPlayerId===L)||T.statuses.push({type:"Revealed",addedByPlayerId:L}));else{(!T.revealedTo||T.revealedTo==="all"||!Array.isArray(T.revealedTo))&&(T.revealedTo=[]);const g=P.filter(O=>!T.revealedTo.includes(O));T.revealedTo.push(...g)}return b})},[n]),N=$.useCallback((h,P)=>{n(D=>{var L;const l=h.boardCoords?(L=D.board[h.boardCoords.row][h.boardCoords.col].card)==null?void 0:L.ownerId:h.ownerId;if(!l)return D;const b=Ue(D),T=b.revealRequests.find(g=>g.fromPlayerId===P&&g.toPlayerId===l);return T?T.cardIdentifiers.some(O=>JSON.stringify(O)===JSON.stringify(h))||T.cardIdentifiers.push(h):b.revealRequests.push({fromPlayerId:P,toPlayerId:l,cardIdentifiers:[h]}),b})},[n]),_=$.useCallback((h,P)=>{n(D=>{const l=D.revealRequests.findIndex(L=>L.toPlayerId===t.current&&L.fromPlayerId===h);if(l===-1)return D;const b=Ue(D),T=b.revealRequests[l];if(P){const{cardIdentifiers:L}=T;for(const g of L){let O=null;if(g.source==="board"&&g.boardCoords)O=b.board[g.boardCoords.row][g.boardCoords.col].card;else if(g.source==="hand"&&g.ownerId&&g.cardIndex!==void 0){const S=b.players.find(k=>k.id===g.ownerId);S&&(O=S.hand[g.cardIndex])}O&&(O.statuses||(O.statuses=[]),O.statuses.some(S=>S.type==="Revealed"&&S.addedByPlayerId===h)||O.statuses.push({type:"Revealed",addedByPlayerId:h}))}}return b.revealRequests.splice(l,1),b})},[n,t]),E=$.useCallback(h=>{n(P=>{const D=Ue(P);let l=null;if(h.source==="board"&&h.boardCoords)l=D.board[h.boardCoords.row][h.boardCoords.col].card;else if(h.source==="hand"&&h.playerId&&h.cardIndex!==void 0){const b=D.players.find(T=>T.id===h.playerId);b&&(l=b.hand[h.cardIndex])}return l&&(l.statuses&&(l.statuses=l.statuses.filter(b=>b.type!=="Revealed")),delete l.revealedTo),D})},[n]);return{addBoardCardStatus:r,removeBoardCardStatus:a,removeBoardCardStatusByOwner:o,modifyBoardCardPower:s,addAnnouncedCardStatus:c,removeAnnouncedCardStatus:u,modifyAnnouncedCardPower:m,addHandCardStatus:f,removeHandCardStatus:v,revealHandCard:y,revealBoardCard:A,requestCardReveal:N,respondToRevealRequest:_,removeRevealedStatus:E}}function ds(e){const{webrtcIsHostRef:t,sendWebrtcAction:n,webrtcManagerRef:r,localPlayerIdRef:a,getCardDefinition:o,commandCardIds:s,createDeck:c,updateState:u}=e,m=$.useCallback((_,E)=>{const h=localStorage.getItem("webrtc_enabled")==="true";if(h&&!t.current)try{localStorage.setItem("webrtc_preferred_deck",E),d.info(`[changePlayerDeck] Saved deck preference: ${E}`)}catch(l){d.warn("[changePlayerDeck] Failed to save deck preference:",l)}const P=c(E,_,"Player "+_);if(u(l=>l.isGameStarted?l:{...l,players:l.players.map(b=>b.id===_?{...b,deck:P,selectedDeck:E,hand:[],discard:[],announcedCard:null,boardHistory:[]}:b)}),d.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${h}, isHost=${t.current}, hasSendAction=${!!n}, hasManager=${!!(r!=null&&r.current)}`),!h)return;const D=P.map(l=>({id:l.id,baseId:l.baseId,power:l.power,powerModifier:l.powerModifier||0,isFaceDown:l.isFaceDown||!1,statuses:l.statuses||[]}));t.current?r!=null&&r.current?(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:_,deckType:E,deck:D,deckSize:D.length}}),d.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${_}, deck ${E}, ${D.length} cards`)):d.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available"):n?(n("CHANGE_PLAYER_DECK",{playerId:_,deckType:E,deck:D,deckSize:D.length}),d.info(`[changePlayerDeck] Guest sending deck data to host: player ${_}, deck ${E}, ${D.length} cards`)):d.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[u,c,n,t,r,a]),f=$.useCallback((_,E)=>{const h=localStorage.getItem("webrtc_enabled")==="true";let P=[];const D=new Map;for(const{cardId:b,quantity:T}of E.cards){const L=o(b);if(!L)continue;const g=s.has(b),O=g?Ke.Command:Ke.Custom,S=g?"CMD":"CUS";for(let k=0;k<T;k++){const Y=(D.get(b)||0)+1;D.set(b,Y),P.push({...L,id:`${S}_${b.toUpperCase()}_${Y}`,baseId:b,deck:O,ownerId:_,ownerName:"Player "+_})}}if(P=Gr(P),u(b=>b.isGameStarted||!b.players.find(L=>L.id===_)?b:{...b,players:b.players.map(L=>L.id===_?{...L,deck:P,selectedDeck:Ke.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:L)}),!h)return;const l=P.map(b=>({id:b.id,baseId:b.baseId,power:b.power,powerModifier:b.powerModifier||0,isFaceDown:b.isFaceDown||!1,statuses:b.statuses||[]}));t.current?r!=null&&r.current&&(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:_,deckType:Ke.Custom,deck:l,deckSize:l.length}}),d.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${_}, ${l.length} cards`)):n&&(n("CHANGE_PLAYER_DECK",{playerId:_,deckType:Ke.Custom,deck:l,deckSize:l.length}),d.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${_}, ${l.length} cards`))},[u,o,s,n,t,r,a]),v=$.useCallback((_,E,h,P)=>{u(D=>{if(!D.isGameStarted||D.board[h.row][h.col].card!==null)return D;const l=Ue(D),b=l.players.find(T=>T.id===_);if(b&&b.discard.length>E){const[T]=b.discard.splice(E,1);T.enteredThisTurn=!0,kr(T,_),(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius"))&&(T.powerModifier===void 0&&(T.powerModifier=0),T.powerModifier+=2),T.statuses||(T.statuses=[]),T.statuses.push({type:"Resurrected",addedByPlayerId:_}),P&&P.forEach(L=>{var g;L.type!=="Resurrected"&&((g=T.statuses)==null||g.push({type:L.type,addedByPlayerId:_}))}),b.boardHistory||(b.boardHistory=[]),b.boardHistory.push(T.id),l.board[h.row][h.col].card=T,oa(l.board,b),l.board=ot(l)}return l})},[u]),y=$.useCallback((_,E)=>{u(h=>{const P=Ue(h),D=P.players.find(l=>l.id===_);if(D&&E.length>0){const l=new Set(E.map(T=>T.id)),b=D.deck.filter(T=>!l.has(T.id));D.deck=[...E,...b]}return P})},[u]),A=$.useCallback((_,E,h)=>{u(P=>{const D=Ue(P),l=D.players.find(b=>b.id===_);return l&&(h==="deck"?l.deck=E:h==="discard"&&(l.discard=E)),D})},[u]),N=$.useCallback((_,E)=>{u(h=>{if(!h.isGameStarted)return h;const P=Ue(h),D=P.players.find(l=>l.id===_);if(D&&D.discard.length>E){const[l]=D.discard.splice(E,1);D.hand.push(l)}return P})},[u]);return{changePlayerDeck:m,loadCustomDeck:f,resurrectDiscardedCard:v,reorderTopDeck:y,reorderCards:A,recoverDiscardedCard:N}}function cs(e){const{ws:t,webrtcManagerRef:n,webrtcIsHostRef:r,gameStateRef:a,scoreDeltaAccumulator:o,setGameState:s,updateState:c,abilityMode:u,setAbilityMode:m,createDeck:f}=e,v=$.useCallback(D=>{localStorage.getItem("webrtc_enabled")==="true"&&n.current?r.current?s(b=>{const T=aa(b,D);return n.current&&n.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:n.current.getPeerId(),data:{activePlayerId:T.activePlayerId,currentPhase:T.currentPhase,turnNumber:T.turnNumber},timestamp:Date.now()}),T}):n.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:D},timestamp:Date.now()}):t.current&&t.current.readyState===WebSocket.OPEN&&(o.forEach((b,T)=>{clearTimeout(b.timerId),d.info(`[ScoreFlush] Flushing on toggle: player=${T}, delta=${b.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:a.current.gameId,playerId:T,delta:b.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:a.current.gameId,playerId:D})))},[t,n,r,a,o,s]),y=$.useCallback((D,l)=>{t.current&&t.current.readyState===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:a.current.gameId,playerId:D,enabled:l}))},[]),A=$.useCallback(D=>{const l=u&&m&&u.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(u.mode);l&&m(null),c(b=>{if(!b.isGameStarted)return b;const T=Math.max(1,Math.min(D,4));return{...b,currentPhase:T,...T===4&&!l?{isScoringStep:!0}:{},...l?{isScoringStep:!1}:{}}})},[c,u,m]),N=$.useCallback(()=>{var b;u&&m&&u.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(u.mode)&&m(null);const D=a.current,l=localStorage.getItem("webrtc_enabled")==="true";if(D.isGameStarted&&D.currentPhase===4&&D.isScoringStep&&!l){((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&(o.forEach((T,L)=>{clearTimeout(T.timerId),d.info(`[ScoreFlush] Flushing pending score: player=${L}, delta=${T.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:D.gameId,playerId:L,delta:T.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:D.gameId})));return}if(l&&D.isGameStarted&&D.currentPhase===4&&D.isScoringStep){c(T=>ir(T));return}c(T=>{if(!T.isGameStarted)return T;const L=Ue(T),g=T.currentPhase+1;return T.preserveDeployAbilities||L.board.forEach(O=>{O.forEach(S=>{var k;(k=S.card)!=null&&k.statuses&&(S.card.statuses=S.card.statuses.filter(Y=>Y.type!=="readyDeploy"))})}),l&&g===4&&T.currentPhase===3?jo(T,T.activePlayerId)?(L.isScoringStep=!0,L.currentPhase=4,L):(d.info(`[nextPhase] Player ${T.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),ir(T)):g===4&&T.currentPhase===3?(L.isScoringStep=!0,L.currentPhase=4,L):(L.board.forEach(O=>{O.forEach(S=>{var k;if((k=S.card)!=null&&k.statuses){const Y=S.card.statuses.findIndex(V=>V.type==="Resurrected");if(Y!==-1){const V=S.card.statuses[Y].addedByPlayerId;S.card.statuses.splice(Y,1),S.card.baseId!=="luciusTheImmortal"&&(S.card.statuses.push({type:"Stun",addedByPlayerId:V}),S.card.statuses.push({type:"Stun",addedByPlayerId:V}))}}})}),L.board=ot(L),L.currentPhase=g,L)})},[c,u,m,a,t,o]),_=$.useCallback(()=>{c(D=>D.isGameStarted?(u&&m&&u.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(u.mode)&&m(null),D.isScoringStep?{...D,isScoringStep:!1,currentPhase:Math.max(1,D.currentPhase-1)}:{...D,currentPhase:Math.max(1,D.currentPhase-1)}):D)},[c,u,m]),E=$.useCallback(()=>{var l;localStorage.getItem("webrtc_enabled")==="true"?c(b=>({...b,isRoundEndModalOpen:!1,currentRound:(b.currentRound||1)+1,players:b.players.map(T=>({...T,score:0}))})):((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&a.current.gameId&&(s(b=>({...b,isRoundEndModalOpen:!1,currentRound:(b.currentRound||1)+1,players:b.players.map(T=>({...T,score:0}))})),t.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:a.current.gameId})))},[s,c,t,a]),h=$.useCallback(()=>{s(D=>({...D,isRoundEndModalOpen:!1}))},[s]),P=$.useCallback(()=>{var l;if(localStorage.getItem("webrtc_enabled")==="true"){const b=a.current,T=b.players.map(S=>{const k=S.selectedDeck||"SynchroTech";return{...S,hand:[],deck:f(k,S.id,S.name),discard:[],score:0,isReady:!1,announcedCard:null,boardHistory:[]}}),L=b.activeGridSize||8,g=[];for(let S=0;S<L;S++){const k=[];for(let Y=0;Y<L;Y++)k.push({card:null});g.push(k)}const O={...b,players:T,board:g,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};s(O),a.current=O,n.current&&n.current.broadcastToGuests({type:"GAME_RESET",senderId:n.current.getPeerId(),data:{players:T.map(S=>({id:S.id,name:S.name,color:S.color,selectedDeck:S.selectedDeck,isDummy:S.isDummy,isDisconnected:S.isDisconnected,autoDrawEnabled:S.autoDrawEnabled,handSize:S.hand.length,deckSize:S.deck.length,discardSize:S.discard.length,...S.isDummy&&{hand:S.hand.map(k=>({id:k.id,baseId:k.baseId,name:k.name,imageUrl:k.imageUrl,power:k.power,powerModifier:k.powerModifier,ability:k.ability,ownerId:k.ownerId,color:k.color,deck:k.deck,isFaceDown:k.isFaceDown,types:k.types,faction:k.faction,statuses:k.statuses})),deck:S.deck.map(k=>({id:k.id,baseId:k.baseId,name:k.name,imageUrl:k.imageUrl,power:k.power,powerModifier:k.powerModifier,ability:k.ability,ownerId:k.ownerId,color:k.color,deck:k.deck,isFaceDown:k.isFaceDown,types:k.types,faction:k.faction,statuses:k.statuses})),discard:S.discard.map(k=>({id:k.id,baseId:k.baseId,name:k.name,imageUrl:k.imageUrl,power:k.power,powerModifier:k.powerModifier,ability:k.ability,ownerId:k.ownerId,color:k.color,deck:k.deck,isFaceDown:k.isFaceDown,types:k.types,faction:k.faction,statuses:k.statuses}))},score:S.score,isReady:S.isReady,announcedCard:S.announcedCard})),gameMode:O.gameMode,isPrivate:O.isPrivate,activeGridSize:O.activeGridSize,dummyPlayerCount:O.dummyPlayerCount,autoAbilitiesEnabled:O.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"RESET_GAME",gameId:a.current.gameId}))},[t,n,a,s,f]);return{toggleActivePlayer:v,toggleAutoDraw:y,setPhase:A,nextPhase:N,prevPhase:_,closeRoundEndModal:E,closeRoundEndModalOnly:h,resetGame:P}}function ls(e){const{ws:t,gameStateRef:n,updateState:r,updatePlayerScore:a,triggerFloatingText:o}=e,s=$.useCallback((u,m,f,v,y)=>{var L,g;const A=n.current;if(!A.isGameStarted||A.isRoundEndModalOpen)return;const N=A.board.some(O=>O.some(S=>{var k,Y;return((k=S.card)==null?void 0:k.ownerId)===y&&S.card.name.toLowerCase().includes("data liberator")&&((Y=S.card.statuses)==null?void 0:Y.some(V=>V.type==="Support"))})),_=A.board.length;let E=u,h=u,P=m,D=m;if(u===f)E=u,h=u,P=0,D=_-1;else if(m===v)P=m,D=m,E=0,h=_-1;else return;let l=0;const b=[];for(let O=E;O<=h;O++)for(let S=P;S<=D;S++){const Y=A.board[O][S].card;if(Y&&!((L=Y.statuses)!=null&&L.some(V=>V.type==="Stun"))){const V=Y.ownerId===y,te=(g=Y.statuses)==null?void 0:g.some(ee=>ee.type==="Exploit"&&ee.addedByPlayerId===y);if(V||N&&te&&Y.ownerId!==y){const ee=Math.max(0,Y.power+(Y.powerModifier||0)+(Y.bonusPower||0));ee>0&&(l+=ee,b.push({row:O,col:S,text:`+${ee}`,playerId:y}))}}}b.length>0&&o(b);const T=localStorage.getItem("webrtc_enabled")==="true";T?r(O=>({...O,players:O.players.map(S=>S.id===y?{...S,score:Math.max(0,(S.score||0)+l)}:S)})):a(y,l),T||a(y,l),l>0&&A.currentPhase===4&&A.activePlayerId===y&&setTimeout(()=>{var O;T?r(S=>ir(S)):((O=t.current)==null?void 0:O.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:A.gameId}))},100)},[o,a,r,t,n]),c=$.useCallback((u,m,f,v,y,A)=>{var T,L;const N=n.current;if(!N.isGameStarted||N.isRoundEndModalOpen)return;const _=f>u?1:-1,E=v>m?1:-1,h=Math.abs(u-f);let P=0,D=0;const l=[];for(let g=0;g<=h;g++){const O=u+g*_,S=m+g*E;if(O<0||O>=N.board.length||S<0||S>=N.board.length)continue;const Y=N.board[O][S].card;if(Y&&!((T=Y.statuses)!=null&&T.some(V=>V.type==="Stun"))&&Y.ownerId===y){const te=Math.max(0,Y.power+(Y.powerModifier||0)+(Y.bonusPower||0));te>0&&(P+=te,l.push({row:O,col:S,text:`+${te}`,playerId:y})),A&&((L=Y.statuses)!=null&&L.some(ee=>ee.type==="Support"&&ee.addedByPlayerId===y))&&(D+=1)}}A==="point_per_support"&&D>0&&(P+=D),l.length>0&&o(l);const b=localStorage.getItem("webrtc_enabled")==="true";b?r(g=>({...g,players:g.players.map(O=>O.id===y?{...O,score:Math.max(0,(O.score||0)+P)}:O)})):a(y,P),b||a(y,P),A==="draw_per_support"&&D>0&&r(g=>{const O=Ue(g),S=O.players.find(k=>k.id===y);if(S&&S.deck.length>0)for(let k=0;k<D;k++)S.deck.length>0&&S.hand.push(S.deck.shift());return O}),P>0&&N.currentPhase===4&&N.activePlayerId===y&&setTimeout(()=>{var g;b?r(O=>ir(O)):((g=t.current)==null?void 0:g.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:N.gameId}))},500)},[o,a,r,t,n]);return{scoreLine:s,scoreDiagonal:c}}const us=e=>{const{updateState:t,rawJsonData:n}=e,r=$.useCallback((v,y,A,N)=>{t(_=>{if(!_.isGameStarted)return _;const E=Ue(_),h=E.board[v.row][v.col].card;if(h){const P=h.statuses?h.statuses.map(D=>D.type):[];if(N&&h.statuses){h.statuses=h.statuses.filter(l=>l.type!==N);const D=h.statuses.map(l=>l.type);console.log(`[markAbilityUsed] Removed status '${N}' from ${h.name} at [${v.row},${v.col}]: [${P.join(", ")}] -> [${D.join(", ")}]`)}else console.log(`[markAbilityUsed] Called for ${h.name} at [${v.row},${v.col}] but no readyStatusToRemove specified. Current statuses: [${P.join(", ")}]`)}return E})},[t]),a=$.useCallback(v=>{t(y=>{if(!y.isGameStarted)return y;const A=Ue(y),N=A.board[v.row][v.col].card;if(N&&(N.statuses||(N.statuses=[]),(N.ability||"").toLowerCase().includes("deploy:")&&!N.statuses.some(E=>E.type==="readyDeploy"))){const E=N.ownerId;if(E==null||E===0)return y;N.statuses.push({type:"readyDeploy",addedByPlayerId:E})}return A})},[t]),o=$.useCallback((v,y)=>{t(A=>{if(!A.isGameStarted)return A;const N=Ue(A),_=N.board[v.row][v.col].card;return _!=null&&_.statuses&&(_.statuses=_.statuses.filter(E=>E.type!==y)),N.board=ot(N),N})},[t]),s=$.useCallback((v,y,A,N,_)=>{t(E=>{if(!E.isGameStarted)return E;const h=Ue(E);return y.forEach(({row:P,col:D})=>{var b;const l=h.board[P][D].card;if(l){if(A==="Stun"&&(l.baseId==="luciusTheImmortal"||l.name.includes("Lucius")&&((b=l.types)!=null&&b.includes("Hero"))))return;l.statuses||(l.statuses=[]),["Support","Threat","Revealed"].includes(A)?l.statuses.some(L=>L.type===A&&L.addedByPlayerId===N)||l.statuses.push({type:A,addedByPlayerId:N}):l.statuses.push({type:A,addedByPlayerId:N})}}),h})},[t]),c=$.useCallback((v,y)=>{t(A=>{if(!A.isGameStarted)return A;const N=Ue(A),_=N.board[v.row][v.col].card,E=N.board[y.row][y.col].card;return N.board[v.row][v.col].card=E,N.board[y.row][y.col].card=_,N.board=ot(N),N})},[t]),u=$.useCallback((v,y,A)=>{t(N=>{if(!N.isGameStarted)return N;const _=Ue(N),E=_.board[v.row][v.col].card,h=_.board[y.row][y.col].card;if(E&&h&&E.statuses){const P=E.statuses.findIndex(D=>D.type===A);if(P>-1){const[D]=E.statuses.splice(P,1);h.statuses||(h.statuses=[]),h.statuses.push(D)}}return _.board=ot(_),_})},[t]),m=$.useCallback((v,y)=>{t(A=>{if(!A.isGameStarted)return A;const N=Ue(A),_=N.board[v.row][v.col].card,E=N.board[y.row][y.col].card,h=["Support","Threat","LastPlayed"];if(_&&E&&_.statuses){const P=_.statuses.filter(l=>!h.includes(l.type)),D=_.statuses.filter(l=>h.includes(l.type));P.length>0&&(E.statuses||(E.statuses=[]),E.statuses.push(...P),_.statuses=D)}return N.board=ot(N),N})},[t]),f=$.useCallback((v,y,A)=>{t(N=>{if(!N.isGameStarted)return N;const _=Ue(N);if(!n)return N;const E=n.tokenDatabase,h=Object.keys(E).find(l=>E[l].name===y);if(!h)return N;const P=E[h],D=_.players.find(l=>l.id===A);if(P&&_.board[v.row][v.col].card===null){const l={id:`TKN_${y.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:Ke.Tokens,name:y,baseId:P.baseId||h,imageUrl:P.imageUrl,fallbackImage:P.fallbackImage,power:P.power,ability:P.ability,flavorText:P.flavorText,color:P.color,types:P.types||["Unit"],faction:"Tokens",ownerId:A,ownerName:D==null?void 0:D.name,enteredThisTurn:!0,statuses:[]};kr(l,A),_.board[v.row][v.col].card=l}return _.board=ot(_),_})},[t,n]);return{markAbilityUsed:r,applyGlobalEffect:s,swapCards:c,transferStatus:u,transferAllCounters:m,spawnToken:f,resetDeployStatus:a,removeStatusByType:o}};function fs(e){const{updateState:t,localPlayerIdRef:n,updatePlayerScore:r}=e;return{moveItem:$.useCallback((o,s)=>{t(c=>{var N,_,E,h,P,D,l,b,T,L;if(!c.isGameStarted||s.target==="board"&&s.boardCoords&&c.board[s.boardCoords.row][s.boardCoords.col].card!==null&&o.source!=="counter_panel")return c;let u=!1;try{const g=localStorage.getItem("auto_abilities_enabled");u=g===null?!0:g==="true"}catch{u=!0}const m=u&&c.currentPhase===1&&o.source==="hand"&&s.target==="board"&&(((N=o.card.types)==null?void 0:N.includes("Unit"))||((_=o.card.types)==null?void 0:_.includes("Command"))),f=Ue(c);if(o.source==="board"&&["hand","deck","discard"].includes(s.target)&&!o.bypassOwnershipCheck){const g=o.card.ownerId,O=f.players.find(Y=>Y.id===g),S=g===n.current,k=!!(O!=null&&O.isDummy);if(!S&&!k)return c}let v=null;if(o.source==="board"&&s.target==="board"&&o.boardCoords){const g=f.board[o.boardCoords.row][o.boardCoords.col];g.card&&(v=g.card);const S=c.board[o.boardCoords.row][o.boardCoords.col].card||v;if(S&&((E=S.statuses)==null?void 0:E.some(Y=>Y.type==="Stun"))){const Y=n.current,V=S.ownerId,te=c.players.find(Te=>Te.id===Y),ee=c.players.find(Te=>Te.id===V),pe=Y===V,ye=(te==null?void 0:te.teamId)!==void 0&&(ee==null?void 0:ee.teamId)!==void 0&&te.teamId===ee.teamId;if((pe||ye)&&!o.isManual)return c}}if(o.source==="counter_panel"&&o.statusType){const g=$t[o.statusType];if(!((g==null?void 0:g.allowedTargets)??["board","hand"]).includes(s.target))return c;let S=null;if(s.target==="board"&&s.boardCoords)S=f.board[s.boardCoords.row][s.boardCoords.col].card;else if(s.playerId!==void 0){const k=f.players.find(Y=>Y.id===s.playerId);k&&(s.target==="hand"&&s.cardIndex!==void 0&&(S=k.hand[s.cardIndex]),s.target==="announced"&&(S=k.announcedCard||null),s.target==="deck"&&k.deck.length>0?s.deckPosition==="top"||!s.deckPosition?S=k.deck[0]:S=k.deck[k.deck.length-1]:s.target==="discard"&&k.discard.length>0&&(S=k.discard[k.discard.length-1]))}if(S){if(o.statusType==="Stun"&&(S.baseId==="luciusTheImmortal"||S.name.includes("Lucius")&&((h=S.types)!=null&&h.includes("Hero"))))return f;const k=o.count||1;let Y;if(o.ownerId!==void 0)Y=o.ownerId;else if(o.card.ownerId!==void 0)Y=o.card.ownerId;else{const V=f.players.find(te=>te.id===f.activePlayerId);Y=V!=null&&V.isDummy?V.id:n.current!==null?n.current:0}if(o.statusType==="Power+")S.powerModifier===void 0&&(S.powerModifier=0),S.powerModifier+=1*k;else if(o.statusType==="Power-")S.powerModifier===void 0&&(S.powerModifier=0),S.powerModifier-=1*k;else if(S.statuses||(S.statuses=[]),o.replaceStatusType&&o.statusType)for(let V=0;V<k;V++){const te=S.statuses.findIndex(ee=>ee.type===o.replaceStatusType&&ee.addedByPlayerId===Y);te!==-1?S.statuses[te]={type:o.statusType,addedByPlayerId:Y}:S.statuses.push({type:o.statusType,addedByPlayerId:Y})}else for(let V=0;V<k;V++)["Support","Threat","Revealed"].includes(o.statusType)?S.statuses.some(ee=>ee.type===o.statusType&&ee.addedByPlayerId===Y)||S.statuses.push({type:o.statusType,addedByPlayerId:Y}):S.statuses.push({type:o.statusType,addedByPlayerId:Y});return s.target==="board"&&(f.board=ot(f)),f}return c}const y=v?{...v}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const g=f.players.find(O=>O.id===o.playerId);if(g){const O=g.hand[o.cardIndex];if(O&&O.id===o.card.id&&O.ownerId===o.card.ownerId)g.hand.splice(o.cardIndex,1);else{const S=g.hand.findIndex(k=>k.id===o.card.id&&k.ownerId===o.card.ownerId);if(S!==-1)g.hand.splice(S,1);else return c}}}else if(o.source==="board"&&o.boardCoords){const g=f.board[o.boardCoords.row][o.boardCoords.col];if(g.card&&g.card.id===o.card.id&&g.card.ownerId===o.card.ownerId)f.board[o.boardCoords.row][o.boardCoords.col].card=null;else return c}else if(o.source==="discard"&&o.playerId!==void 0){const g=f.players.find(O=>O.id===o.playerId);if(g){let O=!1;if(o.cardIndex!==void 0){const S=g.discard[o.cardIndex];S&&S.id===o.card.id&&S.ownerId===o.card.ownerId&&(g.discard.splice(o.cardIndex,1),O=!0)}if(!O){const S=g.discard.findIndex(k=>k.id===o.card.id&&k.ownerId===o.card.ownerId);if(S!==-1)g.discard.splice(S,1);else return c}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const g=f.players.find(O=>O.id===o.playerId);if(g){const O=g.deck[o.cardIndex];if(O&&O.id===o.card.id&&O.ownerId===o.card.ownerId)g.deck.splice(o.cardIndex,1);else{const S=g.deck.findIndex(k=>k.id===o.card.id&&k.ownerId===o.card.ownerId);if(S!==-1)g.deck.splice(S,1);else return c}}}else if(o.source==="announced"&&o.playerId!==void 0){const g=f.players.find(O=>O.id===o.playerId);if(g)if(g.announcedCard&&g.announcedCard.id===o.card.id)g.announcedCard=null;else return c}if(["hand","deck","discard"].includes(s.target))y.statuses&&(y.statuses=y.statuses.filter(g=>g.type==="Revealed")),y.isFaceDown=!1,delete y.powerModifier,delete y.bonusPower,delete y.enteredThisTurn;else if(s.target==="board"&&(y.statuses||(y.statuses=[]),o.source!=="board"&&y.isFaceDown===void 0&&(y.isFaceDown=!1),o.source!=="board")){y.enteredThisTurn=!0;let g=y.ownerId;g===void 0&&(o.source==="token_panel"?g=f.activePlayerId??n.current??0:o.playerId!==void 0?g=o.playerId:g=n.current??0,y.ownerId=g),kr(y,g),o.source==="discard"&&(y.baseId==="luciusTheImmortal"||y.name.includes("Lucius"))&&(y.powerModifier===void 0&&(y.powerModifier=0),y.powerModifier+=2)}if(s.target==="hand"&&s.playerId!==void 0){if((y.deck===Ke.Tokens||y.deck==="counter")&&(((P=y.types)==null?void 0:P.includes("Token"))||((D=y.types)==null?void 0:D.includes("Token Unit"))))return c;hr(y);const O=f.players.find(k=>k.id===s.playerId);if(!O)return c;let S=s.cardIndex!==void 0?s.cardIndex:O.hand.length;if(o.source==="hand"&&o.playerId===s.playerId&&o.cardIndex!==void 0&&(o.cardIndex<S&&(S-=1),o.cardIndex===S))return c;O.hand.splice(S,0,y)}else if(s.target==="board"&&s.boardCoords){if(f.board[s.boardCoords.row][s.boardCoords.col].card===null){if(y.ownerId===void 0&&n.current!==null){const g=f.players.find(O=>O.id===n.current);g&&(y.ownerId=g.id,y.ownerName=g.name)}if(o.source!=="board"&&y.ownerId!==void 0){const g=f.players.find(O=>O.id===y.ownerId);g&&(g.boardHistory||(g.boardHistory=[]),g.boardHistory.push(y.id))}f.board[s.boardCoords.row][s.boardCoords.col].card=y}}else if(s.target==="discard"&&s.playerId!==void 0){if(!(y.deck===Ke.Tokens||y.deck==="counter")){hr(y),y.statuses&&(y.statuses=y.statuses.filter(O=>O.type!=="Revealed"));const g=f.players.find(O=>O.id===s.playerId);g&&(y.ownerId===void 0&&(y.ownerId=s.playerId,y.ownerName=g.name),g.discard.some(S=>S.id===y.id)||g.discard.push(y))}}else if(s.target==="deck"&&s.playerId!==void 0){if((y.deck===Ke.Tokens||y.deck==="counter")&&(((l=y.types)==null?void 0:l.includes("Token"))||((b=y.types)==null?void 0:b.includes("Token Unit"))))return c;hr(y),y.statuses&&(y.statuses=y.statuses.filter(S=>S.type!=="Revealed"));const O=f.players.find(S=>S.id===s.playerId);if(!O)return c;y.ownerId===void 0&&(y.ownerId=s.playerId,y.ownerName=O.name),s.deckPosition==="top"||!s.deckPosition?O.deck.unshift(y):O.deck.push(y)}else if(s.target==="announced"&&s.playerId!==void 0){const g=f.players.find(O=>O.id===s.playerId);g&&(g.announcedCard&&(g.announcedCard.statuses&&(g.announcedCard.statuses=g.announcedCard.statuses.filter(O=>O.type==="Revealed")),delete g.announcedCard.enteredThisTurn,delete g.announcedCard.powerModifier,delete g.announcedCard.bonusPower,g.hand.push(g.announcedCard)),g.announcedCard=y)}if(o.source==="board"&&s.target!=="board"&&y.ownerId!==void 0){const g=f.players.find(O=>O.id===y.ownerId);g&&(g.boardHistory||(g.boardHistory=[]),g.boardHistory=g.boardHistory.filter(O=>O!==y.id))}if((o.source==="board"||s.target==="board")&&y.ownerId!==void 0){const g=f.players.find(O=>O.id===y.ownerId);g&&oa(f.board,g)}if(o.source==="hand"&&s.target==="board"){const g=y;if(g.revealedTo==="all"||((T=g.statuses)==null?void 0:T.some(S=>S.type==="Revealed"))){const S=f.board.length;for(let k=0;k<S;k++)for(let Y=0;Y<S;Y++){const V=f.board[k][Y].card;if(V&&V.name.toLowerCase().includes("vigilant spotter")&&V.ownerId!==g.ownerId&&(f.board=ot(f),(L=f.board[k][Y].card.statuses)!=null&&L.some(ee=>ee.type==="Support"))){const ee=f.players.find(pe=>pe.id===V.ownerId);ee&&setTimeout(()=>{r(ee.id,2)},0)}}}}return(o.source==="board"||s.target==="board")&&(f.board=ot(f)),m&&(f.currentPhase=2),f})},[t,n,r])}}function ps(e){const{ws:t,webrtcManager:n,gameStateRef:r,webrtcIsHostRef:a,setGameState:o}=e,s=$.useCallback((u,m,f,v,y)=>{var P,D,l,b,T,L,g;const A=r.current;let N=[];v?N=v:N=cr(u,A,m,y);const _=[],E=u.mode==="SELECT_DECK";if((P=u.payload)!=null&&P.filter&&u.mode==="SELECT_TARGET"){const O=((D=u.sourceCard)==null?void 0:D.ownerId)||u.originalOwnerId||m,S=A.players.find(k=>k.id===O);S&&S.hand&&S.hand.forEach((k,Y)=>{try{u.payload.filter(k)&&_.push({playerId:S.id,cardIndex:Y})}catch{}})}const h={playerId:m,action:u,sourceCoords:f,timestamp:Date.now(),boardTargets:N,handTargets:_.length>0?_:void 0,isDeckSelectable:E||void 0,originalOwnerId:u.originalOwnerId};o(O=>({...O,targetingMode:h})),r.current.targetingMode=h,((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&A.gameId&&t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:A.gameId,targetingMode:h})),n.current&&(a.current?n.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((T=(b=n.current).getPeerId)==null?void 0:T.call(b))??void 0,data:{targetingMode:h},timestamp:Date.now()}):n.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((g=(L=n.current).getPeerId)==null?void 0:g.call(L))??void 0,data:{targetingMode:h},timestamp:Date.now()})),d.info(`[TargetingMode] Player ${m} activated targeting mode`,{mode:u.mode,boardTargetsCount:N.length})},[t,n,r,a,o]),c=$.useCallback(()=>{var m,f,v,y,A;const u=r.current;o(N=>({...N,targetingMode:null})),r.current.targetingMode=null,((m=t.current)==null?void 0:m.readyState)===WebSocket.OPEN&&u.gameId&&t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:u.gameId})),n.current&&(a.current?n.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((v=(f=n.current).getPeerId)==null?void 0:v.call(f))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):n.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((A=(y=n.current).getPeerId)==null?void 0:A.call(y))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[t,n,r,a,o]);return{setTargetingMode:s,clearTargetingMode:c}}function ys(e){const{webrtcManagerRef:t,webrtcIsHostRef:n,setWebrtcIsHost:r,setConnectionStatus:a,setWebrtcHostId:o,gameStateRef:s,localPlayerIdRef:c}=e,u=$.useCallback(async()=>{var A;if(!t.current)return d.error("WebRTC manager not initialized"),null;try{r(!0),a("Connecting");const N=await t.current.initializeAsHost();o(N),a("Connected");const _=s.current.gameId;_&&Rr(N,_);const E=(A=s.current.players)==null?void 0:A.find(h=>h.id===c.current);return Ao({peerId:N,isHost:!0,playerName:(E==null?void 0:E.name)||null}),d.info("[initializeWebrtcHost] Saved host data for auto-restore"),N}catch(N){return d.error("Failed to initialize WebRTC host:",N),a("Disconnected"),null}},[t,r,a,o,s,c]),m=$.useCallback(async A=>{if(!t.current)return d.error("WebRTC manager not initialized"),!1;try{return r(!1),o(A),a("Connecting"),await t.current.initializeAsGuest(A),!0}catch(N){return d.error("Failed to connect as guest:",N),a("Disconnected"),!1}},[t,r,a,o]),f=$.useCallback((A,N)=>t.current?n.current?(d.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):t.current.sendAction(A,N):(d.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[t,n]),v=$.useCallback(A=>{var _,E;if(!t.current||n.current)return d.warn("[requestDeckView] Only guests can request deck view from host"),!1;const N={type:"REQUEST_DECK_VIEW",senderId:t.current.getPeerId(),playerId:n.current||(E=(_=t.current).getLocalPlayerId)==null?void 0:E.call(_),data:{targetPlayerId:A},timestamp:Date.now()};return t.current.sendMessageToHost(N)},[t,n]),y=$.useCallback((A,N,_)=>!t.current||n.current?(d.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):t.current.sendFullDeckToHost(A,N,_),[t,n]);return{initializeWebrtcHost:u,connectAsGuest:m,sendWebrtcAction:f,requestDeckView:v,sendFullDeckToHost:y}}function hs(e){const{ws:t,gameStateRef:n,localPlayerIdRef:r,isRestoringSessionRef:a,isManualExitRef:o,webrtcIsHostRef:s,receivedServerStateRef:c,joiningGameIdRef:u,setGameState:m,setLocalPlayerId:f,connectWebSocket:v,updateState:y}=e,A=$.useCallback(()=>{t.current&&(t.current.readyState===WebSocket.OPEN||t.current.readyState===WebSocket.CONNECTING)?t.current.close():v()},[t,v]),N=$.useCallback(P=>{var D;if(o.current=!1,((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN){u.current=P;let l=null;try{const T=localStorage.getItem(Ot);T&&(l=JSON.parse(T))}catch{Ut()}const b={type:"JOIN_GAME",gameId:P};(l==null?void 0:l.gameId)===P&&l.playerToken?(b.playerToken=l.playerToken,d.info(`JoinGame: Sending reconnection with token ${l.playerToken.substring(0,8)}... for player ${l.playerId}`)):d.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${l==null?void 0:l.gameId}, requestedGameId=${P}`),t.current.send(JSON.stringify(b))}else v(),u.current=P},[t,o,u,v]),_=$.useCallback(()=>{o.current=!1,Ut();const P=sa(),D={...Rt(),gameId:P,players:[ia(1)]};c.current=!0,y(D),setTimeout(()=>{var l;((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&(t.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:P})),t.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:It})))},be.DECK_SYNC_DELAY)},[y,o,c,t]),E=$.useCallback(()=>{var P;((P=t.current)==null?void 0:P.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[t]),h=$.useCallback(()=>{var l;if(a.current)return;o.current=!0;const P=n.current.gameId,D=r.current;P&&s.current&&So(P);try{Gt(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),d.info("[exitGame] Cleared WebRTC persistence data")}catch(b){d.warn("[exitGame] Failed to clear WebRTC data:",b)}m(Rt()),f(null),Ut(),t.current&&(t.current.onclose=null),((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&P&&D!==null&&t.current.send(JSON.stringify({type:"EXIT_GAME",gameId:P,playerId:D})),t.current&&t.current.close(),setTimeout(()=>{o.current=!1,v()},be.RECONNECT_DELAY)},[a,o,n,r,s,m,f,t,v]);return{createGame:_,requestGamesList:E,exitGame:h,forceReconnect:A,joinGame:N}}const Ct=new Map,Us=(e={})=>{const{abilityMode:t,setAbilityMode:n}=e,[r,a]=$.useState(Rt()),o=$.useRef(Rt()),s=$.useCallback(i=>{a(oe=>{const U=typeof i=="function"?i(oe):i;return o.current=oe,localStorage.getItem("webrtc_enabled")==="true"&&ne.current&&setTimeout(()=>{x.current&&(x.current.broadcastGameState(U),d.debug(`[setGameStateWithDelta] Broadcast state: phase=${U.currentPhase}, round=${U.currentRound}`))},0),U})},[]),[c,u]=$.useState(null),m=$.useRef(r),f=$.useRef(c),[v,y]=$.useState(null),[A,N]=$.useState("Connecting"),[_,E]=$.useState([]),[h,P]=$.useState(null),[D,l]=$.useState(null),[b,T]=$.useState(null),[L,g]=$.useState([]),[O,S]=$.useState([]),[k,Y]=$.useState([]),[V,te]=$.useState(null),[ee,pe]=$.useState(!!It),[ye,Te]=$.useState(!1),[Fe,ve]=$.useState(null),[Re,st]=$.useState(!1),ne=$.useRef(!1),[Nt,Xe]=$.useState(!1),[At,ct]=$.useState(null),ht=$.useRef(!1),we=$.useRef(null),tt=$.useRef(null),mt=$.useRef(null),p=$.useRef(!1),G=$.useRef(!1),X=$.useRef(void 0),ge=$.useRef(!1),x=$.useRef(null),Me=$.useRef(()=>{}),Be=ys({webrtcManagerRef:x,webrtcIsHostRef:ne,setWebrtcIsHost:st,setConnectionStatus:N,setWebrtcHostId:ve,gameStateRef:m,localPlayerIdRef:f}),{initializeWebrtcHost:qe,connectAsGuest:Ne,sendWebrtcAction:et,requestDeckView:lt,sendFullDeckToHost:ut}=Be;$.useEffect(()=>{Me.current=s},[s]),$.useEffect(()=>{ne.current=Re},[Re]),$.useEffect(()=>{const i=localStorage.getItem("webrtc_enabled")==="true";if(Te(i),i){x.current=zo();const oe=x.current.on(U=>{Je(U)});return()=>{oe()}}},[]),$.useEffect(()=>{if(!(localStorage.getItem("webrtc_enabled")==="true"))return;const oe=window.location.hash.slice(1);if(oe&&new URLSearchParams(oe).get("hostId"))return;const U="webrtc_auto_restore_attempted";if(sessionStorage.getItem(U))return;sessionStorage.setItem(U,"true");const B=Do();if(B==="none"){sessionStorage.removeItem(U);return}setTimeout(async()=>{var J,ie;if(!x.current){d.warn("[Auto-restore] WebRTC manager not ready");return}try{if(B==="host"){Le.current=!0,d.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ce=qn(),Z=xn();if(!ce||!Z){d.warn("[Auto-restore] Missing host data or state data"),Gt(),Le.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}d.info(`[Auto-restore] Restoring host session: old peerId=${ce.peerId}`);const Pe=await x.current.initializeAsHost();ne.current=!0,st(!0),ve(Pe),N("Connected"),(J=Z.gameState)!=null&&J.gameId&&(Rr(Pe,Z.gameState.gameId),d.info(`[Auto-restore] Broadcasted NEW host peerId ${Pe} for game ${Z.gameState.gameId}`)),(Z.gameState||Z.localPlayerId!==null)&&(Z.gameState&&(m.current=Z.gameState),Z.localPlayerId!==null&&(f.current=Z.localPlayerId),ht.current=!0,setTimeout(()=>{ht.current=!1},1e4),setTimeout(()=>{var We;Z.gameState&&(a(Z.gameState),d.info(`[Auto-restore] Restored game state with ${((We=Z.gameState.players)==null?void 0:We.length)||0} players, gameId=${Z.gameState.gameId}`)),Z.localPlayerId!==null&&(u(Z.localPlayerId),d.info(`[Auto-restore] Restored local player ID: ${Z.localPlayerId}`))},0)),setTimeout(()=>{if(Le.current=!1,d.info("[Auto-restore] Cleared restoration flag"),x.current&&Z.gameState){const We=Z.gameState.players.filter(rt=>!rt.isDummy&&rt.id!==Z.localPlayerId);We.length>0&&(d.info(`[Auto-restore] Requesting deck data from ${We.length} guest players`),x.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:x.current.getPeerId(),timestamp:Date.now()}))}},500),d.info("[Auto-restore] Host session restoration initiated")}else if(B==="guest"){Le.current=!0,d.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ce=jn(),Z=xn();if(!ce||!Z){d.warn("[Auto-restore] Missing guest data or state data"),Gt(),Le.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}d.info(`[Auto-restore] Restoring guest session: old hostPeerId=${ce.hostPeerId}, playerId=${ce.playerId}`),ne.current=!1,st(!1),N("Connecting");let Pe=ce.hostPeerId;if((ie=Z.gameState)!=null&&ie.gameId){const We=Er(Z.gameState.gameId);We&&We.peerId&&(Pe=We.peerId,d.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Pe}`))}if(ve(Pe),ce.playerId!==null){d.info(`[Auto-restore] Reconnecting as existing player ${ce.playerId} to host ${Pe}`);try{await x.current.initializeAsReconnectingGuest(Pe,ce.playerId),N("Connected"),d.info("[Auto-restore] Successfully reconnected to host")}catch(We){d.error("[Auto-restore] Failed to reconnect to host:",We),N("Disconnected"),Gt(),d.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),Le.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else d.info("[Auto-restore] Connecting as new player"),await x.current.initializeAsGuest(Pe),N("Connected");(Z.gameState||Z.localPlayerId!==null)&&(Z.gameState&&(m.current=Z.gameState),Z.localPlayerId!==null&&(f.current=Z.localPlayerId),ht.current=!0,setTimeout(()=>{ht.current=!1},1e4),setTimeout(()=>{var We,rt;if(Z.gameState&&(a(Z.gameState),d.info(`[Auto-restore] Restored game state with ${((We=Z.gameState.players)==null?void 0:We.length)||0} players, gameId=${Z.gameState.gameId}, isGameStarted=${Z.gameState.isGameStarted}`),Z.localPlayerId!==null)){const Ae=(rt=Z.gameState.players)==null?void 0:rt.some(ke=>ke.id===Z.localPlayerId);d.info(`[Auto-restore] Player ${Z.localPlayerId} exists in restored state: ${Ae}`)}Z.localPlayerId!==null&&(u(Z.localPlayerId),d.info(`[Auto-restore] Restored local player ID: ${Z.localPlayerId}`))},0)),setTimeout(()=>{Le.current=!1,d.info("[Auto-restore] Cleared restoration flag")},100),d.info("[Auto-restore] Guest session restoration initiated")}}catch(ce){d.error("[Auto-restore] Failed to restore session:",ce),Gt(),Le.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),$.useEffect(()=>{if(!ye||!x.current)return;const i=window.location.hash.slice(1);if(!i)return;const U=new URLSearchParams(i).get("hostId");U&&Ne(U)},[ye]),$.useEffect(()=>{m.current=r},[r]),$.useEffect(()=>{f.current=c},[c]);const Ye=rs({ws:we,webrtcManager:x,gameStateRef:m,localPlayerIdRef:f,webrtcIsHostRef:ne,setLatestHighlight:P,setLatestFloatingTexts:l,setLatestNoTarget:T,setLatestDeckSelections:g,setLatestHandCardSelections:S,setTargetSelectionEffects:Y,setGameState:a}),Le=$.useRef(!1);$.useEffect(()=>{if(!ye||!ne.current||!(r!=null&&r.gameId))return;const i=r.gameId,oe=()=>{var J;const B=(J=x.current)==null?void 0:J.getPeerId();B&&i&&Rr(B,i)};oe();const U=setInterval(oe,2e3);return()=>clearInterval(U)},[ye,r==null?void 0:r.gameId]),$.useEffect(()=>{if(!ye||ne.current||!(r!=null&&r.gameId))return;const i=r.gameId,oe=J=>{var ie;ve(J),N("Connecting"),(ie=x.current)==null||ie.initializeAsReconnectingGuest(J,f.current||0).then(()=>{N("Connected")}).catch(ce=>{d.error("[Guest Auto-Reconnect] Failed to reconnect:",ce),N("Disconnected")})},U=J=>{const ie=`webrtc_host_${i}`;if(!(J.key!==ie||!J.newValue))try{const Z=JSON.parse(J.newValue).peerId;Z&&Z!==Fe&&oe(Z)}catch(ce){d.error("[Guest Auto-Reconnect] Failed to parse storage event:",ce)}},B=setInterval(()=>{const J=Er(i);J&&J.peerId!==Fe&&(d.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${J.peerId}`),oe(J.peerId))},2e3);return window.addEventListener("storage",U),()=>{window.removeEventListener("storage",U),clearInterval(B)}},[ye,r==null?void 0:r.gameId,Fe]),$.useEffect(()=>{const i=setInterval(()=>{a(oe=>{const U=Date.now(),B=oe.floatingTexts||[],J=B.filter(ie=>U-ie.timestamp<be.FLOATING_TEXT_DURATION);return J.length!==B.length?{...oe,floatingTexts:J}:oe})},be.DECK_SYNC_DELAY);return()=>clearInterval(i)},[]);const Je=$.useCallback(i=>{var oe,U,B;switch(i.type){case"peer_open":(oe=i.data)!=null&&oe.peerId&&(ve(i.data.peerId),d.info(`WebRTC peer opened with ID: ${i.data.peerId}`));break;case"guest_connected":d.info("Guest connected via WebRTC:",(U=i.data)==null?void 0:U.peerId);break;case"connected_to_host":(B=i.data)!=null&&B.hostPeerId&&Fe!==i.data.hostPeerId&&(ve(i.data.hostPeerId),d.info(`Updated webrtcHostId to: ${i.data.hostPeerId}`)),N("Connected"),Xe(!1),ct(null),ht.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(d.warn("WebRTC peer disconnected"),N("Disconnected"),Xe(!0),!ne.current&&Fe&&r)try{const J={hostPeerId:Fe,playerId:c,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(J)),d.info("[Reconnection] Stored reconnection data before disconnect"),j(Fe)}catch(J){d.error("[Reconnection] Failed to store data:",J)}break;case"message_received":F(i.data);break;case"error":d.error("WebRTC error:",i.data);break}},[r,c,Fe,Re]),je=$.useCallback((i,oe)=>{if(d.info(`[handleWebrtcGuestJoin] Called for guest ${i}, isHost: ${ne.current}`),!ne.current||!x.current){d.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const U=(oe==null?void 0:oe.preferredDeck)||"Random";a(B=>{if(!B)return d.error("[handleWebrtcGuestJoin] No previous state"),B;d.info(`[handleWebrtcGuestJoin] Current state has ${B.players.length} players`);const J=B.players.map(Ae=>Ae.id);let ie=1;for(;J.includes(ie);)ie++;const ce={id:ie,name:`Player ${ie}`,color:sr[J.length%sr.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:U,boardHistory:[],autoDrawEnabled:!0},Z={...B,players:[...B.players,ce]},Pe=B.board.map(Ae=>Ae.map(ke=>({...ke,card:ke.card?{id:ke.card.id,baseId:ke.card.baseId,ownerId:ke.card.ownerId,name:ke.card.name,imageUrl:ke.card.imageUrl,power:ke.card.power,ability:ke.card.ability,isFaceDown:ke.card.isFaceDown,statuses:ke.card.statuses||[]}:null}))),We=Ae=>Ae.map(ke=>({id:ke.id,baseId:ke.baseId,name:ke.name,imageUrl:ke.imageUrl,power:ke.power,powerModifier:ke.powerModifier,ability:ke.ability,ownerId:ke.ownerId,color:ke.color,deck:ke.deck,isFaceDown:ke.isFaceDown,types:ke.types,faction:ke.faction,statuses:ke.statuses}));x.current.acceptGuestMinimal(i,{playerId:ie,gameId:B.gameId,isGameStarted:B.isGameStarted,players:Z.players.map(Ae=>Ae.isDummy?{id:Ae.id,name:Ae.name,color:Ae.color,isDummy:Ae.isDummy,isReady:Ae.isReady,score:Ae.score,selectedDeck:Ae.selectedDeck,hand:We(Ae.hand||[]),deck:We(Ae.deck||[]),discard:We(Ae.discard||[]),handSize:Ae.hand.length,deckSize:Ae.deck.length,discardSize:Ae.discard.length}:{id:Ae.id,name:Ae.name,color:Ae.color,isDummy:Ae.isDummy,isReady:Ae.isReady,score:Ae.score,selectedDeck:Ae.selectedDeck,deckSize:Ae.deck.length,handSize:Ae.hand.length,discardSize:Ae.discard.length}),deckSelections:Z.players.map(Ae=>({id:Ae.id,selectedDeck:Ae.selectedDeck})),gameMode:B.gameMode,currentRound:B.currentRound,currentPhase:B.currentPhase,activePlayerId:B.activePlayerId,startingPlayerId:B.startingPlayerId,activeGridSize:B.activeGridSize,board:Pe},ie),x.current.broadcastGameState(Z,i),x.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:x.current.getPeerId(),data:{playerId:ie,selectedDeck:U},timestamp:Date.now()});const rt=Z.players.find(Ae=>Ae.id===f.current);if(rt&&rt.deck.length>0){const Ae=rt.deck.map(ke=>({id:ke.id,baseId:ke.baseId,power:ke.power,powerModifier:ke.powerModifier||0,isFaceDown:ke.isFaceDown||!1,statuses:ke.statuses||[]}));x.current.sendToGuest(i,{type:"CHANGE_PLAYER_DECK",senderId:x.current.getPeerId(),playerId:rt.id,data:{playerId:rt.id,deckType:rt.selectedDeck,deck:Ae,deckSize:Ae.length},timestamp:Date.now()}),d.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${rt.selectedDeck}, ${Ae.length} cards`)}return Z})},[]),Q=$.useCallback(i=>{const oe=ne.current;if(d.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!x.current}, webrtcIsHostRef.current=${oe}`),!x.current||!oe){d.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}x.current.broadcastGameState(i)},[]),F=$.useCallback(i=>{var oe,U,B,J,ie,ce,Z,Pe,We,rt,Ae,ke,Hr,Fr,Wr,Br,Yr,zr,Kr,qr,jr,Vr,Jr,Xr,Zr,Qr,en,tn,rn,nn,an,on,sn,dn,cn,ln,un,fn,pn,yn,hn,In,En,Tn,mn,gn,wn,_n,Cn,bn,An,Sn,Dn,Rn,On,Pn,kn,vn,Nn,Ln,Mn;if(!(!i||!i.type))switch(d.info(`[handleWebrtcMessage] Received: ${i.type}`),i.type){case"JOIN_ACCEPT_MINIMAL":if(d.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${i.playerId}`),i.data){const I=i.data;d.info(`[handleWebrtcMessage] Creating minimal state with ${((oe=I.players)==null?void 0:oe.length)||0} players`);const w={gameId:I.gameId||sa(),isGameStarted:I.isGameStarted||!1,isPrivate:!1,activeGridSize:I.activeGridSize||4,gameMode:I.gameMode||Or.FreeForAll,dummyPlayerCount:0,players:((U=I.players)==null?void 0:U.map(C=>{if((C.isDummy||!1)&&C.hand&&C.deck&&C.discard)return{id:C.id,name:C.name,color:C.color,isDummy:!0,isReady:C.isReady||!1,score:C.score||0,hand:C.hand||[],deck:C.deck||[],discard:C.discard||[],announcedCard:null,selectedDeck:C.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const z=[],R=[],q=[];for(let le=0;le<(C.handSize||0);le++)z.push({id:`placeholder_${C.id}_hand_${le}`,name:"?",isPlaceholder:!0,ownerId:C.id,deck:C.selectedDeck||"Random",color:C.color});for(let le=0;le<(C.deckSize||0);le++)R.push({id:`placeholder_${C.id}_deck_${le}`,name:"?",isPlaceholder:!0,ownerId:C.id,deck:C.selectedDeck||"Random",color:C.color});for(let le=0;le<(C.discardSize||0);le++)q.push({id:`placeholder_${C.id}_discard_${le}`,name:"?",isPlaceholder:!0,ownerId:C.id,deck:C.selectedDeck||"Random",color:C.color});return{id:C.id,name:C.name,color:C.color,isDummy:!1,isReady:C.isReady||!1,score:C.score||0,hand:z,deck:R,discard:q,announcedCard:null,selectedDeck:C.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:I.board||Vn(),hostId:1,currentPhase:I.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:I.currentRound||1,turnNumber:I.turnNumber||1,activePlayerId:I.activePlayerId??null,startingPlayerId:I.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};a(w),i.playerId!==void 0&&(u(i.playerId),d.info(`[handleWebrtcMessage] Set local player ID to ${i.playerId}`)),a(C=>{const H=C.players.map(z=>{var q;const R=(q=I.players)==null?void 0:q.find(le=>le.id===z.id);if(z.id===i.playerId){const Ce=z.deck.length===0||z.deck.some(fe=>fe.isPlaceholder)||z.deck.length!==30;if(R!=null&&R.selectedDeck&&Ce){const fe=bt(R.selectedDeck,z.id,z.name);d.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${fe.length} cards from ${R.selectedDeck}`),x.current&&fe.length>0&&setTimeout(()=>{const ze=fe.map(Ge=>({id:Ge.id,baseId:Ge.baseId,power:Ge.power,powerModifier:Ge.powerModifier||0,isFaceDown:Ge.isFaceDown||!1,statuses:Ge.statuses||[]}));x.current.sendAction("DECK_DATA_UPDATE",{playerId:i.playerId,deck:ze,deckSize:ze.length}),d.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${R.selectedDeck}, ${ze.length} cards`)},0);const Ie=[...z.hand],Se=[...fe];if(I.isGameStarted&&Ie.length===0&&Se.length>0){for(let Ge=0;Ge<6&&Ge<Se.length;Ge++){const at=Se[0];Se.splice(0,1),Ie.push(at)}d.info(`[JOIN_ACCEPT_MINIMAL] Drew ${Ie.length} cards, deck now has ${Se.length} cards`)}return{...z,deck:Se,hand:Ie,selectedDeck:R.selectedDeck}}}return z});return{...C,players:H}});try{const C=(B=x.current)==null?void 0:B.getHostPeerId();C&&Ir({hostPeerId:C,playerId:i.playerId,playerName:((J=w.players.find(H=>H.id===i.playerId))==null?void 0:J.name)||null,isHost:!1})}catch(C){d.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",C)}}break;case"JOIN_ACCEPT":if(d.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${i.playerId}, hasState: ${!!((ie=i.data)!=null&&ie.gameState)}`),(ce=i.data)!=null&&ce.gameState){const I=i.data.gameState;if(d.info(`[handleWebrtcMessage] Setting game state with ${((Z=I.players)==null?void 0:Z.length)||0} players`),a(I),i.playerId!==void 0){u(i.playerId),d.info(`[handleWebrtcMessage] Set local player ID to ${i.playerId}`);try{const w=(Pe=x.current)==null?void 0:Pe.getHostPeerId(),C=I.players.find(H=>H.id===i.playerId);w&&Ir({hostPeerId:w,playerId:i.playerId,playerName:(C==null?void 0:C.name)||null,isHost:!1})}catch(w){d.warn("[JOIN_ACCEPT] Failed to save guest data:",w)}}}break;case"JOIN_ACCEPT_BINARY":if(d.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${i.playerId}`),i.data instanceof Uint8Array)try{const I=xo(i.data),w=I;if(d.info(`[handleWebrtcMessage] Expanded binary state with ${((We=w.players)==null?void 0:We.length)||0} players`),a(w),i.playerId!==void 0){u(i.playerId),d.info(`[handleWebrtcMessage] Set local player ID to ${i.playerId}`);try{const C=(rt=x.current)==null?void 0:rt.getHostPeerId(),H=w.players.find(z=>z.id===i.playerId);C&&Ir({hostPeerId:C,playerId:i.playerId,playerName:(H==null?void 0:H.name)||null,isHost:!1})}catch(C){d.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",C)}}d.info(`[handleWebrtcMessage] Received optimized binary game state: ${i.data.byteLength} bytes`)}catch(I){d.error("[handleWebrtcMessage] Failed to deserialize binary game state:",I)}break;case"STATE_UPDATE_COMPACT":if(ne.current){if(i.senderId&&i.senderId!==((Ae=x.current)==null?void 0:Ae.getPeerId())&&(d.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${i.senderId}`),(ke=i.data)!=null&&ke.gameState)){const I=i.data.gameState;a(w=>{const C=i.playerId;if(C===void 0)return d.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),w;const H=w.players.map(R=>{if(R.id===C){const q=I.players.find(le=>le.id===C);if(q){const le=Se=>{const ze=_t(Se.baseId);return ze?{...ze,id:Se.id,baseId:Se.baseId,ownerId:C,power:Se.power,powerModifier:Se.powerModifier,isFaceDown:Se.isFaceDown,statuses:Se.statuses||[]}:{id:Se.id,baseId:Se.baseId,name:"Unknown",power:0}},Ce=(q.handCards||[]).map(le),fe=(q.deckCards||[]).map(le),Ie=(q.discardCards||[]).map(le);return d.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${C}: hand=${Ce.length}, deck=${fe.length}, discard=${Ie.length}`),{...R,hand:Ce,deck:fe,discard:Ie,handSize:Ce.length,deckSize:fe.length,discardSize:Ie.length}}}return R}),z={...w,players:H};return x.current&&setTimeout(()=>{x.current.broadcastGameState(z,i.senderId)},0),z})}}else if(!ne.current&&((Hr=i.data)!=null&&Hr.gameState)){const I=i.data.recipientPlayerId??null,w=i.data.gameState;if(ht.current){a(C=>({...C,currentPhase:w.currentPhase,activePlayerId:w.activePlayerId,startingPlayerId:w.startingPlayerId,isReadyCheckActive:w.isReadyCheckActive,isGameStarted:w.isGameStarted}));return}a(C=>{const H=I===null||I===f.current;d.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${I}, local=${f.current}, isForLocal=${H}`);const z=w.players.map(R=>{var le,Ce,fe,Ie,Se,ze;const q=C.players.find(Ge=>Ge.id===R.id);if(R.id===f.current&&q){const Ge=xe=>{if(xe.baseId){const Qe=_t(xe.baseId);if(Qe)return{...Qe,id:xe.id,ownerId:f.current,power:xe.power,powerModifier:xe.powerModifier,isFaceDown:xe.isFaceDown,statuses:xe.statuses||[]}}return q.hand.find(Qe=>Qe.id===xe.id)||q.deck.find(Qe=>Qe.id===xe.id)||q.discard.find(Qe=>Qe.id===xe.id)||{id:xe.id,name:"Unknown",power:0}};if(R.handCards&&R.handCards.length>0||R.deckCards&&R.deckCards.length>0||R.discardCards&&R.discardCards.length>0){d.info(`[STATE_UPDATE_COMPACT] Received ${((le=R.handCards)==null?void 0:le.length)||0} handCards, ${((Ce=R.deckCards)==null?void 0:Ce.length)||0} deckCards, ${((fe=R.discardCards)==null?void 0:fe.length)||0} discardCards`),(Ie=R.handCards)!=null&&Ie[0]&&d.info(`[STATE_UPDATE_COMPACT] First handCard from host: id=${R.handCards[0].id}, baseId=${R.handCards[0].baseId}`);const xe=(R.handCards||[]).map(Ge),Ze=(R.deckCards||[]).map(Ge),Qe=(R.discardCards||[]).map(Ge);return xe.forEach((He,$e)=>{var Ee,nt;(nt=(Ee=R.handCards)==null?void 0:Ee[$e])!=null&&nt.baseId&&!He.baseId&&(He.baseId=R.handCards[$e].baseId)}),Ze.forEach((He,$e)=>{var Ee,nt;(nt=(Ee=R.deckCards)==null?void 0:Ee[$e])!=null&&nt.baseId&&!He.baseId&&(He.baseId=R.deckCards[$e].baseId)}),Qe.forEach((He,$e)=>{var Ee,nt;(nt=(Ee=R.discardCards)==null?void 0:Ee[$e])!=null&&nt.baseId&&!He.baseId&&(He.baseId=R.discardCards[$e].baseId)}),xe[0]&&d.info(`[STATE_UPDATE_COMPACT] First reconstructed hand card: id=${xe[0].id}, name=${xe[0].name}, baseId=${xe[0].baseId}`),d.info(`[STATE_UPDATE_COMPACT] Reconstructed from compact data: ${xe.length} hand, ${Ze.length} deck, ${Qe.length} discard`),{...R,hand:xe,deck:Ze,discard:Qe}}else{const xe=(R.handIds||[]).map(He=>q.hand.find(Ee=>Ee.id===He)||q.deck.find(Ee=>Ee.id===He)||q.discard.find(Ee=>Ee.id===He)||{id:He,name:"?",isPlaceholder:!1}),Ze=(R.deckIds||[]).map(He=>q.deck.find(Ee=>Ee.id===He)||q.hand.find(Ee=>Ee.id===He)||q.discard.find(Ee=>Ee.id===He)||{id:He,name:"?",isPlaceholder:!1}),Qe=(R.discardIds||[]).map(He=>q.discard.find(Ee=>Ee.id===He)||q.hand.find(Ee=>Ee.id===He)||q.deck.find(Ee=>Ee.id===He)||{id:He,name:"?",isPlaceholder:!1});return d.info(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${xe.length} hand, ${Ze.length} deck, ${Qe.length} discard`),{...R,hand:xe,deck:Ze,discard:Qe}}}else{const Ge=R.deckSize??((Se=R.deck)==null?void 0:Se.length)??0,at=R.handSize??((ze=R.hand)==null?void 0:ze.length)??0,xe=R.deckCards&&R.deckCards.length>0;let Ze;if(xe){const $e=Ee=>{if(Ee.baseId){const nt=_t(Ee.baseId);if(nt)return{...nt,id:Ee.id,baseId:Ee.baseId,ownerId:R.id,power:Ee.power,powerModifier:Ee.powerModifier,isFaceDown:Ee.isFaceDown,statuses:Ee.statuses||[]}}return{id:Ee.id,name:"Unknown",power:0}};Ze=R.deckCards.map($e),d.info(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${R.id} from host data: ${Ze.length} cards`)}else if(q&&q.deck.length>0&&q.deck.some(Ee=>!Ee.isPlaceholder))Ze=q.deck.slice(0,Ge),d.info(`[STATE_UPDATE_COMPACT] Preserved real deck data for player ${R.id}: ${Ze.length} cards (remoteDeckSize=${Ge})`);else{Ze=[];for(let Ee=0;Ee<Ge;Ee++)Ze.push({id:`placeholder_${R.id}_deck_${Ee}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});d.info(`[STATE_UPDATE_COMPACT] Created ${Ze.length} placeholders for player ${R.id} (deckSize=${Ge})`)}const Qe=($e,Ee)=>{if($e.baseId&&!$e.isPlaceholder&&!$e.isCardBack){const nt=_t($e.baseId);if(nt)return{...nt,id:$e.id,baseId:$e.baseId,ownerId:R.id,power:$e.power,powerModifier:$e.powerModifier||0,isFaceDown:$e.isFaceDown||!1,statuses:$e.statuses||[]}}return{id:$e.id||`placeholder_${R.id}_hand_${Ee}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color}};let He;if(R.hand&&R.hand.length>0){He=R.hand.map((Ee,nt)=>Qe(Ee,nt));const $e=He.filter(Ee=>!Ee.isPlaceholder).length;$e>0&&d.info(`[STATE_UPDATE_COMPACT] Reconstructed ${$e}/${He.length} revealed hand cards for player ${R.id}`)}else{He=[];for(let $e=0;$e<at;$e++)He.push({id:`placeholder_${R.id}_hand_${$e}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color})}return{...R,hand:He,deck:Ze,discard:(q==null?void 0:q.discard)||[]}}});return{...w,players:z}})}break;case"STATE_UPDATE":if(ne.current&&i.senderId&&i.senderId!==((Fr=x.current)==null?void 0:Fr.getPeerId())){if(d.info(`[STATE_UPDATE] Host received state from guest ${i.senderId}`),(Wr=i.data)!=null&&Wr.gameState){const I=i.data.gameState;a(w=>{const C=i.playerId;if(C===void 0)return d.warn("[STATE_UPDATE] Guest state missing playerId"),w;const H=w.players.map(q=>{if(q.id===C){const le=I.players.find(Ce=>Ce.id===C);if(le){const Ce=le.hand||[],fe=le.deck||[],Ie=le.discard||[];d.info(`[STATE_UPDATE] Merging guest ${C} state: hand=${Ce.length}, deck=${fe.length}, discard=${Ie.length}`);const Se={...q,hand:Ce,deck:fe,discard:Ie,handSize:Ce.length,deckSize:fe.length,discardSize:Ie.length};return d.info(`[STATE_UPDATE] After merge - player ${C}: deckSize=${Se.deckSize}, handSize=${Se.handSize}`),Se}}return q}),z=I.board?I.board:w.board,R={...w,players:H,board:z};return x.current&&setTimeout(()=>{x.current.broadcastGameState(R,i.senderId)},0),R})}break}if(ge.current=!0,(Br=i.data)!=null&&Br.gameState){const I=i.data.gameState;if(ht.current){a(w=>({...w,currentPhase:I.currentPhase,activePlayerId:I.activePlayerId,startingPlayerId:I.startingPlayerId,isReadyCheckActive:I.isReadyCheckActive,isGameStarted:I.isGameStarted}));return}a(w=>{var z;const C=I.players.map(R=>{var le,Ce,fe;const q=w.players.find(Ie=>Ie.id===R.id);if(R.id===f.current&&q){const Ie=q.hand.every(ze=>ze.isPlaceholder)||q.hand.length===0,Se=R.handSize??((le=R.hand)==null?void 0:le.length)??0;if(Ie&&R.hand&&R.hand.length>0)return{...R,hand:R.hand,deck:R.deck||q.deck,discard:R.discard||q.discard};{let ze=q.hand,Ge=q.deck;if(Se>q.hand.length&&Ge.length>0){const at=Se-q.hand.length,xe=[...q.hand],Ze=[...q.deck];for(let Qe=0;Qe<at&&Qe<Ze.length;Qe++){const He=Ze[0];Ze.splice(0,1),xe.push(He)}ze=xe,Ge=Ze}return{...R,hand:ze,deck:Ge,discard:R.discard||q.discard}}}else{if(R.isDummy||!1)return d.info(`[STATE_UPDATE] Using real cards for dummy player ${R.id}`),{...R,hand:R.hand||[],deck:R.deck||[],discard:R.discard||[]};const Se=R.deckSize??((Ce=R.deck)==null?void 0:Ce.length)??0,ze=R.handSize??((fe=R.hand)==null?void 0:fe.length)??0;d.info(`[STATE_UPDATE] Player ${R.id}: deckSize=${Se}, handSize=${ze}`);const Ge=[];for(let xe=0;xe<Se;xe++)Ge.push({id:`placeholder_${R.id}_deck_${xe}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});const at=[];for(let xe=0;xe<ze;xe++)at.push({id:`placeholder_${R.id}_hand_${xe}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});return d.info(`[STATE_UPDATE] Created ${Ge.length} deck placeholders and ${at.length} hand placeholders for player ${R.id}`),{...R,hand:at,deck:Ge,discard:R.discard||[]}}}),H={...I,players:C};if(!ne.current)try{((z=x.current)==null?void 0:z.getHostPeerId())&&f.current!==null&&(Ht({gameState:H,localPlayerId:f.current,isHost:!1}),d.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(R){d.warn("[STATE_UPDATE] Failed to persist guest state:",R)}return H})}break;case"RECONNECT_SNAPSHOT":if(ge.current=!0,i.data){const I=i.data;a(w=>{const C=f.current,H=I.players.map(R=>{const q=w.players.find(Ie=>Ie.id===R.id);if(R.id===C&&q&&q.hand.some(Se=>!Se.isPlaceholder)){let Se=[...q.hand];const ze=[...q.deck];if(R.handSize>Se.length){const Ge=R.handSize-Se.length;for(let at=0;at<Ge&&ze.length>0;at++)Se.push(ze.shift())}else R.handSize<Se.length&&(Se=Se.slice(0,R.handSize));return{...R,hand:Se,deck:ze,discard:q.discard}}const le=[];for(let Ie=0;Ie<R.handSize;Ie++)le.push({id:`placeholder_${R.id}_hand_${Ie}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});const Ce=[];for(let Ie=0;Ie<R.deckSize;Ie++)Ce.push({id:`placeholder_${R.id}_deck_${Ie}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});const fe=[];for(let Ie=0;Ie<R.discardSize;Ie++)fe.push({id:`placeholder_${R.id}_discard_${Ie}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});return{...R,hand:le,deck:Ce,discard:fe}}),z={gameId:I.gameId,gameMode:I.gameMode,isPrivate:I.isPrivate,isGameStarted:I.isGameStarted,isReadyCheckActive:I.isReadyCheckActive,activeGridSize:I.activeGridSize,currentPhase:I.currentPhase,isScoringStep:I.isScoringStep,activePlayerId:I.activePlayerId,startingPlayerId:I.startingPlayerId,currentRound:I.currentRound,turnNumber:I.turnNumber,roundWinners:I.roundWinners||{},gameWinner:I.gameWinner,isRoundEndModalOpen:I.isRoundEndModalOpen,dummyPlayerCount:I.dummyPlayerCount,players:H,board:I.board,spectators:w.spectators,hostId:w.hostId,revealRequests:w.revealRequests,preserveDeployAbilities:w.preserveDeployAbilities,highlights:w.highlights,floatingTexts:w.floatingTexts,targetingMode:w.targetingMode,abilityMode:w.abilityMode};if(!ne.current&&C!==null)try{Ht({gameState:z,localPlayerId:C,isHost:!1}),d.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(R){d.warn("[RECONNECT_SNAPSHOT] Failed to save state:",R)}return d.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${z.currentPhase}, players=${z.players.length}`),z})}break;case"STATE_DELTA":if(ne.current||(ge.current=!0),d.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${ne.current}, senderId: ${i.senderId}`),(Yr=i.data)!=null&&Yr.delta){const I=i.data.delta;d.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(I.playerDeltas||{}).length}, boardCells=${((zr=I.boardCells)==null?void 0:zr.length)||0}, phaseDelta=${!!I.phaseDelta}`),I.boardCells&&I.boardCells.length>0&&I.boardCells.forEach(w=>{var C,H;d.info(`[STATE_DELTA] Board cell [${w.row},${w.col}]: card=${((C=w.card)==null?void 0:C.name)||"(empty)"}, owner=${(H=w.card)==null?void 0:H.ownerId}`)}),ne.current&&i.senderId&&x.current&&(d.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${i.senderId} to other guests`),x.current.broadcastStateDelta(I,i.senderId)),I.phaseDelta&&d.info("[STATE_DELTA] phaseDelta:",JSON.stringify(I.phaseDelta)),I.playerDeltas&&Object.entries(I.playerDeltas).forEach(([w,C])=>{d.info(`[STATE_DELTA] Player ${w} delta: handSizeDelta=${C.handSizeDelta}, deckSizeDelta=${C.deckSizeDelta}`)}),a(w=>{const C=f.current||w.localPlayerId;d.info(`[STATE_DELTA] Applying delta with localPlayerId=${C}, currentPhase before=${w.currentPhase}`);const H=Cr(w);d.info(`[STATE_DELTA] Applying delta with localPlayerId=${C}, currentPhase after=${H.currentPhase}`);try{H.gameId&&C!==null&&(Ht({gameState:H,localPlayerId:C,isHost:ne.current}),d.debug(`[STATE_DELTA] Saved state for ${ne.current?"host":"guest"} auto-restore`))}catch(z){d.warn("[STATE_DELTA] Failed to persist state:",z)}return H})}break;case"STATE_DELTA_BINARY":{ne.current||(ge.current=!0),d.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${ne.current}, senderId: ${i.senderId}, dataType=${(qr=(Kr=i.data)==null?void 0:Kr.constructor)==null?void 0:qr.name}, typeof=${typeof i.data}`);let I=null;if(i.data instanceof Uint8Array)try{I=ra(i.data),I&&d.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(I.playerDeltas||{}).length}, boardCells=${((jr=I.boardCells)==null?void 0:jr.length)||0}`)}catch(w){d.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",w)}else if(typeof i.data=="string")try{I=$o(i.data),I&&d.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${i.data.length} chars): playerDeltas=${Object.keys(I.playerDeltas||{}).length}, boardCells=${((Vr=I.boardCells)==null?void 0:Vr.length)||0}, phaseDelta=${!!I.phaseDelta}`)}catch(w){d.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",w)}else d.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof i.data}, constructor: ${(Xr=(Jr=i.data)==null?void 0:Jr.constructor)==null?void 0:Xr.name}`);I&&(ne.current&&i.senderId&&x.current&&(d.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${i.senderId} to other guests`),x.current.broadcastStateDelta(I,i.senderId)),a(w=>{const C=f.current||w.localPlayerId;d.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${C}, currentPhase before=${w.currentPhase}`);const H=Cr(w);d.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${H.currentPhase}, board has ${H.board.flat().filter(z=>z==null?void 0:z.card).length} cards`);try{H.gameId&&C!==null&&(Ht({gameState:H,localPlayerId:C,isHost:ne.current}),d.debug(`[STATE_DELTA_BINARY] Saved state for ${ne.current?"host":"guest"} auto-restore`))}catch(z){d.warn("[STATE_DELTA_BINARY] Failed to persist state:",z)}return H}));break}case"CARD_REGISTRY":if(typeof i.data=="string")try{const I=atob(i.data),w=new Uint8Array(I.length);for(let z=0;z<I.length;z++)w[z]=I.charCodeAt(z);const{deserializeCardRegistry:C}=require("../utils/gameCodec"),H=C(w);d.info(`[handleWebrtcMessage] Loaded card registry: ${H.cardDefinitions.length} cards`)}catch(I){d.error("[handleWebrtcMessage] Failed to deserialize card registry:",I)}break;case"CARD_STATE":if(typeof i.data=="string")try{const I=atob(i.data),w=new Uint8Array(I.length);for(let C=0;C<I.length;C++)w[C]=I.charCodeAt(C);a(C=>Mt(2,w,C,f.current||C.localPlayerId).gameState)}catch(I){d.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",I)}else i.data instanceof Uint8Array&&a(I=>Mt(2,i.data,I,f.current||I.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof i.data=="string")try{const I=atob(i.data),w=new Uint8Array(I.length);for(let C=0;C<I.length;C++)w[C]=I.charCodeAt(C);a(C=>{const{gameState:H}=Mt(3,w,C,f.current||C.localPlayerId);return H})}catch(I){d.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",I)}else i.data instanceof Uint8Array&&a(I=>{const{gameState:w}=Mt(3,i.data,I,f.current||I.localPlayerId);return w});break;case"SESSION_EVENT":if(typeof i.data=="string")try{const I=atob(i.data),w=new Uint8Array(I.length);for(let C=0;C<I.length;C++)w[C]=I.charCodeAt(C);a(C=>Mt(4,w,C,f.current||C.localPlayerId).gameState)}catch(I){d.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",I)}else i.data instanceof Uint8Array&&a(I=>Mt(4,i.data,I,f.current||I.localPlayerId).gameState);break;case"JOIN_REQUEST":d.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${i.senderId}, isHost: ${ne.current}`),ne.current&&i.senderId?(d.info(`Host received JOIN_REQUEST from ${i.senderId}, data:`,i.data),je(i.senderId,i.data)):d.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${ne.current}, senderId: ${i.senderId}`);break;case"ACTION":if(ne.current&&i.data){const{actionType:I,actionData:w}=i.data;if(I==="STATE_UPDATE"&&(w!=null&&w.gameState)){if(ht.current){x.current&&i.senderId&&x.current.sendToGuest(i.senderId,{type:"STATE_UPDATE",senderId:x.current.getPeerId(),data:{gameState:m.current},timestamp:Date.now()});break}a(C=>{const H=w.gameState,z=H.players.map(q=>{const le=C.players.find(Ce=>Ce.id===q.id);return le&&q.id!==f.current?{...q,deck:le.deck||q.deck,discard:le.discard||q.discard,score:le.score}:q}),R={...H,players:z};return x.current&&x.current.broadcastToGuests({type:"STATE_UPDATE",senderId:x.current.getPeerId(),data:{gameState:R},timestamp:Date.now()}),R})}else if(I==="STATE_DELTA"&&(w!=null&&w.delta))a(C=>{const H=w.delta;let z=H;ht.current&&H.playerDeltas&&(z={...H,playerDeltas:Object.fromEntries(Object.entries(H.playerDeltas).map(([q,le])=>{const Ce={...le};return delete Ce.scoreDelta,[q,Ce]}))}),f.current||C.localPlayerId;const R=Cr(C);return x.current&&x.current.broadcastStateDelta(z),R});else if(I==="NEXT_PHASE")a(C=>{const H=C,z=H.currentPhase,R=z===2&&!H.isScoringStep,q=z+1;return{...H,currentPhase:q,...R&&{isScoringStep:!0}}});else if(I==="PREV_PHASE")a(C=>{const H=C;return H.isScoringStep?{...H,isScoringStep:!1,currentPhase:Math.max(1,H.currentPhase-1)}:{...H,currentPhase:Math.max(1,H.currentPhase-1)}});else if(I==="SET_PHASE"&&(w==null?void 0:w.phaseIndex)!==void 0)a(C=>({...C,currentPhase:w.phaseIndex}));else if(I==="UPDATE_PLAYER_NAME"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.name)!==void 0)a(C=>({...C,players:C.players.map(H=>H.id===w.playerId?{...H,name:w.name}:H)}));else if(I==="CHANGE_PLAYER_COLOR"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.color)!==void 0)a(C=>({...C,players:C.players.map(H=>H.id===w.playerId?{...H,color:w.color}:H)}));else if(I==="UPDATE_PLAYER_SCORE"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.delta)!==void 0)a(C=>({...C,players:C.players.map(H=>H.id===w.playerId?{...H,score:Math.max(0,H.score+w.delta)}:H)}));else if(I==="CHANGE_PLAYER_DECK"&&(w==null?void 0:w.playerId)!==void 0){const C=w.playerId,H=w.deckType,z=w.deck;a(R=>{const q=R.players.find(fe=>fe.id===C);if(!q)return R;let le;z&&z.length>0?(d.info(`[CHANGE_PLAYER_DECK] Host received ${z.length} cards for player ${C}`),le=z.map(fe=>{if(fe.baseId){const Ie=_t(fe.baseId);if(Ie)return{...Ie,id:fe.id,baseId:fe.baseId,deck:H,ownerId:C,ownerName:q.name,power:fe.power,powerModifier:fe.powerModifier||0,isFaceDown:fe.isFaceDown||!1,statuses:fe.statuses||[]}}return{id:fe.id,baseId:fe.id,name:"Unknown",deck:H,ownerId:C,ownerName:q.name,power:fe.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(le=bt(H,C,q.name),d.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${C} with ${le.length} cards from ${H}`));const Ce={...R,players:R.players.map(fe=>fe.id===C?{...fe,selectedDeck:H,deck:le,hand:[],discard:[],announcedCard:null,boardHistory:[]}:fe)};if(x.current){const fe=le.map(Ie=>({id:Ie.id,baseId:Ie.baseId,power:Ie.power,powerModifier:Ie.powerModifier||0,isFaceDown:Ie.isFaceDown||!1,statuses:Ie.statuses||[]}));x.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:x.current.getPeerId(),playerId:C,data:{playerId:C,deckType:H,deck:fe,deckSize:fe.length},timestamp:Date.now()})}return Ce})}else if(I==="TOGGLE_ACTIVE_PLAYER"&&(w==null?void 0:w.playerId)!==void 0)a(C=>{if(!C.players.find(R=>R.id===w.playerId))return C;const z=aa(C,w.playerId);return x.current&&x.current.broadcastGameState(z),z});else if(I==="TOGGLE_AUTO_DRAW"&&(w==null?void 0:w.playerId)!==void 0)a(C=>({...C,players:C.players.map(H=>H.id===w.playerId?{...H,autoDrawEnabled:!H.autoDrawEnabled}:H)}));else if(I==="START_NEXT_ROUND")a(C=>({...C,isRoundEndModalOpen:!1,currentRound:(C.currentRound||1)+1,players:C.players.map(H=>({...H,score:0}))}));else if(I==="RESET_DEPLOY_STATUS")a(C=>{const H=C.board.map(z=>z.map(R=>{var q;return(q=R.card)!=null&&q.statuses?{...R,card:{...R.card,statuses:R.card.statuses.filter(le=>le.type!=="DeployAbilityUsed")}}:R}));return{...C,board:H,preserveDeployAbilities:!1}});else if(I==="DECK_DATA_UPDATE"&&(w==null?void 0:w.playerId)!==void 0&&(w!=null&&w.deck)){const C=w.playerId,H=w.deck,z=w.deckSize;d.info(`[ACTION] DECK_DATA_UPDATE: Received ${H.length} cards for guest ${C}`),a(R=>({...R,players:R.players.map(q=>q.id===C?{...q,deck:[...H],deckSize:z||H.length}:q)}))}else d.warn(`[ACTION] Unknown action type: ${I}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(d.info(`[PLAYER_RECONNECT] Guest ${i.playerId} reconnecting from ${i.senderId}`),ne.current&&i.playerId!==void 0&&i.senderId){const I=m.current;if(d.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(I!=null&&I.gameId)}, gameId=${I==null?void 0:I.gameId}, hasPlayers=${((Zr=I==null?void 0:I.players)==null?void 0:Zr.length)||0}`),I&&I.gameId){d.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${i.playerId}`);const w=Vo(I,i.playerId);(Qr=x.current)==null||Qr.sendToGuest(i.senderId,{type:"RECONNECT_SNAPSHOT",senderId:x.current.getPeerId(),data:w.data,timestamp:Date.now()}),d.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${i.playerId}`)}else d.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((en=i.data)==null?void 0:en.isReadyCheckActive)!==void 0||((tn=i.data)==null?void 0:tn.isPrivate)!==void 0)&&a(I=>({...I,isReadyCheckActive:i.data.isReadyCheckActive??!0,isPrivate:i.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((rn=i.data)==null?void 0:rn.isReadyCheckActive)!==void 0&&a(I=>({...I,isReadyCheckActive:i.data.isReadyCheckActive}));break;case"PLAYER_READY":ne.current&&i.playerId!==void 0?a(I=>{const w=I.players.map(R=>R.id===i.playerId?{...R,isReady:!0}:R),C={...I,players:w};d.info(`Player ${i.playerId} is ready via WebRTC`),x.current&&(x.current.broadcastGameState(C),d.info(`[PLAYER_READY] Broadcasted ready status for player ${i.playerId}`));const H=C.players.filter(R=>!R.isDummy&&!R.isDisconnected);if(H.length>0&&H.every(R=>R.isReady)&&C.isReadyCheckActive&&!C.isGameStarted){const R=C.players.filter(fe=>!fe.isDisconnected),q=Math.floor(Math.random()*R.length),le=R[q].id;let Ce={...C};return Ce.isReadyCheckActive=!1,Ce.isGameStarted=!0,Ce.startingPlayerId=le,Ce.activePlayerId=le,Ce.currentPhase=0,Ce.players=Ce.players.map(fe=>{if(fe.hand.length===0&&fe.deck.length>0){const Se=[...fe.hand],ze=[...fe.deck];for(let Ge=0;Ge<6&&Ge<ze.length;Ge++){const at=ze[0];ze.splice(0,1),Se.push(at)}return d.info(`[PLAYER_READY] Drew ${Se.length} cards for player ${fe.id}`),{...fe,hand:Se,deck:ze}}return fe}),Ce=Mr(Ce,le),d.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${Ce.currentPhase}`),x.current&&(x.current.broadcastToGuests({type:"GAME_START",senderId:x.current.getPeerId(),data:{startingPlayerId:le,activePlayerId:le,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var fe,Ie;d.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(fe=Ce.players[0])==null?void 0:fe.deck.length}, hand=${(Ie=Ce.players[0])==null?void 0:Ie.hand.length}`),d.info(`[PLAYER_READY] Broadcasting state with currentPhase=${Ce.currentPhase}`),Q(Ce)},100)),Ce}return C}):ne.current;break;case"ASSIGN_TEAMS":(nn=i.data)!=null&&nn.assignments&&a(I=>{const w=I.players.map(C=>{let H=C.teamId||1;for(const[z,R]of Object.entries(i.data.assignments))if(R.includes(C.id)){H=parseInt(z);break}return{...C,teamId:H}});return{...I,players:w}});break;case"SET_GAME_MODE":((an=i.data)==null?void 0:an.mode)!==void 0&&a(I=>({...I,gameMode:i.data.mode}));break;case"SET_GAME_PRIVACY":((on=i.data)==null?void 0:on.isPrivate)!==void 0&&a(I=>({...I,isPrivate:i.data.isPrivate}));break;case"SET_GRID_SIZE":((sn=i.data)==null?void 0:sn.size)!==void 0&&a(I=>{const w=i.data.size,C=[];for(let H=0;H<w;H++){const z=[];for(let R=0;R<w;R++)z.push({card:null});C.push(z)}return{...I,activeGridSize:w,board:C}});break;case"SET_DUMMY_PLAYER_COUNT":((dn=i.data)==null?void 0:dn.count)!==void 0&&a(I=>({...I,dummyPlayerCount:i.data.count}));break;case"HOST_READY":i.playerId!==void 0&&(d.info(`[handleWebrtcMessage] Host (player ${i.playerId}) is ready`),a(I=>{const w=I.players.map(C=>C.id===i.playerId?{...C,isReady:!0}:C);return{...I,players:w}}));break;case"GAME_START":ge.current=!0,d.info("[handleWebrtcMessage] Game starting!",i.data),m.current&&(d.info(`[GAME_START] Current phase before: ${m.current.currentPhase}`),m.current.players.forEach(I=>{d.info(`[GAME_START] Before: Player ${I.id} - deck: ${I.deck.length}, hand: ${I.hand.length}`)})),i.data&&a(I=>{d.info(`[GAME_START] Processing for localPlayerId=${f.current}`),I.players.forEach(z=>{d.info(`[GAME_START] Player ${z.id} before: deck=${z.deck.length}, hand=${z.hand.length}`)});const w=i.data.startingPlayerId??i.data.activePlayerId,C={...I,isGameStarted:i.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:w,activePlayerId:i.data.activePlayerId,currentPhase:I.currentPhase},H=C.players.find(z=>z.id===f.current);if(H&&H.hand.length===0&&H.deck.length>0){const R=[...H.hand],q=[...H.deck];for(let le=0;le<6&&le<q.length;le++){const Ce=q[0];q.splice(0,1),R.push(Ce)}C.players=C.players.map(le=>le.id===f.current?{...le,hand:R,deck:q}:le),d.info(`[GAME_START] Drew ${R.length} cards for local player ${f.current}, deck now has ${q.length} cards`)}return C.players.forEach(z=>{d.info(`[GAME_START] Player ${z.id} after: deck=${z.deck.length}, hand=${z.hand.length}`)}),d.info(`[GAME_START] Final state: currentPhase=${C.currentPhase}, activePlayerId=${C.activePlayerId}, startingPlayerId=${C.startingPlayerId}`),C});break;case"ACTIVE_PLAYER_CHANGED":d.info("[handleWebrtcMessage] Active player changed!",i.data),i.data&&a(I=>{const w={...I,activePlayerId:i.data.activePlayerId};if(i.data.currentPhase!==void 0&&(w.currentPhase=i.data.currentPhase),i.data.turnNumber!==void 0&&(w.turnNumber=i.data.turnNumber),w.currentPhase===0&&w.activePlayerId===f.current){const C=w.players.find(H=>H.id===f.current);if(C&&C.deck.length>0){const H=C.deck[0],z=[...C.deck.slice(1)],R=[...C.hand,H];w.players=w.players.map(q=>q.id===f.current?{...q,deck:z,hand:R}:q)}w.currentPhase=1}return w});break;case"SYNC_DECK_SELECTIONS":d.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",i.data),i.data&&a(I=>i.data.playerId!==void 0&&i.data.selectedDeck!==void 0?i.data.playerId===f.current?(d.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${i.data.playerId}`),I):{...I,players:I.players.map(w=>w.id===i.data.playerId?{...w,selectedDeck:i.data.selectedDeck}:w)}:i.data.deckSelections&&Array.isArray(i.data.deckSelections)?{...I,players:I.players.map(w=>{if(w.id===f.current)return w;const C=i.data.deckSelections.find(H=>H.id===w.id);return C?{...w,selectedDeck:C.selectedDeck}:w})}:I);break;case"CHANGE_PLAYER_DECK":if(d.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",i.data),!i.data||i.data.playerId===void 0)break;const Dt=i.data.playerId,Zt=i.data.deckType,Qt=i.data.deck;if(Dt===f.current)break;a(I=>{const w=I.players.find(H=>H.id===Dt);if(!w)return I;let C;return Qt&&Qt.length>0?(d.info(`[CHANGE_PLAYER_DECK] Reconstructing ${Qt.length} cards for player ${Dt}`),C=Qt.map(H=>{if(H.baseId){const z=_t(H.baseId);if(z)return{...z,id:H.id,baseId:H.baseId,deck:Zt,ownerId:Dt,ownerName:w.name,power:H.power,powerModifier:H.powerModifier||0,isFaceDown:H.isFaceDown||!1,statuses:H.statuses||[]}}return{id:H.id,baseId:H.id,name:"Unknown",deck:Zt,ownerId:Dt,ownerName:w.name,power:H.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):C=bt(Zt,Dt,w.name),{...I,players:I.players.map(H=>H.id===Dt?{...H,selectedDeck:Zt,deck:C,hand:[],discard:[],announcedCard:null,boardHistory:[]}:H)}});break;case"GAME_RESET":a(I=>{const w=i.data.activeGridSize||8,C=[];for(let R=0;R<w;R++){const q=[];for(let le=0;le<w;le++)q.push({card:null});C.push(q)}const H=(i.data.players||[]).map(R=>{if(R.isDummy&&R.hand&&R.deck&&R.discard)return{...R,boardHistory:[]};{const q=R.selectedDeck||"SynchroTech";return{...R,hand:[],deck:bt(q,R.id,R.name),discard:[],boardHistory:[]}}}),z={...I,players:H,gameMode:i.data.gameMode,isPrivate:i.data.isPrivate,activeGridSize:i.data.activeGridSize,dummyPlayerCount:i.data.dummyPlayerCount,autoAbilitiesEnabled:i.data.autoAbilitiesEnabled,isGameStarted:i.data.isGameStarted,currentPhase:i.data.currentPhase,currentRound:i.data.currentRound,turnNumber:i.data.turnNumber,activePlayerId:i.data.activePlayerId,startingPlayerId:i.data.startingPlayerId,roundWinners:i.data.roundWinners||{},gameWinner:i.data.gameWinner,isRoundEndModalOpen:i.data.isRoundEndModalOpen,isReadyCheckActive:i.data.isReadyCheckActive,board:C,targetingMode:null,floatingTexts:[]};return m.current=z,z});break;case"ABILITY_MODE_SET":(cn=i.data)!=null&&cn.abilityMode&&(a(I=>({...I,abilityMode:i.data.abilityMode})),d.info("[AbilityMode] Received ability mode from host",{playerId:i.data.abilityMode.playerId,mode:i.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":d.info("[Ability] Target selected",i.data);break;case"ABILITY_COMPLETED":a(I=>({...I,abilityMode:null})),d.info("[Ability] Ability completed",i.data);break;case"ABILITY_CANCELLED":a(I=>({...I,abilityMode:null}));break;case"TRIGGER_HIGHLIGHT":if((ln=i.data)!=null&&ln.highlightData){const I=i.data.highlightData;P(I),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:i.senderId,data:I,timestamp:Date.now()},i.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(i.data){const I=(un=x.current)==null?void 0:un.getPeerId();i.senderId!==I&&P(i.data)}break;case"TRIGGER_FLOATING_TEXT":if((fn=i.data)!=null&&fn.textData){const I=i.data.textData;a(w=>({...w,floatingTexts:[...w.floatingTexts,I].filter(C=>Date.now()-C.timestamp<be.FLOATING_TEXT_DURATION)})),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:i.senderId,data:I,timestamp:Date.now()},i.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((pn=i.data)!=null&&pn.batch){const I=i.data.batch;a(w=>({...w,floatingTexts:[...w.floatingTexts,...I].filter(C=>Date.now()-C.timestamp<be.FLOATING_TEXT_DURATION)})),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:i.senderId,data:{batch:I},timestamp:Date.now()},i.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const I=(yn=x.current)==null?void 0:yn.getPeerId();(hn=i.data)!=null&&hn.batch&&i.senderId!==I?a(w=>({...w,floatingTexts:[...w.floatingTexts,...i.data.batch].filter(C=>Date.now()-C.timestamp<be.FLOATING_TEXT_DURATION)})):(In=i.data)!=null&&In.textData&&i.senderId!==I&&a(w=>({...w,floatingTexts:[...w.floatingTexts,i.data.textData].filter(C=>Date.now()-C.timestamp<be.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((En=i.data)!=null&&En.coords){const I=i.data.coords,w=i.data.timestamp;T({coords:I,timestamp:w}),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:i.senderId,data:{coords:I,timestamp:w},timestamp:Date.now()},i.senderId)}break;case"NO_TARGET_TRIGGERED":if((Tn=i.data)!=null&&Tn.coords){const I=(mn=x.current)==null?void 0:mn.getPeerId();i.senderId!==I&&T({coords:i.data.coords,timestamp:i.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(i.data){const I=i.data;g(w=>[...w,I]),setTimeout(()=>{g(w=>w.filter(C=>C.timestamp!==I.timestamp))},1e3),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:i.senderId,data:I,timestamp:Date.now()},i.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(i.data){const I=i.data;S(w=>[...w,I]),setTimeout(()=>{S(w=>w.filter(C=>C.timestamp!==I.timestamp))},1e3),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:i.senderId,data:I,timestamp:Date.now()},i.senderId)}break;case"TRIGGER_TARGET_SELECTION":if(i.data){const I=i.data;Y(w=>[...w,I]),setTimeout(()=>{Y(w=>w.filter(C=>C.timestamp!==I.timestamp))},1e3),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"TARGET_SELECTION_TRIGGERED",senderId:i.senderId,data:I,timestamp:Date.now()},i.senderId)}break;case"TARGET_SELECTION_TRIGGERED":i.data&&i.senderId!==((gn=x.current)==null?void 0:gn.getPeerId())&&(Y(I=>[...I,i.data]),setTimeout(()=>{Y(I=>I.filter(w=>w.timestamp!==i.data.timestamp))},1e3));break;case"DECK_SELECTION_TRIGGERED":i.data&&i.senderId!==((wn=x.current)==null?void 0:wn.getPeerId())&&(g(I=>[...I,i.data]),setTimeout(()=>{g(I=>I.filter(w=>w.timestamp!==i.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":i.data&&i.senderId!==((_n=x.current)==null?void 0:_n.getPeerId())&&(S(I=>[...I,i.data]),setTimeout(()=>{S(I=>I.filter(w=>w.timestamp!==i.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((Cn=i.data)!=null&&Cn.targetingMode){const I=i.data.targetingMode;a(w=>({...w,targetingMode:I})),m.current.targetingMode=I,d.info("[TargetingMode] Received targeting mode via WebRTC",{playerId:I.playerId,mode:I.action.mode})}break;case"CLEAR_TARGETING_MODE":a(I=>({...I,targetingMode:null})),m.current.targetingMode=null;break;case"SYNC_VALID_TARGETS":((bn=i.data)==null?void 0:bn.playerId)!==f.current&&(te({playerId:i.data.playerId,validHandTargets:i.data.validHandTargets||[],isDeckSelectable:i.data.isDeckSelectable||!1}),setTimeout(()=>{te(I=>(I==null?void 0:I.playerId)===i.data.playerId?null:I)},1e4));break;case"RECONNECT_ACCEPT":if((An=i.data)!=null&&An.gameState){const I=i.data.gameState;a(I),N("Connected"),d.info(`[Reconnection] State restored with ${((Sn=I.players)==null?void 0:Sn.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(w){d.warn("[Reconnection] Failed to clear stored data:",w)}}break;case"RECONNECT_REJECT":{const I=((Dn=i.data)==null?void 0:Dn.reason)||"unknown";d.warn(`[Reconnection] Reconnection rejected: ${I}`),N("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((Rn=i.data)==null?void 0:Rn.playerId)!==void 0&&(d.info(`[Reconnection] Player ${i.data.playerId} disconnected, reconnection window open`),a(I=>({...I,players:I.players.map(w=>w.id===i.data.playerId?{...w,isDisconnected:!0}:w)})));break;case"PLAYER_RECONNECTED":((On=i.data)==null?void 0:On.playerId)!==void 0&&(d.info(`[Reconnection] Player ${i.data.playerId} reconnected`),a(I=>({...I,players:I.players.map(w=>w.id===i.data.playerId?{...w,isDisconnected:!1}:w)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((Pn=i.data)==null?void 0:Pn.playerId)!==void 0&&(d.info(`[Reconnection] Player ${i.data.playerId} converted to dummy`),a(I=>({...I,players:I.players.map(w=>w.id===i.data.playerId?{...w,isDummy:!0,isDisconnected:!0}:w)})));break;case"REQUEST_DECK_VIEW":if(ne.current&&((kn=i.data)==null?void 0:kn.targetPlayerId)!==void 0){const I=i.data.targetPlayerId;i.playerId;const w=r.players.find(C=>C.id===I);if(w&&x.current){let C=[];I===f.current||w.isDummy?(d.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${w.deck.length} cards, first card baseId: ${(vn=w.deck[0])==null?void 0:vn.baseId}`),C=w.deck.map(R=>({id:R.id,baseId:R.baseId,deck:R.deck,power:R.power,powerModifier:R.powerModifier,isFaceDown:R.isFaceDown,statuses:R.statuses||[]}))):w.deckCards&&w.deckCards.length>0?C=w.deckCards:C=w.deck.map(R=>({id:R.id,baseId:R.baseId,power:R.power,powerModifier:R.powerModifier,isFaceDown:R.isFaceDown,statuses:R.statuses||[]}));const H={targetPlayerId:I,deckCards:C,deckSize:C.length},z={type:"DECK_VIEW_DATA",senderId:x.current.getPeerId(),data:H,timestamp:Date.now()};x.current.sendToGuest(i.senderId||"",z),d.info(`[REQUEST_DECK_VIEW] Sent ${H.deckCards.length} cards for player ${I}`)}}break;case"DECK_VIEW_DATA":if(((Nn=i.data)==null?void 0:Nn.targetPlayerId)!==void 0&&((Ln=i.data)!=null&&Ln.deckCards)){const I=i.data.targetPlayerId,w=i.data.deckCards;d.info(`[DECK_VIEW_DATA] Received ${w.length} deck cards for player ${I}`);const C=z=>{if(z.baseId){const q=_t(z.baseId);if(q)return{...q,id:z.id,baseId:z.baseId,deck:z.deck||Ke.SynchroTech,ownerId:I,power:z.power,powerModifier:z.powerModifier,isFaceDown:z.isFaceDown,statuses:z.statuses||[]};d.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${z.baseId}`)}else d.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${z.id}`);return{id:z.id,baseId:z.baseId||z.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:z.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:Ke.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}},H=w.map(C);a(z=>({...z,players:z.players.map(R=>R.id===I?{...R,deck:H}:R)}))}break;case"DECK_DATA_UPDATE":if(ne.current&&i.playerId!==void 0&&((Mn=i.data)!=null&&Mn.deck)){const I=i.playerId,w=i.data.deck,C=i.data.deckSize;d.info(`[DECK_DATA_UPDATE] Received ${w.length} cards for guest ${I}, deckSize=${C}`),a(H=>({...H,players:H.players.map(z=>z.id===I?{...z,deck:[...w],deckSize:C}:z)}))}break;case"REQUEST_DECK_DATA":if(!ne.current&&x.current){const I=r.players.find(w=>w.id===f.current);if(I&&I.deck.length>0){d.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${I.deck.length} cards`);const w=I.deck.map(C=>({id:C.id,baseId:C.baseId,power:C.power,powerModifier:C.powerModifier||0,isFaceDown:C.isFaceDown||!1,statuses:C.statuses||[]}));x.current.sendAction("DECK_DATA_UPDATE",{playerId:f.current,deck:w,deckSize:w.length})}}break;default:d.warn(`[handleWebrtcMessage] Unknown message type: ${i.type}`,i);break}},[Re,bt,Q,r,c]),j=$.useCallback(i=>{if(!x.current||Nt)return;Xe(!0),N("Connecting");const oe=3e4,U=1e3;let B=0;const J=oe/U;try{const ce={hostPeerId:i,playerId:c,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ce))}catch(ce){d.error("[Reconnection] Failed to store data:",ce)}const ie=async()=>{B++;const ce=Math.max(0,oe-B*U);if(ct({attempt:B,maxAttempts:J,timeRemaining:ce}),ce<=0){d.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Xe(!1),ct(null),Gt();return}let Z=i;if(r!=null&&r.gameId){const Pe=Er(r.gameId);if(Pe&&Pe.peerId!==i){Z=Pe.peerId;try{const We={hostPeerId:Z,playerId:c,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(We))}catch(We){d.error("[Reconnection] Failed to update reconnection data:",We)}}}try{const Pe=c||f.current;Pe!==null?(d.info(`[Reconnection] Reconnecting as existing player ${Pe} to host ${Z}`),await x.current.initializeAsReconnectingGuest(Z,Pe)):(d.info("[Reconnection] No playerId, connecting as new player"),await x.current.initializeAsGuest(Z)),d.info("[Reconnection] Successfully reconnected!"),Xe(!1),ct(null)}catch(Pe){d.warn("[Reconnection] Reconnection attempt failed:",Pe),setTimeout(ie,U)}};ie()},[Nt,r,c]),M=$.useCallback(i=>{a(oe=>{if(!oe)return d.error("[updateState] prevState is undefined, skipping update"),oe;const U=typeof i=="function"?i(oe):i;if(!U)return d.error("[updateState] newState is undefined, skipping update"),oe;const B=!oe.gameId&&U.gameId;if(!ge.current&&!B)return U;if(ye&&x.current){if(ne.current){if(x.current.broadcastGameState(U),d.info(`[updateState] Host broadcast state: phase=${U.currentPhase}, activePlayer=${U.activePlayerId}`),U.gameId&&f.current!==null)try{Ht({gameState:U,localPlayerId:f.current,isHost:!0}),d.debug("[updateState] Saved game state for host auto-restore")}catch(J){d.warn("[updateState] Failed to save game state:",J)}}else x.current&&(x.current.sendStateToHost(U,f.current),d.info(`[updateState] Guest sent state to host: phase=${U.currentPhase}, activePlayer=${U.activePlayerId}`));return U}if(we.current&&we.current.readyState===WebSocket.OPEN){const J={type:"UPDATE_STATE",gameState:U};X.current&&(J.playerToken=X.current),we.current.send(JSON.stringify(J))}return U})},[ye,Re,Q]),W=ns({ws:we,webrtcManager:x,gameStateRef:m,webrtcIsHostRef:ne,setGameState:a,updateState:M}),K=as({ws:we,webrtcManager:x,gameStateRef:m,localPlayerIdRef:f,webrtcIsHostRef:ne,setGameState:a}),ue=os({updateState:M}),me=ss({updateState:M}),se=is({localPlayerIdRef:f,updateState:M}),{addBoardCardStatus:re,removeBoardCardStatus:de,removeBoardCardStatusByOwner:he,modifyBoardCardPower:ae,addAnnouncedCardStatus:De,removeAnnouncedCardStatus:Oe,modifyAnnouncedCardPower:_e,addHandCardStatus:it,removeHandCardStatus:ft,revealHandCard:dt,revealBoardCard:gt,requestCardReveal:yt,respondToRevealRequest:pt,removeRevealedStatus:ur}=se,Tt=ds({webrtcIsHostRef:ne,sendWebrtcAction:et,webrtcManagerRef:x,localPlayerIdRef:f,getCardDefinition:_t,commandCardIds:ho,createDeck:bt,updateState:M}),{changePlayerDeck:da,loadCustomDeck:ca,resurrectDiscardedCard:la,reorderTopDeck:ua,reorderCards:fa,recoverDiscardedCard:pa}=Tt,ya=cs({ws:we,webrtcManagerRef:x,webrtcIsHostRef:ne,gameStateRef:m,scoreDeltaAccumulator:Ct,setGameState:a,updateState:M,abilityMode:t,setAbilityMode:n,createDeck:bt}),{toggleActivePlayer:ha,toggleAutoDraw:Ia,setPhase:Ea,nextPhase:Ta,prevPhase:ma,closeRoundEndModal:ga,closeRoundEndModalOnly:wa,resetGame:_a}=ya,St=$.useCallback(()=>{if(localStorage.getItem("webrtc_enabled")==="true"){N("Connected");return}if(p.current||we.current&&(we.current.readyState===WebSocket.OPEN||we.current.readyState===WebSocket.CONNECTING))return;const i=es();if(!i){d.warn("No WebSocket URL configured in settings. Waiting for user input."),N("Disconnected"),tt.current&&clearTimeout(tt.current);return}try{we.current=new WebSocket(i)}catch(oe){console.error("Failed to create WebSocket:",oe),N("Disconnected"),tt.current&&clearTimeout(tt.current),tt.current=window.setTimeout(St,be.RECONNECT_DELAY);return}N("Connecting"),we.current.onopen=()=>{var B;ge.current=!1,N("Connected");const oe=localStorage.getItem("custom_ws_url");oe&&oe.trim()!==""&&localStorage.setItem("websocket_url",oe.trim());const U=m.current;if(d.info("Current gameState on open:",U?`gameId=${U.gameId}`:"null"),d.info("playerTokenRef.current on open:",X.current?"YES":"NO"),U&&U.gameId&&((B=we.current)==null?void 0:B.readyState)===WebSocket.OPEN){let J=X.current;if(!J){try{const ie=localStorage.getItem(Ot);if(ie){const ce=JSON.parse(ie);d.info("RECONNECTION_DATA_KEY:",ce==null?void 0:ce.gameId,U.gameId),ce!=null&&ce.playerToken&&(J=ce.playerToken,X.current=J,d.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(ie){console.warn("Failed to parse reconnection data:",ie instanceof Error?ie.message:String(ie))}if(!J&&U.players&&f.current){const ie=U.players.find(ce=>ce.id===f.current);ie!=null&&ie.playerToken&&(J=ie.playerToken,X.current=J)}}d.info("JoinGame: Sending reconnection with token:",J?"YES":"NO","gameId:",U.gameId),we.current.send(JSON.stringify({type:"JOIN_GAME",gameId:U.gameId,playerToken:J}))}},we.current.onmessage=oe=>{try{const U=JSON.parse(oe.data);if(U.type==="GAMES_LIST")E(U.games);else if(U.type==="JOIN_SUCCESS"){if(U.isSpectator){u(null),d.info("Joined as spectator:",U.message||"Spectator mode"),mt.current=null;return}u(U.playerId);const B=mt.current||m.current.gameId;B&&U.playerId!==null&&U.playerToken?(X.current=U.playerToken,localStorage.setItem(Ot,JSON.stringify({gameId:B,playerId:U.playerId,playerToken:U.playerToken,timestamp:Date.now()})),m.current.gameId===B&&Hn(m.current,U.playerId,U.playerToken)):U.playerId===null&&(Ut(),X.current=void 0),mt.current=null,U.playerId===1&&setTimeout(()=>{var J;((J=we.current)==null?void 0:J.readyState)===WebSocket.OPEN&&we.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:It}))},be.DECK_SYNC_DELAY)}else if(U.type==="CONNECTION_ESTABLISHED"){d.info("Connection acknowledged by server");const B=sessionStorage.getItem("pending_invite_game"),J=sessionStorage.getItem("pending_invite_name");B&&we.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),d.info("Auto-joining invite game:",B),we.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:B,playerName:J||"Player"})))}else if(U.type==="DECK_DATA_UPDATED")d.info("Deck data synced with server");else if(U.type==="ERROR")if(U.message.includes("not found")||U.message.includes("Dummy")){d.info("Game not found error - clearing state");const B=Rt();a(B),m.current=B,u(null),Ut(),mt.current=null}else if(U.message.includes("already started")&&G.current){d.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const B=Rt();a(B),m.current=B,u(null),Ut(),mt.current=null,G.current=!1}else console.warn("Server Error:",U.message);else if(U.type==="HIGHLIGHT_TRIGGERED")P(U.highlightData);else if(U.type==="NO_TARGET_TRIGGERED")T({coords:U.coords,timestamp:U.timestamp});else if(U.type==="DECK_SELECTION_TRIGGERED")g(B=>[...B,U.deckSelectionData]),setTimeout(()=>{g(B=>B.filter(J=>J.timestamp!==U.deckSelectionData.timestamp))},1e3);else if(U.type==="HAND_CARD_SELECTION_TRIGGERED")S(B=>[...B,U.handCardSelectionData]),setTimeout(()=>{S(B=>B.filter(J=>J.timestamp!==U.handCardSelectionData.timestamp))},1e3);else if(U.type==="FLOATING_TEXT_TRIGGERED")a(B=>({...B,floatingTexts:[...B.floatingTexts,U.floatingTextData].filter(J=>Date.now()-J.timestamp<be.FLOATING_TEXT_DURATION)}));else if(U.type==="FLOATING_TEXT_BATCH_TRIGGERED")a(B=>({...B,floatingTexts:[...B.floatingTexts,...U.batch].filter(J=>Date.now()-J.timestamp<be.FLOATING_TEXT_DURATION)}));else if(U.type==="SYNC_VALID_TARGETS")U.playerId!==f.current&&(te({playerId:U.playerId,validHandTargets:U.validHandTargets||[],isDeckSelectable:U.isDeckSelectable||!1}),setTimeout(()=>{te(B=>(B==null?void 0:B.playerId)===U.playerId?null:B)},1e4));else if(U.type==="TARGET_SELECTION_TRIGGERED")U.effect&&U.playerId!==f.current&&(Y(B=>[...B,U.effect]),setTimeout(()=>{Y(B=>B.filter(J=>J.timestamp!==U.effect.timestamp))},1e3));else if(U.type==="TARGETING_MODE_SET"){const B=U.targetingMode;B&&(a(J=>({...J,targetingMode:B})),m.current.targetingMode=B,d.info("[TargetingMode] Received targeting mode from server",{playerId:B.playerId,mode:B.action.mode}))}else if(U.type==="TARGETING_MODE_CLEARED")a(B=>({...B,targetingMode:null})),m.current.targetingMode=null,d.debug("[TargetingMode] Cleared targeting mode from server");else if(U.type==="ABILITY_MODE_SET")U.abilityMode&&(a(B=>({...B,abilityMode:U.abilityMode})),d.info("[AbilityMode] Received ability mode from host",{playerId:U.abilityMode.playerId,mode:U.abilityMode.mode,sourceCard:U.abilityMode.sourceCardName}));else if(U.type==="ABILITY_TARGET_SELECTED")d.info("[Ability] Target selected",U.data);else if(U.type==="ABILITY_COMPLETED")a(B=>({...B,abilityMode:null})),d.info("[Ability] Ability completed",U.data);else if(U.type==="ABILITY_CANCELLED")a(B=>({...B,abilityMode:null})),d.info("[Ability] Ability cancelled");else if(U.type==="GAME_RESET")d.info("[GameReset] Received GAME_RESET message from server"),a(B=>{const J=U.activeGridSize||8,ie=[];for(let Z=0;Z<J;Z++){const Pe=[];for(let We=0;We<J;We++)Pe.push({card:null});ie.push(Pe)}const ce={...B,players:U.players||[],gameMode:U.gameMode,isPrivate:U.isPrivate,activeGridSize:U.activeGridSize,dummyPlayerCount:U.dummyPlayerCount,autoAbilitiesEnabled:U.autoAbilitiesEnabled,isGameStarted:U.isGameStarted,currentPhase:U.currentPhase,currentRound:U.currentRound,turnNumber:U.turnNumber,activePlayerId:U.activePlayerId,startingPlayerId:U.startingPlayerId,roundWinners:U.roundWinners||{},gameWinner:U.gameWinner,isRoundEndModalOpen:U.isRoundEndModalOpen,isReadyCheckActive:U.isReadyCheckActive,board:ie,targetingMode:null,floatingTexts:[]};return m.current=ce,ce});else if(!U.type&&U.players&&U.board){const B=qt(U),J=m.current;if(!J.isScoringStep&&B.isScoringStep&&B.currentPhase!==2){d.debug("Ignoring delayed scoring state update");return}if(J.isScoringStep&&(B.currentPhase!==J.currentPhase||B.activePlayerId!==J.activePlayerId||B.currentPhase!==4)&&(B.isScoringStep=!1),a(B),m.current=B,f.current!==null&&B.gameId){let ce;try{const Z=localStorage.getItem(Ot);Z&&(ce=JSON.parse(Z).playerToken)}catch{}if(!ce&&B.players){const Z=B.players.find(Pe=>Pe.id===f.current);Z!=null&&Z.playerToken&&(ce=Z.playerToken,X.current=ce)}Hn(B,f.current,ce)}}else console.warn("Unknown message type:",U.type,"keys:",Object.keys(U),"data:",U)}catch(U){console.error("Failed to parse message from server:",oe.data,U)}},we.current.onclose=()=>{N("Disconnected"),p.current||(tt.current&&clearTimeout(tt.current),tt.current=window.setTimeout(St,be.RECONNECT_DELAY))},we.current.onerror=oe=>console.error("WebSocket error event:",oe)},[a,Rt]),Ca=$.useCallback((i,oe="Player")=>{var U;p.current=!1,((U=we.current)==null?void 0:U.readyState)===WebSocket.OPEN?we.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:i,playerName:oe})):(sessionStorage.setItem("pending_invite_game",i),sessionStorage.setItem("pending_invite_name",oe),St())},[St]);$.useEffect(()=>{p.current=!1;const i=sessionStorage.getItem("invite_game_id"),oe=sessionStorage.getItem("invite_host_id");if(i&&!oe)return St(),()=>{p.current=!0,tt.current&&clearTimeout(tt.current),we.current&&(we.current.onclose=null,we.current.close())};if(i&&oe)return()=>{p.current=!0,tt.current&&clearTimeout(tt.current),we.current&&(we.current.onclose=null,we.current.close())};const U=performance.getEntriesByType("navigation"),B=U.length>0?U[0]:null,J=(B==null?void 0:B.type)??0,ie=Qo();return ie&&(d.info(`Restoring saved game state (nav type: ${J}):`,ie.gameState.gameId),a(ie.gameState),u(ie.localPlayerId),m.current=ie.gameState,f.current=ie.localPlayerId,X.current=ie.playerToken),St(),()=>{p.current=!0,tt.current&&clearTimeout(tt.current),we.current&&(we.current.onclose=null,we.current.close())}},[]),$.useEffect(()=>{if(It&&m.current&&m.current.gameId){const i=qt(m.current);i!==m.current&&(a(i),m.current=i)}},[]),$.useEffect(()=>{if(ee)return;const i=setInterval(()=>{if(It&&m.current&&m.current.gameId){const oe=qt(m.current);a({...oe}),m.current=oe,pe(!0),clearInterval(i)}},100);return()=>clearInterval(i)},[ee]);const{startReadyCheck:ba,cancelReadyCheck:Aa,playerReady:Sa}=K,{updatePlayerName:Da,changePlayerColor:Ra}=ue,{drawCard:Oa,drawCardsBatch:Pa,shufflePlayerDeck:ka,flipBoardCard:va,flipBoardCardFaceDown:Na}=me,{assignTeams:La,setGameMode:Ma,setGamePrivacy:Ga,setActiveGridSize:xa,setDummyPlayerCount:Ua}=W,$a=$.useCallback(()=>{var i;if(((i=we.current)==null?void 0:i.readyState)===WebSocket.OPEN&&m.current.gameId&&f.current===1){we.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:It}));const oe=m.current,U=Ue(oe);U.players.forEach(B=>{if(["hand","deck","discard"].forEach(ie=>{B[ie]&&(B[ie]=B[ie].map(ce=>{const Z=yr(ce.name);return Z?{...ce,...Z}:ce}))}),B.announcedCard){const ie=yr(B.announcedCard.name);ie&&(B.announcedCard={...B.announcedCard,...ie})}}),U.board.forEach(B=>{B.forEach(J=>{if(J.card){const ie=yr(J.card.name);ie&&(J.card={...J.card,...ie})}})}),we.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:U})),a(U)}},[]),fr=$.useCallback((i,oe)=>{var J;const U=m.current;if(!U.isGameStarted){d.warn("[ScoreUpdate] Blocked: game not started");return}if(U.isRoundEndModalOpen){d.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(oe===0)return;const B=localStorage.getItem("webrtc_enabled")==="true";if(B?M(ie=>({...ie,players:ie.players.map(ce=>ce.id===i?{...ce,score:Math.max(0,(ce.score||0)+oe)}:ce)})):a(ie=>({...ie,players:ie.players.map(ce=>ce.id===i?{...ce,score:Math.max(0,(ce.score||0)+oe)}:ce)})),!B){if(((J=we.current)==null?void 0:J.readyState)!==WebSocket.OPEN){d.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const ie=Ct.get(i);if(ie){clearTimeout(ie.timerId);const ce=ie.delta+oe,Z=setTimeout(()=>{var We;const Pe=Ct.get(i);Pe&&((We=we.current)==null?void 0:We.readyState)===WebSocket.OPEN&&(d.info(`[ScoreUpdate] Sending accumulated delta: player=${i}, delta=${Pe.delta}`),we.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:m.current.gameId,playerId:i,delta:Pe.delta}))),Ct.delete(i)},500);Ct.set(i,{delta:ce,timerId:Z})}else{const ce=setTimeout(()=>{var Pe;const Z=Ct.get(i);Z&&((Pe=we.current)==null?void 0:Pe.readyState)===WebSocket.OPEN&&(d.info(`[ScoreUpdate] Sending delta: player=${i}, delta=${Z.delta}`),we.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:m.current.gameId,playerId:i,delta:Z.delta}))),Ct.delete(i)},500);Ct.set(i,{delta:oe,timerId:ce})}}},[a,M]),{triggerHighlight:Ha,triggerFloatingText:xr,triggerNoTarget:Fa,triggerDeckSelection:Wa,triggerHandCardSelection:Ba,syncValidTargets:Ya,triggerTargetSelection:za}=Ye,Ka=ls({ws:we,gameStateRef:m,updateState:M,updatePlayerScore:fr,triggerFloatingText:xr}),{scoreLine:qa,scoreDiagonal:ja}=Ka,wt=us({updateState:M,rawJsonData:It}),Va=fs({updateState:M,localPlayerIdRef:f,updatePlayerScore:fr}),{moveItem:Ur}=Va,Ja=ps({ws:we,webrtcManager:x,gameStateRef:m,webrtcIsHostRef:ne,setGameState:a}),Xa=hs({ws:we,gameStateRef:m,localPlayerIdRef:f,isRestoringSessionRef:Le,isManualExitRef:p,webrtcIsHostRef:ne,receivedServerStateRef:ge,joiningGameIdRef:mt,setGameState:a,setLocalPlayerId:u,connectWebSocket:St,updateState:M}),{setTargetingMode:Za,clearTargetingMode:Qa}=Ja,{createGame:eo,joinGame:$r,exitGame:to,requestGamesList:ro,forceReconnect:no}=Xa;return{gameState:r,localPlayerId:c,setLocalPlayerId:u,draggedItem:v,setDraggedItem:y,connectionStatus:A,gamesList:_,latestHighlight:h,latestFloatingTexts:D,latestNoTarget:b,latestDeckSelections:L,latestHandCardSelections:O,joinAsInvite:Ca,startReadyCheck:ba,cancelReadyCheck:Aa,playerReady:Sa,assignTeams:La,setGameMode:Ma,setGamePrivacy:Ga,setActiveGridSize:xa,setDummyPlayerCount:Ua,updatePlayerName:Da,changePlayerColor:Ra,updatePlayerScore:fr,changePlayerDeck:da,loadCustomDeck:ca,drawCard:Oa,drawCardsBatch:Pa,shufflePlayerDeck:ka,moveItem:Ur,handleDrop:Ur,addBoardCardStatus:re,removeBoardCardStatus:de,removeBoardCardStatusByOwner:he,modifyBoardCardPower:ae,addAnnouncedCardStatus:De,removeAnnouncedCardStatus:Oe,modifyAnnouncedCardPower:_e,addHandCardStatus:it,removeHandCardStatus:ft,flipBoardCard:va,flipBoardCardFaceDown:Na,revealHandCard:dt,revealBoardCard:gt,requestCardReveal:yt,respondToRevealRequest:pt,syncGame:$a,removeRevealedStatus:ur,toggleActivePlayer:ha,toggleAutoDraw:Ia,triggerHighlight:Ha,triggerFloatingText:xr,triggerNoTarget:Fa,triggerDeckSelection:Wa,triggerHandCardSelection:Ba,triggerTargetSelection:za,targetSelectionEffects:k,syncValidTargets:Ya,remoteValidTargets:V,setTargetingMode:Za,clearTargetingMode:Qa,nextPhase:Ta,prevPhase:ma,setPhase:Ea,markAbilityUsed:wt.markAbilityUsed,applyGlobalEffect:wt.applyGlobalEffect,swapCards:wt.swapCards,transferStatus:wt.transferStatus,transferAllCounters:wt.transferAllCounters,spawnToken:wt.spawnToken,resetDeployStatus:wt.resetDeployStatus,removeStatusByType:wt.removeStatusByType,recoverDiscardedCard:pa,resurrectDiscardedCard:la,scoreLine:qa,closeRoundEndModal:ga,closeRoundEndModalOnly:wa,resetGame:_a,scoreDiagonal:ja,reorderTopDeck:ua,reorderCards:fa,updateState:M,requestDeckView:lt,sendFullDeckToHost:ut,createGame:eo,joinGame:$r,joinGameViaModal:$r,exitGame:to,requestGamesList:ro,forceReconnect:no,webrtcHostId:Fe,webrtcIsHost:Re,initializeWebrtcHost:qe,connectAsGuest:Ne,sendWebrtcAction:et,isReconnecting:Nt,reconnectProgress:At}},$s=({gameState:e,localPlayerId:t,abilityMode:n,setAbilityMode:r,cursorStack:a,setCursorStack:o,commandContext:s,setCommandContext:c,setViewingDiscard:u,triggerNoTarget:m,triggerTargetSelection:f,setPlayMode:v,setCounterSelectionData:y,interactionLock:A,onAbilityComplete:N,updateState:_,moveItem:E,drawCard:h,drawCardsBatch:P,updatePlayerScore:D,markAbilityUsed:l,applyGlobalEffect:b,swapCards:T,transferStatus:L,transferAllCounters:g,resurrectDiscardedCard:O,spawnToken:S,scoreLine:k,nextPhase:Y,modifyBoardCardPower:V,addBoardCardStatus:te,removeBoardCardStatus:ee,removeBoardCardStatusByOwner:pe,resetDeployStatus:ye,scoreDiagonal:Te,removeStatusByType:Fe,triggerFloatingText:ve,triggerHandCardSelection:Re,clearValidTargets:st,setTargetingMode:ne,clearTargetingMode:Nt})=>{const Xe=$.useCallback((p,G)=>{var ge,x,Me,Be,qe,Ne,et,lt,ut,Ye,Le,Je,je;if(p.type==="ABILITY_COMPLETE"){N==null||N();return}if(p.type==="REVEREND_SETUP_SCORE"){const Q=((ge=p.sourceCard)==null?void 0:ge.ownerId)??0;let F=0;for(let j=0;j<e.board.length;j++)for(let M=0;M<e.board[j].length;M++){const W=(x=e.board[j][M])==null?void 0:x.card;if(W!=null&&W.statuses){const K=W.statuses.filter(ue=>ue.type==="Exploit"&&ue.addedByPlayerId===Q);F+=K.length}}F>0?(D(Q,F),ve([{row:G.row,col:G.col,text:`+${F}`,playerId:Q}])):ve([{row:G.row,col:G.col,text:"+0",playerId:Q}]),l(G,!!p.isDeployAbility,!1,p.readyStatusToRemove);return}if(p.type==="GLOBAL_AUTO_APPLY"){if(((Me=p.payload)==null?void 0:Me.customAction)==="FINN_SCORING"){let Q=0;const F=(Be=p.sourceCard)==null?void 0:Be.ownerId;if(F===void 0){console.warn("[FINN_SCORING] Source card missing ownerId, skipping scoring"),l(p.sourceCoords||G,!!p.isDeployAbility,!1,p.readyStatusToRemove);return}if(e.players.forEach(j=>{j.id!==F&&j.hand.forEach(M=>{var W;(W=M.statuses)!=null&&W.some(K=>K.type==="Revealed"&&K.addedByPlayerId===F)&&Q++})}),e.board.forEach(j=>{j.forEach(M=>{var K;const W=M.card;if(W&&W.ownerId!==F){const ue=((K=W.statuses)==null?void 0:K.filter(me=>me.type==="Revealed"&&me.addedByPlayerId===F).length)||0;Q+=ue}})}),Q>0){const j=p.sourceCoords||G;ve({row:j.row,col:j.col,text:`+${Q}`,playerId:F}),D(F,Q)}l(p.sourceCoords||G,!!p.isDeployAbility,!1,p.readyStatusToRemove);return}if(((qe=p.payload)==null?void 0:qe.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){p.sourceCoords&&p.sourceCoords.row>=0?Fe(p.sourceCoords,"Aim"):s.lastMovedCardCoords?Fe(s.lastMovedCardCoords,"Aim"):G&&G.row>=0&&Fe(G,"Aim");return}if(p.payload&&!p.payload.cleanupCommand){const{tokenType:Q,filter:F}=p.payload,j=[],M=e.board.length;if(p.payload.contextReward&&p.sourceCard){let W=0;const K=G&&G.row>=0?G:s.lastMovedCardCoords;if(K){const{row:ue,col:me}=K;let se=e.board[ue][me].card;const re=p.payload._tempContextId||s.lastMovedCardId;if((!se||re&&se.id!==re)&&re)for(let de=0;de<M;de++){for(let he=0;he<M;he++)if(((Ne=e.board[de][he].card)==null?void 0:Ne.id)===re){se=e.board[de][he].card;break}if(se)break}se&&(W=Math.max(0,se.power+(se.powerModifier||0)+(se.bonusPower||0)))}if(W>0){const ue=p.sourceCard.ownerId;if(ue===void 0){console.error("Cannot apply reward: sourceCard has no ownerId");return}const me=p.payload.contextReward;me==="DRAW_MOVED_POWER"||me==="DRAW_EQUAL_POWER"?P(ue,W):me==="SCORE_MOVED_POWER"&&(ve({row:G.row,col:G.col,text:`+${W}`,playerId:ue}),D(ue,W))}if(p.payload.contextReward==="STUN_MOVED_UNIT"&&K){const ue=p.sourceCard.ownerId;ue!==void 0?te(K,"Stun",ue):console.error("Cannot apply stun: sourceCard has no ownerId")}return}if(F)for(let W=0;W<M;W++)for(let K=0;K<M;K++){const ue=e.board[W][K].card;ue&&F(ue)&&j.push({row:W,col:K})}else p.sourceCoords&&p.sourceCoords.row>=0?j.push(p.sourceCoords):G&&G.row>=0?j.push(G):s.lastMovedCardCoords&&j.push(s.lastMovedCardCoords);if(j.length>0){if(Q){const W=p.payload.count||1,K=p.payload.ownerId!==void 0?p.payload.ownerId:((et=p.sourceCard)==null?void 0:et.ownerId)??t;for(let ue=0;ue<W;ue++)b(G,j,Q,K,!!p.isDeployAbility)}}else m(G),l(G,!!p.isDeployAbility,!1,p.readyStatusToRemove);return}}if(!ar(p,e,((lt=p.sourceCard)==null?void 0:lt.ownerId)||t,s)){m(G),p.chainedAction&&setTimeout(()=>{Xe(p.chainedAction,G)},500);return}if(p.type==="CREATE_STACK"&&p.tokenType){let Q=p.count||0;if(p.dynamicCount){const{factor:F,ownerId:j}=p.dynamicCount;let M=0;e.board.forEach(W=>W.forEach(K=>{var ue;if((ue=K.card)!=null&&ue.statuses){const me=K.card.statuses.filter(se=>se.type===F&&se.addedByPlayerId===j);M+=me.length}})),Q=M}Q>0?(r(null),o({type:p.tokenType,count:Q,isDragging:!1,sourceCoords:G,sourceCard:p.sourceCard,originalOwnerId:p.originalOwnerId,excludeOwnerId:p.excludeOwnerId,onlyOpponents:p.onlyOpponents,onlyFaceDown:p.onlyFaceDown,targetType:p.targetType,isDeployAbility:p.isDeployAbility,readyStatusToRemove:p.readyStatusToRemove,requiredTargetStatus:p.requiredTargetStatus,requireStatusFromSourceOwner:p.requireStatusFromSourceOwner,mustBeAdjacentToSource:p.mustBeAdjacentToSource,mustBeInLineWithSource:p.mustBeInLineWithSource,maxDistanceFromSource:p.maxDistanceFromSource,maxOrthogonalDistance:p.maxOrthogonalDistance,placeAllAtOnce:p.placeAllAtOnce,chainedAction:p.chainedAction,...p.targetOwnerId!==void 0&&{targetOwnerId:p.targetOwnerId},recordContext:p.recordContext,replaceStatus:p.replaceStatus})):m(G)}else if(p.type==="ENTER_MODE"){if(p.mode==="SHIELD_SELF_THEN_SPAWN"){te(G,"Shield",p.sourceCard.ownerId),r({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility,payload:p.payload});return}if(p.mode==="SHIELD_SELF_THEN_RIOT_PUSH"){const M=p.sourceCard.ownerId;te(G,"Shield",M);const W=e.board.length,K=Math.floor((W-e.activeGridSize)/2),ue=K,me=K+e.activeGridSize-1;let se=!1;const{row:re,col:de}=G,he=[[-1,0],[1,0],[0,-1],[0,1]];for(const[ae,De]of he){const Oe=re+ae,_e=de+De;if(Oe<ue||Oe>me||_e<ue||_e>me)continue;const it=e.board[Oe][_e];if(!it.card)continue;const ft=e.players.find(Tt=>Tt.id===it.card.ownerId),dt=e.players.find(Tt=>Tt.id===M),gt=(ft==null?void 0:ft.teamId)!==void 0&&(dt==null?void 0:dt.teamId)!==void 0&&ft.teamId===dt.teamId;if(it.card.ownerId===M||gt)continue;const yt=Oe+ae,pt=_e+De;if(yt<ue||yt>me||pt<ue||pt>me)continue;if(e.board[yt][pt].card===null){se=!0;break}}se?r({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility,payload:p.payload}):m(G);return}if(p.mode==="PRINCEPS_SHIELD_THEN_AIM"){const M=p.sourceCard.ownerId;te(G,"Shield",M);const W={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility};ar(W,e,M,s)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:G,sourceCard:p.sourceCard,originalOwnerId:p.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:p.isDeployAbility,readyStatusToRemove:p.readyStatusToRemove}):m(G);return}if(p.mode==="GAWAIN_DEPLOY_SHIELD_AIM"){const M=p.sourceCard.ownerId;te(G,"Shield",M);const W={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility};ar(W,e,M,s)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:G,sourceCard:p.sourceCard,originalOwnerId:p.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:p.isDeployAbility,readyStatusToRemove:p.readyStatusToRemove}):m(G);return}if(p.mode==="ABR_DEPLOY_SHIELD_AIM"){const M=p.sourceCard.ownerId;te(G,"Shield",M);const W={type:"CREATE_STACK",tokenType:"Aim",requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility};ar(W,e,M,s)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:G,sourceCard:p.sourceCard,originalOwnerId:p.originalOwnerId,targetOwnerId:M,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,isDeployAbility:p.isDeployAbility,readyStatusToRemove:p.readyStatusToRemove}):m(G);return}if(p.mode==="RIOT_PUSH"&&p.sourceCoords){const M=e.board.length,W=Math.floor((M-e.activeGridSize)/2),K=W,ue=W+e.activeGridSize-1;let me=!1;const{row:se,col:re}=p.sourceCoords,de=(ut=p.sourceCard)==null?void 0:ut.ownerId,he=[[-1,0],[1,0],[0,-1],[0,1]];for(const[ae,De]of he){const Oe=se+ae,_e=re+De;if(Oe<K||Oe>ue||_e<K||_e>ue)continue;const it=e.board[Oe][_e];if(!it.card||de===void 0)continue;const ft=e.players.find(Tt=>Tt.id===it.card.ownerId),dt=e.players.find(Tt=>Tt.id===de),gt=(ft==null?void 0:ft.teamId)!==void 0&&(dt==null?void 0:dt.teamId)!==void 0&&ft.teamId===dt.teamId;if(it.card.ownerId===de||gt)continue;const yt=Oe+ae,pt=_e+De;if(yt<K||yt>ue||pt<K||pt>ue)continue;if(e.board[yt][pt].card===null){me=!0;break}}if(!me){m(p.sourceCoords);return}}if(p.mode==="SELECT_TARGET"&&((Ye=p.payload)==null?void 0:Ye.actionType)==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"&&p.sourceCard){const M=p.sourceCard.ownerId,W=e.players.find(K=>K.id===M);if(W&&W.hand.length<1){m(p.sourceCoords||G);return}}if(p.mode==="SELECT_TARGET"&&((Le=p.payload)==null?void 0:Le.actionType)==="LUCIUS_SETUP"&&p.sourceCard){const M=p.sourceCard.ownerId,W=e.players.find(K=>K.id===M);if(W&&W.hand.length<1){m(p.sourceCoords||G);return}}let Q=p.sourceCard,F=G;if(p.sourceCoords&&p.sourceCoords.row>=0&&(F=p.sourceCoords),p.mode==="SELECT_CELL"&&s.lastMovedCardCoords&&s.lastMovedCardId&&((Je=p.payload)!=null&&Je.useContextCard)){const{row:M,col:W}=s.lastMovedCardCoords,K=e.board[M][W].card;K&&(Q=K,F=s.lastMovedCardCoords)}r({...p,sourceCard:Q,sourceCoords:F});const j=((je=p.sourceCard)==null?void 0:je.ownerId)??e.activePlayerId??t??1;ne(p,j,F,void 0,s)}else if(p.type==="OPEN_MODAL")if(p.mode==="RETRIEVE_DEVICE"){const Q=e.players.find(F=>{var j;return F.id===((j=p.sourceCard)==null?void 0:j.ownerId)});Q&&(u({player:Q,pickConfig:{filterType:"Device",action:"recover"}}),G.row>=0&&l(G,!!p.isDeployAbility,!1,p.readyStatusToRemove))}else if(p.mode==="IMMUNIS_RETRIEVE"){const Q=e.players.find(F=>{var j;return F.id===((j=p.sourceCard)==null?void 0:j.ownerId)});Q&&(u({player:Q,pickConfig:{filterType:"Optimates",action:"resurrect"}}),r({type:"ENTER_MODE",mode:"IMMUNIS_RETRIEVE",sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility,payload:p.payload}))}else if(p.mode==="SEARCH_DECK"){const Q=e.players.find(F=>{var j;return F.id===((j=p.sourceCard)==null?void 0:j.ownerId)});Q&&(u({player:Q,pickConfig:{filterType:p.payload.filterType||"Unit",action:"recover",isDeck:!0}}),G.row>=0&&l(G,!!p.isDeployAbility,!1,p.readyStatusToRemove))}else p.mode==="ZIUS_LINE_SELECT"?s.lastMovedCardCoords?r({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:p.sourceCard,sourceCoords:s.lastMovedCardCoords,isDeployAbility:p.isDeployAbility,payload:p.payload,chainedAction:p.chainedAction}):r({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility,payload:p.payload,chainedAction:p.chainedAction}):p.mode==="SELECT_DECK"?r({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility,payload:p.payload}):p.mode==="ZIUS_EXPLOIT_AND_SCORE"?r({type:"ENTER_MODE",mode:"ZIUS_EXPLOIT_AND_SCORE",sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility,payload:p.payload}):p.mode==="REVEREND_DOUBLE_EXPLOIT"&&r({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:p.sourceCard,sourceCoords:G,isDeployAbility:p.isDeployAbility,payload:p.payload})},[e,t,s,l,r,o,m,b,u,te,D,h,Fe,N,ve,ne]);$.useEffect(()=>{(n==null?void 0:n.type)==="GLOBAL_AUTO_APPLY"&&(Xe(n,n.sourceCoords||{row:-1,col:-1}),r(null))},[n,Xe,r]),$.useEffect(()=>{n||Nt()},[n,Nt]);const At=$.useCallback((p,G)=>{if(n||a||!e.isGameStarted||t===null)return;const X=e.players.find(Me=>Me.id===p.ownerId),ge=t===p.ownerId||(X==null?void 0:X.isDummy)&&t===1;if(e.activePlayerId!==p.ownerId||!ge||!_o(p,e)||!Dr(p,e.currentPhase,e.activePlayerId,e))return;const x=wo(p,e,p.ownerId,G);if(x){x.readyStatusToRemove&&l(G,!!x.isDeployAbility,!1,x.readyStatusToRemove);const Me={...x,chainedAction:x.chainedAction?{...x.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};Xe(Me,G)}},[n,a,e,t,Xe,l]),ct=$.useCallback(p=>{var qe,Ne,et,lt,ut;if(!n)return;const{mode:G,sourceCard:X,sourceCoords:ge,payload:x,isDeployAbility:Me,readyStatusToRemove:Be}=n;if(G==="SCORE_LAST_PLAYED_LINE"&&n.sourceCoords){if(A.current)return;const{row:Ye,col:Le}=n.sourceCoords,{row:Je,col:je}=p;if(Ye!==Je&&Le!==je)return;A.current=!0;const Q=e.activePlayerId,F=e.board.length;let j=Ye,M=Ye,W=Le,K=Le;if(Ye===Je)j=Ye,M=Ye,W=0,K=F-1;else if(Le===je)W=je,K=je,j=0,M=F-1;else{A.current=!1;return}const ue=e.board.some(re=>re.some(de=>{var he,ae;return((he=de.card)==null?void 0:he.ownerId)===Q&&de.card.name.toLowerCase().includes("data liberator")&&((ae=de.card.statuses)==null?void 0:ae.some(De=>De.type==="Support"))}));let me=0;const se=[];for(let re=j;re<=M;re++)for(let de=W;de<=K;de++){const ae=e.board[re][de].card;if(ae&&!((qe=ae.statuses)!=null&&qe.some(De=>De.type==="Stun"))){const De=ae.ownerId===Q,Oe=(Ne=ae.statuses)==null?void 0:Ne.some(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===Q);if(De||ue&&Oe&&ae.ownerId!==Q){const _e=Math.max(0,ae.power+(ae.powerModifier||0)+(ae.bonusPower||0));_e>0&&(me+=_e,se.push({row:re,col:de,text:`+${_e}`,playerId:Q}))}}}r(null),se.length>0&&ve(se),me>0&&D(Q,me),Y(),setTimeout(()=>{A.current=!1},200);return}if(G==="SELECT_LINE_START"){r({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:X,sourceCoords:ge,isDeployAbility:Me,payload:{...x,firstCoords:p}});return}if(G==="SELECT_LINE_END"&&(x!=null&&x.firstCoords)){const{row:Ye,col:Le}=x.firstCoords,{row:Je,col:je}=p;if(Ye!==Je&&Le!==je)return;const Q=x.actionType,F=(X==null?void 0:X.ownerId)??((et=e.players.find(j=>j.id===e.activePlayerId))!=null&&et.isDummy?e.activePlayerId:t||e.activePlayerId);if(Q==="ZIUS_SCORING"){const j=s.lastMovedCardCoords;if(j){const re=Ye===Je&&j.row===Ye,de=Le===je&&j.col===Le;if(!re&&!de)return}const M=e.board.length;let W=0,K=M-1,ue=0,me=M-1;if(Ye===Je)W=K=Ye;else if(Le===je)ue=me=Le;else return;let se=0;for(let re=W;re<=K;re++)for(let de=ue;de<=me;de++){const he=e.board[re][de];he.card&&(se+=((lt=he.card.statuses)==null?void 0:lt.filter(ae=>ae.type==="Exploit"&&ae.addedByPlayerId===F).length)||0)}se>0&&F&&(ge&&ve({row:ge.row,col:ge.col,text:`+${se}`,playerId:F}),D(F,se)),ge&&ge.row>=0&&l(ge,Me,!1,Be)}else if(Q==="CENTURION_BUFF"&&X&&ge&&F){const j=e.board.length;let M=0,W=j-1,K=0,ue=j-1;Ye===Je?M=W=Ye:K=ue=Le;for(let me=M;me<=W;me++)for(let se=K;se<=ue;se++){const re=e.board[me][se].card;if(re){const de=re.id===X.id,he=re.ownerId===F,ae=e.players.find(_e=>_e.id===F),De=e.players.find(_e=>_e.id===re.ownerId),Oe=(ae==null?void 0:ae.teamId)!==void 0&&(De==null?void 0:De.teamId)!==void 0&&ae.teamId===De.teamId;!de&&(he||Oe)&&V({row:me,col:se},1)}}l(ge,Me,!1,Be)}else(Q==="SCORE_LINE"||!Q)&&(k(Ye,Le,Je,je,F),x.skipNextPhase||Y());setTimeout(()=>r(null),be.MODE_CLEAR_DELAY)}if(G==="SELECT_DIAGONAL"&&x.actionType==="SCORE_DIAGONAL"){const Ye=(X==null?void 0:X.ownerId)??((ut=e.players.find(Le=>Le.id===e.activePlayerId))!=null&&ut.isDummy?e.activePlayerId:t||e.activePlayerId);if(x.firstCoords){const{row:Le,col:Je}=x.firstCoords,{row:je,col:Q}=p;if(Math.abs(Le-je)!==Math.abs(Je-Q)){r(null);return}Te(Le,Je,je,Q,Ye,x.bonusType),x.skipNextPhase||Y(),r(null);return}else{r({...n,payload:{...x,firstCoords:p}});return}}},[n,e,t,k,Y,r,V,l,Te,D,ve,s,_]),ht=$.useCallback((p,G)=>{var X,ge,x,Me,Be,qe,Ne,et,lt,ut,Ye,Le,Je,je;if(a&&v!==null&&v!==void 0){const Q={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};Pt({card:p,ownerId:p.ownerId??0,location:"board"},Q,e.activePlayerId,e.players)&&a.type==="Aim"&&(E({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Aim",count:1},{target:"board",boardCoords:G}),a.sourceCoords&&a.sourceCoords.row>=0&&l(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?o(j=>j?{...j,count:j.count-1}:null):(a.chainedAction&&Xe(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),o(null)));return}if(!A.current){if(n&&(n.mode==="SCORE_LAST_PLAYED_LINE"||n.mode==="SELECT_LINE_END")){ct(G);return}if((n==null?void 0:n.type)==="ENTER_MODE"){if(n.sourceCard&&n.sourceCard.id===p.id&&n.mode!=="SELECT_LINE_START"&&n.mode!=="INTEGRATOR_LINE_SELECT"&&n.mode!=="ZIUS_LINE_SELECT"&&n.mode!=="IP_AGENT_THREAT_SCORING"&&n.mode!=="SELECT_UNIT_FOR_MOVE"&&n.mode!=="SELECT_TARGET"&&n.mode!=="RIOT_PUSH"&&n.mode!=="RIOT_MOVE"&&n.mode!=="REVEREND_DOUBLE_EXPLOIT")return;const{mode:Q,payload:F,sourceCard:j,sourceCoords:M,isDeployAbility:W,readyStatusToRemove:K,originalOwnerId:ue,recordContext:me}=n;if(Q==="SELECT_LINE_START"||Q==="SELECT_LINE_END"){ct(G);return}const se=(j==null?void 0:j.ownerId)??((X=e.players.find(re=>re.id===e.activePlayerId))!=null&&X.isDummy?e.activePlayerId:t||e.activePlayerId);if(Q==="SELECT_TARGET"&&F.tokenType){if(F.filter&&!F.filter(p,G.row,G.col))return;if(E({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:F.tokenType,count:F.count||1},{target:"board",boardCoords:G}),f("board",G),me&&c({lastMovedCardCoords:G,lastMovedCardId:p.id}),F.chainedAction){const re={...F.chainedAction,sourceCard:F.chainedAction.sourceCard??p,sourceCoords:F.chainedAction.sourceCoords??G,isDeployAbility:W,recordContext:!0};Xe(re,G),setTimeout(()=>f("board",G),100),re.type!=="ENTER_MODE"&&r(null)}else M&&M.row>=0&&l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="OPEN_COUNTER_MODAL"){if(F.filter&&!F.filter(p))return;y({card:p,callbackAction:F.rewardType}),r(null);return}if(Q==="SELECT_TARGET"&&F.actionType==="SACRIFICE_AND_BUFF_LINES"){if(F.filter&&!F.filter(p,G.row,G.col))return;E({card:p,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"discard",playerId:p.ownerId});const re=e.board.length,{row:de,col:he}=G;for(let ae=0;ae<re;ae++){if(ae===he)continue;const Oe=e.board[de][ae].card;Oe&&(Oe.ownerId===se||((ge=e.players.find(_e=>_e.id===se))==null?void 0:ge.teamId)!==void 0&&((x=e.players.find(_e=>_e.id===Oe.ownerId))==null?void 0:x.teamId)===((Me=e.players.find(_e=>_e.id===se))==null?void 0:Me.teamId))&&V({row:de,col:ae},1)}for(let ae=0;ae<re;ae++){if(ae===de)continue;const Oe=e.board[ae][he].card;Oe&&(Oe.ownerId===se||((Be=e.players.find(_e=>_e.id===se))==null?void 0:Be.teamId)!==void 0&&((qe=e.players.find(_e=>_e.id===Oe.ownerId))==null?void 0:qe.teamId)===((Ne=e.players.find(_e=>_e.id===se))==null?void 0:Ne.teamId))&&V({row:ae,col:he},1)}M&&M.row>=0&&l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="REVEREND_DOUBLE_EXPLOIT"){if(!se)return;const re=se,de=(p.statuses||[]).filter(he=>he.type==="Exploit"&&he.addedByPlayerId===re).length;for(let he=0;he<de;he++)E({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Exploit",count:1},{target:"board",boardCoords:G});M&&M.row>=0&&l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="DESTROY"){if(F.handOnly||F.filter&&!F.filter(p,G.row,G.col))return;if(((et=p.statuses)==null?void 0:et.some(de=>de.type==="Shield"))?ee(G,"Shield"):E({card:p,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"discard",playerId:p.ownerId}),F.chainedAction){const de={...F.chainedAction,sourceCard:j,sourceCoords:M,isDeployAbility:W};Xe(de,M),de.type!=="ENTER_MODE"&&r(null)}else M&&M.row>=0&&l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="DRAW_EQUAL_POWER"){if(F.filter&&!F.filter(p))return;const re=Math.max(0,p.power+(p.powerModifier||0));for(let de=0;de<re;de++)h(se);setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="SCORE_EQUAL_POWER"){if(F.filter&&!F.filter(p))return;const re=Math.max(0,p.power+(p.powerModifier||0));M&&ve({row:M.row,col:M.col,text:`+${re}`,playerId:se}),D(se,re),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="RESET_DEPLOY"){if(F.filter&&!F.filter(p))return;ye(G),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="SHIELD_AND_REMOVE_AIM"){if(F.filter&&!F.filter(p))return;te(G,"Shield",se),Fe(G,"Aim"),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="MODIFY_POWER"){if(F.filter&&!F.filter(p))return;F.amount&&V(G,F.amount),M&&M.row>=0&&l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="RIOT_PUSH"&&M&&M.row>=0){if(G.row===M.row&&G.col===M.col){l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}const re=Math.abs(G.row-M.row)+Math.abs(G.col-M.col)===1,de=e.players.find(pt=>pt.id===p.ownerId),he=e.players.find(pt=>pt.id===se),ae=(de==null?void 0:de.teamId)!==void 0&&(he==null?void 0:he.teamId)!==void 0&&de.teamId===he.teamId;if(!re||p.ownerId===se||ae)return;const De=G.row-M.row,Oe=G.col-M.col,_e=G.row+De,it=G.col+Oe,ft=e.board.length,dt=Math.floor((ft-e.activeGridSize)/2),gt=dt,yt=dt+e.activeGridSize-1;if(_e<gt||_e>yt||it<gt||it>yt||e.board[_e][it].card!==null)return;E({card:p,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:_e,col:it}}),r({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:j,sourceCoords:M,isDeployAbility:W,payload:{vacatedCoords:G}});return}if(Q==="SWAP_POSITIONS"&&M&&M.row>=0){const re=e.board[M.row][M.col].card;if(!re||re.id!==(j==null?void 0:j.id)){r(null);return}if(j&&j.id===p.id||F.filter&&!F.filter(p,G.row,G.col))return;T(M,G),l(G,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="TRANSFER_STATUS_SELECT"&&M&&M.row>=0){if(j&&j.id===p.id||F.filter&&!F.filter(p,G.row,G.col))return;p.statuses&&p.statuses.length>0&&(L(G,M,p.statuses[0].type),l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY));return}if(Q==="TRANSFER_ALL_STATUSES"&&M&&M.row>=0){if(j&&j.id===p.id||F.filter&&!F.filter(p,G.row,G.col))return;g(G,M),l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="REVEAL_ENEMY"){if(j&&j.id===p.id||F.filter&&!F.filter(p,G.row,G.col))return;o({type:"Revealed",count:1,isDragging:!1,sourceCoords:M,sourceCard:j,originalOwnerId:ue,targetOwnerId:p.ownerId,onlyFaceDown:!0,onlyOpponents:!0,isDeployAbility:W,readyStatusToRemove:K}),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="CENSOR_SWAP"&&M&&M.row>=0){if(F.filter&&!F.filter(p))return;pe(G,"Exploit",se),te(G,"Stun",se),l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="ZEALOUS_WEAKEN"&&M&&M.row>=0){if(F.filter&&!F.filter(p))return;V(G,-1),l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="CENTURION_BUFF"&&M&&M.row>=0){l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="SELECT_UNIT_FOR_MOVE"&&M&&M.row>=0){if(F.filter&&!F.filter(p))return;r({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:p,sourceCoords:G,isDeployAbility:W,recordContext:me,originalOwnerId:se??void 0,payload:{allowSelf:!1,abilitySourceCoords:M,range:F.range,chainedAction:F.chainedAction,originalActorId:se??void 0}});return}if(Q==="SELECT_UNIT_FOR_MOVE"&&!M){if(F.filter&&!F.filter(p))return;r({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:p,sourceCoords:G,recordContext:me,originalOwnerId:se??void 0,payload:{allowSelf:!1,range:F.range,chainedAction:F.chainedAction,originalActorId:se??void 0}});return}if(Q==="INTEGRATOR_LINE_SELECT"&&M&&M.row>=0){if(G.row!==M.row&&G.col!==M.col)return;const re=e.board.length;let de=0;if(G.row===M.row)for(let he=0;he<re;he++){const ae=e.board[G.row][he];ae.card&&(de+=((lt=ae.card.statuses)==null?void 0:lt.filter(De=>De.type==="Exploit"&&De.addedByPlayerId===se).length)||0)}else for(let he=0;he<re;he++){const ae=e.board[he][G.col];ae.card&&(de+=((ut=ae.card.statuses)==null?void 0:ut.filter(De=>De.type==="Exploit"&&De.addedByPlayerId===se).length)||0)}de>0&&(ve({row:M.row,col:M.col,text:`+${de}`,playerId:se}),D(se,de)),l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="IP_AGENT_THREAT_SCORING"&&M&&M.row>=0){if(G.row!==M.row&&G.col!==M.col)return;const re=e.board.length;let de=0;if(G.row===M.row)for(let ae=0;ae<re;ae++){const De=e.board[G.row][ae];De.card&&(de+=((Ye=De.card.statuses)==null?void 0:Ye.filter(Oe=>Oe.type==="Threat"&&Oe.addedByPlayerId===se).length)||0)}else for(let ae=0;ae<re;ae++){const De=e.board[ae][G.col];De.card&&(de+=((Le=De.card.statuses)==null?void 0:Le.filter(Oe=>Oe.type==="Threat"&&Oe.addedByPlayerId===se).length)||0)}const he=de*2;he>0&&(ve({row:M.row,col:M.col,text:`+${he}`,playerId:se}),D(se,he)),l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(Q==="ZIUS_LINE_SELECT"&&M&&M.row>=0){if(G.row!==M.row&&G.col!==M.col)return;const re=e.board.length;let de=0;const he=[];if(G.row===M.row)for(let ae=0;ae<re;ae++){const De=e.board[G.row][ae];if(De.card){const Oe=((Je=De.card.statuses)==null?void 0:Je.filter(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===se).length)||0;Oe>0&&(de+=Oe,he.push({row:G.row,col:ae,text:`+${Oe}`,playerId:se,timestamp:Date.now()}))}}else for(let ae=0;ae<re;ae++){const De=e.board[ae][G.col];if(De.card){const Oe=((je=De.card.statuses)==null?void 0:je.filter(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===se).length)||0;Oe>0&&(de+=Oe,he.push({row:ae,col:G.col,text:`+${Oe}`,playerId:se,timestamp:Date.now()}))}}de>0&&(ve(he),D(se,de)),l(M,W,!1,K),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}return}!n&&!a&&At(p,G)}},[n,a,e,t,A,ct,E,l,r,o,v,ee,pe,te,V,T,L,g,D,h,At,y,ye,Fe,Xe,c,ve,f,Pt]),we=$.useCallback(p=>{var et,lt,ut,Ye,Le,Je,je,Q;if(A.current||(n==null?void 0:n.type)!=="ENTER_MODE")return;const{mode:G,sourceCoords:X,sourceCard:ge,payload:x,isDeployAbility:Me,readyStatusToRemove:Be,recordContext:qe}=n;if(G==="SCORE_LAST_PLAYED_LINE"||G==="SELECT_LINE_END"){ct(p);return}if(G==="SELECT_LINE_START"){ct(p);return}if(G==="SELECT_DIAGONAL"){ct(p);return}const Ne=(ge==null?void 0:ge.ownerId)??((et=e.players.find(F=>F.id===e.activePlayerId))!=null&&et.isDummy?e.activePlayerId:t||e.activePlayerId);if(G==="PATROL_MOVE"&&X&&ge&&X.row>=0){const F=p.row===X.row,j=p.col===X.col;if(p.row===X.row&&p.col===X.col){l(X,Me,!1,Be),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}(F||j)&&(l(X,Me,!1,Be),E({card:ge,source:"board",boardCoords:X},{target:"board",boardCoords:p}),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY));return}if(G==="RIOT_MOVE"&&X&&ge&&x.vacatedCoords){if(p.row===x.vacatedCoords.row&&p.col===x.vacatedCoords.col){E({card:ge,source:"board",boardCoords:X},{target:"board",boardCoords:p}),l(p,Me,!1,Be),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}l(X,Me,!1,Be),r(null);return}if(G==="SPAWN_TOKEN"&&X&&x.tokenName&&X.row>=0){if(Math.abs(p.row-X.row)+Math.abs(p.col-X.col)===1){const j=(ge==null?void 0:ge.ownerId)??Ne;S(p,x.tokenName,j),l(X,Me,!1,Be),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY)}return}if(G==="SELECT_CELL"&&ge){const F=(()=>{var M;if(x.moveFromHand)return null;if(X&&X.row>=0)return X;for(let W=0;W<e.board.length;W++)for(let K=0;K<e.board.length;K++)if(((M=e.board[W][K].card)==null?void 0:M.id)===ge.id)return{row:W,col:K};return null})();if(x.moveFromHand&&s.selectedHandCard){const{playerId:M,cardIndex:W}=s.selectedHandCard,K=e.players.find(me=>me.id===M),ue=K==null?void 0:K.hand[W];ue&&(E({card:ue,source:"hand",playerId:M,cardIndex:W,isManual:!0},{target:"board",boardCoords:p}),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY));return}let j=!1;if(F)if(x.range==="line")j=p.row===F.row||p.col===F.col;else if(x.range==="global")j=!0;else if(x.range===2){const M=Math.abs(p.row-F.row)+Math.abs(p.col-F.col);if(M===1)j=!0;else if(M===2){const W=F.row,K=F.col,ue=p.row,me=p.col;j=[{r:ue,c:K},{r:W,c:me},{r:(W+ue)/2,c:(K+me)/2}].some(re=>{if(!Number.isInteger(re.r)||!Number.isInteger(re.c))return!1;const de=Math.floor((e.board.length-e.activeGridSize)/2),he=de,ae=de+e.activeGridSize-1;return re.r<he||re.r>ae||re.c<he||re.c>ae||Math.abs(re.r-W)+Math.abs(re.c-K)!==1?!1:!e.board[re.r][re.c].card})}}else j=Math.abs(p.row-F.row)+Math.abs(p.col-F.col)===1;if(j&&F){const M=x.allowSelf&&p.row===F.row&&p.col===F.col;if(!M){const W=e.board[F.row][F.col].card;W&&E({card:W,source:"board",boardCoords:F,bypassOwnershipCheck:!0},{target:"board",boardCoords:p})}if(qe&&c({lastMovedCardCoords:p,lastMovedCardId:ge.id}),x.chainedAction){const W={...x.chainedAction};W.targetOwnerId===-2&&(W.targetOwnerId=ge.ownerId),qe&&(W.payload||(W.payload={}),W.payload._tempContextId=ge.id),r(null),st(),setTimeout(()=>{Xe(W,p)},1)}else{if(x.abilitySourceCoords)l(x.abilitySourceCoords,Me,!1,Be);else{const W=M?X:p;W&&W.row>=0&&(x.originalActorId===void 0||ge.ownerId===x.originalActorId)&&l(W,Me,!1,Be)}setTimeout(()=>r(null),be.MODE_CLEAR_DELAY)}return}return}if(G==="IMMUNIS_RETRIEVE"&&X&&X.row>=0){if(x.selectedCardIndex!==void 0&&((lt=x.filter)!=null&&lt.call(x,p.row,p.col))){O(Ne,x.selectedCardIndex,p),l(X,Me,!1,Be),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(x.selectedCardIndex===void 0)return}if(G==="INTEGRATOR_LINE_SELECT"&&X&&X.row>=0){if(p.row!==X.row&&p.col!==X.col)return;const F=e.board.length;let j=0;if(p.row===X.row)for(let M=0;M<F;M++){const W=e.board[p.row][M];W.card&&(j+=((ut=W.card.statuses)==null?void 0:ut.filter(K=>K.type==="Exploit"&&K.addedByPlayerId===Ne).length)||0)}else for(let M=0;M<F;M++){const W=e.board[M][p.col];W.card&&(j+=((Ye=W.card.statuses)==null?void 0:Ye.filter(K=>K.type==="Exploit"&&K.addedByPlayerId===Ne).length)||0)}j>0&&(ve({row:X.row,col:X.col,text:`+${j}`,playerId:Ne}),D(Ne,j)),l(X,Me,!1,Be),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(G==="ZIUS_LINE_SELECT"&&X&&X.row>=0){if(p.row!==X.row&&p.col!==X.col)return;const F=e.board.length;let j=0;const M=[];if(p.row===X.row)for(let W=0;W<F;W++){const K=e.board[p.row][W];if(K.card){const ue=((Le=K.card.statuses)==null?void 0:Le.filter(me=>me.type==="Exploit"&&me.addedByPlayerId===Ne).length)||0;ue>0&&(j+=ue,M.push({row:p.row,col:W,text:`+${ue}`,playerId:Ne,timestamp:Date.now()}))}}else for(let W=0;W<F;W++){const K=e.board[W][p.col];if(K.card){const ue=((Je=K.card.statuses)==null?void 0:Je.filter(me=>me.type==="Exploit"&&me.addedByPlayerId===Ne).length)||0;ue>0&&(j+=ue,M.push({row:W,col:p.col,text:`+${ue}`,playerId:Ne,timestamp:Date.now()}))}}j>0&&(ve(M),D(Ne,j)),l(X,Me,!1,Be),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}if(G==="IP_AGENT_THREAT_SCORING"&&X&&X.row>=0){if(p.row!==X.row&&p.col!==X.col)return;const F=e.board.length;let j=0;if(p.row===X.row)for(let W=0;W<F;W++){const K=e.board[p.row][W];K.card&&(j+=((je=K.card.statuses)==null?void 0:je.filter(ue=>ue.type==="Threat"&&ue.addedByPlayerId===Ne).length)||0)}else for(let W=0;W<F;W++){const K=e.board[W][p.col];K.card&&(j+=((Q=K.card.statuses)==null?void 0:Q.filter(ue=>ue.type==="Threat"&&ue.addedByPlayerId===Ne).length)||0)}const M=j*2;M>0&&(ve({row:X.row,col:X.col,text:`+${M}`,playerId:Ne}),D(Ne,M)),l(X,Me,!1,Be),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY);return}},[A,n,e,t,ct,E,l,r,S,c,O,D,s,Xe,ve,st]),tt=$.useCallback((p,G,X)=>{var ge;if(!A.current){if(a&&v!==null&&v!==void 0){const x={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};if(Pt({card:G,ownerId:p.id,location:"hand"},x,e.activePlayerId,e.players)&&a.type==="Revealed"){const Be=((ge=a.sourceCard)==null?void 0:ge.ownerId)??e.activePlayerId??t??1;G.statuses||(G.statuses=[]),G.statuses.some(Ne=>Ne.type==="Revealed"&&Ne.addedByPlayerId===Be)||(G.statuses.push({type:"Revealed",addedByPlayerId:Be}),E({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:p.id,cardIndex:X}),a.sourceCoords&&a.sourceCoords.row>=0&&l(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?o(Ne=>Ne?{...Ne,count:Ne.count-1}:null):(a.chainedAction&&Xe(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),o(null)))}return}if((n==null?void 0:n.type)==="ENTER_MODE"&&n.mode==="SELECT_TARGET"){const{payload:x,sourceCoords:Me,isDeployAbility:Be,sourceCard:qe,readyStatusToRemove:Ne}=n;if(Re(p.id,X,e.activePlayerId??t??1),x.actionType==="SELECT_HAND_FOR_DEPLOY"){if(x.filter&&!x.filter(G))return;c(et=>({...et,selectedHandCard:{playerId:p.id,cardIndex:X}})),r({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:G,payload:{range:"global",moveFromHand:!0}});return}if(x.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(x.filter&&!x.filter(G)||p.id!==(qe==null?void 0:qe.ownerId))return;E({card:G,source:"hand",playerId:p.id,cardIndex:X,bypassOwnershipCheck:!0},{target:"discard",playerId:p.id}),r({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:qe,sourceCoords:Me,isDeployAbility:Be,payload:{tokenName:x.tokenName}});return}if(x.actionType==="LUCIUS_SETUP"){if(p.id!==(qe==null?void 0:qe.ownerId))return;E({card:G,source:"hand",playerId:p.id,cardIndex:X,bypassOwnershipCheck:!0},{target:"discard",playerId:p.id}),Xe({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:qe,sourceCoords:Me,isDeployAbility:Be,payload:{filterType:"Command"}},Me||{row:-1,col:-1}),r(null);return}if(x.actionType==="DESTROY"){if(x.filter&&!x.filter(G))return;E({card:G,source:"hand",playerId:p.id,cardIndex:X,bypassOwnershipCheck:!0},{target:"discard",playerId:p.id}),Me&&Me.row>=0&&l(Me,Be,!1,Ne),setTimeout(()=>r(null),be.MODE_CLEAR_DELAY)}}}},[A,n,E,l,r,c,Xe,e,t,Re,a,o,v]),mt=$.useCallback((p,G)=>{n||a||A.current||e.isGameStarted&&e.activePlayerId===p.id&&Dr(G,e.currentPhase,e.activePlayerId,e)&&At(G,{row:-1,col:-1})},[n,a,A,e,At]);return{activateAbility:At,executeAction:Xe,handleLineSelection:ct,handleBoardCardClick:ht,handleEmptyCellClick:we,handleHandCardClick:tt,handleAnnouncedCardDoubleClick:mt}},br=(e,t,n,r,a)=>{const o=(n.baseId||e.split("_")[1]||e).toLowerCase(),s=t===-1,c=[];o==="overwatch"?s?c.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:n}):t===0?c.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},targetOwnerId:-1,onlyOpponents:!0,sourceCard:n}):t===1&&c.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:a,baseCount:0}},sourceCard:n}):o==="tacticalmaneuver"?t===0?c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:n,payload:{range:"line",filter:m=>m.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:n}}}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:n,payload:{range:"line",filter:m=>m.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:n}}}):o==="inspiration"?s&&c.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"OPEN_COUNTER_MODAL",filter:m=>m.ownerId===a}}):o==="datainterception"?s?c.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:n}):t===0?c.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:n}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:2,filter:m=>{var f;return((f=m.statuses)==null?void 0:f.some(v=>v.type==="Exploit"&&v.addedByPlayerId===a))||!1}}}):o==="falseorders"?s?c.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:n,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):t===0?c.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:n,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:a,sourceCard:n,originalOwnerId:n.ownerId}}}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:n,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:a}}}}):o==="experimentalstimulants"?t===0?c.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"RESET_DEPLOY",filter:m=>{var f;return m.ownerId===a&&((f=m.types)==null?void 0:f.includes("Unit"))}}}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:"line",filter:m=>m.ownerId===a}}):o==="logisticschain"?t===0?c.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:n,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:n,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):o==="quickresponseteam"?t===0?c.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:m=>{var f;return m.ownerId===a&&((f=m.types)==null?void 0:f.includes("Unit"))}}}):t===1&&c.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:n,payload:{filterType:"Unit"}}):o==="temporaryshelter"?t===0?c.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):t===1&&c.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:n,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):o==="enhancedinterrogation"?s?c.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:n}):t===0?c.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:n}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:2,filter:m=>{var f;return((f=m.statuses)==null?void 0:f.some(v=>v.type==="Aim"&&v.addedByPlayerId===a))||!1}}}):(o==="mobilization1"||o==="linebreach")&&s&&c.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:n,payload:{actionType:"SCORE_LINE"}});const u=n.ownerId||a;return c.forEach(m=>{m.originalOwnerId=u,m.sourceCard&&!m.sourceCard.ownerId&&(m.sourceCard.ownerId=u)}),c},Hs=({gameState:e,localPlayerId:t,setActionQueue:n,setCommandContext:r,setCommandModalCard:a,setCounterSelectionData:o,moveItem:s,updatePlayerScore:c,updateState:u})=>{const m=$.useCallback((y,A)=>{if(t===null)return;const N=e.players.find(P=>P.id===A.playerId);if(!(A.playerId===t||(N==null?void 0:N.isDummy)))return;s(A,{target:"announced",playerId:A.playerId}),r({});const E=(y.baseId||y.id.split("_")[1]||y.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(P=>E.includes(P)))a(y);else{const P=br(y.id,-1,y,e,A.playerId);P.length>0?n([...P,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:y,ownerId:A.playerId},sourceCard:y}]):n([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:y,ownerId:A.playerId},sourceCard:y}])}},[e,t,s,n,r,a]),f=$.useCallback((y,A)=>{var D,l;if(!A||t===null)return;const N=A.ownerId||t,_=[],E=br(A.id,-1,A,e,N);let h;(D=A.baseId)!=null&&D.toLowerCase().includes("inspiration")&&(h=y===0?"DRAW_REMOVED":"SCORE_REMOVED",E.length>0&&E[0].type==="ENTER_MODE"&&(E[0]={...E[0],payload:{...E[0].payload,rewardType:h}})),E.forEach(b=>{_.push(b)}),br(A.id,y,A,e,N).forEach(b=>{_.push(b)}),(l=A.baseId)!=null&&l.toLowerCase().includes("inspiration")||_.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:A,ownerId:N},sourceCard:A}),n(_),a(null)},[e,t,n,a]),v=$.useCallback((y,A)=>{var h;if(t===null)return;const N=A.card.ownerId||t;let _=null;for(let P=0;P<e.board.length;P++){for(let D=0;D<e.board[P].length;D++)if(((h=e.board[P][D].card)==null?void 0:h.id)===A.card.id){_={row:P,col:D};break}if(_)break}if(!_){console.warn(`Card ${A.card.id} not found on board during counter removal`),o(null);return}if(u(P=>{if(!P.isGameStarted)return P;const D=Ue(P),l=D.board[_.row][_.col].card;let b=0;const T=(l==null?void 0:l.statuses)??[];if(Object.entries(y).forEach(([L,g])=>{for(let O=0;O<g;O++){const S=T.map(k=>k.type).lastIndexOf(L);S>-1&&(l!=null&&l.statuses)&&(l.statuses.splice(S,1),b++)}}),!(l!=null&&l.statuses)&&l&&(l.statuses=[]),D.board=ot(D),b>0&&A.callbackAction==="DRAW_REMOVED"){const L=D.players.find(g=>g.id===N);if(L){const g=Math.min(b,L.deck.length);for(let O=0;O<g;O++){const S=L.deck.shift();S&&L.hand.push(S)}}}return D}),A.callbackAction==="SCORE_REMOVED"){const P=Object.values(y).reduce((D,l)=>D+l,0);P>0&&c(N,P)}const E=e.players.find(P=>P.id===N);E!=null&&E.announcedCard&&n([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:E.announcedCard,ownerId:N},sourceCard:E.announcedCard}]),o(null)},[t,c,n,o,e,u]);return{playCommandCard:m,handleCommandConfirm:f,handleCounterSelectionConfirm:v}},Fs=({gameState:e,localPlayerId:t,handleDrop:n,markAbilityUsed:r,requestCardReveal:a,interactionLock:o,setCommandContext:s,onAction:c,cursorStack:u,setCursorStack:m,setAbilityMode:f,triggerTargetSelection:v})=>{const y=$.useRef(null),A=$.useRef({x:0,y:0});return $.useLayoutEffect(()=>{if(u&&y.current){const{x:_,y:E}=A.current;y.current.style.transform=`translate(${_-24}px, ${E-24}px)`}},[u]),$.useEffect(()=>{const _=E=>{A.current={x:E.clientX,y:E.clientY},y.current&&(y.current.style.transform=`translate(${E.clientX-24}px, ${E.clientY-24}px)`)};return window.addEventListener("mousemove",_),()=>window.removeEventListener("mousemove",_)},[]),$.useEffect(()=>{const _=E=>{var l,b,T,L,g,O,S,k;if(E.button!==0||!u)return;const h=document.elementFromPoint(E.clientX,E.clientY);let P=t;if(u.originalOwnerId!==void 0)P=u.originalOwnerId;else if((l=u.sourceCard)!=null&&l.ownerId)P=u.sourceCard.ownerId;else if(u.sourceCoords&&u.sourceCoords.row>=0){const{row:Y,col:V}=u.sourceCoords;if(Y>=0&&Y<e.board.length&&V>=0&&V<((b=e.board[Y])==null?void 0:b.length)){const te=e.board[Y][V].card;te&&(P=te.ownerId||t)}}else if(e.activePlayerId){const Y=e.players.find(V=>V.id===e.activePlayerId);Y!=null&&Y.isDummy&&(P=Y.id)}let D=h==null?void 0:h.closest("[data-hand-card]");if(!D&&h)if(h.getAttribute("data-hand-card"))D=h;else{const Y=h.querySelectorAll("[data-hand-card]");if(Y.length>0){let V=1/0,te=null;const ee=E.clientX,pe=E.clientY;for(const ye of Array.from(Y)){const Te=ye.getBoundingClientRect();if(ee>=Te.left&&ee<=Te.right&&pe>=Te.top&&pe<=Te.bottom){const Fe=Te.left+Te.width/2,ve=Te.top+Te.height/2,Re=Math.hypot(ee-Fe,pe-ve);Re<V&&(V=Re,te=ye)}}D=te}}if(D){const Y=D.getAttribute("data-hand-card");if(Y){const[V,te]=Y.split(","),ee=parseInt(V,10),pe=parseInt(te,10),ye=e.players.find(Fe=>Fe.id===ee),Te=ye==null?void 0:ye.hand[pe];if(ye&&Te){if(u.type==="Revealed"&&!ye.isDummy){if((T=Te.statuses)==null?void 0:T.some(ne=>ne.type==="Revealed"&&ne.addedByPlayerId===P))return;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:u.originalOwnerId??((L=u.sourceCard)==null?void 0:L.ownerId)??P??void 0,statusType:u.type,count:1},{target:"hand",playerId:ee,cardIndex:pe,boardCoords:void 0}),u.sourceCoords&&u.sourceCoords.row>=0&&r(u.sourceCoords,u.isDeployAbility),u.count>1?m(ne=>ne?{...ne,count:ne.count-1}:null):(u.chainedAction&&c(u.chainedAction,u.sourceCoords||{row:-1,col:-1}),m(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}const ve={targetOwnerId:u.targetOwnerId,excludeOwnerId:u.excludeOwnerId,onlyOpponents:u.onlyOpponents||u.targetOwnerId===-1,onlyFaceDown:u.onlyFaceDown,targetType:u.targetType,requiredTargetStatus:u.requiredTargetStatus,tokenType:u.type};if(!Pt({card:Te,ownerId:ee,location:"hand"},ve,P,e.players))return;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:u.originalOwnerId??((g=u.sourceCard)==null?void 0:g.ownerId),statusType:u.type,replaceStatusType:u.replaceStatus?u.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:ee,cardIndex:pe,boardCoords:void 0}),u.sourceCoords&&u.sourceCoords.row>=0&&r(u.sourceCoords,u.isDeployAbility),u.count>1?m(st=>st?{...st,count:st.count-1}:null):(u.chainedAction&&c(u.chainedAction,u.sourceCoords||{row:-1,col:-1}),m(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}}if(!D){const Y=h==null?void 0:h.closest("[data-board-coords]");if(Y){const V=Y.getAttribute("data-board-coords");if(V){const[te,ee]=V.split(","),pe=parseInt(te,10),ye=parseInt(ee,10);if(!isNaN(pe)&&!isNaN(ye)&&pe>=0&&pe<e.board.length&&e.board[pe]&&ye>=0&&ye<e.board[pe].length&&e.board[pe][ye]){const Te=e.board[pe][ye].card;if((Te==null?void 0:Te.ownerId)!==void 0){const Fe={targetOwnerId:u.targetOwnerId,excludeOwnerId:u.excludeOwnerId,onlyOpponents:u.onlyOpponents||u.targetOwnerId===-1,onlyFaceDown:u.onlyFaceDown,targetType:u.targetType,requiredTargetStatus:u.requiredTargetStatus,mustBeAdjacentToSource:u.mustBeAdjacentToSource,mustBeInLineWithSource:u.mustBeInLineWithSource,sourceCoords:u.sourceCoords,tokenType:u.type};if(!Pt({card:Te,ownerId:Te.ownerId,location:"board",boardCoords:{row:pe,col:ye}},Fe,P,e.players))return;const Re=e.players.find(st=>st.id===Te.ownerId);if(u.type==="Revealed"&&!(Re!=null&&Re.isDummy)){if((O=Te.statuses)==null?void 0:O.some(ne=>ne.type==="Revealed"&&ne.addedByPlayerId===P))return;Te.isFaceDown?t!==null&&a({source:"board",ownerId:Te.ownerId,boardCoords:{row:pe,col:ye}},t):(n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:u.originalOwnerId??((S=u.sourceCard)==null?void 0:S.ownerId)??P??void 0,statusType:u.type,count:1},{target:"board",boardCoords:{row:pe,col:ye}}),v("board",{row:pe,col:ye})),u.sourceCoords&&u.sourceCoords.row>=0&&r(u.sourceCoords,u.isDeployAbility),u.count>1?m(ne=>ne?{...ne,count:ne.count-1}:null):(u.chainedAction&&c(u.chainedAction,u.sourceCoords||{row:-1,col:-1}),m(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}if(Te){const Fe=u.placeAllAtOnce?u.count:1;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:u.originalOwnerId??((k=u.sourceCard)==null?void 0:k.ownerId),statusType:u.type,replaceStatusType:u.replaceStatus?u.requiredTargetStatus:void 0,count:Fe},{target:"board",boardCoords:{row:pe,col:ye}}),v("board",{row:pe,col:ye}),u.recordContext&&s(Re=>({...Re,lastMovedCardCoords:{row:pe,col:ye},lastMovedCardId:Te.id})),u.sourceCoords&&u.sourceCoords.row>=0&&r(u.sourceCoords,u.isDeployAbility);const ve=u.count-Fe;if(ve>0)m(Re=>Re?{...Re,count:ve}:null);else{if(u.chainedAction){const Re={...u.chainedAction};u.recordContext&&(Re.mode==="SELECT_CELL"&&(Re.sourceCard=Te,Re.sourceCoords={row:pe,col:ye},Re.recordContext=!0),Re.type==="GLOBAL_AUTO_APPLY"&&(Re.sourceCoords={row:pe,col:ye}),Re.type==="CREATE_STACK"&&(Re.sourceCoords={row:pe,col:ye},Re.originalOwnerId||(Re.sourceCard=Te)),Re.mode==="ZIUS_LINE_SELECT"&&(Re.sourceCoords={row:pe,col:ye})),Re.type==="CREATE_STACK"&&f(null),c(Re,{row:pe,col:ye})}m(null)}o.current=!0,setTimeout(()=>{o.current=!1},300)}}}}else{const V=h==null?void 0:h.closest(".counter-modal-content"),te=(h==null?void 0:h.closest("[data-board-coords]"))!==null,ee=(h==null?void 0:h.closest("[data-hand-card]"))!==null;u.isDragging?V?m(pe=>pe?{...pe,isDragging:!1}:null):!te&&!ee&&m(null):!V&&!te&&!ee&&m(null)}}};return window.addEventListener("mouseup",_),()=>{window.removeEventListener("mouseup",_)}},[u,n,e,t,a,r,o,s,c,m,f,v]),$.useEffect(()=>{const _=E=>{u&&(E.preventDefault(),m(null))};return window.addEventListener("contextmenu",_),()=>{window.removeEventListener("contextmenu",_)}},[u,m]),{cursorFollowerRef:y,handleCounterMouseDown:(_,E)=>{A.current={x:E.clientX,y:E.clientY},m(h=>(h==null?void 0:h.type)===_?{type:_,count:h.count+1,isDragging:!0,sourceCoords:h.sourceCoords}:{type:_,count:1,isDragging:!0})}}};export{Hs as A,$s as B,Fs as C,bs as D,ms as E,Ss as F,Cs as G,cr as H,br as I,Pt as J,ar as K,d as L,Io as M,Gr as N,gs as O,As as P,ho as Q,Rs as S,be as T,$t as a,Ke as b,Yn as c,Eo as d,Ps as e,ws as f,_t as g,_o as h,po as i,vs as j,Or as k,Ds as l,yo as m,To as n,_s as o,Os as p,xs as q,ks as r,Ms as s,fo as t,Gs as u,Ls as v,Gt as w,lr as x,Ns as y,Us as z};
