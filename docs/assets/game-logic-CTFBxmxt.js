import{r as O}from"./vendor-react-DRpQTlnQ.js";import{$ as nr}from"./vendor-webrtc-D4tL16WN.js";var ct=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(ct||{}),Rr=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(Rr||{});const cn={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253319/SYN_IP_DEPT_AGENT_mhwphu.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253342/SYN_TACTICAL_AGENT_xbb7i0.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253325/SYN_PATROL_AGENT_ioetlu.png",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253337/SYN_RIOT_AGENT_jurf4t.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253338/SYN_THREAT_ANALYST_sqnpgw.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678622/Mr._Pearl_Director_of_BioSynch_mo0cil.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253315/HOO_RECKLESS_PROVOCATEUR_hi7a9z.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253317/HOO_DATA_LIBERATOR_lbtqa2.png",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253309/HOO_CAUTIOUS_AVENGER_x4g4g3.png",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253311/HOO_VIGILANT_SPOTTER_eiephm.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253313/HOO_INVENTIVE_MAKER_uzrbg1.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764637482/Finn_nehk0r.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253324/OPT_FABER_d7uxew.png",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253321/OPT_CENSOR_wtxtc2.png",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253332/OPT_PRINCEPS_w3o5lq.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253327/OPT_IMMUNIS_bjlncl.png",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253330/OPT_CENTURION_aaushl.png",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678954/Lucius_The_Immortal_z0lemw.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253298/FUS_CODE_KEEPER_qotsym.png",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253305/FUS_DEVOUT_SYNTHETIC_bavg9k.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253303/FUS_UNWAVERING_INTEGRATOR_emret1.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253299/FUS_SIGNAL_PROPHET_nzd7w3.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253301/FUS_ZEALOUS_MISSIONARY_mfv9xl.png",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678937/Reverend_of_The_Choir_vts8im.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253291/CMD_OVERWATCH_hrba9x.png",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253296/CMD_REPOSITIONING_m7k4kf.png",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763260942/CMD_INSPIRATION_nxifhu.png",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253290/CMD_DATA_INTERCEPTION_ks4lcv.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763640484/CMD_FALSE_ORDERS_ghi01y.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Experimental_Stimulants_x8ns1g.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Logistics_Chain_d4irtq.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507609/Quick_Response_Team_rw2cut.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Temporary_Shelter_o0embx.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Enhanced_Interrogation_suzvxe.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764626980/Autonomous_Battle_Robot_Gawain_uoyjm5.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Reclaimed_Gawain_sg6257.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764767153/Secret_informant_eb0nkm.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Michael_Falk_wcxjnp.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Edith_Byron_v6691r.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Pinkunoneko_nhmjfv.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Maria_Eleftheria_Damanaki_bmx6xv.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Zius_cwd92f.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},ln={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253333/TKN_RECON_DRONE_esfknf.png",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253307/TKN_WALKING_TURRET_uq6owm.png",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},un={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Aim_dcct45.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Exploit_foomty.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Revealed_w1gbe7.png",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Stun_cwqroz.png",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Shield_z9sjr1.png",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Support_ui9qpl.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Threat_i1pbko.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1768321040/Resurrected_tscgk9.png",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},fn=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],Er={cardDatabase:cn,tokenDatabase:ln,countersDatabase:un,deckFiles:fn};let Jr=null,Mt=new Map,Sr=new Map,jt={},pr=[],Ar={};const ia=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function qn(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const n=await fetch("/api/content/database");if(n.ok){const o=await n.json(),l=o.cards.map(([_,m])=>[_,m]),E=o.tokens.map(([_,m])=>[_,m]);e={cardDatabase:Object.fromEntries(l),tokenDatabase:Object.fromEntries(E),countersDatabase:Object.fromEntries(o.counters),deckFiles:o.deckFiles}}else e=Er}catch{e=Er}else e=Er;Jr=e,Mt=new Map(Object.entries(e.cardDatabase)),Sr=new Map(Object.entries(e.tokenDatabase)),jt=e.countersDatabase,pr=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(jt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(n){console.warn("Could not save counters database to localStorage:",n)}St=Jr,yn=Mt,hn=Sr,Bt=jt,mn=pr,Ar=pn(),En=Ar}catch(e){throw console.error("Failed to load content database:",e),e}}function pn(){const e={};for(const r of pr){const n=[];for(const o of r.cards){const l=Mt.get(o.cardId);if(!l){console.warn(`Card definition not found for ID: ${o.cardId} in deck: ${r.name}`);continue}const E=ia.has(o.cardId);for(let _=0;_<o.quantity;_++){const g=o.cardId.replace(/-/g,"--DASH--").toUpperCase();E?n.push({...l,deck:ct.Command,id:`CMD_${g}_${_+1}`,baseId:o.cardId,faction:l.faction||"Command"}):n.push({...l,deck:r.id,id:`${r.id.substring(0,3).toUpperCase()}_${g}_${_+1}`,baseId:o.cardId,faction:l.faction||r.id})}}e[r.id]=n}return e[ct.Tokens]=Array.from(Sr.entries()).map(([r,n])=>{const o=n.types?[...n.types]:[];return{id:`TKN_${n.name.toUpperCase().replace(/\s/g,"_")}`,baseId:r,deck:ct.Tokens,name:n.name,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage,power:n.power,ability:n.ability,color:n.color,types:o,flavorText:n.flavorText,faction:"Tokens"}}),e}let St=null,yn=new Map,hn=new Map,Bt={};try{const e=localStorage.getItem("counters_database");e&&(jt=JSON.parse(e),Bt=jt)}catch{}let mn=[],En={};const In=ia,Vn=()=>pr.filter(e=>e.isSelectable);function Tn(e){return Mt.get(e)}function Ir(e){return Array.from(Mt.values()).find(r=>r.name===e)}function Jn(){return Array.from(Mt.entries()).map(([e,r])=>({id:e,card:r}))}function Xn(){return Mt}function Or(){return Ar}const gn=4,Zn={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764252181/medal_rgbw8d.png"},Qn={[ct.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[ct.Hoods]:{prefix:"HOO",color:"border-purple-500"},[ct.Optimates]:{prefix:"OPT",color:"border-red-500"},[ct.Fusion]:{prefix:"FUS",color:"border-green-400"},[ct.Command]:{prefix:"CMD",color:"border-yellow-500"},[ct.Tokens]:{prefix:"TKN",color:"border-gray-400"},[ct.Custom]:{prefix:"CUS",color:"border-purple-400"},[ct.Neutral]:{prefix:"NEU",color:"border-gray-400"},[ct.Random]:{prefix:"RND",color:"border-gray-400"}},eo={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},_n={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},to={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},or=["blue","purple","red","green","yellow","orange","pink","brown"],ro=["Setup","Main","Commit","Scoring"],sr=()=>Object.fromEntries(Object.entries(Bt).map(([e,r])=>[e,r.imageUrl])),ao=new Proxy({},{get(e,r){return sr()[r]},ownKeys(){return Object.keys(sr())},has(e,r){return r in sr()},getOwnPropertyDescriptor(e,r){const n=sr()[r];return n!==void 0?{enumerable:!0,configurable:!0,value:n}:void 0}}),ir=()=>Object.fromEntries(Object.entries(Bt).map(([e,r])=>[e,r.description])),no=new Proxy({},{get(e,r){return ir()[r]},ownKeys(){return Object.keys(ir())},has(e,r){return r in ir()},getOwnPropertyDescriptor(e,r){const n=ir()[r];return n!==void 0?{enumerable:!0,configurable:!0,value:n}:void 0}}),wn=()=>Object.entries(Bt).filter(([,e])=>!e.allowedPanels||e.allowedPanels.includes("COUNTER_PANEL")).sort(([,e],[,r])=>e.sortOrder-r.sortOrder).map(([e,r])=>({type:e,label:r.name}));wn();const Zt="readyDeploy",Qt="readySetup",er="readyCommit",$t=(e,r,n,o)=>Math.abs(e-n)+Math.abs(r-o)===1,ot=(e,r,n)=>e.statuses?e.statuses.some(o=>o.type===r&&(n===void 0||o.addedByPlayerId===n)):!1,Wt=(e,r)=>e.statuses?e.statuses.some(n=>n.type===r):!1,Dn=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"DESTROY",filter:l=>ot(l,"Aim",n)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:o,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:o,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"threatAnalyst",activationType:"commit",supportRequired:!0,getAction:(e,r,n,o)=>{let l=0;return r.board.forEach(E=>{E.forEach(_=>{var m;(m=_.card)!=null&&m.statuses&&(l+=_.card.statuses.filter(g=>g.type==="Exploit"&&g.addedByPlayerId===n).length)})}),l===0?null:{type:"CREATE_STACK",tokenType:"Revealed",count:l,onlyFaceDown:!0}}},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,r,n,o)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:n})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,r,n,o)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:l=>{var E;return l.ownerId!==n&&((E=l.statuses)==null?void 0:E.some(_=>_.type==="Threat"))}},sourceCard:e,sourceCoords:o})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:o,payload:{filter:l=>l.ownerId!==n&&ot(l,"Exploit",n)}})},{baseId:"centurion",activationType:"commit",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(l,E,_)=>{var m;return l.ownerId===n&&((m=l.types)==null?void 0:m.includes("Unit"))&&E!==void 0&&_!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:o,payload:{filter:(l,E,_)=>$t(E,_,o.row,o.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:o,payload:{filter:l=>l.id===e.id?!1:l.ownerId===n}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:o,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"DESTROY",filter:l=>ot(l,"Aim",n)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:o,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,r,n,o)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,originalOwnerId:n,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:l=>l.ownerId===n}})},{baseId:"censor",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:o,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"DESTROY",filter:l=>ot(l,"Aim",n)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,r,n,o)=>ot(e,"Support",n)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:o,payload:{filter:(l,E)=>$t(l,E,o.row,o.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"DESTROY",filter:(l,E,_)=>$t(E,_,o.row,o.col)&&l.ownerId!==n&&(ot(l,"Threat",n)||ot(l,"Stun",n))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,r,n,o)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:l=>l.ownerId===n&&ot(l,"Support",n)},sourceCard:e,sourceCoords:o})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:o,payload:{filter:l=>l.ownerId===n&&ot(l,"Exploit",n)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:o,payload:{filter:l=>ot(l,"Exploit",n)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:o,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"MODIFY_POWER",amount:-1,filter:l=>ot(l,"Aim",n)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:o,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"REVEAL_ENEMY",sourceCard:e,sourceCoords:o,payload:{filter:(l,E,_)=>$t(E,_,o.row,o.col)&&l.ownerId!==n}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"DESTROY",filter:l=>ot(l,"Aim",n)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"DESTROY",filter:(l,E,_)=>$t(E,_,o.row,o.col)&&l.ownerId!==n&&(ot(l,"Threat",n)||ot(l,"Stun",n))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,r,n,o)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:n})},{baseId:"edithByron",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:o,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:o,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"DESTROY",filter:(l,E,_)=>$t(E,_,o.row,o.col)&&(ot(l,"Threat",n)||ot(l,"Stun",n)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"DESTROY",filter:l=>ot(l,"Aim",n)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,r,n,o)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:o,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:o,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,r,n,o)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:o,ownerId:n})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:o,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:o,payload:{actionType:"LUCIUS_SETUP",filter:l=>l.ownerId===n}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,r,n,o)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:o,payload:{filter:l=>l.ownerId===n,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,r,n,o)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:o})}],Nr=e=>{const r=e.baseId||"";return Dn.filter(n=>{var o;return n.baseId===r||((o=n.baseIdAlt)==null?void 0:o.includes(r))})},Cn=e=>{const n=Nr(e).map(o=>o.activationType);return[...new Set(n)]},Pr=(e,r,n,o)=>{var _;if(n!==e.ownerId)return!1;if(o&&e.ownerId!==void 0){const m=o.players.find(g=>g.id===e.ownerId);if(m!=null&&m.isDummy&&o.activePlayerId!==e.ownerId)return!1}if((_=e.statuses)!=null&&_.some(m=>m.type==="Stun"))return!1;const l=Nr(e),E=r===1&&l.some(m=>m.activationType==="setup")||r===3&&l.some(m=>m.activationType==="commit");if(r===1){const m=l.find(g=>g.activationType==="setup");if(m&&Wt(e,Qt))return!(m.supportRequired&&!ot(e,"Support",n))}if(r===3){const m=l.find(g=>g.activationType==="commit");if(m&&Wt(e,er))return!(m.supportRequired&&!ot(e,"Support",n))}if(!E){const m=l.find(g=>g.activationType==="deploy");if(m&&Wt(e,Zt))return!(m.supportRequired&&!ot(e,"Support",n))}return!1},bn=(e,r,n,o)=>{if(n!==e.ownerId)if(e.ownerId!==void 0){const g=r.players.find(I=>I.id===e.ownerId);if(!(g!=null&&g.isDummy))return null}else return null;const l=Nr(e),E=e.ownerId??n??0,_=r.currentPhase,m=_===1&&l.some(g=>g.activationType==="setup")||_===3&&l.some(g=>g.activationType==="commit");if(_===1){const g=l.find(I=>I.activationType==="setup");if(g&&Wt(e,Qt)){if(g.supportRequired&&!ot(e,"Support",E))return null;const I=g.getAction(e,r,E,o);if(I)return{...I,readyStatusToRemove:Qt}}}if(_===3){const g=l.find(I=>I.activationType==="commit");if(g&&Wt(e,er)){if(g.supportRequired&&!ot(e,"Support",E))return null;const I=g.getAction(e,r,E,o);if(I)return{...I,readyStatusToRemove:er}}}if(!m){const g=l.find(I=>I.activationType==="deploy");if(g&&Wt(e,Zt)){if(g.supportRequired&&!ot(e,"Support",E))return null;const I=g.getAction(e,r,E,o);if(I)return{...I,isDeployAbility:!0,readyStatusToRemove:Zt}}}return null},Rn=(e,r,n)=>{let o,l;return typeof r=="object"?(o=r.currentPhase,n=r.activePlayerId??void 0,l=r):o=r,Pr(e,o,n??void 0,l)},Tr=(e,r)=>{e.statuses||(e.statuses=[]);const n=e.statuses.length,o=e.statuses.map(E=>E.type),l=Cn(e);console.log(`[initializeReadyStatuses] Card: ${e.name} (${e.id}), ownerId: ${r}, abilities: [${l.join(", ")}]`);for(const E of l){let _="";E==="deploy"?_=Zt:E==="setup"?_=Qt:E==="commit"&&(_=er),_&&!e.statuses.some(m=>m.type===_)&&(e.statuses.push({type:_,addedByPlayerId:r}),console.log(`[initializeReadyStatuses] Added status: ${_} to ${e.name}`))}e.statuses.length!==n&&console.log(`[initializeReadyStatuses] Card ${e.name}: statuses changed from [${o.join(", ")}] to [${e.statuses.map(E=>E.type).join(", ")}]`)},gr=e=>{e.statuses&&(e.statuses=e.statuses.filter(r=>r.type!==Zt&&r.type!==Qt&&r.type!==er))};function Ue(e){const r=e,n=r==null?void 0:r.targetingMode;n&&delete r.targetingMode;let o;return typeof structuredClone<"u"?o=structuredClone(e):o=JSON.parse(JSON.stringify(e)),n&&(o.targetingMode=n,r.targetingMode=n),o}const ve={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function oo(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function so(e,r){return`rgba(${e.r}, ${e.g}, ${e.b}, ${r})`}function io(e,r){return e?_n[e]:r}const p={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},qt="webrtc_game_state",Vt="webrtc_host_data",Jt="webrtc_guest_data",Sn="webrtc_current_host_peerId",An=30*60*1e3;function kr(){return Date.now()}function tr(e){return Date.now()-e<An}function On(e){try{const r={...e,timestamp:kr()};localStorage.setItem(Vt,JSON.stringify(r)),p.info("[WebRTC Persistence] Saved host data:",{peerId:r.peerId})}catch(r){p.error("[WebRTC Persistence] Failed to save host data:",r)}}function Xr(e){try{const r={...e,timestamp:kr()};localStorage.setItem(Jt,JSON.stringify(r)),p.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:r.hostPeerId,playerId:r.playerId})}catch(r){p.error("[WebRTC Persistence] Failed to save guest data:",r)}}function dr(e){try{const r={...e,timestamp:kr()};localStorage.setItem(qt,JSON.stringify(r)),p.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(r.timestamp).toISOString())}catch(r){p.error("[WebRTC Persistence] Failed to save game state:",r)}}function da(){try{const e=localStorage.getItem(Vt);if(!e)return null;const r=JSON.parse(e);return tr(r.timestamp)?(p.info("[WebRTC Persistence] Loaded valid host data:",{peerId:r.peerId}),r):(p.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(Vt),null)}catch(e){return p.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(Vt),null}}function ca(){try{const e=localStorage.getItem(Jt);if(!e)return null;const r=JSON.parse(e);return tr(r.timestamp)?(p.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:r.hostPeerId,playerId:r.playerId}),r):(p.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(Jt),null)}catch(e){return p.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(Jt),null}}function Zr(){try{const e=localStorage.getItem(qt);if(!e)return null;const r=JSON.parse(e);return tr(r.timestamp)?(p.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(r.timestamp).toISOString()),r):(p.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(qt),null)}catch(e){return p.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(qt),null}}function Ut(){localStorage.removeItem(qt),localStorage.removeItem(Vt),localStorage.removeItem(Jt),localStorage.removeItem(Sn)}function _r(e,r){try{const n=`webrtc_host_${r}`,o={peerId:e,gameId:r,timestamp:Date.now()};localStorage.setItem(n,JSON.stringify(o)),p.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${r}:`,e)}catch(n){p.error("[WebRTC Persistence] Failed to broadcast host peerId:",n)}}function wr(e){try{const r=`webrtc_host_${e}`,n=localStorage.getItem(r);if(!n)return null;const o=JSON.parse(n);return Date.now()-o.timestamp>15e3?null:{peerId:o.peerId,timestamp:o.timestamp}}catch(r){return p.error("[WebRTC Persistence] Failed to get host peerId:",r),null}}function Pn(e){try{const r=`webrtc_host_${e}`;localStorage.removeItem(r),p.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(r){p.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",r)}}function vn(){const e=sessionStorage.getItem("invite_host_id"),r=sessionStorage.getItem("invite_auto_join");if(e&&r)return"none";const n=da();if(n&&tr(n.timestamp))return"host";const o=ca();return o&&tr(o.timestamp)?"guest":"none"}function fr(e){const r=[...e];for(let n=r.length-1;n>0;n--){const o=Math.floor(Math.random()*(n+1));[r[n],r[o]]=[r[o],r[n]]}return r}const Qr=7,Dr="mrPearlDoF",Nn="reverendOfTheChoir",kn="threatAnalyst";function Ln(e,r){return e!=null&&e.statuses?e.statuses.some(n=>n.type==="Exploit"&&n.addedByPlayerId!==void 0&&r.has(n.addedByPlayerId)):!1}function Mn(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const ea=()=>Array(Qr).fill(null).map(()=>Array(Qr).fill(null).map(()=>({card:null}))),pt=e=>{var b,S,$,se,Z;const{board:r,activeGridSize:n,players:o}=e,l=Mn(r),E=l.length,_=Math.floor((E-n)/2),m=new Map;o.forEach(k=>m.set(k.id,k.teamId));for(let k=0;k<E;k++)for(let ne=0;ne<E;ne++){const J=l[k][ne].card;J&&(J.statuses&&(J.statuses=J.statuses.filter(Te=>Te.type!=="Support"&&Te.type!=="Threat")),delete J.bonusPower)}for(let k=0;k<E;k++)for(let ne=0;ne<E;ne++){const J=l[k][ne].card;if((J==null?void 0:J.ownerId)===void 0||J.isFaceDown)continue;const Te=J.ownerId,Oe=m.get(Te),Se=[{r:k-1,c:ne},{r:k+1,c:ne},{r:k,c:ne-1},{r:k,c:ne+1}],we={};let Ee=!1;for(const V of Se){const{r:X,c:oe}=V;if(X>=0&&X<E&&oe>=0&&oe<E){const j=l[X][oe].card,be=(b=j==null?void 0:j.statuses)==null?void 0:b.some(me=>me.type==="Stun");if((j==null?void 0:j.ownerId)!==void 0&&!j.isFaceDown&&!be){const me=j.ownerId,Be=m.get(me);Te===me||Oe!==void 0&&Oe===Be?Ee=!0:(we[me]||(we[me]=[]),we[me].push({r:X,c:oe}))}}}Ee&&(J.statuses||(J.statuses=[]),J.statuses.some(V=>V.type==="Support")||J.statuses.push({type:"Support",addedByPlayerId:Te}));let G=null;for(const V in we){const X=we[V];if(X&&X.length>=2){G=parseInt(V,10);break}}if(G===null&&k>=_&&k<_+n&&ne>=_&&ne<_+n){const X=k===_||k===_+n-1||ne===_||ne===_+n-1,oe=Object.keys(we).length>0;if(X&&oe){const j=Object.keys(we)[0];j&&(G=parseInt(j,10))}}G!==null&&(J.statuses||(J.statuses=[]),J.statuses.some(V=>V.type==="Threat")||J.statuses.push({type:"Threat",addedByPlayerId:G}))}const g=new Set;for(let k=0;k<E;k++)for(let ne=0;ne<E;ne++){const J=l[k][ne].card,Te=(S=J==null?void 0:J.statuses)==null?void 0:S.some(Oe=>Oe.type==="Stun");if((J==null?void 0:J.baseId)===kn&&!J.isFaceDown&&J.ownerId!==void 0&&!Te){const Oe=[{r:k-1,c:ne},{r:k+1,c:ne},{r:k,c:ne-1},{r:k,c:ne+1}];let Se=!1;const we=J.ownerId,Ee=m.get(we);for(const G of Oe){const{r:V,c:X}=G;if(V>=0&&V<E&&X>=0&&X<E){const oe=l[V][X].card;if((oe==null?void 0:oe.ownerId)!==void 0&&!oe.isFaceDown){const j=oe.ownerId,be=m.get(j),me=we===j||Ee!==void 0&&Ee===be,Be=($=oe==null?void 0:oe.statuses)==null?void 0:$.some(De=>De.type==="Stun");if(me&&!Be){Se=!0;break}}}}Se&&g.add(we)}}for(let k=0;k<E;k++)for(let ne=0;ne<E;ne++){const J=l[k][ne].card;if(!J||J.isFaceDown||J.ownerId===void 0)continue;const Te=J.ownerId,Oe=m.get(Te),Se=[{r:k-1,c:ne},{r:k+1,c:ne},{r:k,c:ne-1},{r:k,c:ne+1}],we={};for(const G of Se){const{r:V,c:X}=G;if(V>=0&&V<E&&X>=0&&X<E){const oe=l[V][X].card,j=(se=oe==null?void 0:oe.statuses)==null?void 0:se.some(be=>be.type==="Stun");if((oe==null?void 0:oe.ownerId)!==void 0&&!oe.isFaceDown&&!j){const be=oe.ownerId,me=m.get(be);if(!(Te===be||Oe!==void 0&&Oe===me)){const De=g.has(be),Ce=Ln(J,g);De&&Ce&&(we[be]||(we[be]=0),we[be]++)}}}}if(Object.keys(we).length>0){J.statuses||(J.statuses=[]);const G=Object.keys(we).map(V=>parseInt(V,10));for(const V of G)J.statuses.some(X=>X.type==="Threat"&&X.addedByPlayerId===V)||J.statuses.push({type:"Threat",addedByPlayerId:V})}}const I=[],A=[];for(let k=0;k<E;k++)for(let ne=0;ne<E;ne++){const J=l[k][ne].card,Te=(Z=J==null?void 0:J.statuses)==null?void 0:Z.some(Oe=>Oe.type==="Stun");J!=null&&J.baseId&&!J.isFaceDown&&J.ownerId!==void 0&&!Te&&(J.baseId===Nn?I.push({r:k,c:ne,ownerId:J.ownerId,baseId:J.baseId}):J.baseId===Dr&&A.push({r:k,c:ne,ownerId:J.ownerId,baseId:J.baseId}))}const x=new Set,Y=new Set;for(const k of I){const{r:ne,c:J,ownerId:Te}=k,Oe=`${ne}-${Te}`;if(!x.has(Oe)){x.add(Oe);for(let we=0;we<E;we++){const Ee=l[ne][we].card;Ee&&Ee.ownerId===Te&&!Ee.isFaceDown&&(Ee.statuses||(Ee.statuses=[]),Ee.statuses.some(G=>G.type==="Support")||Ee.statuses.push({type:"Support",addedByPlayerId:Te}))}}const Se=`${J}-${Te}`;if(!Y.has(Se)){Y.add(Se);for(let we=0;we<E;we++){const Ee=l[we][J].card;Ee&&Ee.ownerId===Te&&!Ee.isFaceDown&&(Ee.statuses||(Ee.statuses=[]),Ee.statuses.some(G=>G.type==="Support")||Ee.statuses.push({type:"Support",addedByPlayerId:Te}))}}}const P=new Set,ie=new Set;for(const k of A){const{r:ne,c:J,ownerId:Te}=k,Oe=`${ne}-${Te}`;if(!P.has(Oe)){P.add(Oe);for(let we=0;we<E;we++){const Ee=l[ne][we].card;Ee&&Ee.ownerId===Te&&!Ee.isFaceDown&&Ee.baseId!==Dr&&(Ee.bonusPower=(Ee.bonusPower||0)+1)}}const Se=`${J}-${Te}`;if(!ie.has(Se)){ie.add(Se);for(let we=0;we<E;we++){const Ee=l[we][J].card;Ee&&Ee.ownerId===Te&&!Ee.isFaceDown&&Ee.baseId!==Dr&&(Ee.bonusPower=(Ee.bonusPower||0)+1)}}}return l},ta=-1,Gn=-2,Kt=1,cr=2,Lt=(e,r,n,o)=>{var m,g,I,A,x;const{card:l,ownerId:E,location:_}=e;if(r.targetOwnerId!==void 0&&r.targetOwnerId!==ta&&r.targetOwnerId!==Gn&&r.targetOwnerId!==E||r.excludeOwnerId!==void 0&&r.excludeOwnerId===E)return!1;if(r.onlyOpponents||r.targetOwnerId===ta){if(E===n)return!1;const Y=o.find(ie=>ie.id===n),P=o.find(ie=>ie.id===E);if(Y&&P&&Y.teamId!==void 0&&Y.teamId===P.teamId)return!1}if(r.targetType&&!((m=l.types)!=null&&m.includes(r.targetType))||r.onlyFaceDown&&((g=l.statuses)!=null&&g.some(Y=>Y.type==="Revealed"&&Y.addedByPlayerId===n)||_==="board"&&!l.isFaceDown)||r.tokenType==="Revealed"&&(I=l.statuses)!=null&&I.some(Y=>Y.type==="Revealed"&&Y.addedByPlayerId===n)||r.requiredTargetStatus&&(!((A=l.statuses)!=null&&A.some(Y=>Y.type===r.requiredTargetStatus))||r.requireStatusFromSourceOwner&&n!==null&&!((x=l.statuses)==null?void 0:x.some(P=>P.type===r.requiredTargetStatus&&P.addedByPlayerId===n))))return!1;if(r.mustBeAdjacentToSource&&r.sourceCoords&&e.boardCoords){const{row:Y,col:P}=r.sourceCoords,{row:ie,col:b}=e.boardCoords;if(Math.abs(Y-ie)+Math.abs(P-b)!==Kt)return!1}if(r.mustBeInLineWithSource&&r.sourceCoords&&e.boardCoords){const{row:Y,col:P}=r.sourceCoords,{row:ie,col:b}=e.boardCoords;if(Y!==ie&&P!==b)return!1}if(r.maxDistanceFromSource!==void 0&&r.sourceCoords&&e.boardCoords){const{row:Y,col:P}=r.sourceCoords,{row:ie,col:b}=e.boardCoords;if(Math.max(Math.abs(Y-ie),Math.abs(P-b))>r.maxDistanceFromSource)return!1}if(r.maxOrthogonalDistance!==void 0&&r.sourceCoords&&e.boardCoords){const{row:Y,col:P}=r.sourceCoords,{row:ie,col:b}=e.boardCoords;if(Math.abs(Y-ie)+Math.abs(P-b)>r.maxOrthogonalDistance)return!1}return!0},vr=(e,r,n,o)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const l=[],E=r.board,_=E.length,m=r.activeGridSize,g=Math.floor((_-m)/2),I=g,A=g+m-1;if(e.type==="CREATE_STACK"){const b={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let S=I;S<=A;S++)for(let $=I;$<=A;$++){const se=E[S][$];se.card&&se.card.ownerId!==void 0&&Lt({card:se.card,ownerId:se.card.ownerId,location:"board",boardCoords:{row:S,col:$}},b,n,r.players)&&l.push({row:S,col:$})}return l}const{mode:x,payload:Y,sourceCoords:P,contextCheck:ie}=e;if(x==="REVEREND_DOUBLE_EXPLOIT"){for(let b=I;b<=A;b++)for(let S=I;S<=A;S++)E[b][S].card&&l.push({row:b,col:S});return l}if((x==="SELECT_TARGET"||x==="CENSOR_SWAP"||x==="ZEALOUS_WEAKEN"||x==="CENTURION_BUFF"||x==="SELECT_UNIT_FOR_MOVE")&&Y.filter&&typeof Y.filter=="function"){if(Y.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||Y.actionType==="LUCIUS_SETUP"||Y.actionType==="SELECT_HAND_FOR_DEPLOY"||Y.handOnly)return[];for(let b=I;b<=A;b++)for(let S=I;S<=A;S++){const $=E[b][S];let se=$.card&&Y.filter($.card,b,S);if(se&&ie==="ADJACENT_TO_LAST_MOVE"&&(o!=null&&o.lastMovedCardCoords)){const{row:Z,col:k}=o.lastMovedCardCoords;Math.abs(b-Z)+Math.abs(S-k)===1||(se=!1)}se&&l.push({row:b,col:S})}}else if(x==="SELECT_TARGET"&&(Y.actionType==="ENHANCED_INT_REVEAL"||Y.actionType==="ENHANCED_INT_MOVE"))for(let b=I;b<=A;b++)for(let S=I;S<=A;S++)E[b][S].card&&l.push({row:b,col:S});else if(x==="PATROL_MOVE"&&P)for(let b=I;b<=A;b++)for(let S=I;S<=A;S++){const $=b===P.row||S===P.col,se=b===P.row&&S===P.col,Z=!E[b][S].card;$&&(Z||se)&&l.push({row:b,col:S})}else if(x==="RIOT_PUSH"&&P){const b=[{r:P.row-1,c:P.col},{r:P.row+1,c:P.col},{r:P.row,c:P.col-1},{r:P.row,c:P.col+1}],S=($,se)=>$>=I&&$<=A&&se>=I&&se<=A;b.forEach($=>{if(S($.r,$.c)){const se=E[$.r][$.c].card;if(se&&se.ownerId!==n){const Z=r.players.find(J=>J.id===n),k=r.players.find(J=>J.id===se.ownerId);if(!((Z==null?void 0:Z.teamId)!==void 0&&(k==null?void 0:k.teamId)!==void 0&&Z.teamId===k.teamId)){const J=$.r-P.row,Te=$.c-P.col,Oe=$.r+J,Se=$.c+Te;S(Oe,Se)&&(E[Oe][Se].card||l.push({row:$.r,col:$.c}))}}}})}else if(x==="RIOT_MOVE"&&Y.vacatedCoords)l.push(Y.vacatedCoords),P&&l.push(P);else if(x==="SWAP_POSITIONS"&&Y.filter)for(let b=I;b<=A;b++)for(let S=I;S<=A;S++){const $=E[b][S];$.card&&Y.filter($.card,b,S)&&l.push({row:b,col:S})}else if((x==="TRANSFER_STATUS_SELECT"||x==="TRANSFER_ALL_STATUSES")&&Y.filter)for(let b=I;b<=A;b++)for(let S=I;S<=A;S++){const $=E[b][S];$.card&&Y.filter($.card,b,S)&&l.push({row:b,col:S})}else if(x==="SPAWN_TOKEN"||x==="SELECT_CELL"||x==="IMMUNIS_RETRIEVE")for(let b=I;b<=A;b++)for(let S=I;S<=A;S++){const $=!E[b][S].card;if(x==="IMMUNIS_RETRIEVE"&&Y.filter){$&&Y.filter(b,S)&&l.push({row:b,col:S});continue}if(x==="SELECT_CELL"){if(Y.moveFromHand){$&&l.push({row:b,col:S});continue}if(!P)continue;const se=b===P.row&&S===P.col,Z=Y.range==="global";let k=!1;if(Z)k=!0;else if(Y.range==="line")k=b===P.row||S===P.col;else if(Y.range===cr){const ne=Math.abs(b-P.row),J=Math.abs(S-P.col),Te=ne+J;if(Te===Kt)k=!0;else if(Te===cr){const Oe=[];ne===cr&&J===0?Oe.push({r:(b+P.row)/2,c:S}):ne===0&&J===cr?Oe.push({r:b,c:(S+P.col)/2}):ne===Kt&&J===Kt&&(Oe.push({r:b,c:P.col}),Oe.push({r:P.row,c:S})),k=Oe.some(Se=>Se.r<0||Se.r>=_||Se.c<0||Se.c>=_?!1:!E[Se.r][Se.c].card)}}else k=Math.abs(b-P.row)+Math.abs(S-P.col)===Kt;($&&k||Y.allowSelf&&se)&&l.push({row:b,col:S})}else if(x==="SPAWN_TOKEN"&&P){const se=Math.abs(b-P.row)+Math.abs(S-P.col)===1;$&&se&&l.push({row:b,col:S})}}else if(x==="REVEAL_ENEMY"&&Y.filter)for(let b=I;b<=A;b++)for(let S=I;S<=A;S++){const $=E[b][S];$.card&&Y.filter($.card,b,S)&&l.push({row:b,col:S})}else if(x==="SELECT_LINE_START")for(let b=I;b<=A;b++)for(let S=I;S<=A;S++)l.push({row:b,col:S});else if(x==="SELECT_LINE_END"&&Y.firstCoords){const{row:b,col:S}=Y.firstCoords;for(let $=I;$<=A;$++)l.push({row:b,col:$});for(let $=I;$<=A;$++)l.push({row:$,col:S})}else if(x==="INTEGRATOR_LINE_SELECT"&&P){const{row:b,col:S}=P;for(let $=I;$<=A;$++)l.push({row:b,col:$});for(let $=I;$<=A;$++)l.push({row:$,col:S})}else if(x==="ZIUS_LINE_SELECT"&&P){const{row:b,col:S}=P;for(let $=I;$<=A;$++)l.push({row:b,col:$});for(let $=I;$<=A;$++)l.push({row:$,col:S})}else if(x==="IP_AGENT_THREAT_SCORING"&&P){const{row:b,col:S}=P;for(let $=I;$<=A;$++)l.push({row:b,col:$});for(let $=I;$<=A;$++)l.push({row:$,col:S})}else if(x==="SELECT_DIAGONAL")if(Y.firstCoords){const{row:b,col:S}=Y.firstCoords;for(let $=I;$<=A;$++)for(let se=I;se<=A;se++)Math.abs($-b)===Math.abs(se-S)&&l.push({row:$,col:se})}else for(let b=I;b<=A;b++)for(let S=I;S<=A;S++)l.push({row:b,col:S});return l},lr=(e,r,n,o)=>{var E,_,m,g,I;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let A=0;A<r.board.length;A++)for(let x=0;x<r.board[A].length;x++)if(r.board[A][x].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((E=e.payload)!=null&&E.actionType)){const A=e.payload.actionType;if(A==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||A==="LUCIUS_SETUP"||A==="SELECT_HAND_FOR_DEPLOY"){const x=((_=e.sourceCard)==null?void 0:_.ownerId)||n;if(x!==null){const Y=r.players.find(P=>P.id===x);if(Y&&Y.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(vr(e,r,n,o).length>0)return!0;if(e.tokenType==="Revealed"||(m=e.tokenType)!=null&&m.startsWith("Power"))for(const x of r.players)for(let Y=0;Y<x.hand.length;Y++){const P={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(Lt({card:x.hand[Y],ownerId:x.id,location:"hand"},P,n,r.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((g=e.payload)!=null&&g.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const A of r.players)if(A.hand.some(x=>e.payload.filter(x))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return vr(e,r,n,o).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((I=e.payload)!=null&&I.filter),!1)};class xn{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,localStorage.getItem("webrtc_enabled")}async initializeAsHost(r){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((n,o)=>{this.peer=r?new nr(r):new nr,this.peer.on("open",l=>{this.emitEvent({type:"peer_open",data:{peerId:l}}),n(l)}),this.peer.on("connection",l=>{p.info(`Guest connection request from: ${l.peer}`),this.handleGuestConnection(l)}),this.peer.on("error",l=>{p.error("WebRTC Peer error:",l),this.emitEvent({type:"error",data:l}),o(l)}),this.peer.on("close",()=>{p.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(r){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((n,o)=>{this.peer=new nr,this.peer.on("open",l=>{const E=this.peer.connect(r,{reliable:!0,serialization:"json"});this.setupHostConnection(E),E.on("open",()=>{this.hostConnection=E,this.emitEvent({type:"connected_to_host",data:{hostPeerId:r}}),this.sendMessageToHost({type:"JOIN_REQUEST",senderId:l,timestamp:Date.now()}),n()}),E.on("error",_=>{p.error("Host connection error:",_),this.emitEvent({type:"error",data:_}),o(_)})}),this.peer.on("error",l=>{p.error("WebRTC Peer error:",l),this.emitEvent({type:"error",data:l}),o(l)})})}async initializeAsReconnectingGuest(r,n){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((o,l)=>{this.peer=new nr,this.peer.on("open",E=>{const _=this.peer.connect(r,{reliable:!0,serialization:"json"});this.setupHostConnection(_),_.on("open",()=>{this.hostConnection=_,this.emitEvent({type:"connected_to_host",data:{hostPeerId:r}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:E,playerId:n,timestamp:Date.now()}),this.isReconnecting=!1,o()}),_.on("error",m=>{p.error("Host connection error:",m),this.emitEvent({type:"error",data:m}),this.isReconnecting=!1,l(m)})}),this.peer.on("error",E=>{p.error("WebRTC Peer error:",E),this.emitEvent({type:"error",data:E}),this.isReconnecting=!1,l(E)})})}handleGuestConnection(r){this.connections.set(r.peer,r),r.on("open",()=>{p.info(`Guest connected: ${r.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:r.peer}})}),r.on("data",n=>{this.handleMessage(n,r)}),r.on("close",()=>{p.info(`Guest disconnected: ${r.peer}`),this.connections.delete(r.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:r.peer}})}),r.on("error",n=>{p.error(`Guest connection error (${r.peer}):`,n)})}setupHostConnection(r){this.hostConnection=r,r.on("data",n=>{this.handleMessage(n,r)}),r.on("close",()=>{p.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),r.on("error",n=>{p.error("Host connection error:",n)})}handleMessage(r,n){p.debug("Received WebRTC message:",r.type),this.emitEvent({type:"message_received",data:r})}sendMessageToHost(r){if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(r),!0}catch(n){return p.error("Failed to send message to host:",n),!1}return!1}broadcastToGuests(r,n){if(!this.isHost){p.warn("Only host can broadcast to guests");return}let o=0;this.connections.forEach((l,E)=>{if(l.open&&E!==n)try{l.send(r),o++}catch(_){p.error(`Failed to send to guest ${E}:`,_)}}),p.debug(`Broadcast to ${o}/${this.connections.size} guests`)}sendToGuest(r,n){if(!this.isHost)return p.warn("Only host can send to specific guest"),!1;const o=this.connections.get(r);if(!o)return p.error(`[sendToGuest] No connection found for guest ${r}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!o.open)return p.error(`[sendToGuest] Connection for guest ${r} is not open`),!1;try{return o.send(n),p.debug(`Sent message to guest ${r}`),!0}catch(l){return p.error(`[sendToGuest] Failed to send message to ${r}:`,l),!1}}acceptGuest(r,n,o){var _;const l=this.connections.get(r);if(!l){p.error(`[acceptGuest] No connection found for guest ${r}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!l.open){p.error(`[acceptGuest] Connection for guest ${r} is not open`);return}const E={type:"JOIN_ACCEPT",senderId:(_=this.peer)==null?void 0:_.id,playerId:o,data:{gameState:n},timestamp:Date.now()};try{l.send(E),p.info(`Accepted guest ${r} as player ${o}`)}catch(m){p.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${r}:`,m)}}acceptGuestMinimal(r,n,o){var _;const l=this.connections.get(r);if(!l){p.error(`[acceptGuestMinimal] No connection found for guest ${r}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!l.open){p.error(`[acceptGuestMinimal] Connection for guest ${r} is not open`);return}const E={type:"JOIN_ACCEPT_MINIMAL",senderId:(_=this.peer)==null?void 0:_.id,playerId:o,data:n,timestamp:Date.now()};try{l.send(E),p.info(`Accepted guest ${r} as player ${o} (minimal)`)}catch(m){p.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${r}:`,m)}}broadcastGameState(r,n){var l;const o={type:"STATE_UPDATE",senderId:(l=this.peer)==null?void 0:l.id,data:{gameState:r},timestamp:Date.now()};this.broadcastToGuests(o,n)}broadcastStateDelta(r,n){var l,E;const o={type:"STATE_DELTA",senderId:(l=this.peer)==null?void 0:l.id,data:{delta:r},timestamp:Date.now()};p.info(`[broadcastStateDelta] Preparing to send STATE_DELTA: playerDeltas=${Object.keys(r.playerDeltas||{}).length}, boardCells=${((E=r.boardCells)==null?void 0:E.length)||0}, phaseDelta=${!!r.phaseDelta}`),this.broadcastToGuests(o,n),p.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${r.sourcePlayerId} to ${this.connections.size} guests`)}sendAction(r,n){var l;const o={type:"ACTION",senderId:(l=this.peer)==null?void 0:l.id,data:{actionType:r,actionData:n},timestamp:Date.now()};return this.sendMessageToHost(o)}sendStateDelta(r){var o;const n={type:"STATE_DELTA",senderId:(o=this.peer)==null?void 0:o.id,data:{delta:r},timestamp:Date.now()};return this.sendMessageToHost(n)}getConnectionInfo(){const r=[];return this.isHost?this.connections.forEach((n,o)=>{r.push({peerId:o,playerId:null,playerName:null,connected:n.open})}):this.hostConnection&&r.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),r}getPeerId(){var r;return((r=this.peer)==null?void 0:r.id)||null}getHostPeerId(){var r,n;return this.isHost?((r=this.peer)==null?void 0:r.id)||null:((n=this.hostConnection)==null?void 0:n.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var r;return this.isHost?this.connections.size:(r=this.hostConnection)!=null&&r.open?1:0}on(r){return this.eventHandlers.add(r),()=>this.eventHandlers.delete(r)}emitEvent(r){this.eventHandlers.forEach(n=>{try{n(r)}catch(o){p.error("Error in WebRTC event handler:",o)}})}cleanup(){this.connections.forEach(r=>r.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let Cr=null;const $n=()=>(Cr||(Cr=new xn),Cr);function Un(e){return 10+e*10}function Lr(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const r=e.currentPhase===1,n=e.activePlayerId===e.startingPlayerId;if(!r||!n)return{shouldEnd:!1,roundWinners:[]};const o=e.currentRound||1,l=Un(o),E=[];for(const m of e.players)!m.isDummy&&!m.isDisconnected&&m.score>=l&&E.push(m.id);return{shouldEnd:E.length>0,roundWinners:E}}function la(e){const{shouldEnd:r,roundWinners:n}=Lr(e);if(!r)return e;const o=e.currentRound||1,l={...e.roundWinners,[o]:n},E=new Map;for(const[,m]of Object.entries(l))for(const g of m){const I=E.get(g)||0;E.set(g,I+1)}let _=null;for(const[m,g]of E.entries())if(g>=2){_=m;break}return p.info(`[endRound] Round ${o} ended. Winners: [${n.join(", ")}], Game winner: ${_||"none"}`),{...e,roundWinners:l,gameWinner:_,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function Mr(e,r){if(e.currentPhase!==0)return p.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const n=e.players.find(E=>E.id===r);if(!n)return p.error(`[performPreparationPhase] Active player ${r} not found!`),e;p.info(`[performPreparationPhase] Player ${r} has deck size: ${n.deck.length}, hand size: ${n.hand.length}`);const o=e.players.map(E=>{if(E.id===r&&E.deck.length>0){const _=E.deck[0],m=[...E.deck.slice(1)],g=[...E.hand,_];return p.info(`[performPreparationPhase] Player ${r} drew card ${(_==null?void 0:_.id)||"unknown"}, deck now: ${m.length}, hand: ${g.length}`),{...E,deck:m,hand:g,readySetup:!1,readyCommit:!1}}return E}),l={...e,players:o,currentPhase:1};return Lr(l).shouldEnd?la(l):(p.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${l.activePlayerId}`),l)}function ra(e,r){const n=e.activePlayerId;if(n===r){const m={...e,activePlayerId:null};return r===e.startingPlayerId&&e.currentPhase===1&&Lr(m).shouldEnd?la(m):m}if(!e.players.filter(m=>!m.isDisconnected).find(m=>m.id===r))return p.warn(`[toggleActivePlayer] Player ${r} not found or disconnected`),e;let E=e.turnNumber||1;r===e.startingPlayerId&&n!==null&&E++;const _={...e,activePlayerId:r,turnNumber:E,currentPhase:0};return Mr(_,r)}function Hn(e,r){const n=e.players.filter(E=>!E.isDisconnected).sort((E,_)=>E.id-_.id);if(n.length===0)return null;if(r===null)return n[0].id;const o=n.findIndex(E=>E.id===r);if(o===-1)return n[0].id;const l=(o+1)%n.length;return n[l].id}function Fn(e,r){var n;for(const o of e.board)for(const l of o)if(((n=l.card)==null?void 0:n.ownerId)===r)return!0;return!1}function ur(e){const r=Hn(e,e.activePlayerId);if(r===null)return p.warn("[passTurnToNextPlayer] No next player found"),e;p.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${r}`);let n={...e,board:e.board.map(o=>o.map(l=>{var E;return((E=l.card)==null?void 0:E.ownerId)===e.activePlayerId&&l.card.statuses?{...l,card:{...l.card,statuses:l.card.statuses.filter(_=>_.type!=="Stun")}}:l}))};return n={...n,board:n.board.map(o=>o.map(l=>l.card&&l.card.statuses?{...l,card:{...l.card,statuses:l.card.statuses.filter(E=>E.type!=="enteredThisTurn")}}:l))},n={...n,activePlayerId:r,currentPhase:0,isScoringStep:!1},Mr(n,r)}function Wn(e,r,n){const o=Or();let l=e;if(e==="Random"||!o[e]){const m=Object.keys(o);if(m.length===0)return p.error("[createDeckLocally] No decks loaded yet!"),[];l=m[0]}const E=o[l];if(!E)return p.error(`[createDeckLocally] Deck data for ${l} not found!`),[];const _=[...E].map(m=>({...m,ownerId:r,ownerName:n}));return fr(_)}function aa(e,r,n){var l,E;p.debug(`[applyStateDelta] Applying delta: sourcePlayerId=${r.sourcePlayerId}, boardCells=${((l=r.boardCells)==null?void 0:l.length)||0}, playerDeltas=${Object.keys(r.playerDeltas||{}).length}, phase=${!!r.phaseDelta}`);const o={...e};if(r.playerDeltas){const _=[],m=new Set;p.debug(`[applyStateDelta] Processing player deltas for ${Object.keys(r.playerDeltas).length} players`);for(const g of e.players){const I=r.playerDeltas[g.id];if(I!=null&&I.removed){p.debug(`[applyStateDelta] Player ${g.id} removed, filtering out`);continue}if(m.add(g.id),I){const A={...g},x=g.id===n,Y=A.isDummy||g.isDummy;if(Y&&(I.hand&&(p.debug(`[applyStateDelta] Dummy player ${g.id}: using full hand from delta (${I.hand.length} cards)`),A.hand=I.hand),I.deck&&(p.debug(`[applyStateDelta] Dummy player ${g.id}: using full deck from delta (${I.deck.length} cards)`),A.deck=I.deck),I.discard&&(p.debug(`[applyStateDelta] Dummy player ${g.id}: using full discard from delta (${I.discard.length} cards)`),A.discard=I.discard)),!Y||!I.hand&&!I.deck&&!I.discard){if(I.handSizeDelta!==void 0)if(x)p.debug(`[applyStateDelta] Local player ${g.id}: handSizeDelta=${I.handSizeDelta} (informational, skipping)`);else{const P=g.hand.length+I.handSizeDelta;if(p.debug(`[applyStateDelta] Player ${g.id}: hand ${g.hand.length} -> ${P} (delta: ${I.handSizeDelta})`),P<g.hand.length)A.hand=g.hand.slice(0,P);else if(P>g.hand.length){const ie=[];for(let b=g.hand.length;b<P;b++)ie.push({id:`placeholder_${g.id}_${b}`,name:"?",isPlaceholder:!0});A.hand=[...g.hand,...ie],p.debug(`[applyStateDelta] Added ${ie.length} placeholder cards to player ${g.id} hand`)}}if(I.deckSizeDelta!==void 0&&!x){const P=g.deck.length+I.deckSizeDelta;if(p.debug(`[applyStateDelta] Player ${g.id}: deck ${g.deck.length} -> ${P} (delta: ${I.deckSizeDelta})`),P<g.deck.length)A.deck=g.deck.slice(0,P);else if(P>g.deck.length){const ie=[];for(let b=g.deck.length;b<P;b++)ie.push({id:`placeholder_${g.id}_deck_${b}`,name:"?",isPlaceholder:!0});A.deck=[...g.deck,...ie]}}if(I.discardAdd&&(A.discard=[...A.discard,...I.discardAdd]),I.discardClear&&(A.discard=[]),I.discardSizeDelta!==void 0&&!I.discardAdd&&!x){const P=g.discard.length+I.discardSizeDelta;if(P<g.discard.length)A.discard=g.discard.slice(0,P);else if(P>g.discard.length){const ie=[];for(let b=g.discard.length;b<P;b++)ie.push({id:`placeholder_${g.id}_discard_${b}`,name:"?",isPlaceholder:!0});A.discard=[...g.discard,...ie]}}}I.scoreDelta!==void 0&&(A.score=Math.max(0,g.score+I.scoreDelta)),I.isReady!==void 0&&(A.isReady=I.isReady),I.selectedDeck!==void 0&&(A.selectedDeck=I.selectedDeck),I.name!==void 0&&(A.name=I.name),I.color!==void 0&&(A.color=I.color),I.isDisconnected!==void 0&&(A.isDisconnected=I.isDisconnected),I.isDummy!==void 0&&(A.isDummy=I.isDummy),I.announcedCard!==void 0&&(p.debug(`[applyStateDelta] Player ${g.id} announcedCard updated:`,((E=I.announcedCard)==null?void 0:E.id)||"null"),A.announcedCard=I.announcedCard),I.boardHistory!==void 0&&(A.boardHistory=[...I.boardHistory]),I.teamId!==void 0&&(A.teamId=I.teamId),I.autoDrawEnabled!==void 0&&(A.autoDrawEnabled=I.autoDrawEnabled),_.push(A)}else _.push(g)}for(const[g,I]of Object.entries(r.playerDeltas)){const A=Number(g);if(!m.has(A)&&!I.removed){p.debug(`[applyStateDelta] Adding new player ${A} (${I.name||"Unknown"}), isDummy=${I.isDummy}`);const x={id:A,name:I.name||`Player ${A}`,color:I.color||"blue",isDummy:I.isDummy||!1,isReady:I.isReady||!1,score:0,selectedDeck:I.selectedDeck||"Random",boardHistory:I.boardHistory||[],isDisconnected:I.isDisconnected||!1,autoDrawEnabled:I.autoDrawEnabled!==void 0?I.autoDrawEnabled:!0},Y=(P,ie)=>({id:`placeholder_${A}_${ie}_${P}`,name:"?",isPlaceholder:!0,ownerId:A,color:x.color,deck:x.selectedDeck});if(I.isDummy){if(I.hand)x.hand=I.hand,p.debug(`[applyStateDelta] New dummy player ${A}: using full hand from delta (${x.hand.length} cards)`);else{const P=I.handSizeDelta||0;x.hand=[];for(let ie=0;ie<P;ie++)x.hand.push(Y(ie,"hand"))}if(I.deck)x.deck=I.deck,p.debug(`[applyStateDelta] New dummy player ${A}: using full deck from delta (${x.deck.length} cards)`);else{const P=x.selectedDeck||"Random",ie=Wn(P,A,x.name),b=I.deckSizeDelta||ie.length;if(ie.length>b){const S=ie.length-b;x.deck=ie.slice(S)}else x.deck=ie;p.debug(`[applyStateDelta] New dummy player ${A}: generated deck locally (${x.deck.length} cards, deckType=${P})`)}if(I.discard)x.discard=I.discard,p.debug(`[applyStateDelta] New dummy player ${A}: using full discard from delta (${x.discard.length} cards)`);else{const P=I.discardSizeDelta||0;x.discard=[];for(let ie=0;ie<P;ie++)x.discard.push(Y(ie,"discard"))}p.debug(`[applyStateDelta] New dummy player ${A}: hand=${x.hand.length}, deck=${x.deck.length}, discard=${x.discard.length}`)}else{const P=I.handSizeDelta||0,ie=I.deckSizeDelta||0,b=I.discardSizeDelta||0;x.hand=[];for(let S=0;S<P;S++)x.hand.push(Y(S,"hand"));x.deck=[];for(let S=0;S<ie;S++)x.deck.push(Y(S,"deck"));x.discard=[];for(let S=0;S<b;S++)x.discard.push(Y(S,"discard"))}I.announcedCard!==void 0?x.announcedCard=I.announcedCard:x.announcedCard=null,_.push(x)}}p.debug(`[applyStateDelta] Player count: ${e.players.length} -> ${_.length}`),o.players=_}if(r.boardCells&&r.boardCells.length>0&&(p.debug(`[applyStateDelta] Applying ${r.boardCells.length} board cell changes`),o.board=e.board.map((_,m)=>_.map((g,I)=>{var Y,P,ie,b,S,$,se;const A=r.boardCells.find(Z=>Z.row===m&&Z.col===I);if(!A)return g;const x={...g};if(A.card!==void 0){const Z=((P=(Y=A.card)==null?void 0:Y.statuses)==null?void 0:P.length)||0,k=((b=(ie=A.card)==null?void 0:ie.statuses)==null?void 0:b.map(ne=>ne.type).join(","))||"none";p.debug(`[applyStateDelta] Cell [${m},${I}]: card ${A.card?"added":"removed"}, name: ${((S=A.card)==null?void 0:S.name)||"N/A"}, statuses: [${k}] (count: ${Z})`),x.card=A.card}if(A.cardStatuses&&x.card){p.debug(`[applyStateDelta] Cell [${m},${I}]: applying cardStatuses, remove=${($=A.cardStatuses.remove)==null?void 0:$.join(",")}, add count=${((se=A.cardStatuses.add)==null?void 0:se.length)||0}`);const Z={...x.card};if(Z.statuses||(Z.statuses=[]),A.cardStatuses.clear)Z.statuses=[];else{if(A.cardStatuses.remove&&A.cardStatuses.remove.length>0){const k=A.cardStatuses.remove,ne=Z.statuses.length;Z.statuses=Z.statuses.filter(Te=>!k.includes(Te.type));const J=Z.statuses.length;ne!==J&&p.debug(`[applyStateDelta] Cell [${m},${I}]: removed ${ne-J} statuses with types: ${k.join(",")}`)}A.cardStatuses.add&&A.cardStatuses.add.length>0&&(Z.statuses=[...Z.statuses,...A.cardStatuses.add],p.debug(`[applyStateDelta] Cell [${m},${I}]: added ${A.cardStatuses.add.length} statuses`))}x.card=Z}if(A.cardPowerDelta!==void 0&&x.card){const Z={...x.card};Z.power=Number(Z.power??0)+A.cardPowerDelta,x.card=Z}if(A.cardPowerModifier!==void 0&&x.card){p.debug(`[applyStateDelta] Applying powerModifier at [${m},${I}]: ${x.card.powerModifier} -> ${A.cardPowerModifier}`);const Z={...x.card};Z.powerModifier=A.cardPowerModifier,x.card=Z}return x}))),r.phaseDelta&&(r.phaseDelta.currentPhase!==void 0&&(o.currentPhase=r.phaseDelta.currentPhase),r.phaseDelta.isScoringStep!==void 0&&(o.isScoringStep=r.phaseDelta.isScoringStep),r.phaseDelta.activePlayerId!==void 0&&(o.activePlayerId=r.phaseDelta.activePlayerId),r.phaseDelta.startingPlayerId!==void 0&&(o.startingPlayerId=r.phaseDelta.startingPlayerId)),r.roundDelta&&(r.roundDelta.currentRound!==void 0&&(o.currentRound=r.roundDelta.currentRound),r.roundDelta.turnNumber!==void 0&&(o.turnNumber=r.roundDelta.turnNumber),r.roundDelta.roundEndTriggered!==void 0&&(o.roundEndTriggered=r.roundDelta.roundEndTriggered),r.roundDelta.roundWinners!==void 0&&(o.roundWinners={...r.roundDelta.roundWinners}),r.roundDelta.gameWinner!==void 0&&(o.gameWinner=r.roundDelta.gameWinner),r.roundDelta.isRoundEndModalOpen!==void 0&&(o.isRoundEndModalOpen=r.roundDelta.isRoundEndModalOpen)),r.settingsDelta){if(r.settingsDelta.activeGridSize!==void 0&&(o.activeGridSize=r.settingsDelta.activeGridSize,e.board.length!==r.settingsDelta.activeGridSize)){const _=r.settingsDelta.activeGridSize;o.board=[];for(let m=0;m<_;m++){const g=[];for(let I=0;I<_;I++)g.push({card:null});o.board.push(g)}}r.settingsDelta.gameMode!==void 0&&(o.gameMode=r.settingsDelta.gameMode,p.debug(`[applyStateDelta] Game mode changed to ${r.settingsDelta.gameMode}`)),r.settingsDelta.isPrivate!==void 0&&(o.isPrivate=r.settingsDelta.isPrivate,p.debug(`[applyStateDelta] Game privacy changed to ${r.settingsDelta.isPrivate}`)),r.settingsDelta.dummyPlayerCount!==void 0&&(o.dummyPlayerCount=r.settingsDelta.dummyPlayerCount,p.debug(`[applyStateDelta] Dummy player count changed to ${r.settingsDelta.dummyPlayerCount}`))}if(r.highlightsDelta)if(r.highlightsDelta.clear)o.highlights=[];else{let _=[...e.highlights];r.highlightsDelta.remove&&(_=_.filter(m=>!r.highlightsDelta.remove.includes(m.timestamp))),r.highlightsDelta.add&&(_=[..._,...r.highlightsDelta.add]),o.highlights=_}return r.floatingTextsDelta&&(r.floatingTextsDelta.clear?o.floatingTexts=[]:r.floatingTextsDelta.add&&(o.floatingTexts=[...e.floatingTexts,...r.floatingTextsDelta.add])),r.targetingModeDelta&&(r.targetingModeDelta.clear?o.targetingMode=null:r.targetingModeDelta.set&&(o.targetingMode=r.targetingModeDelta.set)),r.abilityModeDelta&&(o.abilityMode=r.abilityModeDelta),o}function Ht(e,r,n){var m,g,I,A,x,Y,P,ie,b,S,$,se,Z,k,ne,J,Te,Oe,Se,we,Ee;const o={timestamp:Date.now(),sourcePlayerId:n};(e.currentPhase!==r.currentPhase||e.isScoringStep!==r.isScoringStep||e.activePlayerId!==r.activePlayerId||e.startingPlayerId!==r.startingPlayerId)&&(o.phaseDelta={...e.currentPhase!==r.currentPhase&&{currentPhase:r.currentPhase},...e.isScoringStep!==r.isScoringStep&&{isScoringStep:r.isScoringStep},...e.activePlayerId!==r.activePlayerId&&{activePlayerId:r.activePlayerId},...e.startingPlayerId!==r.startingPlayerId&&{startingPlayerId:r.startingPlayerId}}),(e.currentRound!==r.currentRound||e.turnNumber!==r.turnNumber||e.roundEndTriggered!==r.roundEndTriggered||e.gameWinner!==r.gameWinner||e.isRoundEndModalOpen!==r.isRoundEndModalOpen)&&(o.roundDelta={...e.currentRound!==r.currentRound&&{currentRound:r.currentRound},...e.turnNumber!==r.turnNumber&&{turnNumber:r.turnNumber},...e.roundEndTriggered!==r.roundEndTriggered&&{roundEndTriggered:r.roundEndTriggered},...e.gameWinner!==r.gameWinner&&{gameWinner:r.gameWinner},...e.isRoundEndModalOpen!==r.isRoundEndModalOpen&&{isRoundEndModalOpen:r.isRoundEndModalOpen}}),(e.activeGridSize!==r.activeGridSize||e.gameMode!==r.gameMode||e.isPrivate!==r.isPrivate||e.dummyPlayerCount!==r.dummyPlayerCount)&&(o.settingsDelta={...e.activeGridSize!==r.activeGridSize&&{activeGridSize:r.activeGridSize},...e.gameMode!==r.gameMode&&{gameMode:r.gameMode},...e.isPrivate!==r.isPrivate&&{isPrivate:r.isPrivate},...e.dummyPlayerCount!==r.dummyPlayerCount&&{dummyPlayerCount:r.dummyPlayerCount}},p.debug("[createDeltaFromStates] Settings changed:",o.settingsDelta));const l=[],E=Math.max(e.board.length,r.board.length);for(let G=0;G<E;G++){const V=Math.max(((m=e.board[G])==null?void 0:m.length)||0,((g=r.board[G])==null?void 0:g.length)||0);for(let X=0;X<V;X++){const oe=(I=e.board[G])==null?void 0:I[X],j=(A=r.board[G])==null?void 0:A[X];if(!oe&&!j)continue;const be=(x=oe==null?void 0:oe.card)==null?void 0:x.id,me=(Y=j==null?void 0:j.card)==null?void 0:Y.id;if(be!==me){const Be=((ie=(P=j==null?void 0:j.card)==null?void 0:P.statuses)==null?void 0:ie.length)||0,De=((S=(b=j==null?void 0:j.card)==null?void 0:b.statuses)==null?void 0:S.map(Ce=>Ce.type).join(","))||"none";p.debug(`[createDeltaFromStates] Cell [${G},${X}]: card changed, new card: ${(($=j==null?void 0:j.card)==null?void 0:$.name)||"null"}, statuses: [${De}] (count: ${Be})`),l.push({row:G,col:X,card:(j==null?void 0:j.card)||null})}else if(oe!=null&&oe.card&&(j!=null&&j.card)){const Be={row:G,col:X},De=((se=oe==null?void 0:oe.card)==null?void 0:se.statuses)||[],Ce=((Z=j==null?void 0:j.card)==null?void 0:Z.statuses)||[];if(De.length>0||Ce.length>0){const tt=De.map(F=>F.type).join(","),Ze=Ce.map(F=>F.type).join(",");tt!==Ze&&p.debug(`[createDeltaFromStates] Cell [${G},${X}] (${j.card.name}): statuses differ - old: [${tt}], new: [${Ze}]`)}const Xe=[],ze=[];if(De.length!==Ce.length){const tt=new Map,Ze=new Map;for(const F of De){const Ve=`${F.type}_${F.addedByPlayerId}`;tt.has(Ve)||tt.set(Ve,[]),tt.get(Ve).push(F)}for(const F of Ce){const Ve=`${F.type}_${F.addedByPlayerId}`;Ze.has(Ve)||Ze.set(Ve,[]),Ze.get(Ve).push(F)}for(const[F,Ve]of tt){const f=Ze.get(F),C=Ve.length,Q=f?f.length:0;if(Q<C){const Ie=C-Q;for(let re=0;re<Ie;re++)ze.push(Ve[re].type)}}for(const[F,Ve]of Ze){const f=tt.get(F),C=Ve.length,Q=f?f.length:0;if(C>Q)for(let Ie=Q;Ie<C;Ie++)Xe.push(Ve[Ie])}p.debug(`[createDeltaFromStates] Cell [${G},${X}]: status length changed ${De.length} -> ${Ce.length}, added: ${Xe.length}, removed: ${ze.join(",")}`)}else for(let tt=0;tt<De.length;tt++){const Ze=De[tt],F=Ce[tt];(Ze.type!==F.type||Ze.addedByPlayerId!==F.addedByPlayerId)&&(ze.push(Ze.type),Xe.push(F),p.debug(`[createDeltaFromStates] Cell [${G},${X}]: status replaced at index ${tt}: ${Ze.type} -> ${F.type}`))}(Xe.length>0||ze.length>0)&&(Be.cardStatuses={...Xe.length>0&&{add:Xe},...ze.length>0&&{remove:ze}},p.debug(`[createDeltaFromStates] Cell [${G},${X}]: cardStatuses delta created, remove: [${ze.join(",")}], add: ${Xe.map(tt=>tt.type).join(",")}`));const pe=Number(((k=oe==null?void 0:oe.card)==null?void 0:k.power)??0),st=Number(((ne=j==null?void 0:j.card)==null?void 0:ne.power)??0);pe!==st&&(Be.cardPowerDelta=st-pe);const Tt=(J=oe==null?void 0:oe.card)==null?void 0:J.powerModifier,gt=(Te=j==null?void 0:j.card)==null?void 0:Te.powerModifier;Tt!==gt&&(Be.cardPowerModifier=gt),Object.keys(Be).length>2&&l.push(Be)}}}l.length>0&&(o.boardCells=l);const _={};for(const G of r.players){const V=e.players.find(me=>me.id===G.id);if(!V){p.debug(`[createDeltaFromStates] New player added: ${G.id} (${G.name}), isDummy=${G.isDummy}`);const me={id:G.id,name:G.name,color:G.color,isDummy:G.isDummy,isReady:G.isReady,selectedDeck:G.selectedDeck,isDisconnected:G.isDisconnected,handSizeDelta:G.hand.length,deckSizeDelta:G.deck.length,discardSizeDelta:G.discard.length,announcedCard:G.announcedCard};_[G.id]=me,p.debug(`[createDeltaFromStates] New player delta: sizes hand=${G.hand.length}, deck=${G.deck.length}, discard=${G.discard.length}`);continue}const X={id:G.id};V.score!==G.score&&(X.scoreDelta=G.score-V.score),V.isReady!==G.isReady&&(X.isReady=G.isReady),V.selectedDeck!==G.selectedDeck&&(X.selectedDeck=G.selectedDeck),V.name!==G.name&&(X.name=G.name),V.color!==G.color&&(X.color=G.color),V.isDisconnected!==G.isDisconnected&&(X.isDisconnected=G.isDisconnected),G.isDummy?(X.isDummy=!0,V.hand.length===0&&G.hand.length>0&&G.hand.length>0&&(X.hand=[...G.hand],p.debug(`[createDeltaFromStates] Dummy player ${G.id}: game start, sending full hand (${G.hand.length} cards)`)),V.hand.length!==G.hand.length&&(X.handSizeDelta=G.hand.length-V.hand.length,p.debug(`[createDeltaFromStates] Dummy player ${G.id}: hand size delta: ${X.handSizeDelta}`)),V.deck.length!==G.deck.length&&(X.deckSizeDelta=G.deck.length-V.deck.length,p.debug(`[createDeltaFromStates] Dummy player ${G.id}: deck size delta: ${X.deckSizeDelta}`)),V.discard.length!==G.discard.length&&(X.discardSizeDelta=G.discard.length-V.discard.length,p.debug(`[createDeltaFromStates] Dummy player ${G.id}: discard size delta: ${X.discardSizeDelta}`))):(V.hand.length!==G.hand.length&&(X.handSizeDelta=G.hand.length-V.hand.length),V.deck.length!==G.deck.length&&(X.deckSizeDelta=G.deck.length-V.deck.length),V.discard.length!==G.discard.length&&(X.discardSizeDelta=G.discard.length-V.discard.length,G.discard.length>V.discard.length&&(X.discardAdd=G.discard.slice(V.discard.length))));const oe=V.announcedCard,j=G.announcedCard;(!oe!=!j||oe&&j&&(oe.id!==j.id||oe.power!==j.power||oe.powerModifier!==j.powerModifier||(((Oe=oe.statuses)==null?void 0:Oe.length)??0)!==(((Se=j.statuses)==null?void 0:Se.length)??0)||JSON.stringify(oe.statuses)!==JSON.stringify(j.statuses)))&&(X.announcedCard=j?{...j}:null,p.debug(`[createDeltaFromStates] Player ${G.id} announcedCard changed:`,oe==null?void 0:oe.id,"->",j==null?void 0:j.id)),JSON.stringify(V.boardHistory)!==JSON.stringify(G.boardHistory)&&(X.boardHistory=[...G.boardHistory]),V.teamId!==G.teamId&&(X.teamId=G.teamId),V.autoDrawEnabled!==G.autoDrawEnabled&&(X.autoDrawEnabled=G.autoDrawEnabled),V.selectedDeck!==G.selectedDeck&&(X.selectedDeck=G.selectedDeck,p.debug(`[createDeltaFromStates] Player ${G.id} selectedDeck changed: ${V.selectedDeck} -> ${G.selectedDeck}`)),Object.keys(X).length>1&&(_[G.id]=X)}for(const G of e.players)r.players.find(X=>X.id===G.id)||(p.debug(`[createDeltaFromStates] Player removed: ${G.id} (${G.name})`),_[G.id]={id:G.id,removed:!0});return Object.keys(_).length>0&&(o.playerDeltas=_),JSON.stringify(e.abilityMode)!==JSON.stringify(r.abilityMode)&&(o.abilityModeDelta=r.abilityMode,p.debug("[createDeltaFromStates] abilityMode changed:",(we=e.abilityMode)==null?void 0:we.mode,"->",(Ee=r.abilityMode)==null?void 0:Ee.mode)),JSON.stringify(e.targetingMode)!==JSON.stringify(r.targetingMode)&&(r.targetingMode===null?o.targetingModeDelta={clear:!0}:o.targetingModeDelta={set:r.targetingMode}),o}function Nt(e){var r;return!e.phaseDelta&&!e.roundDelta&&!e.settingsDelta&&!((r=e.boardCells)!=null&&r.length)&&!e.playerDeltas&&!e.highlightsDelta&&!e.floatingTextsDelta&&!e.targetingModeDelta&&!e.abilityModeDelta}function Bn(e,r){return{type:"RECONNECT_SNAPSHOT",data:{gameId:e.gameId??"",gameMode:e.gameMode,isPrivate:e.isPrivate,isGameStarted:e.isGameStarted,isReadyCheckActive:e.isReadyCheckActive,activeGridSize:e.activeGridSize,currentPhase:e.currentPhase,isScoringStep:e.isScoringStep,activePlayerId:e.activePlayerId,startingPlayerId:e.startingPlayerId,currentRound:e.currentRound,turnNumber:e.turnNumber,roundWinners:e.roundWinners,gameWinner:e.gameWinner,isRoundEndModalOpen:e.isRoundEndModalOpen,dummyPlayerCount:e.dummyPlayerCount,players:e.players.map(n=>({id:n.id,name:n.name,color:typeof n.color=="string"?n.color:"blue",isDummy:n.isDummy??!1,isReady:n.isReady??!1,isDisconnected:n.isDisconnected??!1,score:n.score,selectedDeck:n.selectedDeck,autoDrawEnabled:n.autoDrawEnabled??!1,teamId:n.teamId,handSize:n.hand.length,deckSize:n.deck.length,discardSize:n.discard.length,announcedCard:n.announcedCard,boardHistory:n.boardHistory??[]})),board:e.board}}}const Yn=()=>{const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return p.warn("No custom WebSocket URL configured in settings."),null;let r=e.trim();return r.endsWith("/")&&(r=r.slice(0,-1)),r.startsWith("https://")?r=r.replace("https://","wss://"):r.startsWith("http://")&&(r=r.replace("http://","ws://")),!r.startsWith("ws://")&&!r.startsWith("wss://")?(p.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",r),r)},na=()=>Math.random().toString(36).substring(2,18).toUpperCase(),oa=(e,r)=>{var o;e.forEach(l=>l.forEach(E=>{var _;(_=E.card)!=null&&_.statuses&&(E.card.statuses=E.card.statuses.filter(m=>!(m.type==="LastPlayed"&&m.addedByPlayerId===r.id)))})),r.boardHistory||(r.boardHistory=[]);let n=!1;for(;r.boardHistory.length>0&&!n;){const l=r.boardHistory[r.boardHistory.length-1];for(let E=0;E<e.length;E++){for(let _=0;_<e[E].length;_++)if(((o=e[E][_].card)==null?void 0:o.id)===l){const m=e[E][_].card;if(!m||m.ownerId!==r.id)continue;m.statuses||(m.statuses=[]),m.statuses.push({type:"LastPlayed",addedByPlayerId:r.id}),n=!0;break}if(n)break}n||r.boardHistory.pop()}},yr="avalon_game_state",kt="reconnection_data",At=new Map,zt=e=>{var o;if(!e||!St)return e;const{cardDatabase:r,tokenDatabase:n}=St;if(e.deck===ct.Tokens||(o=e.id)!=null&&o.startsWith("TKN_")){if(e.baseId&&n[e.baseId]){const E=n[e.baseId];return{...e,imageUrl:E.imageUrl,fallbackImage:E.fallbackImage}}const l=Object.keys(n).find(E=>n[E].name===e.name);if(l){const E=n[l];return{...e,imageUrl:E.imageUrl,fallbackImage:E.fallbackImage,baseId:l}}}else if(e.baseId&&r[e.baseId]){const l=r[e.baseId];return{...e,imageUrl:l.imageUrl,fallbackImage:l.fallbackImage}}return e},Xt=e=>{var o,l;if(!St)return e;const r=((o=e.board)==null?void 0:o.map(E=>E.map(_=>({..._,card:_.card?zt(_.card):null}))))||e.board,n=((l=e.players)==null?void 0:l.map(E=>{var _,m,g;return{...E,hand:((_=E.hand)==null?void 0:_.map(zt))||[],deck:((m=E.deck)==null?void 0:m.map(zt))||[],discard:((g=E.discard)==null?void 0:g.map(zt))||[],announcedCard:E.announcedCard?zt(E.announcedCard):null}}))||e.players;return{...e,board:r,players:n,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}},sa=(e,r,n)=>{try{const o=Xt(e),l={gameState:o,localPlayerId:r,playerToken:n,timestamp:Date.now()};localStorage.setItem(yr,JSON.stringify(l)),o.gameId&&r!==null&&localStorage.setItem(kt,JSON.stringify({gameId:o.gameId,playerId:r,playerToken:n||null,timestamp:Date.now()}))}catch(o){console.warn("Failed to save game state:",o)}},zn=()=>{try{const e=localStorage.getItem(yr);if(!e)return null;const r=JSON.parse(e),n=24*60*60*1e3;if(Date.now()-r.timestamp>n)return localStorage.removeItem(yr),localStorage.removeItem(kt),null;const o=r.gameState;return{gameState:Xt(o),localPlayerId:r.localPlayerId,playerToken:r.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}},Ft=()=>{localStorage.removeItem(yr),localStorage.removeItem(kt)},co=(e={})=>{const{abilityMode:r,setAbilityMode:n}=e,o=O.useCallback((t,i,a)=>{const s=Or();let c=t;if(t==="Random"||!s[t]){const u=Object.keys(s);if(u.length===0)return console.error("[createDeck] No decks loaded yet!"),[];c=u[0],t==="Random"?console.log(`[createDeck] Random deck selected, using ${c} instead`):console.warn(`[createDeck] Deck ${t} not found, using ${c} instead`)}const d=s[c];if(!d)return console.error(`Deck data for ${c} not loaded! Returning empty deck. Available decks:`,Object.keys(s)),[];const y=[...d].map(u=>({...u,ownerId:i,ownerName:a}));return fr(y)},[]),l=O.useCallback((t,i=!1)=>{const a=Or(),s=Object.keys(a);if(s.length===0)return console.error("[createNewPlayer] No decks loaded yet!"),{id:t,name:i?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:or[t-1]||"blue",isDummy:i,isReady:!1,boardHistory:[],autoDrawEnabled:!0};const c=s[0],d={id:t,name:i?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:c,color:or[t-1]||"blue",isDummy:i,isReady:!1,boardHistory:[],autoDrawEnabled:!0};return d.deck=o(c,t,d.name),d},[o]),E=O.useCallback(()=>({players:[],spectators:[],board:ea(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:Rr.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}),[]),[_,m]=O.useState(E()),g=O.useRef(E()),I=O.useCallback((t,i)=>{m(a=>{const s=typeof t=="function"?t(a):t;return g.current=a,localStorage.getItem("webrtc_enabled")==="true"&&pe.current&&setTimeout(()=>{var y;const d=Ht(a,s,i||q.current||0);!Nt(d)&&D.current&&(D.current.broadcastStateDelta(d),p.debug(`[setGameStateWithDelta] Broadcast delta: phase=${!!d.phaseDelta}, round=${!!d.roundDelta}, board=${((y=d.boardCells)==null?void 0:y.length)||0}, players=${Object.keys(d.playerDeltas||{}).length}`))},0),s})},[]),[A,x]=O.useState(null),[Y,P]=O.useState(null),[ie,b]=O.useState("Connecting"),[S,$]=O.useState([]),[se,Z]=O.useState(null),[k,ne]=O.useState(null),[J,Te]=O.useState(null),[Oe,Se]=O.useState([]),[we,Ee]=O.useState([]),[G,V]=O.useState([]),[X,oe]=O.useState(null),[j,be]=O.useState(!!St),[me,Be]=O.useState(!1),[De,Ce]=O.useState(null),[Xe,ze]=O.useState(!1),pe=O.useRef(!1),[st,Tt]=O.useState(!1),[gt,tt]=O.useState(null),Ze=O.useRef(!1),F=O.useRef(null),Ve=O.useRef(null),f=O.useRef(null),C=O.useRef(!1),Q=O.useRef(!1),Ie=O.useRef(void 0),re=O.useRef(!1),D=O.useRef(null),Ke=O.useRef(()=>{});O.useEffect(()=>{Ke.current=I},[I]),O.useEffect(()=>{pe.current=Xe},[Xe]),O.useEffect(()=>{const t=localStorage.getItem("webrtc_enabled")==="true";if(Be(t),t){D.current=$n();const i=D.current.on(a=>{_t(a)});return()=>{i()}}},[]),O.useEffect(()=>{if(!(localStorage.getItem("webrtc_enabled")==="true"))return;const i=window.location.hash.slice(1);if(i&&new URLSearchParams(i).get("hostId"))return;const a=vn();a!=="none"&&setTimeout(async()=>{var s,c;if(!D.current){p.warn("[Auto-restore] WebRTC manager not ready");return}try{if(a==="host"){Qe.current=!0,p.info("[Auto-restore] Setting restoration flag to prevent premature exit");const d=da(),y=Zr();if(!d||!y){p.warn("[Auto-restore] Missing host data or state data"),Ut(),Qe.current=!1;return}p.info(`[Auto-restore] Restoring host session: old peerId=${d.peerId}`);const u=await D.current.initializeAsHost();pe.current=!0,ze(!0),Ce(u),b("Connected"),(s=y.gameState)!=null&&s.gameId&&(_r(u,y.gameState.gameId),p.info(`[Auto-restore] Broadcasted NEW host peerId ${u} for game ${y.gameState.gameId}`)),(y.gameState||y.localPlayerId!==null)&&(y.gameState&&(B.current=y.gameState),y.localPlayerId!==null&&(q.current=y.localPlayerId),Ze.current=!0,setTimeout(()=>{Ze.current=!1},1e4),setTimeout(()=>{var R;y.gameState&&(m(y.gameState),p.info(`[Auto-restore] Restored game state with ${((R=y.gameState.players)==null?void 0:R.length)||0} players, gameId=${y.gameState.gameId}`)),y.localPlayerId!==null&&(x(y.localPlayerId),p.info(`[Auto-restore] Restored local player ID: ${y.localPlayerId}`))},0)),setTimeout(()=>{Qe.current=!1,p.info("[Auto-restore] Cleared restoration flag")},100),p.info("[Auto-restore] Host session restoration initiated")}else if(a==="guest"){Qe.current=!0,p.info("[Auto-restore] Setting restoration flag to prevent premature exit");const d=ca(),y=Zr();if(!d||!y){p.warn("[Auto-restore] Missing guest data or state data"),Ut(),Qe.current=!1;return}p.info(`[Auto-restore] Restoring guest session: old hostPeerId=${d.hostPeerId}, playerId=${d.playerId}`),pe.current=!1,ze(!1),b("Connecting");let u=d.hostPeerId;if((c=y.gameState)!=null&&c.gameId){const R=wr(y.gameState.gameId);R&&R.peerId&&(u=R.peerId,p.info(`[Auto-restore] Found NEW host peerId in localStorage: ${u}`))}if(Ce(u),d.playerId!==null){p.info(`[Auto-restore] Reconnecting as existing player ${d.playerId} to host ${u}`);try{await D.current.initializeAsReconnectingGuest(u,d.playerId),b("Connected"),p.info("[Auto-restore] Successfully reconnected to host")}catch(R){p.error("[Auto-restore] Failed to reconnect to host:",R),b("Disconnected"),Ut(),p.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),Qe.current=!1;return}}else p.info("[Auto-restore] Connecting as new player"),await D.current.initializeAsGuest(u),b("Connected");(y.gameState||y.localPlayerId!==null)&&(y.gameState&&(B.current=y.gameState),y.localPlayerId!==null&&(q.current=y.localPlayerId),Ze.current=!0,setTimeout(()=>{Ze.current=!1},1e4),setTimeout(()=>{var R,H;if(y.gameState&&(m(y.gameState),p.info(`[Auto-restore] Restored game state with ${((R=y.gameState.players)==null?void 0:R.length)||0} players, gameId=${y.gameState.gameId}, isGameStarted=${y.gameState.isGameStarted}`),y.localPlayerId!==null)){const ee=(H=y.gameState.players)==null?void 0:H.some(qe=>qe.id===y.localPlayerId);p.info(`[Auto-restore] Player ${y.localPlayerId} exists in restored state: ${ee}`)}y.localPlayerId!==null&&(x(y.localPlayerId),p.info(`[Auto-restore] Restored local player ID: ${y.localPlayerId}`))},0)),setTimeout(()=>{Qe.current=!1,p.info("[Auto-restore] Cleared restoration flag")},100),p.info("[Auto-restore] Guest session restoration initiated")}}catch(d){p.error("[Auto-restore] Failed to restore session:",d),Ut(),Qe.current=!1}},100)},[]),O.useEffect(()=>{if(!me||!D.current)return;const t=window.location.hash.slice(1);if(!t)return;const a=new URLSearchParams(t).get("hostId");a&&L(a)},[me]);const B=O.useRef(_);O.useEffect(()=>{B.current=_},[_]);const q=O.useRef(A);O.useEffect(()=>{q.current=A},[A]);const Qe=O.useRef(!1);O.useEffect(()=>{if(!me||!pe.current||!(_!=null&&_.gameId))return;const t=_.gameId,i=()=>{var c;const s=(c=D.current)==null?void 0:c.getPeerId();s&&t&&_r(s,t)};i();const a=setInterval(i,2e3);return()=>clearInterval(a)},[me,_==null?void 0:_.gameId]),O.useEffect(()=>{if(!me||pe.current||!(_!=null&&_.gameId))return;const t=_.gameId,i=c=>{var d;Ce(c),b("Connecting"),(d=D.current)==null||d.initializeAsReconnectingGuest(c,q.current||0).then(()=>{b("Connected")}).catch(y=>{p.error("[Guest Auto-Reconnect] Failed to reconnect:",y),b("Disconnected")})},a=c=>{const d=`webrtc_host_${t}`;if(!(c.key!==d||!c.newValue))try{const u=JSON.parse(c.newValue).peerId;u&&u!==De&&i(u)}catch(y){p.error("[Guest Auto-Reconnect] Failed to parse storage event:",y)}},s=setInterval(()=>{const c=wr(t);c&&c.peerId!==De&&(p.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${c.peerId}`),i(c.peerId))},2e3);return window.addEventListener("storage",a),()=>{window.removeEventListener("storage",a),clearInterval(s)}},[me,_==null?void 0:_.gameId,De]),O.useEffect(()=>{const t=setInterval(()=>{m(i=>{const a=Date.now(),s=i.floatingTexts||[],c=s.filter(d=>a-d.timestamp<ve.FLOATING_TEXT_DURATION);return c.length!==s.length?{...i,floatingTexts:c}:i})},ve.DECK_SYNC_DELAY);return()=>clearInterval(t)},[]);const _t=O.useCallback(t=>{var i,a,s;switch(t.type){case"peer_open":(i=t.data)!=null&&i.peerId&&(Ce(t.data.peerId),p.info(`WebRTC peer opened with ID: ${t.data.peerId}`));break;case"guest_connected":p.info("Guest connected via WebRTC:",(a=t.data)==null?void 0:a.peerId);break;case"connected_to_host":(s=t.data)!=null&&s.hostPeerId&&De!==t.data.hostPeerId&&(Ce(t.data.hostPeerId),p.info(`Updated webrtcHostId to: ${t.data.hostPeerId}`)),b("Connected"),Tt(!1),tt(null),Ze.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(p.warn("WebRTC peer disconnected"),b("Disconnected"),Tt(!0),!pe.current&&De&&_)try{const c={hostPeerId:De,playerId:A,gameState:_,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(c)),p.info("[Reconnection] Stored reconnection data before disconnect"),rt(De)}catch(c){p.error("[Reconnection] Failed to store data:",c)}break;case"message_received":it(t.data);break;case"error":p.error("WebRTC error:",t.data);break}},[_,A,De,Xe]),wt=O.useCallback(t=>{if(p.info(`[handleWebrtcGuestJoin] Called for guest ${t}, isHost: ${pe.current}`),!pe.current||!D.current){p.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}m(i=>{if(!i)return p.error("[handleWebrtcGuestJoin] No previous state"),i;p.info(`[handleWebrtcGuestJoin] Current state has ${i.players.length} players`);const a=i.players.map(H=>H.id);let s=1;for(;a.includes(s);)s++;const c={id:s,name:`Player ${s}`,color:or[a.length%or.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:"Random",boardHistory:[],autoDrawEnabled:!0},d={...i,players:[...i.players,c]},y=i.board.map(H=>H.map(ee=>({...ee,card:ee.card?{id:ee.card.id,baseId:ee.card.baseId,ownerId:ee.card.ownerId,name:ee.card.name,imageUrl:ee.card.imageUrl,power:ee.card.power,ability:ee.card.ability,isFaceDown:ee.card.isFaceDown,statuses:ee.card.statuses||[]}:null}))),u=H=>H.map(ee=>({id:ee.id,baseId:ee.baseId,name:ee.name,imageUrl:ee.imageUrl,power:ee.power,powerModifier:ee.powerModifier,ability:ee.ability,ownerId:ee.ownerId,color:ee.color,deck:ee.deck,isFaceDown:ee.isFaceDown,types:ee.types,faction:ee.faction,statuses:ee.statuses}));D.current.acceptGuestMinimal(t,{playerId:s,gameId:i.gameId,isGameStarted:i.isGameStarted,players:d.players.map(H=>H.isDummy?{id:H.id,name:H.name,color:H.color,isDummy:H.isDummy,isReady:H.isReady,score:H.score,selectedDeck:H.selectedDeck,hand:u(H.hand||[]),deck:u(H.deck||[]),discard:u(H.discard||[]),handSize:H.hand.length,deckSize:H.deck.length,discardSize:H.discard.length}:{id:H.id,name:H.name,color:H.color,isDummy:H.isDummy,isReady:H.isReady,score:H.score,selectedDeck:H.selectedDeck,deckSize:H.deck.length,handSize:H.hand.length,discardSize:H.discard.length}),deckSelections:d.players.map(H=>({id:H.id,selectedDeck:H.selectedDeck})),gameMode:i.gameMode,currentRound:i.currentRound,currentPhase:i.currentPhase,activePlayerId:i.activePlayerId,startingPlayerId:i.startingPlayerId,activeGridSize:i.activeGridSize,board:y},s);const R=Ht(i,d,s);return Nt(R)||D.current.broadcastStateDelta(R,t),D.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:D.current.getPeerId(),data:{playerId:s,selectedDeck:"Random"},timestamp:Date.now()}),d})},[]),je=O.useCallback(t=>{const i={...t,players:t.players.map(a=>{if(a.isDummy||!1){const d=y=>y.map(u=>({id:u.id,baseId:u.baseId,name:u.name,imageUrl:u.imageUrl,power:u.power,powerModifier:u.powerModifier,ability:u.ability,ownerId:u.ownerId,color:u.color,deck:u.deck,isFaceDown:u.isFaceDown,types:u.types,faction:u.faction,statuses:u.statuses}));return{id:a.id,name:a.name,color:a.color,isDummy:!0,isReady:a.isReady,score:a.score,isDisconnected:a.isDisconnected,selectedDeck:a.selectedDeck,autoDrawEnabled:a.autoDrawEnabled,boardHistory:a.boardHistory,announcedCard:null,hand:d(a.hand||[]),deck:d(a.deck||[]),discard:d(a.discard||[]),handSize:a.hand.length,deckSize:a.deck.length,discardSize:a.discard.length}}return{id:a.id,name:a.name,color:a.color,isDummy:a.isDummy,isReady:a.isReady,score:a.score,isDisconnected:a.isDisconnected,selectedDeck:a.selectedDeck,autoDrawEnabled:a.autoDrawEnabled,boardHistory:a.boardHistory,announcedCard:null,hand:[],deck:[],discard:[],handSize:a.handSize??a.hand.length,deckSize:a.deckSize??a.deck.length,discardSize:a.discardSize??a.discard.length}})};return i.board=t.board.map(a=>a.map(s=>({...s,card:s.card?{id:s.card.id,baseId:s.card.baseId,ownerId:s.card.ownerId,name:s.card.name,imageUrl:s.card.imageUrl,power:s.card.power,ability:s.card.ability,isFaceDown:s.card.isFaceDown,deck:s.card.deck}:null}))),i},[]),Ye=O.useCallback(t=>{const i=pe.current;if(p.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!D.current}, webrtcIsHostRef.current=${i}`),!D.current||!i){p.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}const a=je(t);D.current.broadcastGameState(a)},[je]),it=O.useCallback(t=>{var i,a,s,c,d,y,u,R,H,ee,qe,We,He,ut,lt,Fe,ke,Ge,W,te,de,Pe,$e,dt,mt,ft,Gt,rr,xt,xr,$r,Ur,Hr,Fr,Wr,Br,Yr,zr,Kr,jr,qr,Vr;if(!(!t||!t.type))switch(p.info(`[handleWebrtcMessage] Received: ${t.type}`),t.type){case"JOIN_ACCEPT_MINIMAL":if(p.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${t.playerId}`),t.data){const T=t.data;p.info(`[handleWebrtcMessage] Creating minimal state with ${((i=T.players)==null?void 0:i.length)||0} players`);const w={gameId:T.gameId||na(),isGameStarted:T.isGameStarted||!1,isPrivate:!1,activeGridSize:T.activeGridSize||4,gameMode:T.gameMode||Rr.FreeForAll,dummyPlayerCount:0,players:((a=T.players)==null?void 0:a.map(M=>{if((M.isDummy||!1)&&M.hand&&M.deck&&M.discard)return{id:M.id,name:M.name,color:M.color,isDummy:!0,isReady:M.isReady||!1,score:M.score||0,hand:M.hand||[],deck:M.deck||[],discard:M.discard||[],announcedCard:null,selectedDeck:M.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const N=[],he=[],xe=[];for(let Ne=0;Ne<(M.handSize||0);Ne++)N.push({id:`placeholder_${M.id}_hand_${Ne}`,name:"?",isPlaceholder:!0,ownerId:M.id,deck:M.selectedDeck||"Random",color:M.color});for(let Ne=0;Ne<(M.deckSize||0);Ne++)he.push({id:`placeholder_${M.id}_deck_${Ne}`,name:"?",isPlaceholder:!0,ownerId:M.id,deck:M.selectedDeck||"Random",color:M.color});for(let Ne=0;Ne<(M.discardSize||0);Ne++)xe.push({id:`placeholder_${M.id}_discard_${Ne}`,name:"?",isPlaceholder:!0,ownerId:M.id,deck:M.selectedDeck||"Random",color:M.color});return{id:M.id,name:M.name,color:M.color,isDummy:!1,isReady:M.isReady||!1,score:M.score||0,hand:N,deck:he,discard:xe,announcedCard:null,selectedDeck:M.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:T.board||ea(),hostId:1,currentPhase:T.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:T.currentRound||1,turnNumber:T.turnNumber||1,activePlayerId:T.activePlayerId??null,startingPlayerId:T.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};m(w),t.playerId!==void 0&&(x(t.playerId),p.info(`[handleWebrtcMessage] Set local player ID to ${t.playerId}`)),m(M=>{const _e=M.players.map(N=>{var xe;const he=(xe=T.players)==null?void 0:xe.find(Ne=>Ne.id===N.id);if(N.id===t.playerId){const at=N.deck.length===0||N.deck.some(Je=>Je.isPlaceholder)||N.deck.length!==30;if(he!=null&&he.selectedDeck&&at){const Je=o(he.selectedDeck,N.id,N.name);p.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${Je.length} cards from ${he.selectedDeck}`);const et=[...N.hand],nt=[...Je];if(T.isGameStarted&&et.length===0&&nt.length>0){for(let It=0;It<6&&It<nt.length;It++){const Rt=nt[0];nt.splice(0,1),et.push(Rt)}p.info(`[JOIN_ACCEPT_MINIMAL] Drew ${et.length} cards, deck now has ${nt.length} cards`)}return{...N,deck:nt,hand:et,selectedDeck:he.selectedDeck}}}return N});return{...M,players:_e}});const U=w.players.find(M=>M.id===t.playerId);U&&D.current&&(D.current.sendAction("CHANGE_PLAYER_DECK",{playerId:t.playerId,deckType:U.selectedDeck}),p.info(`[JOIN_ACCEPT_MINIMAL] Sent deck selection to host: ${U.selectedDeck}`));try{const M=(s=D.current)==null?void 0:s.getHostPeerId();M&&Xr({hostPeerId:M,playerId:t.playerId,playerName:(U==null?void 0:U.name)||null,isHost:!1})}catch(M){p.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",M)}}break;case"JOIN_ACCEPT":if(p.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${t.playerId}, hasState: ${!!((c=t.data)!=null&&c.gameState)}`),(d=t.data)!=null&&d.gameState){const T=t.data.gameState;if(p.info(`[handleWebrtcMessage] Setting game state with ${((y=T.players)==null?void 0:y.length)||0} players`),m(T),t.playerId!==void 0){x(t.playerId),p.info(`[handleWebrtcMessage] Set local player ID to ${t.playerId}`);try{const w=(u=D.current)==null?void 0:u.getHostPeerId(),U=T.players.find(M=>M.id===t.playerId);w&&Xr({hostPeerId:w,playerId:t.playerId,playerName:(U==null?void 0:U.name)||null,isHost:!1})}catch(w){p.warn("[JOIN_ACCEPT] Failed to save guest data:",w)}}}break;case"STATE_UPDATE":if(re.current=!0,(R=t.data)!=null&&R.gameState){const T=t.data.gameState;if(Ze.current){m(w=>({...w,currentPhase:T.currentPhase,activePlayerId:T.activePlayerId,startingPlayerId:T.startingPlayerId,isReadyCheckActive:T.isReadyCheckActive,isGameStarted:T.isGameStarted}));return}m(w=>{var _e;const U=T.players.map(N=>{var xe,Ne,at;const he=w.players.find(Je=>Je.id===N.id);if(N.id===q.current&&he){const Je=he.hand.every(nt=>nt.isPlaceholder)||he.hand.length===0,et=N.handSize??((xe=N.hand)==null?void 0:xe.length)??0;if(Je&&N.hand&&N.hand.length>0)return{...N,hand:N.hand,deck:N.deck||he.deck,discard:N.discard||he.discard};{let nt=he.hand,Et=he.deck;if(et>he.hand.length&&Et.length>0){const It=et-he.hand.length,Rt=[...he.hand],ar=[...he.deck];for(let mr=0;mr<It&&mr<ar.length;mr++){const dn=ar[0];ar.splice(0,1),Rt.push(dn)}nt=Rt,Et=ar}return{...N,hand:nt,deck:Et,discard:N.discard||he.discard}}}else{if(N.isDummy||!1)return p.info(`[STATE_UPDATE] Using real cards for dummy player ${N.id}`),{...N,hand:N.hand||[],deck:N.deck||[],discard:N.discard||[]};const et=N.deckSize??((Ne=N.deck)==null?void 0:Ne.length)??0,nt=N.handSize??((at=N.hand)==null?void 0:at.length)??0;p.info(`[STATE_UPDATE] Player ${N.id}: deckSize=${et}, handSize=${nt}`);const Et=[];for(let Rt=0;Rt<et;Rt++)Et.push({id:`placeholder_${N.id}_deck_${Rt}`,name:"?",isPlaceholder:!0,ownerId:N.id,deck:N.selectedDeck||"Random",color:N.color});const It=[];for(let Rt=0;Rt<nt;Rt++)It.push({id:`placeholder_${N.id}_hand_${Rt}`,name:"?",isPlaceholder:!0,ownerId:N.id,deck:N.selectedDeck||"Random",color:N.color});return p.info(`[STATE_UPDATE] Created ${Et.length} deck placeholders and ${It.length} hand placeholders for player ${N.id}`),{...N,hand:It,deck:Et,discard:N.discard||[]}}}),M={...T,players:U};if(!pe.current)try{((_e=D.current)==null?void 0:_e.getHostPeerId())&&q.current!==null&&(dr({gameState:M,localPlayerId:q.current,isHost:!1}),p.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(N){p.warn("[STATE_UPDATE] Failed to persist guest state:",N)}return M})}break;case"RECONNECT_SNAPSHOT":if(re.current=!0,t.data){const T=t.data;m(w=>{const U=q.current,M=T.players.map(N=>{const he=w.players.find(Je=>Je.id===N.id);if(N.id===U&&he&&he.hand.some(et=>!et.isPlaceholder)){let et=[...he.hand];const nt=[...he.deck];if(N.handSize>et.length){const Et=N.handSize-et.length;for(let It=0;It<Et&&nt.length>0;It++)et.push(nt.shift())}else N.handSize<et.length&&(et=et.slice(0,N.handSize));return{...N,hand:et,deck:nt,discard:he.discard}}const xe=[];for(let Je=0;Je<N.handSize;Je++)xe.push({id:`placeholder_${N.id}_hand_${Je}`,name:"?",isPlaceholder:!0,ownerId:N.id,deck:N.selectedDeck||"Random",color:N.color});const Ne=[];for(let Je=0;Je<N.deckSize;Je++)Ne.push({id:`placeholder_${N.id}_deck_${Je}`,name:"?",isPlaceholder:!0,ownerId:N.id,deck:N.selectedDeck||"Random",color:N.color});const at=[];for(let Je=0;Je<N.discardSize;Je++)at.push({id:`placeholder_${N.id}_discard_${Je}`,name:"?",isPlaceholder:!0,ownerId:N.id,deck:N.selectedDeck||"Random",color:N.color});return{...N,hand:xe,deck:Ne,discard:at}}),_e={gameId:T.gameId,gameMode:T.gameMode,isPrivate:T.isPrivate,isGameStarted:T.isGameStarted,isReadyCheckActive:T.isReadyCheckActive,activeGridSize:T.activeGridSize,currentPhase:T.currentPhase,isScoringStep:T.isScoringStep,activePlayerId:T.activePlayerId,startingPlayerId:T.startingPlayerId,currentRound:T.currentRound,turnNumber:T.turnNumber,roundWinners:T.roundWinners||{},gameWinner:T.gameWinner,isRoundEndModalOpen:T.isRoundEndModalOpen,dummyPlayerCount:T.dummyPlayerCount,players:M,board:T.board,spectators:w.spectators,hostId:w.hostId,revealRequests:w.revealRequests,preserveDeployAbilities:w.preserveDeployAbilities,highlights:w.highlights,floatingTexts:w.floatingTexts,targetingMode:w.targetingMode,abilityMode:w.abilityMode};if(!pe.current&&U!==null)try{dr({gameState:_e,localPlayerId:U,isHost:!1}),p.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(N){p.warn("[RECONNECT_SNAPSHOT] Failed to save state:",N)}return p.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${_e.currentPhase}, players=${_e.players.length}`),_e})}break;case"STATE_DELTA":if(pe.current||(re.current=!0),p.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${pe.current}, senderId: ${t.senderId}`),(H=t.data)!=null&&H.delta){const T=t.data.delta;p.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(T.playerDeltas||{}).length}, boardCells=${((ee=T.boardCells)==null?void 0:ee.length)||0}, phaseDelta=${!!T.phaseDelta}`),T.boardCells&&T.boardCells.length>0&&T.boardCells.forEach(w=>{var U,M;p.info(`[STATE_DELTA] Board cell [${w.row},${w.col}]: card=${((U=w.card)==null?void 0:U.name)||"(empty)"}, owner=${(M=w.card)==null?void 0:M.ownerId}`)}),pe.current&&t.senderId&&D.current&&(p.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${t.senderId} to other guests`),D.current.broadcastStateDelta(T,t.senderId)),T.phaseDelta&&p.info("[STATE_DELTA] phaseDelta:",JSON.stringify(T.phaseDelta)),T.playerDeltas&&Object.entries(T.playerDeltas).forEach(([w,U])=>{p.info(`[STATE_DELTA] Player ${w} delta: handSizeDelta=${U.handSizeDelta}, deckSizeDelta=${U.deckSizeDelta}`)}),m(w=>{const U=q.current||w.localPlayerId;p.info(`[STATE_DELTA] Applying delta with localPlayerId=${U}, currentPhase before=${w.currentPhase}`);const M=aa(w,T,U);p.info(`[STATE_DELTA] Applying delta with localPlayerId=${U}, currentPhase after=${M.currentPhase}`);try{M.gameId&&U!==null&&(dr({gameState:M,localPlayerId:U,isHost:pe.current}),p.debug(`[STATE_DELTA] Saved state for ${pe.current?"host":"guest"} auto-restore`))}catch(_e){p.warn("[STATE_DELTA] Failed to persist state:",_e)}return M})}break;case"JOIN_REQUEST":p.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${t.senderId}, isHost: ${pe.current}`),pe.current&&t.senderId?(p.info(`Host received JOIN_REQUEST from ${t.senderId}`),wt(t.senderId)):p.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${pe.current}, senderId: ${t.senderId}`);break;case"ACTION":if(pe.current&&t.data){const{actionType:T,actionData:w}=t.data;if(T==="STATE_UPDATE"&&(w!=null&&w.gameState)){if(Ze.current){D.current&&t.senderId&&D.current.sendToGuest(t.senderId,{type:"STATE_UPDATE",senderId:D.current.getPeerId(),data:{gameState:B.current},timestamp:Date.now()});break}m(U=>{const M=w.gameState,_e=M.players.map(he=>{const xe=U.players.find(Ne=>Ne.id===he.id);return xe&&he.id!==q.current?{...he,deck:xe.deck||he.deck,discard:xe.discard||he.discard,score:xe.score}:he}),N={...M,players:_e};return D.current&&D.current.broadcastToGuests({type:"STATE_UPDATE",senderId:D.current.getPeerId(),data:{gameState:N},timestamp:Date.now()}),N})}else T==="STATE_DELTA"&&(w!=null&&w.delta)?m(U=>{const M=w.delta;let _e=M;Ze.current&&M.playerDeltas&&(_e={...M,playerDeltas:Object.fromEntries(Object.entries(M.playerDeltas).map(([xe,Ne])=>{const at={...Ne};return delete at.scoreDelta,[xe,at]}))});const N=q.current||U.localPlayerId,he=aa(U,_e,N);return D.current&&D.current.broadcastStateDelta(_e),he}):T==="NEXT_PHASE"?m(U=>{const M=U,_e=M.currentPhase,N=_e===2&&!M.isScoringStep,he=_e+1;return{...M,currentPhase:he,...N&&{isScoringStep:!0}}}):T==="PREV_PHASE"?m(U=>{const M=U;return M.isScoringStep?{...M,isScoringStep:!1,currentPhase:Math.max(1,M.currentPhase-1)}:{...M,currentPhase:Math.max(1,M.currentPhase-1)}}):T==="SET_PHASE"&&(w==null?void 0:w.phaseIndex)!==void 0?m(U=>({...U,currentPhase:w.phaseIndex})):T==="UPDATE_PLAYER_NAME"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.name)!==void 0?m(U=>({...U,players:U.players.map(M=>M.id===w.playerId?{...M,name:w.name}:M)})):T==="CHANGE_PLAYER_COLOR"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.color)!==void 0?m(U=>({...U,players:U.players.map(M=>M.id===w.playerId?{...M,color:w.color}:M)})):T==="UPDATE_PLAYER_SCORE"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.delta)!==void 0?m(U=>({...U,players:U.players.map(M=>M.id===w.playerId?{...M,score:Math.max(0,M.score+w.delta)}:M)})):T==="CHANGE_PLAYER_DECK"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.deckType)!==void 0?m(U=>{const M=U.players.find(N=>N.id===w.playerId);if(!M)return U;const _e=o(w.deckType,w.playerId,M.name);return p.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${w.playerId} with ${_e.length} cards from ${w.deckType}`),{...U,players:U.players.map(N=>N.id===w.playerId?{...N,selectedDeck:w.deckType,deck:_e}:N)}}):T==="TOGGLE_ACTIVE_PLAYER"&&(w==null?void 0:w.playerId)!==void 0?m(U=>{if(!U.players.find(N=>N.id===w.playerId))return U;const _e=ra(U,w.playerId);if(D.current){const N=Ht(U,_e,w.playerId);D.current.broadcastStateDelta(N)}return _e}):T==="TOGGLE_AUTO_DRAW"&&(w==null?void 0:w.playerId)!==void 0?m(U=>({...U,players:U.players.map(M=>M.id===w.playerId?{...M,autoDrawEnabled:!M.autoDrawEnabled}:M)})):T==="START_NEXT_ROUND"?m(U=>({...U,isRoundEndModalOpen:!1,currentRound:(U.currentRound||1)+1,players:U.players.map(M=>({...M,score:0}))})):T==="RESET_DEPLOY_STATUS"?m(U=>{const M=U.board.map(_e=>_e.map(N=>{var he;return(he=N.card)!=null&&he.statuses?{...N,card:{...N.card,statuses:N.card.statuses.filter(xe=>xe.type!=="DeployAbilityUsed")}}:N}));return{...U,board:M,preserveDeployAbilities:!1}}):p.warn(`[ACTION] Unknown action type: ${T}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(p.info(`[PLAYER_RECONNECT] Guest ${t.playerId} reconnecting from ${t.senderId}`),pe.current&&t.playerId!==void 0&&t.senderId){const T=B.current;if(p.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(T!=null&&T.gameId)}, gameId=${T==null?void 0:T.gameId}, hasPlayers=${((qe=T==null?void 0:T.players)==null?void 0:qe.length)||0}`),T&&T.gameId){p.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${t.playerId}`);const w=Bn(T,t.playerId);(We=D.current)==null||We.sendToGuest(t.senderId,{type:"RECONNECT_SNAPSHOT",senderId:D.current.getPeerId(),data:w.data,timestamp:Date.now()}),p.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${t.playerId}`)}else p.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((He=t.data)==null?void 0:He.isReadyCheckActive)!==void 0||((ut=t.data)==null?void 0:ut.isPrivate)!==void 0)&&m(T=>({...T,isReadyCheckActive:t.data.isReadyCheckActive??!0,isPrivate:t.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((lt=t.data)==null?void 0:lt.isReadyCheckActive)!==void 0&&m(T=>({...T,isReadyCheckActive:t.data.isReadyCheckActive}));break;case"PLAYER_READY":pe.current&&t.playerId!==void 0?m(T=>{const w=T.players.map(N=>N.id===t.playerId?{...N,isReady:!0}:N),U={...T,players:w};if(p.info(`Player ${t.playerId} is ready via WebRTC`),D.current){const N=Ht(T,U,t.playerId);Nt(N)||(D.current.broadcastStateDelta(N),p.info(`[PLAYER_READY] Broadcasted ready status for player ${t.playerId}`))}const M=U.players.filter(N=>!N.isDummy&&!N.isDisconnected);if(M.length>0&&M.every(N=>N.isReady)&&U.isReadyCheckActive&&!U.isGameStarted){const N=U.players.filter(at=>!at.isDisconnected),he=Math.floor(Math.random()*N.length),xe=N[he].id;let Ne={...U};return Ne.isReadyCheckActive=!1,Ne.isGameStarted=!0,Ne.startingPlayerId=xe,Ne.activePlayerId=xe,Ne.currentPhase=0,Ne.players=Ne.players.map(at=>{if(at.hand.length===0&&at.deck.length>0){const et=[...at.hand],nt=[...at.deck];for(let Et=0;Et<6&&Et<nt.length;Et++){const It=nt[0];nt.splice(0,1),et.push(It)}return p.info(`[PLAYER_READY] Drew ${et.length} cards for player ${at.id}`),{...at,hand:et,deck:nt}}return at}),Ne=Mr(Ne,xe),p.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${Ne.currentPhase}`),D.current&&(D.current.broadcastToGuests({type:"GAME_START",senderId:D.current.getPeerId(),data:{startingPlayerId:xe,activePlayerId:xe,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var at,Je;p.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(at=Ne.players[0])==null?void 0:at.deck.length}, hand=${(Je=Ne.players[0])==null?void 0:Je.hand.length}`),p.info(`[PLAYER_READY] Broadcasting state with currentPhase=${Ne.currentPhase}`),Ye(Ne)},100)),Ne}return U}):pe.current;break;case"ASSIGN_TEAMS":(Fe=t.data)!=null&&Fe.assignments&&m(T=>{const w=T.players.map(U=>{let M=U.teamId||1;for(const[_e,N]of Object.entries(t.data.assignments))if(N.includes(U.id)){M=parseInt(_e);break}return{...U,teamId:M}});return{...T,players:w}});break;case"SET_GAME_MODE":((ke=t.data)==null?void 0:ke.mode)!==void 0&&m(T=>({...T,gameMode:t.data.mode}));break;case"SET_GAME_PRIVACY":((Ge=t.data)==null?void 0:Ge.isPrivate)!==void 0&&m(T=>({...T,isPrivate:t.data.isPrivate}));break;case"SET_GRID_SIZE":((W=t.data)==null?void 0:W.size)!==void 0&&m(T=>{const w=t.data.size,U=[];for(let M=0;M<w;M++){const _e=[];for(let N=0;N<w;N++)_e.push({card:null});U.push(_e)}return{...T,activeGridSize:w,board:U}});break;case"SET_DUMMY_PLAYER_COUNT":((te=t.data)==null?void 0:te.count)!==void 0&&m(T=>({...T,dummyPlayerCount:t.data.count}));break;case"HOST_READY":t.playerId!==void 0&&(p.info(`[handleWebrtcMessage] Host (player ${t.playerId}) is ready`),m(T=>{const w=T.players.map(U=>U.id===t.playerId?{...U,isReady:!0}:U);return{...T,players:w}}));break;case"GAME_START":re.current=!0,p.info("[handleWebrtcMessage] Game starting!",t.data),B.current&&(p.info(`[GAME_START] Current phase before: ${B.current.currentPhase}`),B.current.players.forEach(T=>{p.info(`[GAME_START] Before: Player ${T.id} - deck: ${T.deck.length}, hand: ${T.hand.length}`)})),t.data&&m(T=>{p.info(`[GAME_START] Processing for localPlayerId=${q.current}`),T.players.forEach(_e=>{p.info(`[GAME_START] Player ${_e.id} before: deck=${_e.deck.length}, hand=${_e.hand.length}`)});const w=t.data.startingPlayerId??t.data.activePlayerId,U={...T,isGameStarted:t.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:w,activePlayerId:t.data.activePlayerId,currentPhase:T.currentPhase},M=U.players.find(_e=>_e.id===q.current);if(M&&M.hand.length===0&&M.deck.length>0){const N=[...M.hand],he=[...M.deck];for(let xe=0;xe<6&&xe<he.length;xe++){const Ne=he[0];he.splice(0,1),N.push(Ne)}U.players=U.players.map(xe=>xe.id===q.current?{...xe,hand:N,deck:he}:xe),p.info(`[GAME_START] Drew ${N.length} cards for local player ${q.current}, deck now has ${he.length} cards`)}return U.players.forEach(_e=>{p.info(`[GAME_START] Player ${_e.id} after: deck=${_e.deck.length}, hand=${_e.hand.length}`)}),p.info(`[GAME_START] Final state: currentPhase=${U.currentPhase}, activePlayerId=${U.activePlayerId}, startingPlayerId=${U.startingPlayerId}`),U});break;case"ACTIVE_PLAYER_CHANGED":p.info("[handleWebrtcMessage] Active player changed!",t.data),t.data&&m(T=>{const w={...T,activePlayerId:t.data.activePlayerId};if(t.data.currentPhase!==void 0&&(w.currentPhase=t.data.currentPhase),t.data.turnNumber!==void 0&&(w.turnNumber=t.data.turnNumber),w.currentPhase===0&&w.activePlayerId===q.current){const U=w.players.find(M=>M.id===q.current);if(U&&U.deck.length>0){const M=U.deck[0],_e=[...U.deck.slice(1)],N=[...U.hand,M];w.players=w.players.map(he=>he.id===q.current?{...he,deck:_e,hand:N}:he)}w.currentPhase=1}return w});break;case"SYNC_DECK_SELECTIONS":p.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",t.data),t.data&&m(T=>t.data.playerId!==void 0&&t.data.selectedDeck!==void 0?{...T,players:T.players.map(w=>w.id===t.data.playerId?{...w,selectedDeck:t.data.selectedDeck}:w)}:t.data.deckSelections&&Array.isArray(t.data.deckSelections)?{...T,players:T.players.map(w=>{const U=t.data.deckSelections.find(M=>M.id===w.id);return U?{...w,selectedDeck:U.selectedDeck}:w})}:T);break;case"CHANGE_PLAYER_DECK":p.info("[CHANGE_PLAYER_DECK] Received deck change",t.data),pe.current&&t.data?(m(T=>{const w=T.players.find(M=>M.id===t.data.playerId);if(!w)return T;const U=o(t.data.deckType,t.data.playerId,w.name);return p.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${t.data.playerId} with ${U.length} cards from ${t.data.deckType}`),{...T,players:T.players.map(M=>M.id===t.data.playerId?{...M,selectedDeck:t.data.deckType,deck:U}:M)}}),D.current&&D.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:D.current.getPeerId(),data:t.data,timestamp:Date.now()})):m(T=>({...T,players:T.players.map(w=>w.id===t.data.playerId?{...w,selectedDeck:t.data.deckType}:w)}));break;case"GAME_RESET":m(T=>{const w=t.data.activeGridSize||8,U=[];for(let N=0;N<w;N++){const he=[];for(let xe=0;xe<w;xe++)he.push({card:null});U.push(he)}const M=(t.data.players||[]).map(N=>{if(N.isDummy&&N.hand&&N.deck&&N.discard)return{...N,boardHistory:[]};{const he=N.selectedDeck||"SynchroTech";return{...N,hand:[],deck:o(he,N.id,N.name),discard:[],boardHistory:[]}}}),_e={...T,players:M,gameMode:t.data.gameMode,isPrivate:t.data.isPrivate,activeGridSize:t.data.activeGridSize,dummyPlayerCount:t.data.dummyPlayerCount,autoAbilitiesEnabled:t.data.autoAbilitiesEnabled,isGameStarted:t.data.isGameStarted,currentPhase:t.data.currentPhase,currentRound:t.data.currentRound,turnNumber:t.data.turnNumber,activePlayerId:t.data.activePlayerId,startingPlayerId:t.data.startingPlayerId,roundWinners:t.data.roundWinners||{},gameWinner:t.data.gameWinner,isRoundEndModalOpen:t.data.isRoundEndModalOpen,isReadyCheckActive:t.data.isReadyCheckActive,board:U,targetingMode:null,floatingTexts:[]};return B.current=_e,_e});break;case"ABILITY_MODE_SET":(de=t.data)!=null&&de.abilityMode&&(m(T=>({...T,abilityMode:t.data.abilityMode})),p.info("[AbilityMode] Received ability mode from host",{playerId:t.data.abilityMode.playerId,mode:t.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":p.info("[Ability] Target selected",t.data);break;case"ABILITY_COMPLETED":m(T=>({...T,abilityMode:null})),p.info("[Ability] Ability completed",t.data);break;case"ABILITY_CANCELLED":m(T=>({...T,abilityMode:null}));break;case"TRIGGER_HIGHLIGHT":if((Pe=t.data)!=null&&Pe.highlightData){const T=t.data.highlightData;Z(T),pe.current&&D.current&&t.senderId&&D.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:t.senderId,data:T,timestamp:Date.now()},t.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(t.data){const T=($e=D.current)==null?void 0:$e.getPeerId();t.senderId!==T&&Z(t.data)}break;case"TRIGGER_FLOATING_TEXT":if((dt=t.data)!=null&&dt.textData){const T=t.data.textData;m(w=>({...w,floatingTexts:[...w.floatingTexts,T].filter(U=>Date.now()-U.timestamp<ve.FLOATING_TEXT_DURATION)})),pe.current&&D.current&&t.senderId&&D.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:t.senderId,data:T,timestamp:Date.now()},t.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((mt=t.data)!=null&&mt.batch){const T=t.data.batch;m(w=>({...w,floatingTexts:[...w.floatingTexts,...T].filter(U=>Date.now()-U.timestamp<ve.FLOATING_TEXT_DURATION)})),pe.current&&D.current&&t.senderId&&D.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:t.senderId,data:{batch:T},timestamp:Date.now()},t.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const T=(ft=D.current)==null?void 0:ft.getPeerId();(Gt=t.data)!=null&&Gt.batch&&t.senderId!==T?m(w=>({...w,floatingTexts:[...w.floatingTexts,...t.data.batch].filter(U=>Date.now()-U.timestamp<ve.FLOATING_TEXT_DURATION)})):(rr=t.data)!=null&&rr.textData&&t.senderId!==T&&m(w=>({...w,floatingTexts:[...w.floatingTexts,t.data.textData].filter(U=>Date.now()-U.timestamp<ve.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((xt=t.data)!=null&&xt.coords){const T=t.data.coords,w=t.data.timestamp;Te({coords:T,timestamp:w}),pe.current&&D.current&&t.senderId&&D.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:t.senderId,data:{coords:T,timestamp:w},timestamp:Date.now()},t.senderId)}break;case"NO_TARGET_TRIGGERED":if((xr=t.data)!=null&&xr.coords){const T=($r=D.current)==null?void 0:$r.getPeerId();t.senderId!==T&&Te({coords:t.data.coords,timestamp:t.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(t.data){const T=t.data;Se(w=>[...w,T]),setTimeout(()=>{Se(w=>w.filter(U=>U.timestamp!==T.timestamp))},1e3),pe.current&&D.current&&t.senderId&&D.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:t.senderId,data:T,timestamp:Date.now()},t.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(t.data){const T=t.data;Ee(w=>[...w,T]),setTimeout(()=>{Ee(w=>w.filter(U=>U.timestamp!==T.timestamp))},1e3),pe.current&&D.current&&t.senderId&&D.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:t.senderId,data:T,timestamp:Date.now()},t.senderId)}break;case"TRIGGER_TARGET_SELECTION":if(t.data){const T=t.data;V(w=>[...w,T]),setTimeout(()=>{V(w=>w.filter(U=>U.timestamp!==T.timestamp))},1e3),pe.current&&D.current&&t.senderId&&D.current.broadcastToGuests({type:"TARGET_SELECTION_TRIGGERED",senderId:t.senderId,data:T,timestamp:Date.now()},t.senderId)}break;case"TARGET_SELECTION_TRIGGERED":t.data&&t.senderId!==((Ur=D.current)==null?void 0:Ur.getPeerId())&&(V(T=>[...T,t.data]),setTimeout(()=>{V(T=>T.filter(w=>w.timestamp!==t.data.timestamp))},1e3));break;case"DECK_SELECTION_TRIGGERED":t.data&&t.senderId!==((Hr=D.current)==null?void 0:Hr.getPeerId())&&(Se(T=>[...T,t.data]),setTimeout(()=>{Se(T=>T.filter(w=>w.timestamp!==t.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":t.data&&t.senderId!==((Fr=D.current)==null?void 0:Fr.getPeerId())&&(Ee(T=>[...T,t.data]),setTimeout(()=>{Ee(T=>T.filter(w=>w.timestamp!==t.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((Wr=t.data)!=null&&Wr.targetingMode){const T=t.data.targetingMode;m(w=>({...w,targetingMode:T})),B.current.targetingMode=T,p.info("[TargetingMode] Received targeting mode via WebRTC",{playerId:T.playerId,mode:T.action.mode})}break;case"CLEAR_TARGETING_MODE":m(T=>({...T,targetingMode:null})),B.current.targetingMode=null;break;case"SYNC_VALID_TARGETS":((Br=t.data)==null?void 0:Br.playerId)!==q.current&&(oe({playerId:t.data.playerId,validHandTargets:t.data.validHandTargets||[],isDeckSelectable:t.data.isDeckSelectable||!1}),setTimeout(()=>{oe(T=>(T==null?void 0:T.playerId)===t.data.playerId?null:T)},1e4));break;case"RECONNECT_ACCEPT":if((Yr=t.data)!=null&&Yr.gameState){const T=t.data.gameState;m(T),b("Connected"),p.info(`[Reconnection] State restored with ${((zr=T.players)==null?void 0:zr.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(w){p.warn("[Reconnection] Failed to clear stored data:",w)}}break;case"RECONNECT_REJECT":{const T=((Kr=t.data)==null?void 0:Kr.reason)||"unknown";p.warn(`[Reconnection] Reconnection rejected: ${T}`),b("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((jr=t.data)==null?void 0:jr.playerId)!==void 0&&(p.info(`[Reconnection] Player ${t.data.playerId} disconnected, reconnection window open`),m(T=>({...T,players:T.players.map(w=>w.id===t.data.playerId?{...w,isDisconnected:!0}:w)})));break;case"PLAYER_RECONNECTED":((qr=t.data)==null?void 0:qr.playerId)!==void 0&&(p.info(`[Reconnection] Player ${t.data.playerId} reconnected`),m(T=>({...T,players:T.players.map(w=>w.id===t.data.playerId?{...w,isDisconnected:!1}:w)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((Vr=t.data)==null?void 0:Vr.playerId)!==void 0&&(p.info(`[Reconnection] Player ${t.data.playerId} converted to dummy`),m(T=>({...T,players:T.players.map(w=>w.id===t.data.playerId?{...w,isDummy:!0,isDisconnected:!0}:w)})));break;default:p.warn(`[handleWebrtcMessage] Unknown message type: ${t.type}`,t);break}},[Xe,o,Ye,_,A]),rt=O.useCallback(t=>{if(!D.current||st)return;Tt(!0),b("Connecting");const i=3e4,a=1e3;let s=0;const c=i/a;try{const y={hostPeerId:t,playerId:A,gameState:_,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(y))}catch(y){p.error("[Reconnection] Failed to store data:",y)}const d=async()=>{s++;const y=Math.max(0,i-s*a);if(tt({attempt:s,maxAttempts:c,timeRemaining:y}),y<=0){p.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Tt(!1),tt(null),Ut();return}let u=t;if(_!=null&&_.gameId){const R=wr(_.gameId);if(R&&R.peerId!==t){u=R.peerId;try{const H={hostPeerId:u,playerId:A,gameState:_,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(H))}catch(H){p.error("[Reconnection] Failed to update reconnection data:",H)}}}try{const R=A||q.current;R!==null?(p.info(`[Reconnection] Reconnecting as existing player ${R} to host ${u}`),await D.current.initializeAsReconnectingGuest(u,R)):(p.info("[Reconnection] No playerId, connecting as new player"),await D.current.initializeAsGuest(u)),p.info("[Reconnection] Successfully reconnected!"),Tt(!1),tt(null)}catch(R){p.warn("[Reconnection] Reconnection attempt failed:",R),setTimeout(d,a)}};d()},[st,_,A]),ae=O.useCallback(async()=>{var t;if(!D.current)return p.error("WebRTC manager not initialized"),null;try{ze(!0),b("Connecting");const i=await D.current.initializeAsHost();Ce(i),b("Connected");const a=B.current.gameId;a&&_r(i,a);const s=(t=B.current.players)==null?void 0:t.find(c=>c.id===q.current);return On({peerId:i,isHost:!0,playerName:(s==null?void 0:s.name)||null}),p.info("[initializeWebrtcHost] Saved host data for auto-restore"),i}catch(i){return p.error("Failed to initialize WebRTC host:",i),b("Disconnected"),null}},[]),L=O.useCallback(async t=>{if(!D.current)return p.error("WebRTC manager not initialized"),!1;try{return ze(!1),Ce(t),b("Connecting"),await D.current.initializeAsGuest(t),!0}catch(i){return p.error("Failed to connect as guest:",i),b("Disconnected"),!1}},[]),K=O.useCallback((t,i)=>!D.current||pe.current?!1:D.current.sendAction(t,i),[]),h=O.useCallback(t=>{m(i=>{var c,d,y;if(!i)return p.error("[updateState] prevState is undefined, skipping update"),i;const a=typeof t=="function"?t(i):t;if(!a)return p.error("[updateState] newState is undefined, skipping update"),i;const s=!i.gameId&&a.gameId;if(!re.current&&!s)return a;if(me&&D.current){const u=Ht(i,a,q.current||0);if(p.info(`[updateState] WebRTC enabled, isHost=${pe.current}, delta: boardCells=${((c=u.boardCells)==null?void 0:c.length)||0}, playerDeltas=${Object.keys(u.playerDeltas||{}).length}, phase=${!!u.phaseDelta}`),pe.current){if(Nt(u)||(D.current.broadcastStateDelta(u),p.info(`[updateState] Host broadcast delta: phase=${!!u.phaseDelta}, board=${((d=u.boardCells)==null?void 0:d.length)||0}`)),a.gameId&&q.current!==null)try{dr({gameState:a,localPlayerId:q.current,isHost:!0}),p.debug("[updateState] Saved game state for host auto-restore")}catch(R){p.warn("[updateState] Failed to save game state:",R)}}else if(!Nt(u)){const R=D.current.sendStateDelta(u);p.info(`[updateState] Guest sent delta to host: success=${R}, boardCells=${((y=u.boardCells)==null?void 0:y.length)||0}`)}return a}if(F.current&&F.current.readyState===WebSocket.OPEN){const u={type:"UPDATE_STATE",gameState:a};Ie.current&&(u.playerToken=Ie.current),F.current.send(JSON.stringify(u))}return a})},[me,Xe,Ye]),v=O.useCallback(()=>{if(localStorage.getItem("webrtc_enabled")==="true"){b("Connected");return}if(C.current||F.current&&(F.current.readyState===WebSocket.OPEN||F.current.readyState===WebSocket.CONNECTING))return;const t=Yn();if(!t){p.warn("No WebSocket URL configured in settings. Waiting for user input."),b("Disconnected"),Ve.current&&clearTimeout(Ve.current);return}try{F.current=new WebSocket(t)}catch(i){console.error("Failed to create WebSocket:",i),b("Disconnected"),Ve.current&&clearTimeout(Ve.current),Ve.current=window.setTimeout(v,ve.RECONNECT_DELAY);return}b("Connecting"),F.current.onopen=()=>{var s;re.current=!1,b("Connected");const i=localStorage.getItem("custom_ws_url");i&&i.trim()!==""&&localStorage.setItem("websocket_url",i.trim());const a=B.current;if(p.info("Current gameState on open:",a?`gameId=${a.gameId}`:"null"),p.info("playerTokenRef.current on open:",Ie.current?"YES":"NO"),a&&a.gameId&&((s=F.current)==null?void 0:s.readyState)===WebSocket.OPEN){let c=Ie.current;if(!c){try{const d=localStorage.getItem(kt);if(d){const y=JSON.parse(d);p.info("RECONNECTION_DATA_KEY:",y==null?void 0:y.gameId,a.gameId),y!=null&&y.playerToken&&(c=y.playerToken,Ie.current=c,p.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(d){console.warn("Failed to parse reconnection data:",d instanceof Error?d.message:String(d))}if(!c&&a.players&&q.current){const d=a.players.find(y=>y.id===q.current);d!=null&&d.playerToken&&(c=d.playerToken,Ie.current=c)}}p.info("JoinGame: Sending reconnection with token:",c?"YES":"NO","gameId:",a.gameId),F.current.send(JSON.stringify({type:"JOIN_GAME",gameId:a.gameId,playerToken:c}))}},F.current.onmessage=i=>{try{const a=JSON.parse(i.data);if(a.type==="GAMES_LIST")$(a.games);else if(a.type==="JOIN_SUCCESS"){if(a.isSpectator){x(null),p.info("Joined as spectator:",a.message||"Spectator mode"),f.current=null;return}x(a.playerId);const s=f.current||B.current.gameId;s&&a.playerId!==null&&a.playerToken?(Ie.current=a.playerToken,localStorage.setItem(kt,JSON.stringify({gameId:s,playerId:a.playerId,playerToken:a.playerToken,timestamp:Date.now()})),B.current.gameId===s&&sa(B.current,a.playerId,a.playerToken)):a.playerId===null&&(Ft(),Ie.current=void 0),f.current=null,a.playerId===1&&setTimeout(()=>{var c;((c=F.current)==null?void 0:c.readyState)===WebSocket.OPEN&&F.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:St}))},ve.DECK_SYNC_DELAY)}else if(a.type==="CONNECTION_ESTABLISHED"){p.info("Connection acknowledged by server");const s=sessionStorage.getItem("pending_invite_game"),c=sessionStorage.getItem("pending_invite_name");s&&F.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),p.info("Auto-joining invite game:",s),F.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:s,playerName:c||"Player"})))}else if(a.type==="DECK_DATA_UPDATED")p.info("Deck data synced with server");else if(a.type==="ERROR")if(a.message.includes("not found")||a.message.includes("Dummy")){p.info("Game not found error - clearing state");const s=E();m(s),B.current=s,x(null),Ft(),f.current=null}else if(a.message.includes("already started")&&Q.current){p.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const s=E();m(s),B.current=s,x(null),Ft(),f.current=null,Q.current=!1}else console.warn("Server Error:",a.message);else if(a.type==="HIGHLIGHT_TRIGGERED")Z(a.highlightData);else if(a.type==="NO_TARGET_TRIGGERED")Te({coords:a.coords,timestamp:a.timestamp});else if(a.type==="DECK_SELECTION_TRIGGERED")Se(s=>[...s,a.deckSelectionData]),setTimeout(()=>{Se(s=>s.filter(c=>c.timestamp!==a.deckSelectionData.timestamp))},1e3);else if(a.type==="HAND_CARD_SELECTION_TRIGGERED")Ee(s=>[...s,a.handCardSelectionData]),setTimeout(()=>{Ee(s=>s.filter(c=>c.timestamp!==a.handCardSelectionData.timestamp))},1e3);else if(a.type==="FLOATING_TEXT_TRIGGERED")m(s=>({...s,floatingTexts:[...s.floatingTexts,a.floatingTextData].filter(c=>Date.now()-c.timestamp<ve.FLOATING_TEXT_DURATION)}));else if(a.type==="FLOATING_TEXT_BATCH_TRIGGERED")m(s=>({...s,floatingTexts:[...s.floatingTexts,...a.batch].filter(c=>Date.now()-c.timestamp<ve.FLOATING_TEXT_DURATION)}));else if(a.type==="SYNC_VALID_TARGETS")a.playerId!==q.current&&(oe({playerId:a.playerId,validHandTargets:a.validHandTargets||[],isDeckSelectable:a.isDeckSelectable||!1}),setTimeout(()=>{oe(s=>(s==null?void 0:s.playerId)===a.playerId?null:s)},1e4));else if(a.type==="TARGET_SELECTION_TRIGGERED")a.effect&&a.playerId!==q.current&&(V(s=>[...s,a.effect]),setTimeout(()=>{V(s=>s.filter(c=>c.timestamp!==a.effect.timestamp))},1e3));else if(a.type==="TARGETING_MODE_SET"){const s=a.targetingMode;s&&(m(c=>({...c,targetingMode:s})),B.current.targetingMode=s,p.info("[TargetingMode] Received targeting mode from server",{playerId:s.playerId,mode:s.action.mode}))}else if(a.type==="TARGETING_MODE_CLEARED")m(s=>({...s,targetingMode:null})),B.current.targetingMode=null,p.debug("[TargetingMode] Cleared targeting mode from server");else if(a.type==="ABILITY_MODE_SET")a.abilityMode&&(m(s=>({...s,abilityMode:a.abilityMode})),p.info("[AbilityMode] Received ability mode from host",{playerId:a.abilityMode.playerId,mode:a.abilityMode.mode,sourceCard:a.abilityMode.sourceCardName}));else if(a.type==="ABILITY_TARGET_SELECTED")p.info("[Ability] Target selected",a.data);else if(a.type==="ABILITY_COMPLETED")m(s=>({...s,abilityMode:null})),p.info("[Ability] Ability completed",a.data);else if(a.type==="ABILITY_CANCELLED")m(s=>({...s,abilityMode:null})),p.info("[Ability] Ability cancelled");else if(a.type==="GAME_RESET")p.info("[GameReset] Received GAME_RESET message from server"),m(s=>{const c=a.activeGridSize||8,d=[];for(let u=0;u<c;u++){const R=[];for(let H=0;H<c;H++)R.push({card:null});d.push(R)}const y={...s,players:a.players||[],gameMode:a.gameMode,isPrivate:a.isPrivate,activeGridSize:a.activeGridSize,dummyPlayerCount:a.dummyPlayerCount,autoAbilitiesEnabled:a.autoAbilitiesEnabled,isGameStarted:a.isGameStarted,currentPhase:a.currentPhase,currentRound:a.currentRound,turnNumber:a.turnNumber,activePlayerId:a.activePlayerId,startingPlayerId:a.startingPlayerId,roundWinners:a.roundWinners||{},gameWinner:a.gameWinner,isRoundEndModalOpen:a.isRoundEndModalOpen,isReadyCheckActive:a.isReadyCheckActive,board:d,targetingMode:null,floatingTexts:[]};return B.current=y,y});else if(!a.type&&a.players&&a.board){const s=Xt(a),c=B.current;if(!c.isScoringStep&&s.isScoringStep&&s.currentPhase!==2){p.debug("Ignoring delayed scoring state update");return}if(c.isScoringStep&&(s.currentPhase!==c.currentPhase||s.activePlayerId!==c.activePlayerId||s.currentPhase!==4)&&(s.isScoringStep=!1),m(s),B.current=s,q.current!==null&&s.gameId){let y;try{const u=localStorage.getItem(kt);u&&(y=JSON.parse(u).playerToken)}catch{}if(!y&&s.players){const u=s.players.find(R=>R.id===q.current);u!=null&&u.playerToken&&(y=u.playerToken,Ie.current=y)}sa(s,q.current,y)}}else console.warn("Unknown message type:",a.type,"keys:",Object.keys(a),"data:",a)}catch(a){console.error("Failed to parse message from server:",i.data,a)}},F.current.onclose=()=>{b("Disconnected"),C.current||(Ve.current&&clearTimeout(Ve.current),Ve.current=window.setTimeout(v,ve.RECONNECT_DELAY))},F.current.onerror=i=>console.error("WebSocket error event:",i)},[m,E]),z=O.useCallback(()=>{F.current&&(F.current.readyState===WebSocket.OPEN||F.current.readyState===WebSocket.CONNECTING)?F.current.close():v()},[v]),ue=O.useCallback(t=>{var i;if(C.current=!1,((i=F.current)==null?void 0:i.readyState)===WebSocket.OPEN){f.current=t;let a=null;try{const c=localStorage.getItem(kt);c&&(a=JSON.parse(c))}catch{Ft()}const s={type:"JOIN_GAME",gameId:t};(a==null?void 0:a.gameId)===t&&a.playerToken?(s.playerToken=a.playerToken,p.info(`JoinGame: Sending reconnection with token ${a.playerToken.substring(0,8)}... for player ${a.playerId}`)):p.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${a==null?void 0:a.gameId}, requestedGameId=${t}`),F.current.send(JSON.stringify(s))}else v(),f.current=t},[v]),Re=O.useCallback(t=>{Q.current=!0,ue(t)},[ue]),fe=O.useCallback((t,i="Player")=>{var a;C.current=!1,((a=F.current)==null?void 0:a.readyState)===WebSocket.OPEN?F.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:t,playerName:i})):(sessionStorage.setItem("pending_invite_game",t),sessionStorage.setItem("pending_invite_name",i),v())},[v]);O.useEffect(()=>{if(C.current=!1,sessionStorage.getItem("invite_game_id"))return v(),()=>{C.current=!0,Ve.current&&clearTimeout(Ve.current),F.current&&(F.current.onclose=null,F.current.close())};const i=performance.getEntriesByType("navigation"),a=i.length>0?i[0]:null,s=(a==null?void 0:a.type)??0,c=zn();return c&&(p.info(`Restoring saved game state (nav type: ${s}):`,c.gameState.gameId),m(c.gameState),x(c.localPlayerId),B.current=c.gameState,q.current=c.localPlayerId,Ie.current=c.playerToken),v(),()=>{C.current=!0,Ve.current&&clearTimeout(Ve.current),F.current&&(F.current.onclose=null,F.current.close())}},[]),O.useEffect(()=>{if(St&&B.current&&B.current.gameId){const t=Xt(B.current);t!==B.current&&(m(t),B.current=t)}},[]),O.useEffect(()=>{if(j)return;const t=setInterval(()=>{if(St&&B.current&&B.current.gameId){const i=Xt(B.current);m({...i}),B.current=i,be(!0),clearInterval(t)}},100);return()=>clearInterval(t)},[j]);const ce=O.useCallback(()=>{C.current=!1,Ft();const t=na(),i={...E(),gameId:t,players:[l(1)]};re.current=!0,h(i),setTimeout(()=>{var a;((a=F.current)==null?void 0:a.readyState)===WebSocket.OPEN&&(F.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:t})),F.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:St})))},100)},[h,E,l]),ye=O.useCallback(()=>{var t;((t=F.current)==null?void 0:t.readyState)===WebSocket.OPEN&&F.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[]),ge=O.useCallback(()=>{var a;if(Qe.current)return;C.current=!0;const t=B.current.gameId,i=q.current;t&&pe.current&&Pn(t);try{Ut(),p.info("[exitGame] Cleared WebRTC persistence data")}catch(s){p.warn("[exitGame] Failed to clear WebRTC data:",s)}m(E()),x(null),Ft(),F.current&&(F.current.onclose=null),((a=F.current)==null?void 0:a.readyState)===WebSocket.OPEN&&t&&i!==null&&F.current.send(JSON.stringify({type:"EXIT_GAME",gameId:t,playerId:i})),F.current&&F.current.close(),setTimeout(()=>{C.current=!1,v()},100)},[E,v]),le=O.useCallback(()=>{var i;if(localStorage.getItem("webrtc_enabled")==="true"&&D.current&&pe.current){m(a=>({...a,isReadyCheckActive:!0,isPrivate:!0})),D.current.broadcastToGuests({type:"START_READY_CHECK",senderId:D.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((i=F.current)==null?void 0:i.readyState)===WebSocket.OPEN&&B.current.gameId&&F.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:B.current.gameId}))},[pe]),Le=O.useCallback(()=>{var i;if(localStorage.getItem("webrtc_enabled")==="true"&&D.current&&pe.current){m(a=>({...a,isReadyCheckActive:!1})),D.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:D.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((i=F.current)==null?void 0:i.readyState)===WebSocket.OPEN&&B.current.gameId?F.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:B.current.gameId})):m(a=>({...a,isReadyCheckActive:!1}))},[pe]),Me=O.useCallback(()=>{var i;const t=localStorage.getItem("webrtc_enabled")==="true";if(t&&D.current&&pe.current&&q.current!==null){m(a=>{const s=a.players.map(u=>u.id===q.current?{...u,isReady:!0}:u),c={...a,players:s},d=c.players.filter(u=>!u.isDummy&&!u.isDisconnected);if(d.length>0&&d.every(u=>u.isReady)&&c.isReadyCheckActive&&!c.isGameStarted){const u=c.players.filter(He=>!He.isDisconnected),R=Math.floor(Math.random()*u.length),H=u[R].id,ee={...c};ee.isReadyCheckActive=!1,ee.isGameStarted=!0,ee.startingPlayerId=H,ee.activePlayerId=H,ee.currentPhase=0,ee.players=ee.players.map(He=>{if(He.hand.length===0&&He.deck.length>0){const lt=[...He.hand],Fe=[...He.deck];for(let ke=0;ke<6&&ke<Fe.length;ke++){const Ge=Fe[0];Fe.splice(0,1),lt.push(Ge)}return p.info(`[playerReady] Drew initial ${lt.length} cards for player ${He.id}, deck now has ${Fe.length} cards`),{...He,hand:lt,deck:Fe}}return He});const qe=ee.players.find(He=>He.id===H);if(qe&&qe.deck.length>0){const He=qe.deck[0],ut=[...qe.deck.slice(1)],lt=[...qe.hand,He];ee.players=ee.players.map(Fe=>Fe.id===H?{...Fe,deck:ut,hand:lt,readySetup:!1,readyCommit:!1}:Fe),ee.currentPhase=1,p.info(`[playerReady] Preparation phase: Starting player ${H} drew 7th card, now in Setup phase (${ee.currentPhase})`)}const We=Ht(c,ee,q.current||0);return p.info(`[playerReady] Created delta with ${Object.keys(We.playerDeltas||{}).length} player changes, phaseDelta=${!!We.phaseDelta}, roundDelta=${!!We.roundDelta}`),p.info("[playerReady] Delta content:",JSON.stringify(We,null,2)),p.info("[playerReady] isDeltaEmpty result:",Nt(We)),D.current.broadcastToGuests({type:"GAME_START",senderId:D.current.getPeerId(),data:{startingPlayerId:H,activePlayerId:H,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{Nt(We)?p.warn("[playerReady] Delta is empty, NOT broadcasting!"):D.current.broadcastStateDelta(We)},50),ee}return D.current.broadcastToGuests({type:"HOST_READY",senderId:D.current.getPeerId(),playerId:q.current??void 0,timestamp:Date.now()}),c});return}if(t&&D.current&&!pe.current&&q.current!==null){D.current.sendMessageToHost({type:"PLAYER_READY",senderId:D.current.getPeerId(),playerId:q.current,timestamp:Date.now()}),m(a=>({...a,players:a.players.map(s=>s.id===q.current?{...s,isReady:!0}:s)}));return}((i=F.current)==null?void 0:i.readyState)===WebSocket.OPEN&&B.current.gameId&&q.current!==null&&F.current.send(JSON.stringify({type:"PLAYER_READY",gameId:B.current.gameId,playerId:q.current}))},[pe,Ye]),Ae=O.useCallback(t=>{var a;if(localStorage.getItem("webrtc_enabled")==="true"&&D.current&&pe.current){m(s=>{const c=s.players.map(d=>{let y=1;for(const[u,R]of Object.entries(t))if(R.includes(d.id)){y=parseInt(u);break}return{...d,teamId:y}});return{...s,players:c}}),D.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:D.current.getPeerId(),data:{assignments:t},timestamp:Date.now()});return}((a=F.current)==null?void 0:a.readyState)===WebSocket.OPEN&&B.current.gameId&&F.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:B.current.gameId,assignments:t}))},[pe]),yt=O.useCallback(t=>{var a;if(localStorage.getItem("webrtc_enabled")==="true"&&D.current&&pe.current){m(s=>({...s,gameMode:t})),D.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:D.current.getPeerId(),data:{mode:t},timestamp:Date.now()});return}((a=F.current)==null?void 0:a.readyState)===WebSocket.OPEN&&B.current.gameId&&F.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:B.current.gameId,mode:t}))},[pe]),Dt=O.useCallback(t=>{var a;if(localStorage.getItem("webrtc_enabled")==="true"&&D.current&&pe.current){m(s=>({...s,isPrivate:t})),D.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:D.current.getPeerId(),data:{isPrivate:t},timestamp:Date.now()});return}((a=F.current)==null?void 0:a.readyState)===WebSocket.OPEN&&B.current.gameId&&F.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:B.current.gameId,isPrivate:t}))},[pe]),ht=O.useCallback(()=>{var t;if(((t=F.current)==null?void 0:t.readyState)===WebSocket.OPEN&&B.current.gameId&&q.current===1){F.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:St}));const i=B.current,a=Ue(i);a.players.forEach(s=>{if(["hand","deck","discard"].forEach(d=>{s[d]&&(s[d]=s[d].map(y=>{const u=Ir(y.name);return u?{...y,...u}:y}))}),s.announcedCard){const d=Ir(s.announcedCard.name);d&&(s.announcedCard={...s.announcedCard,...d})}}),a.board.forEach(s=>{s.forEach(c=>{if(c.card){const d=Ir(c.card.name);d&&(c.card={...c.card,...d})}})}),F.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:a})),m(a)}},[]),Pt=O.useCallback(t=>{h(i=>{if(i.isGameStarted)return i;const a={...i,activeGridSize:t};if(i.board.length!==t){a.board=[];for(let c=0;c<t;c++){const d=[];for(let y=0;y<t;y++)d.push({card:null});a.board.push(d)}}else a.board=pt(a);return a})},[h]),bt=O.useCallback(t=>{h(i=>{if(i.isGameStarted)return i;const a=i.players.filter(d=>!d.isDummy);if(a.length+t>gn)return i;const s=[...a],c=Math.max(...a.map(d=>d.id),0);for(let d=0;d<t;d++){const y=c+d+1,u=l(y,!0);u.name=`Dummy ${d+1}`,s.push(u)}return{...i,players:s,dummyPlayerCount:t}})},[h,l]),Ct=O.useCallback((t,i,a)=>{h(s=>{var y,u;if(!s.isGameStarted)return s;const c=Ue(s),d=c.board[t.row][t.col].card;if(d){if(i==="Stun"&&(d.baseId==="luciusTheImmortal"||d.name.includes("Lucius")&&((y=d.types)!=null&&y.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(i)&&((u=d.statuses)==null?void 0:u.some(H=>H.type===i&&H.addedByPlayerId===a)))return s;d.statuses||(d.statuses=[]),d.statuses.push({type:i,addedByPlayerId:a})}return c})},[h]),hr=O.useCallback((t,i)=>{h(a=>{if(!a.isGameStarted)return a;const s=Ue(a),c=s.board[t.row][t.col].card;if(c!=null&&c.statuses){const d=c.statuses.map(y=>y.type).lastIndexOf(i);d>-1&&c.statuses.splice(d,1)}return s.board=pt(s),s})},[h]),Ot=O.useCallback((t,i,a)=>{h(s=>{if(!s.isGameStarted)return s;const c=Ue(s),d=c.board[t.row][t.col].card;if(d!=null&&d.statuses){const y=d.statuses.findIndex(u=>u.type===i&&u.addedByPlayerId===a);y>-1&&d.statuses.splice(y,1)}return c.board=pt(c),c})},[h]),ua=O.useCallback((t,i)=>{h(a=>{if(!a.isGameStarted)return a;const s=Ue(a),c=s.board[t.row][t.col].card;return c&&(c.powerModifier===void 0&&(c.powerModifier=0),c.powerModifier+=i),s})},[h]),fa=O.useCallback((t,i,a)=>{h(s=>{var y;if(!s.isGameStarted)return s;const c=Ue(s),d=c.players.find(u=>u.id===t);if(d!=null&&d.announcedCard){if(["Support","Threat","Revealed"].includes(i)&&((y=d.announcedCard.statuses)==null?void 0:y.some(R=>R.type===i&&R.addedByPlayerId===a)))return s;d.announcedCard.statuses||(d.announcedCard.statuses=[]),d.announcedCard.statuses.push({type:i,addedByPlayerId:a})}return c})},[h]),pa=O.useCallback((t,i)=>{h(a=>{var d;if(!a.isGameStarted)return a;const s=Ue(a),c=s.players.find(y=>y.id===t);if((d=c==null?void 0:c.announcedCard)!=null&&d.statuses){const y=c.announcedCard.statuses.map(u=>u.type).lastIndexOf(i);y>-1&&c.announcedCard.statuses.splice(y,1)}return s})},[h]),ya=O.useCallback((t,i)=>{h(a=>{if(!a.isGameStarted)return a;const s=Ue(a),c=s.players.find(d=>d.id===t);return c!=null&&c.announcedCard&&(c.announcedCard.powerModifier===void 0&&(c.announcedCard.powerModifier=0),c.announcedCard.powerModifier+=i),s})},[h]),ha=O.useCallback((t,i,a,s)=>{h(c=>{var u;if(!c.isGameStarted)return c;const d=Ue(c),y=d.players.find(R=>R.id===t);if(y!=null&&y.hand[i]){const R=y.hand[i];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(a)&&((u=R.statuses)==null?void 0:u.some(ee=>ee.type===a&&ee.addedByPlayerId===s)))return c;R.statuses||(R.statuses=[]),R.statuses.push({type:a,addedByPlayerId:s})}return d})},[h]),ma=O.useCallback((t,i,a)=>{h(s=>{if(!s.isGameStarted)return s;const c=Ue(s),d=c.players.find(u=>u.id===t),y=d==null?void 0:d.hand[i];if(y!=null&&y.statuses){const u=y.statuses.map(R=>R.type).lastIndexOf(a);u>-1&&y.statuses.splice(u,1),a==="Revealed"&&(y.statuses.some(H=>H.type==="Revealed")||delete y.revealedTo)}return c})},[h]),Ea=O.useCallback(t=>{h(i=>{if(!i.isGameStarted)return i;const a=Ue(i),s=a.board[t.row][t.col].card;return s&&(s.isFaceDown=!1),a.board=pt(a),a})},[h]),Ia=O.useCallback(t=>{h(i=>{if(!i.isGameStarted)return i;const a=Ue(i),s=a.board[t.row][t.col].card;return s&&(s.isFaceDown=!0),a.board=pt(a),a})},[h]),Ta=O.useCallback((t,i,a)=>{h(s=>{const c=s.players.find(u=>u.id===t);if(!(c!=null&&c.hand[i]))return s;const d=Ue(s),y=d.players.find(u=>u.id===t).hand[i];if(a==="all")y.revealedTo="all",y.statuses||(y.statuses=[]),y.statuses.some(u=>u.type==="Revealed"&&u.addedByPlayerId===t)||y.statuses.push({type:"Revealed",addedByPlayerId:t});else{(!y.revealedTo||y.revealedTo==="all"||!Array.isArray(y.revealedTo))&&(y.revealedTo=[]);const u=a.filter(R=>!y.revealedTo.includes(R));y.revealedTo.push(...u)}return d})},[h]),ga=O.useCallback((t,i)=>{h(a=>{if(!a.board[t.row][t.col].card)return a;const c=Ue(a),d=c.board[t.row][t.col].card,y=d.ownerId;if(i==="all")d.revealedTo="all",y!==void 0&&(d.statuses||(d.statuses=[]),d.statuses.some(u=>u.type==="Revealed"&&u.addedByPlayerId===y)||d.statuses.push({type:"Revealed",addedByPlayerId:y}));else{(!d.revealedTo||d.revealedTo==="all"||!Array.isArray(d.revealedTo))&&(d.revealedTo=[]);const u=i.filter(R=>!d.revealedTo.includes(R));d.revealedTo.push(...u)}return c})},[h]),_a=O.useCallback((t,i)=>{h(a=>{var y;const s=t.boardCoords?(y=a.board[t.boardCoords.row][t.boardCoords.col].card)==null?void 0:y.ownerId:t.ownerId;if(!s)return a;const c=Ue(a),d=c.revealRequests.find(u=>u.fromPlayerId===i&&u.toPlayerId===s);return d?d.cardIdentifiers.some(R=>JSON.stringify(R)===JSON.stringify(t))||d.cardIdentifiers.push(t):c.revealRequests.push({fromPlayerId:i,toPlayerId:s,cardIdentifiers:[t]}),c})},[h]),wa=O.useCallback((t,i)=>{h(a=>{const s=a.revealRequests.findIndex(y=>y.toPlayerId===q.current&&y.fromPlayerId===t);if(s===-1)return a;const c=Ue(a),d=c.revealRequests[s];if(i){const{cardIdentifiers:y}=d;for(const u of y){let R=null;if(u.source==="board"&&u.boardCoords)R=c.board[u.boardCoords.row][u.boardCoords.col].card;else if(u.source==="hand"&&u.ownerId&&u.cardIndex!==void 0){const H=c.players.find(ee=>ee.id===u.ownerId);H&&(R=H.hand[u.cardIndex])}R&&(R.statuses||(R.statuses=[]),R.statuses.some(H=>H.type==="Revealed"&&H.addedByPlayerId===t)||R.statuses.push({type:"Revealed",addedByPlayerId:t}))}}return c.revealRequests.splice(s,1),c})},[h]),Da=O.useCallback(t=>{h(i=>{const a=Ue(i);let s=null;if(t.source==="board"&&t.boardCoords)s=a.board[t.boardCoords.row][t.boardCoords.col].card;else if(t.source==="hand"&&t.playerId&&t.cardIndex!==void 0){const c=a.players.find(d=>d.id===t.playerId);c&&(s=c.hand[t.cardIndex])}return s&&(s.statuses&&(s.statuses=s.statuses.filter(c=>c.type!=="Revealed")),delete s.revealedTo),a})},[h]),Ca=O.useCallback((t,i)=>{h(a=>a.isGameStarted?a:{...a,players:a.players.map(s=>s.id===t?{...s,name:i}:s)})},[h]),ba=O.useCallback((t,i)=>{h(a=>a.isGameStarted||a.players.some(c=>c.id!==t&&!c.isDummy&&c.color===i)?a:{...a,players:a.players.map(c=>c.id===t?{...c,color:i}:c)})},[h]),vt=O.useCallback((t,i)=>{var c;const a=B.current;if(!a.isGameStarted){p.warn("[ScoreUpdate] Blocked: game not started");return}if(a.isRoundEndModalOpen){p.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(i===0)return;const s=localStorage.getItem("webrtc_enabled")==="true";if(s?h(d=>({...d,players:d.players.map(y=>y.id===t?{...y,score:Math.max(0,(y.score||0)+i)}:y)})):m(d=>({...d,players:d.players.map(y=>y.id===t?{...y,score:Math.max(0,(y.score||0)+i)}:y)})),!s){if(((c=F.current)==null?void 0:c.readyState)!==WebSocket.OPEN){p.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const d=At.get(t);if(d){clearTimeout(d.timerId);const y=d.delta+i,u=setTimeout(()=>{var H;const R=At.get(t);R&&((H=F.current)==null?void 0:H.readyState)===WebSocket.OPEN&&(p.info(`[ScoreUpdate] Sending accumulated delta: player=${t}, delta=${R.delta}`),F.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:B.current.gameId,playerId:t,delta:R.delta}))),At.delete(t)},500);At.set(t,{delta:y,timerId:u})}else{const y=setTimeout(()=>{var R;const u=At.get(t);u&&((R=F.current)==null?void 0:R.readyState)===WebSocket.OPEN&&(p.info(`[ScoreUpdate] Sending delta: player=${t}, delta=${u.delta}`),F.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:B.current.gameId,playerId:t,delta:u.delta}))),At.delete(t)},500);At.set(t,{delta:i,timerId:y})}}},[m,h]),Ra=O.useCallback((t,i)=>{const a=localStorage.getItem("webrtc_enabled")==="true";h(s=>s.isGameStarted?s:{...s,players:s.players.map(c=>c.id===t?{...c,deck:o(i,t,c.name),selectedDeck:i,hand:[],discard:[],announcedCard:null,boardHistory:[]}:c)}),a&&!pe.current&&K&&K("CHANGE_PLAYER_DECK",{playerId:t,deckType:i})},[h,o,K]),Sa=O.useCallback((t,i)=>{h(a=>{if(a.isGameStarted)return a;const s=a.players.find(y=>y.id===t);if(!s)return a;const c=[],d=new Map;for(const{cardId:y,quantity:u}of i.cards){const R=Tn(y);if(!R)continue;const H=In.has(y),ee=H?ct.Command:ct.Custom,qe=H?"CMD":"CUS";for(let We=0;We<u;We++){const He=(d.get(y)||0)+1;d.set(y,He),c.push({...R,id:`${qe}_${y.toUpperCase()}_${He}`,baseId:y,deck:ee,ownerId:t,ownerName:s.name})}}return{...a,players:a.players.map(y=>y.id===t?{...y,deck:fr(c),selectedDeck:ct.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:y)}})},[h]),Aa=O.useCallback(t=>{h(i=>{if(!i.isGameStarted)return i;const a=i.players.find(y=>y.id===t);if(!a||a.deck.length===0)return i;const s=Ue(i),c=s.players.find(y=>y.id===t),d=c.deck.shift();return d&&c.hand.push(d),s})},[h]),Oa=O.useCallback((t,i)=>{i<=0||h(a=>{if(!a.isGameStarted)return a;const s=a.players.find(u=>u.id===t);if(!s||s.deck.length===0)return a;const c=Ue(a),d=c.players.find(u=>u.id===t),y=Math.min(i,d.deck.length);for(let u=0;u<y;u++){const R=d.deck.shift();R&&d.hand.push(R)}return c})},[h]),Pa=O.useCallback(t=>{h(i=>{if(!i.isGameStarted||!i.players.find(d=>d.id===t))return i;const s=Ue(i),c=s.players.find(d=>d.id===t);return c.deck=fr(c.deck),s})},[h]),va=O.useCallback(t=>{localStorage.getItem("webrtc_enabled")==="true"&&D.current?pe.current?m(a=>{const s=ra(a,t);return D.current&&D.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:D.current.getPeerId(),data:{activePlayerId:s.activePlayerId,currentPhase:s.currentPhase,turnNumber:s.turnNumber},timestamp:Date.now()}),s}):D.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:t},timestamp:Date.now()}):F.current&&F.current.readyState===WebSocket.OPEN&&(At.forEach((a,s)=>{clearTimeout(a.timerId),p.info(`[ScoreFlush] Flushing on toggle: player=${s}, delta=${a.delta}`),F.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:B.current.gameId,playerId:s,delta:a.delta}))}),At.clear(),F.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:B.current.gameId,playerId:t})))},[]),Na=O.useCallback((t,i)=>{F.current&&F.current.readyState===WebSocket.OPEN&&F.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:B.current.gameId,playerId:t,enabled:i}))},[]),ka=O.useCallback(t=>{const i=r&&n&&r.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(r.mode);i&&n(null),h(a=>{if(!a.isGameStarted)return a;const s=Math.max(1,Math.min(t,4));return{...a,currentPhase:s,...s===4&&!i?{isScoringStep:!0}:{},...i?{isScoringStep:!1}:{}}})},[h,r,n]),La=O.useCallback(()=>{var a;r&&n&&r.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(r.mode)&&n(null);const t=B.current,i=localStorage.getItem("webrtc_enabled")==="true";if(t.isGameStarted&&t.currentPhase===4&&t.isScoringStep&&!i){((a=F.current)==null?void 0:a.readyState)===WebSocket.OPEN&&(At.forEach((s,c)=>{clearTimeout(s.timerId),p.info(`[ScoreFlush] Flushing pending score: player=${c}, delta=${s.delta}`),F.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:t.gameId,playerId:c,delta:s.delta}))}),At.clear(),F.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:t.gameId})));return}if(i&&t.isGameStarted&&t.currentPhase===4&&t.isScoringStep){h(s=>ur(s));return}h(s=>{if(!s.isGameStarted)return s;const c=Ue(s),d=s.currentPhase+1;return s.preserveDeployAbilities||c.board.forEach(y=>{y.forEach(u=>{var R;(R=u.card)!=null&&R.statuses&&(u.card.statuses=u.card.statuses.filter(H=>H.type!=="readyDeploy"))})}),i&&d===4&&s.currentPhase===3?Fn(s,s.activePlayerId)?(c.isScoringStep=!0,c.currentPhase=4,c):(p.info(`[nextPhase] Player ${s.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),ur(s)):d===4&&s.currentPhase===3?(c.isScoringStep=!0,c.currentPhase=4,c):(c.board.forEach(y=>{y.forEach(u=>{var R;if((R=u.card)!=null&&R.statuses){const H=u.card.statuses.findIndex(ee=>ee.type==="Resurrected");if(H!==-1){const ee=u.card.statuses[H].addedByPlayerId;u.card.statuses.splice(H,1),u.card.baseId!=="luciusTheImmortal"&&(u.card.statuses.push({type:"Stun",addedByPlayerId:ee}),u.card.statuses.push({type:"Stun",addedByPlayerId:ee}))}}})}),c.board=pt(c),c.currentPhase=d,c)})},[h,r,n]),Ma=O.useCallback(()=>{h(t=>t.isGameStarted?(r&&n&&r.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(r.mode)&&n(null),t.isScoringStep?{...t,isScoringStep:!1,currentPhase:Math.max(1,t.currentPhase-1)}:{...t,currentPhase:Math.max(1,t.currentPhase-1)}):t)},[h,r,n]),Ga=O.useCallback(()=>{var i;localStorage.getItem("webrtc_enabled")==="true"?h(a=>({...a,isRoundEndModalOpen:!1,currentRound:(a.currentRound||1)+1,players:a.players.map(s=>({...s,score:0}))})):((i=F.current)==null?void 0:i.readyState)===WebSocket.OPEN&&B.current.gameId&&(m(a=>({...a,isRoundEndModalOpen:!1,currentRound:(a.currentRound||1)+1,players:a.players.map(s=>({...s,score:0}))})),F.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:B.current.gameId})))},[m,h]),xa=O.useCallback(()=>{m(t=>({...t,isRoundEndModalOpen:!1}))},[m]),$a=O.useCallback(()=>{var i;if(localStorage.getItem("webrtc_enabled")==="true"){const a=B.current,s=a.players.map(u=>{const R=u.selectedDeck||"SynchroTech";return{...u,hand:[],deck:o(R,u.id,u.name),discard:[],score:0,isReady:!1,announcedCard:null,boardHistory:[]}}),c=a.activeGridSize||8,d=[];for(let u=0;u<c;u++){const R=[];for(let H=0;H<c;H++)R.push({card:null});d.push(R)}const y={...a,players:s,board:d,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};m(y),B.current=y,D.current&&D.current.broadcastToGuests({type:"GAME_RESET",senderId:D.current.getPeerId(),data:{players:s.map(u=>({id:u.id,name:u.name,color:u.color,selectedDeck:u.selectedDeck,isDummy:u.isDummy,isDisconnected:u.isDisconnected,autoDrawEnabled:u.autoDrawEnabled,handSize:u.hand.length,deckSize:u.deck.length,discardSize:u.discard.length,...u.isDummy&&{hand:u.hand.map(R=>({id:R.id,baseId:R.baseId,name:R.name,imageUrl:R.imageUrl,power:R.power,powerModifier:R.powerModifier,ability:R.ability,ownerId:R.ownerId,color:R.color,deck:R.deck,isFaceDown:R.isFaceDown,types:R.types,faction:R.faction,statuses:R.statuses})),deck:u.deck.map(R=>({id:R.id,baseId:R.baseId,name:R.name,imageUrl:R.imageUrl,power:R.power,powerModifier:R.powerModifier,ability:R.ability,ownerId:R.ownerId,color:R.color,deck:R.deck,isFaceDown:R.isFaceDown,types:R.types,faction:R.faction,statuses:R.statuses})),discard:u.discard.map(R=>({id:R.id,baseId:R.baseId,name:R.name,imageUrl:R.imageUrl,power:R.power,powerModifier:R.powerModifier,ability:R.ability,ownerId:R.ownerId,color:R.color,deck:R.deck,isFaceDown:R.isFaceDown,types:R.types,faction:R.faction,statuses:R.statuses}))},score:u.score,isReady:u.isReady,announcedCard:u.announcedCard})),gameMode:y.gameMode,isPrivate:y.isPrivate,activeGridSize:y.activeGridSize,dummyPlayerCount:y.dummyPlayerCount,autoAbilitiesEnabled:y.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((i=F.current)==null?void 0:i.readyState)===WebSocket.OPEN&&F.current.send(JSON.stringify({type:"RESET_GAME",gameId:B.current.gameId}))},[]),Gr=O.useCallback((t,i)=>{h(a=>{var H,ee,qe,We,He,ut,lt,Fe,ke,Ge;if(!a.isGameStarted||i.target==="board"&&i.boardCoords&&a.board[i.boardCoords.row][i.boardCoords.col].card!==null&&t.source!=="counter_panel")return a;let s=!1;try{const W=localStorage.getItem("auto_abilities_enabled");s=W===null?!0:W==="true"}catch{s=!0}const c=s&&a.currentPhase===1&&t.source==="hand"&&i.target==="board"&&(((H=t.card.types)==null?void 0:H.includes("Unit"))||((ee=t.card.types)==null?void 0:ee.includes("Command"))),d=Ue(a);if(t.source==="board"&&["hand","deck","discard"].includes(i.target)&&!t.bypassOwnershipCheck){const W=t.card.ownerId,te=d.players.find($e=>$e.id===W),de=W===q.current,Pe=!!(te!=null&&te.isDummy);if(!de&&!Pe)return a}let y=null;if(t.source==="board"&&i.target==="board"&&t.boardCoords){const W=d.board[t.boardCoords.row][t.boardCoords.col];W.card&&(y=W.card);const de=a.board[t.boardCoords.row][t.boardCoords.col].card||y;if(de&&((qe=de.statuses)==null?void 0:qe.some($e=>$e.type==="Stun"))){const $e=q.current,dt=de.ownerId,mt=a.players.find(xt=>xt.id===$e),ft=a.players.find(xt=>xt.id===dt),Gt=$e===dt,rr=(mt==null?void 0:mt.teamId)!==void 0&&(ft==null?void 0:ft.teamId)!==void 0&&mt.teamId===ft.teamId;if((Gt||rr)&&!t.isManual)return a}}if(t.source==="counter_panel"&&t.statusType){const W=Bt[t.statusType];if(!((W==null?void 0:W.allowedTargets)??["board","hand"]).includes(i.target))return a;let de=null;if(i.target==="board"&&i.boardCoords)de=d.board[i.boardCoords.row][i.boardCoords.col].card;else if(i.playerId!==void 0){const Pe=d.players.find($e=>$e.id===i.playerId);Pe&&(i.target==="hand"&&i.cardIndex!==void 0&&(de=Pe.hand[i.cardIndex]),i.target==="announced"&&(de=Pe.announcedCard||null),i.target==="deck"&&Pe.deck.length>0?i.deckPosition==="top"||!i.deckPosition?de=Pe.deck[0]:de=Pe.deck[Pe.deck.length-1]:i.target==="discard"&&Pe.discard.length>0&&(de=Pe.discard[Pe.discard.length-1]))}if(de){if(t.statusType==="Stun"&&(de.baseId==="luciusTheImmortal"||de.name.includes("Lucius")&&((We=de.types)!=null&&We.includes("Hero"))))return d;const Pe=t.count||1;let $e;if(t.ownerId!==void 0)$e=t.ownerId;else if(t.card.ownerId!==void 0)$e=t.card.ownerId;else{const dt=d.players.find(mt=>mt.id===d.activePlayerId);$e=dt!=null&&dt.isDummy?dt.id:q.current!==null?q.current:0}if(t.statusType==="Power+")de.powerModifier===void 0&&(de.powerModifier=0),de.powerModifier+=1*Pe;else if(t.statusType==="Power-")de.powerModifier===void 0&&(de.powerModifier=0),de.powerModifier-=1*Pe;else if(de.statuses||(de.statuses=[]),t.replaceStatusType&&t.statusType)for(let dt=0;dt<Pe;dt++){const mt=de.statuses.findIndex(ft=>ft.type===t.replaceStatusType&&ft.addedByPlayerId===$e);mt!==-1?de.statuses[mt]={type:t.statusType,addedByPlayerId:$e}:de.statuses.push({type:t.statusType,addedByPlayerId:$e})}else for(let dt=0;dt<Pe;dt++)["Support","Threat","Revealed"].includes(t.statusType)?de.statuses.some(ft=>ft.type===t.statusType&&ft.addedByPlayerId===$e)||de.statuses.push({type:t.statusType,addedByPlayerId:$e}):de.statuses.push({type:t.statusType,addedByPlayerId:$e});return i.target==="board"&&(d.board=pt(d)),d}return a}const u=y?{...y}:{...t.card};if(t.source==="hand"&&t.playerId!==void 0&&t.cardIndex!==void 0){const W=d.players.find(te=>te.id===t.playerId);if(W){const te=W.hand[t.cardIndex];if(te&&te.id===t.card.id&&te.ownerId===t.card.ownerId)W.hand.splice(t.cardIndex,1);else{const de=W.hand.findIndex(Pe=>Pe.id===t.card.id&&Pe.ownerId===t.card.ownerId);if(de!==-1)W.hand.splice(de,1);else return a}}}else if(t.source==="board"&&t.boardCoords){const W=d.board[t.boardCoords.row][t.boardCoords.col];if(W.card&&W.card.id===t.card.id&&W.card.ownerId===t.card.ownerId)d.board[t.boardCoords.row][t.boardCoords.col].card=null;else return a}else if(t.source==="discard"&&t.playerId!==void 0){const W=d.players.find(te=>te.id===t.playerId);if(W){let te=!1;if(t.cardIndex!==void 0){const de=W.discard[t.cardIndex];de&&de.id===t.card.id&&de.ownerId===t.card.ownerId&&(W.discard.splice(t.cardIndex,1),te=!0)}if(!te){const de=W.discard.findIndex(Pe=>Pe.id===t.card.id&&Pe.ownerId===t.card.ownerId);if(de!==-1)W.discard.splice(de,1);else return a}}}else if(t.source==="deck"&&t.playerId!==void 0&&t.cardIndex!==void 0){const W=d.players.find(te=>te.id===t.playerId);if(W){const te=W.deck[t.cardIndex];if(te&&te.id===t.card.id&&te.ownerId===t.card.ownerId)W.deck.splice(t.cardIndex,1);else{const de=W.deck.findIndex(Pe=>Pe.id===t.card.id&&Pe.ownerId===t.card.ownerId);if(de!==-1)W.deck.splice(de,1);else return a}}}else if(t.source==="announced"&&t.playerId!==void 0){const W=d.players.find(te=>te.id===t.playerId);if(W)if(W.announcedCard&&W.announcedCard.id===t.card.id)W.announcedCard=null;else return a}if(["hand","deck","discard"].includes(i.target))u.statuses&&(u.statuses=u.statuses.filter(W=>W.type==="Revealed")),u.isFaceDown=!1,delete u.powerModifier,delete u.bonusPower,delete u.enteredThisTurn;else if(i.target==="board"&&(u.statuses||(u.statuses=[]),t.source!=="board"&&u.isFaceDown===void 0&&(u.isFaceDown=!1),t.source!=="board")){u.enteredThisTurn=!0;let W=u.ownerId;W===void 0&&(t.source==="token_panel"?W=d.activePlayerId??q.current??0:t.playerId!==void 0?W=t.playerId:W=q.current??0,u.ownerId=W),Tr(u,W),t.source==="discard"&&(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius"))&&(u.powerModifier===void 0&&(u.powerModifier=0),u.powerModifier+=2)}if(i.target==="hand"&&i.playerId!==void 0){if((u.deck===ct.Tokens||u.deck==="counter")&&(((He=u.types)==null?void 0:He.includes("Token"))||((ut=u.types)==null?void 0:ut.includes("Token Unit"))))return a;gr(u);const te=d.players.find(Pe=>Pe.id===i.playerId);if(!te)return a;let de=i.cardIndex!==void 0?i.cardIndex:te.hand.length;if(t.source==="hand"&&t.playerId===i.playerId&&t.cardIndex!==void 0&&(t.cardIndex<de&&(de-=1),t.cardIndex===de))return a;te.hand.splice(de,0,u)}else if(i.target==="board"&&i.boardCoords){if(d.board[i.boardCoords.row][i.boardCoords.col].card===null){if(u.ownerId===void 0&&q.current!==null){const W=d.players.find(te=>te.id===q.current);W&&(u.ownerId=W.id,u.ownerName=W.name)}if(t.source!=="board"&&u.ownerId!==void 0){const W=d.players.find(te=>te.id===u.ownerId);W&&(W.boardHistory||(W.boardHistory=[]),W.boardHistory.push(u.id))}d.board[i.boardCoords.row][i.boardCoords.col].card=u}}else if(i.target==="discard"&&i.playerId!==void 0){if(!(u.deck===ct.Tokens||u.deck==="counter")){gr(u),u.statuses&&(u.statuses=u.statuses.filter(te=>te.type!=="Revealed"));const W=d.players.find(te=>te.id===i.playerId);W&&(u.ownerId===void 0&&(u.ownerId=i.playerId,u.ownerName=W.name),W.discard.some(de=>de.id===u.id)||W.discard.push(u))}}else if(i.target==="deck"&&i.playerId!==void 0){if((u.deck===ct.Tokens||u.deck==="counter")&&(((lt=u.types)==null?void 0:lt.includes("Token"))||((Fe=u.types)==null?void 0:Fe.includes("Token Unit"))))return a;gr(u),u.statuses&&(u.statuses=u.statuses.filter(de=>de.type!=="Revealed"));const te=d.players.find(de=>de.id===i.playerId);if(!te)return a;u.ownerId===void 0&&(u.ownerId=i.playerId,u.ownerName=te.name),i.deckPosition==="top"||!i.deckPosition?te.deck.unshift(u):te.deck.push(u)}else if(i.target==="announced"&&i.playerId!==void 0){const W=d.players.find(te=>te.id===i.playerId);W&&(W.announcedCard&&(W.announcedCard.statuses&&(W.announcedCard.statuses=W.announcedCard.statuses.filter(te=>te.type==="Revealed")),delete W.announcedCard.enteredThisTurn,delete W.announcedCard.powerModifier,delete W.announcedCard.bonusPower,W.hand.push(W.announcedCard)),W.announcedCard=u)}if(t.source==="board"&&i.target!=="board"&&u.ownerId!==void 0){const W=d.players.find(te=>te.id===u.ownerId);W&&(W.boardHistory||(W.boardHistory=[]),W.boardHistory=W.boardHistory.filter(te=>te!==u.id))}if((t.source==="board"||i.target==="board")&&u.ownerId!==void 0){const W=d.players.find(te=>te.id===u.ownerId);W&&oa(d.board,W)}if(t.source==="hand"&&i.target==="board"){const W=u;if(W.revealedTo==="all"||((ke=W.statuses)==null?void 0:ke.some(de=>de.type==="Revealed"))){const de=d.board.length;for(let Pe=0;Pe<de;Pe++)for(let $e=0;$e<de;$e++){const dt=d.board[Pe][$e].card;if(dt&&dt.name.toLowerCase().includes("vigilant spotter")&&dt.ownerId!==W.ownerId&&(d.board=pt(d),(Ge=d.board[Pe][$e].card.statuses)!=null&&Ge.some(ft=>ft.type==="Support"))){const ft=d.players.find(Gt=>Gt.id===dt.ownerId);ft&&setTimeout(()=>{vt(ft.id,2)},0)}}}}return(t.source==="board"||i.target==="board")&&(d.board=pt(d)),c&&(d.currentPhase=2),d})},[h]),Ua=O.useCallback((t,i,a,s)=>{h(c=>{if(!c.isGameStarted||c.board[a.row][a.col].card!==null)return c;const d=Ue(c),y=d.players.find(u=>u.id===t);if(y&&y.discard.length>i){const[u]=y.discard.splice(i,1);u.enteredThisTurn=!0,Tr(u,t),(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius"))&&(u.powerModifier===void 0&&(u.powerModifier=0),u.powerModifier+=2),u.statuses||(u.statuses=[]),u.statuses.push({type:"Resurrected",addedByPlayerId:t}),s&&s.forEach(R=>{var H;R.type!=="Resurrected"&&((H=u.statuses)==null||H.push({type:R.type,addedByPlayerId:t}))}),y.boardHistory||(y.boardHistory=[]),y.boardHistory.push(u.id),d.board[a.row][a.col].card=u,oa(d.board,y),d.board=pt(d)}return d})},[h]),Ha=O.useCallback((t,i)=>{h(a=>{const s=Ue(a),c=s.players.find(d=>d.id===t);if(c&&i.length>0){const d=new Set(i.map(u=>u.id)),y=c.deck.filter(u=>!d.has(u.id));c.deck=[...i,...y]}return s})},[h]),Fa=O.useCallback((t,i,a)=>{h(s=>{const c=Ue(s),d=c.players.find(y=>y.id===t);return d&&(a==="deck"?d.deck=i:a==="discard"&&(d.discard=i)),c})},[h]),Wa=O.useCallback(t=>{var a;const i={...t,timestamp:Date.now()};if(Z(i),((a=F.current)==null?void 0:a.readyState)===WebSocket.OPEN&&B.current.gameId)F.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:B.current.gameId,highlightData:i}));else if(D.current){const s={type:"HIGHLIGHT_TRIGGERED",senderId:D.current.getPeerId(),data:i,timestamp:Date.now()};pe.current?D.current.broadcastToGuests(s):D.current.sendMessageToHost(s)}},[]),Yt=O.useCallback(t=>{var c;const i=Array.isArray(t)?t:[t],a=Date.now(),s=i.map((d,y)=>({...d,timestamp:a+y}));if(ne(s),((c=F.current)==null?void 0:c.readyState)===WebSocket.OPEN&&B.current.gameId)F.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:B.current.gameId,batch:s}));else if(D.current){const d={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:D.current.getPeerId(),data:{batch:s},timestamp:Date.now()};pe.current?D.current.broadcastToGuests(d):D.current.sendMessageToHost(d)}},[]),Ba=O.useCallback(t=>{var a;const i=Date.now();if(Te({coords:t,timestamp:i}),((a=F.current)==null?void 0:a.readyState)===WebSocket.OPEN&&B.current.gameId)F.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:B.current.gameId,coords:t,timestamp:i}));else if(D.current){const s={type:"NO_TARGET_TRIGGERED",senderId:D.current.getPeerId(),data:{coords:t,timestamp:i},timestamp:Date.now()};pe.current?D.current.broadcastToGuests(s):D.current.sendMessageToHost(s)}},[]),Ya=O.useCallback((t,i)=>{var s;const a={playerId:t,selectedByPlayerId:i,timestamp:Date.now()};if(Se(c=>[...c,a]),((s=F.current)==null?void 0:s.readyState)===WebSocket.OPEN&&B.current.gameId){const c={type:"TRIGGER_DECK_SELECTION",gameId:B.current.gameId,deckSelectionData:a};F.current.send(JSON.stringify(c))}else if(D.current){const c={type:"DECK_SELECTION_TRIGGERED",senderId:D.current.getPeerId(),data:a,timestamp:Date.now()};pe.current?D.current.broadcastToGuests(c):D.current.sendMessageToHost(c)}setTimeout(()=>{Se(c=>c.filter(d=>d.timestamp!==a.timestamp))},1e3)},[]),za=O.useCallback((t,i,a)=>{var c;const s={playerId:t,cardIndex:i,selectedByPlayerId:a,timestamp:Date.now()};if(Ee(d=>[...d,s]),((c=F.current)==null?void 0:c.readyState)===WebSocket.OPEN&&B.current.gameId){const d={type:"TRIGGER_HAND_CARD_SELECTION",gameId:B.current.gameId,handCardSelectionData:s};F.current.send(JSON.stringify(d))}else if(D.current){const d={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:D.current.getPeerId(),data:s,timestamp:Date.now()};pe.current?D.current.broadcastToGuests(d):D.current.sendMessageToHost(d)}setTimeout(()=>{Ee(d=>d.filter(y=>y.timestamp!==s.timestamp))},1e3)},[]),Ka=O.useCallback(t=>{var i;if(((i=F.current)==null?void 0:i.readyState)===WebSocket.OPEN&&B.current.gameId)F.current.send(JSON.stringify({type:"SYNC_VALID_TARGETS",gameId:B.current.gameId,playerId:q.current,...t}));else if(D.current){const a={type:"SYNC_VALID_TARGETS",senderId:D.current.getPeerId(),data:{playerId:q.current,...t},timestamp:Date.now()};pe.current?D.current.broadcastToGuests(a):D.current.sendMessageToHost(a)}},[]),ja=O.useCallback((t,i,a)=>{var c;if(q.current===null)return;const s={timestamp:Date.now(),location:t,boardCoords:i,handTarget:a,selectedByPlayerId:q.current};if(V(d=>[...d,s]),((c=F.current)==null?void 0:c.readyState)===WebSocket.OPEN&&B.current.gameId)F.current.send(JSON.stringify({type:"TRIGGER_TARGET_SELECTION",gameId:B.current.gameId,effect:s}));else if(D.current)if(pe.current){const d={type:"TARGET_SELECTION_TRIGGERED",senderId:D.current.getPeerId(),data:s,timestamp:Date.now()};D.current.broadcastToGuests(d)}else{const d={type:"SET_TARGETING_MODE",senderId:D.current.getPeerId(),data:s,timestamp:Date.now()};D.current.sendMessageToHost(d)}setTimeout(()=>{V(d=>d.filter(y=>y.timestamp!==s.timestamp))},1e3)},[]),qa=O.useCallback((t,i,a,s,c)=>{var ee,qe,We,He,ut,lt,Fe;const d=B.current;let y=[];s?y=s:y=vr(t,d,i,c);const u=[],R=t.mode==="SELECT_DECK";if((ee=t.payload)!=null&&ee.filter&&t.mode==="SELECT_TARGET"){const ke=((qe=t.sourceCard)==null?void 0:qe.ownerId)||t.originalOwnerId||i,Ge=d.players.find(W=>W.id===ke);Ge&&Ge.hand&&Ge.hand.forEach((W,te)=>{try{t.payload.filter(W)&&u.push({playerId:Ge.id,cardIndex:te})}catch{}})}const H={playerId:i,action:t,sourceCoords:a,timestamp:Date.now(),boardTargets:y,handTargets:u.length>0?u:void 0,isDeckSelectable:R||void 0,originalOwnerId:t.originalOwnerId};m(ke=>({...ke,targetingMode:H})),B.current.targetingMode=H,((We=F.current)==null?void 0:We.readyState)===WebSocket.OPEN&&d.gameId&&F.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:d.gameId,targetingMode:H})),D.current&&(pe.current?D.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((ut=(He=D.current).getPeerId)==null?void 0:ut.call(He))??void 0,data:{targetingMode:H},timestamp:Date.now()}):D.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((Fe=(lt=D.current).getPeerId)==null?void 0:Fe.call(lt))??void 0,data:{targetingMode:H},timestamp:Date.now()})),p.info(`[TargetingMode] Player ${i} activated targeting mode`,{mode:t.mode,boardTargetsCount:y.length})},[]),Va=O.useCallback(()=>{var i,a,s,c,d;const t=B.current;m(y=>({...y,targetingMode:null})),B.current.targetingMode=null,((i=F.current)==null?void 0:i.readyState)===WebSocket.OPEN&&t.gameId&&F.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:t.gameId})),D.current&&(pe.current?D.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((s=(a=D.current).getPeerId)==null?void 0:s.call(a))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):D.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((d=(c=D.current).getPeerId)==null?void 0:d.call(c))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[]),Ja=O.useCallback((t,i,a,s)=>{h(c=>{if(!c.isGameStarted)return c;const d=Ue(c),y=d.board[t.row][t.col].card;if(y){const u=y.statuses?y.statuses.map(R=>R.type):[];if(s&&y.statuses){y.statuses=y.statuses.filter(H=>H.type!==s);const R=y.statuses.map(H=>H.type);console.log(`[markAbilityUsed] Removed status '${s}' from ${y.name} at [${t.row},${t.col}]: [${u.join(", ")}] -> [${R.join(", ")}]`)}else console.log(`[markAbilityUsed] Called for ${y.name} at [${t.row},${t.col}] but no readyStatusToRemove specified. Current statuses: [${u.join(", ")}]`)}return d})},[h]),Xa=O.useCallback(t=>{h(i=>{if(!i.isGameStarted)return i;const a=Ue(i),s=a.board[t.row][t.col].card;if(s&&(s.statuses||(s.statuses=[]),(s.ability||"").toLowerCase().includes("deploy:")&&!s.statuses.some(d=>d.type==="readyDeploy"))){const d=s.ownerId;if(d==null||d===0)return i;s.statuses.push({type:"readyDeploy",addedByPlayerId:d})}return a})},[h]),Za=O.useCallback((t,i)=>{h(a=>{if(!a.isGameStarted)return a;const s=Ue(a),c=s.board[t.row][t.col].card;return c!=null&&c.statuses&&(c.statuses=c.statuses.filter(d=>d.type!==i)),s.board=pt(s),s})},[h]),Qa=O.useCallback((t,i,a,s,c)=>{h(d=>{if(!d.isGameStarted)return d;const y=Ue(d);return i.forEach(({row:u,col:R})=>{var ee;const H=y.board[u][R].card;if(H){if(a==="Stun"&&(H.baseId==="luciusTheImmortal"||H.name.includes("Lucius")&&((ee=H.types)!=null&&ee.includes("Hero"))))return;H.statuses||(H.statuses=[]),["Support","Threat","Revealed"].includes(a)?H.statuses.some(We=>We.type===a&&We.addedByPlayerId===s)||H.statuses.push({type:a,addedByPlayerId:s}):H.statuses.push({type:a,addedByPlayerId:s})}}),y})},[h]),en=O.useCallback((t,i)=>{h(a=>{if(!a.isGameStarted)return a;const s=Ue(a),c=s.board[t.row][t.col].card,d=s.board[i.row][i.col].card;return s.board[t.row][t.col].card=d,s.board[i.row][i.col].card=c,s.board=pt(s),s})},[h]),tn=O.useCallback((t,i,a)=>{h(s=>{if(!s.isGameStarted)return s;const c=Ue(s),d=c.board[t.row][t.col].card,y=c.board[i.row][i.col].card;if(d&&y&&d.statuses){const u=d.statuses.findIndex(R=>R.type===a);if(u>-1){const[R]=d.statuses.splice(u,1);y.statuses||(y.statuses=[]),y.statuses.push(R)}}return c.board=pt(c),c})},[h]),rn=O.useCallback((t,i)=>{h(a=>{if(!a.isGameStarted)return a;const s=Ue(a),c=s.board[t.row][t.col].card,d=s.board[i.row][i.col].card,y=["Support","Threat","LastPlayed"];if(c&&d&&c.statuses){const u=c.statuses.filter(H=>!y.includes(H.type)),R=c.statuses.filter(H=>y.includes(H.type));u.length>0&&(d.statuses||(d.statuses=[]),d.statuses.push(...u),c.statuses=R)}return s.board=pt(s),s})},[h]),an=O.useCallback((t,i)=>{h(a=>{if(!a.isGameStarted)return a;const s=Ue(a),c=s.players.find(d=>d.id===t);if(c&&c.discard.length>i){const[d]=c.discard.splice(i,1);c.hand.push(d)}return s})},[h]),nn=O.useCallback((t,i,a)=>{h(s=>{if(!s.isGameStarted)return s;const c=Ue(s);if(!St)return s;const d=St.tokenDatabase,y=Object.keys(d).find(H=>d[H].name===i);if(!y)return s;const u=d[y],R=c.players.find(H=>H.id===a);if(u&&c.board[t.row][t.col].card===null){const H={id:`TKN_${i.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:ct.Tokens,name:i,baseId:u.baseId||y,imageUrl:u.imageUrl,fallbackImage:u.fallbackImage,power:u.power,ability:u.ability,flavorText:u.flavorText,color:u.color,types:u.types||["Unit"],faction:"Tokens",ownerId:a,ownerName:R==null?void 0:R.name,enteredThisTurn:!0,statuses:[]};Tr(H,a),c.board[t.row][t.col].card=H}return c.board=pt(c),c})},[h]),on=O.useCallback((t,i,a,s,c)=>{var lt,Fe;const d=B.current;if(!d.isGameStarted||d.isRoundEndModalOpen)return;const y=d.board.some(ke=>ke.some(Ge=>{var W,te;return((W=Ge.card)==null?void 0:W.ownerId)===c&&Ge.card.name.toLowerCase().includes("data liberator")&&((te=Ge.card.statuses)==null?void 0:te.some(de=>de.type==="Support"))})),u=d.board.length;let R=t,H=t,ee=i,qe=i;if(t===a)R=t,H=t,ee=0,qe=u-1;else if(i===s)ee=i,qe=i,R=0,H=u-1;else return;let We=0;const He=[];for(let ke=R;ke<=H;ke++)for(let Ge=ee;Ge<=qe;Ge++){const te=d.board[ke][Ge].card;if(te&&!((lt=te.statuses)!=null&&lt.some(de=>de.type==="Stun"))){const de=te.ownerId===c,Pe=(Fe=te.statuses)==null?void 0:Fe.some($e=>$e.type==="Exploit"&&$e.addedByPlayerId===c);if(de||y&&Pe&&te.ownerId!==c){const $e=Math.max(0,te.power+(te.powerModifier||0)+(te.bonusPower||0));$e>0&&(We+=$e,He.push({row:ke,col:Ge,text:`+${$e}`,playerId:c}))}}}He.length>0&&Yt(He);const ut=localStorage.getItem("webrtc_enabled")==="true";ut?h(ke=>({...ke,players:ke.players.map(Ge=>Ge.id===c?{...Ge,score:Math.max(0,(Ge.score||0)+We)}:Ge)})):vt(c,We),ut||vt(c,We),We>0&&d.currentPhase===4&&d.activePlayerId===c&&setTimeout(()=>{var ke;ut?h(Ge=>ur(Ge)):((ke=F.current)==null?void 0:ke.readyState)===WebSocket.OPEN&&F.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:d.gameId}))},100)},[Yt,vt,h]),sn=O.useCallback((t,i,a,s,c,d)=>{var ut,lt;const y=B.current;if(!y.isGameStarted||y.isRoundEndModalOpen)return;const u=a>t?1:-1,R=s>i?1:-1,H=Math.abs(t-a);let ee=0,qe=0;const We=[];for(let Fe=0;Fe<=H;Fe++){const ke=t+Fe*u,Ge=i+Fe*R;if(ke<0||ke>=y.board.length||Ge<0||Ge>=y.board.length)continue;const te=y.board[ke][Ge].card;if(te&&!((ut=te.statuses)!=null&&ut.some(de=>de.type==="Stun"))&&te.ownerId===c){const Pe=Math.max(0,te.power+(te.powerModifier||0)+(te.bonusPower||0));Pe>0&&(ee+=Pe,We.push({row:ke,col:Ge,text:`+${Pe}`,playerId:c})),d&&((lt=te.statuses)!=null&&lt.some($e=>$e.type==="Support"&&$e.addedByPlayerId===c))&&(qe+=1)}}d==="point_per_support"&&qe>0&&(ee+=qe),We.length>0&&Yt(We);const He=localStorage.getItem("webrtc_enabled")==="true";He?h(Fe=>({...Fe,players:Fe.players.map(ke=>ke.id===c?{...ke,score:Math.max(0,(ke.score||0)+ee)}:ke)})):vt(c,ee),He||vt(c,ee),d==="draw_per_support"&&qe>0&&h(Fe=>{const ke=Ue(Fe),Ge=ke.players.find(W=>W.id===c);if(Ge&&Ge.deck.length>0)for(let W=0;W<qe;W++)Ge.deck.length>0&&Ge.hand.push(Ge.deck.shift());return ke}),ee>0&&y.currentPhase===4&&y.activePlayerId===c&&setTimeout(()=>{var Fe;He?h(ke=>ur(ke)):((Fe=F.current)==null?void 0:Fe.readyState)===WebSocket.OPEN&&F.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:y.gameId}))},500)},[Yt,vt,h]);return{gameState:_,localPlayerId:A,setLocalPlayerId:x,draggedItem:Y,setDraggedItem:P,connectionStatus:ie,gamesList:S,latestHighlight:se,latestFloatingTexts:k,latestNoTarget:J,latestDeckSelections:Oe,latestHandCardSelections:we,createGame:ce,joinGame:ue,joinGameViaModal:Re,joinAsInvite:fe,requestGamesList:ye,exitGame:ge,startReadyCheck:le,cancelReadyCheck:Le,playerReady:Me,assignTeams:Ae,setGameMode:yt,setGamePrivacy:Dt,setActiveGridSize:Pt,setDummyPlayerCount:bt,updatePlayerName:Ca,changePlayerColor:ba,updatePlayerScore:vt,changePlayerDeck:Ra,loadCustomDeck:Sa,drawCard:Aa,drawCardsBatch:Oa,shufflePlayerDeck:Pa,moveItem:Gr,handleDrop:Gr,addBoardCardStatus:Ct,removeBoardCardStatus:hr,removeBoardCardStatusByOwner:Ot,modifyBoardCardPower:ua,addAnnouncedCardStatus:fa,removeAnnouncedCardStatus:pa,modifyAnnouncedCardPower:ya,addHandCardStatus:ha,removeHandCardStatus:ma,flipBoardCard:Ea,flipBoardCardFaceDown:Ia,revealHandCard:Ta,revealBoardCard:ga,requestCardReveal:_a,respondToRevealRequest:wa,syncGame:ht,removeRevealedStatus:Da,toggleActivePlayer:va,toggleAutoDraw:Na,forceReconnect:z,triggerHighlight:Wa,triggerFloatingText:Yt,triggerNoTarget:Ba,triggerDeckSelection:Ya,triggerHandCardSelection:za,triggerTargetSelection:ja,targetSelectionEffects:G,syncValidTargets:Ka,remoteValidTargets:X,setTargetingMode:qa,clearTargetingMode:Va,nextPhase:La,prevPhase:Ma,setPhase:ka,markAbilityUsed:Ja,applyGlobalEffect:Qa,swapCards:en,transferStatus:tn,transferAllCounters:rn,recoverDiscardedCard:an,resurrectDiscardedCard:Ua,spawnToken:nn,scoreLine:on,closeRoundEndModal:Ga,closeRoundEndModalOnly:xa,resetGame:$a,resetDeployStatus:Xa,scoreDiagonal:sn,removeStatusByType:Za,reorderTopDeck:Ha,reorderCards:Fa,updateState:h,webrtcHostId:De,webrtcIsHost:Xe,initializeWebrtcHost:ae,connectAsGuest:L,sendWebrtcAction:K,isReconnecting:st,reconnectProgress:gt}},lo=({gameState:e,localPlayerId:r,abilityMode:n,setAbilityMode:o,cursorStack:l,setCursorStack:E,commandContext:_,setCommandContext:m,setViewingDiscard:g,triggerNoTarget:I,triggerTargetSelection:A,setPlayMode:x,setCounterSelectionData:Y,interactionLock:P,onAbilityComplete:ie,updateState:b,moveItem:S,drawCard:$,drawCardsBatch:se,updatePlayerScore:Z,markAbilityUsed:k,applyGlobalEffect:ne,swapCards:J,transferStatus:Te,transferAllCounters:Oe,resurrectDiscardedCard:Se,spawnToken:we,scoreLine:Ee,nextPhase:G,modifyBoardCardPower:V,addBoardCardStatus:X,removeBoardCardStatus:oe,removeBoardCardStatusByOwner:j,resetDeployStatus:be,scoreDiagonal:me,removeStatusByType:Be,triggerFloatingText:De,triggerHandCardSelection:Ce,clearValidTargets:Xe,setTargetingMode:ze,clearTargetingMode:pe})=>{const st=O.useCallback((f,C)=>{var Ie,re,D,Ke,B,q,Qe,_t,wt,je,Ye,it,rt;if(f.type==="ABILITY_COMPLETE"){ie==null||ie();return}if(f.type==="REVEREND_SETUP_SCORE"){const ae=((Ie=f.sourceCard)==null?void 0:Ie.ownerId)??0;let L=0;for(let K=0;K<e.board.length;K++)for(let h=0;h<e.board[K].length;h++){const v=(re=e.board[K][h])==null?void 0:re.card;if(v!=null&&v.statuses){const z=v.statuses.filter(ue=>ue.type==="Exploit"&&ue.addedByPlayerId===ae);L+=z.length}}L>0?(Z(ae,L),De([{row:C.row,col:C.col,text:`+${L}`,playerId:ae}])):De([{row:C.row,col:C.col,text:"+0",playerId:ae}]),k(C,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}if(f.type==="GLOBAL_AUTO_APPLY"){if(((D=f.payload)==null?void 0:D.customAction)==="FINN_SCORING"){let ae=0;const L=(Ke=f.sourceCard)==null?void 0:Ke.ownerId;if(L===void 0){console.warn("[FINN_SCORING] Source card missing ownerId, skipping scoring"),k(f.sourceCoords||C,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}if(e.players.forEach(K=>{K.id!==L&&K.hand.forEach(h=>{var v;(v=h.statuses)!=null&&v.some(z=>z.type==="Revealed"&&z.addedByPlayerId===L)&&ae++})}),e.board.forEach(K=>{K.forEach(h=>{var z;const v=h.card;if(v&&v.ownerId!==L){const ue=((z=v.statuses)==null?void 0:z.filter(Re=>Re.type==="Revealed"&&Re.addedByPlayerId===L).length)||0;ae+=ue}})}),ae>0){const K=f.sourceCoords||C;De({row:K.row,col:K.col,text:`+${ae}`,playerId:L}),Z(L,ae)}k(f.sourceCoords||C,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}if(((B=f.payload)==null?void 0:B.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){f.sourceCoords&&f.sourceCoords.row>=0?Be(f.sourceCoords,"Aim"):_.lastMovedCardCoords?Be(_.lastMovedCardCoords,"Aim"):C&&C.row>=0&&Be(C,"Aim");return}if(f.payload&&!f.payload.cleanupCommand){const{tokenType:ae,filter:L}=f.payload,K=[],h=e.board.length;if(f.payload.contextReward&&f.sourceCard){let v=0;const z=C&&C.row>=0?C:_.lastMovedCardCoords;if(z){const{row:ue,col:Re}=z;let fe=e.board[ue][Re].card;const ce=f.payload._tempContextId||_.lastMovedCardId;if((!fe||ce&&fe.id!==ce)&&ce)for(let ye=0;ye<h;ye++){for(let ge=0;ge<h;ge++)if(((q=e.board[ye][ge].card)==null?void 0:q.id)===ce){fe=e.board[ye][ge].card;break}if(fe)break}fe&&(v=Math.max(0,fe.power+(fe.powerModifier||0)+(fe.bonusPower||0)))}if(v>0){const ue=f.sourceCard.ownerId;if(ue===void 0){console.error("Cannot apply reward: sourceCard has no ownerId");return}const Re=f.payload.contextReward;Re==="DRAW_MOVED_POWER"||Re==="DRAW_EQUAL_POWER"?se(ue,v):Re==="SCORE_MOVED_POWER"&&(De({row:C.row,col:C.col,text:`+${v}`,playerId:ue}),Z(ue,v))}if(f.payload.contextReward==="STUN_MOVED_UNIT"&&z){const ue=f.sourceCard.ownerId;ue!==void 0?X(z,"Stun",ue):console.error("Cannot apply stun: sourceCard has no ownerId")}return}if(L)for(let v=0;v<h;v++)for(let z=0;z<h;z++){const ue=e.board[v][z].card;ue&&L(ue)&&K.push({row:v,col:z})}else f.sourceCoords&&f.sourceCoords.row>=0?K.push(f.sourceCoords):C&&C.row>=0?K.push(C):_.lastMovedCardCoords&&K.push(_.lastMovedCardCoords);if(K.length>0){if(ae){const v=f.payload.count||1,z=f.payload.ownerId!==void 0?f.payload.ownerId:((Qe=f.sourceCard)==null?void 0:Qe.ownerId)??r;for(let ue=0;ue<v;ue++)ne(C,K,ae,z,!!f.isDeployAbility)}}else I(C),k(C,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}}if(!lr(f,e,((_t=f.sourceCard)==null?void 0:_t.ownerId)||r,_)){I(C),f.chainedAction&&setTimeout(()=>{st(f.chainedAction,C)},500);return}if(f.type==="CREATE_STACK"&&f.tokenType){let ae=f.count||0;if(f.dynamicCount){const{factor:L,ownerId:K}=f.dynamicCount;let h=0;e.board.forEach(v=>v.forEach(z=>{var ue;if((ue=z.card)!=null&&ue.statuses){const Re=z.card.statuses.filter(fe=>fe.type===L&&fe.addedByPlayerId===K);h+=Re.length}})),ae=h}ae>0?(o(null),E({type:f.tokenType,count:ae,isDragging:!1,sourceCoords:C,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,excludeOwnerId:f.excludeOwnerId,onlyOpponents:f.onlyOpponents,onlyFaceDown:f.onlyFaceDown,targetType:f.targetType,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove,requiredTargetStatus:f.requiredTargetStatus,requireStatusFromSourceOwner:f.requireStatusFromSourceOwner,mustBeAdjacentToSource:f.mustBeAdjacentToSource,mustBeInLineWithSource:f.mustBeInLineWithSource,maxDistanceFromSource:f.maxDistanceFromSource,maxOrthogonalDistance:f.maxOrthogonalDistance,placeAllAtOnce:f.placeAllAtOnce,chainedAction:f.chainedAction,...f.targetOwnerId!==void 0&&{targetOwnerId:f.targetOwnerId},recordContext:f.recordContext,replaceStatus:f.replaceStatus})):I(C)}else if(f.type==="ENTER_MODE"){if(f.mode==="SHIELD_SELF_THEN_SPAWN"){X(C,"Shield",f.sourceCard.ownerId),o({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility,payload:f.payload});return}if(f.mode==="SHIELD_SELF_THEN_RIOT_PUSH"){const h=f.sourceCard.ownerId;X(C,"Shield",h);const v=e.board.length,z=Math.floor((v-e.activeGridSize)/2),ue=z,Re=z+e.activeGridSize-1;let fe=!1;const{row:ce,col:ye}=C,ge=[[-1,0],[1,0],[0,-1],[0,1]];for(const[le,Le]of ge){const Me=ce+le,Ae=ye+Le;if(Me<ue||Me>Re||Ae<ue||Ae>Re)continue;const yt=e.board[Me][Ae];if(!yt.card)continue;const Dt=e.players.find(Ot=>Ot.id===yt.card.ownerId),ht=e.players.find(Ot=>Ot.id===h),Pt=(Dt==null?void 0:Dt.teamId)!==void 0&&(ht==null?void 0:ht.teamId)!==void 0&&Dt.teamId===ht.teamId;if(yt.card.ownerId===h||Pt)continue;const bt=Me+le,Ct=Ae+Le;if(bt<ue||bt>Re||Ct<ue||Ct>Re)continue;if(e.board[bt][Ct].card===null){fe=!0;break}}fe?o({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility,payload:f.payload}):I(C);return}if(f.mode==="PRINCEPS_SHIELD_THEN_AIM"){const h=f.sourceCard.ownerId;X(C,"Shield",h);const v={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility};lr(v,e,h,_)?E({type:"Aim",count:1,isDragging:!1,sourceCoords:C,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove}):I(C);return}if(f.mode==="GAWAIN_DEPLOY_SHIELD_AIM"){const h=f.sourceCard.ownerId;X(C,"Shield",h);const v={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility};lr(v,e,h,_)?E({type:"Aim",count:1,isDragging:!1,sourceCoords:C,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove}):I(C);return}if(f.mode==="ABR_DEPLOY_SHIELD_AIM"){const h=f.sourceCard.ownerId;X(C,"Shield",h);const v={type:"CREATE_STACK",tokenType:"Aim",requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility};lr(v,e,h,_)?E({type:"Aim",count:1,isDragging:!1,sourceCoords:C,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,targetOwnerId:h,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove}):I(C);return}if(f.mode==="RIOT_PUSH"&&f.sourceCoords){const h=e.board.length,v=Math.floor((h-e.activeGridSize)/2),z=v,ue=v+e.activeGridSize-1;let Re=!1;const{row:fe,col:ce}=f.sourceCoords,ye=(wt=f.sourceCard)==null?void 0:wt.ownerId,ge=[[-1,0],[1,0],[0,-1],[0,1]];for(const[le,Le]of ge){const Me=fe+le,Ae=ce+Le;if(Me<z||Me>ue||Ae<z||Ae>ue)continue;const yt=e.board[Me][Ae];if(!yt.card||ye===void 0)continue;const Dt=e.players.find(Ot=>Ot.id===yt.card.ownerId),ht=e.players.find(Ot=>Ot.id===ye),Pt=(Dt==null?void 0:Dt.teamId)!==void 0&&(ht==null?void 0:ht.teamId)!==void 0&&Dt.teamId===ht.teamId;if(yt.card.ownerId===ye||Pt)continue;const bt=Me+le,Ct=Ae+Le;if(bt<z||bt>ue||Ct<z||Ct>ue)continue;if(e.board[bt][Ct].card===null){Re=!0;break}}if(!Re){I(f.sourceCoords);return}}if(f.mode==="SELECT_TARGET"&&((je=f.payload)==null?void 0:je.actionType)==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"&&f.sourceCard){const h=f.sourceCard.ownerId,v=e.players.find(z=>z.id===h);if(v&&v.hand.length<1){I(f.sourceCoords||C);return}}if(f.mode==="SELECT_TARGET"&&((Ye=f.payload)==null?void 0:Ye.actionType)==="LUCIUS_SETUP"&&f.sourceCard){const h=f.sourceCard.ownerId,v=e.players.find(z=>z.id===h);if(v&&v.hand.length<1){I(f.sourceCoords||C);return}}let ae=f.sourceCard,L=C;if(f.sourceCoords&&f.sourceCoords.row>=0&&(L=f.sourceCoords),f.mode==="SELECT_CELL"&&_.lastMovedCardCoords&&_.lastMovedCardId&&((it=f.payload)!=null&&it.useContextCard)){const{row:h,col:v}=_.lastMovedCardCoords,z=e.board[h][v].card;z&&(ae=z,L=_.lastMovedCardCoords)}o({...f,sourceCard:ae,sourceCoords:L});const K=((rt=f.sourceCard)==null?void 0:rt.ownerId)??e.activePlayerId??r??1;ze(f,K,L,void 0,_)}else if(f.type==="OPEN_MODAL")if(f.mode==="RETRIEVE_DEVICE"){const ae=e.players.find(L=>{var K;return L.id===((K=f.sourceCard)==null?void 0:K.ownerId)});ae&&(g({player:ae,pickConfig:{filterType:"Device",action:"recover"}}),C.row>=0&&k(C,!!f.isDeployAbility,!1,f.readyStatusToRemove))}else if(f.mode==="IMMUNIS_RETRIEVE"){const ae=e.players.find(L=>{var K;return L.id===((K=f.sourceCard)==null?void 0:K.ownerId)});ae&&(g({player:ae,pickConfig:{filterType:"Optimates",action:"resurrect"}}),o({type:"ENTER_MODE",mode:"IMMUNIS_RETRIEVE",sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility,payload:f.payload}))}else if(f.mode==="SEARCH_DECK"){const ae=e.players.find(L=>{var K;return L.id===((K=f.sourceCard)==null?void 0:K.ownerId)});ae&&(g({player:ae,pickConfig:{filterType:f.payload.filterType||"Unit",action:"recover",isDeck:!0}}),C.row>=0&&k(C,!!f.isDeployAbility,!1,f.readyStatusToRemove))}else f.mode==="ZIUS_LINE_SELECT"?_.lastMovedCardCoords?o({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:f.sourceCard,sourceCoords:_.lastMovedCardCoords,isDeployAbility:f.isDeployAbility,payload:f.payload,chainedAction:f.chainedAction}):o({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility,payload:f.payload,chainedAction:f.chainedAction}):f.mode==="SELECT_DECK"?o({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility,payload:f.payload}):f.mode==="ZIUS_EXPLOIT_AND_SCORE"?o({type:"ENTER_MODE",mode:"ZIUS_EXPLOIT_AND_SCORE",sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility,payload:f.payload}):f.mode==="REVEREND_DOUBLE_EXPLOIT"&&o({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:f.sourceCard,sourceCoords:C,isDeployAbility:f.isDeployAbility,payload:f.payload})},[e,r,_,k,o,E,I,ne,g,X,Z,$,Be,ie,De,ze]);O.useEffect(()=>{(n==null?void 0:n.type)==="GLOBAL_AUTO_APPLY"&&(st(n,n.sourceCoords||{row:-1,col:-1}),o(null))},[n,st,o]),O.useEffect(()=>{n||pe()},[n,pe]);const Tt=O.useCallback((f,C)=>{if(n||l||!e.isGameStarted||r===null)return;const Q=e.players.find(D=>D.id===f.ownerId),Ie=r===f.ownerId||(Q==null?void 0:Q.isDummy)&&r===1;if(e.activePlayerId!==f.ownerId||!Ie||!Rn(f,e)||!Pr(f,e.currentPhase,e.activePlayerId,e))return;const re=bn(f,e,f.ownerId,C);if(re){re.readyStatusToRemove&&k(C,!!re.isDeployAbility,!1,re.readyStatusToRemove);const D={...re,chainedAction:re.chainedAction?{...re.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};st(D,C)}},[n,l,e,r,st,k]),gt=O.useCallback(f=>{var B,q,Qe,_t,wt;if(!n)return;const{mode:C,sourceCard:Q,sourceCoords:Ie,payload:re,isDeployAbility:D,readyStatusToRemove:Ke}=n;if(C==="SCORE_LAST_PLAYED_LINE"&&n.sourceCoords){if(P.current)return;const{row:je,col:Ye}=n.sourceCoords,{row:it,col:rt}=f;if(je!==it&&Ye!==rt)return;P.current=!0;const ae=e.activePlayerId,L=e.board.length;let K=je,h=je,v=Ye,z=Ye;if(je===it)K=je,h=je,v=0,z=L-1;else if(Ye===rt)v=rt,z=rt,K=0,h=L-1;else{P.current=!1;return}const ue=e.board.some(ce=>ce.some(ye=>{var ge,le;return((ge=ye.card)==null?void 0:ge.ownerId)===ae&&ye.card.name.toLowerCase().includes("data liberator")&&((le=ye.card.statuses)==null?void 0:le.some(Le=>Le.type==="Support"))}));let Re=0;const fe=[];for(let ce=K;ce<=h;ce++)for(let ye=v;ye<=z;ye++){const le=e.board[ce][ye].card;if(le&&!((B=le.statuses)!=null&&B.some(Le=>Le.type==="Stun"))){const Le=le.ownerId===ae,Me=(q=le.statuses)==null?void 0:q.some(Ae=>Ae.type==="Exploit"&&Ae.addedByPlayerId===ae);if(Le||ue&&Me&&le.ownerId!==ae){const Ae=Math.max(0,le.power+(le.powerModifier||0)+(le.bonusPower||0));Ae>0&&(Re+=Ae,fe.push({row:ce,col:ye,text:`+${Ae}`,playerId:ae}))}}}o(null),fe.length>0&&De(fe),Re>0&&Z(ae,Re),G(),setTimeout(()=>{P.current=!1},200);return}if(C==="SELECT_LINE_START"){o({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:Q,sourceCoords:Ie,isDeployAbility:D,payload:{...re,firstCoords:f}});return}if(C==="SELECT_LINE_END"&&(re!=null&&re.firstCoords)){const{row:je,col:Ye}=re.firstCoords,{row:it,col:rt}=f;if(je!==it&&Ye!==rt)return;const ae=re.actionType,L=(Q==null?void 0:Q.ownerId)??((Qe=e.players.find(K=>K.id===e.activePlayerId))!=null&&Qe.isDummy?e.activePlayerId:r||e.activePlayerId);if(ae==="ZIUS_SCORING"){const K=_.lastMovedCardCoords;if(K){const ce=je===it&&K.row===je,ye=Ye===rt&&K.col===Ye;if(!ce&&!ye)return}const h=e.board.length;let v=0,z=h-1,ue=0,Re=h-1;if(je===it)v=z=je;else if(Ye===rt)ue=Re=Ye;else return;let fe=0;for(let ce=v;ce<=z;ce++)for(let ye=ue;ye<=Re;ye++){const ge=e.board[ce][ye];ge.card&&(fe+=((_t=ge.card.statuses)==null?void 0:_t.filter(le=>le.type==="Exploit"&&le.addedByPlayerId===L).length)||0)}fe>0&&L&&(Ie&&De({row:Ie.row,col:Ie.col,text:`+${fe}`,playerId:L}),Z(L,fe)),Ie&&Ie.row>=0&&k(Ie,D,!1,Ke)}else if(ae==="CENTURION_BUFF"&&Q&&Ie&&L){const K=e.board.length;let h=0,v=K-1,z=0,ue=K-1;je===it?h=v=je:z=ue=Ye;for(let Re=h;Re<=v;Re++)for(let fe=z;fe<=ue;fe++){const ce=e.board[Re][fe].card;if(ce){const ye=ce.id===Q.id,ge=ce.ownerId===L,le=e.players.find(Ae=>Ae.id===L),Le=e.players.find(Ae=>Ae.id===ce.ownerId),Me=(le==null?void 0:le.teamId)!==void 0&&(Le==null?void 0:Le.teamId)!==void 0&&le.teamId===Le.teamId;!ye&&(ge||Me)&&V({row:Re,col:fe},1)}}k(Ie,D,!1,Ke)}else(ae==="SCORE_LINE"||!ae)&&(Ee(je,Ye,it,rt,L),re.skipNextPhase||G());setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY)}if(C==="SELECT_DIAGONAL"&&re.actionType==="SCORE_DIAGONAL"){const je=(Q==null?void 0:Q.ownerId)??((wt=e.players.find(Ye=>Ye.id===e.activePlayerId))!=null&&wt.isDummy?e.activePlayerId:r||e.activePlayerId);if(re.firstCoords){const{row:Ye,col:it}=re.firstCoords,{row:rt,col:ae}=f;if(Math.abs(Ye-rt)!==Math.abs(it-ae)){o(null);return}me(Ye,it,rt,ae,je,re.bonusType),re.skipNextPhase||G(),o(null);return}else{o({...n,payload:{...re,firstCoords:f}});return}}},[n,e,r,Ee,G,o,V,k,me,Z,De,_,b]),tt=O.useCallback((f,C)=>{var Q,Ie,re,D,Ke,B,q,Qe,_t,wt,je,Ye,it,rt;if(l&&x!==null&&x!==void 0){const ae={targetOwnerId:l.targetOwnerId,excludeOwnerId:l.excludeOwnerId,onlyOpponents:l.onlyOpponents||l.targetOwnerId===-1,onlyFaceDown:l.onlyFaceDown,targetType:l.targetType,requiredTargetStatus:l.requiredTargetStatus,tokenType:l.type};Lt({card:f,ownerId:f.ownerId??0,location:"board"},ae,e.activePlayerId,e.players)&&l.type==="Aim"&&(S({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Aim",count:1},{target:"board",boardCoords:C}),l.sourceCoords&&l.sourceCoords.row>=0&&k(l.sourceCoords,l.isDeployAbility,!1,l.readyStatusToRemove),l.count>1?E(K=>K?{...K,count:K.count-1}:null):(l.chainedAction&&st(l.chainedAction,l.sourceCoords||{row:-1,col:-1}),E(null)));return}if(!P.current){if(n&&(n.mode==="SCORE_LAST_PLAYED_LINE"||n.mode==="SELECT_LINE_END")){gt(C);return}if((n==null?void 0:n.type)==="ENTER_MODE"){if(n.sourceCard&&n.sourceCard.id===f.id&&n.mode!=="SELECT_LINE_START"&&n.mode!=="INTEGRATOR_LINE_SELECT"&&n.mode!=="ZIUS_LINE_SELECT"&&n.mode!=="IP_AGENT_THREAT_SCORING"&&n.mode!=="SELECT_UNIT_FOR_MOVE"&&n.mode!=="SELECT_TARGET"&&n.mode!=="RIOT_PUSH"&&n.mode!=="RIOT_MOVE"&&n.mode!=="REVEREND_DOUBLE_EXPLOIT")return;const{mode:ae,payload:L,sourceCard:K,sourceCoords:h,isDeployAbility:v,readyStatusToRemove:z,originalOwnerId:ue,recordContext:Re}=n;if(ae==="SELECT_LINE_START"||ae==="SELECT_LINE_END"){gt(C);return}const fe=(K==null?void 0:K.ownerId)??((Q=e.players.find(ce=>ce.id===e.activePlayerId))!=null&&Q.isDummy?e.activePlayerId:r||e.activePlayerId);if(ae==="SELECT_TARGET"&&L.tokenType){if(L.filter&&!L.filter(f,C.row,C.col))return;if(S({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:L.tokenType,count:L.count||1},{target:"board",boardCoords:C}),A("board",C),Re&&m({lastMovedCardCoords:C,lastMovedCardId:f.id}),L.chainedAction){const ce={...L.chainedAction,sourceCard:L.chainedAction.sourceCard??f,sourceCoords:L.chainedAction.sourceCoords??C,isDeployAbility:v,recordContext:!0};st(ce,C),setTimeout(()=>A("board",C),100),ce.type!=="ENTER_MODE"&&o(null)}else h&&h.row>=0&&k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="SELECT_TARGET"&&L.actionType==="OPEN_COUNTER_MODAL"){if(L.filter&&!L.filter(f))return;Y({card:f,callbackAction:L.rewardType}),o(null);return}if(ae==="SELECT_TARGET"&&L.actionType==="SACRIFICE_AND_BUFF_LINES"){if(L.filter&&!L.filter(f,C.row,C.col))return;S({card:f,source:"board",boardCoords:C,bypassOwnershipCheck:!0},{target:"discard",playerId:f.ownerId});const ce=e.board.length,{row:ye,col:ge}=C;for(let le=0;le<ce;le++){if(le===ge)continue;const Me=e.board[ye][le].card;Me&&(Me.ownerId===fe||((Ie=e.players.find(Ae=>Ae.id===fe))==null?void 0:Ie.teamId)!==void 0&&((re=e.players.find(Ae=>Ae.id===Me.ownerId))==null?void 0:re.teamId)===((D=e.players.find(Ae=>Ae.id===fe))==null?void 0:D.teamId))&&V({row:ye,col:le},1)}for(let le=0;le<ce;le++){if(le===ye)continue;const Me=e.board[le][ge].card;Me&&(Me.ownerId===fe||((Ke=e.players.find(Ae=>Ae.id===fe))==null?void 0:Ke.teamId)!==void 0&&((B=e.players.find(Ae=>Ae.id===Me.ownerId))==null?void 0:B.teamId)===((q=e.players.find(Ae=>Ae.id===fe))==null?void 0:q.teamId))&&V({row:le,col:ge},1)}h&&h.row>=0&&k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="REVEREND_DOUBLE_EXPLOIT"){if(!fe)return;const ce=fe,ye=(f.statuses||[]).filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===ce).length;for(let ge=0;ge<ye;ge++)S({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Exploit",count:1},{target:"board",boardCoords:C});h&&h.row>=0&&k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="SELECT_TARGET"&&L.actionType==="DESTROY"){if(L.handOnly||L.filter&&!L.filter(f,C.row,C.col))return;if(((Qe=f.statuses)==null?void 0:Qe.some(ye=>ye.type==="Shield"))?oe(C,"Shield"):S({card:f,source:"board",boardCoords:C,bypassOwnershipCheck:!0},{target:"discard",playerId:f.ownerId}),L.chainedAction){const ye={...L.chainedAction,sourceCard:K,sourceCoords:h,isDeployAbility:v};st(ye,h),ye.type!=="ENTER_MODE"&&o(null)}else h&&h.row>=0&&k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="SELECT_TARGET"&&L.actionType==="DRAW_EQUAL_POWER"){if(L.filter&&!L.filter(f))return;const ce=Math.max(0,f.power+(f.powerModifier||0));for(let ye=0;ye<ce;ye++)$(fe);setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="SELECT_TARGET"&&L.actionType==="SCORE_EQUAL_POWER"){if(L.filter&&!L.filter(f))return;const ce=Math.max(0,f.power+(f.powerModifier||0));h&&De({row:h.row,col:h.col,text:`+${ce}`,playerId:fe}),Z(fe,ce),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="SELECT_TARGET"&&L.actionType==="RESET_DEPLOY"){if(L.filter&&!L.filter(f))return;be(C),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="SELECT_TARGET"&&L.actionType==="SHIELD_AND_REMOVE_AIM"){if(L.filter&&!L.filter(f))return;X(C,"Shield",fe),Be(C,"Aim"),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="SELECT_TARGET"&&L.actionType==="MODIFY_POWER"){if(L.filter&&!L.filter(f))return;L.amount&&V(C,L.amount),h&&h.row>=0&&k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="RIOT_PUSH"&&h&&h.row>=0){if(C.row===h.row&&C.col===h.col){k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}const ce=Math.abs(C.row-h.row)+Math.abs(C.col-h.col)===1,ye=e.players.find(Ct=>Ct.id===f.ownerId),ge=e.players.find(Ct=>Ct.id===fe),le=(ye==null?void 0:ye.teamId)!==void 0&&(ge==null?void 0:ge.teamId)!==void 0&&ye.teamId===ge.teamId;if(!ce||f.ownerId===fe||le)return;const Le=C.row-h.row,Me=C.col-h.col,Ae=C.row+Le,yt=C.col+Me,Dt=e.board.length,ht=Math.floor((Dt-e.activeGridSize)/2),Pt=ht,bt=ht+e.activeGridSize-1;if(Ae<Pt||Ae>bt||yt<Pt||yt>bt||e.board[Ae][yt].card!==null)return;S({card:f,source:"board",boardCoords:C,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:Ae,col:yt}}),o({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:K,sourceCoords:h,isDeployAbility:v,payload:{vacatedCoords:C}});return}if(ae==="SWAP_POSITIONS"&&h&&h.row>=0){const ce=e.board[h.row][h.col].card;if(!ce||ce.id!==(K==null?void 0:K.id)){o(null);return}if(K&&K.id===f.id||L.filter&&!L.filter(f,C.row,C.col))return;J(h,C),k(C,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="TRANSFER_STATUS_SELECT"&&h&&h.row>=0){if(K&&K.id===f.id||L.filter&&!L.filter(f,C.row,C.col))return;f.statuses&&f.statuses.length>0&&(Te(C,h,f.statuses[0].type),k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY));return}if(ae==="TRANSFER_ALL_STATUSES"&&h&&h.row>=0){if(K&&K.id===f.id||L.filter&&!L.filter(f,C.row,C.col))return;Oe(C,h),k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="REVEAL_ENEMY"){if(K&&K.id===f.id||L.filter&&!L.filter(f,C.row,C.col))return;E({type:"Revealed",count:1,isDragging:!1,sourceCoords:h,sourceCard:K,originalOwnerId:ue,targetOwnerId:f.ownerId,onlyFaceDown:!0,onlyOpponents:!0,isDeployAbility:v,readyStatusToRemove:z}),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="CENSOR_SWAP"&&h&&h.row>=0){if(L.filter&&!L.filter(f))return;j(C,"Exploit",fe),X(C,"Stun",fe),k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="ZEALOUS_WEAKEN"&&h&&h.row>=0){if(L.filter&&!L.filter(f))return;V(C,-1),k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="CENTURION_BUFF"&&h&&h.row>=0){k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="SELECT_UNIT_FOR_MOVE"&&h&&h.row>=0){if(L.filter&&!L.filter(f))return;o({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:f,sourceCoords:C,isDeployAbility:v,recordContext:Re,originalOwnerId:fe??void 0,payload:{allowSelf:!1,abilitySourceCoords:h,range:L.range,chainedAction:L.chainedAction,originalActorId:fe??void 0}});return}if(ae==="SELECT_UNIT_FOR_MOVE"&&!h){if(L.filter&&!L.filter(f))return;o({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:f,sourceCoords:C,recordContext:Re,originalOwnerId:fe??void 0,payload:{allowSelf:!1,range:L.range,chainedAction:L.chainedAction,originalActorId:fe??void 0}});return}if(ae==="INTEGRATOR_LINE_SELECT"&&h&&h.row>=0){if(C.row!==h.row&&C.col!==h.col)return;const ce=e.board.length;let ye=0;if(C.row===h.row)for(let ge=0;ge<ce;ge++){const le=e.board[C.row][ge];le.card&&(ye+=((_t=le.card.statuses)==null?void 0:_t.filter(Le=>Le.type==="Exploit"&&Le.addedByPlayerId===fe).length)||0)}else for(let ge=0;ge<ce;ge++){const le=e.board[ge][C.col];le.card&&(ye+=((wt=le.card.statuses)==null?void 0:wt.filter(Le=>Le.type==="Exploit"&&Le.addedByPlayerId===fe).length)||0)}ye>0&&(De({row:h.row,col:h.col,text:`+${ye}`,playerId:fe}),Z(fe,ye)),k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="IP_AGENT_THREAT_SCORING"&&h&&h.row>=0){if(C.row!==h.row&&C.col!==h.col)return;const ce=e.board.length;let ye=0;if(C.row===h.row)for(let le=0;le<ce;le++){const Le=e.board[C.row][le];Le.card&&(ye+=((je=Le.card.statuses)==null?void 0:je.filter(Me=>Me.type==="Threat"&&Me.addedByPlayerId===fe).length)||0)}else for(let le=0;le<ce;le++){const Le=e.board[le][C.col];Le.card&&(ye+=((Ye=Le.card.statuses)==null?void 0:Ye.filter(Me=>Me.type==="Threat"&&Me.addedByPlayerId===fe).length)||0)}const ge=ye*2;ge>0&&(De({row:h.row,col:h.col,text:`+${ge}`,playerId:fe}),Z(fe,ge)),k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(ae==="ZIUS_LINE_SELECT"&&h&&h.row>=0){if(C.row!==h.row&&C.col!==h.col)return;const ce=e.board.length;let ye=0;const ge=[];if(C.row===h.row)for(let le=0;le<ce;le++){const Le=e.board[C.row][le];if(Le.card){const Me=((it=Le.card.statuses)==null?void 0:it.filter(Ae=>Ae.type==="Exploit"&&Ae.addedByPlayerId===fe).length)||0;Me>0&&(ye+=Me,ge.push({row:C.row,col:le,text:`+${Me}`,playerId:fe,timestamp:Date.now()}))}}else for(let le=0;le<ce;le++){const Le=e.board[le][C.col];if(Le.card){const Me=((rt=Le.card.statuses)==null?void 0:rt.filter(Ae=>Ae.type==="Exploit"&&Ae.addedByPlayerId===fe).length)||0;Me>0&&(ye+=Me,ge.push({row:le,col:C.col,text:`+${Me}`,playerId:fe,timestamp:Date.now()}))}}ye>0&&(De(ge),Z(fe,ye)),k(h,v,!1,z),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}return}!n&&!l&&Tt(f,C)}},[n,l,e,r,P,gt,S,k,o,E,x,oe,j,X,V,J,Te,Oe,Z,$,Tt,Y,be,Be,st,m,De,A,Lt]),Ze=O.useCallback(f=>{var Qe,_t,wt,je,Ye,it,rt,ae;if(P.current||(n==null?void 0:n.type)!=="ENTER_MODE")return;const{mode:C,sourceCoords:Q,sourceCard:Ie,payload:re,isDeployAbility:D,readyStatusToRemove:Ke,recordContext:B}=n;if(C==="SCORE_LAST_PLAYED_LINE"||C==="SELECT_LINE_END"){gt(f);return}if(C==="SELECT_LINE_START"){gt(f);return}if(C==="SELECT_DIAGONAL"){gt(f);return}const q=(Ie==null?void 0:Ie.ownerId)??((Qe=e.players.find(L=>L.id===e.activePlayerId))!=null&&Qe.isDummy?e.activePlayerId:r||e.activePlayerId);if(C==="PATROL_MOVE"&&Q&&Ie&&Q.row>=0){const L=f.row===Q.row,K=f.col===Q.col;if(f.row===Q.row&&f.col===Q.col){k(Q,D,!1,Ke),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}(L||K)&&(k(Q,D,!1,Ke),S({card:Ie,source:"board",boardCoords:Q},{target:"board",boardCoords:f}),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY));return}if(C==="RIOT_MOVE"&&Q&&Ie&&re.vacatedCoords){if(f.row===re.vacatedCoords.row&&f.col===re.vacatedCoords.col){S({card:Ie,source:"board",boardCoords:Q},{target:"board",boardCoords:f}),k(f,D,!1,Ke),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}k(Q,D,!1,Ke),o(null);return}if(C==="SPAWN_TOKEN"&&Q&&re.tokenName&&Q.row>=0){if(Math.abs(f.row-Q.row)+Math.abs(f.col-Q.col)===1){const K=(Ie==null?void 0:Ie.ownerId)??q;we(f,re.tokenName,K),k(Q,D,!1,Ke),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY)}return}if(C==="SELECT_CELL"&&Ie){const L=(()=>{var h;if(re.moveFromHand)return null;if(Q&&Q.row>=0)return Q;for(let v=0;v<e.board.length;v++)for(let z=0;z<e.board.length;z++)if(((h=e.board[v][z].card)==null?void 0:h.id)===Ie.id)return{row:v,col:z};return null})();if(re.moveFromHand&&_.selectedHandCard){const{playerId:h,cardIndex:v}=_.selectedHandCard,z=e.players.find(Re=>Re.id===h),ue=z==null?void 0:z.hand[v];ue&&(S({card:ue,source:"hand",playerId:h,cardIndex:v,isManual:!0},{target:"board",boardCoords:f}),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY));return}let K=!1;if(L)if(re.range==="line")K=f.row===L.row||f.col===L.col;else if(re.range==="global")K=!0;else if(re.range===2){const h=Math.abs(f.row-L.row)+Math.abs(f.col-L.col);if(h===1)K=!0;else if(h===2){const v=L.row,z=L.col,ue=f.row,Re=f.col;K=[{r:ue,c:z},{r:v,c:Re},{r:(v+ue)/2,c:(z+Re)/2}].some(ce=>{if(!Number.isInteger(ce.r)||!Number.isInteger(ce.c))return!1;const ye=Math.floor((e.board.length-e.activeGridSize)/2),ge=ye,le=ye+e.activeGridSize-1;return ce.r<ge||ce.r>le||ce.c<ge||ce.c>le||Math.abs(ce.r-v)+Math.abs(ce.c-z)!==1?!1:!e.board[ce.r][ce.c].card})}}else K=Math.abs(f.row-L.row)+Math.abs(f.col-L.col)===1;if(K&&L){const h=re.allowSelf&&f.row===L.row&&f.col===L.col;if(!h){const v=e.board[L.row][L.col].card;v&&S({card:v,source:"board",boardCoords:L,bypassOwnershipCheck:!0},{target:"board",boardCoords:f})}if(B&&m({lastMovedCardCoords:f,lastMovedCardId:Ie.id}),re.chainedAction){const v={...re.chainedAction};v.targetOwnerId===-2&&(v.targetOwnerId=Ie.ownerId),B&&(v.payload||(v.payload={}),v.payload._tempContextId=Ie.id),o(null),Xe(),setTimeout(()=>{st(v,f)},1)}else{if(re.abilitySourceCoords)k(re.abilitySourceCoords,D,!1,Ke);else{const v=h?Q:f;v&&v.row>=0&&(re.originalActorId===void 0||Ie.ownerId===re.originalActorId)&&k(v,D,!1,Ke)}setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY)}return}return}if(C==="IMMUNIS_RETRIEVE"&&Q&&Q.row>=0){if(re.selectedCardIndex!==void 0&&((_t=re.filter)!=null&&_t.call(re,f.row,f.col))){Se(q,re.selectedCardIndex,f),k(Q,D,!1,Ke),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(re.selectedCardIndex===void 0)return}if(C==="INTEGRATOR_LINE_SELECT"&&Q&&Q.row>=0){if(f.row!==Q.row&&f.col!==Q.col)return;const L=e.board.length;let K=0;if(f.row===Q.row)for(let h=0;h<L;h++){const v=e.board[f.row][h];v.card&&(K+=((wt=v.card.statuses)==null?void 0:wt.filter(z=>z.type==="Exploit"&&z.addedByPlayerId===q).length)||0)}else for(let h=0;h<L;h++){const v=e.board[h][f.col];v.card&&(K+=((je=v.card.statuses)==null?void 0:je.filter(z=>z.type==="Exploit"&&z.addedByPlayerId===q).length)||0)}K>0&&(De({row:Q.row,col:Q.col,text:`+${K}`,playerId:q}),Z(q,K)),k(Q,D,!1,Ke),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(C==="ZIUS_LINE_SELECT"&&Q&&Q.row>=0){if(f.row!==Q.row&&f.col!==Q.col)return;const L=e.board.length;let K=0;const h=[];if(f.row===Q.row)for(let v=0;v<L;v++){const z=e.board[f.row][v];if(z.card){const ue=((Ye=z.card.statuses)==null?void 0:Ye.filter(Re=>Re.type==="Exploit"&&Re.addedByPlayerId===q).length)||0;ue>0&&(K+=ue,h.push({row:f.row,col:v,text:`+${ue}`,playerId:q,timestamp:Date.now()}))}}else for(let v=0;v<L;v++){const z=e.board[v][f.col];if(z.card){const ue=((it=z.card.statuses)==null?void 0:it.filter(Re=>Re.type==="Exploit"&&Re.addedByPlayerId===q).length)||0;ue>0&&(K+=ue,h.push({row:v,col:f.col,text:`+${ue}`,playerId:q,timestamp:Date.now()}))}}K>0&&(De(h),Z(q,K)),k(Q,D,!1,Ke),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}if(C==="IP_AGENT_THREAT_SCORING"&&Q&&Q.row>=0){if(f.row!==Q.row&&f.col!==Q.col)return;const L=e.board.length;let K=0;if(f.row===Q.row)for(let v=0;v<L;v++){const z=e.board[f.row][v];z.card&&(K+=((rt=z.card.statuses)==null?void 0:rt.filter(ue=>ue.type==="Threat"&&ue.addedByPlayerId===q).length)||0)}else for(let v=0;v<L;v++){const z=e.board[v][f.col];z.card&&(K+=((ae=z.card.statuses)==null?void 0:ae.filter(ue=>ue.type==="Threat"&&ue.addedByPlayerId===q).length)||0)}const h=K*2;h>0&&(De({row:Q.row,col:Q.col,text:`+${h}`,playerId:q}),Z(q,h)),k(Q,D,!1,Ke),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY);return}},[P,n,e,r,gt,S,k,o,we,m,Se,Z,_,st,De,Xe]),F=O.useCallback((f,C,Q)=>{var Ie;if(!P.current){if(l&&x!==null&&x!==void 0){const re={targetOwnerId:l.targetOwnerId,excludeOwnerId:l.excludeOwnerId,onlyOpponents:l.onlyOpponents||l.targetOwnerId===-1,onlyFaceDown:l.onlyFaceDown,targetType:l.targetType,requiredTargetStatus:l.requiredTargetStatus,tokenType:l.type};if(Lt({card:C,ownerId:f.id,location:"hand"},re,e.activePlayerId,e.players)&&l.type==="Revealed"){const Ke=((Ie=l.sourceCard)==null?void 0:Ie.ownerId)??e.activePlayerId??r??1;C.statuses||(C.statuses=[]),C.statuses.some(q=>q.type==="Revealed"&&q.addedByPlayerId===Ke)||(C.statuses.push({type:"Revealed",addedByPlayerId:Ke}),S({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:f.id,cardIndex:Q}),l.sourceCoords&&l.sourceCoords.row>=0&&k(l.sourceCoords,l.isDeployAbility,!1,l.readyStatusToRemove),l.count>1?E(q=>q?{...q,count:q.count-1}:null):(l.chainedAction&&st(l.chainedAction,l.sourceCoords||{row:-1,col:-1}),E(null)))}return}if((n==null?void 0:n.type)==="ENTER_MODE"&&n.mode==="SELECT_TARGET"){const{payload:re,sourceCoords:D,isDeployAbility:Ke,sourceCard:B,readyStatusToRemove:q}=n;if(Ce(f.id,Q,e.activePlayerId??r??1),re.actionType==="SELECT_HAND_FOR_DEPLOY"){if(re.filter&&!re.filter(C))return;m(Qe=>({...Qe,selectedHandCard:{playerId:f.id,cardIndex:Q}})),o({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:C,payload:{range:"global",moveFromHand:!0}});return}if(re.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(re.filter&&!re.filter(C)||f.id!==(B==null?void 0:B.ownerId))return;S({card:C,source:"hand",playerId:f.id,cardIndex:Q,bypassOwnershipCheck:!0},{target:"discard",playerId:f.id}),o({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:B,sourceCoords:D,isDeployAbility:Ke,payload:{tokenName:re.tokenName}});return}if(re.actionType==="LUCIUS_SETUP"){if(f.id!==(B==null?void 0:B.ownerId))return;S({card:C,source:"hand",playerId:f.id,cardIndex:Q,bypassOwnershipCheck:!0},{target:"discard",playerId:f.id}),st({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:B,sourceCoords:D,isDeployAbility:Ke,payload:{filterType:"Command"}},D||{row:-1,col:-1}),o(null);return}if(re.actionType==="DESTROY"){if(re.filter&&!re.filter(C))return;S({card:C,source:"hand",playerId:f.id,cardIndex:Q,bypassOwnershipCheck:!0},{target:"discard",playerId:f.id}),D&&D.row>=0&&k(D,Ke,!1,q),setTimeout(()=>o(null),ve.MODE_CLEAR_DELAY)}}}},[P,n,S,k,o,m,st,e,r,Ce,l,E,x]),Ve=O.useCallback((f,C)=>{n||l||P.current||e.isGameStarted&&e.activePlayerId===f.id&&Pr(C,e.currentPhase,e.activePlayerId,e)&&Tt(C,{row:-1,col:-1})},[n,l,P,e,Tt]);return{activateAbility:Tt,executeAction:st,handleLineSelection:gt,handleBoardCardClick:tt,handleEmptyCellClick:Ze,handleHandCardClick:F,handleAnnouncedCardDoubleClick:Ve}},br=(e,r,n,o,l)=>{const E=(n.baseId||e.split("_")[1]||e).toLowerCase(),_=r===-1,m=[];E==="overwatch"?_?m.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:n}):r===0?m.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:l},targetOwnerId:-1,onlyOpponents:!0,sourceCard:n}):r===1&&m.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:l,baseCount:0}},sourceCard:n}):E==="tacticalmaneuver"?r===0?m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:n,payload:{range:"line",filter:I=>I.ownerId===l,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:n}}}):r===1&&m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:n,payload:{range:"line",filter:I=>I.ownerId===l,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:n}}}):E==="inspiration"?_&&m.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"OPEN_COUNTER_MODAL",filter:I=>I.ownerId===l}}):E==="datainterception"?_?m.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:n}):r===0?m.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:l},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:n}):r===1&&m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:2,filter:I=>{var A;return((A=I.statuses)==null?void 0:A.some(x=>x.type==="Exploit"&&x.addedByPlayerId===l))||!1}}}):E==="falseorders"?_?m.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:n,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):r===0?m.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:n,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:l,sourceCard:n,originalOwnerId:n.ownerId}}}):r===1&&m.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:n,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:l}}}}):E==="experimentalstimulants"?r===0?m.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"RESET_DEPLOY",filter:I=>{var A;return I.ownerId===l&&((A=I.types)==null?void 0:A.includes("Unit"))}}}):r===1&&m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:"line",filter:I=>I.ownerId===l}}):E==="logisticschain"?r===0?m.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:n,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):r===1&&m.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:n,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):E==="quickresponseteam"?r===0?m.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:I=>{var A;return I.ownerId===l&&((A=I.types)==null?void 0:A.includes("Unit"))}}}):r===1&&m.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:n,payload:{filterType:"Unit"}}):E==="temporaryshelter"?r===0?m.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:l,recordContext:!0,sourceCard:n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):r===1&&m.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:l,recordContext:!0,sourceCard:n,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):E==="enhancedinterrogation"?_?m.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:n}):r===0?m.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:l},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:n}):r===1&&m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:2,filter:I=>{var A;return((A=I.statuses)==null?void 0:A.some(x=>x.type==="Aim"&&x.addedByPlayerId===l))||!1}}}):(E==="mobilization1"||E==="linebreach")&&_&&m.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:n,payload:{actionType:"SCORE_LINE"}});const g=n.ownerId||l;return m.forEach(I=>{I.originalOwnerId=g,I.sourceCard&&!I.sourceCard.ownerId&&(I.sourceCard.ownerId=g)}),m},uo=({gameState:e,localPlayerId:r,setActionQueue:n,setCommandContext:o,setCommandModalCard:l,setCounterSelectionData:E,moveItem:_,updatePlayerScore:m,updateState:g})=>{const I=O.useCallback((Y,P)=>{if(r===null)return;const ie=e.players.find(se=>se.id===P.playerId);if(!(P.playerId===r||(ie==null?void 0:ie.isDummy)))return;_(P,{target:"announced",playerId:P.playerId}),o({});const S=(Y.baseId||Y.id.split("_")[1]||Y.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(se=>S.includes(se)))l(Y);else{const se=br(Y.id,-1,Y,e,P.playerId);se.length>0?n([...se,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:Y,ownerId:P.playerId},sourceCard:Y}]):n([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:Y,ownerId:P.playerId},sourceCard:Y}])}},[e,r,_,n,o,l]),A=O.useCallback((Y,P)=>{var Z,k;if(!P||r===null)return;const ie=P.ownerId||r,b=[],S=br(P.id,-1,P,e,ie);let $;(Z=P.baseId)!=null&&Z.toLowerCase().includes("inspiration")&&($=Y===0?"DRAW_REMOVED":"SCORE_REMOVED",S.length>0&&S[0].type==="ENTER_MODE"&&(S[0]={...S[0],payload:{...S[0].payload,rewardType:$}})),S.forEach(ne=>{b.push(ne)}),br(P.id,Y,P,e,ie).forEach(ne=>{b.push(ne)}),(k=P.baseId)!=null&&k.toLowerCase().includes("inspiration")||b.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:P,ownerId:ie},sourceCard:P}),n(b),l(null)},[e,r,n,l]),x=O.useCallback((Y,P)=>{var $;if(r===null)return;const ie=P.card.ownerId||r;let b=null;for(let se=0;se<e.board.length;se++){for(let Z=0;Z<e.board[se].length;Z++)if((($=e.board[se][Z].card)==null?void 0:$.id)===P.card.id){b={row:se,col:Z};break}if(b)break}if(!b){console.warn(`Card ${P.card.id} not found on board during counter removal`),E(null);return}if(g(se=>{if(!se.isGameStarted)return se;const Z=Ue(se),k=Z.board[b.row][b.col].card;let ne=0;const J=(k==null?void 0:k.statuses)??[];if(Object.entries(Y).forEach(([Te,Oe])=>{for(let Se=0;Se<Oe;Se++){const we=J.map(Ee=>Ee.type).lastIndexOf(Te);we>-1&&(k!=null&&k.statuses)&&(k.statuses.splice(we,1),ne++)}}),!(k!=null&&k.statuses)&&k&&(k.statuses=[]),Z.board=pt(Z),ne>0&&P.callbackAction==="DRAW_REMOVED"){const Te=Z.players.find(Oe=>Oe.id===ie);if(Te){const Oe=Math.min(ne,Te.deck.length);for(let Se=0;Se<Oe;Se++){const we=Te.deck.shift();we&&Te.hand.push(we)}}}return Z}),P.callbackAction==="SCORE_REMOVED"){const se=Object.values(Y).reduce((Z,k)=>Z+k,0);se>0&&m(ie,se)}const S=e.players.find(se=>se.id===ie);S!=null&&S.announcedCard&&n([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:S.announcedCard,ownerId:ie},sourceCard:S.announcedCard}]),E(null)},[r,m,n,E,e,g]);return{playCommandCard:I,handleCommandConfirm:A,handleCounterSelectionConfirm:x}},fo=({gameState:e,localPlayerId:r,handleDrop:n,markAbilityUsed:o,requestCardReveal:l,interactionLock:E,setCommandContext:_,onAction:m,cursorStack:g,setCursorStack:I,setAbilityMode:A,triggerTargetSelection:x})=>{const Y=O.useRef(null),P=O.useRef({x:0,y:0});return O.useLayoutEffect(()=>{if(g&&Y.current){const{x:b,y:S}=P.current;Y.current.style.transform=`translate(${b-24}px, ${S-24}px)`}},[g]),O.useEffect(()=>{const b=S=>{P.current={x:S.clientX,y:S.clientY},Y.current&&(Y.current.style.transform=`translate(${S.clientX-24}px, ${S.clientY-24}px)`)};return window.addEventListener("mousemove",b),()=>window.removeEventListener("mousemove",b)},[]),O.useEffect(()=>{const b=S=>{var k,ne,J,Te,Oe,Se,we,Ee;if(S.button!==0||!g)return;const $=document.elementFromPoint(S.clientX,S.clientY);let se=r;if(g.originalOwnerId!==void 0)se=g.originalOwnerId;else if((k=g.sourceCard)!=null&&k.ownerId)se=g.sourceCard.ownerId;else if(g.sourceCoords&&g.sourceCoords.row>=0){const{row:G,col:V}=g.sourceCoords;if(G>=0&&G<e.board.length&&V>=0&&V<((ne=e.board[G])==null?void 0:ne.length)){const X=e.board[G][V].card;X&&(se=X.ownerId||r)}}else if(e.activePlayerId){const G=e.players.find(V=>V.id===e.activePlayerId);G!=null&&G.isDummy&&(se=G.id)}let Z=$==null?void 0:$.closest("[data-hand-card]");if(!Z&&$)if($.getAttribute("data-hand-card"))Z=$;else{const G=$.querySelectorAll("[data-hand-card]");if(G.length>0){let V=1/0,X=null;const oe=S.clientX,j=S.clientY;for(const be of Array.from(G)){const me=be.getBoundingClientRect();if(oe>=me.left&&oe<=me.right&&j>=me.top&&j<=me.bottom){const Be=me.left+me.width/2,De=me.top+me.height/2,Ce=Math.hypot(oe-Be,j-De);Ce<V&&(V=Ce,X=be)}}Z=X}}if(Z){const G=Z.getAttribute("data-hand-card");if(G){const[V,X]=G.split(","),oe=parseInt(V,10),j=parseInt(X,10),be=e.players.find(Be=>Be.id===oe),me=be==null?void 0:be.hand[j];if(be&&me){if(g.type==="Revealed"&&!be.isDummy){if((J=me.statuses)==null?void 0:J.some(ze=>ze.type==="Revealed"&&ze.addedByPlayerId===se))return;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:g.originalOwnerId??((Te=g.sourceCard)==null?void 0:Te.ownerId)??se??void 0,statusType:g.type,count:1},{target:"hand",playerId:oe,cardIndex:j,boardCoords:void 0}),g.sourceCoords&&g.sourceCoords.row>=0&&o(g.sourceCoords,g.isDeployAbility),g.count>1?I(ze=>ze?{...ze,count:ze.count-1}:null):(g.chainedAction&&m(g.chainedAction,g.sourceCoords||{row:-1,col:-1}),I(null)),E.current=!0,setTimeout(()=>{E.current=!1},300);return}const De={targetOwnerId:g.targetOwnerId,excludeOwnerId:g.excludeOwnerId,onlyOpponents:g.onlyOpponents||g.targetOwnerId===-1,onlyFaceDown:g.onlyFaceDown,targetType:g.targetType,requiredTargetStatus:g.requiredTargetStatus,tokenType:g.type};if(!Lt({card:me,ownerId:oe,location:"hand"},De,se,e.players))return;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:g.originalOwnerId??((Oe=g.sourceCard)==null?void 0:Oe.ownerId),statusType:g.type,replaceStatusType:g.replaceStatus?g.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:oe,cardIndex:j,boardCoords:void 0}),g.sourceCoords&&g.sourceCoords.row>=0&&o(g.sourceCoords,g.isDeployAbility),g.count>1?I(Xe=>Xe?{...Xe,count:Xe.count-1}:null):(g.chainedAction&&m(g.chainedAction,g.sourceCoords||{row:-1,col:-1}),I(null)),E.current=!0,setTimeout(()=>{E.current=!1},300);return}}}if(!Z){const G=$==null?void 0:$.closest("[data-board-coords]");if(G){const V=G.getAttribute("data-board-coords");if(V){const[X,oe]=V.split(","),j=parseInt(X,10),be=parseInt(oe,10);if(!isNaN(j)&&!isNaN(be)&&j>=0&&j<e.board.length&&e.board[j]&&be>=0&&be<e.board[j].length&&e.board[j][be]){const me=e.board[j][be].card;if((me==null?void 0:me.ownerId)!==void 0){const Be={targetOwnerId:g.targetOwnerId,excludeOwnerId:g.excludeOwnerId,onlyOpponents:g.onlyOpponents||g.targetOwnerId===-1,onlyFaceDown:g.onlyFaceDown,targetType:g.targetType,requiredTargetStatus:g.requiredTargetStatus,mustBeAdjacentToSource:g.mustBeAdjacentToSource,mustBeInLineWithSource:g.mustBeInLineWithSource,sourceCoords:g.sourceCoords,tokenType:g.type};if(!Lt({card:me,ownerId:me.ownerId,location:"board",boardCoords:{row:j,col:be}},Be,se,e.players))return;const Ce=e.players.find(Xe=>Xe.id===me.ownerId);if(g.type==="Revealed"&&!(Ce!=null&&Ce.isDummy)){if((Se=me.statuses)==null?void 0:Se.some(ze=>ze.type==="Revealed"&&ze.addedByPlayerId===se))return;me.isFaceDown?r!==null&&l({source:"board",ownerId:me.ownerId,boardCoords:{row:j,col:be}},r):(n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:g.originalOwnerId??((we=g.sourceCard)==null?void 0:we.ownerId)??se??void 0,statusType:g.type,count:1},{target:"board",boardCoords:{row:j,col:be}}),x("board",{row:j,col:be})),g.sourceCoords&&g.sourceCoords.row>=0&&o(g.sourceCoords,g.isDeployAbility),g.count>1?I(ze=>ze?{...ze,count:ze.count-1}:null):(g.chainedAction&&m(g.chainedAction,g.sourceCoords||{row:-1,col:-1}),I(null)),E.current=!0,setTimeout(()=>{E.current=!1},300);return}}if(me){const Be=g.placeAllAtOnce?g.count:1;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:g.originalOwnerId??((Ee=g.sourceCard)==null?void 0:Ee.ownerId),statusType:g.type,replaceStatusType:g.replaceStatus?g.requiredTargetStatus:void 0,count:Be},{target:"board",boardCoords:{row:j,col:be}}),x("board",{row:j,col:be}),g.recordContext&&_(Ce=>({...Ce,lastMovedCardCoords:{row:j,col:be},lastMovedCardId:me.id})),g.sourceCoords&&g.sourceCoords.row>=0&&o(g.sourceCoords,g.isDeployAbility);const De=g.count-Be;if(De>0)I(Ce=>Ce?{...Ce,count:De}:null);else{if(g.chainedAction){const Ce={...g.chainedAction};g.recordContext&&(Ce.mode==="SELECT_CELL"&&(Ce.sourceCard=me,Ce.sourceCoords={row:j,col:be},Ce.recordContext=!0),Ce.type==="GLOBAL_AUTO_APPLY"&&(Ce.sourceCoords={row:j,col:be}),Ce.type==="CREATE_STACK"&&(Ce.sourceCoords={row:j,col:be},Ce.originalOwnerId||(Ce.sourceCard=me)),Ce.mode==="ZIUS_LINE_SELECT"&&(Ce.sourceCoords={row:j,col:be})),Ce.type==="CREATE_STACK"&&A(null),m(Ce,{row:j,col:be})}I(null)}E.current=!0,setTimeout(()=>{E.current=!1},300)}}}}else{const V=$==null?void 0:$.closest(".counter-modal-content"),X=($==null?void 0:$.closest("[data-board-coords]"))!==null,oe=($==null?void 0:$.closest("[data-hand-card]"))!==null;g.isDragging?V?I(j=>j?{...j,isDragging:!1}:null):!X&&!oe&&I(null):!V&&!X&&!oe&&I(null)}}};return window.addEventListener("mouseup",b),()=>{window.removeEventListener("mouseup",b)}},[g,n,e,r,l,o,E,_,m,I,A,x]),O.useEffect(()=>{const b=S=>{g&&(S.preventDefault(),I(null))};return window.addEventListener("contextmenu",b),()=>{window.removeEventListener("contextmenu",b)}},[g,I]),{cursorFollowerRef:Y,handleCounterMouseDown:(b,S)=>{P.current={x:S.clientX,y:S.clientY},I($=>($==null?void 0:$.type)===b?{type:b,count:$.count+1,isDragging:!0,sourceCoords:$.sourceCoords}:{type:b,count:1,isDragging:!0})}}};export{vr as A,br as B,Lt as C,Qn as D,lr as E,to as F,Zn as G,fr as H,gn as M,eo as P,ao as S,ve as T,Bt as a,ct as b,yn as c,_n as d,oo as e,Jn as f,Tn as g,Rn as h,mn as i,io as j,Rr as k,ro as l,En as m,wn as n,Xn as o,no as p,Vn as q,so as r,In as s,hn as t,Ut as u,co as v,uo as w,lo as x,fo as y,qn as z};
