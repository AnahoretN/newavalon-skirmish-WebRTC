import{r as $,j as lo}from"./vendor-react-JYPVbgc1-0.2.11.js";import{$ as Dt}from"./vendor-webrtc-BBsnVRmn-0.2.11.js";import{d as ba,e as uo}from"./vendor-BPR6uEV2-0.2.11.js";var De=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(De||{}),er=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(er||{});const fo={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365235/SYN_IP_DEPT_AGENT_pbvh9e.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_TACTICAL_AGENT_vquxfm.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_PATROL_AGENT_nlyneg.webp",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_RIOT_AGENT_i4lk5m.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_THREAT_ANALYST_uqxbsp.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367440/HERO_Mr._Pearl_Director_of_BioSynch_lsesol.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_RECKLESS_PROVOCATEUR_wvfdcr.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_DATA_LIBERATOR_qeru3j.webp",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_CAUTIOUS_AVENGER_xzk6pd.webp",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_VIGILANT_SPOTTER_xo8ig7.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_INVENTIVE_MAKER_sicb73.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367436/HERO_Finn_c8637x.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_FABER_cr804w.webp",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365250/OPT_CENSOR_w4qijk.webp",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_PRINCEPS_aaqakx.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_IMMUNIS_hvlxhi.webp",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_CENTURION_grztbi.webp",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367435/HERO_Lucius_The_Immortal_irhhaj.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_CODE_KEEPER_yhowqj.webp",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_DEVOUT_SYNTHETIC_nkr1tx.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_UNWAVERING_INTEGRATOR_g1cbag.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_SIGNAL_PROPHET_rmk9me.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_ZEALOUS_MISSIONARY_v7qjhw.webp",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367438/HERO_Reverend_of_The_Choir_njrrih.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365196/CMD_OVERWATCH_djwlqo.webp",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_REPOSITIONING_uhwvrk.webp",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_INSPIRATION_v0bi3l.webp",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_DATA_INTERCEPTION_gen1qw.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_FALSE_ORDERS_aatcmc.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367418/CMD_Experimental_Stimulants_plsnet.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367415/CMD_Logistics_Chain_odmwxq.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367414/CMD_Quick_Response_Team_xff2yt.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367411/CMD_Temporary_Shelter_podjbj.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367413/CMD_Enhanced_Interrogation_legiod.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367446/N_Autonomous_Battle_Robot_Gawain_oni745.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Reclaimed_Gawain_sjmlsp.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Secret_informant_w0w6g5.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367432/HERO_Michael_Falk_sv5i5c.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367434/HERO_Edith_Byron_ny23vb.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367429/HERO_Pinkunoneko_cqhpuy.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367431/HERO_Maria_Eleftheria_Damanaki_cpw12i.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367428/HERO_Zius_xhuyxa.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},po={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_RECON_DRONE_w3elir.webp",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_WALKING_TURRET_c0mttm.webp",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},yo={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365400/Aim_qzeaqn.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365398/Exploit_pf2zwf.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Revealed_lsan64.webp",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand and face-down cards on board.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board-facedown","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365403/Stun_pbe7ex.webp",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Shield_yilhdt.webp",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365402/Support_hxzufw.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771368527/Threat_dqnnsq.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365394/Resurrected_awaucv.webp",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},ho=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],Ut={cardDatabase:fo,tokenDatabase:po,countersDatabase:yo,deckFiles:ho};let fa=null,ot=new Map,Jt=new Map,gt={},Ot=[],Xt={};const Aa=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function ii(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const a=await fetch("/api/content/database");if(a.ok){const r=await a.json(),n=r.cards.map(([o,s])=>[o,s]),i=r.tokens.map(([o,s])=>[o,s]);e={cardDatabase:Object.fromEntries(n),tokenDatabase:Object.fromEntries(i),countersDatabase:Object.fromEntries(r.counters),deckFiles:r.deckFiles}}else e=Ut}catch{e=Ut}else e=Ut;fa=e,ot=new Map(Object.entries(e.cardDatabase)),Jt=new Map(Object.entries(e.tokenDatabase)),gt=e.countersDatabase,Ot=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(gt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(a){console.warn("Could not save counters database to localStorage:",a)}Fe=fa,tr=ot,Io=Jt,mt=gt,Eo=Ot,Xt=mo(),To=Xt}catch(e){throw console.error("Failed to load content database:",e),e}}function mo(){const e={};for(const t of Ot){const a=[];for(const r of t.cards){const n=ot.get(r.cardId);if(!n){console.warn(`Card definition not found for ID: ${r.cardId} in deck: ${t.name}`);continue}const i=Aa.has(r.cardId);for(let o=0;o<r.quantity;o++){const d=r.cardId.replace(/-/g,"--DASH--").toUpperCase();i?a.push({...n,deck:De.Command,id:`CMD_${d}_${o+1}`,baseId:r.cardId,faction:n.faction||"Command"}):a.push({...n,deck:t.id,id:`${t.id.substring(0,3).toUpperCase()}_${d}_${o+1}`,baseId:r.cardId,faction:n.faction||t.id})}}e[t.id]=a}return e[De.Tokens]=Array.from(Jt.entries()).map(([t,a])=>{const r=a.types?[...a.types]:[];return{id:`TKN_${a.name.toUpperCase().replace(/\s/g,"_")}`,baseId:t,deck:De.Tokens,name:a.name,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage,power:a.power,ability:a.ability,color:a.color,types:r,flavorText:a.flavorText,faction:"Tokens"}}),e}let Fe=null,tr=new Map,Io=new Map,mt={};try{const e=localStorage.getItem("counters_database");e&&(gt=JSON.parse(e),mt=gt)}catch{}let Eo=[],To={};const go=Aa,di=()=>Ot.filter(e=>e.isSelectable);function Ye(e){return ot.get(e)}function $t(e){return Array.from(ot.values()).find(t=>t.name===e)}function ci(){return Array.from(ot.entries()).map(([e,t])=>({id:e,card:t}))}function li(){return ot}function Sa(){return Xt}const wo=4,ui={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/medal_tavarc.webp"},fi={[De.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[De.Hoods]:{prefix:"HOO",color:"border-purple-500"},[De.Optimates]:{prefix:"OPT",color:"border-red-500"},[De.Fusion]:{prefix:"FUS",color:"border-green-400"},[De.Command]:{prefix:"CMD",color:"border-yellow-500"},[De.Tokens]:{prefix:"TKN",color:"border-gray-400"},[De.Custom]:{prefix:"CUS",color:"border-purple-400"},[De.Neutral]:{prefix:"NEU",color:"border-gray-400"},[De.Random]:{prefix:"RND",color:"border-gray-400"}},pi={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},_o={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},yi={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},ht=["blue","purple","red","green","yellow","orange","pink","brown"],hi=["Setup","Main","Commit","Scoring"],Rt=()=>Object.fromEntries(Object.entries(mt).map(([e,t])=>[e,t.imageUrl])),mi=new Proxy({},{get(e,t){return Rt()[t]},ownKeys(){return Object.keys(Rt())},has(e,t){return t in Rt()},getOwnPropertyDescriptor(e,t){const a=Rt()[t];return a!==void 0?{enumerable:!0,configurable:!0,value:a}:void 0}}),Pt=()=>Object.fromEntries(Object.entries(mt).map(([e,t])=>[e,t.description])),Ii=new Proxy({},{get(e,t){return Pt()[t]},ownKeys(){return Object.keys(Pt())},has(e,t){return t in Pt()},getOwnPropertyDescriptor(e,t){const a=Pt()[t];return a!==void 0?{enumerable:!0,configurable:!0,value:a}:void 0}}),bo=()=>Object.entries(mt).filter(([e,t])=>e!=="Resurrected"&&(!t.allowedPanels||t.allowedPanels.includes("COUNTER_PANEL"))).sort(([,e],[,t])=>e.sortOrder-t.sortOrder).map(([e,t])=>({type:e,label:t.name}));bo();const Ve="readyDeploy",$e="readySetup",He="readyCommit",Pe=(e,t,a)=>e.statuses?e.statuses.some(r=>r.type===t&&(a===void 0||r.addedByPlayerId===a)):!1,Ge=(e,t)=>e.statuses?e.statuses.some(a=>a.type===t):!1,Ao=(e,t,a)=>a===1&&Ge(e,$e),So=(e,t,a,r,n)=>!!(a&&Ge(e,Ve)||t===1&&r&&Ge(e,$e)||t===3&&n&&Ge(e,He)),Ht=e=>{e.statuses&&(e.statuses=e.statuses.filter(t=>t.type!==Ve&&t.type!==$e&&t.type!==He))},ut=(e,t,a,r)=>Math.abs(e-a)+Math.abs(t-r)===1,Co=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",a)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,t,a,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:a})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,t,a,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>{var i;return n.ownerId!==a&&((i=n.statuses)==null?void 0:i.some(o=>o.type==="Threat"))}},sourceCard:e,sourceCoords:r})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.ownerId!==a&&Pe(n,"Exploit",a)}})},{baseId:"centurion",activationType:"commit",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(n,i,o)=>{var s;return n.ownerId===a&&((s=n.types)==null?void 0:s.includes("Unit"))&&i!==void 0&&o!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:r,payload:{filter:(n,i,o)=>ut(i,o,r.row,r.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.id===e.id?!1:n.ownerId===a}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:r,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",a)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,originalOwnerId:a,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:n=>n.ownerId===a}})},{baseId:"censor",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:r,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",a)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,t,a,r)=>Pe(e,"Support",a)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:r,payload:{filter:(n,i)=>ut(n,i,r.row,r.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(n,i,o)=>ut(i,o,r.row,r.col)&&n.ownerId!==a&&(Pe(n,"Threat",a)||Pe(n,"Stun",a))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,t,a,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>n.ownerId===a&&Pe(n,"Support",a)},sourceCard:e,sourceCoords:r})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.ownerId===a&&Pe(n,"Exploit",a)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:r,payload:{filter:n=>Pe(n,"Exploit",a)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"MODIFY_POWER",amount:-1,filter:n=>Pe(n,"Aim",a)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:r,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"REVEAL_ENEMY",sourceCard:e,sourceCoords:r,payload:{filter:(n,i,o)=>{var h;const s=ut(i,o,r.row,r.col),d=n.ownerId!==a,c=n.deck==="Tokens"||((h=n.types)==null?void 0:h.includes("Token"));return s&&d&&!c}}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",a)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(n,i,o)=>ut(i,o,r.row,r.col)&&n.ownerId!==a&&(Pe(n,"Threat",a)||Pe(n,"Stun",a))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,t,a,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:a})},{baseId:"edithByron",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(n,i,o)=>ut(i,o,r.row,r.col)&&(Pe(n,"Threat",a)||Pe(n,"Stun",a)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",a)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:r,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,t,a,r)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:r,ownerId:a})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"LUCIUS_SETUP",filter:n=>n.ownerId===a}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.ownerId===a,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,t,a,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:r})}],rr=e=>{const t=e.baseId||"";return Co.filter(a=>{var r;return a.baseId===t||((r=a.baseIdAlt)==null?void 0:r.includes(t))})},Do=e=>{const a=rr(e).map(r=>r.activationType);return[...new Set(a)]},Ca=(e,t,a,r)=>{var o;if(a!==e.ownerId)return!1;if(r&&e.ownerId!==void 0){const s=r.players.find(d=>d.id===e.ownerId);if(s!=null&&s.isDummy&&r.activePlayerId!==e.ownerId)return!1}if((o=e.statuses)!=null&&o.some(s=>s.type==="Stun"))return!1;const n=rr(e),i=t===1&&n.some(s=>s.activationType==="setup")||t===3&&n.some(s=>s.activationType==="commit");if(t===1){const s=n.find(d=>d.activationType==="setup");if(s&&Ge(e,$e))return!(s.supportRequired&&!Pe(e,"Support",a))}if(t===3){const s=n.find(d=>d.activationType==="commit");if(s&&Ge(e,He))return!(s.supportRequired&&!Pe(e,"Support",a))}if(!i){const s=n.find(d=>d.activationType==="deploy");if(s&&Ge(e,Ve))return!(s.supportRequired&&!Pe(e,"Support",a))}return!1},Ro=(e,t,a,r)=>{if(a!==e.ownerId)if(e.ownerId!==void 0){const d=t.players.find(c=>c.id===e.ownerId);if(!(d!=null&&d.isDummy))return null}else return null;const n=rr(e),i=e.ownerId??a??0,o=t.currentPhase,s=o===1&&n.some(d=>d.activationType==="setup")||o===3&&n.some(d=>d.activationType==="commit");if(o===1){const d=n.find(c=>c.activationType==="setup");if(d&&Ge(e,$e)){if(d.supportRequired&&!Pe(e,"Support",i))return null;const c=d.getAction(e,t,i,r);if(c)return{...c,readyStatusToRemove:$e}}}if(o===3){const d=n.find(c=>c.activationType==="commit");if(d&&Ge(e,He)){if(d.supportRequired&&!Pe(e,"Support",i))return null;const c=d.getAction(e,t,i,r);if(c)return{...c,readyStatusToRemove:He}}}if(!s){const d=n.find(c=>c.activationType==="deploy");if(d&&Ge(e,Ve)){if(d.supportRequired&&!Pe(e,"Support",i))return null;const c=d.getAction(e,t,i,r);if(c)return{...c,isDeployAbility:!0,readyStatusToRemove:Ve}}}return null},y={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},Po=(e,t)=>t===1&&Ge(e,$e)?$e:t===3&&Ge(e,He)?He:Ge(e,Ve)?Ve:null,Ei=(e,t)=>{var o;let a,r;typeof t=="object"?(a=t.currentPhase,r=t):a=t;const n=r==null?void 0:r.activePlayerId;return n===void 0||e.ownerId!==n||(o=e.statuses)!=null&&o.some(s=>s.type==="Stun")||!Po(e,a)?!1:Ca(e,a,e.ownerId,r)},Da=(e,t,a)=>{var s;let r;if(typeof t=="object"?(r=t.currentPhase,a=t.activePlayerId??void 0):r=t,a===void 0||e.ownerId!==a||(s=e.statuses)!=null&&s.some(d=>d.type==="Stun"))return!1;const n=Ge(e,Ve),i=Ge(e,$e),o=Ge(e,He);return So(e,r,n,i,o)},ar=(e,t)=>{e.statuses||(e.statuses=[]);const a=Do(e);for(const r of a){let n="";r==="deploy"?n=Ve:r==="setup"?n=$e:r==="commit"&&(n=He),n&&(e.statuses.some(o=>o.type===n)||e.statuses.push({type:n,addedByPlayerId:t}))}},Zt=(e,t)=>{const a=pa("setup"),r=pa("commit");for(let n=0;n<e.board.length;n++)for(let i=0;i<e.board[n].length;i++){const s=e.board[n][i].card;if(!s||s.ownerId!==t)continue;const d=s.baseId||s.id;if(d){if(y.debug(`[resetReadyStatusesForTurn] Processing card: ${s.name} (baseId: ${d}, ownerId: ${s.ownerId})`),s.statuses||(s.statuses=[]),a.includes(d)){const c=s.statuses.some(h=>h.type===$e);s.statuses=s.statuses.filter(h=>h.type!==$e),s.statuses.push({type:$e,addedByPlayerId:t}),c||y.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_SETUP to ${s.name}`)}else s.statuses=s.statuses.filter(c=>c.type!==$e);if(r.includes(d)){const c=s.statuses.some(h=>h.type===He);s.statuses=s.statuses.filter(h=>h.type!==He),s.statuses.push({type:He,addedByPlayerId:t}),c||y.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_COMMIT to ${s.name}`)}else s.statuses=s.statuses.filter(c=>c.type!==He)}}};function pa(e){const t=[];for(const[a,r]of Object.entries(tr))(r.abilities||[]).some(i=>i.activationType===e)&&t.push(a);return t}class ko{constructor(){this.queue=[],this.loading=new Set,this.loaded=new Set,this.maxConcurrent=1,this.minDelayBetweenLoads=1e3,this.lastLoadTime=0,this.isProcessing=!1}preload(t,a="low"){!t||this.loaded.has(t)||this.loading.has(t)||this.queue.some(n=>n.url===t)||(this.queue.push({url:t,priority:a,timestamp:Date.now()}),this.queue.sort((n,i)=>{const o={high:0,normal:1,low:2},s=o[n.priority]-o[i.priority];return s!==0?s:n.timestamp-i.timestamp}),this.processQueue())}preloadMany(t,a="low"){t.forEach(r=>this.preload(r,a))}isLoaded(t){return this.loaded.has(t)}clearQueue(){this.queue=[]}clear(){this.queue=[],this.loading.clear(),this.loaded.clear()}processQueue(){if(this.isProcessing||this.queue.length===0)return;this.isProcessing=!0;const t=()=>{if(this.queue.length===0){this.isProcessing=!1;return}const r=Date.now()-this.lastLoadTime,n=Math.max(0,this.minDelayBetweenLoads-r);setTimeout(()=>{const i=this.queue.shift();if(!i){this.isProcessing=!1;return}this.loadImage(i.url).then(()=>{this.lastLoadTime=Date.now(),t()}).catch(()=>{this.lastLoadTime=Date.now(),t()})},n)};t()}loadImage(t){return new Promise((a,r)=>{this.loading.add(t);const n=new Image;n.onload=()=>{this.loading.delete(t),this.loaded.add(t),a()},n.onerror=()=>{this.loading.delete(t),r(new Error(`Failed to load: ${t}`))},n.src=t})}}const Oo=new ko;function vo(e,t){const a=[];for(const r of e)if(r.id!==t){if(r.hand)for(const n of r.hand)n.imageUrl&&!a.includes(n.imageUrl)&&a.push(n.imageUrl);if(r.deck)for(const n of r.deck)n.imageUrl&&!a.includes(n.imageUrl)&&a.push(n.imageUrl);if(r.discard)for(const n of r.discard)n.imageUrl&&!a.includes(n.imageUrl)&&a.push(n.imageUrl)}return a}function Ie(e){const t=e,a=t==null?void 0:t.targetingMode;a&&delete t.targetingMode;let r;return typeof structuredClone<"u"?r=structuredClone(e):r=JSON.parse(JSON.stringify(e)),a&&(r.targetingMode=a,t.targetingMode=a),r}const oe={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function Ti(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function gi(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}function wi(e,t){return e?_o[e]:t}function ve(){return localStorage.getItem("webrtc_enabled")==="true"}const Ra=$.createContext(null),_i=({children:e})=>{const[t,a]=$.useState(null),[r,n]=$.useState({}),[i,o]=$.useState("lg"),s=$.useCallback((u,D={},T="lg")=>{a(u),n(D),o(T)},[]),d=$.useCallback(()=>{a(null),n({}),o("lg")},[]),c=$.useCallback(u=>t===u,[t]),h=$.useCallback(()=>r,[r]),I=$.useCallback(()=>i,[i]),_={openModal:t,modalData:r,modalSize:i,open:s,close:d,isOpen:c,getData:h,getSize:I};return lo.jsx(Ra.Provider,{value:_,children:e})},Mt=()=>{const e=$.useContext(Ra);if(!e)throw new Error("useModals must be used within ModalsProvider");return e},bi=()=>{const{open:e,close:t,isOpen:a}=Mt();return{isOpen:a("rules"),open:r=>e("rules",r,"full"),close:t}},Ai=()=>{const{open:e,close:t,isOpen:a}=Mt();return{isOpen:a("settings"),open:r=>e("settings",r,"md"),close:t}},Si=()=>{const{open:e,close:t,isOpen:a,getData:r}=Mt();return{isOpen:a("joinGame"),open:n=>e("joinGame",n,"lg"),close:t,getData:()=>r()}},Ci=()=>{const{open:e,close:t,isOpen:a}=Mt();return{isOpen:a("deckBuilder"),open:r=>e("deckBuilder",r,"full"),close:t}},wt="webrtc_game_state",_t="webrtc_host_data",bt="webrtc_guest_data",No="webrtc_current_host_peerId",Mo=30*60*1e3;function nr(){return Date.now()}function St(e){return Date.now()-e<Mo}function Lo(e){try{const t={...e,timestamp:nr()};localStorage.setItem(_t,JSON.stringify(t)),y.info("[WebRTC Persistence] Saved host data:",{peerId:t.peerId})}catch(t){y.error("[WebRTC Persistence] Failed to save host data:",t)}}function Ft(e){try{const t={...e,timestamp:nr()};localStorage.setItem(bt,JSON.stringify(t)),y.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId})}catch(t){y.error("[WebRTC Persistence] Failed to save guest data:",t)}}function It(e){try{const t={...e,timestamp:nr()};localStorage.setItem(wt,JSON.stringify(t)),y.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(t.timestamp).toISOString())}catch(t){y.error("[WebRTC Persistence] Failed to save game state:",t)}}function Pa(){try{const e=localStorage.getItem(_t);if(!e)return null;const t=JSON.parse(e);return St(t.timestamp)?(y.info("[WebRTC Persistence] Loaded valid host data:",{peerId:t.peerId}),t):(y.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(_t),null)}catch(e){return y.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(_t),null}}function ka(){try{const e=localStorage.getItem(bt);if(!e)return null;const t=JSON.parse(e);return St(t.timestamp)?(y.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId}),t):(y.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(bt),null)}catch(e){return y.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(bt),null}}function ya(){try{const e=localStorage.getItem(wt);if(!e)return null;const t=JSON.parse(e);return St(t.timestamp)?(y.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(t.timestamp).toISOString()),t):(y.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(wt),null)}catch(e){return y.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(wt),null}}function rt(){localStorage.removeItem(wt),localStorage.removeItem(_t),localStorage.removeItem(bt),localStorage.removeItem(No)}function Qt(e,t){try{const a=`webrtc_host_${t}`,r={peerId:e,gameId:t,timestamp:Date.now()};localStorage.setItem(a,JSON.stringify(r)),y.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${t}:`,e)}catch(a){y.error("[WebRTC Persistence] Failed to broadcast host peerId:",a)}}function Bt(e){try{const t=`webrtc_host_${e}`,a=localStorage.getItem(t);if(!a)return null;const r=JSON.parse(a);return Date.now()-r.timestamp>15e3?null:{peerId:r.peerId,timestamp:r.timestamp}}catch(t){return y.error("[WebRTC Persistence] Failed to get host peerId:",t),null}}function ha(e){try{const t=`webrtc_host_${e}`;localStorage.removeItem(t),y.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(t){y.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",t)}}function Go(){const e=sessionStorage.getItem("invite_host_id"),t=sessionStorage.getItem("invite_auto_join");if(e&&t)return"none";const a=Pa();if(a&&St(a.timestamp))return"host";const r=ka();return r&&St(r.timestamp)?"guest":"none"}const ma=7,Wt="mrPearlDoF",xo="reverendOfTheChoir",Uo="threatAnalyst";function $o(e,t){return e!=null&&e.statuses?e.statuses.some(a=>a.type==="Exploit"&&a.addedByPlayerId!==void 0&&t.has(a.addedByPlayerId)):!1}function Ho(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const Oa=()=>Array(ma).fill(null).map(()=>Array(ma).fill(null).map(()=>({card:null}))),Ne=e=>{var T,g,p,C,E;const{board:t,activeGridSize:a,players:r}=e,n=Ho(t),i=n.length,o=Math.floor((i-a)/2),s=new Map;r.forEach(l=>s.set(l.id,l.teamId));for(let l=0;l<i;l++)for(let w=0;w<i;w++){const b=n[l][w].card;b&&(b.statuses&&(b.statuses=b.statuses.filter(M=>M.type!=="Support"&&M.type!=="Threat")),delete b.bonusPower)}for(let l=0;l<i;l++)for(let w=0;w<i;w++){const b=n[l][w].card;if((b==null?void 0:b.ownerId)===void 0||b.isFaceDown)continue;const M=b.ownerId,L=s.get(M),G=[{r:l-1,c:w},{r:l+1,c:w},{r:l,c:w-1},{r:l,c:w+1}],N={};let m=!1;for(const P of G){const{r:A,c:v}=P;if(A>=0&&A<i&&v>=0&&v<i){const x=n[A][v].card,F=(T=x==null?void 0:x.statuses)==null?void 0:T.some(W=>W.type==="Stun");if((x==null?void 0:x.ownerId)!==void 0&&!x.isFaceDown&&!F){const W=x.ownerId,j=s.get(W);M===W||L!==void 0&&L===j?m=!0:(N[W]||(N[W]=[]),N[W].push({r:A,c:v}))}}}m&&(b.statuses||(b.statuses=[]),b.statuses.some(P=>P.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:M}));let O=null;for(const P in N){const A=N[P];if(A&&A.length>=2){O=parseInt(P,10);break}}if(O===null&&l>=o&&l<o+a&&w>=o&&w<o+a){const A=l===o||l===o+a-1||w===o||w===o+a-1,v=Object.keys(N).length>0;if(A&&v){const x=Object.keys(N)[0];x&&(O=parseInt(x,10))}}O!==null&&(b.statuses||(b.statuses=[]),b.statuses.some(P=>P.type==="Threat")||b.statuses.push({type:"Threat",addedByPlayerId:O}))}const d=new Set;for(let l=0;l<i;l++)for(let w=0;w<i;w++){const b=n[l][w].card,M=(g=b==null?void 0:b.statuses)==null?void 0:g.some(L=>L.type==="Stun");if((b==null?void 0:b.baseId)===Uo&&!b.isFaceDown&&b.ownerId!==void 0&&!M){const L=[{r:l-1,c:w},{r:l+1,c:w},{r:l,c:w-1},{r:l,c:w+1}];let G=!1;const N=b.ownerId,m=s.get(N);for(const O of L){const{r:P,c:A}=O;if(P>=0&&P<i&&A>=0&&A<i){const v=n[P][A].card;if((v==null?void 0:v.ownerId)!==void 0&&!v.isFaceDown){const x=v.ownerId,F=s.get(x),W=N===x||m!==void 0&&m===F,j=(p=v==null?void 0:v.statuses)==null?void 0:p.some(X=>X.type==="Stun");if(W&&!j){G=!0;break}}}}G&&d.add(N)}}for(let l=0;l<i;l++)for(let w=0;w<i;w++){const b=n[l][w].card;if(!b||b.isFaceDown||b.ownerId===void 0)continue;const M=b.ownerId,L=s.get(M),G=[{r:l-1,c:w},{r:l+1,c:w},{r:l,c:w-1},{r:l,c:w+1}],N={};for(const O of G){const{r:P,c:A}=O;if(P>=0&&P<i&&A>=0&&A<i){const v=n[P][A].card,x=(C=v==null?void 0:v.statuses)==null?void 0:C.some(F=>F.type==="Stun");if((v==null?void 0:v.ownerId)!==void 0&&!v.isFaceDown&&!x){const F=v.ownerId,W=s.get(F);if(!(M===F||L!==void 0&&L===W)){const X=d.has(F),z=$o(b,d);X&&z&&(N[F]||(N[F]=0),N[F]++)}}}}if(Object.keys(N).length>0){b.statuses||(b.statuses=[]);const O=Object.keys(N).map(P=>parseInt(P,10));for(const P of O)b.statuses.some(A=>A.type==="Threat"&&A.addedByPlayerId===P)||b.statuses.push({type:"Threat",addedByPlayerId:P})}}const c=[],h=[];for(let l=0;l<i;l++)for(let w=0;w<i;w++){const b=n[l][w].card,M=(E=b==null?void 0:b.statuses)==null?void 0:E.some(L=>L.type==="Stun");b!=null&&b.baseId&&!b.isFaceDown&&b.ownerId!==void 0&&!M&&(b.baseId===xo?c.push({r:l,c:w,ownerId:b.ownerId,baseId:b.baseId}):b.baseId===Wt&&h.push({r:l,c:w,ownerId:b.ownerId,baseId:b.baseId}))}const I=new Set,_=new Set;for(const l of c){const{r:w,c:b,ownerId:M}=l,L=`${w}-${M}`;if(!I.has(L)){I.add(L);for(let N=0;N<i;N++){const m=n[w][N].card;m&&m.ownerId===M&&!m.isFaceDown&&(m.statuses||(m.statuses=[]),m.statuses.some(O=>O.type==="Support")||m.statuses.push({type:"Support",addedByPlayerId:M}))}}const G=`${b}-${M}`;if(!_.has(G)){_.add(G);for(let N=0;N<i;N++){const m=n[N][b].card;m&&m.ownerId===M&&!m.isFaceDown&&(m.statuses||(m.statuses=[]),m.statuses.some(O=>O.type==="Support")||m.statuses.push({type:"Support",addedByPlayerId:M}))}}}const u=new Set,D=new Set;for(const l of h){const{r:w,c:b,ownerId:M}=l,L=`${w}-${M}`;if(!u.has(L)){u.add(L);for(let N=0;N<i;N++){const m=n[w][N].card;m&&m.ownerId===M&&!m.isFaceDown&&m.baseId!==Wt&&(m.bonusPower=(m.bonusPower||0)+1)}}const G=`${b}-${M}`;if(!D.has(G)){D.add(G);for(let N=0;N<i;N++){const m=n[N][b].card;m&&m.ownerId===M&&!m.isFaceDown&&m.baseId!==Wt&&(m.bonusPower=(m.bonusPower||0)+1)}}}return n};var it=(e=>(e[e.CARD_REGISTRY=1]="CARD_REGISTRY",e[e.CARD_STATE=2]="CARD_STATE",e[e.ABILITY_EFFECT=3]="ABILITY_EFFECT",e[e.SESSION_EVENT=4]="SESSION_EVENT",e))(it||{});function Fo(){const e={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},t=new Set,a=Array.from(tr.values());for(const r of a)if(r.baseId&&!t.has(r.baseId)){t.add(r.baseId);const n=e.cardDefinitions.length;e.baseIdToIndex.set(r.baseId,n),e.indexToBaseId.set(n,r.baseId),e.cardDefinitions.push({baseId:r.baseId,name:r.name,imageUrl:r.imageUrl,power:r.power,ability:r.ability||"",types:r.types||[],faction:r.faction||""})}return e.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],y.info(`[CardRegistry] Built registry with ${e.cardDefinitions.length} cards, ${e.statusTypes.length} status types`),e}function va(e,t){let a=0;for(const r of e||[]){const n=t.statusTypes.indexOf(r.type);n>=0&&n<32&&(a|=1<<n)}return a>>>0}function Na(e,t,a){const r=[];for(let n=0;n<32;n++)if(e&1<<n){const i=a.statusTypes[n];i&&r.push({type:i,addedByPlayerId:t})}return r}function Ma(e){let t=0;return e.isFaceDown&&(t|=1),e.enteredThisTurn&&(t|=2),e.revealedTo==="all"&&(t|=4),t}function Yt(e,t){const a=new Uint8Array(13);let r=0;const n=or(e.id);a[r++]=n>>24&255,a[r++]=n>>16&255,a[r++]=n>>8&255,a[r++]=n&255;const i=e.baseId?t.baseIdToIndex.get(e.baseId)??0:0;a[r++]=i>>8&255,a[r++]=i&255,a[r++]=(e.ownerId??0)&255;const o=Math.round(e.power||0);a[r++]=Math.clamp(o,-128,127)&255,a[r++]=Ma(e);const s=va(e.statuses||[],t);return a[r++]=s>>24&255,a[r++]=s>>16&255,a[r++]=s>>8&255,a[r++]=s&255,a}function Bo(e,t,a){const r=new Uint8Array(10);let n=0;const i=or(e.id);r[n++]=i>>24&255,r[n++]=i>>16&255,r[n++]=i>>8&255,r[n++]=i&255,r[n++]=(e.ownerId??a)&255,r[n++]=Ma(e);const o=va(e.statuses||[],t);return r[n++]=o>>24&255,r[n++]=o>>16&255,r[n++]=o>>8&255,r[n++]=o&255,r}function or(e){let t=0;for(let a=0;a<e.length;a++){const r=e.charCodeAt(a);t=(t<<5)-t+r,t=t&t}return t>>>0}function Wo(e,t,a){var T;const r=[],n=Date.now(),i=new Uint8Array(7);i[0]=it.CARD_STATE,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,r.push(i);const o=[],s=Math.min(e.players.length,255);o.push(new Uint8Array([s]));for(const g of e.players){o.push(new Uint8Array([g.id&255]));const p=ht.indexOf(g.color);o.push(new Uint8Array([p>=0?p:0]));const C=Math.min(g.deck.length,255),E=Math.min(g.hand.length,255),l=Math.min(g.discard.length,255);o.push(new Uint8Array([C,E,l,g.announcedCard?1:0])),o.push(new Uint8Array([Math.min(g.score,255)]));const w=Math.min(g.hand.length,255);o.push(new Uint8Array([w]));const b=g.id===a;for(const L of g.hand)b?o.push(Yt(L,t)):o.push(Bo(L,t,g.id));const M=Math.min(g.discard.length,255);o.push(new Uint8Array([M]));for(const L of g.discard){const G=or(L.id),N=new Uint8Array(4);N[0]=G>>24&255,N[1]=G>>16&255,N[2]=G>>8&255,N[3]=G&255,o.push(N)}g.announcedCard&&o.push(Yt(g.announcedCard,t))}const d=e.board.length;o.push(new Uint8Array([d,d,d]));const c=[];for(let g=0;g<e.board.length;g++)for(let p=0;p<((T=e.board[g])==null?void 0:T.length);p++){const C=e.board[g][p];C!=null&&C.card&&c.push({row:g,col:p,card:C.card})}const h=c.length,I=new Uint8Array(2);I[0]=h>>8&255,I[1]=h&255,o.push(I);for(const{row:g,col:p,card:C}of c)o.push(new Uint8Array([g,p])),o.push(Yt(C,t));o.push(new Uint8Array([e.currentPhase===void 0?255:Math.clamp(e.currentPhase,0,254),(e.activePlayerId??255)&255,e.currentRound===void 0?255:Math.clamp(e.currentRound,0,254)]));let _=0;for(const g of o)_+=g.length;i[5]=_>>8&255,i[6]=_&255,r.push(...o);const u=new Uint8Array(r.reduce((g,p)=>g+p.length,0));let D=0;for(const g of r)u.set(g,D),D+=g.length;return y.info(`[GameCodec] Encoded card state: ${u.length} bytes (${h} board cards, ${e.players.length} players)`),u}function Yo(e,t,a){let r=0;if(e[r++]!==it.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],e[r++]<<8|e[r++];const n=e[r++],i=[];for(let T=0;T<n;T++){const g=e[r++],p=e[r++],C=ht[p]||"blue",E=e[r++];e[r++],e[r++];const l=e[r++]===1,w=e[r++],b=e[r++],M=[],L=g===a;for(let P=0;P<b;P++)if(L)M.push(Kt(e,r,t)),r+=13;else{const A=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],v=e[r++],x=e[r++],F=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];M.push({id:`card_${A}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:v,isFaceDown:(x&1)!==0,revealedTo:x&4?"all":void 0,statuses:Na(F,g,t),isPlaceholder:!0})}const G=e[r++],N=[];for(let P=0;P<G;P++){const A=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];N.push({id:`discard_${A}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:g,isPlaceholder:!0})}let m=null;l&&(m=Kt(e,r,t),r+=13);const O=[];for(let P=0;P<E;P++)O.push({id:`deck_${g}_${P}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:g,isPlaceholder:!0});i.push({id:g,name:`Player ${g}`,score:w,hand:M,deck:O,discard:N,announcedCard:m,selectedDeck:"Random",color:C,boardHistory:[]})}const o=e[r++];r++,r++;const s=e[r++]<<8|e[r++],d=[];for(let T=0;T<o;T++){const g=[];for(let p=0;p<o;p++)g.push({card:null});d.push(g)}for(let T=0;T<s;T++){const g=e[r++],p=e[r++],C=Kt(e,r,t);r+=13,g<d.length&&p<d[g].length&&(d[g][p]={card:C})}const c=e[r++],h=e[r++],I=e[r++];return{players:i,board:d,currentPhase:c===255?void 0:c,activePlayerId:h===255?null:h,currentRound:I===255?void 0:I}}function Kt(e,t,a){const n=`card_${e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++]}_${Date.now()}`,i=e[t++]<<8|e[t++],o=e[t++];let s=e[t++];s>127&&(s=s-256);const d=e[t++],c=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++],h=a.cardDefinitions[i],I=(h==null?void 0:h.baseId)||"";return{id:n,baseId:I,deck:"Random",name:(h==null?void 0:h.name)||"?",imageUrl:(h==null?void 0:h.imageUrl)||"",power:s,ability:(h==null?void 0:h.ability)||"",types:(h==null?void 0:h.types)||[],faction:(h==null?void 0:h.faction)||"",ownerId:o,isFaceDown:(d&1)!==0,enteredThisTurn:(d&2)!==0,revealedTo:d&4?"all":void 0,statuses:Na(c,0,a)}}Math.clamp||(Math.clamp=function(e,t,a){return Math.min(Math.max(e,t),a)});let zt=null;function La(){return zt||(zt=Fo()),zt}function Ia(e,t){const a=La();return Wo(e,a,t)}function Ko(e,t){const a=La();return Yo(e,a,t)}function zo(e){return ba(e)}function Ga(e){y.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return uo(e)}catch(t){return y.error("[webrtcSerialization] Failed to serialize delta:",t),new Uint8Array(0)}}function xa(e){y.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return ba(e)}catch(t){return y.error("[webrtcSerialization] Failed to deserialize delta:",t),{}}}function qo(e){const t=Ga(e);let a="";const r=new Uint8Array(t),n=r.byteLength;for(let i=0;i<n;i++)a+=String.fromCharCode(r[i]);return btoa(a)}function Vo(e){const t=atob(e),a=new Uint8Array(t.length);for(let r=0;r<t.length;r++)a[r]=t.charCodeAt(r);return xa(a)}function jo(e,t){var I;const a=new TextEncoder,r=[],n=Date.now(),i=new Uint8Array(7);i[0]=it.ABILITY_EFFECT,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,r.push(i);const o=[];if(o.push(new Uint8Array([e])),t.sourcePos){const _=(t.sourcePos.row&15)<<4|t.sourcePos.col&15;o.push(new Uint8Array([_]))}else o.push(new Uint8Array([255]));const s=((I=t.targetPositions)==null?void 0:I.length)||0;if(o.push(new Uint8Array([Math.min(s,255)])),t.targetPositions)for(const _ of t.targetPositions.slice(0,255)){const u=(_.row&15)<<4|_.col&15;o.push(new Uint8Array([u]))}if(t.text){const _=a.encode(t.text),u=Math.min(_.length,255);o.push(new Uint8Array([u])),o.push(_.slice(0,u))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(t.value??0)&255])),o.push(new Uint8Array([(t.playerId??0)&255]));let d=0;for(const _ of o)d+=_.length;i[5]=d>>8&255,i[6]=d&255,r.push(...o);const c=new Uint8Array(r.reduce((_,u)=>_+u.length,0));let h=0;for(const _ of r)c.set(_,h),h+=_.length;return y.debug(`[AbilityMessages] Encoded effect type ${e}: ${c.length} bytes`),c}function Jo(e){let t=0;if(e[t++]!==it.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const a=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={effectType:e[t++],timestamp:a,data:{}},n=e[t++];n!==255&&(r.data.sourcePos={row:n>>4&15,col:n&15});const i=e[t++];if(i>0){r.data.targetPositions=[];for(let s=0;s<i;s++){const d=e[t++];r.data.targetPositions.push({row:d>>4&15,col:d&15})}}const o=e[t++];if(o>0){const s=new TextDecoder;r.data.text=s.decode(e.subarray(t,t+o)),t+=o}return r.data.value=e[t++],r.data.playerId=e[t++],r}function Xo(e,t={}){const a=new TextEncoder,r=[],n=Date.now(),i=new Uint8Array(7);i[0]=it.SESSION_EVENT,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,r.push(i);const o=[];if(o.push(new Uint8Array([e])),o.push(new Uint8Array([(t.playerId??0)&255])),t.playerName){const I=a.encode(t.playerName),_=Math.min(I.length,255);o.push(new Uint8Array([_])),o.push(I.slice(0,_))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(t.startingPlayerId??0)&255])),o.push(new Uint8Array([Math.min(t.roundNumber??0,255)])),o.push(new Uint8Array([Math.min(t.newPhase??0,255)])),o.push(new Uint8Array([(t.newActivePlayerId??0)&255])),o.push(new Uint8Array([(t.gameWinner??255)&255]));let s=0;if(t.winners)for(const I of t.winners)I<32&&(s|=1<<I);o.push(new Uint8Array([s>>24&255,s>>16&255,s>>8&255,s&255]));let d=0;for(const I of o)d+=I.length;i[5]=d>>8&255,i[6]=d&255,r.push(...o);const c=new Uint8Array(r.reduce((I,_)=>I+_.length,0));let h=0;for(const I of r)c.set(I,h),h+=I.length;return y.debug(`[SessionMessages] Encoded event type ${e}: ${c.length} bytes`),c}function Zo(e){let t=0;if(e[t++]!==it.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const a=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={eventType:e[t++],timestamp:a,data:{}};r.data.playerId=e[t++];const n=e[t++];if(n>0){const s=new TextDecoder;r.data.playerName=s.decode(e.subarray(t,t+n)),t+=n}r.data.startingPlayerId=e[t++],r.data.roundNumber=e[t++],r.data.newPhase=e[t++],r.data.newActivePlayerId=e[t++];const i=e[t++];r.data.gameWinner=i===255?null:i;const o=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];if(o!==0){r.data.winners=[];for(let s=0;s<32;s++)o&1<<s&&r.data.winners.push(s)}return r}const Qo=!0;class Ke{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,this.guestPlayerIds=new Map,localStorage.getItem("webrtc_enabled")}async initializeAsHost(t){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((a,r)=>{this.peer=t?new Dt(t):new Dt,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),a(n)}),this.peer.on("connection",n=>{y.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{y.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{y.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(t){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((a,r)=>{this.peer=new Dt,this.peer.on("open",n=>{const i=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(i),i.on("open",()=>{this.hostConnection=i,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}});let o=null;try{const s=localStorage.getItem("webrtc_preferred_deck");s&&(o=s,y.info(`[initializeAsGuest] Found deck preference in localStorage: ${o}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(s){y.warn("[initializeAsGuest] Failed to read deck preference:",s)}this.sendMessageToHost({type:"JOIN_REQUEST",senderId:n,data:{preferredDeck:o||void 0},timestamp:Date.now()}),a()}),i.on("error",o=>{y.error("Host connection error:",o),this.emitEvent({type:"error",data:o}),r(o)})}),this.peer.on("error",n=>{y.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)})})}async initializeAsReconnectingGuest(t,a){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((r,n)=>{this.peer=new Dt,this.peer.on("open",i=>{const o=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(o),o.on("open",()=>{this.hostConnection=o,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:i,playerId:a,timestamp:Date.now()}),this.isReconnecting=!1,r()}),o.on("error",s=>{y.error("Host connection error:",s),this.emitEvent({type:"error",data:s}),this.isReconnecting=!1,n(s)})}),this.peer.on("error",i=>{y.error("WebRTC Peer error:",i),this.emitEvent({type:"error",data:i}),this.isReconnecting=!1,n(i)})})}handleGuestConnection(t){this.connections.set(t.peer,t),t.on("open",()=>{y.info(`Guest connected: ${t.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:t.peer}})}),t.on("data",a=>{this.handleMessage(a,t)}),t.on("close",()=>{y.info(`Guest disconnected: ${t.peer}`),this.connections.delete(t.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:t.peer}})}),t.on("error",a=>{y.error(`Guest connection error (${t.peer}):`,a)})}setupHostConnection(t){this.hostConnection=t,t.on("data",a=>{this.handleMessage(a,t)}),t.on("close",()=>{y.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),t.on("error",a=>{y.error("Host connection error:",a)})}handleMessage(t,a){y.debug("Received WebRTC message:",t.type),this.emitEvent({type:"message_received",data:t})}sendMessageToHost(t){var a,r,n,i;if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(t),(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&y.info(`[WebrtcManager] Sent ${t.type} to host`,{hasData:!!t.data,hasTargetingMode:!!((a=t.data)!=null&&a.targetingMode),targetingModePlayerId:(n=(r=t.data)==null?void 0:r.targetingMode)==null?void 0:n.playerId}),!0}catch(o){return y.error("Failed to send message to host:",o),!1}return(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&y.warn(`[WebrtcManager] Could not send ${t.type} to host`,{isHost:this.isHost,hasHostConnection:!!this.hostConnection,isConnectionOpen:((i=this.hostConnection)==null?void 0:i.open)??!1}),!1}broadcastToGuests(t,a){if(!this.isHost)return y.warn("Only host can broadcast to guests"),0;let r=0;return this.connections.forEach((n,i)=>{if(n.open&&i!==a)try{n.send(t),r++}catch(o){y.error(`Failed to send to guest ${i}:`,o)}}),y.debug(`Broadcast to ${r}/${this.connections.size} guests`),r}sendToGuest(t,a){if(!this.isHost)return y.warn("Only host can send to specific guest"),!1;const r=this.connections.get(t);if(!r)return y.error(`[sendToGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!r.open)return y.error(`[sendToGuest] Connection for guest ${t} is not open`),!1;try{return r.send(a),y.debug(`Sent message to guest ${t}`),!0}catch(n){return y.error(`[sendToGuest] Failed to send message to ${t}:`,n),!1}}acceptGuest(t,a,r){var i;const n=this.connections.get(t);if(!n){y.error(`[acceptGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){y.error(`[acceptGuest] Connection for guest ${t} is not open`);return}try{if(Qo){const o=Ia(a,null),s={type:"JOIN_ACCEPT_BINARY",senderId:(i=this.peer)==null?void 0:i.id,playerId:r,data:o,timestamp:Date.now()};n.send(s),y.info(`Accepted guest ${t} as player ${r} (BINARY, ${o.byteLength} bytes)`)}}catch(o){y.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${t}:`,o)}}acceptGuestMinimal(t,a,r){var o;const n=this.connections.get(t);if(!n){y.error(`[acceptGuestMinimal] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){y.error(`[acceptGuestMinimal] Connection for guest ${t} is not open`);return}this.guestPlayerIds.set(t,r);const i={type:"JOIN_ACCEPT_MINIMAL",senderId:(o=this.peer)==null?void 0:o.id,playerId:r,data:a,timestamp:Date.now()};try{n.send(i),y.info(`Accepted guest ${t} as player ${r} (minimal)`)}catch(s){y.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${t}:`,s)}}broadcastGameState(t,a){this.broadcastGameStateLegacy(t,a)}broadcastGameStateLegacy(t,a){let r=0;this.connections.forEach((n,i)=>{var c;if(!n.open||i===a)return;const o=this.guestPlayerIds.get(i)??null,s=Ke.createPersonalizedGameState(t,o),d={type:"STATE_UPDATE_COMPACT",senderId:(c=this.peer)==null?void 0:c.id,data:{gameState:s,recipientPlayerId:o},timestamp:Date.now()};try{n.send(d),r++}catch(h){y.error(`[broadcastGameStateLegacy] Failed to send to guest ${i} (player ${o}):`,h)}}),y.debug(`[broadcastGameStateLegacy] Sent to ${r}/${this.connections.size} guests`)}static createPersonalizedGameState(t,a){return{...t,players:t.players.map(r=>{if(a!==null&&r.id===a){const i=r.deck.length??0,o=r.discard.length??0,s=r.hand.length??0;return y.debug(`[createPersonalizedGameState] Player ${r.id} (own): ${s} hand, ${i} deck, ${o} discard`),{...r,handCards:r.hand.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),deckCards:r.deck.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),discardCards:r.discard.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?Ke.optimizeCard(r.announcedCard):null,deckSize:i,discardSize:o,handSize:s}}else{const i=r.deckSize??r.deck.length??0,o=r.hand.filter(s=>!s.isFaceDown).length;return o>0&&y.debug(`[createPersonalizedGameState] Player ${r.id} (other): ${o} revealed, ${r.hand.length-o} face-down`),{...r,hand:r.hand.map(s=>s.isFaceDown?Ke.createCardBack(s):{id:s.id,baseId:s.baseId,power:s.power,powerModifier:s.powerModifier||0,isFaceDown:s.isFaceDown,statuses:s.statuses||[],ownerId:s.ownerId,ownerName:s.ownerName,deck:s.deck}),deck:[],discard:[],announcedCard:r.announcedCard?Ke.createCardBack(r.announcedCard):null,deckSize:i,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}}}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?Ke.optimizeCard(n.card):null})))}}static createCompactStateForHost(t,a){return{...t,players:t.players.map(r=>r.id===a?(y.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),deckCards:r.deck.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),discardCards:r.discard.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),hand:[],deck:[],discard:[],handSize:r.hand.length,deckSize:r.deck.length,discardSize:r.discard.length}):{...r,hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?Ke.optimizeCard(n.card):null})))}}static optimizeCard(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier,ability:t.ability,ownerId:t.ownerId,color:t.color,deck:t.deck,isFaceDown:t.isFaceDown,types:t.types,faction:t.faction,statuses:t.statuses||[],hasRevealToken:t.hasRevealToken||!1,imageUrl:t.imageUrl}}static createCardBack(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,hasRevealToken:t.hasRevealToken||!1,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck}}broadcastStateDelta(t,a){var r,n;{const i=qo(t),o={type:"STATE_DELTA_BINARY",senderId:(r=this.peer)==null?void 0:r.id,data:i,timestamp:Date.now()};y.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${i.length} chars, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, boardCells=${((n=t.boardCells)==null?void 0:n.length)||0}`),this.broadcastToGuests(o,a),y.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${t.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(t,a,r){var n;try{const i=Ia(t,a),o=btoa(String.fromCharCode(...i)),s={type:"CARD_STATE",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,r);return y.info(`[broadcastCardState] Sent ${i.length} bytes to ${d} guests`),d}catch(i){return y.error("[broadcastCardState] Failed to encode/broadcast state:",i),0}}broadcastAbilityEffect(t,a,r){var n;try{const i=jo(t,a),o=btoa(String.fromCharCode(...i)),s={type:"ABILITY_EFFECT",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,r);return y.debug(`[broadcastAbilityEffect] Sent effect ${t} to ${d} guests`),d}catch(i){return y.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",i),0}}broadcastSessionEvent(t,a,r){var n;try{const i=Xo(t,a),o=btoa(String.fromCharCode(...i)),s={type:"SESSION_EVENT",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,r);return y.debug(`[broadcastSessionEvent] Sent event ${t} to ${d} guests`),d}catch(i){return y.error("[broadcastSessionEvent] Failed to encode/broadcast event:",i),0}}sendAction(t,a){var n;const r={type:"ACTION",senderId:(n=this.peer)==null?void 0:n.id,data:{actionType:t,actionData:a},timestamp:Date.now()};return this.sendMessageToHost(r)}sendStateDelta(t){var a;{const r=Ga(t),n={type:"STATE_DELTA_BINARY",senderId:(a=this.peer)==null?void 0:a.id,data:r,timestamp:Date.now()};return this.sendMessageToHost(n)}}sendStateToHost(t,a){var o,s,d;if(a===null)return y.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const r=Ke.createCompactStateForHost(t,a),n=t.players.find(c=>c.id===a);n&&y.info(`[sendStateToHost] Player ${a} sending compact state: hand=${((o=n.hand)==null?void 0:o.length)??0}, deck=${((s=n.deck)==null?void 0:s.length)??0}`);const i={type:"STATE_UPDATE_COMPACT",senderId:(d=this.peer)==null?void 0:d.id,playerId:a,data:{gameState:r},timestamp:Date.now()};return this.sendMessageToHost(i)}sendFullDeckToHost(t,a,r){var i;const n={type:"DECK_DATA_UPDATE",senderId:(i=this.peer)==null?void 0:i.id,playerId:t,data:{playerId:t,deck:a.map(o=>Ke.optimizeCard(o)),deckSize:r},timestamp:Date.now()};return this.sendMessageToHost(n)}sendCustomDeckData(t,a,r){var o;if(!r)return!0;y.info(`[sendCustomDeckData] Player ${t} sending ${a.length} custom deck cards to host`);const n=a.map(s=>({id:s.id,baseId:s.baseId,name:s.name,power:s.power,powerModifier:s.powerModifier,ability:s.ability,types:s.types,faction:s.faction,imageUrl:s.imageUrl,color:s.color,deck:s.deck})),i={type:"CUSTOM_DECK_DATA",senderId:(o=this.peer)==null?void 0:o.id,playerId:t,data:{playerId:t,deckCards:n},timestamp:Date.now()};return this.sendMessageToHost(i)}getConnectionInfo(){const t=[];return this.isHost?this.connections.forEach((a,r)=>{t.push({peerId:r,playerId:null,playerName:null,connected:a.open})}):this.hostConnection&&t.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),t}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getHostPeerId(){var t,a;return this.isHost?((t=this.peer)==null?void 0:t.id)||null:((a=this.hostConnection)==null?void 0:a.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var t;return this.isHost?this.connections.size:(t=this.hostConnection)!=null&&t.open?1:0}on(t){return this.eventHandlers.add(t),()=>this.eventHandlers.delete(t)}emitEvent(t){this.eventHandlers.forEach(a=>{try{a(t)}catch(r){y.error("Error in WebRTC event handler:",r)}})}cleanup(){this.connections.forEach(t=>t.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let qt=null;const es=()=>(qt||(qt=new Ke),qt);function ts(e){return 10+e*10}function sr(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const t=e.currentPhase===1,a=e.activePlayerId===e.startingPlayerId;if(!t||!a)return{shouldEnd:!1,roundWinners:[]};const r=e.currentRound||1,n=ts(r),i=[];for(const s of e.players)!s.isDummy&&!s.isDisconnected&&s.score>=n&&i.push(s.id);return{shouldEnd:i.length>0,roundWinners:i}}function Ua(e){const{shouldEnd:t,roundWinners:a}=sr(e);if(!t)return e;const r=e.currentRound||1,n={...e.roundWinners,[r]:a},i=new Map;for(const[,s]of Object.entries(n))for(const d of s){const c=i.get(d)||0;i.set(d,c+1)}let o=null;for(const[s,d]of i.entries())if(d>=2){o=s;break}return y.info(`[endRound] Round ${r} ended. Winners: [${a.join(", ")}], Game winner: ${o||"none"}`),{...e,roundWinners:n,gameWinner:o,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function ir(e,t){if(e.currentPhase!==0)return y.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const a=e.players.find(i=>i.id===t);if(!a)return y.error(`[performPreparationPhase] Active player ${t} not found!`),e;y.info(`[performPreparationPhase] Player ${t} has deck size: ${a.deck.length}, hand size: ${a.hand.length}`);const r=e.players.map(i=>{if(i.id===t&&i.deck.length>0){const o=i.deck[0],s=[...i.deck.slice(1)],d=[...i.hand,o];return y.info(`[performPreparationPhase] Player ${t} drew card ${(o==null?void 0:o.id)||"unknown"}, deck now: ${s.length}, hand: ${d.length}`),{...i,deck:s,hand:d,readySetup:!1,readyCommit:!1}}return i});let n={...e,players:r,currentPhase:1};return Zt(n,t),sr(n).shouldEnd?Ua(n):(y.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${n.activePlayerId}`),n)}function $a(e,t){const a=e.activePlayerId;if(a===t){const s={...e,activePlayerId:null};return t===e.startingPlayerId&&e.currentPhase===1&&sr(s).shouldEnd?Ua(s):s}if(!e.players.filter(s=>!s.isDisconnected).find(s=>s.id===t))return y.warn(`[toggleActivePlayer] Player ${t} not found or disconnected`),e;let i=e.turnNumber||1;t===e.startingPlayerId&&a!==null&&i++;const o={...e,activePlayerId:t,turnNumber:i,currentPhase:0};return ir(o,t)}function rs(e,t){const a=e.players.filter(i=>!i.isDisconnected).sort((i,o)=>i.id-o.id);if(a.length===0)return null;if(t===null)return a[0].id;const r=a.findIndex(i=>i.id===t);if(r===-1)return a[0].id;const n=(r+1)%a.length;return a[n].id}function as(e,t){var a;for(const r of e.board)for(const n of r)if(((a=n.card)==null?void 0:a.ownerId)===t)return!0;return!1}function yt(e){const t=rs(e,e.activePlayerId);if(t===null)return y.warn("[passTurnToNextPlayer] No next player found"),e;y.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${t}`);let a={...e,board:e.board.map(r=>r.map(n=>{var i;return((i=n.card)==null?void 0:i.ownerId)===e.activePlayerId&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(o=>o.type!=="Stun")}}:n}))};return a={...a,board:a.board.map(r=>r.map(n=>n.card&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(i=>i.type!=="enteredThisTurn")}}:n))},a={...a,activePlayerId:t,currentPhase:0,isScoringStep:!1,targetingMode:null},ir(a,t)}function Vt(e,t,a){return y.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),e}function ns(e,t){return{type:"RECONNECT_SNAPSHOT",data:e}}function os(e,t,a){var r,n,i,o;try{const s=Ko(e,a);y.info(`[WebRTCCodec] Received card state: ${(r=s.board)==null?void 0:r.length}x${((i=(n=s.board)==null?void 0:n[0])==null?void 0:i.length)||0}, ${((o=s.players)==null?void 0:o.length)||0} players`);const d={...t};return s.players&&(d.players=s.players.map(c=>{const h=t.players.find(I=>I.id===c.id);if(h){const I=c.id===a;return{...h,...c,hand:I?h.hand:c.hand,color:h.color}}return c})),s.board&&(d.board=s.board),s.currentPhase!==void 0&&(d.currentPhase=s.currentPhase),s.activePlayerId!==void 0&&(d.activePlayerId=s.activePlayerId),s.currentRound!==void 0&&(d.currentRound=s.currentRound),d}catch(s){return y.error("[WebRTCCodec] Failed to deserialize card state:",s),t}}function ss(e,t){try{const{effectType:a,timestamp:r,data:n}=Jo(e);y.debug(`[WebRTCCodec] Received ability effect: ${a}`);let i=t;switch(a){case 1:return{gameState:i,effectData:{type:"highlight",...n,timestamp:r}};case 2:return{gameState:i,effectData:{type:"floatingText",...n,timestamp:r}};case 3:return{gameState:i,effectData:{type:"noTarget",...n}};case 8:return{gameState:i,effectData:{type:"targetingMode",...n}};case 9:return{gameState:i,effectData:{type:"clearTargeting"}};default:return y.warn(`[WebRTCCodec] Unknown ability effect type: ${a}`),{gameState:i,effectData:null}}}catch(a){return y.error("[WebRTCCodec] Failed to handle ability effect:",a),{gameState:t,effectData:null}}}function is(e,t){var a;try{const{eventType:r,data:n}=Zo(e);y.info(`[WebRTCCodec] Received session event: ${r}`);const i={...t};switch(r){case 1:y.info(`[WebRTCCodec] Player connected: ${n.playerName} (ID: ${n.playerId})`);break;case 2:y.info(`[WebRTCCodec] Player disconnected: ID: ${n.playerId}`),i.players=i.players.map(o=>o.id===n.playerId?{...o,isDisconnected:!0}:o);break;case 3:y.info(`[WebRTCCodec] Game starting, first player: ${n.startingPlayerId}`),i.isGameStarted=!0,n.startingPlayerId!==void 0&&(i.activePlayerId=n.startingPlayerId,i.startingPlayerId=n.startingPlayerId);break;case 4:y.info(`[WebRTCCodec] Round ${n.roundNumber} starting`),i.currentRound=n.roundNumber??1;break;case 5:if(y.info(`[WebRTCCodec] Round ${n.roundNumber} ended, winners: ${(a=n.winners)==null?void 0:a.join(", ")}`),i.isRoundEndModalOpen=!0,n.winners&&n.roundNumber!==void 0){const o=i.roundWinners||{};o[n.roundNumber]=n.winners,i.roundWinners=o}break;case 6:y.info(`[WebRTCCodec] Phase change: ${n.newPhase}`),n.newPhase!==void 0&&(i.currentPhase=n.newPhase),n.newActivePlayerId!==void 0&&(i.activePlayerId=n.newActivePlayerId);break;case 7:y.info(`[WebRTCCodec] Turn change: player ${n.newActivePlayerId}`),n.newActivePlayerId!==void 0&&(i.activePlayerId=n.newActivePlayerId);break;case 8:y.info(`[WebRTCCodec] Game ended, winner: ${n.gameWinner}`),n.gameWinner!==void 0&&(i.gameWinner=n.gameWinner===255?null:n.gameWinner);break;default:y.warn(`[WebRTCCodec] Unknown session event type: ${r}`)}return i}catch(r){return y.error("[WebRTCCodec] Failed to handle session event:",r),t}}function ft(e,t,a,r){return e===2?{gameState:os(t,a,r)}:e===3?ss(t,a):e===4?{gameState:is(t,a)}:(y.warn(`[WebRTCCodec] Unknown codec message type: ${e}`),{gameState:a})}const vt="avalon_game_state",nt="reconnection_data";function Ha(e,t){var r;e.forEach(n=>n.forEach(i=>{var o;(o=i.card)!=null&&o.statuses&&(i.card.statuses=i.card.statuses.filter(s=>!(s.type==="LastPlayed"&&s.addedByPlayerId===t.id)))})),t.boardHistory||(t.boardHistory=[]);let a=!1;for(;t.boardHistory.length>0&&!a;){const n=t.boardHistory[t.boardHistory.length-1];for(let i=0;i<e.length;i++){for(let o=0;o<e[i].length;o++)if(((r=e[i][o].card)==null?void 0:r.id)===n){const s=e[i][o].card;if(!s||s.ownerId!==t.id)continue;s.statuses||(s.statuses=[]),s.statuses.push({type:"LastPlayed",addedByPlayerId:t.id}),a=!0;break}if(a)break}a||t.boardHistory.pop()}}function Et(e){var r;if(!e||!Fe)return e;const{cardDatabase:t,tokenDatabase:a}=Fe;if(e.deck===De.Tokens||(r=e.id)!=null&&r.startsWith("TKN_")){if(e.baseId&&a[e.baseId]){const i=a[e.baseId];return{...e,imageUrl:i.imageUrl,fallbackImage:i.fallbackImage}}const n=Object.keys(a).find(i=>a[i].name===e.name);if(n){const i=a[n];return{...e,imageUrl:i.imageUrl,fallbackImage:i.fallbackImage,baseId:n}}}else if(e.baseId&&t[e.baseId]){const n=t[e.baseId];return{...e,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage}}return e}function Ct(e){var r,n;if(!Fe)return e;const t=((r=e.board)==null?void 0:r.map(i=>i.map(o=>({...o,card:o.card?Et(o.card):null}))))||e.board,a=((n=e.players)==null?void 0:n.map(i=>{var o,s,d;return{...i,hand:((o=i.hand)==null?void 0:o.map(Et))||[],deck:((s=i.deck)==null?void 0:s.map(Et))||[],discard:((d=i.discard)==null?void 0:d.map(Et))||[],announcedCard:i.announcedCard?Et(i.announcedCard):null}}))||e.players;return{...e,board:t,players:a,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}}function Ea(e,t,a){try{const r=Ct(e),n={gameState:r,localPlayerId:t,playerToken:a,timestamp:Date.now()};localStorage.setItem(vt,JSON.stringify(n)),r.gameId&&t!==null&&localStorage.setItem(nt,JSON.stringify({gameId:r.gameId,playerId:t,playerToken:a||null,timestamp:Date.now()}))}catch(r){console.warn("Failed to save game state:",r)}}function ds(){try{const e=localStorage.getItem(vt);if(!e)return null;const t=JSON.parse(e),a=24*60*60*1e3;if(Date.now()-t.timestamp>a)return localStorage.removeItem(vt),localStorage.removeItem(nt),null;const r=t.gameState;return{gameState:Ct(r),localPlayerId:t.localPlayerId,playerToken:t.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}}function pt(){localStorage.removeItem(vt),localStorage.removeItem(nt)}function dr(e){const t=[...e];for(let a=t.length-1;a>0;a--){const r=Math.floor(Math.random()*(a+1));[t[a],t[r]]=[t[r],t[a]]}return t}function Fa(){return Math.random().toString(36).substring(2,18).toUpperCase()}function Ze(e,t,a){const r=Sa();let n=e;if(e==="Random"||!r[e]){const s=Object.keys(r);if(s.length===0)return y.error("[createDeck] No decks loaded yet!"),[];n=s[0],e==="Random"||y.warn(`[createDeck] Deck ${e} not found, using ${n} instead`)}const i=r[n];if(!i)return y.error(`Deck data for ${n} not loaded! Returning empty deck. Available decks:`,Object.keys(r)),[];const o=[...i].map(s=>({...s,ownerId:t,ownerName:a}));return dr(o)}function Ba(e,t=!1){const a=Sa(),r=Object.keys(a);if(r.length===0)return y.error("[createNewPlayer] No decks loaded yet!"),{id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:ht[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};const n=r[0],i={id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:n,color:ht[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};return i.deck=Ze(n,e,i.name),i}function at(){return{players:[],spectators:[],board:Oa(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:er.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}const Ta=-1,cs=-2,Tt=1,kt=2,st=(e,t,a,r)=>{var s,d,c,h,I;const{card:n,ownerId:i,location:o}=e;if(t.targetOwnerId!==void 0&&t.targetOwnerId!==Ta&&t.targetOwnerId!==cs&&t.targetOwnerId!==i||t.excludeOwnerId!==void 0&&t.excludeOwnerId===i)return!1;if(t.onlyOpponents||t.targetOwnerId===Ta){if(i===a)return!1;const _=r.find(D=>D.id===a),u=r.find(D=>D.id===i);if(_&&u&&_.teamId!==void 0&&_.teamId===u.teamId)return!1}if(t.targetType&&!((s=n.types)!=null&&s.includes(t.targetType))||t.onlyFaceDown&&((d=n.statuses)!=null&&d.some(_=>_.type==="Revealed"&&_.addedByPlayerId===a)||o==="board"&&!n.isFaceDown)||t.tokenType==="Revealed"&&(c=n.statuses)!=null&&c.some(_=>_.type==="Revealed"&&_.addedByPlayerId===a)||t.requiredTargetStatus&&(!((h=n.statuses)!=null&&h.some(_=>_.type===t.requiredTargetStatus))||t.requireStatusFromSourceOwner&&a!==null&&!((I=n.statuses)==null?void 0:I.some(u=>u.type===t.requiredTargetStatus&&u.addedByPlayerId===a))))return!1;if(t.mustBeAdjacentToSource&&t.sourceCoords&&e.boardCoords){const{row:_,col:u}=t.sourceCoords,{row:D,col:T}=e.boardCoords;if(Math.abs(_-D)+Math.abs(u-T)!==Tt)return!1}if(t.mustBeInLineWithSource&&t.sourceCoords&&e.boardCoords){const{row:_,col:u}=t.sourceCoords,{row:D,col:T}=e.boardCoords;if(_!==D&&u!==T)return!1}if(t.maxDistanceFromSource!==void 0&&t.sourceCoords&&e.boardCoords){const{row:_,col:u}=t.sourceCoords,{row:D,col:T}=e.boardCoords;if(Math.max(Math.abs(_-D),Math.abs(u-T))>t.maxDistanceFromSource)return!1}if(t.maxOrthogonalDistance!==void 0&&t.sourceCoords&&e.boardCoords){const{row:_,col:u}=t.sourceCoords,{row:D,col:T}=e.boardCoords;if(Math.abs(_-D)+Math.abs(u-T)>t.maxOrthogonalDistance)return!1}return!0},Nt=(e,t,a,r)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const n=[],i=t.board,o=i.length,s=t.activeGridSize,d=Math.floor((o-s)/2),c=d,h=d+s-1;if(e.type==="CREATE_STACK"){const T={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let g=c;g<=h;g++)for(let p=c;p<=h;p++){const C=i[g][p];C.card&&C.card.ownerId!==void 0&&st({card:C.card,ownerId:C.card.ownerId,location:"board",boardCoords:{row:g,col:p}},T,a,t.players)&&n.push({row:g,col:p})}return n}const{mode:I,payload:_,sourceCoords:u,contextCheck:D}=e;if(I==="REVEREND_DOUBLE_EXPLOIT"){for(let T=c;T<=h;T++)for(let g=c;g<=h;g++)i[T][g].card&&n.push({row:T,col:g});return n}if((I==="SELECT_TARGET"||I==="CENSOR_SWAP"||I==="ZEALOUS_WEAKEN"||I==="CENTURION_BUFF"||I==="SELECT_UNIT_FOR_MOVE")&&_.filter&&typeof _.filter=="function"){if(_.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||_.actionType==="LUCIUS_SETUP"||_.actionType==="SELECT_HAND_FOR_DEPLOY"||_.handOnly)return[];for(let T=c;T<=h;T++)for(let g=c;g<=h;g++){const p=i[T][g];let C=p.card&&_.filter(p.card,T,g);if(C&&D==="ADJACENT_TO_LAST_MOVE"&&(r!=null&&r.lastMovedCardCoords)){const{row:E,col:l}=r.lastMovedCardCoords;Math.abs(T-E)+Math.abs(g-l)===1||(C=!1)}C&&n.push({row:T,col:g})}}else if(I==="SELECT_TARGET"&&(_.actionType==="ENHANCED_INT_REVEAL"||_.actionType==="ENHANCED_INT_MOVE"))for(let T=c;T<=h;T++)for(let g=c;g<=h;g++)i[T][g].card&&n.push({row:T,col:g});else if(I==="PATROL_MOVE"&&u)for(let T=c;T<=h;T++)for(let g=c;g<=h;g++){const p=T===u.row||g===u.col,C=T===u.row&&g===u.col,E=!i[T][g].card;p&&(E||C)&&n.push({row:T,col:g})}else if(I==="RIOT_PUSH"&&u){const T=[{r:u.row-1,c:u.col},{r:u.row+1,c:u.col},{r:u.row,c:u.col-1},{r:u.row,c:u.col+1}],g=(p,C)=>p>=c&&p<=h&&C>=c&&C<=h;T.forEach(p=>{if(g(p.r,p.c)){const C=i[p.r][p.c].card;if(C&&C.ownerId!==a){const E=t.players.find(b=>b.id===a),l=t.players.find(b=>b.id===C.ownerId);if(!((E==null?void 0:E.teamId)!==void 0&&(l==null?void 0:l.teamId)!==void 0&&E.teamId===l.teamId)){const b=p.r-u.row,M=p.c-u.col,L=p.r+b,G=p.c+M;g(L,G)&&(i[L][G].card||n.push({row:p.r,col:p.c}))}}}})}else if(I==="RIOT_MOVE"&&_.vacatedCoords)n.push(_.vacatedCoords),u&&n.push(u);else if(I==="SWAP_POSITIONS"&&_.filter)for(let T=c;T<=h;T++)for(let g=c;g<=h;g++){const p=i[T][g];p.card&&_.filter(p.card,T,g)&&n.push({row:T,col:g})}else if((I==="TRANSFER_STATUS_SELECT"||I==="TRANSFER_ALL_STATUSES")&&_.filter)for(let T=c;T<=h;T++)for(let g=c;g<=h;g++){const p=i[T][g];p.card&&_.filter(p.card,T,g)&&n.push({row:T,col:g})}else if(I==="SPAWN_TOKEN"||I==="SELECT_CELL"||I==="IMMUNIS_RETRIEVE")for(let T=c;T<=h;T++)for(let g=c;g<=h;g++){const p=!i[T][g].card;if(I==="IMMUNIS_RETRIEVE"&&_.filter){p&&_.filter(T,g)&&n.push({row:T,col:g});continue}if(I==="SELECT_CELL"){if(_.moveFromHand){p&&n.push({row:T,col:g});continue}if(!u)continue;const C=T===u.row&&g===u.col,E=_.range==="global";let l=!1;if(E)l=!0;else if(_.range==="line")l=T===u.row||g===u.col;else if(_.range===kt){const w=Math.abs(T-u.row),b=Math.abs(g-u.col),M=w+b;if(M===Tt)l=!0;else if(M===kt){const L=[];w===kt&&b===0?L.push({r:(T+u.row)/2,c:g}):w===0&&b===kt?L.push({r:T,c:(g+u.col)/2}):w===Tt&&b===Tt&&(L.push({r:T,c:u.col}),L.push({r:u.row,c:g})),l=L.some(G=>G.r<0||G.r>=o||G.c<0||G.c>=o?!1:!i[G.r][G.c].card)}}else l=Math.abs(T-u.row)+Math.abs(g-u.col)===Tt;(p&&l||_.allowSelf&&C)&&n.push({row:T,col:g})}else if(I==="SPAWN_TOKEN"&&u){const C=Math.abs(T-u.row)+Math.abs(g-u.col)===1;p&&C&&n.push({row:T,col:g})}}else if(I==="REVEAL_ENEMY"&&_.filter)for(let T=c;T<=h;T++)for(let g=c;g<=h;g++){const p=i[T][g];p.card&&_.filter(p.card,T,g)&&n.push({row:T,col:g})}else if(I==="SELECT_LINE_START")for(let T=c;T<=h;T++)for(let g=c;g<=h;g++)n.push({row:T,col:g});else if(I==="SELECT_LINE_END"&&_.firstCoords){const{row:T,col:g}=_.firstCoords;for(let p=c;p<=h;p++)n.push({row:T,col:p});for(let p=c;p<=h;p++)n.push({row:p,col:g})}else if(I==="INTEGRATOR_LINE_SELECT"&&u){const{row:T,col:g}=u;for(let p=c;p<=h;p++)n.push({row:T,col:p});for(let p=c;p<=h;p++)n.push({row:p,col:g})}else if(I==="ZIUS_LINE_SELECT"&&u){const{row:T,col:g}=u;for(let p=c;p<=h;p++)n.push({row:T,col:p});for(let p=c;p<=h;p++)n.push({row:p,col:g})}else if(I==="IP_AGENT_THREAT_SCORING"&&u){const{row:T,col:g}=u;for(let p=c;p<=h;p++)n.push({row:T,col:p});for(let p=c;p<=h;p++)n.push({row:p,col:g})}else if(I==="SELECT_DIAGONAL")if(_.firstCoords){const{row:T,col:g}=_.firstCoords;for(let p=c;p<=h;p++)for(let C=c;C<=h;C++)Math.abs(p-T)===Math.abs(C-g)&&n.push({row:p,col:C})}else for(let T=c;T<=h;T++)for(let g=c;g<=h;g++)n.push({row:T,col:g});return n},At=(e,t,a,r)=>{var i,o,s,d,c;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let h=0;h<t.board.length;h++)for(let I=0;I<t.board[h].length;I++)if(t.board[h][I].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((i=e.payload)!=null&&i.actionType)){const h=e.payload.actionType;if(h==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||h==="LUCIUS_SETUP"||h==="SELECT_HAND_FOR_DEPLOY"){const I=((o=e.sourceCard)==null?void 0:o.ownerId)||a;if(I!==null){const _=t.players.find(u=>u.id===I);if(_&&_.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(Nt(e,t,a,r).length>0)return!0;const I=["Aim","Exploit","Stun","Shield"];if(!(e.tokenType&&I.includes(e.tokenType))&&(e.tokenType==="Revealed"||(s=e.tokenType)!=null&&s.startsWith("Power")))for(const u of t.players)for(let D=0;D<u.hand.length;D++){const T={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(st({card:u.hand[D],ownerId:u.id,location:"hand"},T,a,t.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((d=e.payload)!=null&&d.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const h of t.players)if(h.hand.some(I=>e.payload.filter(I))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return Nt(e,t,a,r).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((c=e.payload)!=null&&c.filter),!1)};function ls(e){const{ws:t,webrtcManager:a,gameStateRef:r,localPlayerIdRef:n,webrtcIsHostRef:i,setLatestHighlight:o,setLatestFloatingTexts:s,setLatestNoTarget:d,setLatestDeckSelections:c,setLatestHandCardSelections:h,setClickWaves:I,setGameState:_}=e,u=$.useRef({}),D=500,T=$.useCallback(L=>{var N;const G={...L,timestamp:Date.now()};if(o(G),((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:r.current.gameId,highlightData:G}));else if(a.current){const m={type:"HIGHLIGHT_TRIGGERED",senderId:a.current.getPeerId(),data:G,timestamp:Date.now()};i.current?a.current.broadcastToGuests(m):a.current.sendMessageToHost(m)}},[t,a,r,i,o]),g=$.useCallback(L=>{var O;const G=Array.isArray(L)?L:[L],N=Date.now(),m=G.map((P,A)=>({...P,timestamp:N+A}));if(s(m),((O=t.current)==null?void 0:O.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:r.current.gameId,batch:m}));else if(a.current){const P={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:a.current.getPeerId(),data:{batch:m},timestamp:Date.now()};i.current?a.current.broadcastToGuests(P):a.current.sendMessageToHost(P)}},[t,a,r,i,s]),p=$.useCallback(L=>{var N;const G=Date.now();if(d({coords:L,timestamp:G}),((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:r.current.gameId,coords:L,timestamp:G}));else if(a.current){const m={type:"NO_TARGET_TRIGGERED",senderId:a.current.getPeerId(),data:{coords:L,timestamp:G},timestamp:Date.now()};i.current?a.current.broadcastToGuests(m):a.current.sendMessageToHost(m)}},[t,a,r,i,d]),C=$.useCallback((L,G)=>{var m;const N={playerId:L,selectedByPlayerId:G,timestamp:Date.now()};if(c(O=>[...O,N]),((m=t.current)==null?void 0:m.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:r.current.gameId,deckSelectionData:N}));else if(a.current){const O={type:"DECK_SELECTION_TRIGGERED",senderId:a.current.getPeerId(),data:N,timestamp:Date.now()};i.current?a.current.broadcastToGuests(O):a.current.sendMessageToHost(O)}setTimeout(()=>{c(O=>O.filter(P=>P.timestamp!==N.timestamp))},1e3)},[t,a,r,i,c]),E=$.useCallback((L,G,N)=>{var O;const m={playerId:L,cardIndex:G,selectedByPlayerId:N,timestamp:Date.now()};if(h(P=>[...P,m]),((O=t.current)==null?void 0:O.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:r.current.gameId,handCardSelectionData:m}));else if(a.current){const P={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:a.current.getPeerId(),data:m,timestamp:Date.now()};i.current?a.current.broadcastToGuests(P):a.current.sendMessageToHost(P)}setTimeout(()=>{h(P=>P.filter(A=>A.timestamp!==m.timestamp))},1e3)},[t,a,r,i,h]),l=$.useCallback(L=>{var G;if(((G=t.current)==null?void 0:G.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"SYNC_VALID_TARGETS",gameId:r.current.gameId,playerId:n.current,...L}));else if(a.current){const N={type:"SYNC_VALID_TARGETS",senderId:a.current.getPeerId(),data:{playerId:n.current,...L},timestamp:Date.now()};i.current?a.current.broadcastToGuests(N):a.current.sendMessageToHost(N)}},[t,a,r,i,n]),w=$.useCallback((L,G,N)=>{var x;if(n.current===null)return;const m=n.current,O=Date.now(),P=u.current[m]||0;if(O-P<D)return;u.current[m]=O;const A=r.current.players.find(F=>F.id===m);if(!A)return;const v={timestamp:Date.now(),location:L,boardCoords:G,handTarget:N,clickedByPlayerId:m,playerColor:A.color};if(console.log("[triggerClickWave] Creating wave:",v),I(F=>[...F,v]),((x=t.current)==null?void 0:x.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_CLICK_WAVE",gameId:r.current.gameId,wave:v}));else if(a.current){const F={type:"CLICK_WAVE_TRIGGERED",senderId:a.current.getPeerId(),data:v,timestamp:Date.now()};i.current?a.current.broadcastToGuests(F):a.current.sendMessageToHost(F)}setTimeout(()=>{I(F=>F.filter(W=>W.timestamp!==v.timestamp))},600)},[t,a,r,i,I]),b=$.useCallback((L,G,N,m,O,P)=>{var F;const A=r.current;if(!A||!A.board){console.warn("[setTargetingMode] No game state or board available");return}let v;m?v=m:N&&(v=Nt(L,A,G,O));const x={playerId:G,action:L,sourceCoords:N,timestamp:Date.now(),boardTargets:v,handTargets:P};if(_(W=>({...W,targetingMode:x})),((F=t.current)==null?void 0:F.readyState)===WebSocket.OPEN&&A.gameId)t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:A.gameId,targetingMode:x}));else if(a.current){const W={type:"SET_TARGETING_MODE",senderId:a.current.getPeerId(),data:x,timestamp:Date.now()};i.current?a.current.broadcastToGuests(W):a.current.sendMessageToHost(W)}},[t,a,r,i,_]),M=$.useCallback(()=>{var G;const L=r.current;if(_(N=>({...N,targetingMode:null})),((G=t.current)==null?void 0:G.readyState)===WebSocket.OPEN&&(L!=null&&L.gameId))t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:L.gameId}));else if(a.current){const N={type:"CLEAR_TARGETING_MODE",senderId:a.current.getPeerId(),data:{},timestamp:Date.now()};i.current?a.current.broadcastToGuests(N):a.current.sendMessageToHost(N)}},[t,a,r,i,_]);return{triggerHighlight:T,triggerFloatingText:g,triggerNoTarget:p,triggerDeckSelection:C,triggerHandCardSelection:E,syncValidTargets:l,triggerClickWave:w,setTargetingMode:b,clearTargetingMode:M}}function us(e){const{ws:t,webrtcManager:a,gameStateRef:r,webrtcIsHostRef:n,setGameState:i,updateState:o}=e,s=$.useCallback(_=>{var D;if(ve()&&a.current&&n.current){i(T=>{const g=T.players.map(p=>{let C=1;for(const[E,l]of Object.entries(_))if(l.includes(p.id)){C=parseInt(E);break}return{...p,teamId:C}});return{...T,players:g}}),a.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:a.current.getPeerId(),data:{assignments:_},timestamp:Date.now()});return}((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:r.current.gameId,assignments:_}))},[t,a,r,n,i]),d=$.useCallback(_=>{var D;if(ve()&&a.current&&n.current){i(T=>({...T,gameMode:_})),a.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:a.current.getPeerId(),data:{mode:_},timestamp:Date.now()});return}((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:r.current.gameId,mode:_}))},[t,a,r,n,i]),c=$.useCallback(_=>{var D;if(ve()&&a.current&&n.current){i(T=>({...T,isPrivate:_})),a.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:a.current.getPeerId(),data:{isPrivate:_},timestamp:Date.now()});return}((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:r.current.gameId,isPrivate:_}))},[t,a,r,n,i]),h=$.useCallback(_=>{o(u=>{if(u.isGameStarted)return u;const D={...u,activeGridSize:_};if(u.board.length!==_){D.board=[];for(let g=0;g<_;g++){const p=[];for(let C=0;C<_;C++)p.push({card:null});D.board.push(p)}}return D})},[o]),I=$.useCallback(_=>{o(u=>{if(u.isGameStarted)return u;const D=u.players.filter(p=>!p.isDummy);if(D.length+_>wo)return u;const T=[...D],g=Math.max(...D.map(p=>p.id),0);for(let p=0;p<_;p++){const C=g+p+1,E=Ba(C,!0);E.name=`Dummy ${p+1}`,T.push(E)}return{...u,players:T,dummyPlayerCount:_}})},[o]);return{assignTeams:s,setGameMode:d,setGamePrivacy:c,setActiveGridSize:h,setDummyPlayerCount:I}}function fs(e){const{ws:t,webrtcManager:a,gameStateRef:r,localPlayerIdRef:n,webrtcIsHostRef:i,setGameState:o}=e,s=$.useCallback(()=>{var I;if(ve()&&a.current&&i.current){o(_=>({..._,isReadyCheckActive:!0,isPrivate:!0})),a.current.broadcastToGuests({type:"START_READY_CHECK",senderId:a.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((I=t.current)==null?void 0:I.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:r.current.gameId}))},[t,a,r,i,o]),d=$.useCallback(()=>{var I;if(ve()&&a.current&&i.current){o(_=>({..._,isReadyCheckActive:!1})),a.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:a.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((I=t.current)==null?void 0:I.readyState)===WebSocket.OPEN&&r.current.gameId?t.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:r.current.gameId})):o(_=>({..._,isReadyCheckActive:!1}))},[t,a,r,i,o]),c=$.useCallback(()=>{var I;const h=ve();if(h&&a.current&&i.current&&n.current!==null){o(_=>{const u=_.players.map(p=>p.id===n.current?{...p,isReady:!0}:p),D={..._,players:u},T=D.players.filter(p=>!p.isDummy&&!p.isDisconnected);if(T.length>0&&T.every(p=>p.isReady)&&!D.isGameStarted){const p=D.players.filter(b=>!b.isDisconnected),C=Math.floor(Math.random()*p.length),E=p[C].id,l={...D};l.isReadyCheckActive=!1,l.isGameStarted=!0,l.startingPlayerId=E,l.activePlayerId=E,l.currentPhase=0,l.players=l.players.map(b=>{if(b.hand.length===0&&b.deck.length>0){const L=[...b.hand],G=[...b.deck];for(let N=0;N<6&&N<G.length;N++){const m=G[0];G.splice(0,1),L.push(m)}return y.info(`[playerReady] Drew initial ${L.length} cards for player ${b.id}`),{...b,hand:L,deck:G}}return b});const w=l.players.find(b=>b.id===E);if(w&&w.deck.length>0){const b=w.deck[0],M=[...w.deck.slice(1)],L=[...w.hand,b];l.players=l.players.map(G=>G.id===E?{...G,deck:M,hand:L,readySetup:!1,readyCommit:!1}:G),l.currentPhase=1}return a.current.broadcastGameState(l),a.current.broadcastToGuests({type:"GAME_START",senderId:a.current.getPeerId(),data:{startingPlayerId:E,activePlayerId:E,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),l}return a.current.broadcastToGuests({type:"HOST_READY",senderId:a.current.getPeerId(),playerId:n.current??void 0,timestamp:Date.now()}),D});return}if(h&&a.current&&!i.current&&n.current!==null){a.current.sendMessageToHost({type:"PLAYER_READY",senderId:a.current.getPeerId(),playerId:n.current,timestamp:Date.now()}),o(_=>({..._,players:_.players.map(u=>u.id===n.current?{...u,isReady:!0}:u)}));return}((I=t.current)==null?void 0:I.readyState)===WebSocket.OPEN&&r.current.gameId&&n.current!==null&&t.current.send(JSON.stringify({type:"PLAYER_READY",gameId:r.current.gameId,playerId:n.current}))},[t,a,r,n,i,o]);return{startReadyCheck:s,cancelReadyCheck:d,playerReady:c}}function ps(e){const{updateState:t,sendWebrtcAction:a,webrtcIsHostRef:r,webrtcManagerRef:n}=e,i=$.useCallback((s,d)=>{t(c=>c.isGameStarted?c:{...c,players:c.players.map(h=>h.id===s?{...h,name:d}:h)})},[t]),o=$.useCallback((s,d)=>{t(h=>({...h,players:h.players.map(I=>I.id===s?{...I,color:d}:I)})),a!==null&&(r!=null&&r.current&&(n!=null&&n.current)?n.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:n.current.getPeerId(),data:{playerId:s,color:d},timestamp:Date.now()}):!(r!=null&&r.current)&&a&&a("CHANGE_PLAYER_COLOR",{playerId:s,color:d}))},[t,a,r,n]);return{updatePlayerName:i,changePlayerColor:o}}function ys(e){const{updateState:t}=e,a=$.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const c=d.players.find(u=>u.id===s);if(!c||c.deck.length===0)return d;const h=Ie(d),I=h.players.find(u=>u.id===s),_=I.deck.shift();return _&&I.hand.push(_),h})},[t]),r=$.useCallback((s,d)=>{d<=0||t(c=>{if(!c.isGameStarted)return c;const h=c.players.find(D=>D.id===s);if(!h||h.deck.length===0)return c;const I=Ie(c),_=I.players.find(D=>D.id===s),u=Math.min(d,_.deck.length);for(let D=0;D<u;D++){const T=_.deck.shift();T&&_.hand.push(T)}return I})},[t]),n=$.useCallback(s=>{t(d=>{if(!d.isGameStarted||!d.players.find(_=>_.id===s))return d;const h=Ie(d),I=h.players.find(_=>_.id===s);return I.deck=dr([...I.deck]),h})},[t]),i=$.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const c={...d},h=c.board[s.row][s.col].card;return h&&(h.isFaceDown=!1),{...c,board:Ne(c)}})},[t]),o=$.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const c={...d},h=c.board[s.row][s.col].card;return h&&(h.isFaceDown=!0),{...c,board:Ne(c)}})},[t]);return{drawCard:a,drawCardsBatch:r,shufflePlayerDeck:n,flipBoardCard:i,flipBoardCardFaceDown:o}}function hs(e){const{localPlayerIdRef:t,updateState:a}=e,r=$.useCallback((p,C,E)=>{a(l=>{var M,L;if(!l.isGameStarted)return l;const w=Ie(l),b=w.board[p.row][p.col].card;if(b){if(C==="Stun"&&(b.baseId==="luciusTheImmortal"||b.name.includes("Lucius")&&((M=b.types)!=null&&M.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(C)&&((L=b.statuses)==null?void 0:L.some(N=>N.type===C&&N.addedByPlayerId===E)))return l;b.statuses||(b.statuses=[]),b.statuses.push({type:C,addedByPlayerId:E})}return w})},[a]),n=$.useCallback((p,C)=>{a(E=>{if(!E.isGameStarted)return E;const l=Ie(E),w=l.board[p.row][p.col].card;if(w!=null&&w.statuses){const b=w.statuses.map(M=>M.type).lastIndexOf(C);b>-1&&w.statuses.splice(b,1)}return l.board=Ne(l),l})},[a]),i=$.useCallback((p,C,E)=>{a(l=>{if(!l.isGameStarted)return l;const w=Ie(l),b=w.board[p.row][p.col].card;if(b!=null&&b.statuses){const M=b.statuses.findIndex(L=>L.type===C&&L.addedByPlayerId===E);M>-1&&b.statuses.splice(M,1)}return w.board=Ne(w),w})},[a]),o=$.useCallback((p,C)=>{a(E=>{if(!E.isGameStarted)return E;const l=Ie(E),w=l.board[p.row][p.col].card;return w&&(w.powerModifier===void 0&&(w.powerModifier=0),w.powerModifier+=C),l})},[a]),s=$.useCallback((p,C,E)=>{a(l=>{var M;if(!l.isGameStarted)return l;const w=Ie(l),b=w.players.find(L=>L.id===p);if(b!=null&&b.announcedCard){if(["Support","Threat","Revealed"].includes(C)&&((M=b.announcedCard.statuses)==null?void 0:M.some(G=>G.type===C&&G.addedByPlayerId===E)))return l;b.announcedCard.statuses||(b.announcedCard.statuses=[]),b.announcedCard.statuses.push({type:C,addedByPlayerId:E})}return w})},[a]),d=$.useCallback((p,C)=>{a(E=>{var b;if(!E.isGameStarted)return E;const l=Ie(E),w=l.players.find(M=>M.id===p);if((b=w==null?void 0:w.announcedCard)!=null&&b.statuses){const M=w.announcedCard.statuses.map(L=>L.type).lastIndexOf(C);M>-1&&w.announcedCard.statuses.splice(M,1)}return l})},[a]),c=$.useCallback((p,C)=>{a(E=>{if(!E.isGameStarted)return E;const l=Ie(E),w=l.players.find(b=>b.id===p);return w!=null&&w.announcedCard&&(w.announcedCard.powerModifier===void 0&&(w.announcedCard.powerModifier=0),w.announcedCard.powerModifier+=C),l})},[a]),h=$.useCallback((p,C,E,l)=>{a(w=>{var L;if(!w.isGameStarted)return w;const b=Ie(w),M=b.players.find(G=>G.id===p);if(M!=null&&M.hand[C]){const G=M.hand[C];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(E)&&((L=G.statuses)==null?void 0:L.some(m=>m.type===E&&m.addedByPlayerId===l)))return w;G.statuses||(G.statuses=[]),G.statuses.push({type:E,addedByPlayerId:l})}return b})},[a]),I=$.useCallback((p,C,E)=>{a(l=>{if(!l.isGameStarted)return l;const w=Ie(l),b=w.players.find(L=>L.id===p),M=b==null?void 0:b.hand[C];if(M!=null&&M.statuses){const L=M.statuses.map(G=>G.type).lastIndexOf(E);L>-1&&M.statuses.splice(L,1),E==="Revealed"&&(M.statuses.some(N=>N.type==="Revealed")||delete M.revealedTo)}return w})},[a]),_=$.useCallback((p,C,E)=>{a(l=>{const w=l.players.find(L=>L.id===p);if(!(w!=null&&w.hand[C]))return l;const b=Ie(l),M=b.players.find(L=>L.id===p).hand[C];if(E==="all")M.revealedTo="all",M.statuses||(M.statuses=[]),M.statuses.some(L=>L.type==="Revealed"&&L.addedByPlayerId===p)||M.statuses.push({type:"Revealed",addedByPlayerId:p});else{(!M.revealedTo||M.revealedTo==="all"||!Array.isArray(M.revealedTo))&&(M.revealedTo=[]);const L=E.filter(G=>!M.revealedTo.includes(G));M.revealedTo.push(...L)}return b})},[a]),u=$.useCallback((p,C)=>{a(E=>{if(!E.board[p.row][p.col].card)return E;const w=Ie(E),b=w.board[p.row][p.col].card,M=b.ownerId;if(C==="all")b.revealedTo="all",M!==void 0&&(b.statuses||(b.statuses=[]),b.statuses.some(L=>L.type==="Revealed"&&L.addedByPlayerId===M)||b.statuses.push({type:"Revealed",addedByPlayerId:M}));else{(!b.revealedTo||b.revealedTo==="all"||!Array.isArray(b.revealedTo))&&(b.revealedTo=[]);const L=C.filter(G=>!b.revealedTo.includes(G));b.revealedTo.push(...L)}return w})},[a]),D=$.useCallback((p,C)=>{a(E=>{var M;const l=p.boardCoords?(M=E.board[p.boardCoords.row][p.boardCoords.col].card)==null?void 0:M.ownerId:p.ownerId;if(!l)return E;const w=Ie(E),b=w.revealRequests.find(L=>L.fromPlayerId===C&&L.toPlayerId===l);return b?b.cardIdentifiers.some(G=>JSON.stringify(G)===JSON.stringify(p))||b.cardIdentifiers.push(p):w.revealRequests.push({fromPlayerId:C,toPlayerId:l,cardIdentifiers:[p]}),w})},[a]),T=$.useCallback((p,C)=>{a(E=>{const l=E.revealRequests.findIndex(M=>M.toPlayerId===t.current&&M.fromPlayerId===p);if(l===-1)return E;const w=Ie(E),b=w.revealRequests[l];if(C){const{cardIdentifiers:M}=b;for(const L of M){let G=null;if(L.source==="board"&&L.boardCoords)G=w.board[L.boardCoords.row][L.boardCoords.col].card;else if(L.source==="hand"&&L.ownerId&&L.cardIndex!==void 0){const N=w.players.find(m=>m.id===L.ownerId);N&&(G=N.hand[L.cardIndex])}G&&(G.statuses||(G.statuses=[]),G.statuses.some(N=>N.type==="Revealed"&&N.addedByPlayerId===p)||G.statuses.push({type:"Revealed",addedByPlayerId:p}))}}return w.revealRequests.splice(l,1),w})},[a,t]),g=$.useCallback(p=>{a(C=>{const E=Ie(C);let l=null;if(p.source==="board"&&p.boardCoords)l=E.board[p.boardCoords.row][p.boardCoords.col].card;else if(p.source==="hand"&&p.playerId&&p.cardIndex!==void 0){const w=E.players.find(b=>b.id===p.playerId);w&&(l=w.hand[p.cardIndex])}return l&&(l.statuses&&(l.statuses=l.statuses.filter(w=>w.type!=="Revealed")),delete l.revealedTo),E})},[a]);return{addBoardCardStatus:r,removeBoardCardStatus:n,removeBoardCardStatusByOwner:i,modifyBoardCardPower:o,addAnnouncedCardStatus:s,removeAnnouncedCardStatus:d,modifyAnnouncedCardPower:c,addHandCardStatus:h,removeHandCardStatus:I,revealHandCard:_,revealBoardCard:u,requestCardReveal:D,respondToRevealRequest:T,removeRevealedStatus:g}}function ms(e){const{webrtcIsHostRef:t,sendWebrtcAction:a,webrtcManagerRef:r,localPlayerIdRef:n,getCardDefinition:i,commandCardIds:o,createDeck:s,updateState:d}=e,c=$.useCallback((T,g)=>{const p=ve();if(p&&!t.current)try{localStorage.setItem("webrtc_preferred_deck",g),y.info(`[changePlayerDeck] Saved deck preference: ${g}`)}catch(l){y.warn("[changePlayerDeck] Failed to save deck preference:",l)}const C=s(g,T,"Player "+T);if(d(l=>l.isGameStarted?l:{...l,players:l.players.map(w=>w.id===T?{...w,deck:C,selectedDeck:g,hand:[],discard:[],announcedCard:null,boardHistory:[]}:w)}),y.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${p}, isHost=${t.current}, hasSendAction=${!!a}, hasManager=${!!(r!=null&&r.current)}`),!p)return;const E=C.map(l=>({id:l.id,baseId:l.baseId,power:l.power,powerModifier:l.powerModifier||0,isFaceDown:l.isFaceDown||!1,statuses:l.statuses||[]}));t.current?r!=null&&r.current?(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:T,deckType:g,deck:E,deckSize:E.length}}),y.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${T}, deck ${g}, ${E.length} cards`)):y.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available"):a?(a("CHANGE_PLAYER_DECK",{playerId:T,deckType:g,deck:E,deckSize:E.length}),y.info(`[changePlayerDeck] Guest sending deck data to host: player ${T}, deck ${g}, ${E.length} cards`)):y.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[d,s,a,t,r,n]),h=$.useCallback((T,g)=>{const p=ve();let C=[];const E=new Map;for(const{cardId:w,quantity:b}of g.cards){const M=i(w);if(!M)continue;const L=o.has(w),G=L?De.Command:De.Custom,N=L?"CMD":"CUS";for(let m=0;m<b;m++){const O=(E.get(w)||0)+1;E.set(w,O),C.push({...M,id:`${N}_${w.toUpperCase()}_${O}`,baseId:w,deck:G,ownerId:T,ownerName:"Player "+T})}}if(C=dr(C),d(w=>w.isGameStarted||!w.players.find(M=>M.id===T)?w:{...w,players:w.players.map(M=>M.id===T?{...M,deck:C,selectedDeck:De.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:M)}),!p)return;const l=C.map(w=>({id:w.id,baseId:w.baseId,power:w.power,powerModifier:w.powerModifier||0,isFaceDown:w.isFaceDown||!1,statuses:w.statuses||[]}));t.current?r!=null&&r.current&&(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:T,deckType:De.Custom,deck:l,deckSize:l.length}}),y.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${T}, ${l.length} cards`)):a&&(a("CHANGE_PLAYER_DECK",{playerId:T,deckType:De.Custom,deck:l,deckSize:l.length}),y.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${T}, ${l.length} cards`))},[d,i,o,a,t,r,n]),I=$.useCallback((T,g,p,C)=>{d(E=>{if(!E.isGameStarted||E.board[p.row][p.col].card!==null)return E;const l=Ie(E),w=l.players.find(b=>b.id===T);if(w&&w.discard.length>g){const[b]=w.discard.splice(g,1);b.enteredThisTurn=!0,ar(b,T),(b.baseId==="luciusTheImmortal"||b.name.includes("Lucius"))&&(b.powerModifier===void 0&&(b.powerModifier=0),b.powerModifier+=2),b.statuses||(b.statuses=[]),b.statuses.push({type:"Resurrected",addedByPlayerId:T}),C&&C.forEach(M=>{var L;M.type!=="Resurrected"&&((L=b.statuses)==null||L.push({type:M.type,addedByPlayerId:T}))}),w.boardHistory||(w.boardHistory=[]),w.boardHistory.push(b.id),l.board[p.row][p.col].card=b,Ha(l.board,w),l.board=Ne(l)}return l})},[d]),_=$.useCallback((T,g)=>{d(p=>{const C=Ie(p),E=C.players.find(l=>l.id===T);if(E&&g.length>0){const l=new Set(g.map(b=>b.id)),w=E.deck.filter(b=>!l.has(b.id));E.deck=[...g,...w]}return C})},[d]),u=$.useCallback((T,g,p)=>{d(C=>{const E=Ie(C),l=E.players.find(w=>w.id===T);return l&&(p==="deck"?l.deck=g:p==="discard"&&(l.discard=g)),E})},[d]),D=$.useCallback((T,g)=>{d(p=>{if(!p.isGameStarted)return p;const C=Ie(p),E=C.players.find(l=>l.id===T);if(E&&E.discard.length>g){const[l]=E.discard.splice(g,1);E.hand.push(l)}return C})},[d]);return{changePlayerDeck:c,loadCustomDeck:h,resurrectDiscardedCard:I,reorderTopDeck:_,reorderCards:u,recoverDiscardedCard:D}}function Is(e){const{ws:t,webrtcManagerRef:a,webrtcIsHostRef:r,gameStateRef:n,scoreDeltaAccumulator:i,setGameState:o,updateState:s,abilityMode:d,setAbilityMode:c,createDeck:h}=e,I=$.useCallback(E=>{ve()&&a.current?r.current?o(w=>{const b=$a(w,E);return a.current&&a.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:a.current.getPeerId(),data:{activePlayerId:b.activePlayerId,currentPhase:b.currentPhase,turnNumber:b.turnNumber},timestamp:Date.now()}),b}):a.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:E},timestamp:Date.now()}):t.current&&t.current.readyState===WebSocket.OPEN&&(i.forEach((w,b)=>{clearTimeout(w.timerId),y.info(`[ScoreFlush] Flushing on toggle: player=${b}, delta=${w.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:n.current.gameId,playerId:b,delta:w.delta}))}),i.clear(),t.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:n.current.gameId,playerId:E})))},[t,a,r,n,i,o]),_=$.useCallback((E,l)=>{t.current&&t.current.readyState===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:n.current.gameId,playerId:E,enabled:l}))},[]),u=$.useCallback(E=>{const l=d&&c&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode);l&&c(null),s(w=>{if(!w.isGameStarted)return w;const b=Math.max(1,Math.min(E,4));return{...w,currentPhase:b,...b===4&&!l?{isScoringStep:!0}:{},...l?{isScoringStep:!1}:{}}})},[s,d,c]),D=$.useCallback(()=>{var w;d&&c&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&c(null);const E=n.current,l=ve();if(E.isGameStarted&&E.currentPhase===4&&E.isScoringStep&&!l){((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN&&(i.forEach((b,M)=>{clearTimeout(b.timerId),y.info(`[ScoreFlush] Flushing pending score: player=${M}, delta=${b.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:E.gameId,playerId:M,delta:b.delta}))}),i.clear(),t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:E.gameId})));return}if(l&&E.isGameStarted&&E.currentPhase===4&&E.isScoringStep){s(b=>yt(b));return}s(b=>{if(!b.isGameStarted)return b;const M=Ie(b),L=b.currentPhase+1;return b.preserveDeployAbilities||M.board.forEach(G=>{G.forEach(N=>{var m;(m=N.card)!=null&&m.statuses&&(N.card.statuses=N.card.statuses.filter(O=>O.type!=="readyDeploy"))})}),l&&L===4&&b.currentPhase===3?as(b,b.activePlayerId)?(M.isScoringStep=!0,M.currentPhase=4,M):(y.info(`[nextPhase] Player ${b.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),yt(b)):L===4&&b.currentPhase===3?(M.isScoringStep=!0,M.currentPhase=4,M):(M.board.forEach(G=>{G.forEach(N=>{var m;if((m=N.card)!=null&&m.statuses){const O=N.card.statuses.findIndex(P=>P.type==="Resurrected");if(O!==-1){const P=N.card.statuses[O].addedByPlayerId;N.card.statuses.splice(O,1),N.card.baseId!=="luciusTheImmortal"&&(N.card.statuses.push({type:"Stun",addedByPlayerId:P}),N.card.statuses.push({type:"Stun",addedByPlayerId:P}))}}})}),M.board=Ne(M),M.currentPhase=L,M)})},[s,d,c,n,t,i]),T=$.useCallback(()=>{s(E=>E.isGameStarted?(d&&c&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&c(null),E.isScoringStep?{...E,isScoringStep:!1,currentPhase:Math.max(1,E.currentPhase-1)}:{...E,currentPhase:Math.max(1,E.currentPhase-1)}):E)},[s,d,c]),g=$.useCallback(()=>{var l;ve()?s(w=>({...w,isRoundEndModalOpen:!1,currentRound:(w.currentRound||1)+1,players:w.players.map(b=>({...b,score:0}))})):((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&n.current.gameId&&(o(w=>({...w,isRoundEndModalOpen:!1,currentRound:(w.currentRound||1)+1,players:w.players.map(b=>({...b,score:0}))})),t.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:n.current.gameId})))},[o,s,t,n]),p=$.useCallback(()=>{o(E=>({...E,isRoundEndModalOpen:!1}))},[o]),C=$.useCallback(()=>{var l;if(ve()){const w=n.current,b=w.players.map(N=>{const m=N.selectedDeck||"SynchroTech";return{...N,hand:[],deck:h(m,N.id,N.name),discard:[],score:0,isReady:!1,announcedCard:null,boardHistory:[]}}),M=w.activeGridSize||8,L=[];for(let N=0;N<M;N++){const m=[];for(let O=0;O<M;O++)m.push({card:null});L.push(m)}const G={...w,players:b,board:L,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};o(G),n.current=G,a.current&&a.current.broadcastToGuests({type:"GAME_RESET",senderId:a.current.getPeerId(),data:{players:b.map(N=>({id:N.id,name:N.name,color:N.color,selectedDeck:N.selectedDeck,isDummy:N.isDummy,isDisconnected:N.isDisconnected,autoDrawEnabled:N.autoDrawEnabled,handSize:N.hand.length,deckSize:N.deck.length,discardSize:N.discard.length,...N.isDummy&&{hand:N.hand.map(m=>({id:m.id,baseId:m.baseId,name:m.name,imageUrl:m.imageUrl,power:m.power,powerModifier:m.powerModifier,ability:m.ability,ownerId:m.ownerId,color:m.color,deck:m.deck,isFaceDown:m.isFaceDown,types:m.types,faction:m.faction,statuses:m.statuses})),deck:N.deck.map(m=>({id:m.id,baseId:m.baseId,name:m.name,imageUrl:m.imageUrl,power:m.power,powerModifier:m.powerModifier,ability:m.ability,ownerId:m.ownerId,color:m.color,deck:m.deck,isFaceDown:m.isFaceDown,types:m.types,faction:m.faction,statuses:m.statuses})),discard:N.discard.map(m=>({id:m.id,baseId:m.baseId,name:m.name,imageUrl:m.imageUrl,power:m.power,powerModifier:m.powerModifier,ability:m.ability,ownerId:m.ownerId,color:m.color,deck:m.deck,isFaceDown:m.isFaceDown,types:m.types,faction:m.faction,statuses:m.statuses}))},score:N.score,isReady:N.isReady,announcedCard:N.announcedCard})),gameMode:G.gameMode,isPrivate:G.isPrivate,activeGridSize:G.activeGridSize,dummyPlayerCount:G.dummyPlayerCount,autoAbilitiesEnabled:G.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"RESET_GAME",gameId:n.current.gameId}))},[t,a,n,o,h]);return{toggleActivePlayer:I,toggleAutoDraw:_,setPhase:u,nextPhase:D,prevPhase:T,closeRoundEndModal:g,closeRoundEndModalOnly:p,resetGame:C}}function Es(e){const{ws:t,gameStateRef:a,updateState:r,updatePlayerScore:n,triggerFloatingText:i,clearTargetingMode:o}=e,s=$.useCallback((c,h,I,_,u)=>{var L,G;const D=a.current;if(!D.isGameStarted||D.isRoundEndModalOpen)return;const T=D.board.some(N=>N.some(m=>{var O,P;return((O=m.card)==null?void 0:O.ownerId)===u&&m.card.name.toLowerCase().includes("data liberator")&&((P=m.card.statuses)==null?void 0:P.some(A=>A.type==="Support"))})),g=D.board.length;let p=c,C=c,E=h,l=h;if(c===I)p=c,C=c,E=0,l=g-1;else if(h===_)E=h,l=h,p=0,C=g-1;else return;let w=0;const b=[];for(let N=p;N<=C;N++)for(let m=E;m<=l;m++){const P=D.board[N][m].card;if(P&&!((L=P.statuses)!=null&&L.some(A=>A.type==="Stun"))){const A=P.ownerId===u,v=(G=P.statuses)==null?void 0:G.some(x=>x.type==="Exploit"&&x.addedByPlayerId===u);if(A||T&&v&&P.ownerId!==u){const x=Math.max(0,P.power+(P.powerModifier||0)+(P.bonusPower||0));x>0&&(w+=x,b.push({row:N,col:m,text:`+${x}`,playerId:u}))}}}b.length>0&&i(b);const M=ve();if(M?r(N=>({...N,players:N.players.map(m=>m.id===u?{...m,score:Math.max(0,(m.score||0)+w)}:m)})):n(u,w),M||n(u,w),w>0&&D.currentPhase===4&&D.activePlayerId===u){const N=D.gameId;setTimeout(()=>{var m;o==null||o(),M?r(O=>yt(O)):((m=t.current)==null?void 0:m.readyState)===WebSocket.OPEN&&N&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:N}))},100)}},[i,n,r,t,a,o,yt]),d=$.useCallback((c,h,I,_,u,D)=>{var M,L;const T=a.current;if(!T.isGameStarted||T.isRoundEndModalOpen)return;const g=I>c?1:-1,p=_>h?1:-1,C=Math.abs(c-I);let E=0,l=0;const w=[];for(let G=0;G<=C;G++){const N=c+G*g,m=h+G*p;if(N<0||N>=T.board.length||m<0||m>=T.board.length)continue;const P=T.board[N][m].card;if(P&&!((M=P.statuses)!=null&&M.some(A=>A.type==="Stun"))&&P.ownerId===u){const v=Math.max(0,P.power+(P.powerModifier||0)+(P.bonusPower||0));v>0&&(E+=v,w.push({row:N,col:m,text:`+${v}`,playerId:u})),D&&((L=P.statuses)!=null&&L.some(x=>x.type==="Support"&&x.addedByPlayerId===u))&&(l+=1)}}D==="point_per_support"&&l>0&&(E+=l),w.length>0&&i(w);const b=ve();if(b?r(G=>({...G,players:G.players.map(N=>N.id===u?{...N,score:Math.max(0,(N.score||0)+E)}:N)})):n(u,E),b||n(u,E),D==="draw_per_support"&&l>0&&r(G=>{const N=Ie(G),m=N.players.find(O=>O.id===u);if(m&&m.deck.length>0)for(let O=0;O<l;O++)m.deck.length>0&&m.hand.push(m.deck.shift());return N}),E>0&&T.currentPhase===4&&T.activePlayerId===u){const G=T.gameId;setTimeout(()=>{var N;o==null||o(),b?r(m=>yt(m)):((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&G&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:G}))},500)}},[i,n,r,t,a,o,yt]);return{scoreLine:s,scoreDiagonal:d}}const Ts=e=>{const{updateState:t,rawJsonData:a}=e,r=$.useCallback((I,_,u,D)=>{t(T=>{var C,E;if(!T.isGameStarted||I.row<0||I.col<0)return T;const g=Ie(T),p=(E=(C=g.board[I.row])==null?void 0:C[I.col])==null?void 0:E.card;if(p){const l=p.statuses?p.statuses.map(w=>w.type):[];if(D&&p.statuses){p.statuses=p.statuses.filter(b=>b.type!==D);const w=p.statuses.map(b=>b.type);y.debug(`[markAbilityUsed] Removed status '${D}' from ${p.name} at [${I.row},${I.col}]: [${l.join(", ")}] -> [${w.join(", ")}]`)}else y.debug(`[markAbilityUsed] Called for ${p.name} at [${I.row},${I.col}] but no readyStatusToRemove specified. Current statuses: [${l.join(", ")}]`)}return g})},[t]),n=$.useCallback(I=>{t(_=>{var T,g;if(!_.isGameStarted||I.row<0||I.col<0)return _;const u=Ie(_),D=(g=(T=u.board[I.row])==null?void 0:T[I.col])==null?void 0:g.card;if(D&&(D.statuses||(D.statuses=[]),(D.ability||"").toLowerCase().includes("deploy:")&&!D.statuses.some(C=>C.type==="readyDeploy"))){const C=D.ownerId;if(C==null||C===0)return _;D.statuses.push({type:"readyDeploy",addedByPlayerId:C})}return u})},[t]),i=$.useCallback((I,_)=>{t(u=>{if(!u.isGameStarted)return u;const D=Ie(u),T=D.board[I.row][I.col].card;return T!=null&&T.statuses&&(T.statuses=T.statuses.filter(g=>g.type!==_)),D.board=Ne(D),D})},[t]),o=$.useCallback((I,_,u,D,T)=>{t(g=>{if(!g.isGameStarted)return g;const p=Ie(g);return _.forEach(({row:C,col:E})=>{var w;const l=p.board[C][E].card;if(l){if(u==="Stun"&&(l.baseId==="luciusTheImmortal"||l.name.includes("Lucius")&&((w=l.types)!=null&&w.includes("Hero"))))return;l.statuses||(l.statuses=[]),["Support","Threat","Revealed"].includes(u)?l.statuses.some(M=>M.type===u&&M.addedByPlayerId===D)||l.statuses.push({type:u,addedByPlayerId:D}):l.statuses.push({type:u,addedByPlayerId:D})}}),p})},[t]),s=$.useCallback((I,_)=>{t(u=>{if(!u.isGameStarted)return u;const D=Ie(u),T=D.board[I.row][I.col].card,g=D.board[_.row][_.col].card;return D.board[I.row][I.col].card=g,D.board[_.row][_.col].card=T,D.board=Ne(D),D})},[t]),d=$.useCallback((I,_,u)=>{t(D=>{if(!D.isGameStarted)return D;const T=Ie(D),g=T.board[I.row][I.col].card,p=T.board[_.row][_.col].card;if(g&&p&&g.statuses){const C=g.statuses.findIndex(E=>E.type===u);if(C>-1){const[E]=g.statuses.splice(C,1);p.statuses||(p.statuses=[]),p.statuses.push(E)}}return T.board=Ne(T),T})},[t]),c=$.useCallback((I,_)=>{t(u=>{if(!u.isGameStarted)return u;const D=Ie(u),T=D.board[I.row][I.col].card,g=D.board[_.row][_.col].card,p=["Support","Threat","LastPlayed"];if(T&&g&&T.statuses){const C=T.statuses.filter(l=>!p.includes(l.type)),E=T.statuses.filter(l=>p.includes(l.type));C.length>0&&(g.statuses||(g.statuses=[]),g.statuses.push(...C),T.statuses=E)}return D.board=Ne(D),D})},[t]),h=$.useCallback((I,_,u)=>{t(D=>{if(!D.isGameStarted)return D;const T=Ie(D);if(!a)return D;const g=a.tokenDatabase,p=Object.keys(g).find(l=>g[l].name===_);if(!p)return D;const C=g[p],E=T.players.find(l=>l.id===u);if(C&&T.board[I.row][I.col].card===null){const l={id:`TKN_${_.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:De.Tokens,name:_,baseId:C.baseId||p,imageUrl:C.imageUrl,fallbackImage:C.fallbackImage,power:C.power,ability:C.ability,flavorText:C.flavorText,color:C.color,types:C.types||["Unit"],faction:"Tokens",ownerId:u,ownerName:E==null?void 0:E.name,enteredThisTurn:!0,statuses:[]};ar(l,u),T.board[I.row][I.col].card=l}return T.board=Ne(T),T})},[t,a]);return{markAbilityUsed:r,applyGlobalEffect:o,swapCards:s,transferStatus:d,transferAllCounters:c,spawnToken:h,resetDeployStatus:n,removeStatusByType:i}};function gs(e){const{updateState:t,localPlayerIdRef:a,updatePlayerScore:r}=e,n=$.useCallback((o,s)=>{t(d=>{var T,g,p,C,E,l,w,b,M,L,G,N;if(!d.isGameStarted||s.target==="board"&&s.boardCoords&&d.board[s.boardCoords.row][s.boardCoords.col].card!==null&&o.source!=="counter_panel")return d;let c=!1;try{const m=localStorage.getItem("auto_abilities_enabled");c=m===null?!0:m==="true"}catch{c=!0}const h=c&&d.currentPhase===1&&o.source==="hand"&&s.target==="board"&&(((T=o.card.types)==null?void 0:T.includes("Unit"))||((g=o.card.types)==null?void 0:g.includes("Command"))),I=Ie(d);if(o.source==="board"&&["hand","deck","discard"].includes(s.target)&&!o.bypassOwnershipCheck){const m=o.card.ownerId,O=I.players.find(v=>v.id===m),P=m===a.current,A=!!(O!=null&&O.isDummy);if(!P&&!A)return d}let _=null;if(o.source==="board"&&s.target==="board"&&o.boardCoords){const m=I.board[o.boardCoords.row][o.boardCoords.col];m.card&&(_=m.card);const P=d.board[o.boardCoords.row][o.boardCoords.col].card||_;if(P&&((p=P.statuses)==null?void 0:p.some(v=>v.type==="Stun"))){const v=a.current,x=P.ownerId,F=d.players.find(z=>z.id===v),W=d.players.find(z=>z.id===x),j=v===x,X=(F==null?void 0:F.teamId)!==void 0&&(W==null?void 0:W.teamId)!==void 0&&F.teamId===W.teamId;if((j||X)&&!o.isManual)return d}}if(o.source==="counter_panel"&&o.statusType){const m=mt[o.statusType],O=(m==null?void 0:m.allowedTargets)??["board","hand"];if(!O.includes(s.target)&&!O.includes("board-facedown"))return d;let P=null;if(s.target==="board"&&s.boardCoords){if(P=I.board[s.boardCoords.row][s.boardCoords.col].card,O.includes("board-facedown")&&P&&!P.isFaceDown)return d}else if(s.playerId!==void 0){const A=I.players.find(v=>v.id===s.playerId);A&&(s.target==="hand"&&s.cardIndex!==void 0&&(P=A.hand[s.cardIndex]),s.target==="announced"&&(P=A.announcedCard||null),s.target==="deck"&&A.deck.length>0?s.deckPosition==="top"||!s.deckPosition?P=A.deck[0]:P=A.deck[A.deck.length-1]:s.target==="discard"&&A.discard.length>0&&(P=A.discard[A.discard.length-1]))}if(P){if(o.statusType==="Revealed"){const x=a.current;if(s.target==="board"&&P.ownerId===x||s.target==="hand"&&s.playerId===x)return d}if(o.statusType==="Stun"&&(P.baseId==="luciusTheImmortal"||P.name.includes("Lucius")&&((C=P.types)!=null&&C.includes("Hero"))))return I;const A=o.count||1;let v;if(o.ownerId!==void 0)v=o.ownerId;else if(o.card.ownerId!==void 0)v=o.card.ownerId;else{const x=I.players.find(F=>F.id===I.activePlayerId);v=x!=null&&x.isDummy?x.id:a.current!==null?a.current:0}if(o.statusType==="Power+")P.powerModifier===void 0&&(P.powerModifier=0),P.powerModifier+=1*A;else if(o.statusType==="Power-")P.powerModifier===void 0&&(P.powerModifier=0),P.powerModifier-=1*A;else if(P.statuses||(P.statuses=[]),o.replaceStatusType&&o.statusType)for(let x=0;x<A;x++){const F=P.statuses.findIndex(W=>W.type===o.replaceStatusType&&W.addedByPlayerId===v);F!==-1?P.statuses[F]={type:o.statusType,addedByPlayerId:v}:P.statuses.push({type:o.statusType,addedByPlayerId:v})}else for(let x=0;x<A;x++)["Support","Threat","Revealed"].includes(o.statusType)?P.statuses.some(W=>W.type===o.statusType&&W.addedByPlayerId===v)||P.statuses.push({type:o.statusType,addedByPlayerId:v}):P.statuses.push({type:o.statusType,addedByPlayerId:v});return s.target==="board"&&(I.board=Ne(I)),I}return d}const u=_?{..._}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const m=I.players.find(O=>O.id===o.playerId);if(m){const O=m.hand[o.cardIndex];if(O&&O.id===o.card.id&&O.ownerId===o.card.ownerId)m.hand.splice(o.cardIndex,1);else{const P=m.hand.findIndex(A=>A.id===o.card.id&&A.ownerId===o.card.ownerId);if(P!==-1)m.hand.splice(P,1);else return d}}}else if(o.source==="board"&&o.boardCoords){const m=I.board[o.boardCoords.row][o.boardCoords.col];if(m.card&&m.card.id===o.card.id&&m.card.ownerId===o.card.ownerId)I.board[o.boardCoords.row][o.boardCoords.col].card=null;else return d}else if(o.source==="discard"&&o.playerId!==void 0){const m=I.players.find(O=>O.id===o.playerId);if(m){let O=!1;if(o.cardIndex!==void 0){const P=m.discard[o.cardIndex];P&&P.id===o.card.id&&P.ownerId===o.card.ownerId&&(m.discard.splice(o.cardIndex,1),O=!0)}if(!O){const P=m.discard.findIndex(A=>A.id===o.card.id&&A.ownerId===o.card.ownerId);if(P!==-1)m.discard.splice(P,1);else return d}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const m=I.players.find(O=>O.id===o.playerId);if(m){const O=m.deck[o.cardIndex];if(O&&O.id===o.card.id&&O.ownerId===o.card.ownerId)m.deck.splice(o.cardIndex,1);else{const P=m.deck.findIndex(A=>A.id===o.card.id&&A.ownerId===o.card.ownerId);if(P!==-1)m.deck.splice(P,1);else return d}}}else if(o.source==="announced"&&o.playerId!==void 0){const m=I.players.find(O=>O.id===o.playerId);if(m)if(m.announcedCard&&m.announcedCard.id===o.card.id)m.announcedCard=null;else return d}if(["hand","deck","discard"].includes(s.target))u.statuses&&(u.statuses=u.statuses.filter(m=>m.type==="Revealed")),u.isFaceDown=!1,delete u.powerModifier,delete u.bonusPower,delete u.enteredThisTurn;else if(s.target==="board"&&(u.statuses||(u.statuses=[]),o.source!=="board"&&u.isFaceDown===void 0&&(u.isFaceDown=!1),o.source!=="board")){u.enteredThisTurn=!0;let m=u.ownerId;m===void 0&&(o.source==="token_panel"?m=I.activePlayerId??a.current??0:o.playerId!==void 0?m=o.playerId:m=a.current??0,u.ownerId=m),ar(u,m),o.source==="discard"&&(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius"))&&(u.powerModifier===void 0&&(u.powerModifier=0),u.powerModifier+=2)}if(s.target==="hand"&&s.playerId!==void 0){if((u.deck===De.Tokens||u.deck==="counter")&&(((E=u.types)==null?void 0:E.includes("Token"))||((l=u.types)==null?void 0:l.includes("Token Unit"))))return I.board[o.sourceBoardCoords.row][o.sourceBoardCoords.col].card=null,I;Ht(u);const O=I.players.find(A=>A.id===s.playerId);if(!O)return d;let P=s.cardIndex!==void 0?s.cardIndex:O.hand.length;if(o.source==="hand"&&o.playerId===s.playerId&&o.cardIndex!==void 0&&(o.cardIndex<P&&(P-=1),o.cardIndex===P))return d;O.hand.splice(P,0,u)}else if(s.target==="board"&&s.boardCoords){if(I.board[s.boardCoords.row][s.boardCoords.col].card===null){if(u.ownerId===void 0&&a.current!==null){const m=I.players.find(O=>O.id===a.current);m&&(u.ownerId=m.id,u.ownerName=m.name)}if(o.source!=="board"&&u.ownerId!==void 0){const m=I.players.find(O=>O.id===u.ownerId);m&&(m.boardHistory||(m.boardHistory=[]),m.boardHistory.push(u.id))}I.board[s.boardCoords.row][s.boardCoords.col].card=u}}else if(s.target==="discard"&&s.playerId!==void 0){if((u.deck===De.Tokens||u.deck==="counter")&&(((w=u.types)==null?void 0:w.includes("Token"))||((b=u.types)==null?void 0:b.includes("Token Unit"))))return I.board[o.sourceBoardCoords.row][o.sourceBoardCoords.col].card=null,I;Ht(u),u.statuses&&(u.statuses=u.statuses.filter(P=>P.type!=="Revealed"));const O=I.players.find(P=>P.id===s.playerId);O&&(u.ownerId===void 0&&(u.ownerId=s.playerId,u.ownerName=O.name),O.discard.some(A=>A.id===u.id)||O.discard.push(u))}else if(s.target==="deck"&&s.playerId!==void 0){if((u.deck===De.Tokens||u.deck==="counter")&&(((M=u.types)==null?void 0:M.includes("Token"))||((L=u.types)==null?void 0:L.includes("Token Unit"))))return I.board[o.sourceBoardCoords.row][o.sourceBoardCoords.col].card=null,I;Ht(u),u.statuses&&(u.statuses=u.statuses.filter(P=>P.type!=="Revealed"));const O=I.players.find(P=>P.id===s.playerId);if(!O)return d;u.ownerId===void 0&&(u.ownerId=s.playerId,u.ownerName=O.name),s.deckPosition==="top"||!s.deckPosition?O.deck.unshift(u):O.deck.push(u)}else if(s.target==="announced"&&s.playerId!==void 0){const m=I.players.find(O=>O.id===s.playerId);m&&(m.announcedCard&&(m.announcedCard.statuses&&(m.announcedCard.statuses=m.announcedCard.statuses.filter(O=>O.type==="Revealed")),delete m.announcedCard.enteredThisTurn,delete m.announcedCard.powerModifier,delete m.announcedCard.bonusPower,m.hand.push(m.announcedCard)),m.announcedCard=u)}if(o.source==="board"&&s.target!=="board"&&u.ownerId!==void 0){const m=I.players.find(O=>O.id===u.ownerId);m&&(m.boardHistory||(m.boardHistory=[]),m.boardHistory=m.boardHistory.filter(O=>O!==u.id))}if((o.source==="board"||s.target==="board")&&u.ownerId!==void 0){const m=I.players.find(O=>O.id===u.ownerId);m&&Ha(I.board,m)}if(o.source==="hand"&&s.target==="board"){const m=u;if(m.revealedTo==="all"||((G=m.statuses)==null?void 0:G.some(P=>P.type==="Revealed"))){const P=I.board.length;for(let A=0;A<P;A++)for(let v=0;v<P;v++){const x=I.board[A][v].card;if(x&&x.name.toLowerCase().includes("vigilant spotter")&&x.ownerId!==m.ownerId&&(I.board=Ne(I),(N=I.board[A][v].card.statuses)!=null&&N.some(W=>W.type==="Support"))){const W=I.players.find(j=>j.id===x.ownerId);W&&setTimeout(()=>{r(W.id,2)},0)}}}}return(o.source==="board"||s.target==="board")&&(I.board=Ne(I)),h&&(I.currentPhase=2),I})},[t,a,r]),i=$.useCallback((o,s)=>{t(d=>{if(!d.isGameStarted)return d;const c=Ie(d),h=c.board.length;if(o.row<0||o.row>=h||o.col<0||o.col>=h||s.row<0||s.row>=h||s.col<0||s.col>=h)return d;const I=c.board[o.row][o.col],_=c.board[s.row][s.col],u=I.card,D=_.card;return!u||!D?d:(c.board[o.row][o.col].card=D,c.board[s.row][s.col].card=u,c.board=Ne(c),c)})},[t]);return{moveItem:n,swapBoardCards:i}}function ws(e){const{ws:t,webrtcManager:a,gameStateRef:r,webrtcIsHostRef:n,setGameState:i}=e,o=$.useCallback((d,c,h,I,_,u)=>{var E,l,w,b,M,L,G;const D=r.current;if(typeof c!="number"){y.error(`[TargetingMode] Invalid playerId type: ${typeof c}, value:`,c);return}let T=[];I?T=I:T=Nt(d,D,c,_);let g=[];if(u)g=u;else if(g=[],d.mode,(E=d.payload)!=null&&E.filter&&d.mode==="SELECT_TARGET"){y.info("[TargetingMode] Calculating hand targets for action",{actionMode:d.mode,filterType:typeof d.payload.filter,hasActionType:!!d.payload.actionType});for(const N of D.players)N.hand&&N.hand.forEach((m,O)=>{try{d.payload.filter(m)&&(g.push({playerId:N.id,cardIndex:O}),y.debug(`[TargetingMode] Found hand target: player ${N.id}, card ${O}, card ${m.name}`))}catch(P){y.warn(`[TargetingMode] Filter failed for card ${m.name}:`,P)}});y.info(`[TargetingMode] Hand targets calculated: ${g.length} targets`)}else y.info("[TargetingMode] No hand targets calculated - no filter or wrong mode",{hasFilter:!!((l=d.payload)!=null&&l.filter),mode:d.mode});const p=d.mode==="SELECT_DECK",C={playerId:c,action:d,sourceCoords:h,timestamp:Date.now(),boardTargets:T,handTargets:g.length>0?g:void 0,isDeckSelectable:p||void 0,originalOwnerId:d.originalOwnerId};if(i(N=>({...N,targetingMode:C})),r.current.targetingMode=C,((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN&&D.gameId&&t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:D.gameId,targetingMode:C})),a.current)if(n.current)a.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((M=(b=a.current).getPeerId)==null?void 0:M.call(b))??void 0,data:{targetingMode:C},timestamp:Date.now()});else{const N=a.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((G=(L=a.current).getPeerId)==null?void 0:G.call(L))??void 0,data:{targetingMode:C},timestamp:Date.now()});y.info("[TargetingMode] Guest sent SET_TARGETING_MODE to host",{success:N,playerId:c,boardTargetsCount:T.length,handTargetsCount:g.length})}y.info(`[TargetingMode] Player ${c} (type: ${typeof c}) activated targeting mode`,{mode:d.mode,boardTargetsCount:T.length,handTargetsCount:g.length,isDeckSelectable:p||!1})},[t,a,r,n,i]),s=$.useCallback(()=>{var c,h,I,_,u;const d=r.current;i(D=>({...D,targetingMode:null})),r.current.targetingMode=null,((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&d.gameId&&t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:d.gameId})),a.current&&(n.current?a.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((I=(h=a.current).getPeerId)==null?void 0:I.call(h))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):a.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((u=(_=a.current).getPeerId)==null?void 0:u.call(_))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[t,a,r,n,i]);return{setTargetingMode:o,clearTargetingMode:s}}function _s(e){const{webrtcManagerRef:t,webrtcIsHostRef:a,setWebrtcIsHost:r,setConnectionStatus:n,setWebrtcHostId:i,gameStateRef:o,localPlayerIdRef:s}=e,d=$.useCallback(async()=>{var u;if(!t.current)return y.error("WebRTC manager not initialized"),null;try{r(!0),n("Connecting");const D=await t.current.initializeAsHost();i(D),n("Connected");const T=o.current.gameId;T&&Qt(D,T);const g=(u=o.current.players)==null?void 0:u.find(p=>p.id===s.current);return Lo({peerId:D,isHost:!0,playerName:(g==null?void 0:g.name)||null}),y.info("[initializeWebrtcHost] Saved host data for auto-restore"),D}catch(D){return y.error("Failed to initialize WebRTC host:",D),n("Disconnected"),null}},[t,r,n,i,o,s]),c=$.useCallback(async u=>{if(!t.current)return y.error("WebRTC manager not initialized"),!1;try{return r(!1),i(u),n("Connecting"),await t.current.initializeAsGuest(u),!0}catch(D){return y.error("Failed to connect as guest:",D),n("Disconnected"),!1}},[t,r,n,i]),h=$.useCallback((u,D)=>t.current?a.current?(y.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):t.current.sendAction(u,D):(y.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[t,a]),I=$.useCallback(u=>{var T,g;if(!t.current||a.current)return y.warn("[requestDeckView] Only guests can request deck view from host"),!1;const D={type:"REQUEST_DECK_VIEW",senderId:t.current.getPeerId(),playerId:a.current||(g=(T=t.current).getLocalPlayerId)==null?void 0:g.call(T),data:{targetPlayerId:u},timestamp:Date.now()};return t.current.sendMessageToHost(D)},[t,a]),_=$.useCallback((u,D,T)=>!t.current||a.current?(y.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):t.current.sendFullDeckToHost(u,D,T),[t,a]);return{initializeWebrtcHost:d,connectAsGuest:c,sendWebrtcAction:h,requestDeckView:I,sendFullDeckToHost:_}}function bs(){const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return y.warn("No custom WebSocket URL configured in settings."),null;let t=e.trim();return t.endsWith("/")&&(t=t.slice(0,-1)),t.startsWith("https://")?t=t.replace("https://","wss://"):t.startsWith("http://")&&(t=t.replace("http://","ws://")),!t.startsWith("ws://")&&!t.startsWith("wss://")?(y.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",t),t)}function As(e){const{gameStateRef:t,localPlayerIdRef:a,setGameState:r,setLocalPlayerId:n,setConnectionStatus:i,setGamesList:o,setLatestHighlight:s,setLatestNoTarget:d,setLatestDeckSelections:c,setLatestHandCardSelections:h,setClickWaves:I,setLatestFloatingTexts:_,setRemoteValidTargets:u,isManualExitRef:D,joiningGameIdRef:T,playerTokenRef:g,receivedServerStateRef:p,isJoinAttemptRef:C}=e,E=$.useRef(null),l=$.useRef(null),w=$.useCallback(()=>{if(ve()){i("Connected");return}if(D.current||E.current&&(E.current.readyState===WebSocket.OPEN||E.current.readyState===WebSocket.CONNECTING))return;const O=bs();if(!O){y.warn("No WebSocket URL configured in settings. Waiting for user input."),i("Disconnected"),l.current&&clearTimeout(l.current);return}try{E.current=new WebSocket(O)}catch(P){y.error("Failed to create WebSocket:",P),i("Disconnected"),l.current&&clearTimeout(l.current),l.current=window.setTimeout(w,oe.RECONNECT_DELAY);return}i("Connecting"),E.current.onopen=()=>{var v;p.current=!1,i("Connected");const P=localStorage.getItem("custom_ws_url");P&&P.trim()!==""&&localStorage.setItem("websocket_url",P.trim());const A=t.current;if(y.info("Current gameState on open:",A?`gameId=${A.gameId}`:"null"),y.info("playerTokenRef.current on open:",g.current?"YES":"NO"),A&&A.gameId&&((v=E.current)==null?void 0:v.readyState)===WebSocket.OPEN){let x=g.current;if(!x){try{const F=localStorage.getItem(nt);if(F){const W=JSON.parse(F);y.info("RECONNECTION_DATA_KEY:",W==null?void 0:W.gameId,A.gameId),W!=null&&W.playerToken&&(x=W.playerToken,g.current=x,y.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(F){console.warn("Failed to parse reconnection data:",F instanceof Error?F.message:String(F))}if(!x&&A.players&&a.current){const F=A.players.find(W=>W.id===a.current);F!=null&&F.playerToken&&(x=F.playerToken,g.current=x)}}y.info("JoinGame: Sending reconnection with token:",x?"YES":"NO","gameId:",A.gameId),E.current.send(JSON.stringify({type:"JOIN_GAME",gameId:A.gameId,playerToken:x}))}},E.current.onmessage=P=>{try{const A=JSON.parse(P.data);if(A.type==="GAMES_LIST")o(A.games);else if(A.type==="JOIN_SUCCESS"){if(A.isSpectator){n(null),y.info("Joined as spectator:",A.message||"Spectator mode"),T.current=null;return}n(A.playerId);const v=T.current||t.current.gameId;v&&A.playerId!==null&&A.playerToken?(g.current=A.playerToken,localStorage.setItem(nt,JSON.stringify({gameId:v,playerId:A.playerId,playerToken:A.playerToken,timestamp:Date.now()})),t.current.gameId===v&&Ea(t.current,A.playerId,A.playerToken)):A.playerId===null&&(pt(),g.current=void 0),T.current=null,A.playerId===1&&setTimeout(()=>{var x;((x=E.current)==null?void 0:x.readyState)===WebSocket.OPEN&&E.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe}))},oe.DECK_SYNC_DELAY)}else if(A.type==="CONNECTION_ESTABLISHED"){y.info("Connection acknowledged by server");const v=sessionStorage.getItem("pending_invite_game"),x=sessionStorage.getItem("pending_invite_name");v&&E.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),y.info("Auto-joining invite game:",v),E.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:v,playerName:x||"Player"})))}else if(A.type==="DECK_DATA_UPDATED")y.info("Deck data synced with server");else if(A.type==="ERROR")if(A.message.includes("not found")||A.message.includes("Dummy")){y.info("Game not found error - clearing state");const v=at();r(v),t.current=v,n(null),pt(),T.current=null}else if(A.message.includes("already started")&&C.current){y.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const v=at();r(v),t.current=v,n(null),pt(),T.current=null,C.current=!1}else console.warn("Server Error:",A.message);else if(A.type==="HIGHLIGHT_TRIGGERED")s(A.highlightData);else if(A.type==="NO_TARGET_TRIGGERED")d({coords:A.coords,timestamp:A.timestamp});else if(A.type==="DECK_SELECTION_TRIGGERED")c(v=>[...v,A.deckSelectionData]),setTimeout(()=>{c(v=>v.filter(x=>x.timestamp!==A.deckSelectionData.timestamp))},1e3);else if(A.type==="HAND_CARD_SELECTION_TRIGGERED")h(v=>[...v,A.handCardSelectionData]),setTimeout(()=>{h(v=>v.filter(x=>x.timestamp!==A.handCardSelectionData.timestamp))},1e3);else if(A.type==="FLOATING_TEXT_TRIGGERED")r(v=>({...v,floatingTexts:[...v.floatingTexts,A.floatingTextData].filter(x=>Date.now()-x.timestamp<oe.FLOATING_TEXT_DURATION)}));else if(A.type==="FLOATING_TEXT_BATCH_TRIGGERED")r(v=>({...v,floatingTexts:[...v.floatingTexts,...A.batch].filter(x=>Date.now()-x.timestamp<oe.FLOATING_TEXT_DURATION)}));else if(A.type==="SYNC_VALID_TARGETS")A.playerId,a.current;else if(A.type==="CLICK_WAVE_TRIGGERED")A.wave&&A.wave.clickedByPlayerId!==a.current&&(I(v=>[...v,A.wave]),setTimeout(()=>{I(v=>v.filter(x=>x.timestamp!==A.wave.timestamp))},600));else if(A.type==="TARGETING_MODE_SET"){const v=A.targetingMode;v&&(r(x=>({...x,targetingMode:v})),t.current.targetingMode=v,y.info("[TargetingMode] Received targeting mode from server",{playerId:v.playerId,mode:v.action.mode}))}else if(A.type==="TARGETING_MODE_CLEARED")r(v=>({...v,targetingMode:null})),t.current.targetingMode=null,y.debug("[TargetingMode] Cleared targeting mode from server");else if(A.type==="ABILITY_MODE_SET")A.abilityMode&&(r(v=>({...v,abilityMode:A.abilityMode})),y.info("[AbilityMode] Received ability mode from host",{playerId:A.abilityMode.playerId,mode:A.abilityMode.mode,sourceCard:A.abilityMode.sourceCardName}));else if(A.type==="ABILITY_TARGET_SELECTED")y.info("[Ability] Target selected",A.data);else if(A.type==="ABILITY_COMPLETED")r(v=>({...v,abilityMode:null})),y.info("[Ability] Ability completed",A.data);else if(A.type==="ABILITY_CANCELLED")r(v=>({...v,abilityMode:null})),y.info("[Ability] Ability cancelled");else if(A.type==="GAME_RESET")y.info("[GameReset] Received GAME_RESET message from server"),r(v=>{const x=A.activeGridSize||8,F=[];for(let j=0;j<x;j++){const X=[];for(let z=0;z<x;z++)X.push({card:null});F.push(X)}const W={...v,players:A.players||[],gameMode:A.gameMode,isPrivate:A.isPrivate,activeGridSize:A.activeGridSize,dummyPlayerCount:A.dummyPlayerCount,autoAbilitiesEnabled:A.autoAbilitiesEnabled,isGameStarted:A.isGameStarted,currentPhase:A.currentPhase,currentRound:A.currentRound,turnNumber:A.turnNumber,activePlayerId:A.activePlayerId,startingPlayerId:A.startingPlayerId,roundWinners:A.roundWinners||{},gameWinner:A.gameWinner,isRoundEndModalOpen:A.isRoundEndModalOpen,isReadyCheckActive:A.isReadyCheckActive,board:F,targetingMode:null,floatingTexts:[]};return t.current=W,W});else if(!A.type&&A.players&&A.board){const v=Ct(A),x=t.current;if(!x.isScoringStep&&v.isScoringStep&&v.currentPhase!==2){y.debug("Ignoring delayed scoring state update");return}if(x.isScoringStep&&(v.currentPhase!==x.currentPhase||v.activePlayerId!==x.activePlayerId||v.currentPhase!==4)&&(v.isScoringStep=!1),r(v),t.current=v,a.current!==null&&v.gameId){let W;try{const j=localStorage.getItem(nt);j&&(W=JSON.parse(j).playerToken)}catch{}if(!W&&v.players){const j=v.players.find(X=>X.id===a.current);j!=null&&j.playerToken&&(W=j.playerToken,g.current=W)}Ea(v,a.current,W)}}else console.warn("Unknown message type:",A.type,"keys:",Object.keys(A),"data:",A)}catch(A){y.error("Failed to parse message from server:",P.data,A)}},E.current.onclose=()=>{i("Disconnected"),D.current||(l.current&&clearTimeout(l.current),l.current=window.setTimeout(w,oe.RECONNECT_DELAY))},E.current.onerror=P=>y.error("WebSocket error event:",P)},[r,i,o,s,d,c,h,I,_,u,n,at,D,t,a,g,p,T]),b=$.useCallback(()=>{E.current&&(E.current.readyState===WebSocket.OPEN||E.current.readyState===WebSocket.CONNECTING)?E.current.close():w()},[E,w]),M=$.useCallback(O=>{var P;if(D.current=!1,((P=E.current)==null?void 0:P.readyState)===WebSocket.OPEN){T.current=O;let A=null;try{const x=localStorage.getItem(nt);x&&(A=JSON.parse(x))}catch{pt()}const v={type:"JOIN_GAME",gameId:O};(A==null?void 0:A.gameId)===O&&A.playerToken?(v.playerToken=A.playerToken,y.info(`JoinGame: Sending reconnection with token ${A.playerToken.substring(0,8)}... for player ${A.playerId}`)):y.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${A==null?void 0:A.gameId}, requestedGameId=${O}`),E.current.send(JSON.stringify(v))}else w(),T.current=O},[E,D,T,w]),L=$.useCallback((O,P="Player")=>{var A;D.current=!1,((A=E.current)==null?void 0:A.readyState)===WebSocket.OPEN?E.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:O,playerName:P})):(sessionStorage.setItem("pending_invite_game",O),sessionStorage.setItem("pending_invite_name",P),w())},[w]),G=$.useCallback(()=>{D.current=!1,pt();const O=Fa(),P={...at(),gameId:O,players:[Ba(1)]};return p.current=!0,setTimeout(()=>{var A;((A=E.current)==null?void 0:A.readyState)===WebSocket.OPEN&&(E.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:O})),E.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe})))},oe.DECK_SYNC_DELAY),{gameId:O,initialState:P}},[D,p]),N=$.useCallback(()=>{var O;((O=E.current)==null?void 0:O.readyState)===WebSocket.OPEN&&E.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[E]),m=$.useCallback((O,P,A,v)=>{var W;if(O.current)return;D.current=!0;const x=t.current.gameId,F=a.current;x&&P.current&&A(x);try{v(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),y.info("[exitGame] Cleared WebRTC persistence data")}catch(j){y.warn("[exitGame] Failed to clear WebRTC data:",j)}r(at()),n(null),pt(),E.current&&(E.current.onclose=null),((W=E.current)==null?void 0:W.readyState)===WebSocket.OPEN&&x&&F!==null&&E.current.send(JSON.stringify({type:"EXIT_GAME",gameId:x,playerId:F})),E.current&&E.current.close(),setTimeout(()=>{D.current=!1,w()},oe.RECONNECT_DELAY)},[t,a,D,r,n,E,w]);return{ws:E,reconnectTimeoutRef:l,connectWebSocket:w,forceReconnect:b,createGame:G,joinGame:M,joinAsInvite:L,exitGame:m,requestGamesList:N}}const Xe=new Map,Di=(e={})=>{const{abilityMode:t,setAbilityMode:a}=e,[r,n]=$.useState(at()),i=$.useRef(at()),o=$.useCallback(f=>{n(re=>{const ee=typeof f=="function"?f(re):f;return i.current=re,ve()&&V.current&&setTimeout(()=>{q.current&&(q.current.broadcastGameState(ee),y.debug(`[setGameStateWithDelta] Broadcast state: phase=${ee.currentPhase}, round=${ee.currentRound}`))},0),ee})},[]),[s,d]=$.useState(null),c=$.useRef(r),h=$.useRef(s),[I,_]=$.useState(null),[u,D]=$.useState("Connecting"),[T,g]=$.useState([]),[p,C]=$.useState(null),[E,l]=$.useState(null),[w,b]=$.useState(null),[M,L]=$.useState([]),[G,N]=$.useState([]),[m,O]=$.useState([]),[P,A]=$.useState(null),[v,x]=$.useState(!!Fe),[F,W]=$.useState(!1),[j,X]=$.useState(null),[z,ae]=$.useState(!1),V=$.useRef(!1),[ge,Ee]=$.useState(!1),[_e,ke]=$.useState(null),Re=$.useRef(!1),be=$.useRef(null),Be=$.useRef(!1),Lt=$.useRef(!1),dt=$.useRef(),ze=$.useRef(!1),q=$.useRef(null),Oe=$.useRef(()=>{}),xe=_s({webrtcManagerRef:q,webrtcIsHostRef:V,setWebrtcIsHost:ae,setConnectionStatus:D,setWebrtcHostId:X,gameStateRef:c,localPlayerIdRef:h}),{initializeWebrtcHost:je,connectAsGuest:Qe,sendWebrtcAction:et,requestDeckView:cr,sendFullDeckToHost:tt}=xe,ct=As({gameStateRef:c,localPlayerIdRef:h,setGameState:n,setLocalPlayerId:d,setConnectionStatus:D,setGamesList:g,setLatestHighlight:C,setLatestNoTarget:b,setLatestDeckSelections:L,setLatestHandCardSelections:N,setClickWaves:O,setLatestFloatingTexts:l,setRemoteValidTargets:A,isManualExitRef:Be,joiningGameIdRef:be,playerTokenRef:dt,receivedServerStateRef:ze,isJoinAttemptRef:Lt}),{ws:we,reconnectTimeoutRef:lt,connectWebSocket:lr,forceReconnect:Wa,joinGame:ur,joinAsInvite:Ya,requestGamesList:Ka}=ct;$.useEffect(()=>{Oe.current=o},[o]),$.useEffect(()=>{V.current=z},[z]),$.useEffect(()=>{const f=ve();if(W(f),f){q.current=es();const re=q.current.on(ee=>{Qa(ee)});return()=>{re()}}},[]),$.useEffect(()=>{if(!ve())return;const re=window.location.hash.slice(1);if(re&&new URLSearchParams(re).get("hostId"))return;const ee="webrtc_auto_restore_attempted";if(sessionStorage.getItem(ee))return;sessionStorage.setItem(ee,"true");const te=Go();if(te==="none"){sessionStorage.removeItem(ee);return}setTimeout(async()=>{var de,ne;if(!q.current){y.warn("[Auto-restore] WebRTC manager not ready");return}try{if(te==="host"){We.current=!0,y.info("[Auto-restore] Setting restoration flag to prevent premature exit");const le=Pa(),Z=ya();if(!le||!Z){y.warn("[Auto-restore] Missing host data or state data"),rt(),We.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}y.info(`[Auto-restore] Restoring host session: old peerId=${le.peerId}`);const Te=await q.current.initializeAsHost();V.current=!0,ae(!0),X(Te),D("Connected"),(de=Z.gameState)!=null&&de.gameId&&(Qt(Te,Z.gameState.gameId),y.info(`[Auto-restore] Broadcasted NEW host peerId ${Te} for game ${Z.gameState.gameId}`)),(Z.gameState||Z.localPlayerId!==null)&&(Z.gameState&&(c.current=Z.gameState),Z.localPlayerId!==null&&(h.current=Z.localPlayerId),Re.current=!0,setTimeout(()=>{Re.current=!1},1e4),setTimeout(()=>{var Ae;Z.gameState&&(n(Z.gameState),y.info(`[Auto-restore] Restored game state with ${((Ae=Z.gameState.players)==null?void 0:Ae.length)||0} players, gameId=${Z.gameState.gameId}`)),Z.localPlayerId!==null&&(d(Z.localPlayerId),y.info(`[Auto-restore] Restored local player ID: ${Z.localPlayerId}`))},0)),setTimeout(()=>{if(We.current=!1,y.info("[Auto-restore] Cleared restoration flag"),q.current&&Z.gameState){const Ae=Z.gameState.players.filter(Me=>!Me.isDummy&&Me.id!==Z.localPlayerId);Ae.length>0&&(y.info(`[Auto-restore] Requesting deck data from ${Ae.length} guest players`),q.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:q.current.getPeerId(),timestamp:Date.now()}))}},500),y.info("[Auto-restore] Host session restoration initiated")}else if(te==="guest"){We.current=!0,y.info("[Auto-restore] Setting restoration flag to prevent premature exit");const le=ka(),Z=ya();if(!le||!Z){y.warn("[Auto-restore] Missing guest data or state data"),rt(),We.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}y.info(`[Auto-restore] Restoring guest session: old hostPeerId=${le.hostPeerId}, playerId=${le.playerId}`),V.current=!1,ae(!1),D("Connecting");let Te=le.hostPeerId;if((ne=Z.gameState)!=null&&ne.gameId){const Ae=Bt(Z.gameState.gameId);Ae&&Ae.peerId&&(Te=Ae.peerId,y.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Te}`))}if(X(Te),le.playerId!==null){y.info(`[Auto-restore] Reconnecting as existing player ${le.playerId} to host ${Te}`);try{await q.current.initializeAsReconnectingGuest(Te,le.playerId),D("Connected"),y.info("[Auto-restore] Successfully reconnected to host")}catch(Ae){y.error("[Auto-restore] Failed to reconnect to host:",Ae),D("Disconnected"),rt(),y.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),We.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else y.info("[Auto-restore] Connecting as new player"),await q.current.initializeAsGuest(Te),D("Connected");(Z.gameState||Z.localPlayerId!==null)&&(Z.gameState&&(c.current=Z.gameState),Z.localPlayerId!==null&&(h.current=Z.localPlayerId),Re.current=!0,setTimeout(()=>{Re.current=!1},1e4),setTimeout(()=>{var Ae,Me;if(Z.gameState&&(n(Z.gameState),y.info(`[Auto-restore] Restored game state with ${((Ae=Z.gameState.players)==null?void 0:Ae.length)||0} players, gameId=${Z.gameState.gameId}, isGameStarted=${Z.gameState.isGameStarted}`),Z.localPlayerId!==null)){const ue=(Me=Z.gameState.players)==null?void 0:Me.some(pe=>pe.id===Z.localPlayerId);y.info(`[Auto-restore] Player ${Z.localPlayerId} exists in restored state: ${ue}`)}Z.localPlayerId!==null&&(d(Z.localPlayerId),y.info(`[Auto-restore] Restored local player ID: ${Z.localPlayerId}`))},0)),setTimeout(()=>{We.current=!1,y.info("[Auto-restore] Cleared restoration flag")},100),y.info("[Auto-restore] Guest session restoration initiated")}}catch(le){y.error("[Auto-restore] Failed to restore session:",le),rt(),We.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),$.useEffect(()=>{if(!F||!q.current)return;const f=window.location.hash.slice(1);if(!f)return;const ee=new URLSearchParams(f).get("hostId");ee&&Qe(ee)},[F]),$.useEffect(()=>{c.current=r},[r]),$.useEffect(()=>{h.current=s},[s]),$.useEffect(()=>{if(!r||!r.players||!s)return;const f=vo(r.players,s);Oo.preloadMany(f,"low")},[r==null?void 0:r.players,s]);const za=ls({ws:we,webrtcManager:q,gameStateRef:c,localPlayerIdRef:h,webrtcIsHostRef:V,setLatestHighlight:C,setLatestFloatingTexts:l,setLatestNoTarget:b,setLatestDeckSelections:L,setLatestHandCardSelections:N,setClickWaves:O,setGameState:n}),{triggerHighlight:qa,triggerFloatingText:fr,triggerNoTarget:Va,triggerDeckSelection:ja,triggerHandCardSelection:Ja,syncValidTargets:Xa,triggerClickWave:Za}=za,We=$.useRef(!1);$.useEffect(()=>{if(!F||!V.current||!(r!=null&&r.gameId))return;const f=r.gameId,re=()=>{var de;const te=(de=q.current)==null?void 0:de.getPeerId();te&&f&&Qt(te,f)};re();const ee=setInterval(re,2e3);return()=>clearInterval(ee)},[F,r==null?void 0:r.gameId]),$.useEffect(()=>{if(!F||V.current||!(r!=null&&r.gameId))return;const f=r.gameId,re=de=>{var ne;X(de),D("Connecting"),(ne=q.current)==null||ne.initializeAsReconnectingGuest(de,h.current||0).then(()=>{D("Connected")}).catch(le=>{y.error("[Guest Auto-Reconnect] Failed to reconnect:",le),D("Disconnected")})},ee=de=>{const ne=`webrtc_host_${f}`;if(!(de.key!==ne||!de.newValue))try{const Z=JSON.parse(de.newValue).peerId;Z&&Z!==j&&re(Z)}catch(le){y.error("[Guest Auto-Reconnect] Failed to parse storage event:",le)}},te=setInterval(()=>{const de=Bt(f);de&&de.peerId!==j&&(y.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${de.peerId}`),re(de.peerId))},2e3);return window.addEventListener("storage",ee),()=>{window.removeEventListener("storage",ee),clearInterval(te)}},[F,r==null?void 0:r.gameId,j]),$.useEffect(()=>{const f=setInterval(()=>{n(re=>{const ee=Date.now(),te=re.floatingTexts||[],de=te.filter(ne=>ee-ne.timestamp<oe.FLOATING_TEXT_DURATION);return de.length!==te.length?{...re,floatingTexts:de}:re})},oe.DECK_SYNC_DELAY);return()=>clearInterval(f)},[]);const Qa=$.useCallback(f=>{var re,ee,te;switch(f.type){case"peer_open":(re=f.data)!=null&&re.peerId&&(X(f.data.peerId),y.info(`WebRTC peer opened with ID: ${f.data.peerId}`));break;case"guest_connected":y.info("Guest connected via WebRTC:",(ee=f.data)==null?void 0:ee.peerId);break;case"connected_to_host":(te=f.data)!=null&&te.hostPeerId&&j!==f.data.hostPeerId&&(X(f.data.hostPeerId),y.info(`Updated webrtcHostId to: ${f.data.hostPeerId}`)),D("Connected"),Ee(!1),ke(null),Re.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(y.warn("WebRTC peer disconnected"),D("Disconnected"),Ee(!0),!V.current&&j&&r)try{const de={hostPeerId:j,playerId:s,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(de)),y.info("[Reconnection] Stored reconnection data before disconnect"),rn(j)}catch(de){y.error("[Reconnection] Failed to store data:",de)}break;case"message_received":tn(f.data);break;case"error":y.error("WebRTC error:",f.data);break}},[r,s,j,z]),en=$.useCallback((f,re)=>{if(y.info(`[handleWebrtcGuestJoin] Called for guest ${f}, isHost: ${V.current}`),!V.current||!q.current){y.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const ee=(re==null?void 0:re.preferredDeck)||"Random";n(te=>{if(!te)return y.error("[handleWebrtcGuestJoin] No previous state"),te;y.info(`[handleWebrtcGuestJoin] Current state has ${te.players.length} players`);const de=te.players.map(ue=>ue.id);let ne=1;for(;de.includes(ne);)ne++;const le={id:ne,name:`Player ${ne}`,color:ht[(ne-1)%ht.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:ee,boardHistory:[],autoDrawEnabled:!0},Z={...te,players:[...te.players,le]},Te=te.board.map(ue=>ue.map(pe=>({...pe,card:pe.card?{id:pe.card.id,baseId:pe.card.baseId,ownerId:pe.card.ownerId,name:pe.card.name,imageUrl:pe.card.imageUrl,power:pe.card.power,ability:pe.card.ability,isFaceDown:pe.card.isFaceDown,statuses:pe.card.statuses||[]}:null}))),Ae=ue=>ue.map(pe=>({id:pe.id,baseId:pe.baseId,name:pe.name,imageUrl:pe.imageUrl,power:pe.power,powerModifier:pe.powerModifier,ability:pe.ability,ownerId:pe.ownerId,color:pe.color,deck:pe.deck,isFaceDown:pe.isFaceDown,types:pe.types,faction:pe.faction,statuses:pe.statuses}));q.current.acceptGuestMinimal(f,{playerId:ne,gameId:te.gameId,isGameStarted:te.isGameStarted,players:Z.players.map(ue=>ue.isDummy?{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,hand:Ae(ue.hand||[]),deck:Ae(ue.deck||[]),discard:Ae(ue.discard||[]),handSize:ue.hand.length,deckSize:ue.deck.length,discardSize:ue.discard.length}:{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,deckSize:ue.deck.length,handSize:ue.hand.length,discardSize:ue.discard.length}),deckSelections:Z.players.map(ue=>({id:ue.id,selectedDeck:ue.selectedDeck})),gameMode:te.gameMode,currentRound:te.currentRound,currentPhase:te.currentPhase,activePlayerId:te.activePlayerId,startingPlayerId:te.startingPlayerId,activeGridSize:te.activeGridSize,board:Te},ne),q.current.broadcastGameState(Z,f),q.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:q.current.getPeerId(),data:{playerId:ne,selectedDeck:ee},timestamp:Date.now()});const Me=Z.players.find(ue=>ue.id===h.current);if(Me&&Me.deck.length>0){const ue=Me.deck.map(pe=>({id:pe.id,baseId:pe.baseId,power:pe.power,powerModifier:pe.powerModifier||0,isFaceDown:pe.isFaceDown||!1,statuses:pe.statuses||[]}));q.current.sendToGuest(f,{type:"CHANGE_PLAYER_DECK",senderId:q.current.getPeerId(),playerId:Me.id,data:{playerId:Me.id,deckType:Me.selectedDeck,deck:ue,deckSize:ue.length},timestamp:Date.now()}),y.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${Me.selectedDeck}, ${ue.length} cards`)}return Z})},[]),Gt=$.useCallback(f=>{const re=V.current;if(y.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!q.current}, webrtcIsHostRef.current=${re}`),!q.current||!re){y.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}q.current.broadcastGameState(f)},[]),tn=$.useCallback(f=>{var re,ee,te,de,ne,le,Z,Te,Ae,Me,ue,pe,hr,mr,Ir,Er,Tr,gr,wr,_r,br,Ar,Sr,Cr,Dr,Rr,Pr,kr,Or,vr,Nr,Mr,Lr,Gr,xr,Ur,$r,Hr,Fr,Br,Wr,Yr,Kr,zr,qr,Vr,jr,Jr,Xr,Zr,Qr,ea,ta,ra,aa,na,oa,sa,ia,da,ca,la,ua;if(!(!f||!f.type))switch(y.info(`[handleWebrtcMessage] Received: ${f.type}`),f.type){case"JOIN_ACCEPT_MINIMAL":if(y.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${f.playerId}`),f.data){const S=f.data;y.info(`[handleWebrtcMessage] Creating minimal state with ${((re=S.players)==null?void 0:re.length)||0} players`);const R={gameId:S.gameId||Fa(),isGameStarted:S.isGameStarted||!1,isPrivate:!1,activeGridSize:S.activeGridSize||4,gameMode:S.gameMode||er.FreeForAll,dummyPlayerCount:0,players:((ee=S.players)==null?void 0:ee.map(k=>{if((k.isDummy||!1)&&k.hand&&k.deck&&k.discard)return{id:k.id,name:k.name,color:k.color,isDummy:!0,isReady:k.isReady||!1,score:k.score||0,hand:k.hand||[],deck:k.deck||[],discard:k.discard||[],announcedCard:null,selectedDeck:k.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const Y=[],U=[],K=[];for(let H=0;H<(k.handSize||0);H++)Y.push({id:`placeholder_${k.id}_hand_${H}`,name:"?",isPlaceholder:!0,ownerId:k.id,deck:k.selectedDeck||"Random",color:k.color});for(let H=0;H<(k.deckSize||0);H++)U.push({id:`placeholder_${k.id}_deck_${H}`,name:"?",isPlaceholder:!0,ownerId:k.id,deck:k.selectedDeck||"Random",color:k.color});for(let H=0;H<(k.discardSize||0);H++)K.push({id:`placeholder_${k.id}_discard_${H}`,name:"?",isPlaceholder:!0,ownerId:k.id,deck:k.selectedDeck||"Random",color:k.color});return{id:k.id,name:k.name,color:k.color,isDummy:!1,isReady:k.isReady||!1,score:k.score||0,hand:Y,deck:U,discard:K,announcedCard:null,selectedDeck:k.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:S.board||Oa(),hostId:1,currentPhase:S.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:S.currentRound||1,turnNumber:S.turnNumber||1,activePlayerId:S.activePlayerId??null,startingPlayerId:S.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};n(R),f.playerId!==void 0&&(d(f.playerId),y.info(`[handleWebrtcMessage] Set local player ID to ${f.playerId}`)),n(k=>{const B=k.players.map(Y=>{var K;const U=(K=S.players)==null?void 0:K.find(H=>H.id===Y.id);if(Y.id===f.playerId){const J=Y.deck.length===0||Y.deck.some(Q=>Q.isPlaceholder)||Y.deck.length!==30;if(U!=null&&U.selectedDeck&&J){const Q=Ze(U.selectedDeck,Y.id,Y.name);y.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${Q.length} cards from ${U.selectedDeck}`),q.current&&Q.length>0&&setTimeout(()=>{const ye=Q.map(se=>({id:se.id,baseId:se.baseId,power:se.power,powerModifier:se.powerModifier||0,isFaceDown:se.isFaceDown||!1,statuses:se.statuses||[]}));q.current.sendAction("DECK_DATA_UPDATE",{playerId:f.playerId,deck:ye,deckSize:ye.length}),y.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${U.selectedDeck}, ${ye.length} cards`)},0);const ce=[...Y.hand],fe=[...Q];if(S.isGameStarted&&ce.length===0&&fe.length>0){for(let se=0;se<6&&se<fe.length;se++){const Se=fe[0];fe.splice(0,1),ce.push(Se)}y.info(`[JOIN_ACCEPT_MINIMAL] Drew ${ce.length} cards, deck now has ${fe.length} cards`)}return{...Y,deck:fe,hand:ce,selectedDeck:U.selectedDeck}}}return Y});return{...k,players:B}});try{const k=(te=q.current)==null?void 0:te.getHostPeerId();k&&Ft({hostPeerId:k,playerId:f.playerId,playerName:((de=R.players.find(B=>B.id===f.playerId))==null?void 0:de.name)||null,isHost:!1})}catch(k){y.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",k)}}break;case"JOIN_ACCEPT":if(y.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${f.playerId}, hasState: ${!!((ne=f.data)!=null&&ne.gameState)}`),(le=f.data)!=null&&le.gameState){const S=f.data.gameState;if(y.info(`[handleWebrtcMessage] Setting game state with ${((Z=S.players)==null?void 0:Z.length)||0} players`),n(S),f.playerId!==void 0){d(f.playerId),y.info(`[handleWebrtcMessage] Set local player ID to ${f.playerId}`);try{const R=(Te=q.current)==null?void 0:Te.getHostPeerId(),k=S.players.find(B=>B.id===f.playerId);R&&Ft({hostPeerId:R,playerId:f.playerId,playerName:(k==null?void 0:k.name)||null,isHost:!1})}catch(R){y.warn("[JOIN_ACCEPT] Failed to save guest data:",R)}}}break;case"JOIN_ACCEPT_BINARY":if(y.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${f.playerId}`),f.data instanceof Uint8Array)try{const S=zo(f.data),R=S;if(y.info(`[handleWebrtcMessage] Expanded binary state with ${((Ae=R.players)==null?void 0:Ae.length)||0} players`),n(R),f.playerId!==void 0){d(f.playerId),y.info(`[handleWebrtcMessage] Set local player ID to ${f.playerId}`);try{const k=(Me=q.current)==null?void 0:Me.getHostPeerId(),B=R.players.find(Y=>Y.id===f.playerId);k&&Ft({hostPeerId:k,playerId:f.playerId,playerName:(B==null?void 0:B.name)||null,isHost:!1})}catch(k){y.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",k)}}y.info(`[handleWebrtcMessage] Received optimized binary game state: ${f.data.byteLength} bytes`)}catch(S){y.error("[handleWebrtcMessage] Failed to deserialize binary game state:",S)}break;case"STATE_UPDATE_COMPACT":if(V.current){if(f.senderId&&f.senderId!==((ue=q.current)==null?void 0:ue.getPeerId())&&(y.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${f.senderId}`),(pe=f.data)!=null&&pe.gameState)){const S=f.data.gameState;n(R=>{const k=f.playerId;if(k===void 0)return y.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),R;const B=R.players.map(K=>{if(K.id===k){const H=S.players.find(J=>J.id===k);if(H){const J=ye=>{const se=Ye(ye.baseId);return se?{...se,id:ye.id,baseId:ye.baseId,ownerId:k,power:ye.power,powerModifier:ye.powerModifier,isFaceDown:ye.isFaceDown,statuses:ye.statuses||[]}:{id:ye.id,baseId:ye.baseId,name:"Unknown",power:0}},Q=(H.handCards||[]).map(J),ce=(H.deckCards||[]).map(J),fe=(H.discardCards||[]).map(J);return y.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${k}: hand=${Q.length}, deck=${ce.length}, discard=${fe.length}`),{...K,hand:Q,deck:ce,discard:fe,handSize:Q.length,deckSize:ce.length,discardSize:fe.length}}}return K}),Y=S.board?S.board.map(K=>K.map(H=>{if(!H||!H.card)return H;const J=Ye(H.card.baseId||H.card.id);if(J){const Q=H.card.ownerId;return{...H,card:{...J,id:H.card.id,baseId:H.card.baseId||H.card.id,ownerId:Q,ownerName:H.card.ownerName,power:H.card.power,powerModifier:H.card.powerModifier,isFaceDown:H.card.isFaceDown||!1,statuses:H.card.statuses||[],enteredThisTurn:H.card.enteredThisTurn,deck:H.card.deck}}}return H})):R.board,U={...R,...S,players:B,board:Y};return q.current&&setTimeout(()=>{q.current.broadcastGameState(U,f.senderId)},0),U})}}else if(!V.current&&((hr=f.data)!=null&&hr.gameState)){const S=f.data.recipientPlayerId??null,R=f.data.gameState;if(Re.current){n(k=>({...k,currentPhase:R.currentPhase,activePlayerId:R.activePlayerId,startingPlayerId:R.startingPlayerId,isReadyCheckActive:R.isReadyCheckActive,isGameStarted:R.isGameStarted}));return}n(k=>{const B=S===null||S===h.current;y.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${S}, local=${h.current}, isForLocal=${B}`);const Y=R.players.map(H=>{var Q,ce;const J=k.players.find(fe=>fe.id===H.id);if(H.id===h.current&&J){const fe=se=>{if(se.baseId){const Ce=Ye(se.baseId);if(Ce)return{...Ce,id:se.id,ownerId:h.current,power:se.power,powerModifier:se.powerModifier,isFaceDown:se.isFaceDown,statuses:se.statuses||[]}}return J.hand.find(Ce=>Ce.id===se.id)||J.deck.find(Ce=>Ce.id===se.id)||J.discard.find(Ce=>Ce.id===se.id)||{id:se.id,name:"Unknown",power:0}};if(H.handCards&&H.handCards.length>0||H.deckCards&&H.deckCards.length>0||H.discardCards&&H.discardCards.length>0){const se=(H.handCards||[]).map(fe),Se=(H.deckCards||[]).map(fe),Ce=(H.discardCards||[]).map(fe);return se.forEach((me,he)=>{var ie,Le;(Le=(ie=H.handCards)==null?void 0:ie[he])!=null&&Le.baseId&&!me.baseId&&(me.baseId=H.handCards[he].baseId)}),Se.forEach((me,he)=>{var ie,Le;(Le=(ie=H.deckCards)==null?void 0:ie[he])!=null&&Le.baseId&&!me.baseId&&(me.baseId=H.deckCards[he].baseId)}),Ce.forEach((me,he)=>{var ie,Le;(Le=(ie=H.discardCards)==null?void 0:ie[he])!=null&&Le.baseId&&!me.baseId&&(me.baseId=H.discardCards[he].baseId)}),y.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${se.length} hand, ${Se.length} deck, ${Ce.length} discard`),{...H,hand:se,deck:Se,discard:Ce}}else{const se=(H.handIds||[]).map(me=>J.hand.find(ie=>ie.id===me)||J.deck.find(ie=>ie.id===me)||J.discard.find(ie=>ie.id===me)||{id:me,name:"?",isPlaceholder:!1}),Se=(H.deckIds||[]).map(me=>J.deck.find(ie=>ie.id===me)||J.hand.find(ie=>ie.id===me)||J.discard.find(ie=>ie.id===me)||{id:me,name:"?",isPlaceholder:!1}),Ce=(H.discardIds||[]).map(me=>J.discard.find(ie=>ie.id===me)||J.hand.find(ie=>ie.id===me)||J.deck.find(ie=>ie.id===me)||{id:me,name:"?",isPlaceholder:!1});return y.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${se.length} hand, ${Se.length} deck, ${Ce.length} discard`),{...H,hand:se,deck:Se,discard:Ce}}}else{const fe=H.deckSize??((Q=H.deck)==null?void 0:Q.length)??0,ye=H.handSize??((ce=H.hand)==null?void 0:ce.length)??0,se=H.deckCards&&H.deckCards.length>0;let Se;if(se){const he=ie=>{if(ie.baseId){const Le=Ye(ie.baseId);if(Le)return{...Le,id:ie.id,baseId:ie.baseId,ownerId:H.id,power:ie.power,powerModifier:ie.powerModifier,isFaceDown:ie.isFaceDown,statuses:ie.statuses||[]}}return{id:ie.id,name:"Unknown",power:0}};Se=H.deckCards.map(he),y.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${H.id}: ${Se.length} cards`)}else if(J&&J.deck.length>0&&J.deck.some(ie=>!ie.isPlaceholder))Se=J.deck.slice(0,fe),y.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${H.id}: ${Se.length} cards`);else{Se=[];for(let ie=0;ie<fe;ie++)Se.push({id:`placeholder_${H.id}_deck_${ie}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color})}const Ce=(he,ie)=>{if(he.baseId&&!he.isPlaceholder&&!he.isCardBack){const Le=Ye(he.baseId);if(Le)return{...Le,id:he.id,baseId:he.baseId,ownerId:H.id,power:he.power,powerModifier:he.powerModifier||0,isFaceDown:he.isFaceDown||!1,statuses:he.statuses||[]}}return{id:he.id||`placeholder_${H.id}_hand_${ie}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color}};let me;if(H.hand&&H.hand.length>0){me=H.hand.map((ie,Le)=>Ce(ie,Le));const he=me.filter(ie=>!ie.isPlaceholder).length;he>0&&y.info(`[STATE_UPDATE_COMPACT] Reconstructed ${he}/${me.length} revealed hand cards for player ${H.id}`)}else{me=[];for(let he=0;he<ye;he++)me.push({id:`placeholder_${H.id}_hand_${he}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color})}return{...H,hand:me,deck:Se,discard:(J==null?void 0:J.discard)||[]}}}),U=R.board?R.board.map(H=>H.map(J=>{if(!J||!J.card)return J;const Q=Ye(J.card.baseId||J.card.id);return Q?{...J,card:{...Q,id:J.card.id,baseId:J.card.baseId||J.card.id,ownerId:J.card.ownerId,ownerName:J.card.ownerName,power:J.card.power,powerModifier:J.card.powerModifier,isFaceDown:J.card.isFaceDown||!1,statuses:J.card.statuses||[],enteredThisTurn:J.card.enteredThisTurn,deck:J.card.deck}}:J})):k.board,K=Ne({...R,players:Y,board:U});return{...R,players:Y,board:K}})}break;case"STATE_UPDATE":if(V.current&&f.senderId&&f.senderId!==((mr=q.current)==null?void 0:mr.getPeerId())){if(y.info(`[STATE_UPDATE] Host received state from guest ${f.senderId}`),(Ir=f.data)!=null&&Ir.gameState){const S=f.data.gameState;n(R=>{const k=f.playerId;if(k===void 0)return y.warn("[STATE_UPDATE] Guest state missing playerId"),R;const B=R.players.map(K=>{if(K.id===k){const H=S.players.find(J=>J.id===k);if(H){const J=se=>({...se,ownerId:k}),Q=(H.hand||[]).map(J),ce=(H.deck||[]).map(J),fe=(H.discard||[]).map(J);y.info(`[STATE_UPDATE] Merging guest ${k} state: hand=${Q.length}, deck=${ce.length}, discard=${fe.length}`);const ye={...K,hand:Q,deck:ce,discard:fe,handSize:Q.length,deckSize:ce.length,discardSize:fe.length};return y.info(`[STATE_UPDATE] After merge - player ${k}: deckSize=${ye.deckSize}, handSize=${ye.handSize}`),ye}}return K}),Y=S.board?S.board.map(K=>K.map(H=>!H||!H.card?H:{...H,card:{...H.card,ownerId:H.card.ownerId}})):R.board,U={...R,players:B,board:Y};return q.current&&setTimeout(()=>{q.current.broadcastGameState(U,f.senderId)},0),U})}break}if(ze.current=!0,(Er=f.data)!=null&&Er.gameState){const S=f.data.gameState;if(Re.current){n(R=>({...R,currentPhase:S.currentPhase,activePlayerId:S.activePlayerId,startingPlayerId:S.startingPlayerId,isReadyCheckActive:S.isReadyCheckActive,isGameStarted:S.isGameStarted}));return}n(R=>{var Y;const k=S.players.map(U=>{var H,J,Q;const K=R.players.find(ce=>ce.id===U.id);if(U.id===h.current&&K){const ce=K.hand.every(ye=>ye.isPlaceholder)||K.hand.length===0,fe=U.handSize??((H=U.hand)==null?void 0:H.length)??0;if(ce&&U.hand&&U.hand.length>0)return{...U,hand:U.hand,deck:U.deck||K.deck,discard:U.discard||K.discard};{let ye=K.hand,se=K.deck;if(fe>K.hand.length&&se.length>0){const Se=fe-K.hand.length,Ce=[...K.hand],me=[...K.deck];for(let he=0;he<Se&&he<me.length;he++){const ie=me[0];me.splice(0,1),Ce.push(ie)}ye=Ce,se=me}return{...U,hand:ye,deck:se,discard:U.discard||K.discard}}}else{if(U.isDummy||!1)return y.info(`[STATE_UPDATE] Using real cards for dummy player ${U.id}`),{...U,hand:U.hand||[],deck:U.deck||[],discard:U.discard||[]};const fe=U.deckSize??((J=U.deck)==null?void 0:J.length)??0,ye=U.handSize??((Q=U.hand)==null?void 0:Q.length)??0;y.info(`[STATE_UPDATE] Player ${U.id}: deckSize=${fe}, handSize=${ye}`);const se=[];for(let Ce=0;Ce<fe;Ce++)se.push({id:`placeholder_${U.id}_deck_${Ce}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});const Se=[];for(let Ce=0;Ce<ye;Ce++)Se.push({id:`placeholder_${U.id}_hand_${Ce}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});return y.info(`[STATE_UPDATE] Created ${se.length} deck placeholders and ${Se.length} hand placeholders for player ${U.id}`),{...U,hand:Se,deck:se,discard:U.discard||[]}}}),B={...S,players:k};if(!V.current)try{((Y=q.current)==null?void 0:Y.getHostPeerId())&&h.current!==null&&(It({gameState:B,localPlayerId:h.current,isHost:!1}),y.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(U){y.warn("[STATE_UPDATE] Failed to persist guest state:",U)}return B})}break;case"RECONNECT_SNAPSHOT":if(ze.current=!0,f.data){const S=f.data;n(R=>{const k=h.current,B=S.players.map(U=>{const K=R.players.find(ce=>ce.id===U.id);if(U.id===k&&K&&K.hand.some(fe=>!fe.isPlaceholder)){let fe=[...K.hand];const ye=[...K.deck];if(U.handSize>fe.length){const se=U.handSize-fe.length;for(let Se=0;Se<se&&ye.length>0;Se++)fe.push(ye.shift())}else U.handSize<fe.length&&(fe=fe.slice(0,U.handSize));return{...U,hand:fe,deck:ye,discard:K.discard}}const H=[];for(let ce=0;ce<U.handSize;ce++)H.push({id:`placeholder_${U.id}_hand_${ce}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});const J=[];for(let ce=0;ce<U.deckSize;ce++)J.push({id:`placeholder_${U.id}_deck_${ce}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});const Q=[];for(let ce=0;ce<U.discardSize;ce++)Q.push({id:`placeholder_${U.id}_discard_${ce}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});return{...U,hand:H,deck:J,discard:Q}}),Y={gameId:S.gameId,gameMode:S.gameMode,isPrivate:S.isPrivate,isGameStarted:S.isGameStarted,isReadyCheckActive:S.isReadyCheckActive,activeGridSize:S.activeGridSize,currentPhase:S.currentPhase,isScoringStep:S.isScoringStep,activePlayerId:S.activePlayerId,startingPlayerId:S.startingPlayerId,currentRound:S.currentRound,turnNumber:S.turnNumber,roundWinners:S.roundWinners||{},gameWinner:S.gameWinner,isRoundEndModalOpen:S.isRoundEndModalOpen,dummyPlayerCount:S.dummyPlayerCount,players:B,board:S.board,spectators:R.spectators,hostId:R.hostId,revealRequests:R.revealRequests,preserveDeployAbilities:R.preserveDeployAbilities,highlights:R.highlights,floatingTexts:R.floatingTexts,targetingMode:R.targetingMode,abilityMode:R.abilityMode};if(!V.current&&k!==null)try{It({gameState:Y,localPlayerId:k,isHost:!1}),y.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(U){y.warn("[RECONNECT_SNAPSHOT] Failed to save state:",U)}return y.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${Y.currentPhase}, players=${Y.players.length}`),Y})}break;case"STATE_DELTA":if(V.current||(ze.current=!0),y.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${V.current}, senderId: ${f.senderId}`),(Tr=f.data)!=null&&Tr.delta){const S=f.data.delta;y.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(S.playerDeltas||{}).length}, boardCells=${((gr=S.boardCells)==null?void 0:gr.length)||0}, phaseDelta=${!!S.phaseDelta}`),S.boardCells&&S.boardCells.length>0&&S.boardCells.forEach(R=>{var k,B;y.info(`[STATE_DELTA] Board cell [${R.row},${R.col}]: card=${((k=R.card)==null?void 0:k.name)||"(empty)"}, owner=${(B=R.card)==null?void 0:B.ownerId}`)}),V.current&&f.senderId&&q.current&&(y.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${f.senderId} to other guests`),q.current.broadcastStateDelta(S,f.senderId)),S.phaseDelta&&y.info("[STATE_DELTA] phaseDelta:",JSON.stringify(S.phaseDelta)),S.playerDeltas&&Object.entries(S.playerDeltas).forEach(([R,k])=>{y.info(`[STATE_DELTA] Player ${R} delta: handSizeDelta=${k.handSizeDelta}, deckSizeDelta=${k.deckSizeDelta}`)}),n(R=>{const k=h.current||R.localPlayerId;y.info(`[STATE_DELTA] Applying delta with localPlayerId=${k}, currentPhase before=${R.currentPhase}`);const B=Vt(R);y.info(`[STATE_DELTA] Applying delta with localPlayerId=${k}, currentPhase after=${B.currentPhase}`);try{B.gameId&&k!==null&&(It({gameState:B,localPlayerId:k,isHost:V.current}),y.debug(`[STATE_DELTA] Saved state for ${V.current?"host":"guest"} auto-restore`))}catch(Y){y.warn("[STATE_DELTA] Failed to persist state:",Y)}return B})}break;case"STATE_DELTA_BINARY":{V.current||(ze.current=!0),y.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${V.current}, senderId: ${f.senderId}, dataType=${(_r=(wr=f.data)==null?void 0:wr.constructor)==null?void 0:_r.name}, typeof=${typeof f.data}`);let S=null;if(f.data instanceof Uint8Array)try{S=xa(f.data),S&&y.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(S.playerDeltas||{}).length}, boardCells=${((br=S.boardCells)==null?void 0:br.length)||0}`)}catch(R){y.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",R)}else if(typeof f.data=="string")try{S=Vo(f.data),S&&y.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${f.data.length} chars): playerDeltas=${Object.keys(S.playerDeltas||{}).length}, boardCells=${((Ar=S.boardCells)==null?void 0:Ar.length)||0}, phaseDelta=${!!S.phaseDelta}`)}catch(R){y.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",R)}else y.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof f.data}, constructor: ${(Cr=(Sr=f.data)==null?void 0:Sr.constructor)==null?void 0:Cr.name}`);S&&(V.current&&f.senderId&&q.current&&(y.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${f.senderId} to other guests`),q.current.broadcastStateDelta(S,f.senderId)),n(R=>{const k=h.current||R.localPlayerId;y.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${k}, currentPhase before=${R.currentPhase}`);const B=Vt(R);y.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${B.currentPhase}, board has ${B.board.flat().filter(Y=>Y==null?void 0:Y.card).length} cards`);try{B.gameId&&k!==null&&(It({gameState:B,localPlayerId:k,isHost:V.current}),y.debug(`[STATE_DELTA_BINARY] Saved state for ${V.current?"host":"guest"} auto-restore`))}catch(Y){y.warn("[STATE_DELTA_BINARY] Failed to persist state:",Y)}return B}));break}case"CARD_STATE":if(typeof f.data=="string")try{const S=atob(f.data),R=new Uint8Array(S.length);for(let k=0;k<S.length;k++)R[k]=S.charCodeAt(k);n(k=>ft(2,R,k,h.current||k.localPlayerId).gameState)}catch(S){y.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",S)}else f.data instanceof Uint8Array&&n(S=>ft(2,f.data,S,h.current||S.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof f.data=="string")try{const S=atob(f.data),R=new Uint8Array(S.length);for(let k=0;k<S.length;k++)R[k]=S.charCodeAt(k);n(k=>{const{gameState:B}=ft(3,R,k,h.current||k.localPlayerId);return B})}catch(S){y.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",S)}else f.data instanceof Uint8Array&&n(S=>{const{gameState:R}=ft(3,f.data,S,h.current||S.localPlayerId);return R});break;case"SESSION_EVENT":if(typeof f.data=="string")try{const S=atob(f.data),R=new Uint8Array(S.length);for(let k=0;k<S.length;k++)R[k]=S.charCodeAt(k);n(k=>ft(4,R,k,h.current||k.localPlayerId).gameState)}catch(S){y.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",S)}else f.data instanceof Uint8Array&&n(S=>ft(4,f.data,S,h.current||S.localPlayerId).gameState);break;case"JOIN_REQUEST":y.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${f.senderId}, isHost: ${V.current}`),V.current&&f.senderId?(y.info(`Host received JOIN_REQUEST from ${f.senderId}, data:`,f.data),en(f.senderId,f.data)):y.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${V.current}, senderId: ${f.senderId}`);break;case"ACTION":if(V.current&&f.data){const{actionType:S,actionData:R}=f.data;if(S==="STATE_UPDATE"&&(R!=null&&R.gameState)){if(Re.current){q.current&&f.senderId&&q.current.sendToGuest(f.senderId,{type:"STATE_UPDATE",senderId:q.current.getPeerId(),data:{gameState:c.current},timestamp:Date.now()});break}n(k=>{const B=R.gameState,Y=B.players.map(K=>{const H=k.players.find(J=>J.id===K.id);return H&&K.id!==h.current?{...K,deck:H.deck||K.deck,discard:H.discard||K.discard,score:H.score}:K}),U={...B,players:Y};return q.current&&q.current.broadcastToGuests({type:"STATE_UPDATE",senderId:q.current.getPeerId(),data:{gameState:U},timestamp:Date.now()}),U})}else if(S==="STATE_DELTA"&&(R!=null&&R.delta))n(k=>{const B=R.delta;let Y=B;Re.current&&B.playerDeltas&&(Y={...B,playerDeltas:Object.fromEntries(Object.entries(B.playerDeltas).map(([K,H])=>{const J={...H};return delete J.scoreDelta,[K,J]}))}),h.current||k.localPlayerId;const U=Vt(k);return q.current&&q.current.broadcastStateDelta(Y),U});else if(S==="NEXT_PHASE")n(k=>{const B=k,Y=B.currentPhase,U=Y===2&&!B.isScoringStep,K=Y+1;return{...B,currentPhase:K,...U&&{isScoringStep:!0}}});else if(S==="PREV_PHASE")n(k=>{const B=k;return B.isScoringStep?{...B,isScoringStep:!1,currentPhase:Math.max(1,B.currentPhase-1)}:{...B,currentPhase:Math.max(1,B.currentPhase-1)}});else if(S==="SET_PHASE"&&(R==null?void 0:R.phaseIndex)!==void 0)n(k=>({...k,currentPhase:R.phaseIndex}));else if(S==="UPDATE_PLAYER_NAME"&&(R==null?void 0:R.playerId)!==void 0&&(R==null?void 0:R.name)!==void 0)n(k=>({...k,players:k.players.map(B=>B.id===R.playerId?{...B,name:R.name}:B)}));else if(S==="CHANGE_PLAYER_COLOR"&&(R==null?void 0:R.playerId)!==void 0&&(R==null?void 0:R.color)!==void 0){const k=R.playerId,B=R.color;n(Y=>{const U={...Y,players:Y.players.map(K=>K.id===k?{...K,color:B}:K)};return q.current&&q.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:q.current.getPeerId(),data:{playerId:k,color:B},timestamp:Date.now()}),U})}else if(S==="UPDATE_PLAYER_SCORE"&&(R==null?void 0:R.playerId)!==void 0&&(R==null?void 0:R.delta)!==void 0){const k=R.playerId,B=R.delta;n(Y=>{const U={...Y,players:Y.players.map(K=>K.id===k?{...K,score:Math.max(0,K.score+B)}:K)};return q.current&&q.current.broadcastToGuests({type:"UPDATE_PLAYER_SCORE",senderId:q.current.getPeerId(),data:{playerId:k,delta:B},timestamp:Date.now()}),U})}else if(S==="CHANGE_PLAYER_DECK"&&(R==null?void 0:R.playerId)!==void 0){const k=R.playerId,B=R.deckType,Y=R.deck;n(U=>{const K=U.players.find(Q=>Q.id===k);if(!K)return U;let H;Y&&Y.length>0?(y.info(`[CHANGE_PLAYER_DECK] Host received ${Y.length} cards for player ${k}`),H=Y.map(Q=>{if(Q.baseId){const ce=Ye(Q.baseId);if(ce)return{...ce,id:Q.id,baseId:Q.baseId,deck:B,ownerId:k,ownerName:K.name,power:Q.power,powerModifier:Q.powerModifier||0,isFaceDown:Q.isFaceDown||!1,statuses:Q.statuses||[]}}return{id:Q.id,baseId:Q.id,name:"Unknown",deck:B,ownerId:k,ownerName:K.name,power:Q.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(H=Ze(B,k,K.name),y.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${k} with ${H.length} cards from ${B}`));const J={...U,players:U.players.map(Q=>Q.id===k?{...Q,selectedDeck:B,deck:H,hand:[],discard:[],announcedCard:null,boardHistory:[]}:Q)};if(q.current){const Q=H.map(ce=>({id:ce.id,baseId:ce.baseId,power:ce.power,powerModifier:ce.powerModifier||0,isFaceDown:ce.isFaceDown||!1,statuses:ce.statuses||[]}));q.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:q.current.getPeerId(),playerId:k,data:{playerId:k,deckType:B,deck:Q,deckSize:Q.length},timestamp:Date.now()})}return J})}else if(S==="TOGGLE_ACTIVE_PLAYER"&&(R==null?void 0:R.playerId)!==void 0)n(k=>{if(!k.players.find(U=>U.id===R.playerId))return k;const Y=$a(k,R.playerId);return q.current&&q.current.broadcastGameState(Y),Y});else if(S==="TOGGLE_AUTO_DRAW"&&(R==null?void 0:R.playerId)!==void 0)n(k=>({...k,players:k.players.map(B=>B.id===R.playerId?{...B,autoDrawEnabled:!B.autoDrawEnabled}:B)}));else if(S==="START_NEXT_ROUND")n(k=>({...k,isRoundEndModalOpen:!1,currentRound:(k.currentRound||1)+1,players:k.players.map(B=>({...B,score:0}))}));else if(S==="RESET_DEPLOY_STATUS")n(k=>{const B=k.board.map(Y=>Y.map(U=>{var K;return(K=U.card)!=null&&K.statuses?{...U,card:{...U.card,statuses:U.card.statuses.filter(H=>H.type!=="DeployAbilityUsed")}}:U}));return{...k,board:B,preserveDeployAbilities:!1}});else if(S==="DECK_DATA_UPDATE"&&(R==null?void 0:R.playerId)!==void 0&&(R!=null&&R.deck)){const k=R.playerId,B=R.deck,Y=R.deckSize;y.info(`[ACTION] DECK_DATA_UPDATE: Received ${B.length} cards for guest ${k}`),n(U=>({...U,players:U.players.map(K=>K.id===k?{...K,deck:[...B],deckSize:Y||B.length}:K)}))}else y.warn(`[ACTION] Unknown action type: ${S}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(y.info(`[PLAYER_RECONNECT] Guest ${f.playerId} reconnecting from ${f.senderId}`),V.current&&f.playerId!==void 0&&f.senderId){const S=c.current;if(y.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(S!=null&&S.gameId)}, gameId=${S==null?void 0:S.gameId}, hasPlayers=${((Dr=S==null?void 0:S.players)==null?void 0:Dr.length)||0}`),S&&S.gameId){y.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${f.playerId}`);const R=ns(S,f.playerId);(Rr=q.current)==null||Rr.sendToGuest(f.senderId,{type:"RECONNECT_SNAPSHOT",senderId:q.current.getPeerId(),data:R.data,timestamp:Date.now()}),y.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${f.playerId}`)}else y.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((Pr=f.data)==null?void 0:Pr.isReadyCheckActive)!==void 0||((kr=f.data)==null?void 0:kr.isPrivate)!==void 0)&&n(S=>({...S,isReadyCheckActive:f.data.isReadyCheckActive??!0,isPrivate:f.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((Or=f.data)==null?void 0:Or.isReadyCheckActive)!==void 0&&n(S=>({...S,isReadyCheckActive:f.data.isReadyCheckActive}));break;case"PLAYER_READY":V.current&&f.playerId!==void 0?n(S=>{const R=S.players.map(U=>U.id===f.playerId?{...U,isReady:!0}:U),k={...S,players:R};y.info(`Player ${f.playerId} is ready via WebRTC`),q.current&&(q.current.broadcastGameState(k),y.info(`[PLAYER_READY] Broadcasted ready status for player ${f.playerId}`));const B=k.players.filter(U=>!U.isDummy&&!U.isDisconnected);if(B.length>0&&B.every(U=>U.isReady)&&!k.isGameStarted){const U=k.players.filter(Q=>!Q.isDisconnected),K=Math.floor(Math.random()*U.length),H=U[K].id;let J={...k};return J.isReadyCheckActive=!1,J.isGameStarted=!0,J.startingPlayerId=H,J.activePlayerId=H,J.currentPhase=0,J.players=J.players.map(Q=>{if(Q.hand.length===0&&Q.deck.length>0){const fe=[...Q.hand],ye=[...Q.deck];for(let se=0;se<6&&se<ye.length;se++){const Se=ye[0];ye.splice(0,1),fe.push(Se)}return y.info(`[PLAYER_READY] Drew ${fe.length} cards for player ${Q.id}`),{...Q,hand:fe,deck:ye}}return Q}),J=ir(J,H),y.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${J.currentPhase}`),q.current&&(q.current.broadcastToGuests({type:"GAME_START",senderId:q.current.getPeerId(),data:{startingPlayerId:H,activePlayerId:H,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var Q,ce;y.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(Q=J.players[0])==null?void 0:Q.deck.length}, hand=${(ce=J.players[0])==null?void 0:ce.hand.length}`),y.info(`[PLAYER_READY] Broadcasting state with currentPhase=${J.currentPhase}`),Gt(J)},100)),J}return k}):V.current;break;case"ASSIGN_TEAMS":(vr=f.data)!=null&&vr.assignments&&n(S=>{const R=S.players.map(k=>{let B=k.teamId||1;for(const[Y,U]of Object.entries(f.data.assignments))if(U.includes(k.id)){B=parseInt(Y);break}return{...k,teamId:B}});return{...S,players:R}});break;case"SET_GAME_MODE":((Nr=f.data)==null?void 0:Nr.mode)!==void 0&&n(S=>({...S,gameMode:f.data.mode}));break;case"SET_GAME_PRIVACY":((Mr=f.data)==null?void 0:Mr.isPrivate)!==void 0&&n(S=>({...S,isPrivate:f.data.isPrivate}));break;case"SET_GRID_SIZE":((Lr=f.data)==null?void 0:Lr.size)!==void 0&&n(S=>{const R=f.data.size,k=[];for(let B=0;B<R;B++){const Y=[];for(let U=0;U<R;U++)Y.push({card:null});k.push(Y)}return{...S,activeGridSize:R,board:k}});break;case"SET_DUMMY_PLAYER_COUNT":((Gr=f.data)==null?void 0:Gr.count)!==void 0&&n(S=>({...S,dummyPlayerCount:f.data.count}));break;case"HOST_READY":f.playerId!==void 0&&(y.info(`[handleWebrtcMessage] Host (player ${f.playerId}) is ready`),n(S=>{const R=S.players.map(k=>k.id===f.playerId?{...k,isReady:!0}:k);return{...S,players:R}}));break;case"GAME_START":ze.current=!0,y.info("[handleWebrtcMessage] Game starting!",f.data),c.current&&(y.info(`[GAME_START] Current phase before: ${c.current.currentPhase}`),c.current.players.forEach(S=>{y.info(`[GAME_START] Before: Player ${S.id} - deck: ${S.deck.length}, hand: ${S.hand.length}`)})),f.data&&n(S=>{y.info(`[GAME_START] Processing for localPlayerId=${h.current}`),S.players.forEach(Y=>{y.info(`[GAME_START] Player ${Y.id} before: deck=${Y.deck.length}, hand=${Y.hand.length}`)});const R=f.data.startingPlayerId??f.data.activePlayerId,k={...S,isGameStarted:f.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:R,activePlayerId:f.data.activePlayerId,currentPhase:S.currentPhase},B=k.players.find(Y=>Y.id===h.current);if(B&&B.hand.length===0&&B.deck.length>0){const U=[...B.hand],K=[...B.deck];for(let H=0;H<6&&H<K.length;H++){const J=K[0];K.splice(0,1),U.push(J)}k.players=k.players.map(H=>H.id===h.current?{...H,hand:U,deck:K}:H),y.info(`[GAME_START] Drew ${U.length} cards for local player ${h.current}, deck now has ${K.length} cards`)}return k.players.forEach(Y=>{y.info(`[GAME_START] Player ${Y.id} after: deck=${Y.deck.length}, hand=${Y.hand.length}`)}),y.info(`[GAME_START] Final state: currentPhase=${k.currentPhase}, activePlayerId=${k.activePlayerId}, startingPlayerId=${k.startingPlayerId}`),k});break;case"ACTIVE_PLAYER_CHANGED":y.info("[handleWebrtcMessage] Active player changed!",f.data),f.data&&n(S=>{const R={...S,activePlayerId:f.data.activePlayerId};if(f.data.currentPhase!==void 0&&(R.currentPhase=f.data.currentPhase),f.data.turnNumber!==void 0&&(R.turnNumber=f.data.turnNumber),R.currentPhase===0&&R.activePlayerId===h.current){const k=R.players.find(B=>B.id===h.current);if(k&&k.deck.length>0){const B=k.deck[0],Y=[...k.deck.slice(1)],U=[...k.hand,B];R.players=R.players.map(K=>K.id===h.current?{...K,deck:Y,hand:U}:K)}R.currentPhase=1,Zt(R,R.activePlayerId)}return R.activePlayerId&&R.activePlayerId!==S.activePlayerId&&Zt(R,R.activePlayerId),R});break;case"SYNC_DECK_SELECTIONS":y.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",f.data),f.data&&n(S=>f.data.playerId!==void 0&&f.data.selectedDeck!==void 0?f.data.playerId===h.current?(y.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${f.data.playerId}`),S):{...S,players:S.players.map(R=>R.id===f.data.playerId?{...R,selectedDeck:f.data.selectedDeck}:R)}:f.data.deckSelections&&Array.isArray(f.data.deckSelections)?{...S,players:S.players.map(R=>{if(R.id===h.current)return R;const k=f.data.deckSelections.find(B=>B.id===R.id);return k?{...R,selectedDeck:k.selectedDeck}:R})}:S);break;case"CHANGE_PLAYER_DECK":if(y.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",f.data),!f.data||f.data.playerId===void 0)break;{const S=f.data.playerId,R=f.data.deckType,k=f.data.deck;if(S===h.current)break;n(B=>{const Y=B.players.find(K=>K.id===S);if(!Y)return B;let U;return k&&k.length>0?U=k.map(K=>{if(K.baseId){const H=Ye(K.baseId);return H?{...H,id:K.id,baseId:K.baseId,deck:R,ownerId:S,ownerName:Y.name,power:K.power,powerModifier:K.powerModifier||0,isFaceDown:K.isFaceDown||!1,statuses:K.statuses||[]}:{id:K.id,baseId:K.baseId,name:"Unknown",deck:R,ownerId:S,ownerName:Y.name,power:K.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}return{id:K.id,baseId:K.id,name:"Unknown",deck:R,ownerId:S,ownerName:Y.name,power:K.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}):U=Ze(R,S,Y.name),{...B,players:B.players.map(K=>K.id===S?{...K,selectedDeck:R,deck:U,hand:[],discard:[],announcedCard:null,boardHistory:[]}:K)}})}break;case"GAME_RESET":n(S=>{const R=f.data.activeGridSize||8,k=[];for(let U=0;U<R;U++){const K=[];for(let H=0;H<R;H++)K.push({card:null});k.push(K)}const B=(f.data.players||[]).map(U=>{if(U.isDummy&&U.hand&&U.deck&&U.discard)return{...U,boardHistory:[]};{const K=U.selectedDeck||"SynchroTech";return{...U,hand:[],deck:Ze(K,U.id,U.name),discard:[],boardHistory:[]}}}),Y={...S,players:B,gameMode:f.data.gameMode,isPrivate:f.data.isPrivate,activeGridSize:f.data.activeGridSize,dummyPlayerCount:f.data.dummyPlayerCount,autoAbilitiesEnabled:f.data.autoAbilitiesEnabled,isGameStarted:f.data.isGameStarted,currentPhase:f.data.currentPhase,currentRound:f.data.currentRound,turnNumber:f.data.turnNumber,activePlayerId:f.data.activePlayerId,startingPlayerId:f.data.startingPlayerId,roundWinners:f.data.roundWinners||{},gameWinner:f.data.gameWinner,isRoundEndModalOpen:f.data.isRoundEndModalOpen,isReadyCheckActive:f.data.isReadyCheckActive,board:k,targetingMode:null,floatingTexts:[]};return c.current=Y,Y});break;case"ABILITY_MODE_SET":(xr=f.data)!=null&&xr.abilityMode&&(n(S=>({...S,abilityMode:f.data.abilityMode})),y.info("[AbilityMode] Received ability mode from host",{playerId:f.data.abilityMode.playerId,mode:f.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":y.info("[Ability] Target selected",f.data);break;case"ABILITY_COMPLETED":n(S=>({...S,abilityMode:null})),y.info("[Ability] Ability completed",f.data);break;case"ABILITY_CANCELLED":n(S=>({...S,abilityMode:null}));break;case"CHANGE_PLAYER_COLOR":if(y.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",f.data),!f.data||f.data.playerId===void 0)break;{const S=f.data.playerId,R=f.data.color;if(S===h.current)break;n(k=>({...k,players:k.players.map(B=>B.id===S?{...B,color:R}:B)}))}break;case"UPDATE_PLAYER_SCORE":if(y.info("[UPDATE_PLAYER_SCORE] Received score update broadcast",f.data),!f.data||f.data.playerId===void 0)break;{const S=f.data.playerId,R=f.data.delta;if(S===h.current)break;n(k=>({...k,players:k.players.map(B=>B.id===S?{...B,score:Math.max(0,B.score+R)}:B)}))}break;case"TRIGGER_HIGHLIGHT":if((Ur=f.data)!=null&&Ur.highlightData){const S=f.data.highlightData;C(S),V.current&&q.current&&f.senderId&&q.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:f.senderId,data:S,timestamp:Date.now()},f.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(f.data){const S=($r=q.current)==null?void 0:$r.getPeerId();f.senderId!==S&&C(f.data)}break;case"TRIGGER_FLOATING_TEXT":if((Hr=f.data)!=null&&Hr.textData){const S=f.data.textData;n(R=>({...R,floatingTexts:[...R.floatingTexts,S].filter(k=>Date.now()-k.timestamp<oe.FLOATING_TEXT_DURATION)})),V.current&&q.current&&f.senderId&&q.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:f.senderId,data:S,timestamp:Date.now()},f.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((Fr=f.data)!=null&&Fr.batch){const S=f.data.batch;n(R=>({...R,floatingTexts:[...R.floatingTexts,...S].filter(k=>Date.now()-k.timestamp<oe.FLOATING_TEXT_DURATION)})),V.current&&q.current&&f.senderId&&q.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:f.senderId,data:{batch:S},timestamp:Date.now()},f.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const S=(Br=q.current)==null?void 0:Br.getPeerId();(Wr=f.data)!=null&&Wr.batch&&f.senderId!==S?n(R=>({...R,floatingTexts:[...R.floatingTexts,...f.data.batch].filter(k=>Date.now()-k.timestamp<oe.FLOATING_TEXT_DURATION)})):(Yr=f.data)!=null&&Yr.textData&&f.senderId!==S&&n(R=>({...R,floatingTexts:[...R.floatingTexts,f.data.textData].filter(k=>Date.now()-k.timestamp<oe.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((Kr=f.data)!=null&&Kr.coords){const S=f.data.coords,R=f.data.timestamp;b({coords:S,timestamp:R}),V.current&&q.current&&f.senderId&&q.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:f.senderId,data:{coords:S,timestamp:R},timestamp:Date.now()},f.senderId)}break;case"NO_TARGET_TRIGGERED":if((zr=f.data)!=null&&zr.coords){const S=(qr=q.current)==null?void 0:qr.getPeerId();f.senderId!==S&&b({coords:f.data.coords,timestamp:f.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(f.data){const S=f.data;L(R=>[...R,S]),setTimeout(()=>{L(R=>R.filter(k=>k.timestamp!==S.timestamp))},1e3),V.current&&q.current&&f.senderId&&q.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:f.senderId,data:S,timestamp:Date.now()},f.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(f.data){const S=f.data;N(R=>[...R,S]),setTimeout(()=>{N(R=>R.filter(k=>k.timestamp!==S.timestamp))},1e3),V.current&&q.current&&f.senderId&&q.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:f.senderId,data:S,timestamp:Date.now()},f.senderId)}break;case"TRIGGER_CLICK_WAVE":if(f.data){const S=f.data;O(R=>[...R,S]),setTimeout(()=>{O(R=>R.filter(k=>k.timestamp!==S.timestamp))},600),V.current&&q.current&&f.senderId&&q.current.broadcastToGuests({type:"CLICK_WAVE_TRIGGERED",senderId:f.senderId,data:S,timestamp:Date.now()},f.senderId)}break;case"CLICK_WAVE_TRIGGERED":f.data&&f.senderId!==((Vr=q.current)==null?void 0:Vr.getPeerId())&&(O(S=>[...S,f.data]),setTimeout(()=>{O(S=>S.filter(R=>R.timestamp!==f.data.timestamp))},600));break;case"DECK_SELECTION_TRIGGERED":f.data&&f.senderId!==((jr=q.current)==null?void 0:jr.getPeerId())&&(L(S=>[...S,f.data]),setTimeout(()=>{L(S=>S.filter(R=>R.timestamp!==f.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":f.data&&f.senderId!==((Jr=q.current)==null?void 0:Jr.getPeerId())&&(N(S=>[...S,f.data]),setTimeout(()=>{N(S=>S.filter(R=>R.timestamp!==f.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((Xr=f.data)!=null&&Xr.targetingMode){const S=f.data.targetingMode;y.info("[TargetingMode] Received SET_TARGETING_MODE via WebRTC",{playerId:S.playerId,mode:S.action.mode,boardTargetsCount:((Zr=S.boardTargets)==null?void 0:Zr.length)||0,handTargetsCount:((Qr=S.handTargets)==null?void 0:Qr.length)||0,isDeckSelectable:S.isDeckSelectable||!1,timestamp:S.timestamp}),n(R=>({...R,targetingMode:S})),c.current.targetingMode=S}break;case"CLEAR_TARGETING_MODE":n(S=>({...S,targetingMode:null})),c.current.targetingMode=null;break;case"SYNC_VALID_TARGETS":((ea=f.data)==null?void 0:ea.playerId)!==h.current&&(A({playerId:f.data.playerId,validHandTargets:f.data.validHandTargets||[],isDeckSelectable:f.data.isDeckSelectable||!1}),setTimeout(()=>{A(S=>(S==null?void 0:S.playerId)===f.data.playerId?null:S)},1e4));break;case"RECONNECT_ACCEPT":if((ta=f.data)!=null&&ta.gameState){const S=f.data.gameState;n(S),D("Connected"),y.info(`[Reconnection] State restored with ${((ra=S.players)==null?void 0:ra.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(R){y.warn("[Reconnection] Failed to clear stored data:",R)}}break;case"RECONNECT_REJECT":{const S=((aa=f.data)==null?void 0:aa.reason)||"unknown";y.warn(`[Reconnection] Reconnection rejected: ${S}`),D("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((na=f.data)==null?void 0:na.playerId)!==void 0&&(y.info(`[Reconnection] Player ${f.data.playerId} disconnected, reconnection window open`),n(S=>({...S,players:S.players.map(R=>R.id===f.data.playerId?{...R,isDisconnected:!0}:R)})));break;case"PLAYER_RECONNECTED":((oa=f.data)==null?void 0:oa.playerId)!==void 0&&(y.info(`[Reconnection] Player ${f.data.playerId} reconnected`),n(S=>({...S,players:S.players.map(R=>R.id===f.data.playerId?{...R,isDisconnected:!1}:R)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((sa=f.data)==null?void 0:sa.playerId)!==void 0&&(y.info(`[Reconnection] Player ${f.data.playerId} converted to dummy`),n(S=>({...S,players:S.players.map(R=>R.id===f.data.playerId?{...R,isDummy:!0,isDisconnected:!0}:R)})));break;case"REQUEST_DECK_VIEW":if(V.current&&((ia=f.data)==null?void 0:ia.targetPlayerId)!==void 0){const S=f.data.targetPlayerId;f.playerId;const R=r.players.find(k=>k.id===S);if(R&&q.current){let k=[];S===h.current||R.isDummy?(y.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${R.deck.length} cards, first card baseId: ${(da=R.deck[0])==null?void 0:da.baseId}`),k=R.deck.map(U=>({id:U.id,baseId:U.baseId,deck:U.deck,power:U.power,powerModifier:U.powerModifier,isFaceDown:U.isFaceDown,statuses:U.statuses||[]}))):R.deckCards&&R.deckCards.length>0?k=R.deckCards:k=R.deck.map(U=>({id:U.id,baseId:U.baseId,power:U.power,powerModifier:U.powerModifier,isFaceDown:U.isFaceDown,statuses:U.statuses||[]}));const B={targetPlayerId:S,deckCards:k,deckSize:k.length},Y={type:"DECK_VIEW_DATA",senderId:q.current.getPeerId(),data:B,timestamp:Date.now()};q.current.sendToGuest(f.senderId||"",Y),y.info(`[REQUEST_DECK_VIEW] Sent ${B.deckCards.length} cards for player ${S}`)}}break;case"DECK_VIEW_DATA":if(((ca=f.data)==null?void 0:ca.targetPlayerId)!==void 0&&((la=f.data)!=null&&la.deckCards)){const S=f.data.targetPlayerId,R=f.data.deckCards;y.info(`[DECK_VIEW_DATA] Received ${R.length} deck cards for player ${S}`);const k=Y=>{if(Y.baseId){const K=Ye(Y.baseId);if(K)return{...K,id:Y.id,baseId:Y.baseId,deck:Y.deck||De.SynchroTech,ownerId:S,power:Y.power,powerModifier:Y.powerModifier,isFaceDown:Y.isFaceDown,statuses:Y.statuses||[]};y.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${Y.baseId}`)}else y.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${Y.id}`);return{id:Y.id,baseId:Y.baseId||Y.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:Y.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:De.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}},B=R.map(k);n(Y=>({...Y,players:Y.players.map(U=>U.id===S?{...U,deck:B}:U)}))}break;case"DECK_DATA_UPDATE":if(V.current&&f.playerId!==void 0&&((ua=f.data)!=null&&ua.deck)){const S=f.playerId,R=f.data.deck,k=f.data.deckSize;y.info(`[DECK_DATA_UPDATE] Received ${R.length} cards for guest ${S}, deckSize=${k}`),n(B=>({...B,players:B.players.map(Y=>{if(Y.id===S){const U=R.map(K=>({...K,ownerId:K.ownerId??S}));return{...Y,deck:U,deckSize:k}}return Y})}))}break;case"REQUEST_DECK_DATA":if(!V.current&&q.current){const S=r.players.find(R=>R.id===h.current);if(S&&S.deck.length>0){y.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${S.deck.length} cards`);const R=S.deck.map(k=>({id:k.id,baseId:k.baseId,ownerId:k.ownerId??h.current,power:k.power,powerModifier:k.powerModifier||0,isFaceDown:k.isFaceDown||!1,statuses:k.statuses||[]}));q.current.sendAction("DECK_DATA_UPDATE",{playerId:h.current,deck:R,deckSize:R.length})}}break;default:y.warn(`[handleWebrtcMessage] Unknown message type: ${f.type}`,f);break}},[z,Ze,Gt,r,s]),rn=$.useCallback(f=>{if(!q.current||ge)return;Ee(!0),D("Connecting");const re=3e4,ee=1e3;let te=0;const de=re/ee;try{const le={hostPeerId:f,playerId:s,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(le))}catch(le){y.error("[Reconnection] Failed to store data:",le)}const ne=async()=>{te++;const le=Math.max(0,re-te*ee);if(ke({attempt:te,maxAttempts:de,timeRemaining:le}),le<=0){y.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Ee(!1),ke(null),rt();return}let Z=f;if(r!=null&&r.gameId){const Te=Bt(r.gameId);if(Te&&Te.peerId!==f){Z=Te.peerId;try{const Ae={hostPeerId:Z,playerId:s,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(Ae))}catch(Ae){y.error("[Reconnection] Failed to update reconnection data:",Ae)}}}try{const Te=s||h.current;Te!==null?(y.info(`[Reconnection] Reconnecting as existing player ${Te} to host ${Z}`),await q.current.initializeAsReconnectingGuest(Z,Te)):(y.info("[Reconnection] No playerId, connecting as new player"),await q.current.initializeAsGuest(Z)),y.info("[Reconnection] Successfully reconnected!"),Ee(!1),ke(null)}catch(Te){y.warn("[Reconnection] Reconnection attempt failed:",Te),setTimeout(ne,ee)}};ne()},[ge,r,s]),Ue=$.useCallback(f=>{n(re=>{if(!re)return y.error("[updateState] prevState is undefined, skipping update"),re;const ee=typeof f=="function"?f(re):f;if(!ee)return y.error("[updateState] newState is undefined, skipping update"),re;const te=!re.gameId&&ee.gameId;if(!ze.current&&!te)return ee;if(F&&q.current){if(V.current){if(q.current.broadcastGameState(ee),y.info(`[updateState] Host broadcast state: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`),ee.gameId&&h.current!==null)try{It({gameState:ee,localPlayerId:h.current,isHost:!0}),y.debug("[updateState] Saved game state for host auto-restore")}catch(de){y.warn("[updateState] Failed to save game state:",de)}}else q.current&&(q.current.sendStateToHost(ee,h.current),y.info(`[updateState] Guest sent state to host: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`));return ee}if(we.current&&we.current.readyState===WebSocket.OPEN){const de={type:"UPDATE_STATE",gameState:ee};dt.current&&(de.playerToken=dt.current),we.current.send(JSON.stringify(de))}return ee})},[F,z,Gt]),an=$.useCallback(()=>{const{initialState:f}=ct.createGame();Ue(f)},[ct,Ue]),nn=$.useCallback(()=>{ct.exitGame(We,V,ha,rt)},[ct,We,V,ha,rt]),on=us({ws:we,webrtcManager:q,gameStateRef:c,webrtcIsHostRef:V,setGameState:n,updateState:Ue}),sn=fs({ws:we,webrtcManager:q,gameStateRef:c,localPlayerIdRef:h,webrtcIsHostRef:V,setGameState:n}),dn=ps({updateState:Ue,sendWebrtcAction:et,webrtcIsHostRef:V,webrtcManagerRef:q}),cn=ys({updateState:Ue}),ln=hs({localPlayerIdRef:h,updateState:Ue}),{addBoardCardStatus:un,removeBoardCardStatus:fn,removeBoardCardStatusByOwner:pn,modifyBoardCardPower:yn,addAnnouncedCardStatus:hn,removeAnnouncedCardStatus:mn,modifyAnnouncedCardPower:In,addHandCardStatus:En,removeHandCardStatus:Tn,revealHandCard:gn,revealBoardCard:wn,requestCardReveal:_n,respondToRevealRequest:bn,removeRevealedStatus:An}=ln,Sn=ms({webrtcIsHostRef:V,sendWebrtcAction:et,webrtcManagerRef:q,localPlayerIdRef:h,getCardDefinition:Ye,commandCardIds:go,createDeck:Ze,updateState:Ue}),{changePlayerDeck:Cn,loadCustomDeck:Dn,resurrectDiscardedCard:Rn,reorderTopDeck:Pn,reorderCards:kn,recoverDiscardedCard:On}=Sn,vn=Is({ws:we,webrtcManagerRef:q,webrtcIsHostRef:V,gameStateRef:c,scoreDeltaAccumulator:Xe,setGameState:n,updateState:Ue,abilityMode:t,setAbilityMode:a,createDeck:Ze}),{toggleActivePlayer:Nn,toggleAutoDraw:Mn,setPhase:Ln,nextPhase:Gn,prevPhase:xn,closeRoundEndModal:Un,closeRoundEndModalOnly:$n,resetGame:Hn}=vn;$.useEffect(()=>{Be.current=!1;const f=sessionStorage.getItem("invite_game_id"),re=sessionStorage.getItem("invite_host_id");if(f&&!re)return lr(),()=>{Be.current=!0,lt.current&&clearTimeout(lt.current),we.current&&(we.current.onclose=null,we.current.close())};if(f&&re)return()=>{Be.current=!0,lt.current&&clearTimeout(lt.current),we.current&&(we.current.onclose=null,we.current.close())};const ee=performance.getEntriesByType("navigation"),te=ee.length>0?ee[0]:null,de=(te==null?void 0:te.type)??0,ne=ds();return ne&&(y.info(`Restoring saved game state (nav type: ${de}):`,ne.gameState.gameId),n(ne.gameState),d(ne.localPlayerId),c.current=ne.gameState,h.current=ne.localPlayerId,dt.current=ne.playerToken),lr(),()=>{Be.current=!0,lt.current&&clearTimeout(lt.current),we.current&&(we.current.onclose=null,we.current.close())}},[]),$.useEffect(()=>{if(Fe&&c.current&&c.current.gameId){const f=Ct(c.current);f!==c.current&&(n(f),c.current=f)}},[]),$.useEffect(()=>{if(v)return;const f=setInterval(()=>{if(Fe&&c.current&&c.current.gameId){const re=Ct(c.current);n({...re}),c.current=re,x(!0),clearInterval(f)}},100);return()=>clearInterval(f)},[v]);const{startReadyCheck:Fn,cancelReadyCheck:Bn,playerReady:Wn}=sn,{updatePlayerName:Yn,changePlayerColor:Kn}=dn,{drawCard:zn,drawCardsBatch:qn,shufflePlayerDeck:Vn,flipBoardCard:jn,flipBoardCardFaceDown:Jn}=cn,{assignTeams:Xn,setGameMode:Zn,setGamePrivacy:Qn,setActiveGridSize:eo,setDummyPlayerCount:to}=on,ro=$.useCallback(()=>{var f;if(((f=we.current)==null?void 0:f.readyState)===WebSocket.OPEN&&c.current.gameId&&h.current===1){we.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe}));const re=c.current,ee=Ie(re);ee.players.forEach(te=>{if(["hand","deck","discard"].forEach(ne=>{te[ne]&&(te[ne]=te[ne].map(le=>{const Z=$t(le.name);return Z?{...le,...Z}:le}))}),te.announcedCard){const ne=$t(te.announcedCard.name);ne&&(te.announcedCard={...te.announcedCard,...ne})}}),ee.board.forEach(te=>{te.forEach(de=>{if(de.card){const ne=$t(de.card.name);ne&&(de.card={...de.card,...ne})}})}),we.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:ee})),n(ee)}},[]),xt=$.useCallback((f,re)=>{var de;const ee=c.current;if(!ee.isGameStarted){y.warn("[ScoreUpdate] Blocked: game not started");return}if(ee.isRoundEndModalOpen){y.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(re===0)return;const te=ve();if(te?Ue(ne=>({...ne,players:ne.players.map(le=>le.id===f?{...le,score:Math.max(0,(le.score||0)+re)}:le)})):n(ne=>({...ne,players:ne.players.map(le=>le.id===f?{...le,score:Math.max(0,(le.score||0)+re)}:le)})),!te){if(((de=we.current)==null?void 0:de.readyState)!==WebSocket.OPEN){y.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const ne=Xe.get(f);if(ne){clearTimeout(ne.timerId);const le=ne.delta+re,Z=setTimeout(()=>{var Ae;const Te=Xe.get(f);Te&&((Ae=we.current)==null?void 0:Ae.readyState)===WebSocket.OPEN&&(y.info(`[ScoreUpdate] Sending accumulated delta: player=${f}, delta=${Te.delta}`),we.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:c.current.gameId,playerId:f,delta:Te.delta}))),Xe.delete(f)},500);Xe.set(f,{delta:le,timerId:Z})}else{const le=setTimeout(()=>{var Te;const Z=Xe.get(f);Z&&((Te=we.current)==null?void 0:Te.readyState)===WebSocket.OPEN&&(y.info(`[ScoreUpdate] Sending delta: player=${f}, delta=${Z.delta}`),we.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:c.current.gameId,playerId:f,delta:Z.delta}))),Xe.delete(f)},500);Xe.set(f,{delta:re,timerId:le})}}},[n,Ue]),ao=ws({ws:we,webrtcManager:q,gameStateRef:c,webrtcIsHostRef:V,setGameState:n}),{setTargetingMode:no,clearTargetingMode:pr}=ao,oo=Es({ws:we,gameStateRef:c,updateState:Ue,updatePlayerScore:xt,triggerFloatingText:fr,clearTargetingMode:pr}),{scoreLine:so,scoreDiagonal:io}=oo,Je=Ts({updateState:Ue,rawJsonData:Fe}),co=gs({updateState:Ue,localPlayerIdRef:h,updatePlayerScore:xt}),{moveItem:yr}=co;return{gameState:r,localPlayerId:s,setLocalPlayerId:d,draggedItem:I,setDraggedItem:_,connectionStatus:u,gamesList:T,latestHighlight:p,latestFloatingTexts:E,latestNoTarget:w,latestDeckSelections:M,latestHandCardSelections:G,joinAsInvite:Ya,startReadyCheck:Fn,cancelReadyCheck:Bn,playerReady:Wn,assignTeams:Xn,setGameMode:Zn,setGamePrivacy:Qn,setActiveGridSize:eo,setDummyPlayerCount:to,updatePlayerName:Yn,changePlayerColor:Kn,updatePlayerScore:xt,changePlayerDeck:Cn,loadCustomDeck:Dn,drawCard:zn,drawCardsBatch:qn,shufflePlayerDeck:Vn,moveItem:yr,handleDrop:yr,addBoardCardStatus:un,removeBoardCardStatus:fn,removeBoardCardStatusByOwner:pn,modifyBoardCardPower:yn,addAnnouncedCardStatus:hn,removeAnnouncedCardStatus:mn,modifyAnnouncedCardPower:In,addHandCardStatus:En,removeHandCardStatus:Tn,flipBoardCard:jn,flipBoardCardFaceDown:Jn,revealHandCard:gn,revealBoardCard:wn,requestCardReveal:_n,respondToRevealRequest:bn,syncGame:ro,removeRevealedStatus:An,toggleActivePlayer:Nn,toggleAutoDraw:Mn,triggerHighlight:qa,triggerFloatingText:fr,triggerNoTarget:Va,triggerDeckSelection:ja,triggerHandCardSelection:Ja,triggerClickWave:Za,clickWaves:m,syncValidTargets:Xa,remoteValidTargets:P,setTargetingMode:no,clearTargetingMode:pr,nextPhase:Gn,prevPhase:xn,setPhase:Ln,markAbilityUsed:Je.markAbilityUsed,applyGlobalEffect:Je.applyGlobalEffect,swapCards:Je.swapCards,transferStatus:Je.transferStatus,transferAllCounters:Je.transferAllCounters,spawnToken:Je.spawnToken,resetDeployStatus:Je.resetDeployStatus,removeStatusByType:Je.removeStatusByType,recoverDiscardedCard:On,resurrectDiscardedCard:Rn,scoreLine:so,closeRoundEndModal:Un,closeRoundEndModalOnly:$n,resetGame:Hn,scoreDiagonal:io,reorderTopDeck:Pn,reorderCards:kn,updateState:Ue,requestDeckView:cr,sendFullDeckToHost:tt,createGame:an,joinGame:ur,joinGameViaModal:ur,exitGame:nn,requestGamesList:Ka,forceReconnect:Wa,webrtcHostId:j,webrtcIsHost:z,initializeWebrtcHost:je,connectAsGuest:Qe,sendWebrtcAction:et,isReconnecting:ge,reconnectProgress:_e}};function ga(e,t,a){const{gameState:r,localPlayerId:n,abilityMode:i,cursorStack:o,handleActionExecution:s,markAbilityUsed:d}=a;if(i||o||!r.isGameStarted||n===null)return null;const c=r.players.find(_=>_.id===e.ownerId),h=n===e.ownerId||(c==null?void 0:c.isDummy)&&n===1;if(r.activePlayerId!==e.ownerId||!h||!Da(e,r)||!Ca(e,r.currentPhase,r.activePlayerId,r))return null;const I=Ro(e,r,e.ownerId,t);if(I){I.readyStatusToRemove&&d(t,!!I.isDeployAbility,!1,I.readyStatusToRemove);const _={...I,chainedAction:I.chainedAction?{...I.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};return s(_,t),_}return null}function qe(e,t){var r;const a=(r=e.sourceCard)==null?void 0:r.ownerId;return typeof a=="number"?a:typeof t=="number"?t:0}function Ss(e,t,a){var h;const{gameState:r,localPlayerId:n,commandContext:i,triggerNoTarget:o,onAbilityComplete:s,handleActionExecution:d}=a;if(e.type==="ABILITY_COMPLETE"){s==null||s();return}if(e.type==="REVEREND_SETUP_SCORE"){Cs(e,t,a);return}if(e.type==="GLOBAL_AUTO_APPLY"){Ds(e,t,a);return}if(!At(e,r,((h=e.sourceCard)==null?void 0:h.ownerId)||n,i)){o(t),e.chainedAction&&setTimeout(()=>{d(e.chainedAction,t)},500);return}if(e.type==="CREATE_STACK"){Rs(e,t,a);return}if(e.type==="OPEN_MODAL"){Ps(e,t,a);return}if(e.type==="ENTER_MODE"){ks(e,t,a);return}y.warn("[handleActionExecution] Unknown action type:",e.type)}function Cs(e,t,a){var c,h;const{gameState:r,updatePlayerScore:n,triggerFloatingText:i,markAbilityUsed:o}=a,s=((c=e.sourceCard)==null?void 0:c.ownerId)??0;let d=0;for(let I=0;I<r.board.length;I++)for(let _=0;_<r.board[I].length;_++){const u=(h=r.board[I][_])==null?void 0:h.card;if(u!=null&&u.statuses){const D=u.statuses.filter(T=>T.type==="Exploit"&&T.addedByPlayerId===s);d+=D.length}}d>0&&n(s,d),i([{row:t.row,col:t.col,text:`+${d}`,playerId:s}]),o(t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Ds(e,t,a){var D,T,g,p,C,E;const{gameState:r,localPlayerId:n,commandContext:i,markAbilityUsed:o,triggerNoTarget:s,triggerFloatingText:d,updatePlayerScore:c,applyGlobalEffect:h,addBoardCardStatus:I,removeStatusByType:_,handleActionExecution:u}=a;if(((D=e.payload)==null?void 0:D.customAction)==="FINN_SCORING"){const l=(T=e.sourceCard)==null?void 0:T.ownerId;if(l===void 0){y.warn("[FINN_SCORING] Source card missing ownerId"),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}let w=0;if(r.players.forEach(b=>{b.id!==l&&b.hand.forEach(M=>{var L;(L=M.statuses)!=null&&L.some(G=>G.type==="Revealed"&&G.addedByPlayerId===l)&&w++})}),r.board.forEach(b=>{b.forEach(M=>{var G;const L=M.card;if(L&&L.ownerId!==l){const N=((G=L.statuses)==null?void 0:G.filter(m=>m.type==="Revealed"&&m.addedByPlayerId===l).length)||0;w+=N}})}),w>0){const b=e.sourceCoords||t;d({row:b.row,col:b.col,text:`+${w}`,playerId:l}),c(l,w)}o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(((g=e.payload)==null?void 0:g.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){e.sourceCoords&&e.sourceCoords.row>=0?_(e.sourceCoords,"Aim"):i.lastMovedCardCoords&&_(i.lastMovedCardCoords,"Aim");return}if((p=e.payload)!=null&&p.tokenType&&e.payload.filter){const{tokenType:l,filter:w}=e.payload,b=[],M=r.board.length;for(let L=0;L<M;L++)for(let G=0;G<M;G++){const N=r.board[L][G].card;N&&w(N,L,G)&&b.push({row:L,col:G})}if(b.length===0){s(e.sourceCoords||t),e.chainedAction&&setTimeout(()=>u(e.chainedAction,t),500),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}b.forEach(L=>{var G;I(L,l,((G=e.sourceCard)==null?void 0:G.ownerId)||0)}),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove),e.chainedAction&&setTimeout(()=>u(e.chainedAction,t),oe.MODE_CLEAR_DELAY);return}if((C=e.payload)!=null&&C.contextReward){wa(e,t,a);return}if(e.payload&&!e.payload.cleanupCommand){const{tokenType:l,filter:w}=e.payload,b=[],M=r.board.length;if(e.payload.contextReward&&e.sourceCard){wa(e,t,a);return}if(w)for(let L=0;L<M;L++)for(let G=0;G<M;G++){const N=r.board[L][G].card;N&&w(N)&&b.push({row:L,col:G})}else e.sourceCoords&&e.sourceCoords.row>=0?b.push(e.sourceCoords):t&&t.row>=0?b.push(t):i.lastMovedCardCoords&&b.push(i.lastMovedCardCoords);if(b.length>0){if(l){const L=e.payload.count||1,G=e.payload.ownerId!==void 0?e.payload.ownerId:((E=e.sourceCard)==null?void 0:E.ownerId)??n??0;for(let N=0;N<L;N++)h(t,b,l,G,!!e.isDeployAbility)}}else s(t),o(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}}function Rs(e,t,a){const{gameState:r,setAbilityMode:n,setCursorStack:i,triggerNoTarget:o}=a;let s=e.count||0;if(e.dynamicCount){const{factor:d,ownerId:c}=e.dynamicCount;let h=0;r.board.forEach(I=>{I.forEach(_=>{var u;if((u=_.card)!=null&&u.statuses){const D=_.card.statuses.filter(T=>T.type===d&&T.addedByPlayerId===c);h+=D.length}})}),s=h}s>0?(n(null),i({type:e.tokenType||"Aim",count:s,sourceCoords:e.sourceCoords||t,sourceCard:e.sourceCard,isDeployAbility:e.isDeployAbility,readyStatusToRemove:e.readyStatusToRemove,targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,placeAllAtOnce:e.placeAllAtOnce,replaceStatus:e.replaceStatus,chainedAction:e.chainedAction,recordContext:e.recordContext})):o(t)}function Ps(e,t,a){var c,h;const{gameState:r,localPlayerId:n,commandContext:i,setViewingDiscard:o,markAbilityUsed:s}=a;if(!At(e,r,((c=e.sourceCard)==null?void 0:c.ownerId)||n,i)){s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(e.mode==="RETRIEVE_DEVICE"){const I=r.players.find(_=>{var u;return _.id===((u=e.sourceCard)==null?void 0:u.ownerId)});I&&(o({player:I,pickConfig:{filterType:"Device",action:"recover"}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}else if(e.mode==="IMMUNIS_RETRIEVE"){const I=r.players.find(_=>{var u;return _.id===((u=e.sourceCard)==null?void 0:u.ownerId)});I&&o({player:I,pickConfig:{filterType:"Optimates",action:"resurrect"}})}else if(e.mode==="SEARCH_DECK"){const I=r.players.find(_=>{var u;return _.id===((u=e.sourceCard)==null?void 0:u.ownerId)});I&&(o({player:I,pickConfig:{filterType:((h=e.payload)==null?void 0:h.filterType)||"Unit",action:"recover",isDeck:!0}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function ks(e,t,a){var u,D;const{gameState:r,localPlayerId:n,commandContext:i,triggerNoTarget:o,setAbilityMode:s,markAbilityUsed:d,addBoardCardStatus:c,setTargetingMode:h,handleActionExecution:I}=a,_=e.mode;if(_==="SHIELD_SELF_THEN_RIOT_PUSH"){const T=e.sourceCard.ownerId;if(c(t,"Shield",T),!At(e,r,T,i)){o(t),d(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),h(e,qe(e,n),t,void 0,i);return}if(_==="SHIELD_SELF_THEN_SPAWN"){const T=qe(e,n);c(t,"Shield",T),s({...e,payload:{...e.payload,shieldApplied:!0}}),h(e,T,t);return}if(_==="PRINCEPS_SHIELD_THEN_AIM"){const T=qe(e,n);c(t,"Shield",T);const g={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};I(g,t);return}if(_==="GAWAIN_DEPLOY_SHIELD_AIM"){const T=e.sourceCard.ownerId;c(t,"Shield",T);const g={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};I(g,t);return}if(_==="ABR_DEPLOY_SHIELD_AIM"){const T=e.sourceCard.ownerId;c(t,"Shield",T);const g={type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};I(g,t);return}if(_==="RIOT_PUSH"){if(e.isDeployAbility){s(e),h(e,qe(e,n),t);return}if(!At(e,r,((u=e.sourceCard)==null?void 0:u.ownerId)||n,i)){o(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),h(e,qe(e,n),t);return}if(_==="PATROL_MOVE"){s(e),h(e,qe(e,n),t);return}if(_==="SELECT_TARGET"){if(e.isDeployAbility){s(e),h(e,qe(e,n),t,void 0,i);return}if(!At(e,r,((D=e.sourceCard)==null?void 0:D.ownerId)||n,i)){o(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),h(e,qe(e,n),t,void 0,i);return}s(e),h(e,qe(e,n),t)}function wa(e,t,a){var p,C,E,l,w,b,M;const{gameState:r,commandContext:n,updatePlayerScore:i,triggerFloatingText:o,drawCardsBatch:s,removeBoardCardStatus:d,addBoardCardStatus:c,modifyBoardCardPower:h,markAbilityUsed:I}=a,_=(p=e.payload)==null?void 0:p.contextReward,u=n.lastMovedCardCoords||t;if(!u||u.row<0)return;let D=r.board[u.row][u.col].card;const T=((C=e.payload)==null?void 0:C._tempContextId)||n.lastMovedCardId;if((!D||T&&D.id!==T)&&T)for(let L=0;L<r.board.length;L++){for(let G=0;G<r.board[L].length;G++)if(((E=r.board[L][G].card)==null?void 0:E.id)===T){D=r.board[L][G].card;break}if(D)break}if(!D){y.warn("[ContextReward] No card at coords");return}const g=Math.max(0,D.power+(D.powerModifier||0)+(D.bonusPower||0));_==="DRAW_MOVED_POWER"||_==="DRAW_EQUAL_POWER"?s(((l=e.sourceCard)==null?void 0:l.ownerId)||0,g):_==="SCORE_MOVED_POWER"?(o({row:u.row,col:u.col,text:`+${g}`,playerId:((w=e.sourceCard)==null?void 0:w.ownerId)||0}),i(((b=e.sourceCard)==null?void 0:b.ownerId)||0,g)):_==="STUN_MOVED_UNIT"?c(u,"Stun",((M=e.sourceCard)==null?void 0:M.ownerId)||0):_==="REMOVE_AIM"?d(u,"Aim"):_==="WEAKEN"&&h(u,-1),I(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Os(e,t){var N;const{gameState:a,localPlayerId:r,abilityMode:n,setAbilityMode:i,cursorStack:o,commandContext:s,setCommandContext:d,playMode:c,draggedItem:h,interactionLock:I,handleActionExecution:_,handleDrop:u,moveItem:D,setCursorStack:T,triggerNoTarget:g,markAbilityUsed:p,spawnToken:C,resurrectDiscardedCard:E,updatePlayerScore:l,triggerFloatingText:w,handleLineSelection:b,openContextMenu:M,triggerDeckSelection:L}=t;if(I.current)return!1;const G=a.board.length;if(h)return e.row>=0&&e.row<G&&e.col>=0&&e.col<a.board[e.row].length?(u(h,{location:"board",row:e.row,col:e.col}),!0):!1;if(o&&o.isDragging){if(st({location:"board",row:e.row,col:e.col},{...o.targetOwnerId!==void 0&&{targetOwnerId:o.targetOwnerId},...o.excludeOwnerId!==void 0&&{excludeOwnerId:o.excludeOwnerId},onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.targetType&&{targetType:o.targetType},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},...o.requireStatusFromSourceOwner!==void 0&&{requireStatusFromSourceOwner:o.requireStatusFromSourceOwner},...o.mustBeAdjacentToSource&&o.sourceCoords&&{mustBeAdjacentTo:o.sourceCoords},...o.mustBeInLineWithSource&&o.sourceCoords&&{mustBeInLineWith:o.sourceCoords},...o.maxDistanceFromSource!==void 0&&{maxDistance:o.maxDistanceFromSource},...o.range&&{range:o.range}},r??0,a.players)){let O=null;if(o.sourceCoords){const{row:P,col:A}=o.sourceCoords;P>=0&&P<G&&A>=0&&A<a.board[P].length&&(O=a.board[P][A].card)}if(O)return _({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:o.type,count:o.count,targetOwnerId:o.targetOwnerId,onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.range&&{range:o.range},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},cleanupCommand:!0},sourceCard:O,sourceCoords:o.sourceCoords},e),!0}return!1}if(n&&n.mode==="SPAWN_TOKEN"){const{sourceCoords:m,payload:O,sourceCard:P,isDeployAbility:A,readyStatusToRemove:v}=n;if(!m||!(O!=null&&O.tokenName)||!(Math.abs(e.row-m.row)+Math.abs(e.col-m.col)===1))return!1;const F=(P==null?void 0:P.ownerId)??((N=n.sourceCard)==null?void 0:N.ownerId);return C(e,O.tokenName,F),p(m,A,!1,v),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="SELECT_CELL"){const{sourceCoords:m,sourceCard:O,isDeployAbility:P,readyStatusToRemove:A,payload:v}=n,x=(()=>{var j;if(m&&m.row>=0)return m;if(!O)return null;for(let X=0;X<a.board.length;X++)for(let z=0;z<a.board.length;z++)if(((j=a.board[X][z].card)==null?void 0:j.id)===O.id)return{row:X,col:z};return null})();if(!x||!O)return!1;let F=!1;if((v==null?void 0:v.range)==="line")F=e.row===x.row||e.col===x.col;else if((v==null?void 0:v.range)==="global")F=!0;else if((v==null?void 0:v.range)===2){const j=Math.abs(e.row-x.row)+Math.abs(e.col-x.col);if(j===1)F=!0;else if(j===2){const X=x.row,z=x.col,ae=e.row,V=e.col;F=[{r:ae,c:z},{r:X,c:V},{r:(X+ae)/2,c:(z+V)/2}].some(Ee=>{if(!Number.isInteger(Ee.r)||!Number.isInteger(Ee.c))return!1;const _e=Math.floor((a.board.length-a.activeGridSize)/2),ke=_e,Re=_e+a.activeGridSize-1;return Ee.r<ke||Ee.r>Re||Ee.c<ke||Ee.c>Re||Math.abs(Ee.r-X)+Math.abs(Ee.c-z)!==1?!1:!a.board[Ee.r][Ee.c].card})}}else v!=null&&v.filter?F=v.filter(null,e.row,e.col):F=Math.abs(e.row-x.row)+Math.abs(e.col-x.col)===1;if(!F)return!1;if(v!=null&&v.moveFromHand&&s.selectedHandCard){const{playerId:j,cardIndex:X}=s.selectedHandCard,z=a.players.find(V=>V.id===j),ae=z==null?void 0:z.hand[X];if(ae)return D({card:ae,source:"hand",playerId:j,cardIndex:X,isManual:!0},{target:"board",boardCoords:e}),p(m||e,P,!1,A),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}if(!((v==null?void 0:v.allowSelf)&&e.row===x.row&&e.col===x.col)){const j=a.board[x.row][x.col].card;j&&D({card:j,source:"board",boardCoords:x,bypassOwnershipCheck:!0},{target:"board",boardCoords:e})}if(v!=null&&v.recordContext&&d({lastMovedCardCoords:e,lastMovedCardId:O.id}),p(m||e,P,!1,A),v!=null&&v.chainedAction){const j={...v.chainedAction};j.targetOwnerId===-2&&(j.targetOwnerId=O.ownerId),v.recordContext&&(j.payload||(j.payload={}),j.payload._tempContextId=O.id),i(null),setTimeout(()=>{_(j,e)},oe.MODE_CLEAR_DELAY)}else setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY);return!0}if(n&&n.mode==="PATROL_MOVE"){const{sourceCoords:m,sourceCard:O,isDeployAbility:P,readyStatusToRemove:A}=n;if(!m||!O)return!1;if(e.row===m.row&&e.col===m.col)return p(m,P,!1,A),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0;const v=e.row===m.row,x=e.col===m.col;return!v&&!x||a.board[e.row][e.col].card!==null?!1:(D({card:O,source:"board",boardCoords:m},{target:"board",boardCoords:e}),p(e,P,!1,A),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0)}if(n&&n.mode==="RIOT_MOVE"){const{sourceCoords:m,sourceCard:O,isDeployAbility:P,readyStatusToRemove:A,payload:v}=n;return!m||!O||!(v!=null&&v.vacatedCoords)?!1:e.row===v.vacatedCoords.row&&e.col===v.vacatedCoords.col?(D({card:O,source:"board",boardCoords:m},{target:"board",boardCoords:e}),p(e,P,!1,A),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0):(p(m,P,!1,A),i(null),!0)}if(n&&n.mode==="IMMUNIS_RETRIEVE"){const{sourceCoords:m,payload:O,isDeployAbility:P,readyStatusToRemove:A,sourceCard:v}=n;if(!m||!(Math.abs(e.row-m.row)+Math.abs(e.col-m.col)===1))return!1;if((O==null?void 0:O.selectedCardIndex)!==void 0){const F=(v==null?void 0:v.ownerId)||0;return E(F,O.selectedCardIndex,e),p(m,P,!1,A),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}return!1}if(n&&n.mode==="INTEGRATOR_LINE_SELECT"){const{sourceCoords:m,sourceCard:O,isDeployAbility:P,readyStatusToRemove:A}=n;if(!m||m.row<0)return!1;const v=e.row===m.row,x=e.col===m.col;if(!v&&!x)return!1;const F=(O==null?void 0:O.ownerId)||0;let W=0;if(v)for(let j=0;j<G;j++){const X=a.board[e.row][j].card;X!=null&&X.statuses&&(W+=X.statuses.filter(z=>z.type==="Exploit"&&z.addedByPlayerId===F).length)}else for(let j=0;j<G;j++){const X=a.board[j][e.col].card;j!==m.row&&X!=null&&X.statuses&&(W+=X.statuses.filter(z=>z.type==="Exploit"&&z.addedByPlayerId===F).length)}return W>0&&(l(F,W),w({row:m.row,col:m.col,text:`+${W}`,playerId:F})),p(m,P,!1,A),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="IP_AGENT_THREAT_SCORING"){const{sourceCoords:m,sourceCard:O,isDeployAbility:P,readyStatusToRemove:A}=n;if(!m)return!1;const v=e.row===m.row,x=e.col===m.col;if(!v&&!x)return!1;const F=(O==null?void 0:O.ownerId)||0;let W=0;if(v)for(let X=0;X<G;X++){const z=a.board[e.row][X].card;z!=null&&z.statuses&&(W+=z.statuses.filter(ae=>ae.type==="Threat"&&ae.addedByPlayerId===F).length)}else for(let X=0;X<G;X++){const z=a.board[X][e.col].card;X!==m.row&&z!=null&&z.statuses&&(W+=z.statuses.filter(ae=>ae.type==="Threat"&&ae.addedByPlayerId===F).length)}const j=W*2;return j>0&&(l(F,j),w({row:m.row,col:m.col,text:`+${j}`,playerId:F})),p(m,P,!1,A),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="ZIUS_LINE_SELECT"){const{sourceCoords:m,sourceCard:O,isDeployAbility:P,readyStatusToRemove:A}=n,v=s.lastMovedCardCoords||m;if(!v)return!1;const x=e.row===v.row,F=e.col===v.col;if(!x&&!F)return!1;const W=(O==null?void 0:O.ownerId)||0;let j=0;const X=[];if(x)for(let z=0;z<G;z++){const ae=a.board[e.row][z].card;if(ae!=null&&ae.statuses){const V=ae.statuses.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===W);j+=V.length,V.length>0&&X.push({row:e.row,col:z})}}else for(let z=0;z<G;z++){const ae=a.board[z][e.col].card;if(z!==v.row&&ae!=null&&ae.statuses){const V=ae.statuses.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===W);j+=V.length,V.length>0&&X.push({row:z,col:e.col})}}return j>0&&(l(W,j),X.forEach(z=>{w({row:z.row,col:z.col,text:"+1",playerId:W})})),p(m||v,P,!1,A),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}return n&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","SELECT_LINE_START","SELECT_DIAGONAL"].includes(n.mode)?(b(e),!0):c!=null&&c.card&&c.sourceCoords?(u({card:c.card,source:"hand",playerId:c.playerId,cardIndex:c.cardIndex},{location:"board",row:e.row,col:e.col}),!0):!1}function vs(e,t,a,r){var p;const{gameState:n,localPlayerId:i,abilityMode:o,cursorStack:s,interactionLock:d,setCommandContext:c,setAbilityMode:h,moveItem:I,markAbilityUsed:_,handleActionExecution:u,triggerHandCardSelection:D,setCursorStack:T,clearTargetingMode:g}=r;if(!d.current){if(s){if(["Aim","Exploit","Stun","Shield"].includes(s.type))return;const E={targetOwnerId:s.targetOwnerId,excludeOwnerId:s.excludeOwnerId,onlyOpponents:s.onlyOpponents||s.targetOwnerId===-1,onlyFaceDown:s.onlyFaceDown,targetType:s.targetType,requiredTargetStatus:s.requiredTargetStatus,tokenType:s.type};if(st({card:t,ownerId:e.id,location:"hand"},E,n.activePlayerId,n.players)&&s.type==="Revealed"){const w=((p=s.sourceCard)==null?void 0:p.ownerId)??n.activePlayerId??i??1;t.statuses||(t.statuses=[]),t.statuses.some(M=>M.type==="Revealed"&&M.addedByPlayerId===w)||(t.statuses.push({type:"Revealed",addedByPlayerId:w}),I({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:e.id,cardIndex:a}),s.sourceCoords&&s.sourceCoords.row>=0&&_(s.sourceCoords,s.isDeployAbility,!1,s.readyStatusToRemove),s.count>1?T(M=>M?{...M,count:M.count-1}:null):(g(),clearValidTargets==null||clearValidTargets(),s.chainedAction&&u(s.chainedAction,s.sourceCoords||{row:-1,col:-1}),T(null)))}return}if((o==null?void 0:o.type)==="ENTER_MODE"&&o.mode==="SELECT_TARGET"){const{payload:C,sourceCoords:E,isDeployAbility:l,sourceCard:w,readyStatusToRemove:b}=o;if(D(e.id,a,n.activePlayerId??i??1),C.actionType==="SELECT_HAND_FOR_DEPLOY"){if(C.filter&&!C.filter(t))return;c(M=>({...M,selectedHandCard:{playerId:e.id,cardIndex:a}})),h({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,payload:{range:"global",moveFromHand:!0}});return}if(C.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(C.filter&&!C.filter(t)||e.id!==(w==null?void 0:w.ownerId))return;I({card:t,source:"hand",playerId:e.id,cardIndex:a,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),h({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:w,sourceCoords:E,isDeployAbility:l,payload:{tokenName:C.tokenName}});return}if(C.actionType==="LUCIUS_SETUP"){if(e.id!==(w==null?void 0:w.ownerId))return;I({card:t,source:"hand",playerId:e.id,cardIndex:a,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),u({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:w,sourceCoords:E,isDeployAbility:l,payload:{filterType:"Command"}},E||{row:-1,col:-1}),h(null);return}if(C.actionType==="DESTROY"){if(C.filter&&!C.filter(t))return;I({card:t,source:"hand",playerId:e.id,cardIndex:a,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),E&&E.row>=0&&_(E,l,!1,b),setTimeout(()=>h(null),oe.MODE_CLEAR_DELAY)}}}}function Ns(e,t,a){const{abilityMode:r,cursorStack:n,interactionLock:i,gameState:o,activateAbility:s}=a;r||n||i.current||o.isGameStarted&&o.activePlayerId===e.id&&Ao(t,"setup",o.currentPhase)&&s(t,{row:-1,col:-1})}function Ms(e,t){var w,b,M,L,G;const{gameState:a,localPlayerId:r,abilityMode:n,interactionLock:i,setAbilityMode:o,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:c,nextPhase:h,modifyBoardCardPower:I,scoreLine:_,scoreDiagonal:u,commandContext:D}=t;if(!n)return!1;const{mode:T,sourceCard:g,sourceCoords:p,payload:C,isDeployAbility:E,readyStatusToRemove:l}=n;if(T==="SCORE_LAST_PLAYED_LINE"&&n.sourceCoords){if(i.current)return!0;const{row:N,col:m}=n.sourceCoords,{row:O,col:P}=e;if(N!==O&&m!==P)return!0;i.current=!0;const A=a.activePlayerId,v=a.board.length;let x=N,F=N,W=m,j=m;if(N===O)x=N,F=N,W=0,j=v-1;else if(m===P)W=P,j=P,x=0,F=v-1;else return i.current=!1,!0;const X=a.board.some(V=>V.some(ge=>{var Ee,_e;return((Ee=ge.card)==null?void 0:Ee.ownerId)===A&&ge.card.name.toLowerCase().includes("data liberator")&&((_e=ge.card.statuses)==null?void 0:_e.some(ke=>ke.type==="Support"))}));let z=0;const ae=[];for(let V=x;V<=F;V++)for(let ge=W;ge<=j;ge++){const _e=a.board[V][ge].card;if(_e&&!((w=_e.statuses)!=null&&w.some(ke=>ke.type==="Stun"))){const ke=_e.ownerId===A,Re=(b=_e.statuses)==null?void 0:b.some(be=>be.type==="Exploit"&&be.addedByPlayerId===A);if(ke||X&&Re&&_e.ownerId!==A){const be=Math.max(0,_e.power+(_e.powerModifier||0)+(_e.bonusPower||0));be>0&&(z+=be,ae.push({row:V,col:ge,text:`+${be}`,playerId:A}))}}}return o(null),ae.length>0&&c(ae),z>0&&d(A,z),h(),setTimeout(()=>{i.current=!1},200),!0}if(T==="SELECT_LINE_START")return o({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:g,sourceCoords:p,isDeployAbility:E,payload:{...C,firstCoords:e}}),!0;if(T==="SELECT_LINE_END"&&(C!=null&&C.firstCoords)){const{row:N,col:m}=C.firstCoords,{row:O,col:P}=e;if(N!==O&&m!==P)return!0;const A=C.actionType,v=(g==null?void 0:g.ownerId)??((M=a.players.find(x=>x.id===a.activePlayerId))!=null&&M.isDummy?a.activePlayerId:r||a.activePlayerId);if(A==="ZIUS_SCORING"){const x=D.lastMovedCardCoords;if(x){const V=N===O&&x.row===N,ge=m===P&&x.col===m;if(!V&&!ge)return!0}const F=a.board.length;let W=0,j=F-1,X=0,z=F-1;if(N===O)W=j=N;else if(m===P)X=z=m;else return!0;let ae=0;for(let V=W;V<=j;V++)for(let ge=X;ge<=z;ge++){const Ee=a.board[V][ge];Ee.card&&(ae+=((L=Ee.card.statuses)==null?void 0:L.filter(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===v).length)||0)}ae>0&&v&&(p&&c({row:p.row,col:p.col,text:`+${ae}`,playerId:v}),d(v,ae)),p&&p.row>=0&&s(p,E,!1,l)}else if(A==="CENTURION_BUFF"&&g&&p&&v){const x=a.board.length;let F=0,W=x-1,j=0,X=x-1;N===O?F=W=N:j=X=m;for(let z=F;z<=W;z++)for(let ae=j;ae<=X;ae++){const V=a.board[z][ae].card;if(V){const ge=V.id===g.id,Ee=V.ownerId===v,_e=a.players.find(be=>be.id===v),ke=a.players.find(be=>be.id===V.ownerId),Re=(_e==null?void 0:_e.teamId)!==void 0&&(ke==null?void 0:ke.teamId)!==void 0&&_e.teamId===ke.teamId;!ge&&(Ee||Re)&&I({row:z,col:ae},1)}}s(p,E,!1,l)}else(A==="SCORE_LINE"||!A)&&(_(N,m,O,P,v),C.skipNextPhase||h());return setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}if(T==="SELECT_DIAGONAL"&&C.actionType==="SCORE_DIAGONAL"){const N=(g==null?void 0:g.ownerId)??((G=a.players.find(m=>m.id===a.activePlayerId))!=null&&G.isDummy?a.activePlayerId:r||a.activePlayerId);if(C.firstCoords){const{row:m,col:O}=C.firstCoords,{row:P,col:A}=e;return Math.abs(m-P)!==Math.abs(O-A)?(o(null),!0):(u(m,O,P,A,N,C.bonusType),C.skipNextPhase||h(),o(null),!0)}else return o({...n,payload:{...C,firstCoords:e}}),!0}return!1}function Ls(e,t,a){var z;const{gameState:r,localPlayerId:n,abilityMode:i,commandContext:o,markAbilityUsed:s,triggerNoTarget:d,handleActionExecution:c,interactionLock:h,moveItem:I,swapCards:_,transferStatus:u,transferAllCounters:D,spawnToken:T,modifyBoardCardPower:g,addBoardCardStatus:p,removeBoardCardStatus:C,removeBoardCardStatusByOwner:E,removeStatusByType:l,resetDeployStatus:w,updatePlayerScore:b,triggerFloatingText:M,setCounterSelectionData:L,validTargets:G,handleLineSelection:N,setAbilityMode:m,setCommandContext:O,triggerClickWave:P}=a;if(!i||i.type!=="ENTER_MODE"||h.current||i.sourceCard&&i.sourceCard.id===e.id&&i.mode!=="SELECT_LINE_START"&&i.mode!=="INTEGRATOR_LINE_SELECT"&&i.mode!=="ZIUS_LINE_SELECT"&&i.mode!=="IP_AGENT_THREAT_SCORING"&&i.mode!=="SELECT_UNIT_FOR_MOVE"&&i.mode!=="SELECT_TARGET"&&i.mode!=="RIOT_PUSH"&&i.mode!=="RIOT_MOVE"&&i.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{mode:A,payload:v,sourceCard:x,sourceCoords:F,isDeployAbility:W,readyStatusToRemove:j,recordContext:X}=i;return A==="SELECT_LINE_START"||A==="SELECT_LINE_END"?(N(t),!0):((x==null?void 0:x.ownerId)??((z=r.players.find(ae=>ae.id===r.activePlayerId))!=null&&z.isDummy?r.activePlayerId:n||r.activePlayerId),A==="SELECT_TARGET"&&v.tokenType?Gs(e,t,a):A==="SELECT_TARGET"?xs(e,t,a):A==="RIOT_PUSH"?Us(e,t,a):A==="RIOT_MOVE"?$s(e,t,a):A==="SWAP_POSITIONS"?Hs(e,t,a):A==="TRANSFER_STATUS_SELECT"?Fs(e,t,a):A==="ZEALOUS_WEAKEN"?Bs(e,t,a):A==="REVEREND_DOUBLE_EXPLOIT"?Ws(e,t,a):A==="SELECT_UNIT_FOR_MOVE"?Ys(e,t,a):A==="PATROL_MOVE"?Ks(e,t,a):A==="SPAWN_TOKEN"?zs(e,t,a):A==="REVEAL_ENEMY"?qs(e,t,a):A==="SELECT_CELL"?Vs(e,t,a):A==="IMMUNIS_RETRIEVE"?js(e,t,a):A==="INTEGRATOR_LINE_SELECT"?Js(e,t,a):A==="IP_AGENT_THREAT_SCORING"?Xs(e,t,a):A==="ZIUS_LINE_SELECT"?Zs(e,t,a):A==="SELECT_DIAGONAL"?Qs(e,t,a):A==="SCORE_LAST_PLAYED_LINE"?ei(e,t,a):A==="SEARCH_DECK"?ti(e,t,a):A==="RETRIEVE_DEVICE"?ri(e,t,a):A==="SELECT_DECK"?ai(e,t,a):!1)}function Gs(e,t,a){const{abilityMode:r,triggerClickWave:n,moveItem:i,markAbilityUsed:o,setAbilityMode:s,setCommandContext:d,handleActionExecution:c,clearValidTargets:h}=a,{payload:I,sourceCoords:_,isDeployAbility:u,readyStatusToRemove:D}=r;if(I.filter&&!I.filter(e,t.row,t.col))return!1;if(i({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:I.tokenType,count:I.count||1},{target:"board",boardCoords:t}),n("board",t),I.recordContext&&d({lastMovedCardCoords:t,lastMovedCardId:e.id}),I.chainedAction){const T={...I.chainedAction,sourceCard:I.chainedAction.sourceCard??e,sourceCoords:I.chainedAction.sourceCoords??t,isDeployAbility:u,recordContext:!0};c(T,t),setTimeout(()=>n("board",t),100),T.type!=="ENTER_MODE"&&(s(null),h())}else _&&_.row>=0&&o(_,u,!1,D),setTimeout(()=>{s(null),h()},oe.MODE_CLEAR_DELAY);return!0}function xs(e,t,a){var L,G,N,m;const{abilityMode:r,markAbilityUsed:n,setAbilityMode:i,moveItem:o,modifyBoardCardPower:s,addBoardCardStatus:d,removeBoardCardStatus:c,removeBoardCardStatusByOwner:h,removeStatusByType:I,resetDeployStatus:_,updatePlayerScore:u,triggerFloatingText:D,setCounterSelectionData:T,handleActionExecution:g,gameState:p}=a,{mode:C,payload:E,sourceCoords:l,isDeployAbility:w,readyStatusToRemove:b}=r,M=((L=r.sourceCard)==null?void 0:L.ownerId)??((G=p.players.find(O=>O.id===p.activePlayerId))!=null&&G.isDummy?p.activePlayerId:a.localPlayerId||p.activePlayerId);if(E.actionType==="OPEN_COUNTER_MODAL")return E.filter&&!E.filter(e)?!1:(T({card:e,callbackAction:E.rewardType}),i(null),!0);if(E.actionType==="SACRIFICE_AND_BUFF_LINES"){if(E.filter&&!E.filter(e,t.row,t.col))return!1;o({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"discard",playerId:e.ownerId});const O=p.board.length,{row:P,col:A}=t;for(let v=0;v<O;v++){if(v===A)continue;const F=p.board[P][v].card;F&&_a(p,F.ownerId,M)&&s({row:P,col:v},1)}for(let v=0;v<O;v++){if(v===P)continue;const F=p.board[v][A].card;F&&_a(p,F.ownerId,M)&&s({row:v,col:A},1)}return n(l||t,w,!1,b),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}if(E.actionType==="SHIELD_AND_REMOVE_AIM")return E.filter&&!E.filter(e)?!1:(d(t,"Shield",M),I(t,"Aim"),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0);if(E.actionType==="RESET_DEPLOY")return E.filter&&!E.filter(e)?!1:(_(t),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0);if(E.actionType==="MODIFY_POWER")return E.filter&&!E.filter(e)?!1:(E.amount&&s(t,E.amount),l&&l.row>=0&&n(l,w,!1,b),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0);if(E.actionType==="DESTROY")return E.filter&&!E.filter(e)?!1:(((N=e.statuses)==null?void 0:N.some(P=>P.type==="Shield"))?c(t,"Shield"):o({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),n(l||t,w,!1,b),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0);if(E.actionType==="LUCIUS_SETUP")return E.filter&&!E.filter(e)?!1:(o({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),E.chainedAction&&g(E.chainedAction,t),!0);if(E.actionType==="CENSOR_SWAP"){if(E.filter&&!E.filter(e))return!1;const O=((m=e.statuses)==null?void 0:m.filter(P=>P.type==="Exploit"&&P.addedByPlayerId===M).length)||0;if(O>0){h(t,"Exploit",M);for(let P=0;P<O;P++)d(t,"Stun",M)}return n(l||t,w,!1,b),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}return!1}function Us(e,t,a){const{abilityMode:r,gameState:n,setAbilityMode:i,moveItem:o,markAbilityUsed:s,interactionLock:d}=a;if(d.current)return!1;const{sourceCoords:c,isDeployAbility:h,readyStatusToRemove:I,sourceCard:_}=r;if(!c||c.row<0)return!1;if(t.row===c.row&&t.col===c.col)return s(c,h,!1,I),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0;const u=Math.abs(t.row-c.row)+Math.abs(t.col-c.col)===1,D=n.players.find(G=>G.id===e.ownerId),T=n.players.find(G=>G.id===(_==null?void 0:_.ownerId)),g=(D==null?void 0:D.teamId)!==void 0&&(T==null?void 0:T.teamId)!==void 0&&D.teamId===T.teamId;if(!u||e.ownerId===(_==null?void 0:_.ownerId)||g)return!1;const p=t.row-c.row,C=t.col-c.col,E=t.row+p,l=t.col+C,w=n.board.length,b=Math.floor((w-n.activeGridSize)/2),M=b,L=b+n.activeGridSize-1;return E<M||E>L||l<M||l>L||n.board[E][l].card!==null?!1:(o({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:E,col:l}}),i({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:_,sourceCoords:c,isDeployAbility:h,payload:{vacatedCoords:t}}),!0)}function $s(e,t,a){const{abilityMode:r,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="RIOT_MOVE")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:c,readyStatusToRemove:h,payload:I}=r;return!s||!d||!(I!=null&&I.vacatedCoords)?!1:t.row===I.vacatedCoords.row&&t.col===I.vacatedCoords.col?(n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),i(t,c,!1,h),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0):(i(s,c,!1,h),o(null),!0)}function Hs(e,t,a){const{abilityMode:r,gameState:n,swapCards:i,markAbilityUsed:o,setAbilityMode:s,validTargets:d}=a;if(!r||r.mode!=="SWAP_POSITIONS")return!1;const{sourceCoords:c,sourceCard:h,isDeployAbility:I,readyStatusToRemove:_,payload:u}=r;if(!c||c.row<0)return!1;const D=n.board[c.row][c.col].card;return!D||D.id!==(h==null?void 0:h.id)?(s(null),!1):h&&h.id===e.id||u.filter&&!u.filter(e,t.row,t.col)||!u.filter&&d&&!d.some(g=>g.row===t.row&&g.col===t.col)?!1:(i(c,t),o(t,I,!1,_),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0)}function Fs(e,t,a){const{abilityMode:r,transferStatus:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="TRANSFER_STATUS_SELECT")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:c,readyStatusToRemove:h}=r;return!s||s.row<0||d&&d.id===e.id||!e.statuses||e.statuses.length===0?!1:(n(t,s,e.statuses[0].type),i(s,c,!1,h),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0)}function Bs(e,t,a){const{abilityMode:r,modifyBoardCardPower:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="ZEALOUS_WEAKEN")return!1;const{payload:s,sourceCoords:d,isDeployAbility:c,readyStatusToRemove:h}=r;return s.filter&&!s.filter(e)?!1:(n(t,-1),i(d||t,c,!1,h),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0)}function Ws(e,t,a){const{abilityMode:r,gameState:n,addBoardCardStatus:i,markAbilityUsed:o,triggerFloatingText:s,setAbilityMode:d}=a;if(!r||r.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{sourceCoords:c,sourceCard:h,isDeployAbility:I,readyStatusToRemove:_}=r,u=(h==null?void 0:h.ownerId)||0,D=(e.statuses||[]).filter(T=>T.type==="Exploit"&&T.addedByPlayerId===u).length;if(D>0){for(let T=0;T<D;T++)i(t,"Exploit",u);s([{row:t.row,col:t.col,text:`+${D}`,playerId:u}])}return o(c||t,I,!1,_),setTimeout(()=>d(null),oe.MODE_CLEAR_DELAY),!0}function Ys(e,t,a){const{abilityMode:r,setAbilityMode:n}=a;if(!r||r.mode!=="SELECT_UNIT_FOR_MOVE")return!1;const{sourceCard:i,payload:o,isDeployAbility:s,readyStatusToRemove:d}=r;return i&&i.id===e.id||o.filter&&!o.filter(e,t.row,t.col)?!1:(n({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:t,isDeployAbility:s,readyStatusToRemove:d,payload:{range:o.range||2,moveFromHand:o.moveFromHand||!1,selectedCard:e,allowSelf:!1}}),!0)}function Ks(e,t,a){const{abilityMode:r,gameState:n,moveItem:i,markAbilityUsed:o,setAbilityMode:s}=a;if(!r||r.mode!=="PATROL_MOVE")return!1;const{sourceCoords:d,sourceCard:c,isDeployAbility:h,readyStatusToRemove:I}=r;if(!d||!c)return!1;if(t.row===d.row&&t.col===d.col)return o(d,h,!1,I),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0;const _=t.row===d.row,u=t.col===d.col;return!_&&!u||n.board[t.row][t.col].card!==null?!1:(i({card:c,source:"board",boardCoords:d},{target:"board",boardCoords:t}),o(t,h,!1,I),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0)}function zs(e,t,a){var D;const{abilityMode:r,spawnToken:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SPAWN_TOKEN")return!1;const{sourceCoords:s,payload:d,isDeployAbility:c,readyStatusToRemove:h,sourceCard:I}=r;if(!s||!(d!=null&&d.tokenName)||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1))return!1;const u=(I==null?void 0:I.ownerId)??((D=r.sourceCard)==null?void 0:D.ownerId);return n(t,d.tokenName,u),i(s,c,!1,h),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}function qs(e,t,a){var p;const{abilityMode:r,setAbilityMode:n,setCursorStack:i,moveItem:o,markAbilityUsed:s,gameState:d}=a;if(!r||r.mode!=="REVEAL_ENEMY")return!1;const{sourceCoords:c,sourceCard:h,isDeployAbility:I,readyStatusToRemove:_,payload:u}=r;if(!c||!h||!(Math.abs(t.row-c.row)+Math.abs(t.col-c.col)===1)||e.deck==="Tokens"||((p=e.types)==null?void 0:p.includes("Token")))return!1;const g=e.ownerId;return i({type:"Revealed",count:1,targetOwnerId:g,onlyFaceDown:!0,onlyOpponents:!0,sourceCoords:t,sourceCard:e,isDeployAbility:I,readyStatusToRemove:_}),s(c,I,!1,_),setTimeout(()=>n(null),oe.MODE_CLEAR_DELAY),!0}function Vs(e,t,a){const{abilityMode:r,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SELECT_CELL")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:c,readyStatusToRemove:h,payload:I}=r;return I!=null&&I.filter&&!I.filter(null,t.row,t.col)?!1:(I!=null&&I.moveFromHand&&(I!=null&&I.selectedCard)?n({card:I.selectedCard,source:"hand"},{target:"board",boardCoords:t}):s&&s.row>=0&&n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),i(s||t,c,!1,h),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0)}function js(e,t,a){const{abilityMode:r,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="IMMUNIS_RETRIEVE")return!1;const{sourceCoords:s,payload:d,isDeployAbility:c,readyStatusToRemove:h}=r;return!s||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1)?!1:d!=null&&d.selectedCard?(n({card:d.selectedCard,source:"discard"},{target:"board",boardCoords:t}),i(s,c,!1,h),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0):!1}function Js(e,t,a){const{abilityMode:r,gameState:n,moveItem:i,markAbilityUsed:o,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:c}=a;if(!r||r.mode!=="INTEGRATOR_LINE_SELECT")return!1;const{sourceCoords:h,sourceCard:I,isDeployAbility:_,readyStatusToRemove:u}=r,D=(I==null?void 0:I.ownerId)||0,T=t.row===h.row,g=t.col===h.col;if(!T&&!g)return!1;let p=0;if(T)for(let C=0;C<n.board.length;C++){const E=n.board[t.row][C].card;E!=null&&E.statuses&&(p+=E.statuses.filter(l=>l.type==="Exploit"&&l.addedByPlayerId===D).length)}else for(let C=0;C<n.board.length;C++){const E=n.board[C][t.col].card;C!==h.row&&E!=null&&E.statuses&&(p+=E.statuses.filter(l=>l.type==="Exploit"&&l.addedByPlayerId===D).length)}return p>0&&(s(D,p),d({row:h.row,col:h.col,text:`+${p}`,playerId:D})),o(h||t,_,!1,u),setTimeout(()=>c(null),oe.MODE_CLEAR_DELAY),!0}function Xs(e,t,a){const{abilityMode:r,gameState:n,updatePlayerScore:i,triggerFloatingText:o,markAbilityUsed:s,setAbilityMode:d}=a;if(!r||r.mode!=="IP_AGENT_THREAT_SCORING")return!1;const{sourceCoords:c,sourceCard:h,isDeployAbility:I,readyStatusToRemove:_}=r,u=(h==null?void 0:h.ownerId)||0,D=t.row===c.row,T=t.col===c.col;if(!D&&!T)return!1;let g=0;if(D)for(let C=0;C<n.board.length;C++){const E=n.board[t.row][C].card;E!=null&&E.statuses&&(g+=E.statuses.filter(l=>l.type==="Threat"&&l.addedByPlayerId===u).length)}else for(let C=0;C<n.board.length;C++){const E=n.board[C][t.col].card;C!==c.row&&E!=null&&E.statuses&&(g+=E.statuses.filter(l=>l.type==="Threat"&&l.addedByPlayerId===u).length)}const p=g*2;return p>0&&(i(u,p),o({row:c.row,col:c.col,text:`+${p}`,playerId:u})),s(c||t,I,!1,_),setTimeout(()=>d(null),oe.MODE_CLEAR_DELAY),!0}function Zs(e,t,a){const{abilityMode:r,gameState:n,commandContext:i,updatePlayerScore:o,triggerFloatingText:s,markAbilityUsed:d,setAbilityMode:c}=a;if(!r||r.mode!=="ZIUS_LINE_SELECT")return!1;const{sourceCoords:h,sourceCard:I,isDeployAbility:_,readyStatusToRemove:u}=r,D=(I==null?void 0:I.ownerId)||0,T=i.lastMovedCardCoords||h,g=t.row===T.row,p=t.col===T.col;if(!g&&!p)return!1;let C=0;const E=[];if(g)for(let l=0;l<n.board.length;l++){const w=n.board[t.row][l].card;if(w!=null&&w.statuses){const b=w.statuses.filter(M=>M.type==="Exploit"&&M.addedByPlayerId===D);C+=b.length,b.length>0&&E.push({row:t.row,col:l})}}else for(let l=0;l<n.board.length;l++){const w=n.board[l][t.col].card;if(l!==T.row&&w!=null&&w.statuses){const b=w.statuses.filter(M=>M.type==="Exploit"&&M.addedByPlayerId===D);C+=b.length,b.length>0&&E.push({row:l,col:t.col})}}return C>0&&(o(D,C),E.forEach(l=>{s({row:l.row,col:l.col,text:"+1",playerId:D})})),d(h||t,_,!1,u),setTimeout(()=>c(null),oe.MODE_CLEAR_DELAY),!0}function Qs(e,t,a){var L;const{abilityMode:r,gameState:n,moveItem:i,markAbilityUsed:o,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:c,payload:h}=a;if(!r||r.mode!=="SELECT_DIAGONAL")return!1;const{sourceCoords:I,sourceCard:_,isDeployAbility:u,readyStatusToRemove:D}=r,T=(_==null?void 0:_.ownerId)||0,{row:g,col:p}=t,{row:C,col:E}=I||{row:0,col:0},l=g-p===C-E,w=g+p===C+E;if(!l&&!w)return!1;if(h!=null&&h.selectForMove&&e)return h.chainedAction&&a.handleActionExecution(h.chainedAction,t),!0;let b=0;const M=n.board.length;if(l){const G=C-E;for(let N=0;N<M;N++){const m=G+N,O=N;if(m>=0&&m<M&&O>=0&&O<M){const P=n.board[m][O].card;P!=null&&P.statuses&&(b+=P.statuses.filter(A=>A.type==="Exploit"&&A.addedByPlayerId===T).length)}}}if(w){const G=C+E;for(let N=0;N<M;N++){const m=N,O=G-m;if(m>=0&&m<M&&O>=0&&O<M){const P=n.board[m][O].card;P!=null&&P.statuses&&(b+=P.statuses.filter(A=>A.type==="Exploit"&&A.addedByPlayerId===T).length)}}}return h!=null&&h.bonusForSupport&&((L=_==null?void 0:_.statuses)!=null&&L.some(G=>G.type==="Support"))&&(b+=h.bonusForSupport),b>0&&(s(T,b),d({row:(I==null?void 0:I.row)||t.row,col:(I==null?void 0:I.col)||t.col,text:`+${b}`,playerId:T})),o(I||t,u,!1,D),setTimeout(()=>c(null),oe.MODE_CLEAR_DELAY),!0}function ei(e,t,a){const{abilityMode:r,gameState:n,commandContext:i,moveItem:o,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:c,setAbilityMode:h}=a;if(!r||r.mode!=="SCORE_LAST_PLAYED_LINE")return!1;const{sourceCoords:I,sourceCard:_,isDeployAbility:u,readyStatusToRemove:D,payload:T}=r,g=(_==null?void 0:_.ownerId)||0,p=i.lastMovedCardCoords;if(!p)return!1;const C=n.board[p.row][p.col].card;if(!C)return!1;const E=t.row===p.row,l=t.col===p.col;if(!E&&!l)return!1;const w=Math.max(0,C.power+(C.powerModifier||0));return(T==null?void 0:T.rewardType)==="SCORE"?(d(g,w),c({row:p.row,col:p.col,text:`+${w}`,playerId:g})):T==null||T.rewardType,s(I||t,u,!1,D),setTimeout(()=>h(null),oe.MODE_CLEAR_DELAY),!0}function ti(e,t,a){const{abilityMode:r,setViewingDiscard:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SEARCH_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:c}=r;return n(!0),i(s||t,d,!1,c),o(null),!0}function ri(e,t,a){const{abilityMode:r,setViewingDiscard:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="RETRIEVE_DEVICE")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:c}=r;return n(!0),i(s||t,d,!1,c),o(null),!0}function ai(e,t,a){const{abilityMode:r,triggerDeckSelection:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SELECT_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:c}=r;return n(e.ownerId),i(s||t,d,!1,c),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}function _a(e,t,a){const r=e.players.find(i=>i.id===t),n=e.players.find(i=>i.id===a);return!r||!n?!1:r.teamId!==void 0&&n.teamId!==void 0&&r.teamId===n.teamId}const Ri=({gameState:e,localPlayerId:t,abilityMode:a,setAbilityMode:r,cursorStack:n,setCursorStack:i,commandContext:o,setCommandContext:s,setViewingDiscard:d,triggerNoTarget:c,triggerClickWave:h,playMode:I,setPlayMode:_,setCounterSelectionData:u,interactionLock:D,onAbilityComplete:T,updateState:g,moveItem:p,drawCard:C,drawCardsBatch:E,updatePlayerScore:l,markAbilityUsed:w,applyGlobalEffect:b,swapCards:M,transferStatus:L,transferAllCounters:G,resurrectDiscardedCard:N,spawnToken:m,scoreLine:O,nextPhase:P,modifyBoardCardPower:A,addBoardCardStatus:v,removeBoardCardStatus:x,removeBoardCardStatusByOwner:F,resetDeployStatus:W,scoreDiagonal:j,removeStatusByType:X,triggerFloatingText:z,triggerHandCardSelection:ae,clearValidTargets:V,setTargetingMode:ge,clearTargetingMode:Ee,validTargets:_e})=>{const ke=$.useRef(()=>{}),Re=$.useCallback(Oe=>{Ms(Oe,{gameState:e,localPlayerId:t,abilityMode:a,interactionLock:D,setAbilityMode:r,markAbilityUsed:w,updatePlayerScore:l,triggerFloatingText:z,nextPhase:P,modifyBoardCardPower:A,scoreLine:O,scoreDiagonal:j,commandContext:o})},[a,e,t,D,r,w,l,z,P,A,O,j,o]);ke.current=Re;const be=$.useCallback((Oe,xe)=>{Ss(Oe,xe,{gameState:e,localPlayerId:t,setAbilityMode:r,setCursorStack:i,commandContext:o,markAbilityUsed:w,triggerNoTarget:c,handleActionExecution:be,modifyBoardCardPower:A,addBoardCardStatus:v,removeBoardCardStatus:x,removeStatusByType:X,updatePlayerScore:l,triggerFloatingText:z,setViewingDiscard:d,handleLineSelection:ke.current,onAbilityComplete:T,applyGlobalEffect:b,drawCardsBatch:E,setTargetingMode:ge})},[e,t,a,r,n,i,o,s,_,w,c,D,p,M,L,G,m,A,v,x,F,X,W,l,z,u,d,_e,T,b,E,ge]);$.useEffect(()=>{(a==null?void 0:a.type)==="GLOBAL_AUTO_APPLY"&&(be(a,a.sourceCoords||{row:-1,col:-1}),r(null))},[a,be,r]),$.useEffect(()=>{a||Ee()},[a,Ee]);const Be=$.useCallback((Oe,xe)=>{ga(Oe,xe,{gameState:e,localPlayerId:t,abilityMode:a,cursorStack:n,handleActionExecution:be,markAbilityUsed:w})},[e,t,a,n,be,w]),Lt=$.useCallback((Oe,xe)=>{var je,Qe;if(n&&_!==null&&_!==void 0){const et={targetOwnerId:n.targetOwnerId,excludeOwnerId:n.excludeOwnerId,onlyOpponents:n.onlyOpponents||n.targetOwnerId===-1,onlyFaceDown:n.onlyFaceDown,targetType:n.targetType,requiredTargetStatus:n.requiredTargetStatus,tokenType:n.type};if(st({card:Oe,ownerId:Oe.ownerId??0,location:"board"},et,e.activePlayerId,e.players)){if(n.type==="Revealed"){const tt=((je=n.sourceCard)==null?void 0:je.ownerId)??e.activePlayerId??t??1;if((Qe=Oe.statuses)==null?void 0:Qe.some(we=>we.type==="Revealed"&&we.addedByPlayerId===tt))return}p({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:n.type,count:1},{target:"board",boardCoords:xe}),n.sourceCoords&&n.sourceCoords.row>=0&&w(n.sourceCoords,n.isDeployAbility,!1,n.readyStatusToRemove),n.count>1?i(tt=>tt?{...tt,count:tt.count-1}:null):(Ee(),V(),n.chainedAction&&be(n.chainedAction,n.sourceCoords||{row:-1,col:-1}),i(null))}return}if(!D.current){if(!a&&!n&&e.isGameStarted&&Da(Oe,e)){Be(Oe,xe);return}if(a&&(a.mode==="SCORE_LAST_PLAYED_LINE"||a.mode==="SELECT_LINE_END")){Re(xe);return}(a==null?void 0:a.type)==="ENTER_MODE"&&Ls(Oe,xe,{gameState:e,localPlayerId:t,abilityMode:a,setAbilityMode:r,cursorStack:n,setCursorStack:i,commandContext:o,setCommandContext:s,playMode:null,setPlayMode:_,draggedItem:null,setDraggedItem:()=>{},openContextMenu:()=>{},markAbilityUsed:w,triggerNoTarget:c,triggerClickWave:h,handleActionExecution:be,interactionLock:D,moveItem:p,swapCards:M,transferStatus:L,transferAllCounters:G,spawnToken:m,modifyBoardCardPower:A,addBoardCardStatus:v,removeBoardCardStatus:x,removeBoardCardStatusByOwner:F,removeStatusByType:X,resetDeployStatus:W,updatePlayerScore:l,triggerFloatingText:z,setCounterSelectionData:u,setViewingDiscard:d,clearValidTargets:V,validTargets:_e,handleLineSelection:Re})||!a&&!n&&Be(Oe,xe)}},[n,_,e,t,D,a,Re,p,w,i,be,r,s,u,d,m,M,L,G,A,v,x,F,X,W,l,z,c,h,_e,Ee,Be]),dt=$.useCallback(Oe=>{Os(Oe,{gameState:e,localPlayerId:t,abilityMode:a,setAbilityMode:r,cursorStack:n,commandContext:o,setCommandContext:s,playMode:I,draggedItem:null,interactionLock:D,handleActionExecution:be,handleDrop:p,moveItem:p,setCursorStack:i,triggerNoTarget:c,markAbilityUsed:w,spawnToken:m,resurrectDiscardedCard:N,updatePlayerScore:l,triggerFloatingText:z,handleLineSelection:Re,openContextMenu:()=>{},triggerDeckSelection:()=>{}})},[e,t,a,r,n,o,s,I,D,be,p,i,c,w,m,N,l,z,Re]),ze=$.useCallback((Oe,xe,je)=>{vs(Oe,xe,je,{gameState:e,localPlayerId:t,abilityMode:a,cursorStack:n,interactionLock:D,setCommandContext:s,setAbilityMode:r,moveItem:p,markAbilityUsed:w,handleActionExecution:be,triggerHandCardSelection:ae,setCursorStack:i,clearTargetingMode:Ee})},[a,n,e,t,be,w,r,s,ae,p,i,Ee,V,D]),q=$.useCallback((Oe,xe)=>{Ns(Oe,xe,{abilityMode:a,cursorStack:n,gameState:e,activateAbility:(je,Qe)=>ga(je,Qe,{gameState:e,localPlayerId:t,abilityMode:a,cursorStack:n,handleActionExecution:be,markAbilityUsed:w})})},[a,n,e,t,be,w]);return{activateAbility:Be,executeAction:be,handleLineSelection:Re,handleBoardCardClick:Lt,handleEmptyCellClick:dt,handleHandCardClick:ze,handleAnnouncedCardDoubleClick:q}},jt=(e,t,a,r,n)=>{const i=(a.baseId||e.split("_")[1]||e).toLowerCase(),o=t===-1,s=[];i==="overwatch"?o?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:a}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},targetOwnerId:-1,onlyOpponents:!0,sourceCard:a}):t===1&&s.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:n,baseCount:0}},sourceCard:a}):i==="tacticalmaneuver"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:a,payload:{range:"line",filter:c=>c.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:a}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:a,payload:{range:"line",filter:c=>c.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:a}}}):i==="inspiration"?o&&s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:a,payload:{actionType:"OPEN_COUNTER_MODAL",filter:c=>c.ownerId===n}}):i==="datainterception"?o?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:a}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:a}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:a,payload:{range:2,filter:c=>{var h;return((h=c.statuses)==null?void 0:h.some(I=>I.type==="Exploit"&&I.addedByPlayerId===n))||!1}}}):i==="falseorders"?o?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:a,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):t===0?s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:a,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:n,sourceCard:a,originalOwnerId:a.ownerId}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:a,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:n}}}}):i==="experimentalstimulants"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:a,payload:{actionType:"RESET_DEPLOY",filter:c=>{var h;return c.ownerId===n&&((h=c.types)==null?void 0:h.includes("Unit"))}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:a,payload:{range:"line",filter:c=>c.ownerId===n}}):i==="logisticschain"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:a,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:a,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):i==="quickresponseteam"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:a,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:c=>{var h;return c.ownerId===n&&((h=c.types)==null?void 0:h.includes("Unit"))}}}):t===1&&s.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:a,payload:{filterType:"Unit"}}):i==="temporaryshelter"?t===0?s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):t===1&&s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:a,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):i==="enhancedinterrogation"?o?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:a}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:a}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:a,payload:{range:2,filter:c=>{var h;return((h=c.statuses)==null?void 0:h.some(I=>I.type==="Aim"&&I.addedByPlayerId===n))||!1}}}):(i==="mobilization1"||i==="linebreach")&&o&&s.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:a,payload:{actionType:"SCORE_LINE"}});const d=a.ownerId||n;return s.forEach(c=>{c.originalOwnerId=d,c.sourceCard&&!c.sourceCard.ownerId&&(c.sourceCard.ownerId=d)}),s},Pi=({gameState:e,localPlayerId:t,setActionQueue:a,setCommandContext:r,setCommandModalCard:n,setCounterSelectionData:i,moveItem:o,updatePlayerScore:s,updateState:d})=>{const c=$.useCallback((_,u)=>{if(t===null)return;const D=e.players.find(C=>C.id===u.playerId);if(!(u.playerId===t||(D==null?void 0:D.isDummy)))return;o(u,{target:"announced",playerId:u.playerId}),r({});const g=(_.baseId||_.id.split("_")[1]||_.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(C=>g.includes(C)))n(_);else{const C=jt(_.id,-1,_,e,u.playerId);C.length>0?a([...C,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:_,ownerId:u.playerId},sourceCard:_}]):a([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:_,ownerId:u.playerId},sourceCard:_}])}},[e,t,o,a,r,n]),h=$.useCallback((_,u)=>{var E,l;if(!u||t===null)return;const D=u.ownerId||t,T=[],g=jt(u.id,-1,u,e,D);let p;(E=u.baseId)!=null&&E.toLowerCase().includes("inspiration")&&(p=_===0?"DRAW_REMOVED":"SCORE_REMOVED",g.length>0&&g[0].type==="ENTER_MODE"&&(g[0]={...g[0],payload:{...g[0].payload,rewardType:p}})),g.forEach(w=>{T.push(w)}),jt(u.id,_,u,e,D).forEach(w=>{T.push(w)}),(l=u.baseId)!=null&&l.toLowerCase().includes("inspiration")||T.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:u,ownerId:D},sourceCard:u}),a(T),n(null)},[e,t,a,n]),I=$.useCallback((_,u)=>{var p;if(t===null)return;const D=u.card.ownerId||t;let T=null;for(let C=0;C<e.board.length;C++){for(let E=0;E<e.board[C].length;E++)if(((p=e.board[C][E].card)==null?void 0:p.id)===u.card.id){T={row:C,col:E};break}if(T)break}if(!T){y.warn(`Card ${u.card.id} not found on board during counter removal`),i(null);return}if(d(C=>{if(!C.isGameStarted)return C;const E=Ie(C),l=E.board[T.row][T.col].card;let w=0;const b=(l==null?void 0:l.statuses)??[];if(Object.entries(_).forEach(([M,L])=>{for(let G=0;G<L;G++){const N=b.map(m=>m.type).lastIndexOf(M);N>-1&&(l!=null&&l.statuses)&&(l.statuses.splice(N,1),w++)}}),!(l!=null&&l.statuses)&&l&&(l.statuses=[]),E.board=Ne(E),w>0&&u.callbackAction==="DRAW_REMOVED"){const M=E.players.find(L=>L.id===D);if(M){const L=Math.min(w,M.deck.length);for(let G=0;G<L;G++){const N=M.deck.shift();N&&M.hand.push(N)}}}return E}),u.callbackAction==="SCORE_REMOVED"){const C=Object.values(_).reduce((E,l)=>E+l,0);C>0&&s(D,C)}const g=e.players.find(C=>C.id===D);g!=null&&g.announcedCard&&a([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:g.announcedCard,ownerId:D},sourceCard:g.announcedCard}]),i(null)},[t,s,a,i,e,d]);return{playCommandCard:c,handleCommandConfirm:h,handleCounterSelectionConfirm:I}},ki=({gameState:e,localPlayerId:t,handleDrop:a,markAbilityUsed:r,requestCardReveal:n,interactionLock:i,setCommandContext:o,onAction:s,cursorStack:d,setCursorStack:c,setAbilityMode:h,triggerClickWave:I,clearTargetingMode:_})=>{const u=$.useRef(null),D=$.useRef({x:0,y:0});return $.useLayoutEffect(()=>{if(d&&u.current){const{x:g,y:p}=D.current;u.current.style.transform=`translate(${g-24}px, ${p-24}px)`}},[d]),$.useEffect(()=>{const g=p=>{D.current={x:p.clientX,y:p.clientY},u.current&&(u.current.style.transform=`translate(${p.clientX-24}px, ${p.clientY-24}px)`)};return window.addEventListener("mousemove",g),()=>window.removeEventListener("mousemove",g)},[]),$.useEffect(()=>{const g=p=>{var w,b,M,L,G,N,m;if(p.button!==0||!d)return;const C=document.elementFromPoint(p.clientX,p.clientY);let E=t;if(d.originalOwnerId!==void 0)E=d.originalOwnerId;else if((w=d.sourceCard)!=null&&w.ownerId)E=d.sourceCard.ownerId;else if(d.sourceCoords&&d.sourceCoords.row>=0){const{row:O,col:P}=d.sourceCoords;if(O>=0&&O<e.board.length&&P>=0&&P<((b=e.board[O])==null?void 0:b.length)){const A=e.board[O][P].card;A&&(E=A.ownerId||t)}}else if(e.activePlayerId){const O=e.players.find(P=>P.id===e.activePlayerId);O!=null&&O.isDummy&&(E=O.id)}let l=C==null?void 0:C.closest("[data-hand-card]");if(!l&&C)if(C.getAttribute("data-hand-card"))l=C;else{const O=C.querySelectorAll("[data-hand-card]");if(O.length>0){let P=1/0,A=null;const v=p.clientX,x=p.clientY;for(const F of Array.from(O)){const W=F.getBoundingClientRect();if(v>=W.left&&v<=W.right&&x>=W.top&&x<=W.bottom){const j=W.left+W.width/2,X=W.top+W.height/2,z=Math.hypot(v-j,x-X);z<P&&(P=z,A=F)}}l=A}}if(l){const O=l.getAttribute("data-hand-card");if(O){const[P,A]=O.split(","),v=parseInt(P,10),x=parseInt(A,10),F=e.players.find(j=>j.id===v),W=F==null?void 0:F.hand[x];if(F&&W){if(d.type==="Revealed"&&!F.isDummy){if((M=W.statuses)==null?void 0:M.some(V=>V.type==="Revealed"&&V.addedByPlayerId===E))return;d.count===1&&(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),_()),a({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((L=d.sourceCard)==null?void 0:L.ownerId)??E??void 0,statusType:d.type,count:1},{target:"hand",playerId:v,cardIndex:x,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?c(V=>V?{...V,count:V.count-1}:null):c(null),i.current=!0,setTimeout(()=>{i.current=!1},300);return}const X={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,tokenType:d.type};if(!st({card:W,ownerId:v,location:"hand"},X,E,e.players))return;d.count===1&&(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),_()),a({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((G=d.sourceCard)==null?void 0:G.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:v,cardIndex:x,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?c(ae=>ae?{...ae,count:ae.count-1}:null):c(null),i.current=!0,setTimeout(()=>{i.current=!1},300);return}}}if(!l){const O=C==null?void 0:C.closest("[data-board-coords]");if(O){const P=O.getAttribute("data-board-coords");if(P){const[A,v]=P.split(","),x=parseInt(A,10),F=parseInt(v,10);if(!isNaN(x)&&!isNaN(F)&&x>=0&&x<e.board.length&&e.board[x]&&F>=0&&F<e.board[x].length&&e.board[x][F]){const W=e.board[x][F].card;if((W==null?void 0:W.ownerId)!==void 0){const j={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,mustBeAdjacentToSource:d.mustBeAdjacentToSource,mustBeInLineWithSource:d.mustBeInLineWithSource,sourceCoords:d.sourceCoords,tokenType:d.type};if(!st({card:W,ownerId:W.ownerId,location:"board",boardCoords:{row:x,col:F}},j,E,e.players))return;const z=e.players.find(ae=>ae.id===W.ownerId);if(d.type==="Revealed"&&!(z!=null&&z.isDummy)){if(W.ownerId===t||!W.isFaceDown||((N=W.statuses)==null?void 0:N.some(V=>V.type==="Revealed"&&V.addedByPlayerId===E)))return;t!==null&&n({source:"board",ownerId:W.ownerId,boardCoords:{row:x,col:F}},t),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?c(V=>V?{...V,count:V.count-1}:null):(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),c(null)),i.current=!0,setTimeout(()=>{i.current=!1},300);return}}if(W){const j=d.placeAllAtOnce?d.count:1;a({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((m=d.sourceCard)==null?void 0:m.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:j},{target:"board",boardCoords:{row:x,col:F}}),I("board",{row:x,col:F}),d.recordContext&&o(z=>({...z,lastMovedCardCoords:{row:x,col:F},lastMovedCardId:W.id})),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility);const X=d.count-j;if(X>0)c(z=>z?{...z,count:X}:null);else{if(d.chainedAction){const z={...d.chainedAction};d.recordContext&&(z.mode==="SELECT_CELL"&&(z.sourceCard=W,z.sourceCoords={row:x,col:F},z.recordContext=!0),z.type==="GLOBAL_AUTO_APPLY"&&(z.sourceCoords={row:x,col:F}),z.type==="CREATE_STACK"&&(z.sourceCoords={row:x,col:F},z.originalOwnerId||(z.sourceCard=W)),z.mode==="ZIUS_LINE_SELECT"&&(z.sourceCoords={row:x,col:F})),z.type==="CREATE_STACK"&&h(null),s(z,{row:x,col:F})}_(),c(null)}i.current=!0,setTimeout(()=>{i.current=!1},300)}}}}else{const P=C==null?void 0:C.closest(".counter-modal-content"),A=(C==null?void 0:C.closest("[data-board-coords]"))!==null,v=(C==null?void 0:C.closest("[data-hand-card]"))!==null;d.isDragging?P?c(x=>x?{...x,isDragging:!1}:null):!A&&!v&&(_(),c(null)):!P&&!A&&!v&&(_(),c(null))}}};return window.addEventListener("mouseup",g),()=>{window.removeEventListener("mouseup",g)}},[d,a,e,t,n,r,i,o,s,c,h,I]),$.useEffect(()=>{const g=p=>{d&&(p.preventDefault(),_(),c(null))};return window.addEventListener("contextmenu",g),()=>{window.removeEventListener("contextmenu",g)}},[d,c,_]),{cursorFollowerRef:u,handleCounterMouseDown:(g,p)=>{D.current={x:p.clientX,y:p.clientY};const C=e.players.find(l=>l.id===e.activePlayerId),E=C!=null&&C.isDummy&&e.activePlayerId!==null?e.activePlayerId:t??0;c(l=>(l==null?void 0:l.type)===g?{type:g,count:l.count+1,isDragging:!0,sourceCoords:l.sourceCoords,originalOwnerId:E}:{type:g,count:1,isDragging:!0,originalOwnerId:E})}}};export{rt as A,Mt as B,_i as C,fi as D,Di as E,yi as F,ui as G,Pi as H,Ri as I,ki as J,ii as K,Nt as L,wo as M,jt as N,st as O,_o as P,At as Q,dr as R,mi as S,oe as T,di as U,go as V,mt as a,pi as b,tr as c,Oo as d,Ei as e,De as f,Ti as g,Da as h,Ye as i,ci as j,Eo as k,wi as l,y as m,er as n,ve as o,hi as p,To as q,gi as r,bo as s,Io as t,li as u,Ii as v,Si as w,Ci as x,Ai as y,bi as z};
