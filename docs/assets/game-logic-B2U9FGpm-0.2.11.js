import{r as H,j as Xo}from"./vendor-react-JYPVbgc1-0.2.11.js";import{$ as Ht}from"./vendor-webrtc-BBsnVRmn-0.2.11.js";import{e as la,d as Yt}from"./vendor-BPR6uEV2-0.2.11.js";var Ce=(t=>(t.SynchroTech="SynchroTech",t.Hoods="Hoods",t.Optimates="Optimates",t.Fusion="Fusion",t.Command="Command",t.Tokens="Tokens",t.Custom="Custom",t.Neutral="Neutral",t.Random="Random",t))(Ce||{}),pr=(t=>(t.FreeForAll="FFA",t.TwoVTwo="2v2",t.ThreeVOne="3v1",t))(pr||{});const l={info:(...t)=>{},warn:(...t)=>{console.warn(...t)},error:(...t)=>{console.error(...t)},debug:(...t)=>{}},Zo={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365235/SYN_IP_DEPT_AGENT_pbvh9e.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_TACTICAL_AGENT_vquxfm.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_PATROL_AGENT_nlyneg.webp",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_RIOT_AGENT_i4lk5m.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_THREAT_ANALYST_uqxbsp.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367440/HERO_Mr._Pearl_Director_of_BioSynch_lsesol.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_RECKLESS_PROVOCATEUR_wvfdcr.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_DATA_LIBERATOR_qeru3j.webp",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_CAUTIOUS_AVENGER_xzk6pd.webp",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_VIGILANT_SPOTTER_xo8ig7.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_INVENTIVE_MAKER_sicb73.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367436/HERO_Finn_c8637x.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_FABER_cr804w.webp",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365250/OPT_CENSOR_w4qijk.webp",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_PRINCEPS_aaqakx.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_IMMUNIS_hvlxhi.webp",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_CENTURION_grztbi.webp",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367435/HERO_Lucius_The_Immortal_irhhaj.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_CODE_KEEPER_yhowqj.webp",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_DEVOUT_SYNTHETIC_nkr1tx.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_UNWAVERING_INTEGRATOR_g1cbag.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_SIGNAL_PROPHET_rmk9me.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_ZEALOUS_MISSIONARY_v7qjhw.webp",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367438/HERO_Reverend_of_The_Choir_njrrih.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365196/CMD_OVERWATCH_djwlqo.webp",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_REPOSITIONING_uhwvrk.webp",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_INSPIRATION_v0bi3l.webp",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_DATA_INTERCEPTION_gen1qw.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_FALSE_ORDERS_aatcmc.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367418/CMD_Experimental_Stimulants_plsnet.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367415/CMD_Logistics_Chain_odmwxq.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367414/CMD_Quick_Response_Team_xff2yt.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367411/CMD_Temporary_Shelter_podjbj.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367413/CMD_Enhanced_Interrogation_legiod.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367446/N_Autonomous_Battle_Robot_Gawain_oni745.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Reclaimed_Gawain_sjmlsp.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Secret_informant_w0w6g5.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367432/HERO_Michael_Falk_sv5i5c.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367434/HERO_Edith_Byron_ny23vb.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367429/HERO_Pinkunoneko_cqhpuy.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367431/HERO_Maria_Eleftheria_Damanaki_cpw12i.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367428/HERO_Zius_xhuyxa.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},Qo={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_RECON_DRONE_w3elir.webp",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_WALKING_TURRET_c0mttm.webp",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},es={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365400/Aim_qzeaqn.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365398/Exploit_pf2zwf.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Revealed_lsan64.webp",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand and face-down cards on board.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board-facedown","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365403/Stun_pbe7ex.webp",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Shield_yilhdt.webp",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365402/Support_hxzufw.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771368527/Threat_dqnnsq.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365394/Resurrected_awaucv.webp",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},ts=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],Jt={cardDatabase:Zo,tokenDatabase:Qo,countersDatabase:es,deckFiles:ts};let qn=null,ct=new Map,dr=new Map,kt={},Ft=[],cr={};const ua=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function fd(){try{let t;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const r=await fetch("/api/content/database");if(r.ok){const n=await r.json(),a=n.cards.map(([c,i])=>[c,i]),o=n.tokens.map(([c,i])=>[c,i]);t={cardDatabase:Object.fromEntries(a),tokenDatabase:Object.fromEntries(o),countersDatabase:Object.fromEntries(n.counters),deckFiles:n.deckFiles}}else t=Jt}catch{t=Jt}else t=Jt;qn=t,ct=new Map(Object.entries(t.cardDatabase)),dr=new Map(Object.entries(t.tokenDatabase)),kt=t.countersDatabase,Ft=t.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(kt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(r){console.warn("Could not save counters database to localStorage:",r)}xe=qn,ns=ct,as=dr,ut=kt,os=Ft,cr=rs(),ss=cr}catch(t){throw console.error("Failed to load content database:",t),t}}function rs(){const t={};for(const e of Ft){const r=[];for(const n of e.cards){const a=ct.get(n.cardId);if(!a){console.warn(`Card definition not found for ID: ${n.cardId} in deck: ${e.name}`);continue}const o=ua.has(n.cardId);for(let c=0;c<n.quantity;c++){const s=n.cardId.replace(/-/g,"--DASH--").toUpperCase();o?r.push({...a,deck:Ce.Command,id:`CMD_${s}_${c+1}`,baseId:n.cardId,faction:a.faction||"Command"}):r.push({...a,deck:e.id,id:`${e.id.substring(0,3).toUpperCase()}_${s}_${c+1}`,baseId:n.cardId,faction:a.faction||e.id})}}if(t[e.id]=r,e.id==="Optimates"){const n=new Set;let a=!1;r.forEach(o=>{n.has(o.id)&&(l.error(`[buildDecksData] DUPLICATE ID in Optimates: ${o.id}`),a=!0),n.add(o.id),o.baseId||o.id}),a&&l.warn("[buildDecksData] Optimates deck has duplicate IDs!")}}return t[Ce.Tokens]=Array.from(dr.entries()).map(([e,r])=>{const n=r.types?[...r.types]:[];return{id:`TKN_${r.name.toUpperCase().replace(/\s/g,"_")}`,baseId:e,deck:Ce.Tokens,name:r.name,imageUrl:r.imageUrl,fallbackImage:r.fallbackImage,power:r.power,ability:r.ability,color:r.color,types:n,flavorText:r.flavorText,faction:"Tokens"}}),t}let xe=null,ns=new Map,as=new Map,ut={};try{const t=localStorage.getItem("counters_database");t&&(kt=JSON.parse(t),ut=kt)}catch{}let os=[],ss={};const is=ua,pd=()=>Ft.filter(t=>t.isSelectable);function Be(t){return ct.get(t)}function Xt(t){return Array.from(ct.values()).find(e=>e.name===t)}function yd(){return Array.from(ct.entries()).map(([t,e])=>({id:t,card:e}))}function hd(){return ct}function fa(){return cr}const ds=4,md={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/medal_tavarc.webp"},Ed={[Ce.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[Ce.Hoods]:{prefix:"HOO",color:"border-purple-500"},[Ce.Optimates]:{prefix:"OPT",color:"border-red-500"},[Ce.Fusion]:{prefix:"FUS",color:"border-green-400"},[Ce.Command]:{prefix:"CMD",color:"border-yellow-500"},[Ce.Tokens]:{prefix:"TKN",color:"border-gray-400"},[Ce.Custom]:{prefix:"CUS",color:"border-purple-400"},[Ce.Neutral]:{prefix:"NEU",color:"border-gray-400"},[Ce.Random]:{prefix:"RND",color:"border-gray-400"}},Id={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},cs={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},Td={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},_t=["blue","purple","red","green","yellow","orange","pink","brown"],gd=["Setup","Main","Commit","Scoring"],Gt=()=>Object.fromEntries(Object.entries(ut).map(([t,e])=>[t,e.imageUrl])),wd=new Proxy({},{get(t,e){return Gt()[e]},ownKeys(){return Object.keys(Gt())},has(t,e){return e in Gt()},getOwnPropertyDescriptor(t,e){const r=Gt()[e];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),Ut=()=>Object.fromEntries(Object.entries(ut).map(([t,e])=>[t,e.description])),_d=new Proxy({},{get(t,e){return Ut()[e]},ownKeys(){return Object.keys(Ut())},has(t,e){return e in Ut()},getOwnPropertyDescriptor(t,e){const r=Ut()[e];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),ls=()=>Object.entries(ut).filter(([t,e])=>t!=="Resurrected"&&(!e.allowedPanels||e.allowedPanels.includes("COUNTER_PANEL"))).sort(([,t],[,e])=>t.sortOrder-e.sortOrder).map(([t,e])=>({type:t,label:e.name}));ls();const he={DEPLOY:"readyDeploy",SETUP:"readySetup",COMMIT:"readyCommit"},St={SETUP_USED:"setupUsedThisTurn",COMMIT_USED:"commitUsedThisTurn"};function pa(t){return Object.values(he).includes(t)}function Ye(t,e){return t.statuses?t.statuses.some(r=>r.type===e):!1}function Zt(t,e,r){t.statuses||(t.statuses=[]),t.statuses.some(n=>n.type===e)||t.statuses.push({type:e,addedByPlayerId:r})}function us(t,e){t.statuses&&(t.statuses=t.statuses.filter(r=>r.type!==e))}function Qt(t){t.statuses&&(t.statuses=t.statuses.filter(e=>!pa(e.type)))}function Vn(t,e){var n;const r=e==="setup"?St.SETUP_USED:St.COMMIT_USED;return((n=t.statuses)==null?void 0:n.some(a=>a.type===r))??!1}function jn(t,e){const r=e==="setup"?St.SETUP_USED:St.COMMIT_USED;if(t.statuses||(t.statuses=[]),!t.statuses.some(n=>n.type===r)){t.statuses.push({type:r,addedByPlayerId:t.ownerId||0});const n=e==="setup"?he.SETUP:he.COMMIT;us(t,n)}}function fs(t){t.statuses&&(t.statuses=t.statuses.filter(e=>!(e.type===St.SETUP_USED||e.type===St.COMMIT_USED)))}function ps(t,e){var r;for(const n of t.board)for(const a of n)((r=a.card)==null?void 0:r.ownerId)===e&&fs(a.card)}function ya(t){var e;return((e=t.statuses)==null?void 0:e.some(r=>r.type==="Stun"))??!1}function ys(t,e){return t.statuses?t.statuses.some(r=>r.type==="Support"&&(e===void 0||r.addedByPlayerId===e)):!1}function ke(t,e,r){return t.statuses?t.statuses.some(n=>n.type===e&&(r===void 0||n.addedByPlayerId===r)):!1}function Jn(t,e,r){return!(!t.ownerId||t.ownerId!==r||ya(t)||e&&!ys(t,r))}function st(t,e){const{gameState:r,cards:n}=t,a=t.playerId??r.activePlayerId;if(a===void 0)return;const o=r.currentPhase,c=n??ms(r);for(const i of c)a!==null&&ha(i,a,o,e(i))}function ha(t,e,r,n){if(!t.ownerId||!t.statuses){t.statuses=t.statuses||[];return}const a=t.ownerId===e,o=new Set;if(a&&!ya(t)){const c=n.hasSetupAbility&&Jn(t,n.setupRequiresSupport,e),i=n.hasCommitAbility&&Jn(t,n.commitRequiresSupport,e);n.hasDeployAbility&&Ye(t,he.DEPLOY)&&o.add(he.DEPLOY),c&&r===1&&!o.has(he.DEPLOY)&&!Vn(t,"setup")&&o.add(he.SETUP),i&&r===3&&!o.has(he.DEPLOY)&&!Vn(t,"commit")&&o.add(he.COMMIT)}hs(t,o)}function hs(t,e){t.statuses||(t.statuses=[]);const r=t.ownerId??0;t.statuses=t.statuses.filter(n=>pa(n.type)?e.has(n.type):!0),e.has(he.DEPLOY)&&!Ye(t,he.DEPLOY)&&t.statuses.push({type:he.DEPLOY,addedByPlayerId:r}),e.has(he.SETUP)&&!Ye(t,he.SETUP)&&t.statuses.push({type:he.SETUP,addedByPlayerId:r}),e.has(he.COMMIT)&&!Ye(t,he.COMMIT)&&t.statuses.push({type:he.COMMIT,addedByPlayerId:r})}function ms(t){const e=[];for(const r of t.board)for(const n of r)n.card&&e.push(n.card);return e}function Es(t,e,r,n){if(t.statuses||(t.statuses=[]),r.hasDeployAbility){Zt(t,he.DEPLOY,e);return}n===1&&r.hasSetupAbility?Zt(t,he.SETUP,e):n===3&&r.hasCommitAbility&&Zt(t,he.COMMIT,e)}function Is(t,e){return e===1&&Ye(t,he.SETUP)?he.SETUP:e===3&&Ye(t,he.COMMIT)?he.COMMIT:Ye(t,he.DEPLOY)?he.DEPLOY:null}const Ts="readySetup",gs=(t,e)=>t.statuses?t.statuses.some(r=>r.type===e):!1,ws=(t,e,r)=>r===1&&gs(t,Ts),Et=(t,e,r,n)=>Math.abs(t-r)+Math.abs(e-n)===1,_s=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"riotAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:t,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"codeKeeper",activationType:"deploy",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>{var o;return a.ownerId!==r&&((o=a.statuses)==null?void 0:o.some(c=>c.type==="Threat"))}},sourceCard:t,sourceCoords:n})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId!==r&&ke(a,"Exploit",r)}})},{baseId:"centurion",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(a,o,c)=>{var i;return a.ownerId===r&&((i=a.types)==null?void 0:i.includes("Unit"))&&o!==void 0&&c!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:t,sourceCoords:n,payload:{filter:(a,o,c)=>a.id===t.id?!1:Et(o,c,n.row,n.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:t,sourceCoords:n,payload:{filter:a=>{if(a.id===t.id||a.ownerId!==t.ownerId||!a.statuses||a.statuses.length===0)return!1;const o=["Aim","Exploit","Rule","Shield","Stun"];return a.statuses.some(c=>o.includes(c.type))}}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:n,maxOrthogonalDistance:2,sourceCard:t})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:t,sourceCoords:n,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,originalOwnerId:r,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:a=>a.ownerId===r}})},{baseId:"censor",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:n,sourceCard:t,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(t,e,r,n)=>ke(t,"Support",r)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:t,sourceCoords:n,payload:{filter:(a,o)=>Et(a,o,n.row,n.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,o,c)=>Et(o,c,n.row,n.col)&&a.ownerId!==r&&(ke(a,"Threat",r)||ke(a,"Stun",r))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>a.ownerId===r&&ke(a,"Support",r)},sourceCard:t,sourceCoords:n})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId===r&&ke(a,"Exploit",r)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:t,sourceCoords:n,payload:{filter:a=>ke(a,"Exploit",r)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"walkingTurret",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"MODIFY_POWER",amount:-1,filter:a=>ke(a,"Aim",r)}})},{baseId:"reconDrone",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,sourceCoords:n,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"REVEAL_ENEMY_CHAINED",filter:(a,o,c)=>{const i=Et(o,c,n.row,n.col),s=a.ownerId!==r;return i&&s},targetOwnerId:void 0},skipChainedActionOnNoTargets:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:1}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,o,c)=>Et(o,c,n.row,n.col)&&a.ownerId!==r&&(ke(a,"Threat",r)||ke(a,"Stun",r))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:t,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"edithByron",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:t,sourceCoords:n,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,o,c)=>Et(o,c,n.row,n.col)&&(ke(a,"Threat",r)||ke(a,"Stun",r)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:t,sourceCoords:n,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:t,sourceCoords:n,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(t,e,r,n)=>({type:"REVEREND_SETUP_SCORE",sourceCard:t,sourceCoords:n,ownerId:r})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"LUCIUS_SETUP",filter:a=>a.ownerId===r}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId===r,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:t,sourceCoords:n})}],zt=t=>{const e=t.baseId||"";return _s.filter(r=>{var n;return r.baseId===e||((n=r.baseIdAlt)==null?void 0:n.includes(e))})},ma=t=>{const r=zt(t).map(n=>n.activationType);return[...new Set(r)]},Ss=(t,e,r,n)=>{var c;if(r!==t.ownerId)return!1;if(n&&t.ownerId!==void 0){const i=n.players.find(s=>s.id===t.ownerId);if(i!=null&&i.isDummy&&n.activePlayerId!==t.ownerId)return!1}if((c=t.statuses)!=null&&c.some(i=>i.type==="Stun"))return!1;const a=zt(t),o=e===1&&a.some(i=>i.activationType==="setup")||e===3&&a.some(i=>i.activationType==="commit");if(e===1){const i=a.find(s=>s.activationType==="setup");if(i&&Ye(t,he.SETUP))return!(i.supportRequired&&!ke(t,"Support",r))}if(e===3){const i=a.find(s=>s.activationType==="commit");if(i&&Ye(t,he.COMMIT))return!(i.supportRequired&&!ke(t,"Support",r))}if(!o){const i=a.find(s=>s.activationType==="deploy");if(i&&Ye(t,he.DEPLOY))return!(i.supportRequired&&!ke(t,"Support",r))}return!1},bs=(t,e,r,n)=>{if(r!==t.ownerId)if(t.ownerId!==void 0){const s=e.players.find(d=>d.id===t.ownerId);if(!(s!=null&&s.isDummy))return null}else return null;const a=zt(t),o=t.ownerId??r??0,c=e.currentPhase;if(c===1&&a.some(s=>s.activationType==="setup")||c===3&&a.some(s=>s.activationType==="commit"),c===1){const s=a.find(d=>d.activationType==="setup");if(s&&Ye(t,he.SETUP)){if(s.supportRequired&&!ke(t,"Support",o))return null;const d=s.getAction(t,e,o,n);if(d)return{...d,readyStatusToRemove:he.SETUP}}}if(c===3){const s=a.find(d=>d.activationType==="commit");if(s&&Ye(t,he.COMMIT)){if(s.supportRequired&&!ke(t,"Support",o))return null;const d=s.getAction(t,e,o,n);if(d)return{...d,readyStatusToRemove:he.COMMIT}}}if(!(c===1&&Ye(t,he.SETUP)||c===3&&Ye(t,he.COMMIT))){const s=a.find(d=>d.activationType==="deploy");if(s&&Ye(t,he.DEPLOY)){if(s.supportRequired&&!ke(t,"Support",o))return null;const d=s.getAction(t,e,o,n);if(d)return{...d,isDeployAbility:!0,readyStatusToRemove:he.DEPLOY}}}return null},As="readyDeploy",Xn="readySetup",Zn="readyCommit";function Ze(t){const e=ma(t),r=e.includes("deploy"),n=e.includes("setup"),a=e.includes("commit"),o=zt(t),c=o.find(s=>s.activationType==="setup"),i=o.find(s=>s.activationType==="commit");return{hasDeployAbility:r,hasSetupAbility:n,hasCommitAbility:a,setupRequiresSupport:(c==null?void 0:c.supportRequired)??!1,commitRequiresSupport:(i==null?void 0:i.supportRequired)??!1}}const Ea=(t,e,r)=>{let n;return typeof e=="object"?(n=e.currentPhase,r=e.activePlayerId??void 0):n=e,r!==void 0&&t.ownerId!==r?!1:Is(t,n)!==null};function xt(t){const e=t.activePlayerId;if(e===void 0)return;l.info(`[recalculateAllReadyStatuses] Phase ${t.currentPhase}, activePlayerId=${e}`);const r=t.currentPhase;r!==1&&r!==3||st({gameState:t},Ze)}function Cs(t,e){st({gameState:t,playerId:e},Ze)}function er(t,e){const r=e.activePlayerId;if(r==null)return;const n=Ze(t);ha(t,r,e.currentPhase,n)}function yr(t,e,r){const n=Ze(t);Es(t,e,n,r)}class Ds{constructor(){this.queue=[],this.loading=new Set,this.loaded=new Set,this.minDelayBetweenLoads=1e3,this.lastLoadTime=0,this.isProcessing=!1}preload(e,r="low"){!e||this.loaded.has(e)||this.loading.has(e)||this.queue.some(a=>a.url===e)||(this.queue.push({url:e,priority:r,timestamp:Date.now()}),this.queue.sort((a,o)=>{const c={high:0,normal:1,low:2},i=c[a.priority]-c[o.priority];return i!==0?i:a.timestamp-o.timestamp}),this.processQueue())}preloadMany(e,r="low"){e.forEach(n=>this.preload(n,r))}isLoaded(e){return this.loaded.has(e)}clearQueue(){this.queue=[]}clear(){this.queue=[],this.loading.clear(),this.loaded.clear()}processQueue(){if(this.isProcessing||this.queue.length===0)return;this.isProcessing=!0;const e=()=>{if(this.queue.length===0){this.isProcessing=!1;return}const n=Date.now()-this.lastLoadTime,a=Math.max(0,this.minDelayBetweenLoads-n);setTimeout(()=>{const o=this.queue.shift();if(!o){this.isProcessing=!1;return}this.loadImage(o.url).then(()=>{this.lastLoadTime=Date.now(),e()}).catch(()=>{this.lastLoadTime=Date.now(),e()})},a)};e()}loadImage(e){return new Promise((r,n)=>{this.loading.add(e);const a=new Image;a.onload=()=>{this.loading.delete(e),this.loaded.add(e),r()},a.onerror=()=>{this.loading.delete(e),n(new Error(`Failed to load: ${e}`))},a.src=e})}}const Rs=new Ds;function Ps(t,e){const r=[];for(const n of t)if(n.id!==e){if(n.hand)for(const a of n.hand)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl);if(n.deck)for(const a of n.deck)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl);if(n.discard)for(const a of n.discard)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl)}return r}function fe(t){const e=t,r=e==null?void 0:e.targetingMode;r&&delete e.targetingMode;let n;return typeof structuredClone<"u"?n=structuredClone(t):n=JSON.parse(JSON.stringify(t)),r&&(n.targetingMode=r,e.targetingMode=r),n}const ie={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function Sd(t){return{r:Math.min(255,Math.round(t.r*1.3)),g:Math.min(255,Math.round(t.g*1.3)),b:Math.min(255,Math.round(t.b*1.3))}}function bd(t,e){return`rgba(${t.r}, ${t.g}, ${t.b}, ${e})`}function Ad(t,e){return t?cs[t]:e}function Fe(){return localStorage.getItem("webrtc_enabled")==="true"}const Ia=H.createContext(null),Cd=({children:t})=>{const[e,r]=H.useState(null),[n,a]=H.useState({}),[o,c]=H.useState("lg"),i=H.useCallback((y,A={},f="lg")=>{r(y),a(A),c(f)},[]),s=H.useCallback(()=>{r(null),a({}),c("lg")},[]),d=H.useCallback(y=>e===y,[e]),E=H.useCallback(()=>n,[n]),P=H.useCallback(()=>o,[o]),S={openModal:e,modalData:n,modalSize:o,open:i,close:s,isOpen:d,getData:E,getSize:P};return Xo.jsx(Ia.Provider,{value:S,children:t})},Kt=()=>{const t=H.useContext(Ia);if(!t)throw new Error("useModals must be used within ModalsProvider");return t},Dd=()=>{const{open:t,close:e,isOpen:r}=Kt();return{isOpen:r("rules"),open:n=>t("rules",n,"full"),close:e}},Rd=()=>{const{open:t,close:e,isOpen:r}=Kt();return{isOpen:r("settings"),open:n=>t("settings",n,"md"),close:e}},Pd=()=>{const{open:t,close:e,isOpen:r,getData:n}=Kt();return{isOpen:r("joinGame"),open:a=>t("joinGame",a,"lg"),close:e,getData:()=>n()}},kd=()=>{const{open:t,close:e,isOpen:r}=Kt();return{isOpen:r("deckBuilder"),open:n=>t("deckBuilder",n,"full"),close:e}},Ot="webrtc_game_state",vt="webrtc_host_data",Mt="webrtc_guest_data",ks="webrtc_current_host_peerId",Os=30*60*1e3;function hr(){return Date.now()}function Nt(t){return Date.now()-t<Os}function vs(t){try{const e={...t,timestamp:hr()};localStorage.setItem(vt,JSON.stringify(e)),l.info("[WebRTC Persistence] Saved host data:",{peerId:e.peerId})}catch(e){l.error("[WebRTC Persistence] Failed to save host data:",e)}}function tr(t){try{const e={...t,timestamp:hr()};localStorage.setItem(Mt,JSON.stringify(e)),l.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:e.hostPeerId,playerId:e.playerId})}catch(e){l.error("[WebRTC Persistence] Failed to save guest data:",e)}}function Ct(t){try{const e={...t,timestamp:hr()};localStorage.setItem(Ot,JSON.stringify(e)),l.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(e.timestamp).toISOString())}catch(e){l.error("[WebRTC Persistence] Failed to save game state:",e)}}function Ta(){try{const t=localStorage.getItem(vt);if(!t)return null;const e=JSON.parse(t);return Nt(e.timestamp)?(l.info("[WebRTC Persistence] Loaded valid host data:",{peerId:e.peerId}),e):(l.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(vt),null)}catch(t){return l.error("[WebRTC Persistence] Failed to load host data:",t),localStorage.removeItem(vt),null}}function ga(){try{const t=localStorage.getItem(Mt);if(!t)return null;const e=JSON.parse(t);return Nt(e.timestamp)?(l.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:e.hostPeerId,playerId:e.playerId}),e):(l.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(Mt),null)}catch(t){return l.error("[WebRTC Persistence] Failed to load guest data:",t),localStorage.removeItem(Mt),null}}function Qn(){try{const t=localStorage.getItem(Ot);if(!t)return null;const e=JSON.parse(t);return Nt(e.timestamp)?(l.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(e.timestamp).toISOString()),e):(l.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(Ot),null)}catch(t){return l.error("[WebRTC Persistence] Failed to load game state:",t),localStorage.removeItem(Ot),null}}function at(){localStorage.removeItem(Ot),localStorage.removeItem(vt),localStorage.removeItem(Mt),localStorage.removeItem(ks)}function lr(t,e){try{const r=`webrtc_host_${e}`,n={peerId:t,gameId:e,timestamp:Date.now()};localStorage.setItem(r,JSON.stringify(n)),l.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${e}:`,t)}catch(r){l.error("[WebRTC Persistence] Failed to broadcast host peerId:",r)}}function rr(t){try{const e=`webrtc_host_${t}`,r=localStorage.getItem(e);if(!r)return null;const n=JSON.parse(r);return Date.now()-n.timestamp>15e3?null:{peerId:n.peerId,timestamp:n.timestamp}}catch(e){return l.error("[WebRTC Persistence] Failed to get host peerId:",e),null}}function ea(t){try{const e=`webrtc_host_${t}`;localStorage.removeItem(e),l.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${t}`)}catch(e){l.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",e)}}function Ms(){const t=sessionStorage.getItem("invite_host_id"),e=sessionStorage.getItem("invite_auto_join");if(t&&e)return"none";const r=Ta();if(r&&Nt(r.timestamp))return"host";const n=ga();return n&&Nt(n.timestamp)?"guest":"none"}const ta=7,nr="mrPearlDoF",Ns="reverendOfTheChoir",Ls="threatAnalyst";function Gs(t,e){return t!=null&&t.statuses?t.statuses.some(r=>r.type==="Exploit"&&r.addedByPlayerId!==void 0&&e.has(r.addedByPlayerId)):!1}function Us(t){return typeof structuredClone<"u"?structuredClone(t):JSON.parse(JSON.stringify(t))}const wa=()=>Array(ta).fill(null).map(()=>Array(ta).fill(null).map(()=>({card:null}))),Le=t=>{var f,I,p,_,D;const{board:e,activeGridSize:r,players:n}=t,a=Us(e),o=a.length,c=Math.floor((o-r)/2),i=new Map;n.forEach(u=>i.set(u.id,u.teamId));for(let u=0;u<o;u++)for(let w=0;w<o;w++){const T=a[u][w].card;T&&(T.statuses&&(T.statuses=T.statuses.filter(m=>m.type!=="Support"&&m.type!=="Threat")),delete T.bonusPower)}for(let u=0;u<o;u++)for(let w=0;w<o;w++){const T=a[u][w].card;if((T==null?void 0:T.ownerId)===void 0||T.isFaceDown)continue;const m=T.ownerId,g=i.get(m),C=[{r:u-1,c:w},{r:u+1,c:w},{r:u,c:w-1},{r:u,c:w+1}],k={};let R=!1;for(const U of C){const{r:$,c:M}=U;if($>=0&&$<o&&M>=0&&M<o){const G=a[$][M].card,x=(f=G==null?void 0:G.statuses)==null?void 0:f.some(q=>q.type==="Stun");if((G==null?void 0:G.ownerId)!==void 0&&!G.isFaceDown&&!x){const q=G.ownerId,Z=i.get(q);m===q||g!==void 0&&g===Z?R=!0:(k[q]||(k[q]=[]),k[q].push({r:$,c:M}))}}}R&&(T.statuses||(T.statuses=[]),T.statuses.some(U=>U.type==="Support")||T.statuses.push({type:"Support",addedByPlayerId:m}));let O=null;for(const U in k){const $=k[U];if($&&$.length>=2){O=parseInt(U,10);break}}if(O===null&&u>=c&&u<c+r&&w>=c&&w<c+r){const $=u===c||u===c+r-1||w===c||w===c+r-1,M=Object.keys(k).length>0;if($&&M){const G=Object.keys(k)[0];G&&(O=parseInt(G,10))}}O!==null&&(T.statuses||(T.statuses=[]),T.statuses.some(U=>U.type==="Threat")||T.statuses.push({type:"Threat",addedByPlayerId:O}))}const s=new Set;for(let u=0;u<o;u++)for(let w=0;w<o;w++){const T=a[u][w].card,m=(I=T==null?void 0:T.statuses)==null?void 0:I.some(g=>g.type==="Stun");if((T==null?void 0:T.baseId)===Ls&&!T.isFaceDown&&T.ownerId!==void 0&&!m){const g=[{r:u-1,c:w},{r:u+1,c:w},{r:u,c:w-1},{r:u,c:w+1}];let C=!1;const k=T.ownerId,R=i.get(k);for(const O of g){const{r:U,c:$}=O;if(U>=0&&U<o&&$>=0&&$<o){const M=a[U][$].card;if((M==null?void 0:M.ownerId)!==void 0&&!M.isFaceDown){const G=M.ownerId,x=i.get(G),q=k===G||R!==void 0&&R===x,Z=(p=M==null?void 0:M.statuses)==null?void 0:p.some(J=>J.type==="Stun");if(q&&!Z){C=!0;break}}}}C&&s.add(k)}}for(let u=0;u<o;u++)for(let w=0;w<o;w++){const T=a[u][w].card;if(!T||T.isFaceDown||T.ownerId===void 0)continue;const m=T.ownerId,g=i.get(m),C=[{r:u-1,c:w},{r:u+1,c:w},{r:u,c:w-1},{r:u,c:w+1}],k={};for(const O of C){const{r:U,c:$}=O;if(U>=0&&U<o&&$>=0&&$<o){const M=a[U][$].card,G=(_=M==null?void 0:M.statuses)==null?void 0:_.some(x=>x.type==="Stun");if((M==null?void 0:M.ownerId)!==void 0&&!M.isFaceDown&&!G){const x=M.ownerId,q=i.get(x);if(!(m===x||g!==void 0&&g===q)){const J=s.has(x),de=Gs(T,s);J&&de&&(k[x]||(k[x]=0),k[x]++)}}}}if(Object.keys(k).length>0){T.statuses||(T.statuses=[]);const O=Object.keys(k).map(U=>parseInt(U,10));for(const U of O)T.statuses.some($=>$.type==="Threat"&&$.addedByPlayerId===U)||T.statuses.push({type:"Threat",addedByPlayerId:U})}}const d=[],E=[];for(let u=0;u<o;u++)for(let w=0;w<o;w++){const T=a[u][w].card,m=(D=T==null?void 0:T.statuses)==null?void 0:D.some(g=>g.type==="Stun");T!=null&&T.baseId&&!T.isFaceDown&&T.ownerId!==void 0&&!m&&(T.baseId===Ns?d.push({r:u,c:w,ownerId:T.ownerId,baseId:T.baseId}):T.baseId===nr&&E.push({r:u,c:w,ownerId:T.ownerId,baseId:T.baseId}))}const P=new Set,S=new Set;for(const u of d){const{r:w,c:T,ownerId:m}=u,g=`${w}-${m}`;if(!P.has(g)){P.add(g);for(let k=0;k<o;k++){const R=a[w][k].card;R&&R.ownerId===m&&!R.isFaceDown&&(R.statuses||(R.statuses=[]),R.statuses.some(O=>O.type==="Support")||R.statuses.push({type:"Support",addedByPlayerId:m}))}}const C=`${T}-${m}`;if(!S.has(C)){S.add(C);for(let k=0;k<o;k++){const R=a[k][T].card;R&&R.ownerId===m&&!R.isFaceDown&&(R.statuses||(R.statuses=[]),R.statuses.some(O=>O.type==="Support")||R.statuses.push({type:"Support",addedByPlayerId:m}))}}}const y=new Set,A=new Set;for(const u of E){const{r:w,c:T,ownerId:m}=u,g=`${w}-${m}`;if(!y.has(g)){y.add(g);for(let k=0;k<o;k++){const R=a[w][k].card;R&&R.ownerId===m&&!R.isFaceDown&&R.baseId!==nr&&(R.bonusPower=(R.bonusPower||0)+1)}}const C=`${T}-${m}`;if(!A.has(C)){A.add(C);for(let k=0;k<o;k++){const R=a[k][T].card;R&&R.ownerId===m&&!R.isFaceDown&&R.baseId!==nr&&(R.bonusPower=(R.bonusPower||0)+1)}}}return a};var ft=(t=>(t[t.CARD_REGISTRY=1]="CARD_REGISTRY",t[t.CARD_STATE=2]="CARD_STATE",t[t.ABILITY_EFFECT=3]="ABILITY_EFFECT",t[t.SESSION_EVENT=4]="SESSION_EVENT",t))(ft||{}),Rt=(t=>(t[t.HIGHLIGHT_CELL=1]="HIGHLIGHT_CELL",t[t.FLOATING_TEXT=2]="FLOATING_TEXT",t[t.NO_TARGET=3]="NO_TARGET",t[t.STATUS_ADDED=4]="STATUS_ADDED",t[t.STATUS_REMOVED=5]="STATUS_REMOVED",t[t.POWER_CHANGED=6]="POWER_CHANGED",t[t.CARD_DESTROYED=7]="CARD_DESTROYED",t[t.TARGETING_MODE=8]="TARGETING_MODE",t[t.CLEAR_TARGETING=9]="CLEAR_TARGETING",t))(Rt||{});function xs(t){let e=0;return t.isFaceDown&&(e|=1),t.enteredThisTurn&&(e|=2),t.revealedTo==="all"&&(e|=4),e}function $s(t){const e=t.baseId||"",n=new TextEncoder().encode(e),a=new Uint8Array(1+n.length+1+1+1+4);let o=0;a[o++]=n.length,a.set(n,o),o+=n.length,a[o++]=(t.ownerId??0)&255;const c=Math.round(t.power||0);a[o++]=Math.clamp(c,-128,127)&255,a[o++]=xs(t);const i=Hs(t.statuses||[]);return a[o++]=i>>24&255,a[o++]=i>>16&255,a[o++]=i>>8&255,a[o++]=i&255,a}function Hs(t){const e=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"];let r=0;for(const n of t){const a=e.indexOf(n.type);a>=0&&a<32&&(r|=1<<a)}return r>>>0}function Fs(t,e){const r=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],n=[];for(let a=0;a<32;a++)if(t&1<<a){const o=r[a];o&&n.push({type:o,addedByPlayerId:e})}return n}function Ws(t){var y;const e=[],r=Date.now(),n=new Uint8Array(7);n[0]=ft.CARD_STATE,n[1]=r>>24&255,n[2]=r>>16&255,n[3]=r>>8&255,n[4]=r&255,e.push(n);const a=[],o=Math.min(t.players.length,255);a.push(new Uint8Array([o]));for(const A of t.players){a.push(new Uint8Array([A.id&255]));const f=_t.indexOf(A.color);a.push(new Uint8Array([f>=0?f:0])),a.push(new Uint8Array([Math.min(A.score,255)])),a.push(new Uint8Array([A.isReady?1:0]))}const c=t.board.length;a.push(new Uint8Array([c,c,c]));const i=[];for(let A=0;A<t.board.length;A++)for(let f=0;f<((y=t.board[A])==null?void 0:y.length);f++){const I=t.board[A][f];I!=null&&I.card&&i.push({row:A,col:f,card:I.card})}const s=i.length,d=new Uint8Array(2);d[0]=s>>8&255,d[1]=s&255,a.push(d);for(const{row:A,col:f,card:I}of i)a.push(new Uint8Array([A,f])),a.push($s(I));a.push(new Uint8Array([t.currentPhase===void 0?255:Math.clamp(t.currentPhase,0,254),(t.activePlayerId??255)&255,t.currentRound===void 0?255:Math.clamp(t.currentRound,0,254)]));let E=0;for(const A of a)E+=A.length;n[5]=E>>8&255,n[6]=E&255,e.push(...a);const P=new Uint8Array(e.reduce((A,f)=>A+f.length,0));let S=0;for(const A of e)P.set(A,S),S+=A.length;return l.info(`[GameCodec] Encoded card state: ${P.length} bytes (${s} board cards, ${t.players.length} players)`),P}function Bs(t){let e=0;if(t[e++]!==ft.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++],t[e++]<<8|t[e++];const r=t[e++],n=[];for(let y=0;y<r;y++){const A=t[e++],f=t[e++],I=_t[f]||"blue",p=t[e++],_=t[e++]===1;n.push({id:A,name:"",color:I,score:p,isReady:_,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:Ce.Random,boardHistory:[],isDummy:!1,isDisconnected:!1,teamId:void 0})}const a=t[e++];e++,e++;const o=t[e++]<<8|t[e++],c=[];for(let y=0;y<a;y++){const A=[];for(let f=0;f<a;f++)A.push({card:null});c.push(A)}for(let y=0;y<o;y++){const A=t[e++],f=t[e++],{card:I,bytesConsumed:p}=Ys(t,e);e+=p,A<c.length&&f<c[A].length&&(c[A][f]={card:I})}const i=t[e++],s=t[e++],d=t[e++];return{players:n,board:c,currentPhase:i===255?void 0:i,activePlayerId:s===255?null:s,currentRound:d===255?void 0:d}}function Ys(t,e){const r=new TextDecoder;let n=e;const a=t[n++],o=r.decode(t.subarray(n,n+a));n+=a;const c=t[n++];let i=t[n++];i>127&&(i=i-256);const s=t[n++],d=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++],E=zs(o);return{card:{id:`${o}_${c}_${Date.now()}_${Math.random()}`,baseId:o,deck:"Random",name:(E==null?void 0:E.name)||o,imageUrl:(E==null?void 0:E.imageUrl)||"",power:i,ability:(E==null?void 0:E.ability)||"",types:(E==null?void 0:E.types)||[],faction:(E==null?void 0:E.faction)||"",ownerId:c,isFaceDown:(s&1)!==0,enteredThisTurn:(s&2)!==0,revealedTo:s&4?"all":void 0,statuses:Fs(d,0)},bytesConsumed:n-e}}function zs(t){try{if(xe){if(xe.cardDatabase&&xe.cardDatabase[t]){const r=xe.cardDatabase[t];return l.debug(`[GameCodec] Found card ${t} in cardDatabase`),{name:r.name||t,imageUrl:r.imageUrl||r.fallbackImage||"",power:r.power||0,ability:r.ability||"",types:r.types||[],faction:r.faction||""}}if(xe.tokenDatabase&&xe.tokenDatabase[t]){const r=xe.tokenDatabase[t];return l.debug(`[GameCodec] Found token ${t} in tokenDatabase`),{name:r.name||t,imageUrl:r.imageUrl||r.fallbackImage||"",power:r.power||0,ability:r.ability||"",types:r.types||[],faction:r.faction||""}}}const e=Be==null?void 0:Be(t);if(e)return l.debug(`[GameCodec] Found card ${t} via getCardDefinition`),{name:e.name||t,imageUrl:e.imageUrl||"",power:e.power||0,ability:e.ability||"",types:e.types||[],faction:e.faction||""}}catch(e){l.warn(`[GameCodec] Failed to look up card ${t}:`,e)}return l.warn(`[GameCodec] Card ${t} not found in local database`),null}Math.clamp||(Math.clamp=function(t,e,r){return Math.min(Math.max(t,e),r)});function ar(t,e){return Ws(t)}function Ks(t,e){return Bs(t)}function qs(t){return Yt(t)}function _a(t){l.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return la(t)}catch(e){return l.error("[webrtcSerialization] Failed to serialize delta:",e),new Uint8Array(0)}}function Sa(t){l.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Yt(t)}catch(e){return l.error("[webrtcSerialization] Failed to deserialize delta:",e),{}}}function Vs(t){const e=_a(t);let r="";const n=new Uint8Array(e),a=n.byteLength;for(let o=0;o<a;o++)r+=String.fromCharCode(n[o]);return btoa(r)}function js(t){const e=atob(t),r=new Uint8Array(e.length);for(let n=0;n<e.length;n++)r[n]=e.charCodeAt(n);return Sa(r)}function ra(t){try{const e=atob(t),r=new Uint8Array(e.length);for(let o=0;o<e.length;o++)r[o]=e.charCodeAt(o);const a=Yt(r);return l.info("[deserializePersonalizedizedState] Decoded state, has players:",!!a.players,"keys:",Object.keys(a)),a}catch(e){throw l.error("[deserializePersonalizedState] Failed to decode:",e),e}}function na(t){try{const e=t.map(a=>a.baseId||a.id),r=la(e),n=String.fromCharCode(...r);return btoa(n)}catch(e){throw l.error("[serializeDeckCards] Failed to encode:",e),e}}function aa(t,e){try{const r=atob(t),n=new Uint8Array(r.length);for(let c=0;c<r.length;c++)n[c]=r.charCodeAt(c);const a=Yt(n),{getCardDefinition:o}=require("../content");return a.map((c,i)=>{const s=o(c);return s?{id:`${e}_deck_${i}_${Date.now()}`,baseId:c,name:s.name,imageUrl:s.imageUrl,power:s.power||0,ability:s.ability||"",types:s.types||[],faction:s.faction||"",color:s.color||"Red",ownerId:e,isFaceDown:!0,statuses:[]}:{id:`${e}_deck_${i}_${Date.now()}`,baseId:c,name:"Unknown",imageUrl:"",power:0,ownerId:e,isFaceDown:!0,statuses:[]}})}catch(r){throw l.error("[deserializeDeckCards] Failed to decode:",r),r}}function Js(t,e){var P;const r=new TextEncoder,n=[],a=Date.now(),o=new Uint8Array(7);o[0]=ft.ABILITY_EFFECT,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,n.push(o);const c=[];if(c.push(new Uint8Array([t])),e.sourcePos){const S=(e.sourcePos.row&15)<<4|e.sourcePos.col&15;c.push(new Uint8Array([S]))}else c.push(new Uint8Array([255]));const i=((P=e.targetPositions)==null?void 0:P.length)||0;if(c.push(new Uint8Array([Math.min(i,255)])),e.targetPositions)for(const S of e.targetPositions.slice(0,255)){const y=(S.row&15)<<4|S.col&15;c.push(new Uint8Array([y]))}if(e.text){const S=r.encode(e.text),y=Math.min(S.length,255);c.push(new Uint8Array([y])),c.push(S.slice(0,y))}else c.push(new Uint8Array([0]));c.push(new Uint8Array([(e.value??0)&255])),c.push(new Uint8Array([(e.playerId??0)&255]));let s=0;for(const S of c)s+=S.length;o[5]=s>>8&255,o[6]=s&255,n.push(...c);const d=new Uint8Array(n.reduce((S,y)=>S+y.length,0));let E=0;for(const S of n)d.set(S,E),E+=S.length;return l.debug(`[AbilityMessages] Encoded effect type ${t}: ${d.length} bytes`),d}function Xs(t){let e=0;if(t[e++]!==ft.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const r=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];e+=2;const n={effectType:t[e++],timestamp:r,data:{}},a=t[e++];a!==255&&(n.data.sourcePos={row:a>>4&15,col:a&15});const o=t[e++];if(o>0){n.data.targetPositions=[];for(let i=0;i<o;i++){const s=t[e++];n.data.targetPositions.push({row:s>>4&15,col:s&15})}}const c=t[e++];if(c>0){const i=new TextDecoder;n.data.text=i.decode(t.subarray(e,e+c)),e+=c}return n.data.value=t[e++],n.data.playerId=t[e++],n}function Zs(t,e={}){const r=new TextEncoder,n=[],a=Date.now(),o=new Uint8Array(7);o[0]=ft.SESSION_EVENT,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,n.push(o);const c=[];if(c.push(new Uint8Array([t])),c.push(new Uint8Array([(e.playerId??0)&255])),e.playerName){const P=r.encode(e.playerName),S=Math.min(P.length,255);c.push(new Uint8Array([S])),c.push(P.slice(0,S))}else c.push(new Uint8Array([0]));c.push(new Uint8Array([(e.startingPlayerId??0)&255])),c.push(new Uint8Array([Math.min(e.roundNumber??0,255)])),c.push(new Uint8Array([Math.min(e.newPhase??0,255)])),c.push(new Uint8Array([(e.newActivePlayerId??0)&255])),c.push(new Uint8Array([(e.gameWinner??255)&255]));let i=0;if(e.winners)for(const P of e.winners)P<32&&(i|=1<<P);c.push(new Uint8Array([i>>24&255,i>>16&255,i>>8&255,i&255]));let s=0;for(const P of c)s+=P.length;o[5]=s>>8&255,o[6]=s&255,n.push(...c);const d=new Uint8Array(n.reduce((P,S)=>P+S.length,0));let E=0;for(const P of n)d.set(P,E),E+=P.length;return l.debug(`[SessionMessages] Encoded event type ${t}: ${d.length} bytes`),d}function Qs(t){let e=0;if(t[e++]!==ft.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const r=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];e+=2;const n={eventType:t[e++],timestamp:r,data:{}};n.data.playerId=t[e++];const a=t[e++];if(a>0){const i=new TextDecoder;n.data.playerName=i.decode(t.subarray(e,e+a)),e+=a}n.data.startingPlayerId=t[e++],n.data.roundNumber=t[e++],n.data.newPhase=t[e++],n.data.newActivePlayerId=t[e++];const o=t[e++];n.data.gameWinner=o===255?null:o;const c=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];if(c!==0){n.data.winners=[];for(let i=0;i<32;i++)c&1<<i&&n.data.winners.push(i)}return n}class ei{constructor(e={}){this.peer=null,this.connections=new Map,this.guests=new Map,this.eventHandlers=new Set,this.reconnectingPlayers=new Map,this.reconnectionTimeout=3e4,this.config={maxGuests:e.maxGuests??4,autoAcceptGuests:e.autoAcceptGuests??!0,enableReconnection:e.enableReconnection??!1},localStorage.getItem("webrtc_enabled")}async initialize(){return this.peer&&this.cleanup(),new Promise((e,r)=>{this.peer=new Ht,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),e(n)}),this.peer.on("connection",n=>{l.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{l.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{l.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}handleGuestConnection(e){const r=e.peer;if(this.config.maxGuests&&this.connections.size>=this.config.maxGuests){l.warn(`Max guests limit reached: ${this.connections.size}/${this.config.maxGuests}`),e.close();return}const n={peerId:r,playerId:null,playerName:null,connected:!1,connectedAt:Date.now()};this.connections.set(r,e),this.guests.set(r,n),e.on("open",()=>{n.connected=!0,this.emitEvent({type:"guest_connected",data:{peerId:r}})}),e.on("data",a=>{this.handleMessage(a,r)}),e.on("close",()=>{const a=this.guests.get(r),o=a==null?void 0:a.playerId;this.connections.delete(r),this.guests.delete(r),o!=null&&this.config.enableReconnection&&this.markPlayerReconnecting(o,r),this.emitEvent({type:"guest_disconnected",data:{peerId:r,playerId:o}})}),e.on("error",a=>{l.error(`Guest connection error (${r}):`,a)})}handleMessage(e,r){var o,c,i;const n=this.guests.get(r),a=(n==null?void 0:n.playerId)??e.playerId??"unknown";e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE"?l.info(`[HostConnectionManager] Received ${e.type} from peer ${r} (player ${a})`,{hasData:!!e.data,hasTargetingMode:!!((o=e.data)!=null&&o.targetingMode),targetingModePlayerId:(i=(c=e.data)==null?void 0:c.targetingMode)==null?void 0:i.playerId,timestamp:e.timestamp}):l.debug(`Received WebRTC message from ${r}:`,e.type),this.emitEvent({type:"message_received",data:{message:e,fromPeerId:r}})}sendToGuest(e,r){const n=this.connections.get(e);if(!n)return l.error(`[sendToGuest] No connection found for ${e}`),!1;if(!n.open)return l.error(`[sendToGuest] Connection for ${e} is not open`),!1;try{return l.info(`[sendToGuest] Sending ${r.type} to ${e}`),n.send(r),l.info(`[sendToGuest] Sent ${r.type} to ${e} successfully`),!0}catch(a){return l.error(`[sendToGuest] Failed to send message to ${e}:`,a),!1}}broadcast(e,r){let n=0;return this.connections.forEach((a,o)=>{if(a.open&&o!==r)try{a.send(e),n++}catch(c){l.error(`Failed to send to guest ${o}:`,c)}}),l.debug(`Broadcast to ${n}/${this.connections.size} guests`),n}acceptGuestMinimal(e,r,n){var c;const a=this.connections.get(e);if(!a)return l.error(`[acceptGuestMinimal] No connection found for ${e}`),!1;if(!a.open)return l.error(`[acceptGuestMinimal] Connection for ${e} is not open`),!1;const o=this.guests.get(e);o&&(o.playerId=n);try{const i={type:"JOIN_ACCEPT_MINIMAL",senderId:(c=this.peer)==null?void 0:c.id,playerId:n,data:r,timestamp:Date.now()};return a.send(i),l.info(`Accepted guest ${e} as player ${n} (minimal)`),!0}catch(i){return l.error(`[acceptGuestMinimal] Failed to send to ${e}:`,i),!1}}acceptGuest(e,r,n){var c;const a=this.connections.get(e);if(!a)return l.error(`[acceptGuest] No connection found for ${e}`),!1;if(!a.open)return l.error(`[acceptGuest] Connection for ${e} is not open`),!1;const o=this.guests.get(e);o&&(o.playerId=n);try{const i=ar(r,n),s=btoa(String.fromCharCode(...i)),d={type:"JOIN_ACCEPT_BINARY",senderId:(c=this.peer)==null?void 0:c.id,playerId:n,data:s,timestamp:Date.now()};return a.send(d),l.info(`[acceptGuest] Sent JOIN_ACCEPT_BINARY to ${e}, state size: ${s.length} chars`),!0}catch(i){return l.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${e}:`,i),!1}}broadcastGameState(e,r){if(this.connections.size===0)return;const n=e.players.map(o=>`P${o.id}:${o.score}`).join(", ");l.info(`[broadcastGameState] Broadcasting state with scores: ${n}, currentPhase=${e.currentPhase}, activePlayerId=${e.activePlayerId}`);let a=0;this.connections.forEach((o,c)=>{var s;if(!o.open||r&&c===r)return;const i=this.guests.get(c);if(i)try{const d=ar(e,i.playerId),E=btoa(String.fromCharCode(...d)),P={type:"CARD_STATE",senderId:(s=this.peer)==null?void 0:s.id,data:E,timestamp:Date.now()};o.send(P),a++}catch(d){l.error(`[broadcastGameState] Failed to send to guest ${c} (player ${i.playerId}):`,d)}}),l.debug(`[broadcastGameState] Sent to ${a}/${this.connections.size} guests`)}broadcastStateDelta(e,r){var n,a;{const o=Vs(e),c={type:"STATE_DELTA_BINARY",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()};l.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${o.length} chars, playerDeltas=${Object.keys(e.playerDeltas||{}).length}, boardCells=${((a=e.boardCells)==null?void 0:a.length)||0}`),this.broadcast(c,r),l.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${e.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(e,r,n){var a;try{const o=ar(e,r),c=btoa(String.fromCharCode(...o)),i={type:"CARD_STATE",senderId:(a=this.peer)==null?void 0:a.id,data:c,timestamp:Date.now()},s=this.broadcast(i,n);return l.info(`[broadcastCardState] Sent ${o.length} bytes to ${s} guests`),s}catch(o){return l.error("[broadcastCardState] Failed to encode/broadcast state:",o),0}}broadcastAbilityEffect(e,r,n){var a;try{const o=Js(e,r),c=btoa(String.fromCharCode(...o)),i={type:"ABILITY_EFFECT",senderId:(a=this.peer)==null?void 0:a.id,data:c,timestamp:Date.now()},s=this.broadcast(i,n);return l.debug(`[broadcastAbilityEffect] Sent effect ${e} to ${s} guests`),s}catch(o){return l.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",o),0}}broadcastSessionEvent(e,r,n){var a;try{const o=Zs(e,r),c=btoa(String.fromCharCode(...o)),i={type:"SESSION_EVENT",senderId:(a=this.peer)==null?void 0:a.id,data:c,timestamp:Date.now()},s=this.broadcast(i,n);return l.debug(`[broadcastSessionEvent] Sent event ${e} to ${s} guests`),s}catch(o){return l.error("[broadcastSessionEvent] Failed to encode/broadcast event:",o),0}}broadcastHighlight(e,r,n,a){return this.broadcastAbilityEffect(Rt.HIGHLIGHT_CELL,{sourcePos:{row:e,col:r},playerId:n},a)}broadcastFloatingText(e,r,n,a){return this.broadcastAbilityEffect(Rt.FLOATING_TEXT,{sourcePos:{row:e,col:r},text:n},a)}broadcastTargetingMode(e,r,n){return this.broadcastAbilityEffect(Rt.TARGETING_MODE,{sourcePos:e,targetPositions:r},n)}broadcastClearTargeting(e){return this.broadcastAbilityEffect(Rt.CLEAR_TARGETING,{},e)}broadcastPlayerConnected(e,r,n){return this.broadcastSessionEvent(1,{playerId:e,playerName:r},n)}broadcastPlayerDisconnected(e,r){return this.broadcastSessionEvent(2,{playerId:e},r)}broadcastCardStatusSync(e,r){var n;try{const a={type:"CARD_STATUS_SYNC",senderId:(n=this.peer)==null?void 0:n.id,data:{changes:e},timestamp:Date.now()},o=this.broadcast(a,r);return l.info(`[broadcastCardStatusSync] Sent ${e.length} status changes to ${o} guests`),o}catch(a){return l.error("[broadcastCardStatusSync] Failed to broadcast:",a),0}}broadcastBoardCardSync(e,r,n){var a;try{const o={type:"BOARD_CARD_SYNC",senderId:(a=this.peer)==null?void 0:a.id,data:{cards:e,action:r,timestamp:Date.now()},timestamp:Date.now()},c=this.broadcast(o,n);return l.info(`[broadcastBoardCardSync] Sent ${e.length} card data (${r}) to ${c} guests`),c}catch(o){return l.error("[broadcastBoardCardSync] Failed to broadcast:",o),0}}broadcastGameStart(e,r){return this.broadcastSessionEvent(3,{startingPlayerId:e},r)}broadcastRoundStart(e,r){return this.broadcastSessionEvent(4,{roundNumber:e},r)}broadcastRoundEnd(e,r,n){return this.broadcastSessionEvent(5,{roundNumber:e,winners:r},n)}broadcastPhaseChange(e,r,n){return this.broadcastSessionEvent(6,{newPhase:e,newActivePlayerId:r},n)}broadcastTurnChange(e,r){return this.broadcastSessionEvent(7,{newActivePlayerId:e},r)}broadcastGameEnd(e,r){return this.broadcastSessionEvent(8,{gameWinner:e},r)}sendAction(e,r){var a;const n={type:"ACTION",senderId:(a=this.peer)==null?void 0:a.id,data:{actionType:e,actionData:r},timestamp:Date.now()};return this.broadcast(n)>0}getConnectionInfo(){const e=[];return this.connections.forEach((r,n)=>{const a=this.guests.get(n);e.push({peerId:n,playerId:(a==null?void 0:a.playerId)||null,playerName:(a==null?void 0:a.playerName)||null,connected:r.open})}),e}getGuest(e){return this.guests.get(e)}getGuestByPlayerId(e){return Array.from(this.guests.values()).find(r=>r.playerId===e)}setGuestPlayerId(e,r){const n=this.guests.get(e);n&&(n.playerId=r)}getPeerId(){var e;return((e=this.peer)==null?void 0:e.id)||null}getGuestCount(){return this.connections.size}hasGuests(){return Array.from(this.connections.values()).some(e=>e.open)}markPlayerReconnecting(e,r){this.reconnectingPlayers.set(e,{disconnectedAt:Date.now(),oldPeerId:r}),setTimeout(()=>{const n=this.reconnectingPlayers.get(e);n&&Date.now()-n.disconnectedAt>=this.reconnectionTimeout&&this.reconnectingPlayers.delete(e)},this.reconnectionTimeout),l.info(`[Reconnection] Player ${e} marked as reconnecting, window: ${this.reconnectionTimeout}ms`)}isPlayerReconnecting(e){const r=this.reconnectingPlayers.get(e);return r?Date.now()-r.disconnectedAt>=this.reconnectionTimeout?(this.reconnectingPlayers.delete(e),!1):!0:!1}getPlayerReconnectTimeRemaining(e){const r=this.reconnectingPlayers.get(e);if(!r)return 0;const n=Date.now()-r.disconnectedAt;return Math.max(0,this.reconnectionTimeout-n)}acceptPlayerReconnect(e,r,n){var c;if(!this.isPlayerReconnecting(r))return l.warn(`[Reconnection] Player ${r} not in reconnection window or expired`),!1;const a=this.connections.get(e);if(!a||!a.open)return l.error(`[Reconnection] No valid connection for ${e}`),!1;this.reconnectingPlayers.delete(r);const o={type:"RECONNECT_ACCEPT",senderId:(c=this.peer)==null?void 0:c.id,playerId:r,data:{gameState:n},timestamp:Date.now()};try{a.send(o),l.info(`[Reconnection] Player ${r} reconnected from ${e}`);const i=this.guests.get(e);return i&&(i.playerId=r),!0}catch(i){return l.error("[Reconnection] Failed to send RECONNECT_ACCEPT:",i),!1}}rejectPlayerReconnect(e,r){var o;const n=this.connections.get(e);if(!n||!n.open)return;const a={type:"RECONNECT_REJECT",senderId:(o=this.peer)==null?void 0:o.id,data:{reason:r},timestamp:Date.now()};try{n.send(a),n.close(),l.info(`[Reconnection] Rejected reconnection from ${e}, reason: ${r}`)}catch(c){l.error("[Reconnection] Failed to send RECONNECT_REJECT:",c)}}getReconnectingPlayers(){const e=Date.now(),r=[];return this.reconnectingPlayers.forEach((n,a)=>{e-n.disconnectedAt<this.reconnectionTimeout?r.push(a):this.reconnectingPlayers.delete(a)}),r}cancelPlayerReconnection(e){this.reconnectingPlayers.delete(e)}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>{try{r(e)}catch(n){l.error("Error in WebRTC event handler:",n)}})}cleanup(){if(this.connections.forEach(e=>e.close()),this.connections.clear(),this.guests.clear(),this.reconnectingPlayers.clear(),this.peer){try{this.peer.destroy()}catch{}this.peer=null}}}class ti{constructor(){this.peer=null,this.connections=new Map,this.eventHandlers=new Set,localStorage.getItem("webrtc_enabled")}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>r(e))}getPeerId(){var e;return((e=this.peer)==null?void 0:e.id)??null}getConnection(e){return this.connections.get(e)}getAllConnections(){return this.connections}isInitialized(){return this.peer!==null}async initializeAsHost(e){return this.peer&&this.cleanup(),new Promise((r,n)=>{this.peer=e?new Ht(e):new Ht,this.peer.on("open",a=>{this.emitEvent({type:"peer_open",data:{peerId:a}}),r(a)}),this.peer.on("connection",a=>{l.info(`Incoming connection from: ${a.peer}`),this.handleConnection(a)}),this.peer.on("error",a=>{l.error("WebrtcPeer error:",a),this.emitEvent({type:"error",data:a}),n(a)}),this.peer.on("close",()=>{l.warn("WebrtcPeer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(){return this.peer&&this.cleanup(),new Promise((e,r)=>{this.peer=new Ht,this.peer.on("open",n=>{e(n)}),this.peer.on("error",n=>{l.error("WebrtcPeer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{l.warn("WebrtcPeer closed"),this.emitEvent({type:"peer_closed"})})})}connectTo(e){if(!this.peer)return l.error("Cannot connect: peer not initialized"),null;const r=this.peer.connect(e,{reliable:!0,serialization:"json"});return this.handleConnection(r),r}handleConnection(e){this.connections.set(e.peer,e),e.on("open",()=>{l.info(`Connection opened: ${e.peer}`),this.emitEvent({type:"connection_open",data:{peerId:e.peer}})}),e.on("data",r=>{this.emitEvent({type:"connection_data",data:{peerId:e.peer,data:r}})}),e.on("close",()=>{l.info(`Connection closed: ${e.peer}`),this.connections.delete(e.peer),this.emitEvent({type:"connection_closed",data:{peerId:e.peer}})}),e.on("error",r=>{l.error(`Connection error (${e.peer}):`,r),this.emitEvent({type:"error",data:{peerId:e.peer,error:r}})})}sendTo(e,r){const n=this.connections.get(e);if(!n)return l.error(`[sendTo] No connection found for peer ${e}`),!1;if(!n.open)return l.error(`[sendTo] Connection for peer ${e} is not open`),!1;try{return n.send(r),!0}catch(a){return l.error(`[sendTo] Failed to send to ${e}:`,a),!1}}broadcast(e,r){let n=0;return this.connections.forEach((a,o)=>{if(a.open&&o!==r)try{a.send(e),n++}catch(c){l.error(`[broadcast] Failed to send to ${o}:`,c)}}),n}closeConnection(e){const r=this.connections.get(e);r&&(r.close(),this.connections.delete(e))}cleanup(){if(this.connections.forEach(e=>{try{e.close()}catch{}}),this.connections.clear(),this.peer){try{this.peer.destroy()}catch{}this.peer=null}}getPeer(){return this.peer}}const ri=["readySetup","readyCommit"];function ur(t){const e=(t.statuses||[]).filter(n=>!ri.includes(n.type));return(t.statuses||[]).some(n=>n.type==="readyDeploy")&&l.debug(`[optimizeCard] Card ${t.name} has readyDeploy, including in broadcast`),{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier||0,isFaceDown:t.isFaceDown,statuses:e,ownerId:t.ownerId,deck:t.deck,ability:t.ability,color:t.color,types:t.types,faction:t.faction,imageUrl:t.imageUrl}}function ot(t){return{id:t.id,baseId:t.baseId||t.id,power:t.power,powerModifier:t.powerModifier||0,isFaceDown:t.isFaceDown??!1,statuses:t.statuses||[]}}function ni(t,e){return{...t,players:t.players.map(r=>{if(r.id===e)return l.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(n=>ot(n)),deckCards:r.deck.map(n=>ot(n)),discardCards:r.discard.map(n=>ot(n)),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?ur(r.announcedCard):null,deckSize:r.deck.length,discardSize:r.discard.length,handSize:r.hand.length};{const a=r.hand.filter(i=>i.statuses&&i.statuses.length>0).length>0,o=r.isDummy===!0,c={...r,...a&&{handCards:r.hand.map(i=>ot(i))},hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0};return o&&(l.info(`[createCompactStateForHost] Dummy player ${r.id}: sending ${r.hand.length} hand, ${r.deck.length} deck, ${r.discard.length} discard`),c.handCards=r.hand.map(i=>ot(i)),c.deckCards=r.deck.map(i=>ot(i)),c.discardCards=r.discard.map(i=>ot(i))),r.id===e?l.info(`[createCompactStateForHost] Local player ${r.id} score: ${r.score}`):l.info(`[createCompactStateForHost] Other player ${r.id} (${o?"dummy":"real"}) score: ${c.score} (from original)`),c}}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?ur(n.card):null})))}}class oa{constructor(e={}){this.hostPeerId=null,this.eventHandlers=new Set,this.config=e,this.webrtcPeer=new ti,this.webrtcPeer.on(r=>this.handlePeerEvent(r)),localStorage.getItem("webrtc_enabled")}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>r(e))}handlePeerEvent(e){var r,n,a,o,c,i;switch(e.type){case"peer_open":this.hostPeerId&&this.webrtcPeer.connectTo(this.hostPeerId);break;case"connection_open":l.info(`Connected to host: ${e.data.peerId}`),this.emitEvent({type:"connected_to_host",data:{hostPeerId:e.data.peerId}}),(n=(r=this.config).onHostConnected)==null||n.call(r);break;case"connection_closed":l.warn("Host connection closed"),this.emitEvent({type:"host_disconnected"}),(o=(a=this.config).onHostDisconnected)==null||o.call(a);break;case"connection_data":this.handleMessage(e.data.data);break;case"error":l.error("WebRTC error:",e.data),this.emitEvent({type:"error",data:e.data}),(i=(c=this.config).onError)==null||i.call(c,e.data);break}}handleMessage(e){var r,n;e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE"||e.type==="JOIN_ACCEPT_MINIMAL"||e.type==="JOIN_ACCEPT"?l.info(`[GuestConnection] Received ${e.type} from host`,{senderId:e.senderId,playerId:e.playerId,hasData:!!e.data,timestamp:e.timestamp}):l.info(`[GuestConnection] Received ${e.type} from host`),this.emitEvent({type:"message_received",data:e}),(n=(r=this.config).onMessage)==null||n.call(r,e)}async connect(e){if(this.hostPeerId=e,await this.webrtcPeer.initializeAsGuest(),this.webrtcPeer.isInitialized()){const r=this.webrtcPeer.connectTo(e);if(!r)throw new Error("Failed to create connection to host");return new Promise((n,a)=>{const o=setTimeout(()=>{a(new Error("Connection timeout"))},1e4),c=()=>{clearTimeout(o);let s=null;try{const d=localStorage.getItem("webrtc_preferred_deck");d&&(s=d,l.info(`[connect] Found deck preference in localStorage: ${s}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(d){l.warn("[connect] Failed to read deck preference:",d)}this.sendMessage({type:"JOIN_REQUEST",senderId:this.getPeerId()??void 0,data:{preferredDeck:s||void 0},timestamp:Date.now()}),n()},i=s=>{clearTimeout(o),a(s)};r.once("open",c),r.once("error",i)})}}async connectAsReconnecting(e,r){this.hostPeerId=e,await this.webrtcPeer.initializeAsGuest();const n=this.webrtcPeer.connectTo(e);if(!n)throw new Error("Failed to create connection to host");return new Promise((a,o)=>{const c=setTimeout(()=>{o(new Error("Reconnection timeout"))},1e4),i=()=>{clearTimeout(c),this.sendMessage({type:"PLAYER_RECONNECT",senderId:this.getPeerId()??void 0,playerId:r,timestamp:Date.now()}),a()},s=d=>{clearTimeout(c),o(d)};n.once("open",i),n.once("error",s)})}sendMessage(e){var n,a,o;if(!this.hostPeerId)return l.warn("[GuestConnection] Not connected to host"),!1;const r=this.webrtcPeer.sendTo(this.hostPeerId,e);return(e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE")&&(r?l.info(`[GuestConnection] Sent ${e.type} to host`,{hasData:!!e.data,hasTargetingMode:!!((n=e.data)!=null&&n.targetingMode),targetingModePlayerId:(o=(a=e.data)==null?void 0:a.targetingMode)==null?void 0:o.playerId,timestamp:e.timestamp}):l.warn(`[GuestConnection] Could not send ${e.type} to host`)),r}sendAction(e,r){const n={type:"ACTION",senderId:this.getPeerId()??void 0,data:{actionType:e,actionData:r},timestamp:Date.now()};return this.sendMessage(n)}sendStateDelta(e){{const r=_a(e),n={type:"STATE_DELTA_BINARY",senderId:this.getPeerId()??void 0,data:r,timestamp:Date.now()};return this.sendMessage(n)}}sendStateToHost(e,r){var c,i;if(r===null)return l.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const n=ni(e,r),a=e.players.find(s=>s.id===r);a&&l.info(`[sendStateToHost] Player ${r} sending compact state: hand=${((c=a.hand)==null?void 0:c.length)??0}, deck=${((i=a.deck)==null?void 0:i.length)??0}, score=${a.score}`);const o={type:"STATE_UPDATE_COMPACT",senderId:this.getPeerId()??void 0,playerId:r,data:{gameState:n},timestamp:Date.now()};return this.sendMessage(o)}sendFullDeckToHost(e,r,n){const a={type:"DECK_DATA_UPDATE",senderId:this.getPeerId()??void 0,playerId:e,data:{playerId:e,deck:r.map(o=>ur(o)),deckSize:n},timestamp:Date.now()};return this.sendMessage(a)}sendCustomDeckData(e,r,n){if(!n)return!0;l.info(`[sendCustomDeckData] Player ${e} sending ${r.length} custom deck cards to host`);const a=r.map(c=>({id:c.id,baseId:c.baseId,name:c.name,power:c.power,powerModifier:c.powerModifier,ability:c.ability,types:c.types,faction:c.faction,imageUrl:c.imageUrl,color:c.color,deck:c.deck})),o={type:"CUSTOM_DECK_DATA",senderId:this.getPeerId()??void 0,playerId:e,data:{playerId:e,deckCards:a},timestamp:Date.now()};return this.sendMessage(o)}getPeerId(){return this.webrtcPeer.getPeerId()}getHostPeerId(){return this.hostPeerId}isConnected(){if(!this.hostPeerId)return!1;const e=this.webrtcPeer.getConnection(this.hostPeerId);return(e==null?void 0:e.open)??!1}getConnectionCount(){return this.isConnected()?1:0}getConnectionInfo(){if(!this.hostPeerId)return[];const e=this.webrtcPeer.getConnection(this.hostPeerId);return[{peerId:this.hostPeerId,playerId:null,playerName:null,connected:(e==null?void 0:e.open)??!1}]}cleanup(){this.webrtcPeer.cleanup(),this.hostPeerId=null}}class ai{constructor(){this.mode=null,this.hostManager=null,this.guestManager=null,this.eventHandlers=new Set,this.isReconnecting=!1}async initializeAsHost(e){return this.mode==="guest"&&this.cleanup(),this.mode="host",this.hostManager=new ei({enableReconnection:!0}),this.hostManager.on(r=>this.emitEvent(r)),this.hostManager.initialize()}async initializeAsGuest(e){this.mode==="host"&&this.cleanup(),this.mode="guest",this.guestManager=new oa({onMessage:r=>this.emitEvent({type:"message_received",data:r}),onHostConnected:()=>this.emitEvent({type:"connected_to_host"}),onHostDisconnected:()=>this.emitEvent({type:"host_disconnected"}),onError:r=>this.emitEvent({type:"error",data:r})}),await this.guestManager.connect(e)}async initializeAsReconnectingGuest(e,r){this.mode==="host"&&this.cleanup(),this.mode="guest",this.isReconnecting=!0,this.guestManager=new oa({onMessage:n=>this.emitEvent({type:"message_received",data:n}),onHostConnected:()=>{this.isReconnecting=!1,this.emitEvent({type:"connected_to_host"})},onHostDisconnected:()=>this.emitEvent({type:"host_disconnected"}),onError:n=>{this.isReconnecting=!1,this.emitEvent({type:"error",data:n})}}),await this.guestManager.connectAsReconnecting(e,r),this.isReconnecting=!1}acceptGuest(e,r,n){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.acceptGuest(e,r,n)}acceptGuestMinimal(e,r,n){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.acceptGuestMinimal(e,r,n)}broadcastGameState(e,r){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.broadcastGameState(e,r)}broadcastStateDelta(e,r){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.broadcastStateDelta(e,r)}broadcastCardStatusSync(e,r){return this.hostManager?this.hostManager.broadcastCardStatusSync(e,r):(l.warn("[WebrtcManager] Not in host mode"),0)}broadcastBoardCardSync(e,r,n){return this.hostManager?this.hostManager.broadcastBoardCardSync(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}broadcastToGuests(e,r){return this.hostManager?this.hostManager.broadcast(e,r):(l.warn("[WebrtcManager] Not in host mode"),0)}sendToGuest(e,r){return this.hostManager?this.hostManager.sendToGuest(e,r):(l.warn("[WebrtcManager] Not in host mode"),!1)}sendAction(e,r){return this.guestManager?this.guestManager.sendAction(e,r):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendStateDelta(e){return this.guestManager?this.guestManager.sendStateDelta(e):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendStateToHost(e,r){return this.guestManager?this.guestManager.sendStateToHost(e,r):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendFullDeckToHost(e,r,n){return this.guestManager?this.guestManager.sendFullDeckToHost(e,r,n):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendCustomDeckData(e,r,n){return this.guestManager?this.guestManager.sendCustomDeckData(e,r,n):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendMessageToHost(e){return this.mode!=="guest"||!this.guestManager?!1:this.guestManager.sendMessage(e)}broadcastCardState(e,r,n){return this.hostManager?this.hostManager.broadcastCardState(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}broadcastAbilityEffect(e,r,n){return this.hostManager?this.hostManager.broadcastAbilityEffect(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}broadcastSessionEvent(e,r,n){return this.hostManager?this.hostManager.broadcastSessionEvent(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}getPeerId(){return this.mode==="host"&&this.hostManager?this.hostManager.getPeerId():this.mode==="guest"&&this.guestManager?this.guestManager.getPeerId():null}getHostPeerId(){return this.mode==="guest"&&this.guestManager?this.guestManager.getHostPeerId():this.mode==="host"&&this.hostManager?this.hostManager.getPeerId():null}getConnectionInfo(){return this.mode==="host"&&this.hostManager?this.hostManager.getConnectionInfo():this.mode==="guest"&&this.guestManager?this.guestManager.getConnectionInfo():[]}isConnected(){return this.mode==="host"&&this.hostManager?this.hostManager.hasGuests():this.mode==="guest"&&this.guestManager?this.guestManager.isConnected():!1}isHostMode(){return this.mode==="host"}getConnectionCount(){return this.mode==="host"&&this.hostManager?this.hostManager.getGuestCount():this.mode==="guest"&&this.guestManager?this.guestManager.getConnectionCount():0}getGuest(e){if(this.hostManager)return this.hostManager.getGuest(e)}getGuestByPlayerId(e){if(this.hostManager)return this.hostManager.getGuestByPlayerId(e)}setGuestPlayerId(e,r){this.hostManager&&this.hostManager.setGuestPlayerId(e,r)}isPlayerReconnecting(e){return this.hostManager?this.hostManager.isPlayerReconnecting(e):!1}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>{try{r(e)}catch(n){l.error("Error in WebRTC event handler:",n)}})}cleanup(){this.hostManager&&(this.hostManager.cleanup(),this.hostManager=null),this.guestManager&&(this.guestManager.cleanup(),this.guestManager=null),this.mode=null,this.isReconnecting=!1}get peer(){return this.mode==="host"&&this.hostManager||this.mode==="guest"&&this.guestManager,null}}let or=null;const fr=()=>(or||(or=new ai),or);function oi(t){return 10+t*10}function mr(t){if(!t.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const e=t.currentPhase===1,r=t.activePlayerId===t.startingPlayerId;if(!e||!r)return{shouldEnd:!1,roundWinners:[]};const n=t.currentRound||1,a=oi(n),o=[];for(const i of t.players)!i.isDummy&&!i.isDisconnected&&i.score>=a&&o.push(i.id);return{shouldEnd:o.length>0,roundWinners:o}}function ba(t){const{shouldEnd:e,roundWinners:r}=mr(t);if(!e)return t;const n=t.currentRound||1,a={...t.roundWinners,[n]:r},o=new Map;for(const[,i]of Object.entries(a))for(const s of i){const d=o.get(s)||0;o.set(s,d+1)}let c=null;for(const[i,s]of o.entries())if(s>=2){c=i;break}return l.info(`[endRound] Round ${n} ended. Winners: [${r.join(", ")}], Game winner: ${c||"none"}`),{...t,roundWinners:a,gameWinner:c,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function Er(t,e){if(t.currentPhase!==0)return l.warn(`[performPreparationPhase] Not in Preparation phase (current: ${t.currentPhase})`),t;const r=t.players.find(o=>o.id===e);if(!r)return l.error(`[performPreparationPhase] Active player ${e} not found!`),t;l.info(`[performPreparationPhase] Player ${e} has deck size: ${r.deck.length}, hand size: ${r.hand.length}`);const n=t.players.map(o=>{if(o.id===e&&o.deck.length>0){const c=o.deck[0],i=[...o.deck.slice(1)],s=[...o.hand,c];return l.info(`[performPreparationPhase] Player ${e} drew card ${(c==null?void 0:c.id)||"unknown"}, deck now: ${i.length}, hand: ${s.length}`),{...o,deck:i,hand:s,readySetup:!1,readyCommit:!1}}return o}),a={...t,players:n,currentPhase:1};return Cs(a,e),mr(a).shouldEnd?ba(a):(l.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${a.activePlayerId}`),a)}function Aa(t,e){const r=t.activePlayerId;if(r===e){const i={...t,activePlayerId:null};return e===t.startingPlayerId&&t.currentPhase===1&&mr(i).shouldEnd?ba(i):i}if(!t.players.filter(i=>!i.isDisconnected).find(i=>i.id===e))return l.warn(`[toggleActivePlayer] Player ${e} not found or disconnected`),t;let o=t.turnNumber||1;e===t.startingPlayerId&&r!==null&&o++;const c={...t,activePlayerId:e,turnNumber:o,currentPhase:0};return Er(c,e)}function si(t,e){const r=t.players.filter(o=>!o.isDisconnected).sort((o,c)=>o.id-c.id);if(r.length===0)return null;if(e===null)return r[0].id;const n=r.findIndex(o=>o.id===e);if(n===-1)return r[0].id;const a=(n+1)%r.length;return r[a].id}function ii(t,e){var r;for(const n of t.board)for(const a of n)if(((r=a.card)==null?void 0:r.ownerId)===e)return!0;return!1}function gt(t){const e=si(t,t.activePlayerId);if(e===null)return l.warn("[passTurnToNextPlayer] No next player found"),t;l.info(`[passTurnToNextPlayer] Passing turn from ${t.activePlayerId} to ${e}`);let r={...t,board:t.board.map(n=>n.map(a=>{var o;return((o=a.card)==null?void 0:o.ownerId)===t.activePlayerId&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(c=>c.type!=="Stun")}}:a}))};return t.activePlayerId!==null&&ps(r,t.activePlayerId),r={...r,board:r.board.map(n=>n.map(a=>a.card&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(o=>o.type!=="enteredThisTurn")}}:a))},r={...r,activePlayerId:e,currentPhase:0,isScoringStep:!1,targetingMode:null},Er(r,e)}function sr(t,e,r){return l.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),t}function di(t,e){const{serializePersonalizedState:r}=require("./webrtcSerialization"),{createPersonalizedGameState:n}=require("../host/StatePersonalization"),a=n(t,e??null);return{type:"RECONNECT_SNAPSHOT",data:r(a),_format:"msgpack"}}function ci(t,e,r){var n,a,o,c;try{const i=Ks(t,r);l.info(`[WebRTCCodec] Received card state: ${(n=i.board)==null?void 0:n.length}x${((o=(a=i.board)==null?void 0:a[0])==null?void 0:o.length)||0}, ${((c=i.players)==null?void 0:c.length)||0} players`);const s={...e};return i.players&&(s.players=i.players.map(d=>{const E=e.players.find(P=>P.id===d.id);return E?{...E,score:d.score,isReady:d.isReady,color:d.color}:d})),i.board&&(s.board=i.board),i.currentPhase!==void 0&&(s.currentPhase=i.currentPhase),i.activePlayerId!==void 0&&(s.activePlayerId=i.activePlayerId),i.currentRound!==void 0&&(s.currentRound=i.currentRound),s}catch(i){return l.error("[WebRTCCodec] Failed to deserialize card state:",i),e}}function li(t,e){try{const{effectType:r,timestamp:n,data:a}=Xs(t);l.debug(`[WebRTCCodec] Received ability effect: ${r}`);const o=e;switch(r){case 1:return{gameState:o,effectData:{type:"highlight",...a,timestamp:n}};case 2:return{gameState:o,effectData:{type:"floatingText",...a,timestamp:n}};case 3:return{gameState:o,effectData:{type:"noTarget",...a}};case 8:return{gameState:o,effectData:{type:"targetingMode",...a}};case 9:return{gameState:o,effectData:{type:"clearTargeting"}};default:return l.warn(`[WebRTCCodec] Unknown ability effect type: ${r}`),{gameState:o,effectData:null}}}catch(r){return l.error("[WebRTCCodec] Failed to handle ability effect:",r),{gameState:e,effectData:null}}}function ui(t,e){var r;try{const{eventType:n,data:a}=Qs(t);l.info(`[WebRTCCodec] Received session event: ${n}`);const o={...e};switch(n){case 1:l.info(`[WebRTCCodec] Player connected: ${a.playerName} (ID: ${a.playerId})`);break;case 2:l.info(`[WebRTCCodec] Player disconnected: ID: ${a.playerId}`),o.players=o.players.map(c=>c.id===a.playerId?{...c,isDisconnected:!0}:c);break;case 3:l.info(`[WebRTCCodec] Game starting, first player: ${a.startingPlayerId}`),o.isGameStarted=!0,a.startingPlayerId!==void 0&&(o.activePlayerId=a.startingPlayerId,o.startingPlayerId=a.startingPlayerId);break;case 4:l.info(`[WebRTCCodec] Round ${a.roundNumber} starting`),o.currentRound=a.roundNumber??1;break;case 5:if(l.info(`[WebRTCCodec] Round ${a.roundNumber} ended, winners: ${(r=a.winners)==null?void 0:r.join(", ")}`),o.isRoundEndModalOpen=!0,a.winners&&a.roundNumber!==void 0){const c=o.roundWinners||{};c[a.roundNumber]=a.winners,o.roundWinners=c}break;case 6:l.info(`[WebRTCCodec] Phase change: ${a.newPhase}`),a.newPhase!==void 0&&(o.currentPhase=a.newPhase),a.newActivePlayerId!==void 0&&(o.activePlayerId=a.newActivePlayerId);break;case 7:l.info(`[WebRTCCodec] Turn change: player ${a.newActivePlayerId}`),a.newActivePlayerId!==void 0&&(o.activePlayerId=a.newActivePlayerId);break;case 8:l.info(`[WebRTCCodec] Game ended, winner: ${a.gameWinner}`),a.gameWinner!==void 0&&(o.gameWinner=a.gameWinner===255?null:a.gameWinner);break;default:l.warn(`[WebRTCCodec] Unknown session event type: ${n}`)}return o}catch(n){return l.error("[WebRTCCodec] Failed to handle session event:",n),e}}function It(t,e,r,n){return t===2?{gameState:ci(e,r,n)}:t===3?li(e,r):t===4?{gameState:ui(e,r)}:(l.warn(`[WebRTCCodec] Unknown codec message type: ${t}`),{gameState:r})}const Wt="avalon_game_state",dt="reconnection_data";function Ca(t,e){var n;t.forEach(a=>a.forEach(o=>{var c;(c=o.card)!=null&&c.statuses&&(o.card.statuses=o.card.statuses.filter(i=>!(i.type==="LastPlayed"&&i.addedByPlayerId===e.id)))})),e.boardHistory||(e.boardHistory=[]);let r=!1;for(;e.boardHistory.length>0&&!r;){const a=e.boardHistory[e.boardHistory.length-1];for(let o=0;o<t.length;o++){for(let c=0;c<t[o].length;c++)if(((n=t[o][c].card)==null?void 0:n.id)===a){const i=t[o][c].card;if(!i||i.ownerId!==e.id)continue;i.statuses||(i.statuses=[]),i.statuses.push({type:"LastPlayed",addedByPlayerId:e.id}),r=!0;break}if(r)break}r||e.boardHistory.pop()}}function Dt(t){var n;if(!t||!xe)return t;const{cardDatabase:e,tokenDatabase:r}=xe;if(t.deck===Ce.Tokens||(n=t.id)!=null&&n.startsWith("TKN_")){if(t.baseId&&r[t.baseId]){const o=r[t.baseId];return{...t,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage}}const a=Object.keys(r).find(o=>r[o].name===t.name);if(a){const o=r[a];return{...t,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage,baseId:a}}}else if(t.baseId&&e[t.baseId]){const a=e[t.baseId];return{...t,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage}}return t}function Lt(t){var n,a;if(!xe)return t;const e=((n=t.board)==null?void 0:n.map(o=>o.map(c=>({...c,card:c.card?Dt(c.card):null}))))||t.board,r=((a=t.players)==null?void 0:a.map(o=>{var c,i,s;return{...o,hand:((c=o.hand)==null?void 0:c.map(Dt))||[],deck:((i=o.deck)==null?void 0:i.map(Dt))||[],discard:((s=o.discard)==null?void 0:s.map(Dt))||[],announcedCard:o.announcedCard?Dt(o.announcedCard):null}}))||t.players;return{...t,board:e,players:r,floatingTexts:t.floatingTexts||[],highlights:t.highlights||[]}}function sa(t,e,r){try{const n=Lt(t),a={gameState:n,localPlayerId:e,playerToken:r,timestamp:Date.now()};localStorage.setItem(Wt,JSON.stringify(a)),n.gameId&&e!==null&&localStorage.setItem(dt,JSON.stringify({gameId:n.gameId,playerId:e,playerToken:r||null,timestamp:Date.now()}))}catch(n){console.warn("Failed to save game state:",n)}}function fi(){try{const t=localStorage.getItem(Wt);if(!t)return null;const e=JSON.parse(t),r=24*60*60*1e3;if(Date.now()-e.timestamp>r)return localStorage.removeItem(Wt),localStorage.removeItem(dt),null;const n=e.gameState;return{gameState:Lt(n),localPlayerId:e.localPlayerId,playerToken:e.playerToken}}catch(t){return console.warn("Failed to load game state:",t),null}}function Tt(){localStorage.removeItem(Wt),localStorage.removeItem(dt)}function Ir(t){const e=[...t];for(let r=e.length-1;r>0;r--){const n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function Da(){return Math.random().toString(36).substring(2,18).toUpperCase()}function tt(t,e,r){const n=fa();let a=t;if(t==="Random"||!n[t]){const i=Object.keys(n);if(i.length===0)return l.error("[createDeck] No decks loaded yet!"),[];a=i[0],t==="Random"||l.warn(`[createDeck] Deck ${t} not found, using ${a} instead`)}const o=n[a];if(!o)return l.error(`Deck data for ${a} not loaded! Returning empty deck. Available decks:`,Object.keys(n)),[];if(a==="Optimates"){const i={};o.forEach(s=>{const d=s.baseId||s.id;i[d]=(i[d]||0)+1})}const c=[...o].map(i=>({...i,ownerId:e,ownerName:r}));return Ir(c)}function Ra(t,e=!1){const r=fa(),n=Object.keys(r);if(n.length===0)return l.error("[createNewPlayer] No decks loaded yet!"),{id:t,name:e?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:_t[t-1]||"blue",isDummy:e,isReady:e,boardHistory:[],autoDrawEnabled:!0};const a=n[0],o={id:t,name:e?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:a,color:_t[t-1]||"blue",isDummy:e,isReady:e,boardHistory:[],autoDrawEnabled:!0};return o.deck=tt(a,t,o.name),o}function it(){return{players:[],spectators:[],board:wa(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:pr.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}const ia=-1,pi=-2,Pt=1,$t=2,lt=(t,e,r,n)=>{var i,s,d,E,P;const{card:a,ownerId:o,location:c}=t;if(e.targetOwnerId!==void 0&&e.targetOwnerId!==ia&&e.targetOwnerId!==pi&&e.targetOwnerId!==o||e.excludeOwnerId!==void 0&&e.excludeOwnerId===o)return!1;if(e.onlyOpponents||e.targetOwnerId===ia){if(o===r)return!1;const S=n.find(A=>A.id===r),y=n.find(A=>A.id===o);if(S&&y&&S.teamId!==void 0&&S.teamId===y.teamId)return!1}if(e.targetType&&!((i=a.types)!=null&&i.includes(e.targetType))||e.onlyFaceDown&&((s=a.statuses)!=null&&s.some(S=>S.type==="Revealed"&&S.addedByPlayerId===r)||c==="board"&&!a.isFaceDown)||e.tokenType==="Revealed"&&(d=a.statuses)!=null&&d.some(S=>S.type==="Revealed"&&S.addedByPlayerId===r)||e.requiredTargetStatus&&(!((E=a.statuses)!=null&&E.some(S=>S.type===e.requiredTargetStatus))||e.requireStatusFromSourceOwner&&r!==null&&!((P=a.statuses)==null?void 0:P.some(y=>y.type===e.requiredTargetStatus&&y.addedByPlayerId===r))))return!1;if(e.mustBeAdjacentToSource&&e.sourceCoords&&t.boardCoords){const{row:S,col:y}=e.sourceCoords,{row:A,col:f}=t.boardCoords;if(Math.abs(S-A)+Math.abs(y-f)!==Pt)return!1}if(e.mustBeInLineWithSource&&e.sourceCoords&&t.boardCoords){const{row:S,col:y}=e.sourceCoords,{row:A,col:f}=t.boardCoords;if(S!==A&&y!==f)return!1}if(e.maxDistanceFromSource!==void 0&&e.sourceCoords&&t.boardCoords){const{row:S,col:y}=e.sourceCoords,{row:A,col:f}=t.boardCoords;if(Math.max(Math.abs(S-A),Math.abs(y-f))>e.maxDistanceFromSource)return!1}if(e.maxOrthogonalDistance!==void 0&&e.sourceCoords&&t.boardCoords){const{row:S,col:y}=e.sourceCoords,{row:A,col:f}=t.boardCoords;if(Math.abs(S-A)+Math.abs(y-f)>e.maxOrthogonalDistance)return!1}return!0},Bt=(t,e,r,n)=>{if(!t||t.type!=="ENTER_MODE"&&t.type!=="CREATE_STACK")return[];const a=[],o=e.board,c=o.length,i=e.activeGridSize,s=Math.floor((c-i)/2),d=s,E=s+i-1;if(t.type==="CREATE_STACK"){const f={targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,requiredTargetStatus:t.requiredTargetStatus,requireStatusFromSourceOwner:t.requireStatusFromSourceOwner,mustBeAdjacentToSource:t.mustBeAdjacentToSource,mustBeInLineWithSource:t.mustBeInLineWithSource,maxDistanceFromSource:t.maxDistanceFromSource,maxOrthogonalDistance:t.maxOrthogonalDistance,sourceCoords:t.sourceCoords,tokenType:t.tokenType};for(let I=d;I<=E;I++)for(let p=d;p<=E;p++){const _=o[I][p];_.card&&_.card.ownerId!==void 0&&lt({card:_.card,ownerId:_.card.ownerId,location:"board",boardCoords:{row:I,col:p}},f,r,e.players)&&a.push({row:I,col:p})}return a}const{mode:P,payload:S,sourceCoords:y,contextCheck:A}=t;if(P==="REVEREND_DOUBLE_EXPLOIT"){for(let f=d;f<=E;f++)for(let I=d;I<=E;I++)o[f][I].card&&a.push({row:f,col:I});return a}if((P==="SELECT_TARGET"||P==="CENSOR_SWAP"||P==="ZEALOUS_WEAKEN"||P==="CENTURION_BUFF"||P==="SELECT_UNIT_FOR_MOVE")&&S.filter&&typeof S.filter=="function"){if(S.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||S.actionType==="LUCIUS_SETUP"||S.actionType==="SELECT_HAND_FOR_DEPLOY"||S.handOnly)return[];for(let f=d;f<=E;f++)for(let I=d;I<=E;I++){const p=o[f][I];let _=p.card&&S.filter(p.card,f,I);if(_&&A==="ADJACENT_TO_LAST_MOVE"&&(n!=null&&n.lastMovedCardCoords)){const{row:D,col:u}=n.lastMovedCardCoords;Math.abs(f-D)+Math.abs(I-u)===1||(_=!1)}_&&a.push({row:f,col:I})}}else if(P==="SELECT_TARGET"&&(S.actionType==="ENHANCED_INT_REVEAL"||S.actionType==="ENHANCED_INT_MOVE"))for(let f=d;f<=E;f++)for(let I=d;I<=E;I++)o[f][I].card&&a.push({row:f,col:I});else if(P==="PATROL_MOVE"&&y)for(let f=d;f<=E;f++)for(let I=d;I<=E;I++){const p=f===y.row||I===y.col,_=f===y.row&&I===y.col,D=!o[f][I].card;p&&(D||_)&&a.push({row:f,col:I})}else if(P==="RIOT_PUSH"&&y){const f=[{r:y.row-1,c:y.col},{r:y.row+1,c:y.col},{r:y.row,c:y.col-1},{r:y.row,c:y.col+1}],I=(p,_)=>p>=d&&p<=E&&_>=d&&_<=E;f.forEach(p=>{if(I(p.r,p.c)){const _=o[p.r][p.c].card;if(_&&_.ownerId!==r){const D=e.players.find(T=>T.id===r),u=e.players.find(T=>T.id===_.ownerId);if(!((D==null?void 0:D.teamId)!==void 0&&(u==null?void 0:u.teamId)!==void 0&&D.teamId===u.teamId)){const T=p.r-y.row,m=p.c-y.col,g=p.r+T,C=p.c+m;I(g,C)&&(o[g][C].card||a.push({row:p.r,col:p.c}))}}}})}else if(P==="SHIELD_SELF_THEN_RIOT_PUSH"&&y){y&&a.push(y);const f=[{r:y.row-1,c:y.col},{r:y.row+1,c:y.col},{r:y.row,c:y.col-1},{r:y.row,c:y.col+1}],I=(p,_)=>p>=d&&p<=E&&_>=d&&_<=E;f.forEach(p=>{if(I(p.r,p.c)){const _=o[p.r][p.c].card;if(_&&_.ownerId!==r){const D=e.players.find(T=>T.id===r),u=e.players.find(T=>T.id===_.ownerId);if(!((D==null?void 0:D.teamId)!==void 0&&(u==null?void 0:u.teamId)!==void 0&&D.teamId===u.teamId)){const T=p.r-y.row,m=p.c-y.col,g=p.r+T,C=p.c+m;I(g,C)&&(o[g][C].card||a.push({row:p.r,col:p.c}))}}}})}else if(P==="RIOT_MOVE"&&S.vacatedCoords)a.push(S.vacatedCoords),y&&a.push(y);else if(P==="SWAP_POSITIONS"&&S.filter)for(let f=d;f<=E;f++)for(let I=d;I<=E;I++){const p=o[f][I];p.card&&S.filter(p.card,f,I)&&a.push({row:f,col:I})}else if((P==="TRANSFER_STATUS_SELECT"||P==="TRANSFER_ALL_STATUSES")&&S.filter)for(let f=d;f<=E;f++)for(let I=d;I<=E;I++){const p=o[f][I];p.card&&S.filter(p.card,f,I)&&a.push({row:f,col:I})}else if(P==="SPAWN_TOKEN"||P==="SELECT_CELL"||P==="IMMUNIS_RETRIEVE")for(let f=d;f<=E;f++)for(let I=d;I<=E;I++){const p=!o[f][I].card;if(P==="IMMUNIS_RETRIEVE"&&S.filter){p&&S.filter(f,I)&&a.push({row:f,col:I});continue}if(P==="SELECT_CELL"){if(S.moveFromHand){p&&a.push({row:f,col:I});continue}if(!y)continue;const _=f===y.row&&I===y.col,D=S.range==="global";let u=!1;if(D)u=!0;else if(S.range==="line")u=f===y.row||I===y.col;else if(S.range===$t){const w=Math.abs(f-y.row),T=Math.abs(I-y.col),m=w+T;if(m===Pt)u=!0;else if(m===$t){const g=[];w===$t&&T===0?g.push({r:(f+y.row)/2,c:I}):w===0&&T===$t?g.push({r:f,c:(I+y.col)/2}):w===Pt&&T===Pt&&(g.push({r:f,c:y.col}),g.push({r:y.row,c:I})),u=g.some(C=>C.r<0||C.r>=c||C.c<0||C.c>=c?!1:!o[C.r][C.c].card)}}else u=Math.abs(f-y.row)+Math.abs(I-y.col)===Pt;(p&&u||S.allowSelf&&_)&&a.push({row:f,col:I})}else if(P==="SPAWN_TOKEN"&&y){const _=Math.abs(f-y.row)+Math.abs(I-y.col)===1;p&&_&&a.push({row:f,col:I})}}else if(P==="REVEAL_ENEMY"&&S.filter)for(let f=d;f<=E;f++)for(let I=d;I<=E;I++){const p=o[f][I];p.card&&S.filter(p.card,f,I)&&a.push({row:f,col:I})}else if(P==="SELECT_LINE_START")for(let f=d;f<=E;f++)for(let I=d;I<=E;I++)a.push({row:f,col:I});else if(P==="SELECT_LINE_END"&&S.firstCoords){const{row:f,col:I}=S.firstCoords;for(let p=d;p<=E;p++)a.push({row:f,col:p});for(let p=d;p<=E;p++)a.push({row:p,col:I})}else if(P==="INTEGRATOR_LINE_SELECT"&&y){const{row:f,col:I}=y;for(let p=d;p<=E;p++)a.push({row:f,col:p});for(let p=d;p<=E;p++)a.push({row:p,col:I})}else if(P==="ZIUS_LINE_SELECT"&&y){const{row:f,col:I}=y;for(let p=d;p<=E;p++)a.push({row:f,col:p});for(let p=d;p<=E;p++)a.push({row:p,col:I})}else if(P==="IP_AGENT_THREAT_SCORING"&&y){const{row:f,col:I}=y;for(let p=d;p<=E;p++)a.push({row:f,col:p});for(let p=d;p<=E;p++)a.push({row:p,col:I})}else if(P==="SELECT_DIAGONAL")if(S.firstCoords){const{row:f,col:I}=S.firstCoords;for(let p=d;p<=E;p++)for(let _=d;_<=E;_++)Math.abs(p-f)===Math.abs(_-I)&&a.push({row:p,col:_})}else for(let f=d;f<=E;f++)for(let I=d;I<=E;I++)a.push({row:f,col:I});return a},wt=(t,e,r,n)=>{var o,c,i,s,d;if(t.type==="OPEN_MODAL"||t.mode==="SELECT_DECK")return!0;if(t.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let E=0;E<e.board.length;E++)for(let P=0;P<e.board[E].length;P++)if(e.board[E][P].card)return!0;return!1}if(t.mode==="PRINCEPS_SHIELD_THEN_AIM"||t.mode==="SHIELD_SELF_THEN_SPAWN"||t.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||t.mode==="ABR_DEPLOY_SHIELD_AIM"||t.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(t.mode==="SELECT_TARGET"&&((o=t.payload)!=null&&o.actionType)){const E=t.payload.actionType;if(E==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||E==="LUCIUS_SETUP"||E==="SELECT_HAND_FOR_DEPLOY"){const P=((c=t.sourceCard)==null?void 0:c.ownerId)||r;if(P!==null){const S=e.players.find(y=>y.id===P);if(S&&S.hand.length>0)return!0}return!1}}if(t.type==="CREATE_STACK"){if(Bt(t,e,r,n).length>0)return!0;const P=["Aim","Exploit","Stun","Shield"];if(!(t.tokenType&&P.includes(t.tokenType))&&(t.tokenType==="Revealed"||(i=t.tokenType)!=null&&i.startsWith("Power")))for(const y of e.players)for(let A=0;A<y.hand.length;A++){const f={targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,tokenType:t.tokenType};if(lt({card:y.hand[A],ownerId:y.id,location:"hand"},f,r,e.players))return!0}return!1}if(t.mode==="SELECT_TARGET"&&((s=t.payload)!=null&&s.filter)){if(t.payload.handOnly||t.payload.allowHandTargets||t.payload.actionType==="DESTROY"){for(const E of e.players)if(E.hand.some(P=>t.payload.filter(P))&&t.payload.handOnly)return!0}if(t.payload.handOnly)return!1}return Bt(t,e,r,n).length>0?!0:((t.mode==="CENSOR_SWAP"||t.mode==="ZEALOUS_WEAKEN"||t.mode==="CENTURION_BUFF"||t.mode==="SELECT_UNIT_FOR_MOVE")&&((d=t.payload)!=null&&d.filter),!1)};function yi(t){const{ws:e,webrtcManager:r,gameStateRef:n,localPlayerIdRef:a,webrtcIsHostRef:o,setLatestHighlight:c,setLatestFloatingTexts:i,setLatestNoTarget:s,setLatestDeckSelections:d,setLatestHandCardSelections:E,setClickWaves:P,setGameState:S}=t,y=H.useRef({}),A=500,f=H.useCallback(g=>{var k;const C={...g,timestamp:Date.now()};if(c(C),((k=e.current)==null?void 0:k.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:n.current.gameId,highlightData:C}));else if(r.current){const R={type:"HIGHLIGHT_TRIGGERED",senderId:r.current.getPeerId(),data:C,timestamp:Date.now()};o.current?r.current.broadcastToGuests(R):r.current.sendMessageToHost(R)}},[e,r,n,o,c]),I=H.useCallback(g=>{var O;const C=Array.isArray(g)?g:[g],k=Date.now(),R=C.map((U,$)=>({...U,timestamp:k+$}));if(i(R),((O=e.current)==null?void 0:O.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:n.current.gameId,batch:R}));else if(r.current){const U={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:r.current.getPeerId(),data:{batch:R},timestamp:Date.now()};o.current?r.current.broadcastToGuests(U):r.current.sendMessageToHost(U)}},[e,r,n,o,i]),p=H.useCallback(g=>{var k;const C=Date.now();if(s({coords:g,timestamp:C}),((k=e.current)==null?void 0:k.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:n.current.gameId,coords:g,timestamp:C}));else if(r.current){const R={type:"NO_TARGET_TRIGGERED",senderId:r.current.getPeerId(),data:{coords:g,timestamp:C},timestamp:Date.now()};o.current?r.current.broadcastToGuests(R):r.current.sendMessageToHost(R)}},[e,r,n,o,s]),_=H.useCallback((g,C)=>{var R;const k={playerId:g,selectedByPlayerId:C,timestamp:Date.now()};if(d(O=>[...O,k]),((R=e.current)==null?void 0:R.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:n.current.gameId,deckSelectionData:k}));else if(r.current){const O={type:"DECK_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:k,timestamp:Date.now()};o.current?r.current.broadcastToGuests(O):r.current.sendMessageToHost(O)}setTimeout(()=>{d(O=>O.filter(U=>U.timestamp!==k.timestamp))},1e3)},[e,r,n,o,d]),D=H.useCallback((g,C,k)=>{var O;const R={playerId:g,cardIndex:C,selectedByPlayerId:k,timestamp:Date.now()};if(E(U=>[...U,R]),((O=e.current)==null?void 0:O.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:n.current.gameId,handCardSelectionData:R}));else if(r.current){const U={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:R,timestamp:Date.now()};o.current?r.current.broadcastToGuests(U):r.current.sendMessageToHost(U)}setTimeout(()=>{E(U=>U.filter($=>$.timestamp!==R.timestamp))},1e3)},[e,r,n,o,E]),u=H.useCallback(g=>{},[]),w=H.useCallback((g,C,k)=>{var G;if(a.current===null)return;const R=a.current,O=Date.now(),U=y.current[R]||0;if(O-U<A)return;y.current[R]=O;const $=n.current.players.find(x=>x.id===R);if(!$)return;const M={timestamp:Date.now(),location:g,boardCoords:C,handTarget:k,clickedByPlayerId:R,playerColor:$.color};if(P(x=>[...x,M]),((G=e.current)==null?void 0:G.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_CLICK_WAVE",gameId:n.current.gameId,wave:M}));else if(r.current){const x={type:"CLICK_WAVE_TRIGGERED",senderId:r.current.getPeerId(),data:M,timestamp:Date.now()};o.current?r.current.broadcastToGuests(x):r.current.sendMessageToHost(x)}setTimeout(()=>{P(x=>x.filter(q=>q.timestamp!==M.timestamp))},600)},[e,r,n,o,P]),T=H.useCallback((g,C,k,R,O,U)=>{var x;const $=n.current;if(!$||!$.board){console.warn("[setTargetingMode] No game state or board available");return}let M;R?M=R:k&&(M=Bt(g,$,C,O));const G={playerId:C,action:g,sourceCoords:k,timestamp:Date.now(),boardTargets:M,handTargets:U};if(S(q=>({...q,targetingMode:G})),((x=e.current)==null?void 0:x.readyState)===WebSocket.OPEN&&$.gameId)e.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:$.gameId,targetingMode:G}));else if(r.current){const q={type:"SET_TARGETING_MODE",senderId:r.current.getPeerId(),data:G,timestamp:Date.now()};o.current?r.current.broadcastToGuests(q):r.current.sendMessageToHost(q)}},[e,r,n,o,S]),m=H.useCallback(()=>{var C;const g=n.current;if(S(k=>({...k,targetingMode:null})),((C=e.current)==null?void 0:C.readyState)===WebSocket.OPEN&&(g!=null&&g.gameId))e.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:g.gameId}));else if(r.current){const k={type:"CLEAR_TARGETING_MODE",senderId:r.current.getPeerId(),data:{},timestamp:Date.now()};o.current?r.current.broadcastToGuests(k):r.current.sendMessageToHost(k)}},[e,r,n,o,S]);return{triggerHighlight:f,triggerFloatingText:I,triggerNoTarget:p,triggerDeckSelection:_,triggerHandCardSelection:D,syncValidTargets:u,triggerClickWave:w,setTargetingMode:T,clearTargetingMode:m}}function hi(t){const{ws:e,webrtcManager:r,gameStateRef:n,webrtcIsHostRef:a,setGameState:o,updateState:c}=t,i=H.useCallback(S=>{var A;if(Fe()&&r.current&&a.current){o(f=>{const I=f.players.map(p=>{let _=1;for(const[D,u]of Object.entries(S))if(u.includes(p.id)){_=parseInt(D);break}return{...p,teamId:_}});return{...f,players:I}}),r.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:r.current.getPeerId(),data:{assignments:S},timestamp:Date.now()});return}((A=e.current)==null?void 0:A.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:n.current.gameId,assignments:S}))},[e,r,n,a,o]),s=H.useCallback(S=>{var A;if(Fe()&&r.current&&a.current){o(f=>({...f,gameMode:S})),r.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:r.current.getPeerId(),data:{mode:S},timestamp:Date.now()});return}((A=e.current)==null?void 0:A.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:n.current.gameId,mode:S}))},[e,r,n,a,o]),d=H.useCallback(S=>{var A;if(Fe()&&r.current&&a.current){o(f=>({...f,isPrivate:S})),r.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:r.current.getPeerId(),data:{isPrivate:S},timestamp:Date.now()});return}((A=e.current)==null?void 0:A.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:n.current.gameId,isPrivate:S}))},[e,r,n,a,o]),E=H.useCallback(S=>{c(y=>{if(y.isGameStarted)return y;const A={...y,activeGridSize:S};if(y.board.length!==S){A.board=[];for(let I=0;I<S;I++){const p=[];for(let _=0;_<S;_++)p.push({card:null});A.board.push(p)}}return A})},[c]),P=H.useCallback(S=>{c(y=>{if(y.isGameStarted)return y;const A=y.players.filter(p=>!p.isDummy);if(A.length+S>ds)return y;const f=[...A],I=Math.max(...A.map(p=>p.id),0);for(let p=0;p<S;p++){const _=I+p+1,D=Ra(_,!0);D.name=`Dummy ${p+1}`,f.push(D)}return{...y,players:f,dummyPlayerCount:S}})},[c]);return{assignTeams:i,setGameMode:s,setGamePrivacy:d,setActiveGridSize:E,setDummyPlayerCount:P}}function mi(t){const{ws:e,webrtcManager:r,gameStateRef:n,localPlayerIdRef:a,webrtcIsHostRef:o,setGameState:c}=t,i=H.useCallback(()=>{var P;if(Fe()&&r.current&&o.current){c(S=>({...S,isReadyCheckActive:!0,isPrivate:!0})),r.current.broadcastToGuests({type:"START_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:n.current.gameId}))},[e,r,n,o,c]),s=H.useCallback(()=>{var P;if(Fe()&&r.current&&o.current){c(S=>({...S,isReadyCheckActive:!1})),r.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId?e.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:n.current.gameId})):c(S=>({...S,isReadyCheckActive:!1}))},[e,r,n,o,c]),d=H.useCallback(()=>{var P;const E=Fe();if(E&&r.current&&o.current&&a.current!==null){c(S=>{const y=S.players.map(p=>p.id===a.current?{...p,isReady:!0}:p),A={...S,players:y},f=A.players.filter(p=>!p.isDummy&&!p.isDisconnected);if(f.length>0&&f.every(p=>p.isReady)&&!A.isGameStarted){const p=A.players.filter(T=>!T.isDisconnected),_=Math.floor(Math.random()*p.length),D=p[_].id,u={...A};u.isReadyCheckActive=!1,u.isGameStarted=!0,u.startingPlayerId=D,u.activePlayerId=D,u.currentPhase=0,u.players=u.players.map(T=>{if(T.hand.length===0&&T.deck.length>0){const g=[...T.hand],C=[...T.deck];for(let k=0;k<6&&k<C.length;k++){const R=C[0];C.splice(0,1),g.push(R)}return l.info(`[playerReady] Drew initial ${g.length} cards for player ${T.id}`),{...T,hand:g,deck:C}}return T});const w=u.players.find(T=>T.id===D);if(w&&w.deck.length>0){const T=w.deck[0],m=[...w.deck.slice(1)],g=[...w.hand,T];u.players=u.players.map(C=>C.id===D?{...C,deck:m,hand:g,readySetup:!1,readyCommit:!1}:C),u.currentPhase=1}return r.current.broadcastGameState(u),r.current.broadcastToGuests({type:"GAME_START",senderId:r.current.getPeerId(),data:{startingPlayerId:D,activePlayerId:D,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),u}return r.current.broadcastToGuests({type:"HOST_READY",senderId:r.current.getPeerId(),playerId:a.current??void 0,timestamp:Date.now()}),A});return}if(E&&r.current&&!o.current&&a.current!==null){r.current.sendMessageToHost({type:"PLAYER_READY",senderId:r.current.getPeerId(),playerId:a.current,timestamp:Date.now()}),c(S=>({...S,players:S.players.map(y=>y.id===a.current?{...y,isReady:!0}:y)}));return}((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId&&a.current!==null&&e.current.send(JSON.stringify({type:"PLAYER_READY",gameId:n.current.gameId,playerId:a.current}))},[e,r,n,a,o,c]);return{startReadyCheck:i,cancelReadyCheck:s,playerReady:d}}function Ei(t){const{updateState:e,sendWebrtcAction:r,webrtcIsHostRef:n,webrtcManagerRef:a}=t,o=H.useCallback((i,s)=>{e(d=>d.isGameStarted?d:{...d,players:d.players.map(E=>E.id===i?{...E,name:s}:E)})},[e]),c=H.useCallback((i,s)=>{e(E=>({...E,players:E.players.map(P=>P.id===i?{...P,color:s}:P)})),r!==null&&(n!=null&&n.current&&(a!=null&&a.current)?a.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:a.current.getPeerId(),data:{playerId:i,color:s},timestamp:Date.now()}):!(n!=null&&n.current)&&r&&r("CHANGE_PLAYER_COLOR",{playerId:i,color:s}))},[e,r,n,a]);return{updatePlayerName:o,changePlayerColor:c}}function Ii(t){const{updateState:e}=t,r=H.useCallback(i=>{e(s=>{if(!s.isGameStarted)return s;const d=s.players.find(y=>y.id===i);if(!d||d.deck.length===0)return s;const E=fe(s),P=E.players.find(y=>y.id===i),S=P.deck.shift();return S&&P.hand.push(S),E})},[e]),n=H.useCallback((i,s)=>{s<=0||e(d=>{if(!d.isGameStarted)return d;const E=d.players.find(A=>A.id===i);if(!E||E.deck.length===0)return d;const P=fe(d),S=P.players.find(A=>A.id===i),y=Math.min(s,S.deck.length);for(let A=0;A<y;A++){const f=S.deck.shift();f&&S.hand.push(f)}return P})},[e]),a=H.useCallback(i=>{e(s=>{if(!s.isGameStarted||!s.players.find(f=>f.id===i))return s;const E=fe(s),P=E.players.find(f=>f.id===i);P.deck=Ir([...P.deck]);const S=t.webrtcManager.current,y=t.webrtcIsHostRef.current,A=t.localPlayerIdRef.current;return S&&s.gameId&&!y&&i===A&&setTimeout(()=>{S.sendFullDeckToHost(i,P.deck,P.deck.length)},0),E})},[e,t]),o=H.useCallback(i=>{e(s=>{if(!s.isGameStarted)return s;const d={...s},E=d.board[i.row][i.col].card;return E&&(E.isFaceDown=!1),{...d,board:Le(d)}})},[e]),c=H.useCallback(i=>{e(s=>{if(!s.isGameStarted)return s;const d={...s},E=d.board[i.row][i.col].card;return E&&(E.isFaceDown=!0),{...d,board:Le(d)}})},[e]);return{drawCard:r,drawCardsBatch:n,shufflePlayerDeck:a,flipBoardCard:o,flipBoardCardFaceDown:c}}function Ti(t){const{localPlayerIdRef:e,updateState:r}=t,n=H.useCallback((p,_,D)=>{r(u=>{var m,g;if(!u.isGameStarted)return u;const w=fe(u),T=w.board[p.row][p.col].card;if(T){if(_==="Stun"&&(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius")&&((m=T.types)!=null&&m.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(_)&&((g=T.statuses)==null?void 0:g.some(k=>k.type===_&&k.addedByPlayerId===D)))return u;T.statuses||(T.statuses=[]),T.statuses.push({type:_,addedByPlayerId:D}),(_==="Stun"||_==="Support")&&er(T,w)}return w})},[r]),a=H.useCallback((p,_)=>{r(D=>{if(!D.isGameStarted)return D;const u=fe(D),w=u.board[p.row][p.col].card;if(w!=null&&w.statuses){const T=w.statuses.map(m=>m.type).lastIndexOf(_);T>-1&&(w.statuses.splice(T,1),(_==="Stun"||_==="Support")&&er(w,u))}return u.board=Le(u),u})},[r]),o=H.useCallback((p,_,D)=>{r(u=>{if(!u.isGameStarted)return u;const w=fe(u),T=w.board[p.row][p.col].card;if(T!=null&&T.statuses){const m=T.statuses.findIndex(g=>g.type===_&&g.addedByPlayerId===D);m>-1&&(T.statuses.splice(m,1),(_==="Stun"||_==="Support")&&er(T,w))}return w.board=Le(w),w})},[r]),c=H.useCallback((p,_)=>{r(D=>{if(!D.isGameStarted)return D;const u=fe(D),w=u.board[p.row][p.col].card;return w&&(w.powerModifier===void 0&&(w.powerModifier=0),w.powerModifier+=_),u})},[r]),i=H.useCallback((p,_,D)=>{r(u=>{var m;if(!u.isGameStarted)return u;const w=fe(u),T=w.players.find(g=>g.id===p);if(T!=null&&T.announcedCard){if(["Support","Threat","Revealed"].includes(_)&&((m=T.announcedCard.statuses)==null?void 0:m.some(C=>C.type===_&&C.addedByPlayerId===D)))return u;T.announcedCard.statuses||(T.announcedCard.statuses=[]),T.announcedCard.statuses.push({type:_,addedByPlayerId:D})}return w})},[r]),s=H.useCallback((p,_)=>{r(D=>{var T;if(!D.isGameStarted)return D;const u=fe(D),w=u.players.find(m=>m.id===p);if((T=w==null?void 0:w.announcedCard)!=null&&T.statuses){const m=w.announcedCard.statuses.map(g=>g.type).lastIndexOf(_);m>-1&&w.announcedCard.statuses.splice(m,1)}return u})},[r]),d=H.useCallback((p,_)=>{r(D=>{if(!D.isGameStarted)return D;const u=fe(D),w=u.players.find(T=>T.id===p);return w!=null&&w.announcedCard&&(w.announcedCard.powerModifier===void 0&&(w.announcedCard.powerModifier=0),w.announcedCard.powerModifier+=_),u})},[r]),E=H.useCallback((p,_,D,u)=>{r(w=>{var g;if(!w.isGameStarted)return w;const T=fe(w),m=T.players.find(C=>C.id===p);if(m!=null&&m.hand[_]){const C=m.hand[_];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(D)&&((g=C.statuses)==null?void 0:g.some(R=>R.type===D&&R.addedByPlayerId===u)))return w;C.statuses||(C.statuses=[]),C.statuses.push({type:D,addedByPlayerId:u})}return T})},[r]),P=H.useCallback((p,_,D)=>{r(u=>{if(!u.isGameStarted)return u;const w=fe(u),T=w.players.find(g=>g.id===p),m=T==null?void 0:T.hand[_];if(m!=null&&m.statuses){const g=m.statuses.map(C=>C.type).lastIndexOf(D);g>-1&&m.statuses.splice(g,1),D==="Revealed"&&(m.statuses.some(k=>k.type==="Revealed")||delete m.revealedTo)}return w})},[r]),S=H.useCallback((p,_,D)=>{r(u=>{const w=u.players.find(g=>g.id===p);if(!(w!=null&&w.hand[_]))return u;const T=fe(u),m=T.players.find(g=>g.id===p).hand[_];if(D==="all")m.revealedTo="all",m.statuses||(m.statuses=[]),m.statuses.some(g=>g.type==="Revealed"&&g.addedByPlayerId===p)||m.statuses.push({type:"Revealed",addedByPlayerId:p});else{(!m.revealedTo||m.revealedTo==="all"||!Array.isArray(m.revealedTo))&&(m.revealedTo=[]);const g=D.filter(C=>!m.revealedTo.includes(C));m.revealedTo.push(...g)}return T})},[r]),y=H.useCallback((p,_)=>{r(D=>{if(!D.board[p.row][p.col].card)return D;const w=fe(D),T=w.board[p.row][p.col].card,m=T.ownerId;if(_==="all")T.revealedTo="all",m!==void 0&&(T.statuses||(T.statuses=[]),T.statuses.some(g=>g.type==="Revealed"&&g.addedByPlayerId===m)||T.statuses.push({type:"Revealed",addedByPlayerId:m}));else{(!T.revealedTo||T.revealedTo==="all"||!Array.isArray(T.revealedTo))&&(T.revealedTo=[]);const g=_.filter(C=>!T.revealedTo.includes(C));T.revealedTo.push(...g)}return w})},[r]),A=H.useCallback((p,_)=>{r(D=>{var m;const u=p.boardCoords?(m=D.board[p.boardCoords.row][p.boardCoords.col].card)==null?void 0:m.ownerId:p.ownerId;if(!u)return D;const w=fe(D),T=w.revealRequests.find(g=>g.fromPlayerId===_&&g.toPlayerId===u);return T?T.cardIdentifiers.some(C=>JSON.stringify(C)===JSON.stringify(p))||T.cardIdentifiers.push(p):w.revealRequests.push({fromPlayerId:_,toPlayerId:u,cardIdentifiers:[p]}),w})},[r]),f=H.useCallback((p,_)=>{r(D=>{const u=D.revealRequests.findIndex(m=>m.toPlayerId===e.current&&m.fromPlayerId===p);if(u===-1)return D;const w=fe(D),T=w.revealRequests[u];if(_){const{cardIdentifiers:m}=T;for(const g of m){let C=null;if(g.source==="board"&&g.boardCoords)C=w.board[g.boardCoords.row][g.boardCoords.col].card;else if(g.source==="hand"&&g.ownerId&&g.cardIndex!==void 0){const k=w.players.find(R=>R.id===g.ownerId);k&&(C=k.hand[g.cardIndex])}C&&(C.statuses||(C.statuses=[]),C.statuses.some(k=>k.type==="Revealed"&&k.addedByPlayerId===p)||C.statuses.push({type:"Revealed",addedByPlayerId:p}))}}return w.revealRequests.splice(u,1),w})},[r,e]),I=H.useCallback(p=>{r(_=>{const D=fe(_);let u=null;if(p.source==="board"&&p.boardCoords)u=D.board[p.boardCoords.row][p.boardCoords.col].card;else if(p.source==="hand"&&p.playerId&&p.cardIndex!==void 0){const w=D.players.find(T=>T.id===p.playerId);w&&(u=w.hand[p.cardIndex])}return u&&(u.statuses&&(u.statuses=u.statuses.filter(w=>w.type!=="Revealed")),delete u.revealedTo),D})},[r]);return{addBoardCardStatus:n,removeBoardCardStatus:a,removeBoardCardStatusByOwner:o,modifyBoardCardPower:c,addAnnouncedCardStatus:i,removeAnnouncedCardStatus:s,modifyAnnouncedCardPower:d,addHandCardStatus:E,removeHandCardStatus:P,revealHandCard:S,revealBoardCard:y,requestCardReveal:A,respondToRevealRequest:f,removeRevealedStatus:I}}function gi(t){const{webrtcIsHostRef:e,sendWebrtcAction:r,webrtcManagerRef:n,localPlayerIdRef:a,getCardDefinition:o,commandCardIds:c,createDeck:i,updateState:s}=t,d=H.useCallback((f,I)=>{const p=Fe();let _=!1;if(s(u=>{const w=u.players.find(k=>k.id===f);if(!w)return u;_=w.isDummy||!1;const T=_,m=e.current,g=!T||m;if(p&&!m)try{localStorage.setItem("webrtc_preferred_deck",I),l.info(`[changePlayerDeck] Guest saved deck preference: ${I}`)}catch(k){l.warn("[changePlayerDeck] Failed to save deck preference:",k)}const C=g?i(I,f,w.name):[];return p?m?{...u,players:u.players.map(k=>k.id===f?{...k,deck:C,selectedDeck:I,hand:[],discard:[],announcedCard:null,boardHistory:[]}:k)}:{...u,players:u.players.map(k=>k.id===f?{...k,selectedDeck:I}:k)}:{...u,players:u.players.map(k=>k.id===f?{...k,deck:C,selectedDeck:I,hand:[],discard:[],announcedCard:null,boardHistory:[]}:k)}}),l.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${p}, isHost=${e.current}, hasSendAction=${!!r}, hasManager=${!!(n!=null&&n.current)}`),!p)return;if(e.current){const w=i(I,f,"Player "+f).map(T=>({id:T.id,baseId:T.baseId,power:T.power,powerModifier:T.powerModifier||0,isFaceDown:T.isFaceDown||!1,statuses:T.statuses||[]}));if(I==="Optimates"){const T={};w.forEach(m=>{const g=m.baseId||m.id;T[g]=(T[g]||0)+1}),l.info("[changePlayerDeck] Host sending Optimates deck data:",{totalCards:w.length,baseIdCounts:T})}n!=null&&n.current?(n.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:n.current.getPeerId(),timestamp:Date.now(),data:{playerId:f,deckType:I,deck:w,deckSize:w.length}}),l.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${f}, deck ${I}, ${w.length} cards, isDummy=${_}`)):l.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available")}else r?r("CHANGE_PLAYER_DECK",{playerId:f,deckType:I,deck:void 0,deckSize:0}):l.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[s,i,r,e,n,a]),E=H.useCallback((f,I)=>{const p=Fe();let _=[];const D=new Map;for(const{cardId:w,quantity:T}of I.cards){const m=o(w);if(!m)continue;const g=c.has(w),C=g?Ce.Command:Ce.Custom,k=g?"CMD":"CUS";for(let R=0;R<T;R++){const O=(D.get(w)||0)+1;D.set(w,O),_.push({...m,id:`${k}_${w.toUpperCase()}_${O}`,baseId:w,deck:C,ownerId:f,ownerName:"Player "+f})}}if(_=Ir(_),s(w=>w.isGameStarted||!w.players.find(m=>m.id===f)?w:{...w,players:w.players.map(m=>m.id===f?{...m,deck:_,selectedDeck:Ce.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:m)}),!p)return;const u=_.map(w=>({id:w.id,baseId:w.baseId,power:w.power,powerModifier:w.powerModifier||0,isFaceDown:w.isFaceDown||!1,statuses:w.statuses||[]}));e.current?n!=null&&n.current&&(n.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:n.current.getPeerId(),timestamp:Date.now(),data:{playerId:f,deckType:Ce.Custom,deck:u,deckSize:u.length}}),l.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${f}, ${u.length} cards`)):r&&(r("CHANGE_PLAYER_DECK",{playerId:f,deckType:Ce.Custom,deck:u,deckSize:u.length}),l.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${f}, ${u.length} cards`))},[s,o,c,r,e,n,a]),P=H.useCallback((f,I,p,_)=>{s(D=>{if(!D.isGameStarted||D.board[p.row][p.col].card!==null)return D;const u=fe(D),w=u.players.find(T=>T.id===f);if(w&&w.discard.length>I){const[T]=w.discard.splice(I,1);T.enteredThisTurn=!0,yr(T,f,u.currentPhase),(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius"))&&(T.powerModifier===void 0&&(T.powerModifier=0),T.powerModifier+=2),T.statuses||(T.statuses=[]),T.statuses.push({type:"Resurrected",addedByPlayerId:f}),_&&_.forEach(m=>{var g;m.type!=="Resurrected"&&((g=T.statuses)==null||g.push({type:m.type,addedByPlayerId:f}))}),w.boardHistory||(w.boardHistory=[]),w.boardHistory.push(T.id),u.board[p.row][p.col].card=T,Ca(u.board,w),u.board=Le(u)}return u})},[s]),S=H.useCallback((f,I)=>{s(p=>{const _=fe(p),D=_.players.find(u=>u.id===f);if(D&&I.length>0){const u=new Set(I.map(T=>T.id)),w=D.deck.filter(T=>!u.has(T.id));D.deck=[...I,...w]}return _})},[s]),y=H.useCallback((f,I,p)=>{s(_=>{const D=fe(_),u=D.players.find(w=>w.id===f);return u&&(p==="deck"?u.deck=I:p==="discard"&&(u.discard=I)),D})},[s]),A=H.useCallback((f,I)=>{s(p=>{if(!p.isGameStarted)return p;const _=fe(p),D=_.players.find(u=>u.id===f);if(D&&D.discard.length>I){const[u]=D.discard.splice(I,1);D.hand.push(u)}return _})},[s]);return{changePlayerDeck:d,loadCustomDeck:E,resurrectDiscardedCard:P,reorderTopDeck:S,reorderCards:y,recoverDiscardedCard:A}}function wi(t){const{ws:e,webrtcManagerRef:r,webrtcIsHostRef:n,gameStateRef:a,scoreDeltaAccumulator:o,setGameState:c,updateState:i,abilityMode:s,setAbilityMode:d,createDeck:E,webrtcEnabled:P}=t,S=H.useCallback(u=>{P&&r.current?n.current?c(T=>{const m=Aa(T,u);return r.current&&r.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:r.current.getPeerId(),data:{activePlayerId:m.activePlayerId,currentPhase:m.currentPhase,turnNumber:m.turnNumber},timestamp:Date.now()}),m}):r.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:u},timestamp:Date.now()}):e.current&&e.current.readyState===WebSocket.OPEN&&(o.forEach((T,m)=>{clearTimeout(T.timerId),l.info(`[ScoreFlush] Flushing on toggle: player=${m}, delta=${T.delta}`),e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:a.current.gameId,playerId:m,delta:T.delta}))}),o.clear(),e.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:a.current.gameId,playerId:u})))},[e,r,n,a,o,c]),y=H.useCallback((u,w)=>{e.current&&e.current.readyState===WebSocket.OPEN&&e.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:a.current.gameId,playerId:u,enabled:w}))},[]),A=H.useCallback(u=>{const w=s&&d&&s.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(s.mode);if(w&&d(null),P&&r.current){i(m=>{if(!m.isGameStarted)return m;const g=m.currentPhase,C=Math.max(1,Math.min(u,4));if(g===C)return m;const k=fe(m);return k.currentPhase=C,k.board.forEach(U=>{U.forEach($=>{const M=$.card;if(M&&M.statuses){const G=M.statuses.filter(x=>x.type!=="readyDeploy");G.length!==M.statuses.length&&(M.statuses=G)}})}),C===4?k.isScoringStep=!0:g===4&&(k.isScoringStep=!1),(C===1||C===3)&&st({gameState:k},Ze),n.current||r.current.sendMessageToHost({type:"SET_PHASE",senderId:void 0,data:{phaseIndex:C,activePlayerId:k.activePlayerId},timestamp:Date.now()}),k});return}i(m=>{if(!m.isGameStarted)return m;const g=m.currentPhase,C=Math.max(1,Math.min(u,4));if(g===C)return m;const k=fe(m);k.board.forEach($=>{$.forEach(M=>{const G=M.card;if(G&&G.statuses){const x=G.statuses.filter(q=>q.type!=="readyDeploy");x.length!==G.statuses.length&&(G.statuses=x)}})});const U={...k,currentPhase:C,...C===4&&!w?{isScoringStep:!0}:{},...g===4||w?{isScoringStep:!1}:{}};return(C===1||C===3)&&st({gameState:U},Ze),U})},[i,s,d,r,n,a,c]),f=H.useCallback(()=>{var T;s&&d&&s.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(s.mode)&&d(null);const u=a.current,w=P;if(u.isGameStarted&&u.currentPhase===4&&u.isScoringStep&&!w){((T=e.current)==null?void 0:T.readyState)===WebSocket.OPEN&&(o.forEach((m,g)=>{clearTimeout(m.timerId),l.info(`[ScoreFlush] Flushing pending score: player=${g}, delta=${m.delta}`),e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:u.gameId,playerId:g,delta:m.delta}))}),o.clear(),e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:u.gameId})));return}if(w&&n.current&&u.isGameStarted&&u.currentPhase===4&&u.isScoringStep){i(m=>gt(m));return}w&&!n.current&&u.currentPhase===4&&u.isScoringStep||i(m=>{if(!m.isGameStarted)return m;const g=fe(m),C=m.currentPhase+1;return g.board.forEach(k=>{k.forEach(R=>{const O=R.card;if(O&&O.statuses){const U=O.statuses.filter($=>$.type!=="readyDeploy");U.length!==O.statuses.length&&(O.statuses=U)}})}),w&&C===4&&m.currentPhase===3&&n.current?ii(m,m.activePlayerId)?(g.isScoringStep=!0,g.currentPhase=4,g):(l.info(`[nextPhase] Player ${m.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),gt(m)):C===4&&m.currentPhase===3?(g.isScoringStep=!0,g.currentPhase=4,g):(g.board.forEach(k=>{k.forEach(R=>{var O;if((O=R.card)!=null&&O.statuses){const U=R.card.statuses.findIndex($=>$.type==="Resurrected");if(U!==-1){const $=R.card.statuses[U].addedByPlayerId;R.card.statuses.splice(U,1),R.card.baseId!=="luciusTheImmortal"&&(R.card.statuses.push({type:"Stun",addedByPlayerId:$}),R.card.statuses.push({type:"Stun",addedByPlayerId:$}))}}})}),g.board=Le(g),g.currentPhase=C,(C===1||C===3)&&st({gameState:g},Ze),g)})},[i,s,d,a,e,o]),I=H.useCallback(()=>{i(u=>{if(!u.isGameStarted)return u;s&&d&&s.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(s.mode)&&d(null);const w=(u.isScoringStep,u.currentPhase),T=Math.max(1,u.currentPhase-1);if(w!==T){const m=fe(u);if(m.board.forEach(C=>{C.forEach(k=>{const R=k.card;if(R&&R.statuses){const O=R.statuses.filter(U=>U.type!=="readyDeploy");O.length!==R.statuses.length&&(R.statuses=O)}})}),u.isScoringStep){const C={...m,isScoringStep:!1,currentPhase:T};return(T===1||T===3)&&st({gameState:C},Ze),C}const g={...m,currentPhase:T};return(T===1||T===3)&&st({gameState:g},Ze),g}return u.isScoringStep?{...u,isScoringStep:!1,currentPhase:T}:{...u,currentPhase:T}})},[i,s,d]),p=H.useCallback(()=>{var w;P?i(T=>({...T,isRoundEndModalOpen:!1,currentRound:(T.currentRound||1)+1,players:T.players.map(m=>({...m,score:0}))})):((w=e.current)==null?void 0:w.readyState)===WebSocket.OPEN&&a.current.gameId&&(c(T=>({...T,isRoundEndModalOpen:!1,currentRound:(T.currentRound||1)+1,players:T.players.map(m=>({...m,score:0}))})),e.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:a.current.gameId})))},[c,i,e,a]),_=H.useCallback(()=>{c(u=>({...u,isRoundEndModalOpen:!1}))},[c]),D=H.useCallback(()=>{var w;if(P){const T=a.current,m=T.players.map(R=>{const O=R.selectedDeck||"SynchroTech";return{...R,hand:[],deck:E(O,R.id,R.name),discard:[],score:0,isReady:R.isDummy||!1,announcedCard:null,boardHistory:[]}}),g=T.activeGridSize||8,C=[];for(let R=0;R<g;R++){const O=[];for(let U=0;U<g;U++)O.push({card:null});C.push(O)}const k={...T,players:m,board:C,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};c(k),a.current=k,r.current&&r.current.broadcastToGuests({type:"GAME_RESET",senderId:r.current.getPeerId(),data:{players:m.map(R=>({id:R.id,name:R.name,color:R.color,selectedDeck:R.selectedDeck,isDummy:R.isDummy,isDisconnected:R.isDisconnected,autoDrawEnabled:R.autoDrawEnabled,handSize:R.hand.length,deckSize:R.deck.length,discardSize:R.discard.length,...R.isDummy&&{hand:R.hand.map(O=>({id:O.id,baseId:O.baseId,name:O.name,imageUrl:O.imageUrl,power:O.power,powerModifier:O.powerModifier,ability:O.ability,ownerId:O.ownerId,color:O.color,deck:O.deck,isFaceDown:O.isFaceDown,types:O.types,faction:O.faction,statuses:O.statuses})),deck:R.deck.map(O=>({id:O.id,baseId:O.baseId,name:O.name,imageUrl:O.imageUrl,power:O.power,powerModifier:O.powerModifier,ability:O.ability,ownerId:O.ownerId,color:O.color,deck:O.deck,isFaceDown:O.isFaceDown,types:O.types,faction:O.faction,statuses:O.statuses})),discard:R.discard.map(O=>({id:O.id,baseId:O.baseId,name:O.name,imageUrl:O.imageUrl,power:O.power,powerModifier:O.powerModifier,ability:O.ability,ownerId:O.ownerId,color:O.color,deck:O.deck,isFaceDown:O.isFaceDown,types:O.types,faction:O.faction,statuses:O.statuses}))},score:R.score,isReady:R.isReady,announcedCard:R.announcedCard})),gameMode:k.gameMode,isPrivate:k.isPrivate,activeGridSize:k.activeGridSize,dummyPlayerCount:k.dummyPlayerCount,autoAbilitiesEnabled:k.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((w=e.current)==null?void 0:w.readyState)===WebSocket.OPEN&&e.current.send(JSON.stringify({type:"RESET_GAME",gameId:a.current.gameId}))},[e,r,a,c,E,P]);return{toggleActivePlayer:S,toggleAutoDraw:y,setPhase:A,nextPhase:f,prevPhase:I,closeRoundEndModal:p,closeRoundEndModalOnly:_,resetGame:D}}function _i(t){const{ws:e,gameStateRef:r,updateState:n,updatePlayerScore:a,triggerFloatingText:o,clearTargetingMode:c,webrtcIsHostRef:i}=t,s=H.useCallback((E,P,S,y,A)=>{var k,R;const f=r.current;if(!f.isGameStarted||f.isRoundEndModalOpen)return;const I=f.board.some(O=>O.some(U=>{var $,M;return(($=U.card)==null?void 0:$.ownerId)===A&&U.card.name.toLowerCase().includes("data liberator")&&((M=U.card.statuses)==null?void 0:M.some(G=>G.type==="Support"))})),p=f.board.length;let _=E,D=E,u=P,w=P;if(E===S)_=E,D=E,u=0,w=p-1;else if(P===y)u=P,w=P,_=0,D=p-1;else return;let T=0;const m=[];for(let O=_;O<=D;O++)for(let U=u;U<=w;U++){const M=f.board[O][U].card;if(M&&!((k=M.statuses)!=null&&k.some(G=>G.type==="Stun"))){const G=M.ownerId===A,x=(R=M.statuses)==null?void 0:R.some(q=>q.type==="Exploit"&&q.addedByPlayerId===A);if(G||I&&x){const q=Math.max(0,M.power+(M.powerModifier||0)+(M.bonusPower||0));q>0&&(T+=q,m.push({row:O,col:U,text:`+${q}`,playerId:A}))}}}m.length>0&&o(m);const g=Fe();if(g?n(O=>({...O,players:O.players.map(U=>U.id===A?{...U,score:Math.max(0,(U.score||0)+T)}:U)})):a(A,T),g||a(A,T),T>0&&f.currentPhase===4&&f.activePlayerId===A&&(!g||(i==null?void 0:i.current)!==!1)){const O=f.gameId;setTimeout(()=>{var U;c==null||c(),g?n($=>gt($)):((U=e.current)==null?void 0:U.readyState)===WebSocket.OPEN&&O&&e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:O}))},100)}},[o,a,n,e,r,c,gt,i]),d=H.useCallback((E,P,S,y,A,f)=>{var C,k,R;const I=r.current;if(!I.isGameStarted||I.isRoundEndModalOpen)return;const p=S>E?1:-1,_=y>P?1:-1,D=Math.abs(E-S);let u=0,w=0;const T=[];for(let O=0;O<=D;O++){const U=E+O*p,$=P+O*_;if(U<0||U>=I.board.length||$<0||$>=I.board.length)continue;const G=I.board[U][$].card;if(G&&!((C=G.statuses)!=null&&C.some(x=>x.type==="Stun"))){const x=G.ownerId===A,q=(k=G.statuses)==null?void 0:k.some(Z=>Z.type==="Exploit"&&Z.addedByPlayerId===A);if(x||q){const Z=Math.max(0,G.power+(G.powerModifier||0)+(G.bonusPower||0));Z>0&&(u+=Z,T.push({row:U,col:$,text:`+${Z}`,playerId:A})),f&&((R=G.statuses)!=null&&R.some(J=>J.type==="Support"&&J.addedByPlayerId===A))&&(w+=1)}}}f==="point_per_support"&&w>0&&(u+=w),T.length>0&&o(T);const m=Fe();if(m?n(O=>({...O,players:O.players.map(U=>U.id===A?{...U,score:Math.max(0,(U.score||0)+u)}:U)})):a(A,u),m||a(A,u),f==="draw_per_support"&&w>0&&n(O=>{const U=fe(O),$=U.players.find(M=>M.id===A);if($&&$.deck.length>0)for(let M=0;M<w;M++)$.deck.length>0&&$.hand.push($.deck.shift());return U}),u>0&&I.currentPhase===4&&I.activePlayerId===A&&(!m||(i==null?void 0:i.current)!==!1)){const O=I.gameId;setTimeout(()=>{var U;c==null||c(),m?n($=>gt($)):((U=e.current)==null?void 0:U.readyState)===WebSocket.OPEN&&O&&e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:O}))},500)}},[o,a,n,e,r,c,gt,i]);return{scoreLine:s,scoreDiagonal:d}}const Si=t=>{const{updateState:e,rawJsonData:r,broadcastCardStatusSync:n}=t,a=H.useCallback((y,A,f,I)=>{const p=[];e(_=>{var w,T,m;if(!_.isGameStarted||y.row<0||y.col<0)return _;const D=fe(_),u=(T=(w=D.board[y.row])==null?void 0:w[y.col])==null?void 0:T.card;if(u){const g=u.statuses?u.statuses.map(C=>C.type):[];if(I&&u.statuses){u.statuses=u.statuses.filter(k=>k.type!==I);const C=u.statuses.map(k=>k.type);if(l.debug(`[markAbilityUsed] Removed status '${I}' from ${u.name} at [${y.row},${y.col}]: [${g.join(", ")}] -> [${C.join(", ")}]`),I===Xn?(jn(u,"setup"),l.debug(`[markAbilityUsed] Marked Setup ability as used this turn for ${u.name}`),p.push({cardId:u.id,statusType:"setupUsedThisTurn",action:"add",ownerId:u.ownerId})):I===Zn&&(jn(u,"commit"),l.debug(`[markAbilityUsed] Marked Commit ability as used this turn for ${u.name}`),p.push({cardId:u.id,statusType:"commitUsedThisTurn",action:"add",ownerId:u.ownerId})),I===As){const k=u.ownerId;if(k&&k>0){const R=D.activePlayerId===k,O=(m=u.statuses)==null?void 0:m.some(U=>U.type==="Stun");if(R&&!O){const U=ma(u);let $=null;D.currentPhase===1&&U.includes("setup")?$=Xn:D.currentPhase===3&&U.includes("commit")&&($=Zn),$&&!u.statuses.some(M=>M.type===$)&&(u.statuses.push({type:$,addedByPlayerId:k}),l.debug(`[markAbilityUsed] Added phase-specific status '${$}' to ${u.name} after Deploy`))}}}}else l.debug(`[markAbilityUsed] Called for ${u.name} at [${y.row},${y.col}] but no readyStatusToRemove specified. Current statuses: [${g.join(", ")}]`)}return D}),p.length>0&&n&&setTimeout(()=>{n(p)},0)},[e,n]),o=H.useCallback(y=>{e(A=>{var p,_;if(!A.isGameStarted||y.row<0||y.col<0)return A;const f=fe(A),I=(_=(p=f.board[y.row])==null?void 0:p[y.col])==null?void 0:_.card;if(I&&(I.statuses||(I.statuses=[]),(I.ability||"").toLowerCase().includes("deploy:")&&!I.statuses.some(u=>u.type==="readyDeploy"))){const u=I.ownerId;if(u==null||u===0)return A;I.statuses.push({type:"readyDeploy",addedByPlayerId:u})}return f})},[e]),c=H.useCallback((y,A)=>{e(f=>{if(!f.isGameStarted)return f;const I=fe(f),p=I.board[y.row][y.col].card;return p!=null&&p.statuses&&(p.statuses=p.statuses.filter(_=>_.type!==A)),I.board=Le(I),I})},[e]),i=H.useCallback((y,A,f,I,p)=>{e(_=>{if(!_.isGameStarted)return _;const D=fe(_);return A.forEach(({row:u,col:w})=>{var m;const T=D.board[u][w].card;if(T){if(f==="Stun"&&(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius")&&((m=T.types)!=null&&m.includes("Hero"))))return;T.statuses||(T.statuses=[]),["Support","Threat","Revealed"].includes(f)?T.statuses.some(C=>C.type===f&&C.addedByPlayerId===I)||T.statuses.push({type:f,addedByPlayerId:I}):T.statuses.push({type:f,addedByPlayerId:I})}}),D})},[e]),s=H.useCallback((y,A)=>{e(f=>{if(!f.isGameStarted)return f;const I=fe(f),p=I.board[y.row][y.col].card,_=I.board[A.row][A.col].card;return I.board[y.row][y.col].card=_,I.board[A.row][A.col].card=p,I.board=Le(I),I})},[e]),d=H.useCallback((y,A,f)=>{e(I=>{if(!I.isGameStarted)return I;const p=fe(I),_=p.board[y.row][y.col].card,D=p.board[A.row][A.col].card;if(_&&D&&_.statuses){const u=_.statuses.findIndex(w=>w.type===f);if(u>-1){const[w]=_.statuses.splice(u,1);D.statuses||(D.statuses=[]),D.statuses.push(w)}}return p.board=Le(p),p})},[e]),E=H.useCallback((y,A)=>{e(f=>{if(!f.isGameStarted)return f;const I=fe(f),p=I.board[y.row][y.col].card,_=I.board[A.row][A.col].card,D=["Support","Threat","LastPlayed"];if(p&&_&&p.statuses){const u=p.statuses.filter(T=>!D.includes(T.type)),w=p.statuses.filter(T=>D.includes(T.type));u.length>0&&(_.statuses||(_.statuses=[]),_.statuses.push(...u),p.statuses=w)}return I.board=Le(I),I})},[e]),P=H.useCallback((y,A)=>{e(f=>{if(!f.isGameStarted)return f;const I=fe(f),p=I.board[y.row][y.col].card,_=I.board[A.row][A.col].card;return p&&_&&p.statuses&&p.statuses.length>0&&(_.statuses||(_.statuses=[]),_.statuses.push(...p.statuses),p.statuses=[]),I.board=Le(I),I})},[e]),S=H.useCallback((y,A,f)=>{e(I=>{if(!I.isGameStarted)return I;const p=fe(I);if(!r)return I;const _=r.tokenDatabase,D=Object.keys(_).find(T=>_[T].name===A);if(!D)return I;const u=_[D],w=p.players.find(T=>T.id===f);if(u&&p.board[y.row][y.col].card===null){const T={id:`TKN_${A.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:Ce.Tokens,name:A,baseId:u.baseId||D,imageUrl:u.imageUrl,fallbackImage:u.fallbackImage,power:u.power,ability:u.ability,flavorText:u.flavorText,color:u.color,types:u.types||["Unit"],faction:"Tokens",ownerId:f,ownerName:w==null?void 0:w.name,enteredThisTurn:!0,statuses:[]};yr(T,f,p.currentPhase),p.board[y.row][y.col].card=T}return p.board=Le(p),p})},[e,r]);return{markAbilityUsed:a,applyGlobalEffect:i,swapCards:s,transferStatus:d,transferAllCounters:E,transferAllStatusesWithoutException:P,spawnToken:S,resetDeployStatus:o,removeStatusByType:c}};function bi(t){const{updateState:e,localPlayerIdRef:r,updatePlayerScore:n}=t,a=H.useCallback((s,d)=>{e(E=>{var p,_,D,u,w,T;if(!E.isGameStarted||d.target==="board"&&d.boardCoords&&E.board[d.boardCoords.row][d.boardCoords.col].card!==null&&s.source!=="counter_panel")return E;let P=!1;try{const m=localStorage.getItem("auto_abilities_enabled");P=m===null?!0:m==="true"}catch{P=!0}const S=P&&E.currentPhase===1&&s.source==="hand"&&d.target==="board"&&(((p=s.card.types)==null?void 0:p.includes("Unit"))||((_=s.card.types)==null?void 0:_.includes("Command"))),y=fe(E);if(s.source==="board"&&["hand","deck","discard"].includes(d.target)&&!s.bypassOwnershipCheck){const m=s.card.ownerId,g=y.players.find(R=>R.id===m),C=m===r.current,k=!!(g!=null&&g.isDummy);if(!C&&!k)return E}let A=null;if(s.source==="board"&&s.boardCoords){const m=y.board[s.boardCoords.row][s.boardCoords.col];if(m.card&&(A=m.card),d.target==="board"){const C=E.board[s.boardCoords.row][s.boardCoords.col].card||A;if(C&&((D=C.statuses)==null?void 0:D.some(R=>R.type==="Stun"))){const R=r.current,O=C.ownerId,U=E.players.find(x=>x.id===R),$=E.players.find(x=>x.id===O),M=R===O,G=(U==null?void 0:U.teamId)!==void 0&&($==null?void 0:$.teamId)!==void 0&&U.teamId===$.teamId;if((M||G)&&!s.isManual)return E}}}if(s.source==="counter_panel"&&s.statusType){const m=ut[s.statusType],g=(m==null?void 0:m.allowedTargets)??["board","hand"];if(!g.includes(d.target)&&!g.includes("board-facedown"))return E;let C=null;if(d.target==="board"&&d.boardCoords){if(C=y.board[d.boardCoords.row][d.boardCoords.col].card,g.includes("board-facedown")&&C&&!C.isFaceDown)return E}else if(d.playerId!==void 0){const k=y.players.find(R=>R.id===d.playerId);k&&(d.target==="hand"&&d.cardIndex!==void 0&&(C=k.hand[d.cardIndex]),d.target==="announced"&&(C=k.announcedCard||null),d.target==="deck"&&k.deck.length>0?d.deckPosition==="top"||!d.deckPosition?C=k.deck[0]:C=k.deck[k.deck.length-1]:d.target==="discard"&&k.discard.length>0&&(C=k.discard[k.discard.length-1]))}if(C){if(s.statusType==="Stun"&&(C.baseId==="luciusTheImmortal"||C.name.includes("Lucius")&&((u=C.types)!=null&&u.includes("Hero"))))return y;const k=s.count||1;let R;if(s.ownerId!==void 0)R=s.ownerId;else if(s.card.ownerId!==void 0)R=s.card.ownerId;else{const O=y.players.find(U=>U.id===y.activePlayerId);R=O!=null&&O.isDummy?O.id:r.current!==null?r.current:0}if(s.statusType==="Revealed"&&(d.target==="board"&&C.ownerId===R||d.target==="hand"&&d.playerId===R))return E;if(s.statusType==="Power+")C.powerModifier===void 0&&(C.powerModifier=0),C.powerModifier+=1*k;else if(s.statusType==="Power-")C.powerModifier===void 0&&(C.powerModifier=0),C.powerModifier-=1*k;else if(s.statusType==="Revealed"&&d.target==="hand"){if(C.revealedTo||(C.revealedTo=[]),C.revealedTo!=="all"){const U=Array.isArray(C.revealedTo)?C.revealedTo:[];U.includes(R)||U.push(R),C.revealedTo=U}C.statuses||(C.statuses=[]),C.statuses.some(U=>U.type==="Revealed"&&U.addedByPlayerId===R)||C.statuses.push({type:"Revealed",addedByPlayerId:R})}else if(C.statuses||(C.statuses=[]),s.replaceStatusType&&s.statusType)for(let O=0;O<k;O++){const U=C.statuses.findIndex($=>$.type===s.replaceStatusType&&$.addedByPlayerId===R);U!==-1?C.statuses[U]={type:s.statusType,addedByPlayerId:R}:C.statuses.push({type:s.statusType,addedByPlayerId:R})}else for(let O=0;O<k;O++)["Support","Threat","Revealed"].includes(s.statusType)?C.statuses.some($=>$.type===s.statusType&&$.addedByPlayerId===R)||C.statuses.push({type:s.statusType,addedByPlayerId:R}):C.statuses.push({type:s.statusType,addedByPlayerId:R});return d.target==="board"&&(y.board=Le(y)),y}return E}const f=A?{...A}:{...s.card};if(s.source==="hand"&&s.playerId!==void 0&&s.cardIndex!==void 0){const m=y.players.find(g=>g.id===s.playerId);if(m){const g=m.hand[s.cardIndex];if(g&&g.id===s.card.id&&g.ownerId===s.card.ownerId)m.hand.splice(s.cardIndex,1);else{const C=m.hand.findIndex(k=>k.id===s.card.id&&k.ownerId===s.card.ownerId);if(C!==-1)m.hand.splice(C,1);else return E}}}else if(s.source==="board"&&s.boardCoords){const m=y.board[s.boardCoords.row][s.boardCoords.col];if(m.card&&m.card.id===s.card.id&&m.card.ownerId===s.card.ownerId)y.board[s.boardCoords.row][s.boardCoords.col].card=null;else return E}else if(s.source==="discard"&&s.playerId!==void 0){const m=y.players.find(g=>g.id===s.playerId);if(m){let g=!1;if(s.cardIndex!==void 0){const C=m.discard[s.cardIndex];C&&C.id===s.card.id&&C.ownerId===s.card.ownerId&&(m.discard.splice(s.cardIndex,1),g=!0)}if(!g){const C=m.discard.findIndex(k=>k.id===s.card.id&&k.ownerId===s.card.ownerId);if(C!==-1)m.discard.splice(C,1);else return E}}}else if(s.source==="deck"&&s.playerId!==void 0&&s.cardIndex!==void 0){const m=y.players.find(g=>g.id===s.playerId);if(m){const g=m.deck[s.cardIndex];if(g&&g.id===s.card.id&&g.ownerId===s.card.ownerId)m.deck.splice(s.cardIndex,1);else{const C=m.deck.findIndex(k=>k.id===s.card.id&&k.ownerId===s.card.ownerId);if(C!==-1)m.deck.splice(C,1);else return E}}}else if(s.source==="announced"&&s.playerId!==void 0){const m=y.players.find(g=>g.id===s.playerId);if(m)if(m.announcedCard&&m.announcedCard.id===s.card.id)m.announcedCard=null;else return E}if(["hand","deck","discard"].includes(d.target))f.statuses&&(f.statuses=f.statuses.filter(m=>m.type==="Revealed")),f.isFaceDown=!1,delete f.powerModifier,delete f.bonusPower,delete f.enteredThisTurn;else if(d.target==="board"&&(f.statuses||(f.statuses=[]),s.source!=="board"&&f.isFaceDown===void 0&&(f.isFaceDown=!1),s.source!=="board")){f.enteredThisTurn=!0;let m=f.ownerId;m===void 0&&(s.source==="token_panel"?s.ownerId!==void 0?m=s.ownerId:m=y.activePlayerId??r.current??0:s.playerId!==void 0?m=s.playerId:m=r.current??0,f.ownerId=m),yr(f,m,y.currentPhase),s.source==="discard"&&(f.baseId==="luciusTheImmortal"||f.name.includes("Lucius"))&&(f.powerModifier===void 0&&(f.powerModifier=0),f.powerModifier+=2)}if(d.target==="hand"&&d.playerId!==void 0){if(f.deck===Ce.Tokens)return y.board[s.boardCoords.row][s.boardCoords.col].card=null,y;Qt(f);const g=y.players.find(k=>k.id===d.playerId);if(!g)return E;let C=d.cardIndex!==void 0?d.cardIndex:g.hand.length;if(s.source==="hand"&&s.playerId===d.playerId&&s.cardIndex!==void 0&&(s.cardIndex<C&&(C-=1),s.cardIndex===C))return E;g.hand.splice(C,0,f)}else if(d.target==="board"&&d.boardCoords){if(y.board[d.boardCoords.row][d.boardCoords.col].card===null){if(f.ownerId===void 0&&r.current!==null){const m=y.players.find(g=>g.id===r.current);m&&(f.ownerId=m.id,f.ownerName=m.name)}if(s.source!=="board"&&f.ownerId!==void 0){const m=y.players.find(g=>g.id===f.ownerId);m&&(m.boardHistory||(m.boardHistory=[]),m.boardHistory.push(f.id))}y.board[d.boardCoords.row][d.boardCoords.col].card=f}}else if(d.target==="discard"&&d.playerId!==void 0){if(f.deck===Ce.Tokens)return y.board[s.boardCoords.row][s.boardCoords.col].card=null,y;Qt(f);const g=y.players.find(C=>C.id===d.playerId);g&&(f.ownerId===void 0&&(f.ownerId=d.playerId,f.ownerName=g.name),g.discard.some(k=>k.id===f.id)||g.discard.push(f))}else if(d.target==="deck"&&d.playerId!==void 0){if(f.deck===Ce.Tokens)return y.board[s.boardCoords.row][s.boardCoords.col].card=null,y;Qt(f);const g=y.players.find(C=>C.id===d.playerId);if(!g)return E;f.ownerId===void 0&&(f.ownerId=d.playerId,f.ownerName=g.name),d.deckPosition==="top"||!d.deckPosition?g.deck.unshift(f):g.deck.push(f)}else if(d.target==="announced"&&d.playerId!==void 0){const m=y.players.find(g=>g.id===d.playerId);m&&(m.announcedCard&&(m.announcedCard.statuses&&(m.announcedCard.statuses=m.announcedCard.statuses.filter(g=>g.type==="Revealed")),delete m.announcedCard.enteredThisTurn,delete m.announcedCard.powerModifier,delete m.announcedCard.bonusPower,m.hand.push(m.announcedCard)),m.announcedCard=f)}if(s.source==="board"&&d.target!=="board"&&f.ownerId!==void 0){const m=y.players.find(g=>g.id===f.ownerId);m&&(m.boardHistory||(m.boardHistory=[]),m.boardHistory=m.boardHistory.filter(g=>g!==f.id))}if((s.source==="board"||d.target==="board")&&f.ownerId!==void 0){const m=y.players.find(g=>g.id===f.ownerId);m&&Ca(y.board,m)}if(s.source==="hand"&&d.target==="board"){const m=f;if(m.revealedTo==="all"||((w=m.statuses)==null?void 0:w.some(C=>C.type==="Revealed"))){const C=y.board.length;for(let k=0;k<C;k++)for(let R=0;R<C;R++){const O=y.board[k][R].card;if(O&&O.name.toLowerCase().includes("vigilant spotter")&&O.ownerId!==m.ownerId&&(y.board=Le(y),(T=y.board[k][R].card.statuses)!=null&&T.some($=>$.type==="Support"))){const $=y.players.find(M=>M.id===O.ownerId);$&&setTimeout(()=>{n($.id,2)},0)}}}}return(s.source==="board"||d.target==="board")&&(y.board=Le(y)),S&&(y.currentPhase=2),y})},[e,r,n]),o=H.useCallback((s,d)=>{e(E=>{if(!E.isGameStarted)return E;const P=fe(E),S=P.board.length;if(s.row<0||s.row>=S||s.col<0||s.col>=S||d.row<0||d.row>=S||d.col<0||d.col>=S)return E;const y=P.board[s.row][s.col],A=P.board[d.row][d.col],f=y.card,I=A.card;return!f||!I?E:(P.board[s.row][s.col].card=I,P.board[d.row][d.col].card=f,P.board=Le(P),P)})},[e]),c=H.useCallback((s,d)=>{e(E=>{if(!E.isGameStarted)return E;const P=fe(E),S=P.board[d.row][d.col];if(!S.card||S.card.id!==s.id||S.card.ownerId!==s.ownerId)return E;const y=S.card,A=y.ownerId,f=P.players.find(I=>I.id===A);return f?(P.board[d.row][d.col].card=null,y.statuses&&(y.statuses=y.statuses.filter(I=>I.type==="Revealed")),y.isFaceDown=!1,delete y.powerModifier,delete y.bonusPower,f.discard.push(y),P.board=Le(P),P):E})},[e]),i=H.useCallback((s,d)=>{e(E=>{if(!E.isGameStarted)return E;const P=fe(E),S=P.board[d.row][d.col];if(!S.card||S.card.id!==s.id||S.card.ownerId!==s.ownerId)return E;const y=S.card,A=y.ownerId,f=P.players.find(I=>I.id===A);return f?(P.board[d.row][d.col].card=null,y.statuses&&(y.statuses=y.statuses.filter(I=>I.type==="Revealed")),y.isFaceDown=!1,delete y.powerModifier,delete y.bonusPower,f.hand.push(y),P.board=Le(P),P):E})},[e]);return{moveItem:a,swapBoardCards:o,destroyCard:c,returnCardToHand:i}}function Ai(t){const{ws:e,webrtcManager:r,gameStateRef:n,webrtcIsHostRef:a,setGameState:o}=t,c=H.useCallback((s,d,E,P,S,y)=>{var D,u,w,T,m,g,C;const A=n.current;if(typeof d!="number"){l.error(`[TargetingMode] Invalid playerId type: ${typeof d}, value:`,d);return}let f=[];P?f=P:f=Bt(s,A,d,S);let I=[];if(y)I=y;else if(I=[],(D=s.payload)!=null&&D.filter&&s.mode==="SELECT_TARGET"){l.info("[TargetingMode] Calculating hand targets for action",{actionMode:s.mode,filterType:typeof s.payload.filter,hasActionType:!!s.payload.actionType});for(const k of A.players)k.hand&&k.hand.forEach((R,O)=>{try{s.payload.filter(R)&&(I.push({playerId:k.id,cardIndex:O}),l.debug(`[TargetingMode] Found hand target: player ${k.id}, card ${O}, card ${R.name}`))}catch(U){l.warn(`[TargetingMode] Filter failed for card ${R.name}:`,U)}});l.info(`[TargetingMode] Hand targets calculated: ${I.length} targets`)}else l.info("[TargetingMode] No hand targets calculated - no filter or wrong mode",{hasFilter:!!((u=s.payload)!=null&&u.filter),mode:s.mode});const p=s.mode==="SELECT_DECK",_={playerId:d,action:s,sourceCoords:E,timestamp:Date.now(),boardTargets:f,handTargets:I.length>0?I:void 0,isDeckSelectable:p||void 0,originalOwnerId:s.originalOwnerId};if(o(k=>({...k,targetingMode:_})),n.current.targetingMode=_,((w=e.current)==null?void 0:w.readyState)===WebSocket.OPEN&&A.gameId&&e.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:A.gameId,targetingMode:_})),r.current)if(a.current)r.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((m=(T=r.current).getPeerId)==null?void 0:m.call(T))??void 0,data:{targetingMode:_},timestamp:Date.now()});else{const k=r.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((C=(g=r.current).getPeerId)==null?void 0:C.call(g))??void 0,data:{targetingMode:_},timestamp:Date.now()});l.info("[TargetingMode] Guest sent SET_TARGETING_MODE to host",{success:k,playerId:d,boardTargetsCount:f.length,handTargetsCount:I.length})}l.info(`[TargetingMode] Player ${d} (type: ${typeof d}) activated targeting mode`,{mode:s.mode,boardTargetsCount:f.length,handTargetsCount:I.length,isDeckSelectable:p||!1})},[e,r,n,a,o]),i=H.useCallback(()=>{var d,E,P,S,y;const s=n.current;o(A=>({...A,targetingMode:null})),n.current.targetingMode=null,((d=e.current)==null?void 0:d.readyState)===WebSocket.OPEN&&s.gameId&&e.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:s.gameId})),r.current&&(a.current?r.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((P=(E=r.current).getPeerId)==null?void 0:P.call(E))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):r.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((y=(S=r.current).getPeerId)==null?void 0:y.call(S))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[e,r,n,a,o]);return{setTargetingMode:c,clearTargetingMode:i}}function Ci(t){const{webrtcManagerRef:e,webrtcIsHostRef:r,setWebrtcIsHost:n,setConnectionStatus:a,setWebrtcHostId:o,gameStateRef:c,localPlayerIdRef:i}=t,s=H.useCallback(async()=>{var A;try{n(!0),a("Connecting");const f=fr();e.current=f;const I=await f.initializeAsHost();o(I),a("Connected");const p=c.current.gameId;p&&lr(I,p);const _=(A=c.current.players)==null?void 0:A.find(D=>D.id===i.current);return vs({peerId:I,isHost:!0,playerName:(_==null?void 0:_.name)||null}),l.info("[initializeWebrtcHost] Saved host data for auto-restore"),I}catch(f){return l.error("Failed to initialize WebRTC host:",f),a("Disconnected"),null}},[n,a,o,c,i,e]),d=H.useCallback(async A=>{try{n(!1),o(A),a("Connecting");const f=fr();return e.current=f,await f.initializeAsGuest(A),!0}catch(f){return l.error("Failed to connect as guest:",f),a("Disconnected"),!1}},[n,a,o,e]),E=H.useCallback((A,f)=>e.current?r.current?(l.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):e.current.sendAction(A,f):(l.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[e,r]),P=H.useCallback(A=>!e.current||r.current?(l.warn("[requestDeckView] Only guests can request deck view from host"),!1):e.current.sendAction("REQUEST_DECK_VIEW",{targetPlayerId:A}),[e,r]),S=H.useCallback((A,f,I)=>!e.current||r.current?(l.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):e.current.sendFullDeckToHost(A,f,I),[e,r]),y=H.useCallback((A,f)=>!e.current||!r.current?(l.warn("[shareHostDeckWithGuests] Only host can share deck data"),!1):e.current.broadcastToGuests({type:"HOST_DECK_DATA",senderId:e.current.getPeerId(),data:{deck:A,deckSize:f},timestamp:Date.now()}),[e,r]);return{initializeWebrtcHost:s,connectAsGuest:d,sendWebrtcAction:E,requestDeckView:P,sendFullDeckToHost:S,shareHostDeckWithGuests:y}}function Di(){const t=localStorage.getItem("custom_ws_url");if(!t||t.trim()==="")return l.warn("No custom WebSocket URL configured in settings."),null;let e=t.trim();return e.endsWith("/")&&(e=e.slice(0,-1)),e.startsWith("https://")?e=e.replace("https://","wss://"):e.startsWith("http://")&&(e=e.replace("http://","ws://")),!e.startsWith("ws://")&&!e.startsWith("wss://")?(l.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",e),e)}function Ri(t){const{gameStateRef:e,localPlayerIdRef:r,setGameState:n,setLocalPlayerId:a,setConnectionStatus:o,setGamesList:c,setLatestHighlight:i,setLatestNoTarget:s,setLatestDeckSelections:d,setLatestHandCardSelections:E,setClickWaves:P,setLatestFloatingTexts:S,setRemoteValidTargets:y,isManualExitRef:A,joiningGameIdRef:f,playerTokenRef:I,receivedServerStateRef:p,isJoinAttemptRef:_}=t,D=H.useRef(null),u=H.useRef(null),w=H.useCallback(()=>{if(Fe()){o("Connected");return}if(A.current||D.current&&(D.current.readyState===WebSocket.OPEN||D.current.readyState===WebSocket.CONNECTING))return;const O=Di();if(!O){l.warn("No WebSocket URL configured in settings. Waiting for user input."),o("Disconnected"),u.current&&clearTimeout(u.current);return}try{D.current=new WebSocket(O)}catch(U){l.error("Failed to create WebSocket:",U),o("Disconnected"),u.current&&clearTimeout(u.current),u.current=window.setTimeout(w,ie.RECONNECT_DELAY);return}o("Connecting"),D.current.onopen=()=>{var M;p.current=!1,o("Connected");const U=localStorage.getItem("custom_ws_url");U&&U.trim()!==""&&localStorage.setItem("websocket_url",U.trim());const $=e.current;if(l.info("Current gameState on open:",$?`gameId=${$.gameId}`:"null"),l.info("playerTokenRef.current on open:",I.current?"YES":"NO"),$&&$.gameId&&((M=D.current)==null?void 0:M.readyState)===WebSocket.OPEN){let G=I.current;if(!G){try{const x=localStorage.getItem(dt);if(x){const q=JSON.parse(x);l.info("RECONNECTION_DATA_KEY:",q==null?void 0:q.gameId,$.gameId),q!=null&&q.playerToken&&(G=q.playerToken,I.current=G,l.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(x){console.warn("Failed to parse reconnection data:",x instanceof Error?x.message:String(x))}if(!G&&$.players&&r.current){const x=$.players.find(q=>q.id===r.current);x!=null&&x.playerToken&&(G=x.playerToken,I.current=G)}}l.info("JoinGame: Sending reconnection with token:",G?"YES":"NO","gameId:",$.gameId),D.current.send(JSON.stringify({type:"JOIN_GAME",gameId:$.gameId,playerToken:G}))}},D.current.onmessage=U=>{var $;try{const M=JSON.parse(U.data);if(M.type==="GAMES_LIST")c(M.games);else if(M.type==="JOIN_SUCCESS"){if(M.isSpectator){a(null),l.info("Joined as spectator:",M.message||"Spectator mode"),f.current=null;return}a(M.playerId);const G=f.current||e.current.gameId;G&&M.playerId!==null&&M.playerToken?(I.current=M.playerToken,localStorage.setItem(dt,JSON.stringify({gameId:G,playerId:M.playerId,playerToken:M.playerToken,timestamp:Date.now()})),e.current.gameId===G&&sa(e.current,M.playerId,M.playerToken)):M.playerId===null&&(Tt(),I.current=void 0),f.current=null,M.playerId===1&&setTimeout(()=>{var x;((x=D.current)==null?void 0:x.readyState)===WebSocket.OPEN&&D.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:xe}))},ie.DECK_SYNC_DELAY)}else if(M.type==="CONNECTION_ESTABLISHED"){l.info("Connection acknowledged by server");const G=sessionStorage.getItem("pending_invite_game"),x=sessionStorage.getItem("pending_invite_name");G&&D.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),l.info("Auto-joining invite game:",G),D.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:G,playerName:x||"Player"})))}else if(M.type==="DECK_DATA_UPDATED")l.info("Deck data synced with server");else if(M.type==="ERROR")if(M.message.includes("not found")||M.message.includes("Dummy")){l.info("Game not found error - clearing state");const G=it();n(G),e.current=G,a(null),Tt(),f.current=null}else if(M.message.includes("already started")&&_.current){l.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const G=it();n(G),e.current=G,a(null),Tt(),f.current=null,_.current=!1}else console.warn("Server Error:",M.message);else if(M.type==="HIGHLIGHT_TRIGGERED")i(M.highlightData);else if(M.type==="NO_TARGET_TRIGGERED")s({coords:M.coords,timestamp:M.timestamp});else if(M.type==="DECK_SELECTION_TRIGGERED")d(G=>[...G,M.deckSelectionData]),setTimeout(()=>{d(G=>G.filter(x=>x.timestamp!==M.deckSelectionData.timestamp))},1e3);else if(M.type==="HAND_CARD_SELECTION_TRIGGERED")E(G=>[...G,M.handCardSelectionData]),setTimeout(()=>{E(G=>G.filter(x=>x.timestamp!==M.handCardSelectionData.timestamp))},1e3);else if(M.type==="FLOATING_TEXT_TRIGGERED")n(G=>({...G,floatingTexts:[...G.floatingTexts,M.floatingTextData].filter(x=>Date.now()-x.timestamp<ie.FLOATING_TEXT_DURATION)}));else if(M.type==="FLOATING_TEXT_BATCH_TRIGGERED")n(G=>({...G,floatingTexts:[...G.floatingTexts,...M.batch].filter(x=>Date.now()-x.timestamp<ie.FLOATING_TEXT_DURATION)}));else if(M.type==="CLICK_WAVE_TRIGGERED")M.wave&&M.wave.clickedByPlayerId!==r.current&&(P(G=>[...G,M.wave]),setTimeout(()=>{P(G=>G.filter(x=>x.timestamp!==M.wave.timestamp))},600));else if(M.type==="TARGETING_MODE_SET"){const G=M.targetingMode;if(G){n(q=>({...q,targetingMode:G})),e.current.targetingMode=G;const x=G.mode||(($=G.action)==null?void 0:$.mode);l.info("[TargetingMode] Received targeting mode from server",{playerId:G.playerId,mode:x})}}else if(M.type==="TARGETING_MODE_CLEARED")n(G=>({...G,targetingMode:null})),e.current.targetingMode=null,l.debug("[TargetingMode] Cleared targeting mode from server");else if(M.type==="ABILITY_MODE_SET")M.abilityMode&&(n(G=>({...G,abilityMode:M.abilityMode})),l.info("[AbilityMode] Received ability mode from host",{playerId:M.abilityMode.playerId,mode:M.abilityMode.mode,sourceCard:M.abilityMode.sourceCardName}));else if(M.type==="ABILITY_TARGET_SELECTED")l.info("[Ability] Target selected",M.data);else if(M.type==="ABILITY_COMPLETED")n(G=>({...G,abilityMode:void 0})),l.info("[Ability] Ability completed",M.data);else if(M.type==="ABILITY_CANCELLED")n(G=>({...G,abilityMode:void 0})),l.info("[Ability] Ability cancelled");else if(M.type==="GAME_RESET")l.info("[GameReset] Received GAME_RESET message from server"),n(G=>{const x=M.activeGridSize||8,q=[];for(let J=0;J<x;J++){const de=[];for(let pe=0;pe<x;pe++)de.push({card:null});q.push(de)}const Z={...G,players:M.players||[],gameMode:M.gameMode,isPrivate:M.isPrivate,activeGridSize:M.activeGridSize,dummyPlayerCount:M.dummyPlayerCount,autoAbilitiesEnabled:M.autoAbilitiesEnabled,isGameStarted:M.isGameStarted,currentPhase:M.currentPhase,currentRound:M.currentRound,turnNumber:M.turnNumber,activePlayerId:M.activePlayerId,startingPlayerId:M.startingPlayerId,roundWinners:M.roundWinners||{},gameWinner:M.gameWinner,isRoundEndModalOpen:M.isRoundEndModalOpen,isReadyCheckActive:M.isReadyCheckActive,board:q,targetingMode:null,floatingTexts:[]};return e.current=Z,Z});else if(!M.type&&M.players&&M.board){const G=Lt(M),x=e.current;if(!x.isScoringStep&&G.isScoringStep&&G.currentPhase!==2){l.debug("Ignoring delayed scoring state update");return}if(x.isScoringStep&&(G.currentPhase!==x.currentPhase||G.activePlayerId!==x.activePlayerId||G.currentPhase!==4)&&(G.isScoringStep=!1),n(G),e.current=G,r.current!==null&&G.gameId){let Z;try{const J=localStorage.getItem(dt);J&&(Z=JSON.parse(J).playerToken)}catch{}if(!Z&&G.players){const J=G.players.find(de=>de.id===r.current);J!=null&&J.playerToken&&(Z=J.playerToken,I.current=Z)}sa(G,r.current,Z)}}else console.warn("Unknown message type:",M.type,"keys:",Object.keys(M),"data:",M)}catch(M){l.error("Failed to parse message from server:",U.data,M)}},D.current.onclose=()=>{o("Disconnected"),A.current||(u.current&&clearTimeout(u.current),u.current=window.setTimeout(w,ie.RECONNECT_DELAY))},D.current.onerror=U=>l.error("WebSocket error event:",U)},[n,o,c,i,s,d,E,P,S,y,a,it,A,e,r,I,p,f]),T=H.useCallback(()=>{D.current&&(D.current.readyState===WebSocket.OPEN||D.current.readyState===WebSocket.CONNECTING)?D.current.close():w()},[D,w]),m=H.useCallback(O=>{var U;if(A.current=!1,((U=D.current)==null?void 0:U.readyState)===WebSocket.OPEN){f.current=O;let $=null;try{const G=localStorage.getItem(dt);G&&($=JSON.parse(G))}catch{Tt()}const M={type:"JOIN_GAME",gameId:O};($==null?void 0:$.gameId)===O&&$.playerToken?(M.playerToken=$.playerToken,l.info(`JoinGame: Sending reconnection with token ${$.playerToken.substring(0,8)}... for player ${$.playerId}`)):l.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${$==null?void 0:$.gameId}, requestedGameId=${O}`),D.current.send(JSON.stringify(M))}else w(),f.current=O},[D,A,f,w]),g=H.useCallback((O,U="Player")=>{var $;A.current=!1,(($=D.current)==null?void 0:$.readyState)===WebSocket.OPEN?D.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:O,playerName:U})):(sessionStorage.setItem("pending_invite_game",O),sessionStorage.setItem("pending_invite_name",U),w())},[w]),C=H.useCallback(()=>{A.current=!1,Tt();const O=Da(),U={...it(),gameId:O,players:[Ra(1)]};return p.current=!0,setTimeout(()=>{var $;(($=D.current)==null?void 0:$.readyState)===WebSocket.OPEN&&(D.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:O})),D.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:xe})))},ie.DECK_SYNC_DELAY),{gameId:O,initialState:U}},[A,p]),k=H.useCallback(()=>{var O;((O=D.current)==null?void 0:O.readyState)===WebSocket.OPEN&&D.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[D]),R=H.useCallback((O,U,$,M)=>{var q;if(O.current)return;A.current=!0;const G=e.current.gameId,x=r.current;G&&U.current&&$(G);try{M(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),l.info("[exitGame] Cleared WebRTC persistence data")}catch(Z){l.warn("[exitGame] Failed to clear WebRTC data:",Z)}n(it()),a(null),Tt(),D.current&&(D.current.onclose=null),((q=D.current)==null?void 0:q.readyState)===WebSocket.OPEN&&G&&x!==null&&D.current.send(JSON.stringify({type:"EXIT_GAME",gameId:G,playerId:x})),D.current&&D.current.close(),setTimeout(()=>{A.current=!1,w()},ie.RECONNECT_DELAY)},[e,r,A,n,a,D,w]);return{ws:D,reconnectTimeoutRef:u,connectWebSocket:w,forceReconnect:T,createGame:C,joinGame:m,joinAsInvite:g,exitGame:R,requestGamesList:k}}const et=new Map,Od=(t={})=>{const{abilityMode:e,setAbilityMode:r}=t,[n,a]=H.useState(it()),o=H.useRef(it()),c=H.useCallback(h=>{a(ae=>{const te=typeof h=="function"?h(ae):h;return o.current=ae,Fe()&&j.current&&setTimeout(()=>{K.current&&(K.current.broadcastGameState(te),l.debug(`[setGameStateWithDelta] Broadcast state: phase=${te.currentPhase}, round=${te.currentRound}`))},0),te})},[]),[i,s]=H.useState(null),d=H.useRef(n),E=H.useRef(i),[P,S]=H.useState(null),[y,A]=H.useState("Connecting"),[f,I]=H.useState([]),[p,_]=H.useState(null),[D,u]=H.useState(null),[w,T]=H.useState(null),[m,g]=H.useState([]),[C,k]=H.useState([]),[R,O]=H.useState([]),[U,$]=H.useState(null),[M,G]=H.useState(!!xe),[x,q]=H.useState(!1),[Z,J]=H.useState(null),[de,pe]=H.useState(!1),j=H.useRef(!1),[De,Oe]=H.useState(!1),[Re,Ge]=H.useState(null),Me=H.useRef(!1),_e=H.useRef(null),qe=H.useRef(!1),qt=H.useRef(!1),pt=H.useRef(),je=H.useRef(!1),K=H.useRef(null),ve=H.useRef(new Map),We=H.useRef(()=>{}),Qe=Ci({webrtcManagerRef:K,webrtcIsHostRef:j,setWebrtcIsHost:pe,setConnectionStatus:A,setWebrtcHostId:J,gameStateRef:d,localPlayerIdRef:E}),{initializeWebrtcHost:yt,connectAsGuest:bt,sendWebrtcAction:rt,requestDeckView:gr,sendFullDeckToHost:Vt,shareHostDeckWithGuests:nt}=Qe,ht=Ri({gameStateRef:d,localPlayerIdRef:E,setGameState:a,setLocalPlayerId:s,setConnectionStatus:A,setGamesList:I,setLatestHighlight:_,setLatestNoTarget:T,setLatestDeckSelections:g,setLatestHandCardSelections:k,setClickWaves:O,setLatestFloatingTexts:u,setRemoteValidTargets:$,isManualExitRef:qe,joiningGameIdRef:_e,playerTokenRef:pt,receivedServerStateRef:je,isJoinAttemptRef:qt}),{ws:ge,reconnectTimeoutRef:mt,connectWebSocket:wr,forceReconnect:Pa,joinGame:_r,joinAsInvite:ka,requestGamesList:Oa}=ht;H.useEffect(()=>{We.current=c},[c]),H.useEffect(()=>{j.current=de},[de]),H.useEffect(()=>{const h=Fe();if(q(h),h){K.current=fr();const ae=K.current.on(te=>{$a(te)});return()=>{ae()}}},[]),H.useEffect(()=>{if(!Fe())return;const ae=window.location.hash.slice(1);if(ae&&new URLSearchParams(ae).get("hostId"))return;const te="webrtc_auto_restore_attempted";if(sessionStorage.getItem(te))return;sessionStorage.setItem(te,"true");const re=Ms();if(re==="none"){sessionStorage.removeItem(te);return}setTimeout(async()=>{var le,ne;if(!K.current){l.warn("[Auto-restore] WebRTC manager not ready");return}try{if(re==="host"){Ve.current=!0,l.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ce=Ta(),X=Qn();if(!ce||!X){l.warn("[Auto-restore] Missing host data or state data"),at(),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}l.info(`[Auto-restore] Restoring host session: old peerId=${ce.peerId}`);const Te=await K.current.initializeAsHost();j.current=!0,pe(!0),J(Te),A("Connected"),(le=X.gameState)!=null&&le.gameId&&(lr(Te,X.gameState.gameId),l.info(`[Auto-restore] Broadcasted NEW host peerId ${Te} for game ${X.gameState.gameId}`)),(X.gameState||X.localPlayerId!==null)&&(X.gameState&&(d.current=X.gameState),X.localPlayerId!==null&&(E.current=X.localPlayerId),Me.current=!0,setTimeout(()=>{Me.current=!1},1e4),setTimeout(()=>{var Se;X.gameState&&(a(X.gameState),l.info(`[Auto-restore] Restored game state with ${((Se=X.gameState.players)==null?void 0:Se.length)||0} players, gameId=${X.gameState.gameId}`)),X.localPlayerId!==null&&(s(X.localPlayerId),l.info(`[Auto-restore] Restored local player ID: ${X.localPlayerId}`))},0)),setTimeout(()=>{if(Ve.current=!1,l.info("[Auto-restore] Cleared restoration flag"),K.current&&X.gameState){const Se=X.gameState.players.filter(He=>!He.isDummy&&He.id!==X.localPlayerId);Se.length>0&&(l.info(`[Auto-restore] Requesting deck data from ${Se.length} guest players`),K.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:K.current.getPeerId(),timestamp:Date.now()}))}},500),l.info("[Auto-restore] Host session restoration initiated")}else if(re==="guest"){Ve.current=!0,l.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ce=ga(),X=Qn();if(!ce||!X){l.warn("[Auto-restore] Missing guest data or state data"),at(),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}l.info(`[Auto-restore] Restoring guest session: old hostPeerId=${ce.hostPeerId}, playerId=${ce.playerId}`),j.current=!1,pe(!1),A("Connecting");let Te=ce.hostPeerId;if((ne=X.gameState)!=null&&ne.gameId){const Se=rr(X.gameState.gameId);Se&&Se.peerId&&(Te=Se.peerId,l.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Te}`))}if(J(Te),ce.playerId!==null){l.info(`[Auto-restore] Reconnecting as existing player ${ce.playerId} to host ${Te}`);try{await K.current.initializeAsReconnectingGuest(Te,ce.playerId),A("Connected"),l.info("[Auto-restore] Successfully reconnected to host")}catch(Se){l.error("[Auto-restore] Failed to reconnect to host:",Se),A("Disconnected"),at(),l.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else l.info("[Auto-restore] Connecting as new player"),await K.current.initializeAsGuest(Te),A("Connected");(X.gameState||X.localPlayerId!==null)&&(X.gameState&&(d.current=X.gameState),X.localPlayerId!==null&&(E.current=X.localPlayerId),Me.current=!0,setTimeout(()=>{Me.current=!1},1e4),setTimeout(()=>{var Se,He;if(X.gameState&&(a(X.gameState),l.info(`[Auto-restore] Restored game state with ${((Se=X.gameState.players)==null?void 0:Se.length)||0} players, gameId=${X.gameState.gameId}, isGameStarted=${X.gameState.isGameStarted}`),X.localPlayerId!==null)){const ue=(He=X.gameState.players)==null?void 0:He.some(ye=>ye.id===X.localPlayerId);l.info(`[Auto-restore] Player ${X.localPlayerId} exists in restored state: ${ue}`)}X.localPlayerId!==null&&(s(X.localPlayerId),l.info(`[Auto-restore] Restored local player ID: ${X.localPlayerId}`))},0)),setTimeout(()=>{Ve.current=!1,l.info("[Auto-restore] Cleared restoration flag")},100),l.info("[Auto-restore] Guest session restoration initiated")}}catch(ce){l.error("[Auto-restore] Failed to restore session:",ce),at(),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),H.useEffect(()=>{if(!x||!K.current)return;const h=window.location.hash.slice(1);if(!h)return;const te=new URLSearchParams(h).get("hostId");te&&bt(te)},[x]),H.useEffect(()=>{d.current=n},[n]),H.useEffect(()=>{E.current=i},[i]),H.useEffect(()=>{if(!n||!n.players||!i)return;const h=Ps(n.players,i);Rs.preloadMany(h,"low")},[n==null?void 0:n.players,i]);const va=yi({ws:ge,webrtcManager:K,gameStateRef:d,localPlayerIdRef:E,webrtcIsHostRef:j,setLatestHighlight:_,setLatestFloatingTexts:u,setLatestNoTarget:T,setLatestDeckSelections:g,setLatestHandCardSelections:k,setClickWaves:O,setGameState:a}),{triggerHighlight:Ma,triggerFloatingText:Sr,triggerNoTarget:Na,triggerDeckSelection:La,triggerHandCardSelection:Ga,syncValidTargets:Ua,triggerClickWave:xa}=va,Ve=H.useRef(!1);H.useEffect(()=>{if(!x||!j.current||!(n!=null&&n.gameId))return;const h=n.gameId,ae=()=>{var le;const re=(le=K.current)==null?void 0:le.getPeerId();re&&h&&lr(re,h)};ae();const te=setInterval(ae,2e3);return()=>clearInterval(te)},[x,n==null?void 0:n.gameId]),H.useEffect(()=>{if(!x||j.current||!(n!=null&&n.gameId))return;const h=n.gameId,ae=le=>{var ne;J(le),A("Connecting"),(ne=K.current)==null||ne.initializeAsReconnectingGuest(le,E.current||0).then(()=>{A("Connected")}).catch(ce=>{l.error("[Guest Auto-Reconnect] Failed to reconnect:",ce),A("Disconnected")})},te=le=>{const ne=`webrtc_host_${h}`;if(!(le.key!==ne||!le.newValue))try{const X=JSON.parse(le.newValue).peerId;X&&X!==Z&&ae(X)}catch(ce){l.error("[Guest Auto-Reconnect] Failed to parse storage event:",ce)}},re=setInterval(()=>{const le=rr(h);le&&le.peerId!==Z&&(l.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${le.peerId}`),ae(le.peerId))},2e3);return window.addEventListener("storage",te),()=>{window.removeEventListener("storage",te),clearInterval(re)}},[x,n==null?void 0:n.gameId,Z]),H.useEffect(()=>{const h=setInterval(()=>{a(ae=>{const te=Date.now(),re=ae.floatingTexts||[],le=re.filter(ne=>te-ne.timestamp<ie.FLOATING_TEXT_DURATION);return le.length!==re.length?{...ae,floatingTexts:le}:ae})},ie.DECK_SYNC_DELAY);return()=>clearInterval(h)},[]);const $a=H.useCallback(h=>{var ae,te,re;switch(h.type){case"peer_open":(ae=h.data)!=null&&ae.peerId&&(J(h.data.peerId),l.info(`WebRTC peer opened with ID: ${h.data.peerId}`));break;case"guest_connected":l.info("Guest connected via WebRTC:",(te=h.data)==null?void 0:te.peerId);break;case"connected_to_host":(re=h.data)!=null&&re.hostPeerId&&Z!==h.data.hostPeerId&&(J(h.data.hostPeerId),l.info(`Updated webrtcHostId to: ${h.data.hostPeerId}`)),A("Connected"),Oe(!1),Ge(null),Me.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(l.warn("WebRTC peer disconnected"),A("Disconnected"),Oe(!0),!j.current&&Z&&n)try{const ne={hostPeerId:Z,playerId:i,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ne)),l.info("[Reconnection] Stored reconnection data before disconnect"),Wa(Z)}catch(ne){l.error("[Reconnection] Failed to store data:",ne)}break;case"message_received":const le=h.data.message||h.data;Fa(le);break;case"error":l.error("WebRTC error:",h.data);break}},[n,i,Z,de]),Ha=H.useCallback((h,ae)=>{if(l.info(`[handleWebrtcGuestJoin] Called for guest ${h}, isHost: ${j.current}`),!j.current||!K.current){l.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const te=(ae==null?void 0:ae.preferredDeck)||"Random";a(re=>{if(!re)return l.error("[handleWebrtcGuestJoin] No previous state"),re;l.info(`[handleWebrtcGuestJoin] Current state has ${re.players.length} players`);const le=re.players.map(ue=>ue.id);let ne=1;for(;le.includes(ne);)ne++;const ce={id:ne,name:`Player ${ne}`,color:_t[(ne-1)%_t.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:te,boardHistory:[],autoDrawEnabled:!0},X={...re,players:[...re.players,ce]},Te=re.board.map(ue=>ue.map(ye=>({...ye,card:ye.card?{id:ye.card.id,baseId:ye.card.baseId,ownerId:ye.card.ownerId,name:ye.card.name,imageUrl:ye.card.imageUrl,power:ye.card.power,ability:ye.card.ability,isFaceDown:ye.card.isFaceDown,statuses:ye.card.statuses||[]}:null}))),Se=ue=>ue.map(ye=>({id:ye.id,baseId:ye.baseId,name:ye.name,imageUrl:ye.imageUrl,power:ye.power,powerModifier:ye.powerModifier,ability:ye.ability,ownerId:ye.ownerId,color:ye.color,deck:ye.deck,isFaceDown:ye.isFaceDown,types:ye.types,faction:ye.faction,statuses:ye.statuses}));K.current.acceptGuestMinimal(h,{playerId:ne,gameId:re.gameId,isGameStarted:re.isGameStarted,players:X.players.map(ue=>ue.isDummy?{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,hand:Se(ue.hand||[]),deck:Se(ue.deck||[]),discard:Se(ue.discard||[]),handSize:ue.hand.length,deckSize:ue.deck.length,discardSize:ue.discard.length}:{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,deckSize:ue.deck.length,handSize:ue.hand.length,discardSize:ue.discard.length}),deckSelections:X.players.map(ue=>({id:ue.id,selectedDeck:ue.selectedDeck})),gameMode:re.gameMode,currentRound:re.currentRound,currentPhase:re.currentPhase,activePlayerId:re.activePlayerId,startingPlayerId:re.startingPlayerId,activeGridSize:re.activeGridSize,board:Te},ne),K.current.broadcastGameState(X,h),K.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:K.current.getPeerId(),data:{playerId:ne,selectedDeck:te},timestamp:Date.now()});const He=X.players.find(ue=>ue.id===E.current);if(He&&He.deck.length>0){const ue=He.deck.map(ye=>({id:ye.id,baseId:ye.baseId,power:ye.power,powerModifier:ye.powerModifier||0,isFaceDown:ye.isFaceDown||!1,statuses:ye.statuses||[]}));K.current.sendToGuest(h,{type:"CHANGE_PLAYER_DECK",senderId:K.current.getPeerId(),playerId:He.id,data:{playerId:He.id,deckType:He.selectedDeck,deck:ue,deckSize:ue.length},timestamp:Date.now()}),l.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${He.selectedDeck}, ${ue.length} cards`)}return X})},[]),br=H.useCallback(h=>{const ae=j.current;if(l.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!K.current}, webrtcIsHostRef.current=${ae}`),!K.current||!ae){l.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}K.current.broadcastGameState(h)},[]),Fa=H.useCallback(h=>{var ae,te,re,le,ne,ce,X,Te,Se,He,ue,ye,Dr,Rr,Pr,kr,Or,vr,Mr,Nr,Lr,Gr,Ur,xr,$r,Hr,Fr,Wr,Br,Yr,zr,Kr,qr,Vr,jr,Jr,Xr,Zr,Qr,en,tn,rn,nn,an,on,sn,dn,cn,ln,un,fn,pn,yn,hn,mn,En,In,Tn,gn,wn,_n,Sn,bn,An,Cn,Dn,Rn,Pn,kn,On,vn,Mn,Nn,Ln,Gn,Un,xn,$n,Hn,Fn,Wn,Bn;if(!(!h||!h.type))switch(l.info(`[handleWebrtcMessage] Received: ${h.type}`),h.type){case"JOIN_ACCEPT_MINIMAL":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${h.playerId}`),h.data){const b=h.data;l.info(`[handleWebrtcMessage] Creating minimal state with ${((ae=b.players)==null?void 0:ae.length)||0} players`);const v={gameId:b.gameId||Da(),isGameStarted:b.isGameStarted||!1,isPrivate:!1,activeGridSize:b.activeGridSize||4,gameMode:b.gameMode||pr.FreeForAll,dummyPlayerCount:0,players:((te=b.players)==null?void 0:te.map(N=>{if((N.isDummy||!1)&&N.hand&&N.deck&&N.discard)return{id:N.id,name:N.name,color:N.color,isDummy:!0,isReady:N.isReady||!1,score:N.score||0,hand:N.hand||[],deck:N.deck||[],discard:N.discard||[],announcedCard:null,selectedDeck:N.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const B=[],F=[],Y=[];for(let L=0;L<(N.handSize||0);L++)B.push({id:`placeholder_${N.id}_hand_${L}`,name:"?",isPlaceholder:!0,ownerId:N.id,deck:N.selectedDeck||"Random",color:N.color});for(let L=0;L<(N.deckSize||0);L++)F.push({id:`placeholder_${N.id}_deck_${L}`,name:"?",isPlaceholder:!0,ownerId:N.id,deck:N.selectedDeck||"Random",color:N.color});for(let L=0;L<(N.discardSize||0);L++)Y.push({id:`placeholder_${N.id}_discard_${L}`,name:"?",isPlaceholder:!0,ownerId:N.id,deck:N.selectedDeck||"Random",color:N.color});return{id:N.id,name:N.name,color:N.color,isDummy:!1,isReady:N.isReady||!1,score:N.score||0,hand:B,deck:F,discard:Y,announcedCard:null,selectedDeck:N.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:b.board||wa(),hostId:1,currentPhase:b.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:b.currentRound||1,turnNumber:b.turnNumber||1,activePlayerId:b.activePlayerId??null,startingPlayerId:b.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};a(v),h.playerId!==void 0&&(s(h.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${h.playerId}`)),a(N=>{const W=N.players.map(B=>{var Y;const F=(Y=b.players)==null?void 0:Y.find(L=>L.id===B.id);if(B.id===h.playerId){const z=B.deck.length===0||B.deck.some(V=>V.isPlaceholder)||B.deck.length!==30;if(F!=null&&F.selectedDeck&&z){const V=tt(F.selectedDeck,B.id,B.name);l.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${V.length} cards from ${F.selectedDeck}`),K.current&&V.length>0&&setTimeout(()=>{const se=V.map(Q=>({id:Q.id,baseId:Q.baseId,power:Q.power,powerModifier:Q.powerModifier||0,isFaceDown:Q.isFaceDown||!1,statuses:Q.statuses||[]}));K.current.sendAction("DECK_DATA_UPDATE",{playerId:h.playerId,deck:se,deckSize:se.length}),l.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${F.selectedDeck}, ${se.length} cards`)},0);const ee=[...B.hand],oe=[...V];if(b.isGameStarted&&ee.length===0&&oe.length>0){for(let Q=0;Q<6&&Q<oe.length;Q++){const Ie=oe[0];oe.splice(0,1),ee.push(Ie)}l.info(`[JOIN_ACCEPT_MINIMAL] Drew ${ee.length} cards, deck now has ${oe.length} cards`)}return{...B,deck:oe,hand:ee,selectedDeck:F.selectedDeck}}}return B});return{...N,players:W}});try{const N=(re=K.current)==null?void 0:re.getHostPeerId();N&&tr({hostPeerId:N,playerId:h.playerId,playerName:((le=v.players.find(W=>W.id===h.playerId))==null?void 0:le.name)||null,isHost:!1})}catch(N){l.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",N)}}break;case"JOIN_ACCEPT":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${h.playerId}, hasState: ${!!((ne=h.data)!=null&&ne.gameState)}`),(ce=h.data)!=null&&ce.gameState){const b=h.data.gameState;if(l.info(`[handleWebrtcMessage] Setting game state with ${((X=b.players)==null?void 0:X.length)||0} players`),a(b),h.playerId!==void 0){s(h.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${h.playerId}`);try{const v=(Te=K.current)==null?void 0:Te.getHostPeerId(),N=b.players.find(W=>W.id===h.playerId);v&&tr({hostPeerId:v,playerId:h.playerId,playerName:(N==null?void 0:N.name)||null,isHost:!1})}catch(v){l.warn("[JOIN_ACCEPT] Failed to save guest data:",v)}}}break;case"JOIN_ACCEPT_BINARY":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${h.playerId}`),h.data instanceof Uint8Array)try{const b=qs(h.data),v=b;if(l.info(`[handleWebrtcMessage] Expanded binary state with ${((Se=v.players)==null?void 0:Se.length)||0} players`),a(v),h.playerId!==void 0){s(h.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${h.playerId}`);try{const N=(He=K.current)==null?void 0:He.getHostPeerId(),W=v.players.find(B=>B.id===h.playerId);N&&tr({hostPeerId:N,playerId:h.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(N){l.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",N)}}l.info(`[handleWebrtcMessage] Received optimized binary game state: ${h.data.byteLength} bytes`)}catch(b){l.error("[handleWebrtcMessage] Failed to deserialize binary game state:",b)}break;case"STATE_UPDATE_COMPACT":let Ue=(ue=h.data)==null?void 0:ue.gameState;if(((ye=h.data)==null?void 0:ye._format)==="msgpack"&&typeof Ue=="string")try{Ue=ra(Ue),l.info("[STATE_UPDATE_COMPACT] Decoded MessagePack format")}catch(b){l.error("[STATE_UPDATE_COMPACT] Failed to decode MessagePack:",b);break}if(j.current){if(h.senderId&&h.senderId!==((Dr=K.current)==null?void 0:Dr.getPeerId())&&(l.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${h.senderId}`),Ue)){const b=Ue;a(v=>{const N=h.playerId;if(N===void 0)return l.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),v;const W=v.players.map(Y=>{if(Y.id===N){const L=b.players.find(z=>z.id===N);if(L){const z=se=>{const Q=Be(se.baseId);return Q?{...Q,id:se.id,baseId:se.baseId,ownerId:N,power:se.power,powerModifier:se.powerModifier,isFaceDown:se.isFaceDown,statuses:se.statuses||[]}:{id:se.id,baseId:se.baseId,name:"Unknown",power:0}},V=(L.handCards||[]).map(z),ee=(L.deckCards||[]).map(z),oe=(L.discardCards||[]).map(z);return l.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${N}: hand=${V.length}, deck=${ee.length}, discard=${oe.length}, score=${L.score||0}`),{...Y,hand:V,deck:ee,discard:oe,handSize:V.length,deckSize:ee.length,discardSize:oe.length,score:L.score||Y.score}}}else{const L=b.players.find(V=>V.id===Y.id);if(!L)return Y;if(Y.isDummy===!0&&(L.handCards&&L.handCards.length>0||L.deckCards&&L.deckCards.length>0||L.discardCards&&L.discardCards.length>0)){const V=Q=>{const Ie=Be(Q.baseId);return Ie?{...Ie,id:Q.id,baseId:Q.baseId,ownerId:Y.id,power:Q.power,powerModifier:Q.powerModifier||0,isFaceDown:Q.isFaceDown||!1,statuses:Q.statuses||[]}:{id:Q.id,baseId:Q.baseId,name:"Unknown",power:0}},ee=(L.handCards||[]).map(V),oe=(L.deckCards||[]).map(V),se=(L.discardCards||[]).map(V);return l.info(`[STATE_UPDATE_COMPACT] Host: Guest ${N} modified dummy player ${Y.id}: hand=${ee.length}, deck=${oe.length}, discard=${se.length}`),{...Y,hand:ee,deck:oe,discard:se,handSize:ee.length,deckSize:oe.length,discardSize:se.length}}else if(L.handCards&&L.handCards.length>0&&Y.hand){const V=L.handCards||[],ee=Y.hand.map(oe=>{const se=V.find(Q=>Q.id===oe.id);return se&&se.statuses?{...oe,statuses:se.statuses,isFaceDown:se.isFaceDown}:oe});return{...Y,hand:ee,handSize:ee.length}}}return Y}),B=b.board?b.board.map(Y=>Y.map(L=>{if(!L||!L.card)return L;const z=Be(L.card.baseId||L.card.id);if(z){const V=L.card.ownerId;return{...L,card:{...z,id:L.card.id,baseId:L.card.baseId||L.card.id,ownerId:V,ownerName:L.card.ownerName,power:L.card.power,powerModifier:L.card.powerModifier,isFaceDown:L.card.isFaceDown||!1,statuses:L.card.statuses||[],enteredThisTurn:L.card.enteredThisTurn,deck:L.card.deck}}}return L})):v.board,F={...v,...b,players:W,board:B};return F.activePlayerId!==void 0&&xt(F),K.current&&setTimeout(()=>{K.current.broadcastGameState(F,h.senderId)},0),F})}}else if(!j.current&&((Rr=h.data)!=null&&Rr.gameState)){const b=h.data.recipientPlayerId??null;if(l.info(`[STATE_UPDATE_COMPACT] Received compact state for player ${b}, currentPhase=${Ue.currentPhase}, activePlayerId=${Ue.activePlayerId}`),Me.current){a(v=>(l.info(`[STATE_UPDATE_COMPACT] Skipping - recently restored from localStorage, updating phase from ${v.currentPhase} to ${Ue.currentPhase}`),{...v,currentPhase:Ue.currentPhase,activePlayerId:Ue.activePlayerId,startingPlayerId:Ue.startingPlayerId,isReadyCheckActive:Ue.isReadyCheckActive,isGameStarted:Ue.isGameStarted}));return}a(v=>{const N=b===null||b===E.current;l.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${b}, local=${E.current}, isForLocal=${N}`);const W=Ue.players.map(L=>{var V,ee;const z=v.players.find(oe=>oe.id===L.id);if(L.id===E.current&&z){const oe=Q=>{if(Q.baseId){const be=Be(Q.baseId);if(be)return{...be,id:Q.id,ownerId:E.current,power:Q.power,powerModifier:Q.powerModifier,isFaceDown:Q.isFaceDown,statuses:Q.statuses||[]}}return z.hand.find(be=>be.id===Q.id)||z.deck.find(be=>be.id===Q.id)||z.discard.find(be=>be.id===Q.id)||{id:Q.id,name:"Unknown",power:0}};if(L.handCards&&L.handCards.length>0||L.deckCards&&L.deckCards.length>0||L.discardCards&&L.discardCards.length>0){const Q=(L.handCards||[]).map(oe),Ie=(L.deckCards||[]).map(oe),be=(L.discardCards||[]).map(oe);return Q.forEach((me,$e)=>{var we,Ee;(Ee=(we=L.handCards)==null?void 0:we[$e])!=null&&Ee.baseId&&!me.baseId&&(me.baseId=L.handCards[$e].baseId)}),Ie.forEach((me,$e)=>{var we,Ee;(Ee=(we=L.deckCards)==null?void 0:we[$e])!=null&&Ee.baseId&&!me.baseId&&(me.baseId=L.deckCards[$e].baseId)}),be.forEach((me,$e)=>{var we,Ee;(Ee=(we=L.discardCards)==null?void 0:we[$e])!=null&&Ee.baseId&&!me.baseId&&(me.baseId=L.discardCards[$e].baseId)}),l.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${Q.length} hand, ${Ie.length} deck, ${be.length} discard`),{...L,hand:Q,deck:Ie,discard:be}}else{const Q=(L.handIds||[]).map(me=>z.hand.find(we=>we.id===me)||z.deck.find(we=>we.id===me)||z.discard.find(we=>we.id===me)||{id:me,name:"?",isPlaceholder:!1}),Ie=(L.deckIds||[]).map(me=>z.deck.find(we=>we.id===me)||z.hand.find(we=>we.id===me)||z.discard.find(we=>we.id===me)||{id:me,name:"?",isPlaceholder:!1}),be=(L.discardIds||[]).map(me=>z.discard.find(we=>we.id===me)||z.hand.find(we=>we.id===me)||z.deck.find(we=>we.id===me)||{id:me,name:"?",isPlaceholder:!1});return l.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${Q.length} hand, ${Ie.length} deck, ${be.length} discard`),{...L,hand:Q,deck:Ie,discard:be}}}else{const oe=L.deckSize??((V=L.deck)==null?void 0:V.length)??0,se=L.handSize??((ee=L.hand)==null?void 0:ee.length)??0,Q=L.deckCards&&L.deckCards.length>0;let Ie;if(Q){const Ee=L.deckCards[0];if((Ee==null?void 0:Ee.name)&&(Ee==null?void 0:Ee.imageUrl))Ie=L.deckCards.map(Ae=>({id:Ae.id,baseId:Ae.baseId||Ae.id,name:Ae.name,imageUrl:Ae.imageUrl,fallbackImage:Ae.fallbackImage||"",power:Ae.power,powerModifier:Ae.powerModifier||0,isFaceDown:Ae.isFaceDown??!1,statuses:Ae.statuses||[],deck:Ae.deck||"SynchroTech",color:Ae.color||"Red",ability:Ae.ability||"",bonusPower:Ae.bonusPower||0,isPlaceholder:Ae.isPlaceholder||!1,types:Ae.types||[],faction:Ae.faction||"",ownerId:L.id})),l.debug(`[STATE_UPDATE_COMPACT] Using full deck data for player ${L.id}: ${Ie.length} cards`);else{const Ae=Ke=>{if(Ke.baseId){const At=Be(Ke.baseId);if(At)return{...At,id:Ke.id,baseId:Ke.baseId,ownerId:L.id,power:Ke.power,powerModifier:Ke.powerModifier,isFaceDown:Ke.isFaceDown,statuses:Ke.statuses||[]}}return{id:Ke.id,name:"Unknown",power:0}};if(Ie=L.deckCards.map(Ae),L.id===3){const Ke={};Ie.forEach(At=>{const Kn=At.baseId||At.id;Ke[Kn]=(Ke[Kn]||0)+1}),l.info(`[STATE_UPDATE_COMPACT] Reconstructed deck for Player 3 (dummy): ${Ie.length} cards`,Ke)}l.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${L.id}: ${Ie.length} cards`)}}else if(z&&z.deck.length>0&&z.deck.some(Pe=>!Pe.isPlaceholder)){const Pe=z.deck.length;Ie=z.deck.slice(0,oe),L.id===3&&l.info(`[STATE_UPDATE_COMPACT] Player 3 deck slice: before=${Pe}, remoteDeckSize=${oe}, after=${Ie.length}`),l.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${L.id}: ${Ie.length} cards`)}else{Ie=[];for(let Pe=0;Pe<oe;Pe++)Ie.push({id:`placeholder_${L.id}_deck_${Pe}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color})}const be=(Ee,Pe)=>{if(Ee.baseId&&!Ee.isPlaceholder&&!Ee.isCardBack){const Ae=Be(Ee.baseId);if(Ae)return{...Ae,id:Ee.id,baseId:Ee.baseId,ownerId:L.id,power:Ee.power,powerModifier:Ee.powerModifier||0,isFaceDown:Ee.isFaceDown||!1,statuses:Ee.statuses||[]}}return{id:Ee.id||`placeholder_${L.id}_hand_${Pe}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color}};let me;const $e=L.handCards&&L.handCards.length>0,we=L.hand&&L.hand.length>0;if($e)me=L.handCards.map(Pe=>{const Ae=Be(Pe.baseId);return Ae?{...Ae,id:Pe.id,baseId:Pe.baseId,ownerId:L.id,power:Pe.power,powerModifier:Pe.powerModifier||0,isFaceDown:Pe.isFaceDown||!1,statuses:Pe.statuses||[]}:{id:Pe.id,baseId:Pe.baseId,name:"Unknown",power:Pe.power||0,ownerId:L.id,isPlaceholder:!1}}),l.info(`[STATE_UPDATE_COMPACT] Reconstructed ${me.length} hand cards from handCards for player ${L.id}`);else if(we){me=L.hand.map((Pe,Ae)=>be(Pe,Ae));const Ee=me.filter(Pe=>!Pe.isPlaceholder).length;Ee>0&&l.info(`[STATE_UPDATE_COMPACT] Reconstructed ${Ee}/${me.length} revealed hand cards for player ${L.id}`)}else{me=[];for(let Ee=0;Ee<se;Ee++)me.push({id:`placeholder_${L.id}_hand_${Ee}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color})}return{...L,hand:me,deck:Ie,discard:(z==null?void 0:z.discard)||[]}}}),B=Ue.board?Ue.board.map(L=>L.map(z=>{if(!z||!z.card)return z;const V=Be(z.card.baseId||z.card.id);return V?{...z,card:{...V,id:z.card.id,baseId:z.card.baseId||z.card.id,ownerId:z.card.ownerId,ownerName:z.card.ownerName,power:z.card.power,powerModifier:z.card.powerModifier,isFaceDown:z.card.isFaceDown||!1,statuses:z.card.statuses||[],enteredThisTurn:z.card.enteredThisTurn,deck:z.card.deck}}:z})):v.board,F=Le({...Ue,players:W,board:B}),Y={...Ue,players:W,board:F};return l.info(`[STATE_UPDATE_COMPACT] Merged state: currentPhase=${Y.currentPhase}, activePlayerId=${Y.activePlayerId}, startingPlayerId=${Y.startingPlayerId}`),Y.activePlayerId!==void 0&&xt(Y),Y})}break;case"STATE_UPDATE":if(j.current&&h.senderId&&h.senderId!==((Pr=K.current)==null?void 0:Pr.getPeerId())){if(l.info(`[STATE_UPDATE] Host received state from guest ${h.senderId}`),(kr=h.data)!=null&&kr.gameState){const b=h.data.gameState;a(v=>{const N=h.playerId;if(N===void 0)return l.warn("[STATE_UPDATE] Guest state missing playerId"),v;const W=v.players.map(Y=>{if(Y.id===N){const L=b.players.find(z=>z.id===N);if(L){const z=Q=>({...Q,ownerId:N}),V=(L.hand||[]).map(z),ee=(L.deck||[]).map(z),oe=(L.discard||[]).map(z);l.info(`[STATE_UPDATE] Merging guest ${N} state: hand=${V.length}, deck=${ee.length}, discard=${oe.length}`);const se={...Y,hand:V,deck:ee,discard:oe,handSize:V.length,deckSize:ee.length,discardSize:oe.length};return l.info(`[STATE_UPDATE] After merge - player ${N}: deckSize=${se.deckSize}, handSize=${se.handSize}`),se}}return Y}),B=b.board?b.board.map(Y=>Y.map(L=>!L||!L.card?L:{...L,card:{...L.card,ownerId:L.card.ownerId}})):v.board,F={...v,players:W,board:B};return K.current&&setTimeout(()=>{K.current.broadcastGameState(F,h.senderId)},0),F})}break}if(je.current=!0,(Or=h.data)!=null&&Or.gameState){const b=h.data.gameState;if(Me.current){a(v=>({...v,currentPhase:b.currentPhase,activePlayerId:b.activePlayerId,startingPlayerId:b.startingPlayerId,isReadyCheckActive:b.isReadyCheckActive,isGameStarted:b.isGameStarted}));return}a(v=>{var B;const N=b.players.map(F=>{var L,z,V;const Y=v.players.find(ee=>ee.id===F.id);if(F.id===E.current&&Y){const ee=Y.hand.every(se=>se.isPlaceholder)||Y.hand.length===0,oe=F.handSize??((L=F.hand)==null?void 0:L.length)??0;if(ee&&F.hand&&F.hand.length>0)return{...F,hand:F.hand,deck:F.deck||Y.deck,discard:F.discard||Y.discard};{let se=Y.hand,Q=Y.deck;if(oe>Y.hand.length&&Q.length>0){const Ie=oe-Y.hand.length,be=[...Y.hand],me=[...Y.deck];for(let $e=0;$e<Ie&&$e<me.length;$e++){const we=me[0];me.splice(0,1),be.push(we)}se=be,Q=me}return{...F,hand:se,deck:Q,discard:F.discard||Y.discard}}}else{if(F.isDummy||!1)return l.info(`[STATE_UPDATE] Using real cards for dummy player ${F.id}`),{...F,hand:F.hand||[],deck:F.deck||[],discard:F.discard||[]};const oe=F.deckSize??((z=F.deck)==null?void 0:z.length)??0,se=F.handSize??((V=F.hand)==null?void 0:V.length)??0;l.info(`[STATE_UPDATE] Player ${F.id}: deckSize=${oe}, handSize=${se}`);const Q=[];for(let be=0;be<oe;be++)Q.push({id:`placeholder_${F.id}_deck_${be}`,name:"?",isPlaceholder:!0,ownerId:F.id,deck:F.selectedDeck||"Random",color:F.color});const Ie=[];for(let be=0;be<se;be++)Ie.push({id:`placeholder_${F.id}_hand_${be}`,name:"?",isPlaceholder:!0,ownerId:F.id,deck:F.selectedDeck||"Random",color:F.color});return l.info(`[STATE_UPDATE] Created ${Q.length} deck placeholders and ${Ie.length} hand placeholders for player ${F.id}`),{...F,hand:Ie,deck:Q,discard:F.discard||[]}}}),W={...b,players:N};if(!j.current)try{((B=K.current)==null?void 0:B.getHostPeerId())&&E.current!==null&&(Ct({gameState:W,localPlayerId:E.current,isHost:!1}),l.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(F){l.warn("[STATE_UPDATE] Failed to persist guest state:",F)}return W})}break;case"RECONNECT_SNAPSHOT":je.current=!0;let Ne=h.data;if(((vr=h.data)==null?void 0:vr._format)==="msgpack"&&typeof h.data=="object")try{Ne=ra(h.data.data||h.data),l.info("[RECONNECT_SNAPSHOT] Decoded MessagePack format")}catch(b){l.error("[RECONNECT_SNAPSHOT] Failed to decode MessagePack:",b),Ne=h.data}Ne&&a(b=>{const v=E.current,N=Ne.players.map(B=>{const F=b.players.find(V=>V.id===B.id);if(B.id===v&&F&&F.hand.some(ee=>!ee.isPlaceholder)){let ee=[...F.hand];const oe=[...F.deck];if(B.handSize>ee.length){const se=B.handSize-ee.length;for(let Q=0;Q<se&&oe.length>0;Q++)ee.push(oe.shift())}else B.handSize<ee.length&&(ee=ee.slice(0,B.handSize));return{...B,hand:ee,deck:oe,discard:F.discard}}const Y=[];for(let V=0;V<B.handSize;V++)Y.push({id:`placeholder_${B.id}_hand_${V}`,name:"?",isPlaceholder:!0,ownerId:B.id,deck:B.selectedDeck||"Random",color:B.color});const L=[];for(let V=0;V<B.deckSize;V++)L.push({id:`placeholder_${B.id}_deck_${V}`,name:"?",isPlaceholder:!0,ownerId:B.id,deck:B.selectedDeck||"Random",color:B.color});const z=[];for(let V=0;V<B.discardSize;V++)z.push({id:`placeholder_${B.id}_discard_${V}`,name:"?",isPlaceholder:!0,ownerId:B.id,deck:B.selectedDeck||"Random",color:B.color});return{...B,hand:Y,deck:L,discard:z}}),W={gameId:Ne.gameId,gameMode:Ne.gameMode,isPrivate:Ne.isPrivate,isGameStarted:Ne.isGameStarted,isReadyCheckActive:Ne.isReadyCheckActive,activeGridSize:Ne.activeGridSize,currentPhase:Ne.currentPhase,isScoringStep:Ne.isScoringStep,activePlayerId:Ne.activePlayerId,startingPlayerId:Ne.startingPlayerId,currentRound:Ne.currentRound,turnNumber:Ne.turnNumber,roundWinners:Ne.roundWinners||{},gameWinner:Ne.gameWinner,isRoundEndModalOpen:Ne.isRoundEndModalOpen,dummyPlayerCount:Ne.dummyPlayerCount,players:N,board:Ne.board,spectators:b.spectators,hostId:b.hostId,revealRequests:b.revealRequests,preserveDeployAbilities:b.preserveDeployAbilities,highlights:b.highlights,floatingTexts:b.floatingTexts,targetingMode:b.targetingMode,abilityMode:b.abilityMode};if(!j.current&&v!==null)try{Ct({gameState:W,localPlayerId:v,isHost:!1}),l.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(B){l.warn("[RECONNECT_SNAPSHOT] Failed to save state:",B)}return l.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${W.currentPhase}, players=${W.players.length}`),W});break;case"STATE_DELTA":if(j.current||(je.current=!0),l.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${j.current}, senderId: ${h.senderId}`),(Mr=h.data)!=null&&Mr.delta){const b=h.data.delta;l.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(b.playerDeltas||{}).length}, boardCells=${((Nr=b.boardCells)==null?void 0:Nr.length)||0}, phaseDelta=${!!b.phaseDelta}`),b.boardCells&&b.boardCells.length>0&&b.boardCells.forEach(v=>{var N,W;l.info(`[STATE_DELTA] Board cell [${v.row},${v.col}]: card=${((N=v.card)==null?void 0:N.name)||"(empty)"}, owner=${(W=v.card)==null?void 0:W.ownerId}`)}),j.current&&h.senderId&&K.current&&(l.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${h.senderId} to other guests`),K.current.broadcastStateDelta(b,h.senderId)),b.phaseDelta&&l.info("[STATE_DELTA] phaseDelta:",JSON.stringify(b.phaseDelta)),b.playerDeltas&&Object.entries(b.playerDeltas).forEach(([v,N])=>{l.info(`[STATE_DELTA] Player ${v} delta: handSizeDelta=${N.handSizeDelta}, deckSizeDelta=${N.deckSizeDelta}`)}),a(v=>{const N=E.current||v.localPlayerId;l.info(`[STATE_DELTA] Applying delta with localPlayerId=${N}, currentPhase before=${v.currentPhase}`);const W=sr(v);l.info(`[STATE_DELTA] Applying delta with localPlayerId=${N}, currentPhase after=${W.currentPhase}`);try{W.gameId&&N!==null&&(Ct({gameState:W,localPlayerId:N,isHost:j.current}),l.debug(`[STATE_DELTA] Saved state for ${j.current?"host":"guest"} auto-restore`))}catch(B){l.warn("[STATE_DELTA] Failed to persist state:",B)}return W})}break;case"STATE_DELTA_BINARY":{j.current||(je.current=!0),l.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${j.current}, senderId: ${h.senderId}, dataType=${(Gr=(Lr=h.data)==null?void 0:Lr.constructor)==null?void 0:Gr.name}, typeof=${typeof h.data}`);let b=null;if(h.data instanceof Uint8Array)try{b=Sa(h.data),b&&l.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(b.playerDeltas||{}).length}, boardCells=${((Ur=b.boardCells)==null?void 0:Ur.length)||0}`)}catch(v){l.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",v)}else if(typeof h.data=="string")try{b=js(h.data),b&&l.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${h.data.length} chars): playerDeltas=${Object.keys(b.playerDeltas||{}).length}, boardCells=${((xr=b.boardCells)==null?void 0:xr.length)||0}, phaseDelta=${!!b.phaseDelta}`)}catch(v){l.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",v)}else l.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof h.data}, constructor: ${(Hr=($r=h.data)==null?void 0:$r.constructor)==null?void 0:Hr.name}`);b&&(j.current&&h.senderId&&K.current&&(l.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${h.senderId} to other guests`),K.current.broadcastStateDelta(b,h.senderId)),a(v=>{const N=E.current||v.localPlayerId;l.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${N}, currentPhase before=${v.currentPhase}`);const W=sr(v);l.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${W.currentPhase}, board has ${W.board.flat().filter(B=>B==null?void 0:B.card).length} cards`);try{W.gameId&&N!==null&&(Ct({gameState:W,localPlayerId:N,isHost:j.current}),l.debug(`[STATE_DELTA_BINARY] Saved state for ${j.current?"host":"guest"} auto-restore`))}catch(B){l.warn("[STATE_DELTA_BINARY] Failed to persist state:",B)}return W}));break}case"CARD_STATE":if(typeof h.data=="string")try{const b=atob(h.data),v=new Uint8Array(b.length);for(let N=0;N<b.length;N++)v[N]=b.charCodeAt(N);a(N=>It(2,v,N,E.current||N.localPlayerId).gameState)}catch(b){l.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",b)}else h.data instanceof Uint8Array&&a(b=>It(2,h.data,b,E.current||b.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof h.data=="string")try{const b=atob(h.data),v=new Uint8Array(b.length);for(let N=0;N<b.length;N++)v[N]=b.charCodeAt(N);a(N=>{const{gameState:W}=It(3,v,N,E.current||N.localPlayerId);return W})}catch(b){l.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",b)}else h.data instanceof Uint8Array&&a(b=>{const{gameState:v}=It(3,h.data,b,E.current||b.localPlayerId);return v});break;case"SESSION_EVENT":if(typeof h.data=="string")try{const b=atob(h.data),v=new Uint8Array(b.length);for(let N=0;N<b.length;N++)v[N]=b.charCodeAt(N);a(N=>It(4,v,N,E.current||N.localPlayerId).gameState)}catch(b){l.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",b)}else h.data instanceof Uint8Array&&a(b=>It(4,h.data,b,E.current||b.localPlayerId).gameState);break;case"JOIN_REQUEST":l.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${h.senderId}, isHost: ${j.current}`),j.current&&h.senderId?(l.info(`Host received JOIN_REQUEST from ${h.senderId}, data:`,h.data),Ha(h.senderId,h.data)):l.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${j.current}, senderId: ${h.senderId}`);break;case"ACTION":if(j.current&&h.data){const{actionType:b,actionData:v}=h.data;if(b==="STATE_UPDATE"&&(v!=null&&v.gameState)){if(Me.current){K.current&&h.senderId&&K.current.sendToGuest(h.senderId,{type:"STATE_UPDATE",senderId:K.current.getPeerId(),data:{gameState:d.current},timestamp:Date.now()});break}a(N=>{const W=v.gameState,B=W.players.map(Y=>{const L=N.players.find(z=>z.id===Y.id);return L&&Y.id!==E.current?{...Y,deck:L.deck||Y.deck,discard:L.discard||Y.discard,score:L.score}:Y}),F={...W,players:B};return K.current&&K.current.broadcastToGuests({type:"STATE_UPDATE",senderId:K.current.getPeerId(),data:{gameState:F},timestamp:Date.now()}),F})}else if(b==="STATE_DELTA"&&(v!=null&&v.delta))a(N=>{const W=v.delta;let B=W;Me.current&&W.playerDeltas&&(B={...W,playerDeltas:Object.fromEntries(Object.entries(W.playerDeltas).map(([Y,L])=>{const z={...L};return delete z.scoreDelta,[Y,z]}))}),E.current||N.localPlayerId;const F=sr(N);return K.current&&K.current.broadcastStateDelta(B),F});else if(b==="NEXT_PHASE")a(N=>{const W=N,B=W.currentPhase,F=B===2&&!W.isScoringStep,Y=B+1;return{...W,currentPhase:Y,...F&&{isScoringStep:!0}}});else if(b==="PREV_PHASE")a(N=>{const W=N;return W.isScoringStep?{...W,isScoringStep:!1,currentPhase:Math.max(1,W.currentPhase-1)}:{...W,currentPhase:Math.max(1,W.currentPhase-1)}});else if(b==="SET_PHASE"&&(v==null?void 0:v.phaseIndex)!==void 0)a(N=>({...N,currentPhase:v.phaseIndex}));else if(b==="UPDATE_PLAYER_NAME"&&(v==null?void 0:v.playerId)!==void 0&&(v==null?void 0:v.name)!==void 0)a(N=>({...N,players:N.players.map(W=>W.id===v.playerId?{...W,name:v.name}:W)}));else if(b==="CHANGE_PLAYER_COLOR"&&(v==null?void 0:v.playerId)!==void 0&&(v==null?void 0:v.color)!==void 0){const N=v.playerId,W=v.color;a(B=>{const F={...B,players:B.players.map(Y=>Y.id===N?{...Y,color:W}:Y)};return K.current&&K.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:K.current.getPeerId(),data:{playerId:N,color:W},timestamp:Date.now()}),F})}else if(b==="UPDATE_PLAYER_SCORE"&&(v==null?void 0:v.playerId)!==void 0&&(v==null?void 0:v.delta)!==void 0){const N=v.playerId,W=v.delta;a(B=>{const F={...B,players:B.players.map(Y=>Y.id===N?{...Y,score:Math.max(0,Y.score+W)}:Y)};return K.current&&K.current.broadcastToGuests({type:"UPDATE_PLAYER_SCORE",senderId:K.current.getPeerId(),data:{playerId:N,delta:W},timestamp:Date.now()}),F})}else if(b==="CHANGE_PLAYER_DECK"&&(v==null?void 0:v.playerId)!==void 0){const N=v.playerId,W=v.deckType,B=v.deck;a(F=>{const Y=F.players.find(V=>V.id===N);if(!Y)return F;let L;B&&B.length>0?(l.info(`[CHANGE_PLAYER_DECK] Host received ${B.length} cards for player ${N}`),L=B.map(V=>{if(V.baseId){const ee=Be(V.baseId);if(ee)return{...ee,id:V.id,baseId:V.baseId,deck:W,ownerId:N,ownerName:Y.name,power:V.power,powerModifier:V.powerModifier||0,isFaceDown:V.isFaceDown||!1,statuses:V.statuses||[]}}return{id:V.id,baseId:V.id,name:"Unknown",deck:W,ownerId:N,ownerName:Y.name,power:V.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(L=tt(W,N,Y.name),l.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${N} with ${L.length} cards from ${W}`));const z={...F,players:F.players.map(V=>V.id===N?{...V,selectedDeck:W,deck:L,hand:[],discard:[],announcedCard:null,boardHistory:[]}:V)};if(K.current){const V=L.map(ee=>({id:ee.id,baseId:ee.baseId,power:ee.power,powerModifier:ee.powerModifier||0,isFaceDown:ee.isFaceDown||!1,statuses:ee.statuses||[]}));K.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:K.current.getPeerId(),playerId:N,data:{playerId:N,deckType:W,deck:V,deckSize:V.length},timestamp:Date.now()})}return z})}else if(b==="TOGGLE_ACTIVE_PLAYER"&&(v==null?void 0:v.playerId)!==void 0)a(N=>{if(!N.players.find(F=>F.id===v.playerId))return N;const B=Aa(N,v.playerId);return K.current&&K.current.broadcastGameState(B),B});else if(b==="TOGGLE_AUTO_DRAW"&&(v==null?void 0:v.playerId)!==void 0)a(N=>({...N,players:N.players.map(W=>W.id===v.playerId?{...W,autoDrawEnabled:!W.autoDrawEnabled}:W)}));else if(b==="START_NEXT_ROUND")a(N=>({...N,isRoundEndModalOpen:!1,currentRound:(N.currentRound||1)+1,players:N.players.map(W=>({...W,score:0}))}));else if(b==="RESET_DEPLOY_STATUS")a(N=>{const W=N.board.map(B=>B.map(F=>{var Y;return(Y=F.card)!=null&&Y.statuses?{...F,card:{...F.card,statuses:F.card.statuses.filter(L=>L.type!=="DeployAbilityUsed")}}:F}));return{...N,board:W,preserveDeployAbilities:!1}});else if(b==="DECK_DATA_UPDATE"&&(v==null?void 0:v.playerId)!==void 0&&(v!=null&&v.deck)){const N=v.playerId,W=v.deck,B=v.deckSize;l.info(`[ACTION] DECK_DATA_UPDATE: Received ${W.length} cards for guest ${N}`),a(F=>({...F,players:F.players.map(Y=>Y.id===N?{...Y,deck:[...W],deckSize:B||W.length}:Y)}))}else l.warn(`[ACTION] Unknown action type: ${b}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(l.info(`[PLAYER_RECONNECT] Guest ${h.playerId} reconnecting from ${h.senderId}`),j.current&&h.playerId!==void 0&&h.senderId){const b=d.current;if(l.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(b!=null&&b.gameId)}, gameId=${b==null?void 0:b.gameId}, hasPlayers=${((Fr=b==null?void 0:b.players)==null?void 0:Fr.length)||0}`),b&&b.gameId){l.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${h.playerId}`);const v=di(b,h.playerId);(Wr=K.current)==null||Wr.sendToGuest(h.senderId,{type:"RECONNECT_SNAPSHOT",senderId:K.current.getPeerId(),data:v.data,timestamp:Date.now()}),l.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${h.playerId}`)}else l.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((Br=h.data)==null?void 0:Br.isReadyCheckActive)!==void 0||((Yr=h.data)==null?void 0:Yr.isPrivate)!==void 0)&&a(b=>({...b,isReadyCheckActive:h.data.isReadyCheckActive??!0,isPrivate:h.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((zr=h.data)==null?void 0:zr.isReadyCheckActive)!==void 0&&a(b=>({...b,isReadyCheckActive:h.data.isReadyCheckActive}));break;case"PLAYER_READY":j.current&&h.playerId!==void 0?a(b=>{const v=b.players.map(F=>F.id===h.playerId?{...F,isReady:!0}:F),N={...b,players:v};l.info(`Player ${h.playerId} is ready via WebRTC`),K.current&&(K.current.broadcastGameState(N),l.info(`[PLAYER_READY] Broadcasted ready status for player ${h.playerId}`));const W=N.players.filter(F=>!F.isDummy&&!F.isDisconnected);if(W.length>0&&W.every(F=>F.isReady)&&!N.isGameStarted){const F=N.players.filter(V=>!V.isDisconnected),Y=Math.floor(Math.random()*F.length),L=F[Y].id;let z={...N};return z.isReadyCheckActive=!1,z.isGameStarted=!0,z.startingPlayerId=L,z.activePlayerId=L,z.currentPhase=0,z.players=z.players.map(V=>{if(V.hand.length===0&&V.deck.length>0){const oe=[...V.hand],se=[...V.deck];for(let Q=0;Q<6&&Q<se.length;Q++){const Ie=se[0];se.splice(0,1),oe.push(Ie)}return l.info(`[PLAYER_READY] Drew ${oe.length} cards for player ${V.id}`),{...V,hand:oe,deck:se}}return V}),z=Er(z,L),l.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${z.currentPhase}`),K.current&&(K.current.broadcastToGuests({type:"GAME_START",senderId:K.current.getPeerId(),data:{startingPlayerId:L,activePlayerId:L,currentPhase:z.currentPhase,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{l.info(`[PLAYER_READY] Sending ACTIVE_PLAYER_CHANGED after game start: activePlayerId=${L}, currentPhase=${z.currentPhase}`),K.current&&K.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:K.current.getPeerId(),data:{activePlayerId:z.activePlayerId,currentPhase:z.currentPhase,turnNumber:z.turnNumber},timestamp:Date.now()})},100)),z}return N}):j.current;break;case"ASSIGN_TEAMS":(Kr=h.data)!=null&&Kr.assignments&&a(b=>{const v=b.players.map(N=>{let W=N.teamId||1;for(const[B,F]of Object.entries(h.data.assignments))if(F.includes(N.id)){W=parseInt(B);break}return{...N,teamId:W}});return{...b,players:v}});break;case"SET_GAME_MODE":((qr=h.data)==null?void 0:qr.mode)!==void 0&&a(b=>({...b,gameMode:h.data.mode}));break;case"SET_GAME_PRIVACY":((Vr=h.data)==null?void 0:Vr.isPrivate)!==void 0&&a(b=>({...b,isPrivate:h.data.isPrivate}));break;case"SET_GRID_SIZE":((jr=h.data)==null?void 0:jr.size)!==void 0&&a(b=>{const v=h.data.size,N=[];for(let W=0;W<v;W++){const B=[];for(let F=0;F<v;F++)B.push({card:null});N.push(B)}return{...b,activeGridSize:v,board:N}});break;case"SET_DUMMY_PLAYER_COUNT":((Jr=h.data)==null?void 0:Jr.count)!==void 0&&a(b=>({...b,dummyPlayerCount:h.data.count}));break;case"HOST_READY":h.playerId!==void 0&&(l.info(`[handleWebrtcMessage] Host (player ${h.playerId}) is ready`),a(b=>{const v=b.players.map(N=>N.id===h.playerId?{...N,isReady:!0}:N);return{...b,players:v}}));break;case"GAME_START":je.current=!0,l.info("[handleWebrtcMessage] Game starting!",h.data),l.info(`[GAME_START] Received data: startingPlayerId=${(Xr=h.data)==null?void 0:Xr.startingPlayerId}, activePlayerId=${(Zr=h.data)==null?void 0:Zr.activePlayerId}, currentPhase=${(Qr=h.data)==null?void 0:Qr.currentPhase}, isGameStarted=${(en=h.data)==null?void 0:en.isGameStarted}`),d.current&&(l.info(`[GAME_START] Current phase before: ${d.current.currentPhase}`),d.current.players.forEach(b=>{l.info(`[GAME_START] Before: Player ${b.id} - deck: ${b.deck.length}, hand: ${b.hand.length}`)})),h.data&&a(b=>{l.info(`[GAME_START] Processing for localPlayerId=${E.current}`),b.players.forEach(B=>{l.info(`[GAME_START] Player ${B.id} before: deck=${B.deck.length}, hand=${B.hand.length}`)});const v=h.data.startingPlayerId??h.data.activePlayerId,N={...b,isGameStarted:h.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:v,activePlayerId:h.data.activePlayerId,currentPhase:h.data.currentPhase??b.currentPhase},W=N.players.find(B=>B.id===E.current);if(W&&W.hand.length===0&&W.deck.length>0){const F=[...W.hand],Y=[...W.deck];for(let L=0;L<6&&L<Y.length;L++){const z=Y[0];Y.splice(0,1),F.push(z)}N.players=N.players.map(L=>L.id===E.current?{...L,hand:F,deck:Y}:L),l.info(`[GAME_START] Drew ${F.length} cards for local player ${E.current}, deck now has ${Y.length} cards`)}return N.players.forEach(B=>{l.info(`[GAME_START] Player ${B.id} after: deck=${B.deck.length}, hand=${B.hand.length}`)}),l.info(`[GAME_START] Final state: currentPhase=${N.currentPhase}, activePlayerId=${N.activePlayerId}, startingPlayerId=${N.startingPlayerId}`),N});break;case"ACTIVE_PLAYER_CHANGED":l.info("[handleWebrtcMessage] Active player changed!",h.data),h.data&&a(b=>{const v={...b,activePlayerId:h.data.activePlayerId};if(h.data.currentPhase!==void 0&&(v.currentPhase=h.data.currentPhase),h.data.turnNumber!==void 0&&(v.turnNumber=h.data.turnNumber),v.currentPhase===0&&v.activePlayerId===E.current){const N=v.players.find(W=>W.id===E.current);if(N&&N.deck.length>0){const W=N.deck[0],B=[...N.deck.slice(1)],F=[...N.hand,W];v.players=v.players.map(Y=>Y.id===E.current?{...Y,deck:B,hand:F}:Y)}v.currentPhase=1,xt(v)}return v.activePlayerId&&v.activePlayerId!==b.activePlayerId&&xt(v),v});break;case"SET_PHASE":l.info("[handleWebrtcMessage] Phase change received",h.data),h.data&&h.data.phaseIndex!==void 0&&a(b=>{const v=Math.max(1,Math.min(h.data.phaseIndex,4));if(b.currentPhase===v)return b;const W=b.board.map(Y=>Y.map(L=>{if(!L.card)return L;const z=L.card;if(z.statuses){const V=z.statuses.filter(ee=>ee.type!=="readyDeploy");if(V.length!==z.statuses.length)return{...L,card:{...z,statuses:V}}}return L})),B={...b,currentPhase:v,board:W};return v===4&&(B.isScoringStep=!0),B});break;case"SYNC_DECK_SELECTIONS":l.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",h.data),h.data&&a(b=>h.data.playerId!==void 0&&h.data.selectedDeck!==void 0?h.data.playerId===E.current?(l.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${h.data.playerId}`),b):{...b,players:b.players.map(v=>v.id===h.data.playerId?{...v,selectedDeck:h.data.selectedDeck}:v)}:h.data.deckSelections&&Array.isArray(h.data.deckSelections)?{...b,players:b.players.map(v=>{if(v.id===E.current)return v;const N=h.data.deckSelections.find(W=>W.id===v.id);return N?{...v,selectedDeck:N.selectedDeck}:v})}:b);break;case"CHANGE_PLAYER_DECK":if(l.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",h.data),!h.data||h.data.playerId===void 0)break;{const b=h.data.playerId,v=h.data.deckType,N=h.data.deck;a(W=>{const B=W.players.find(L=>L.id===b);if(!B)return W;const F=j.current;let Y;if(N&&N.length>0)if(Y=N.map(L=>{if(L.baseId){const z=Be(L.baseId);return z?{...z,id:L.id,baseId:L.baseId,deck:v,ownerId:b,ownerName:B.name,power:L.power,powerModifier:L.powerModifier||0,isFaceDown:L.isFaceDown||!1,statuses:L.statuses||[]}:(l.warn(`[CHANGE_PLAYER_DECK] Card definition not found for baseId: ${L.baseId}, id: ${L.id}`),{id:L.id,baseId:L.baseId,name:"Unknown",deck:v,ownerId:b,ownerName:B.name,power:L.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""})}return l.warn(`[CHANGE_PLAYER_DECK] Card without baseId: ${L.id}`),{id:L.id,baseId:L.id,name:"Unknown",deck:v,ownerId:b,ownerName:B.name,power:L.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}),v==="Optimates"||v==="Command"){const L={};Y.forEach(z=>{const V=z.baseId||z.id;L[V]=(L[V]||0)+1}),l.info(`[CHANGE_PLAYER_DECK] Reconstructed ${v} deck for player ${b}:`,{totalCards:Y.length,cardCounts:L})}else l.info(`[CHANGE_PLAYER_DECK] Reconstructed deck for player ${b} from host data: ${Y.length} cards`);else if(!F)Y=tt(v,b,B.name),l.warn(`[CHANGE_PLAYER_DECK] No deck data from host, creating locally for player ${b} from ${v}`);else return W;return{...W,players:W.players.map(L=>L.id===b?{...L,selectedDeck:v,deck:Y,hand:[],discard:[],announcedCard:null,boardHistory:[]}:L)}})}break;case"GAME_RESET":a(b=>{const v=h.data.activeGridSize||8,N=[];for(let F=0;F<v;F++){const Y=[];for(let L=0;L<v;L++)Y.push({card:null});N.push(Y)}const W=(h.data.players||[]).map(F=>{if(F.isDummy&&F.hand&&F.deck&&F.discard)return{...F,boardHistory:[]};{const Y=F.selectedDeck||"SynchroTech";return{...F,hand:[],deck:tt(Y,F.id,F.name),discard:[],boardHistory:[]}}}),B={...b,players:W,gameMode:h.data.gameMode,isPrivate:h.data.isPrivate,activeGridSize:h.data.activeGridSize,dummyPlayerCount:h.data.dummyPlayerCount,autoAbilitiesEnabled:h.data.autoAbilitiesEnabled,isGameStarted:h.data.isGameStarted,currentPhase:h.data.currentPhase,currentRound:h.data.currentRound,turnNumber:h.data.turnNumber,activePlayerId:h.data.activePlayerId,startingPlayerId:h.data.startingPlayerId,roundWinners:h.data.roundWinners||{},gameWinner:h.data.gameWinner,isRoundEndModalOpen:h.data.isRoundEndModalOpen,isReadyCheckActive:h.data.isReadyCheckActive,board:N,targetingMode:null,floatingTexts:[]};return d.current=B,B});break;case"ABILITY_MODE_SET":(tn=h.data)!=null&&tn.abilityMode&&(a(b=>({...b,abilityMode:h.data.abilityMode})),l.info("[AbilityMode] Received ability mode from host",{playerId:h.data.abilityMode.playerId,mode:h.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":l.info("[Ability] Target selected",h.data);break;case"ABILITY_COMPLETED":a(b=>({...b,abilityMode:void 0})),l.info("[Ability] Ability completed",h.data);break;case"ABILITY_CANCELLED":a(b=>({...b,abilityMode:void 0}));break;case"CHANGE_PLAYER_COLOR":if(l.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",h.data),!h.data||h.data.playerId===void 0)break;{const b=h.data.playerId,v=h.data.color;if(b===E.current)break;a(N=>({...N,players:N.players.map(W=>W.id===b?{...W,color:v}:W)}))}break;case"UPDATE_PLAYER_SCORE":if(l.info("[UPDATE_PLAYER_SCORE] Received score update broadcast",h.data),!h.data||h.data.playerId===void 0)break;{const b=h.data.playerId,v=h.data.delta;if(b===E.current)break;a(N=>({...N,players:N.players.map(W=>W.id===b?{...W,score:Math.max(0,W.score+v)}:W)}))}break;case"TRIGGER_HIGHLIGHT":if((rn=h.data)!=null&&rn.highlightData){const b=h.data.highlightData;_(b),j.current&&K.current&&h.senderId&&K.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(h.data){const b=(nn=K.current)==null?void 0:nn.getPeerId();h.senderId!==b&&_(h.data)}break;case"TRIGGER_FLOATING_TEXT":if((an=h.data)!=null&&an.textData){const b=h.data.textData;a(v=>({...v,floatingTexts:[...v.floatingTexts,b].filter(N=>Date.now()-N.timestamp<ie.FLOATING_TEXT_DURATION)})),j.current&&K.current&&h.senderId&&K.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((on=h.data)!=null&&on.batch){const b=h.data.batch;a(v=>({...v,floatingTexts:[...v.floatingTexts,...b].filter(N=>Date.now()-N.timestamp<ie.FLOATING_TEXT_DURATION)})),j.current&&K.current&&h.senderId&&K.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:h.senderId,data:{batch:b},timestamp:Date.now()},h.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const b=(sn=K.current)==null?void 0:sn.getPeerId();(dn=h.data)!=null&&dn.batch&&h.senderId!==b?a(v=>({...v,floatingTexts:[...v.floatingTexts,...h.data.batch].filter(N=>Date.now()-N.timestamp<ie.FLOATING_TEXT_DURATION)})):(cn=h.data)!=null&&cn.textData&&h.senderId!==b&&a(v=>({...v,floatingTexts:[...v.floatingTexts,h.data.textData].filter(N=>Date.now()-N.timestamp<ie.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((ln=h.data)!=null&&ln.coords){const b=h.data.coords,v=h.data.timestamp;T({coords:b,timestamp:v}),j.current&&K.current&&h.senderId&&K.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:h.senderId,data:{coords:b,timestamp:v},timestamp:Date.now()},h.senderId)}break;case"NO_TARGET_TRIGGERED":if((un=h.data)!=null&&un.coords){const b=(fn=K.current)==null?void 0:fn.getPeerId();h.senderId!==b&&T({coords:h.data.coords,timestamp:h.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(h.data){const b=h.data;g(v=>[...v,b]),setTimeout(()=>{g(v=>v.filter(N=>N.timestamp!==b.timestamp))},1e3),j.current&&K.current&&h.senderId&&K.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(h.data){const b=h.data;k(v=>[...v,b]),setTimeout(()=>{k(v=>v.filter(N=>N.timestamp!==b.timestamp))},1e3),j.current&&K.current&&h.senderId&&K.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"TRIGGER_CLICK_WAVE":if(h.data){const b=h.data;O(v=>[...v,b]),setTimeout(()=>{O(v=>v.filter(N=>N.timestamp!==b.timestamp))},600),j.current&&K.current&&h.senderId&&K.current.broadcastToGuests({type:"CLICK_WAVE_TRIGGERED",senderId:h.senderId,data:b,timestamp:Date.now()},h.senderId)}break;case"CLICK_WAVE_TRIGGERED":h.data&&h.senderId!==((pn=K.current)==null?void 0:pn.getPeerId())&&(O(b=>[...b,h.data]),setTimeout(()=>{O(b=>b.filter(v=>v.timestamp!==h.data.timestamp))},600));break;case"DECK_SELECTION_TRIGGERED":h.data&&h.senderId!==((yn=K.current)==null?void 0:yn.getPeerId())&&(g(b=>[...b,h.data]),setTimeout(()=>{g(b=>b.filter(v=>v.timestamp!==h.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":h.data&&h.senderId!==((hn=K.current)==null?void 0:hn.getPeerId())&&(k(b=>[...b,h.data]),setTimeout(()=>{k(b=>b.filter(v=>v.timestamp!==h.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((mn=h.data)!=null&&mn.targetingMode){const b=h.data.targetingMode,v=b.mode||((En=b.action)==null?void 0:En.mode);l.info("[TargetingMode] Received SET_TARGETING_MODE via WebRTC",{playerId:b.playerId,mode:v,boardTargetsCount:((In=b.boardTargets)==null?void 0:In.length)||0,handTargetsCount:((Tn=b.handTargets)==null?void 0:Tn.length)||0,isDeckSelectable:b.isDeckSelectable||!1,timestamp:b.timestamp,isHost:j.current}),a(N=>({...N,targetingMode:b})),d.current.targetingMode=b,!j.current&&K.current&&K.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((wn=(gn=K.current).getPeerId)==null?void 0:wn.call(gn))??void 0,data:{targetingMode:b},timestamp:Date.now()})}break;case"CLEAR_TARGETING_MODE":l.info("[TargetingMode] Received CLEAR_TARGETING_MODE via WebRTC",{isHost:j.current}),a(b=>({...b,targetingMode:null})),d.current.targetingMode=null,!j.current&&K.current&&K.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((Sn=(_n=K.current).getPeerId)==null?void 0:Sn.call(_n))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()});break;case"RECONNECT_ACCEPT":if((bn=h.data)!=null&&bn.gameState){const b=h.data.gameState;a(b),A("Connected"),l.info(`[Reconnection] State restored with ${((An=b.players)==null?void 0:An.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(v){l.warn("[Reconnection] Failed to clear stored data:",v)}}break;case"RECONNECT_REJECT":{const b=((Cn=h.data)==null?void 0:Cn.reason)||"unknown";l.warn(`[Reconnection] Reconnection rejected: ${b}`),A("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((Dn=h.data)==null?void 0:Dn.playerId)!==void 0&&(l.info(`[Reconnection] Player ${h.data.playerId} disconnected, reconnection window open`),a(b=>({...b,players:b.players.map(v=>v.id===h.data.playerId?{...v,isDisconnected:!0}:v)})));break;case"PLAYER_RECONNECTED":((Rn=h.data)==null?void 0:Rn.playerId)!==void 0&&(l.info(`[Reconnection] Player ${h.data.playerId} reconnected`),a(b=>({...b,players:b.players.map(v=>v.id===h.data.playerId?{...v,isDisconnected:!1}:v)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((Pn=h.data)==null?void 0:Pn.playerId)!==void 0&&(l.info(`[Reconnection] Player ${h.data.playerId} converted to dummy`),a(b=>({...b,players:b.players.map(v=>v.id===h.data.playerId?{...v,isDummy:!0,isDisconnected:!0}:v)})));break;case"REQUEST_DECK_VIEW":if(j.current&&((kn=h.data)==null?void 0:kn.targetPlayerId)!==void 0){const b=h.data.targetPlayerId;h.playerId;const v=n.players.find(N=>N.id===b);if(v&&K.current){let N=[];if(b===E.current||v.isDummy)l.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${v.deck.length} cards`),N=v.deck;else{const Y=ve.current.get(b);Y&&Y.length>0?(l.info(`[REQUEST_DECK_VIEW] Using stored full deck data for guest ${b}, ${Y.length} cards`),N=Y):(l.info(`[REQUEST_DECK_VIEW] No stored full deck for guest ${b}, using gameState deck, ${v.deck.length} cards`),N=v.deck)}const W=na(N),B={targetPlayerId:b,deckCards:W,deckSize:N.length,_format:"baseIdArray"},F={type:"DECK_VIEW_DATA",senderId:K.current.getPeerId(),data:B,timestamp:Date.now()};K.current.sendToGuest(h.senderId||"",F),l.info(`[REQUEST_DECK_VIEW] Sent ${B.deckSize} cards (optimized) for player ${b}`)}}break;case"DECK_VIEW_DATA":if(((On=h.data)==null?void 0:On.targetPlayerId)!==void 0&&((vn=h.data)!=null&&vn.deckCards)){const b=h.data.targetPlayerId,v=h.data.deckCards,N=h.data._format==="baseIdArray";let W;if(N&&typeof v=="string")try{W=aa(v,b)}catch(B){l.error("[DECK_VIEW_DATA] Failed to deserialize optimized deck:",B);break}else{const B=v;l.info(`[DECK_VIEW_DATA] Received legacy format (${B.length} cards) for player ${b}`);const F=B[0];if((F==null?void 0:F.name)&&(F==null?void 0:F.imageUrl))l.info(`[DECK_VIEW_DATA] Received full card data, using directly. First card: ${F.name}`),W=B.map(L=>({id:L.id,baseId:L.baseId||L.id,name:L.name,imageUrl:L.imageUrl,fallbackImage:L.fallbackImage||"",power:L.power,powerModifier:L.powerModifier||0,isFaceDown:L.isFaceDown??!1,statuses:L.statuses||[],deck:L.deck||Ce.SynchroTech,color:L.color||"Red",ability:L.ability||"",bonusPower:L.bonusPower||0,isPlaceholder:L.isPlaceholder||!1,types:L.types||[],faction:L.faction||"",ownerId:L.ownerId||b}));else{const L=z=>{if(z.baseId){const ee=Be(z.baseId);if(ee)return{...ee,id:z.id,baseId:z.baseId,deck:z.deck||Ce.SynchroTech,ownerId:b,power:z.power,powerModifier:z.powerModifier,isFaceDown:z.isFaceDown,statuses:z.statuses||[]};l.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${z.baseId}`)}else l.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${z.id}`);return{id:z.id,baseId:z.baseId||z.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:z.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:Ce.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}};W=B.map(L)}}a(B=>({...B,players:B.players.map(F=>F.id===b?{...F,deck:W}:F)}))}break;case"DECK_DATA_UPDATE":if(j.current&&h.playerId!==void 0&&((Mn=h.data)!=null&&Mn.deck)){const b=h.playerId,v=h.data.deck,N=h.data.deckSize,W=h.data._format==="baseIdArray";let B;if(W&&typeof v=="string")try{B=aa(v,b)}catch(F){l.error("[DECK_DATA_UPDATE] Failed to deserialize optimized deck:",F);break}else{const F=v;l.info(`[DECK_DATA_UPDATE] Received legacy format (${F.length} cards) for guest ${b}, first card: ${(Nn=F[0])==null?void 0:Nn.name}`),B=F.map(Y=>({...Y,ownerId:Y.ownerId??b}))}ve.current.set(b,B),a(F=>{const Y={...F,players:F.players.map(L=>L.id===b?{...L,deck:B,deckSize:N}:L)};return K.current&&h.senderId&&setTimeout(()=>{K.current.broadcastGameState(Y,h.senderId)},0),Y})}break;case"REQUEST_DECK_DATA":if(!j.current&&K.current){const b=n.players.find(v=>v.id===E.current);if(b&&b.deck.length>0){l.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${b.deck.length} cards (optimized format)`);const v=na(b.deck);K.current.sendAction("DECK_DATA_UPDATE",{playerId:E.current,deck:v,deckSize:b.deck.length,_format:"baseIdArray"})}}break;case"HOST_DECK_DATA":if(!j.current&&((Ln=h.data)!=null&&Ln.deck)){const b=h.data.deck,v=h.data.deckSize,N=1;l.info(`[HOST_DECK_DATA] Received host deck data: ${b.length} cards`),a(W=>({...W,players:W.players.map(B=>B.id===N?{...B,deck:b,deckSize:v}:B)}))}break;case"CARD_STATUS_SYNC":l.info("[CARD_STATUS_SYNC] Received card status changes:",((Un=(Gn=h.data)==null?void 0:Gn.changes)==null?void 0:Un.length)||0);const Yn=((xn=h.data)==null?void 0:xn.changes)||[];Yn.length>0&&a(b=>{const v={...b};for(const N of Yn){const{cardId:W,statusType:B,action:F,ownerId:Y}=N;for(let L=0;L<v.board.length;L++)for(let z=0;z<v.board[L].length;z++){const V=v.board[L][z];if(V!=null&&V.card&&V.card.id===W){const ee=V.card;if(ee.statuses||(ee.statuses=[]),F==="add")ee.statuses.some(oe=>oe.type===B)||ee.statuses.push({type:B,addedByPlayerId:Y??0});else if(F==="remove"){const oe=ee.statuses.length;ee.statuses=ee.statuses.filter(se=>se.type!==B),ee.statuses.length}break}}}return v});break;case"BOARD_CARD_SYNC":l.info("[BOARD_CARD_SYNC] Received board card data:",((Hn=($n=h.data)==null?void 0:$n.cards)==null?void 0:Hn.length)||0,"action:",(Fn=h.data)==null?void 0:Fn.action);const zn=((Wn=h.data)==null?void 0:Wn.cards)||[],Jo=((Bn=h.data)==null?void 0:Bn.action)||"update";zn.length>0&&a(b=>{var W;const v={...b},N=[...v.board];for(const B of zn){const{cardId:F,row:Y,col:L,power:z,ownerId:V,enteredThisTurn:ee,statuses:oe}=B;if(!N[Y]||!N[Y][L]){l.warn(`[BOARD_CARD_SYNC] Invalid cell at [${Y},${L}] for card ${F}`);continue}if(Jo==="remove")((W=N[Y][L].card)==null?void 0:W.id)===F&&(N[Y][L].card=null);else{const se=N[Y][L].card;se&&se.id===F&&(se.power=z,se.ownerId=V,se.enteredThisTurn=ee,oe&&Array.isArray(oe)&&(se.statuses=oe.map(Q=>({type:Q.type,addedByPlayerId:Q.addedByPlayerId}))))}}return v.board=N,v});break;default:l.warn(`[handleWebrtcMessage] Unknown message type: ${h.type}`,h);break}},[de,tt,br,n,i]),Wa=H.useCallback(h=>{if(!K.current||De)return;Oe(!0),A("Connecting");const ae=3e4,te=1e3;let re=0;const le=ae/te;try{const ce={hostPeerId:h,playerId:i,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ce))}catch(ce){l.error("[Reconnection] Failed to store data:",ce)}const ne=async()=>{re++;const ce=Math.max(0,ae-re*te);if(Ge({attempt:re,maxAttempts:le,timeRemaining:ce}),ce<=0){l.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Oe(!1),Ge(null),at();return}let X=h;if(n!=null&&n.gameId){const Te=rr(n.gameId);if(Te&&Te.peerId!==h){X=Te.peerId;try{const Se={hostPeerId:X,playerId:i,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(Se))}catch(Se){l.error("[Reconnection] Failed to update reconnection data:",Se)}}}try{const Te=i||E.current;Te!==null?(l.info(`[Reconnection] Reconnecting as existing player ${Te} to host ${X}`),await K.current.initializeAsReconnectingGuest(X,Te)):(l.info("[Reconnection] No playerId, connecting as new player"),await K.current.initializeAsGuest(X)),l.info("[Reconnection] Successfully reconnected!"),Oe(!1),Ge(null)}catch(Te){l.warn("[Reconnection] Reconnection attempt failed:",Te),setTimeout(ne,te)}};ne()},[De,n,i]),ze=H.useCallback(h=>{a(ae=>{if(!ae)return l.error("[updateState] prevState is undefined, skipping update"),ae;const te=typeof h=="function"?h(ae):h;if(!te)return l.error("[updateState] newState is undefined, skipping update"),ae;const re=!ae.gameId&&te.gameId;if(!je.current&&!re)return te;if(x&&K.current){if(j.current){if(K.current.broadcastGameState(te),l.info(`[updateState] Host broadcast state: phase=${te.currentPhase}, activePlayer=${te.activePlayerId}`),te.gameId&&E.current!==null)try{Ct({gameState:te,localPlayerId:E.current,isHost:!0}),l.debug("[updateState] Saved game state for host auto-restore")}catch(le){l.warn("[updateState] Failed to save game state:",le)}}else K.current&&(K.current.sendStateToHost(te,E.current),l.info(`[updateState] Guest sent state to host: phase=${te.currentPhase}, activePlayer=${te.activePlayerId}`));return te}if(ge.current&&ge.current.readyState===WebSocket.OPEN){const le={type:"UPDATE_STATE",gameState:te};pt.current&&(le.playerToken=pt.current),ge.current.send(JSON.stringify(le))}return te})},[x,de,br]),Ba=H.useCallback(()=>{const{initialState:h}=ht.createGame();ze(h)},[ht,ze]),Ya=H.useCallback(()=>{ht.exitGame(Ve,j,ea,at)},[ht,Ve,j,ea,at]),za=hi({ws:ge,webrtcManager:K,gameStateRef:d,webrtcIsHostRef:j,setGameState:a,updateState:ze}),Ka=mi({ws:ge,webrtcManager:K,gameStateRef:d,localPlayerIdRef:E,webrtcIsHostRef:j,setGameState:a}),qa=Ei({updateState:ze,sendWebrtcAction:rt,webrtcIsHostRef:j,webrtcManagerRef:K}),Va=Ii({ws:ge,webrtcManager:K,gameStateRef:d,localPlayerIdRef:E,webrtcIsHostRef:j,updateState:ze}),ja=Ti({localPlayerIdRef:E,updateState:ze}),{addBoardCardStatus:Ja,removeBoardCardStatus:Xa,removeBoardCardStatusByOwner:Za,modifyBoardCardPower:Qa,addAnnouncedCardStatus:eo,removeAnnouncedCardStatus:to,modifyAnnouncedCardPower:ro,addHandCardStatus:no,removeHandCardStatus:ao,revealHandCard:oo,revealBoardCard:so,requestCardReveal:io,respondToRevealRequest:co,removeRevealedStatus:lo}=ja,uo=gi({webrtcIsHostRef:j,sendWebrtcAction:rt,webrtcManagerRef:K,localPlayerIdRef:E,getCardDefinition:Be,commandCardIds:is,createDeck:tt,updateState:ze}),{changePlayerDeck:fo,loadCustomDeck:po,resurrectDiscardedCard:yo,reorderTopDeck:ho,reorderCards:mo,recoverDiscardedCard:Eo}=uo,Io=wi({ws:ge,webrtcManagerRef:K,webrtcIsHostRef:j,gameStateRef:d,scoreDeltaAccumulator:et,setGameState:a,updateState:ze,abilityMode:e,setAbilityMode:r,createDeck:tt,webrtcEnabled:x}),{toggleActivePlayer:To,toggleAutoDraw:go,setPhase:wo,nextPhase:_o,prevPhase:So,closeRoundEndModal:bo,closeRoundEndModalOnly:Ao,resetGame:Co}=Io;H.useEffect(()=>{qe.current=!1;const h=sessionStorage.getItem("invite_game_id"),ae=sessionStorage.getItem("invite_host_id");if(h&&!ae)return wr(),()=>{qe.current=!0,mt.current&&clearTimeout(mt.current),ge.current&&(ge.current.onclose=null,ge.current.close())};if(h&&ae)return()=>{qe.current=!0,mt.current&&clearTimeout(mt.current),ge.current&&(ge.current.onclose=null,ge.current.close())};const te=performance.getEntriesByType("navigation"),re=te.length>0?te[0]:null,le=(re==null?void 0:re.type)??0,ne=fi();return ne&&(l.info(`Restoring saved game state (nav type: ${le}):`,ne.gameState.gameId),a(ne.gameState),s(ne.localPlayerId),d.current=ne.gameState,E.current=ne.localPlayerId,pt.current=ne.playerToken),wr(),()=>{qe.current=!0,mt.current&&clearTimeout(mt.current),ge.current&&(ge.current.onclose=null,ge.current.close())}},[]),H.useEffect(()=>{if(xe&&d.current&&d.current.gameId){const h=Lt(d.current);h!==d.current&&(a(h),d.current=h)}},[]),H.useEffect(()=>{if(M)return;const h=setInterval(()=>{if(xe&&d.current&&d.current.gameId){const ae=Lt(d.current);a({...ae}),d.current=ae,G(!0),clearInterval(h)}},100);return()=>clearInterval(h)},[M]);const{startReadyCheck:Do,cancelReadyCheck:Ro,playerReady:Po}=Ka,{updatePlayerName:ko,changePlayerColor:Oo}=qa,{drawCard:vo,drawCardsBatch:Mo,shufflePlayerDeck:No,flipBoardCard:Lo,flipBoardCardFaceDown:Go}=Va,{assignTeams:Uo,setGameMode:xo,setGamePrivacy:$o,setActiveGridSize:Ho,setDummyPlayerCount:Fo}=za,Wo=H.useCallback(()=>{var h;if(((h=ge.current)==null?void 0:h.readyState)===WebSocket.OPEN&&d.current.gameId&&E.current===1){ge.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:xe}));const ae=d.current,te=fe(ae);te.players.forEach(re=>{if(["hand","deck","discard"].forEach(ne=>{re[ne]&&(re[ne]=re[ne].map(ce=>{const X=Xt(ce.name);return X?{...ce,...X}:ce}))}),re.announcedCard){const ne=Xt(re.announcedCard.name);ne&&(re.announcedCard={...re.announcedCard,...ne})}}),te.board.forEach(re=>{re.forEach(le=>{if(le.card){const ne=Xt(le.card.name);ne&&(le.card={...le.card,...ne})}})}),ge.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:te})),a(te)}},[]),jt=H.useCallback((h,ae)=>{var le;const te=d.current;if(!te.isGameStarted){l.warn("[ScoreUpdate] Blocked: game not started");return}if(te.isRoundEndModalOpen){l.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(ae===0)return;const re=Fe();if(re?ze(ne=>({...ne,players:ne.players.map(ce=>ce.id===h?{...ce,score:Math.max(0,(ce.score||0)+ae)}:ce)})):a(ne=>({...ne,players:ne.players.map(ce=>ce.id===h?{...ce,score:Math.max(0,(ce.score||0)+ae)}:ce)})),!re){if(((le=ge.current)==null?void 0:le.readyState)!==WebSocket.OPEN){l.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const ne=et.get(h);if(ne){clearTimeout(ne.timerId);const ce=ne.delta+ae,X=setTimeout(()=>{var Se;const Te=et.get(h);Te&&((Se=ge.current)==null?void 0:Se.readyState)===WebSocket.OPEN&&(l.info(`[ScoreUpdate] Sending accumulated delta: player=${h}, delta=${Te.delta}`),ge.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:d.current.gameId,playerId:h,delta:Te.delta}))),et.delete(h)},500);et.set(h,{delta:ce,timerId:X})}else{const ce=setTimeout(()=>{var Te;const X=et.get(h);X&&((Te=ge.current)==null?void 0:Te.readyState)===WebSocket.OPEN&&(l.info(`[ScoreUpdate] Sending delta: player=${h}, delta=${X.delta}`),ge.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:d.current.gameId,playerId:h,delta:X.delta}))),et.delete(h)},500);et.set(h,{delta:ae,timerId:ce})}}},[a,ze]),Bo=Ai({ws:ge,webrtcManager:K,gameStateRef:d,webrtcIsHostRef:j,setGameState:a}),{setTargetingMode:Yo,clearTargetingMode:Ar}=Bo,zo=_i({ws:ge,gameStateRef:d,updateState:ze,updatePlayerScore:jt,triggerFloatingText:Sr,clearTargetingMode:Ar,webrtcIsHostRef:j}),{scoreLine:Ko,scoreDiagonal:qo}=zo,Je=Si({updateState:ze,rawJsonData:xe,broadcastCardStatusSync:h=>{Fe()&&j.current&&K.current&&K.current.broadcastCardStatusSync(h)}}),Vo=bi({updateState:ze,localPlayerIdRef:E,updatePlayerScore:jt}),{moveItem:Cr,destroyCard:jo}=Vo;return{gameState:n,localPlayerId:i,setLocalPlayerId:s,draggedItem:P,setDraggedItem:S,connectionStatus:y,gamesList:f,latestHighlight:p,latestFloatingTexts:D,latestNoTarget:w,latestDeckSelections:m,latestHandCardSelections:C,joinAsInvite:ka,startReadyCheck:Do,cancelReadyCheck:Ro,playerReady:Po,assignTeams:Uo,setGameMode:xo,setGamePrivacy:$o,setActiveGridSize:Ho,setDummyPlayerCount:Fo,updatePlayerName:ko,changePlayerColor:Oo,updatePlayerScore:jt,changePlayerDeck:fo,loadCustomDeck:po,drawCard:vo,drawCardsBatch:Mo,shufflePlayerDeck:No,moveItem:Cr,handleDrop:Cr,destroyCard:jo,addBoardCardStatus:Ja,removeBoardCardStatus:Xa,removeBoardCardStatusByOwner:Za,modifyBoardCardPower:Qa,addAnnouncedCardStatus:eo,removeAnnouncedCardStatus:to,modifyAnnouncedCardPower:ro,addHandCardStatus:no,removeHandCardStatus:ao,flipBoardCard:Lo,flipBoardCardFaceDown:Go,revealHandCard:oo,revealBoardCard:so,requestCardReveal:io,respondToRevealRequest:co,syncGame:Wo,removeRevealedStatus:lo,toggleActivePlayer:To,toggleAutoDraw:go,triggerHighlight:Ma,triggerFloatingText:Sr,triggerNoTarget:Na,triggerDeckSelection:La,triggerHandCardSelection:Ga,triggerClickWave:xa,clickWaves:R,syncValidTargets:Ua,setTargetingMode:Yo,clearTargetingMode:Ar,nextPhase:_o,prevPhase:So,setPhase:wo,markAbilityUsed:Je.markAbilityUsed,applyGlobalEffect:Je.applyGlobalEffect,swapCards:Je.swapCards,transferStatus:Je.transferStatus,transferAllCounters:Je.transferAllCounters,transferAllStatusesWithoutException:Je.transferAllStatusesWithoutException,spawnToken:Je.spawnToken,resetDeployStatus:Je.resetDeployStatus,removeStatusByType:Je.removeStatusByType,recoverDiscardedCard:Eo,resurrectDiscardedCard:yo,scoreLine:Ko,closeRoundEndModal:bo,closeRoundEndModalOnly:Ao,resetGame:Co,scoreDiagonal:qo,reorderTopDeck:ho,reorderCards:mo,updateState:ze,requestDeckView:gr,sendFullDeckToHost:Vt,shareHostDeckWithGuests:nt,createGame:Ba,joinGame:_r,joinGameViaModal:_r,exitGame:Ya,requestGamesList:Oa,forceReconnect:Pa,webrtcHostId:Z,webrtcIsHost:de,initializeWebrtcHost:yt,connectAsGuest:bt,sendWebrtcAction:rt,isReconnecting:De,reconnectProgress:Re}};function da(t,e,r){const{gameState:n,localPlayerId:a,abilityMode:o,cursorStack:c,handleActionExecution:i,markAbilityUsed:s,addBoardCardStatus:d}=r;if(o||c||!n.isGameStarted||a===null)return null;const E=n.players.find(y=>y.id===t.ownerId),P=a===t.ownerId||(E==null?void 0:E.isDummy);if(n.activePlayerId!==t.ownerId||!P||!Ea(t,n)||!Ss(t,n.currentPhase,n.activePlayerId,n))return null;const S=bs(t,n,t.ownerId,e);if(S){if(S.type==="ENTER_MODE"&&S.mode==="SHIELD_SELF_THEN_RIOT_PUSH"){d(e,"Shield",t.ownerId),S.readyStatusToRemove&&s(e,!!S.isDeployAbility,!1,S.readyStatusToRemove);const f={...{type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:e,isDeployAbility:S.isDeployAbility,readyStatusToRemove:S.readyStatusToRemove,payload:{}},chainedAction:{type:"ABILITY_COMPLETE"}};return i(f,e),f}S.readyStatusToRemove&&s(e,!!S.isDeployAbility,!1,S.readyStatusToRemove);const y={...S,chainedAction:S.chainedAction?{...S.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};return i(y,e),y}return null}function vd(t){const e=ut[t],r=(e==null?void 0:e.allowedTargets)||[];return{allowedTargets:r,allowHand:r.includes("hand"),allowBoard:r.includes("board"),allowBoardFaceDown:r.includes("board-facedown"),allowDeck:r.includes("deck"),allowDiscard:r.includes("discard")}}function Tr(t,e,r,n){const a={type:t,count:r?r.count+1:1,isDragging:!0,originalOwnerId:e,sourceCoords:r==null?void 0:r.sourceCoords},o={};return t==="Revealed"&&(o.excludeOwnerId=e,o.onlyFaceDown=!0),{...a,...o,...n,...r&&{chainedAction:r.chainedAction,isDeployAbility:r.isDeployAbility,readyStatusToRemove:r.readyStatusToRemove}}}function Xe(t,e){var n;const r=(n=t.sourceCard)==null?void 0:n.ownerId;return typeof r=="number"?r:typeof e=="number"?e:0}function Pi(t,e,r){var E;const{gameState:n,localPlayerId:a,commandContext:o,triggerNoTarget:c,onAbilityComplete:i,handleActionExecution:s}=r;if(t.type==="ABILITY_COMPLETE"){i==null||i();return}if(t.type==="REVEREND_SETUP_SCORE"){ki(t,e,r);return}if(t.type==="GLOBAL_AUTO_APPLY"){Oi(t,e,r);return}if(!wt(t,n,((E=t.sourceCard)==null?void 0:E.ownerId)||a,o)){c(e),t.chainedAction&&!t.skipChainedActionOnNoTargets&&setTimeout(()=>{s(t.chainedAction,e)},500);return}if(t.type==="CREATE_STACK"){vi(t,e,r);return}if(t.type==="OPEN_MODAL"){Mi(t,e,r);return}if(t.type==="ENTER_MODE"){Ni(t,e,r);return}l.warn("[handleActionExecution] Unknown action type:",t.type)}function ki(t,e,r){var d,E;const{gameState:n,updatePlayerScore:a,triggerFloatingText:o,markAbilityUsed:c}=r,i=((d=t.sourceCard)==null?void 0:d.ownerId)??0;let s=0;for(let P=0;P<n.board.length;P++)for(let S=0;S<n.board[P].length;S++){const y=(E=n.board[P][S])==null?void 0:E.card;if(y!=null&&y.statuses){const A=y.statuses.filter(f=>f.type==="Exploit"&&f.addedByPlayerId===i);s+=A.length}}s>0&&a(i,s),o([{row:e.row,col:e.col,text:`+${s}`,playerId:i}]),c(e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function Oi(t,e,r){var A,f,I,p,_,D;const{gameState:n,localPlayerId:a,commandContext:o,markAbilityUsed:c,triggerNoTarget:i,triggerFloatingText:s,updatePlayerScore:d,applyGlobalEffect:E,addBoardCardStatus:P,removeStatusByType:S,handleActionExecution:y}=r;if(((A=t.payload)==null?void 0:A.customAction)==="FINN_SCORING"){const u=(f=t.sourceCard)==null?void 0:f.ownerId;if(u===void 0){l.warn("[FINN_SCORING] Source card missing ownerId"),c(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}let w=0;if(n.players.forEach(T=>{T.id!==u&&T.hand.forEach(m=>{var g;(g=m.statuses)!=null&&g.some(C=>C.type==="Revealed"&&C.addedByPlayerId===u)&&w++})}),n.board.forEach(T=>{T.forEach(m=>{var C;const g=m.card;if(g&&g.ownerId!==u){const k=((C=g.statuses)==null?void 0:C.filter(R=>R.type==="Revealed"&&R.addedByPlayerId===u).length)||0;w+=k}})}),w>0){const T=t.sourceCoords||e;s({row:T.row,col:T.col,text:`+${w}`,playerId:u}),d(u,w)}c(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}if(((I=t.payload)==null?void 0:I.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){t.sourceCoords&&t.sourceCoords.row>=0?S(t.sourceCoords,"Aim"):o.lastMovedCardCoords&&S(o.lastMovedCardCoords,"Aim");return}if((p=t.payload)!=null&&p.tokenType&&t.payload.filter){const{tokenType:u,filter:w}=t.payload,T=[],m=n.board.length;for(let g=0;g<m;g++)for(let C=0;C<m;C++){const k=n.board[g][C].card;k&&w(k,g,C)&&T.push({row:g,col:C})}if(T.length===0){i(t.sourceCoords||e),t.chainedAction&&setTimeout(()=>y(t.chainedAction,e),500),c(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}T.forEach(g=>{var C;P(g,u,((C=t.sourceCard)==null?void 0:C.ownerId)||0)}),c(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove),t.chainedAction&&setTimeout(()=>y(t.chainedAction,e),ie.MODE_CLEAR_DELAY);return}if((_=t.payload)!=null&&_.contextReward){ca(t,e,r);return}if(t.payload&&!t.payload.cleanupCommand){const{tokenType:u,filter:w}=t.payload,T=[],m=n.board.length;if(t.payload.contextReward&&t.sourceCard){ca(t,e,r);return}if(w)for(let g=0;g<m;g++)for(let C=0;C<m;C++){const k=n.board[g][C].card;k&&w(k)&&T.push({row:g,col:C})}else t.sourceCoords&&t.sourceCoords.row>=0?T.push(t.sourceCoords):e&&e.row>=0?T.push(e):o.lastMovedCardCoords&&T.push(o.lastMovedCardCoords);if(T.length>0){if(u){const g=t.payload.count||1,C=t.payload.ownerId!==void 0?t.payload.ownerId:((D=t.sourceCard)==null?void 0:D.ownerId)??a??0;for(let k=0;k<g;k++)E(e,T,u,C,!!t.isDeployAbility)}}else i(e),c(e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}}function vi(t,e,r){var d,E;const{gameState:n,setAbilityMode:a,setCursorStack:o,triggerNoTarget:c,localPlayerId:i}=r;let s=t.count||0;if(t.dynamicCount){const{factor:P,ownerId:S}=t.dynamicCount;let y=0;n.board.forEach(A=>{A.forEach(f=>{var I;if((I=f.card)!=null&&I.statuses){const p=f.card.statuses.filter(_=>_.type===P&&_.addedByPlayerId===S);y+=p.length}})}),s=y}if(s>0){a(null);let P=((d=t.sourceCard)==null?void 0:d.ownerId)??i??0;!((E=t.sourceCard)!=null&&E.ownerId)&&i!==null&&(P=i);const S={count:s,sourceCoords:t.sourceCoords||e,sourceCard:t.sourceCard,isDeployAbility:t.isDeployAbility,readyStatusToRemove:t.readyStatusToRemove,targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,requiredTargetStatus:t.requiredTargetStatus,requireStatusFromSourceOwner:t.requireStatusFromSourceOwner,mustBeAdjacentToSource:t.mustBeAdjacentToSource,mustBeInLineWithSource:t.mustBeInLineWithSource,maxDistanceFromSource:t.maxDistanceFromSource,maxOrthogonalDistance:t.maxOrthogonalDistance,placeAllAtOnce:t.placeAllAtOnce,replaceStatus:t.replaceStatus,chainedAction:t.chainedAction,recordContext:t.recordContext};o(Tr(t.tokenType||"Aim",P,null,S))}else c(e)}function Mi(t,e,r){var d,E;const{gameState:n,localPlayerId:a,commandContext:o,setViewingDiscard:c,markAbilityUsed:i}=r;if(!wt(t,n,((d=t.sourceCard)==null?void 0:d.ownerId)||a,o)){i(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}if(t.mode==="RETRIEVE_DEVICE"){const P=n.players.find(S=>{var y;return S.id===((y=t.sourceCard)==null?void 0:y.ownerId)});P&&(c({player:P,pickConfig:{filterType:"Device",action:"recover"}}),e.row>=0&&i(e,!!t.isDeployAbility,!1,t.readyStatusToRemove))}else if(t.mode==="IMMUNIS_RETRIEVE"){const P=n.players.find(S=>{var y;return S.id===((y=t.sourceCard)==null?void 0:y.ownerId)});P&&c({player:P,pickConfig:{filterType:"Optimates",action:"resurrect"}})}else if(t.mode==="SEARCH_DECK"){const P=n.players.find(S=>{var y;return S.id===((y=t.sourceCard)==null?void 0:y.ownerId)});P&&(c({player:P,pickConfig:{filterType:((E=t.payload)==null?void 0:E.filterType)||"Unit",action:"recover",isDeck:!0}}),e.row>=0&&i(e,!!t.isDeployAbility,!1,t.readyStatusToRemove))}i(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function Ni(t,e,r){var y,A,f,I;const{gameState:n,localPlayerId:a,commandContext:o,triggerNoTarget:c,setAbilityMode:i,markAbilityUsed:s,addBoardCardStatus:d,setTargetingMode:E,handleActionExecution:P}=r,S=t.mode;if(S==="SHIELD_SELF_THEN_RIOT_PUSH"){i(t),E(t,Xe(t,a),e,void 0,o);return}if(S==="SHIELD_SELF_THEN_SPAWN"){const p=Xe(t,a);d(e,"Shield",p),i({...t,payload:{...t.payload,shieldApplied:!0}}),E(t,p,e);return}if(S==="PRINCEPS_SHIELD_THEN_AIM"){const p=Xe(t,a);d(e,"Shield",p);const _={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};P(_,e);return}if(S==="GAWAIN_DEPLOY_SHIELD_AIM"){const p=t.sourceCard.ownerId;d(e,"Shield",p);const _={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};P(_,e);return}if(S==="ABR_DEPLOY_SHIELD_AIM"){const p=t.sourceCard.ownerId;d(e,"Shield",p);const _={type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};P(_,e);return}if(S==="RIOT_PUSH"){if(!wt(t,n,((y=t.sourceCard)==null?void 0:y.ownerId)||a,o)){c(t.sourceCoords||e),s(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),E(t,Xe(t,a),e);return}if(S==="SWAP_POSITIONS"){if(!wt(t,n,((A=t.sourceCard)==null?void 0:A.ownerId)||a,o)){c(t.sourceCoords||e),s(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),E(t,Xe(t,a),e);return}if(S==="PATROL_MOVE"){if(!wt(t,n,((f=t.sourceCard)==null?void 0:f.ownerId)||a,o)){c(t.sourceCoords||e),s(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),E(t,Xe(t,a),e);return}if(S==="SELECT_TARGET"){if(t.isDeployAbility){i(t),E(t,Xe(t,a),e,void 0,o);return}if(!wt(t,n,((I=t.sourceCard)==null?void 0:I.ownerId)||a,o)){c(t.sourceCoords||e),s(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),E(t,Xe(t,a),e,void 0,o);return}i(t),E(t,Xe(t,a),e)}function ca(t,e,r){var p,_,D,u,w,T,m;const{gameState:n,commandContext:a,updatePlayerScore:o,triggerFloatingText:c,drawCardsBatch:i,removeBoardCardStatus:s,addBoardCardStatus:d,modifyBoardCardPower:E,markAbilityUsed:P}=r,S=(p=t.payload)==null?void 0:p.contextReward,y=a.lastMovedCardCoords||e;if(!y||y.row<0)return;let A=n.board[y.row][y.col].card;const f=((_=t.payload)==null?void 0:_._tempContextId)||a.lastMovedCardId;if((!A||f&&A.id!==f)&&f)for(let g=0;g<n.board.length;g++){for(let C=0;C<n.board[g].length;C++)if(((D=n.board[g][C].card)==null?void 0:D.id)===f){A=n.board[g][C].card;break}if(A)break}if(!A){l.warn("[ContextReward] No card at coords");return}const I=Math.max(0,A.power+(A.powerModifier||0)+(A.bonusPower||0));S==="DRAW_MOVED_POWER"||S==="DRAW_EQUAL_POWER"?i(((u=t.sourceCard)==null?void 0:u.ownerId)||0,I):S==="SCORE_MOVED_POWER"?(c({row:y.row,col:y.col,text:`+${I}`,playerId:((w=t.sourceCard)==null?void 0:w.ownerId)||0}),o(((T=t.sourceCard)==null?void 0:T.ownerId)||0,I)):S==="STUN_MOVED_UNIT"?d(y,"Stun",((m=t.sourceCard)==null?void 0:m.ownerId)||0):S==="REMOVE_AIM"?s(y,"Aim"):S==="WEAKEN"&&E(y,-1),P(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function Li(t,e){var T;const{gameState:r,localPlayerId:n,abilityMode:a,setAbilityMode:o,cursorStack:c,commandContext:i,setCommandContext:s,playMode:d,draggedItem:E,interactionLock:P,handleActionExecution:S,handleDrop:y,moveItem:A,markAbilityUsed:f,spawnToken:I,resurrectDiscardedCard:p,updatePlayerScore:_,triggerFloatingText:D,handleLineSelection:u}=e;if(P.current)return!1;const w=r.board.length;if(E)return t.row>=0&&t.row<w&&t.col>=0&&t.col<r.board[t.row].length?(y(E,{location:"board",row:t.row,col:t.col}),!0):!1;if(c&&c.isDragging){if(lt({location:"board",row:t.row,col:t.col},{...c.targetOwnerId!==void 0&&{targetOwnerId:c.targetOwnerId},...c.excludeOwnerId!==void 0&&{excludeOwnerId:c.excludeOwnerId},onlyOpponents:c.onlyOpponents,onlyFaceDown:c.onlyFaceDown,...c.targetType&&{targetType:c.targetType},...c.requiredTargetStatus&&{requiredTargetStatus:c.requiredTargetStatus},...c.requireStatusFromSourceOwner!==void 0&&{requireStatusFromSourceOwner:c.requireStatusFromSourceOwner},...c.mustBeAdjacentToSource&&c.sourceCoords&&{mustBeAdjacentTo:c.sourceCoords},...c.mustBeInLineWithSource&&c.sourceCoords&&{mustBeInLineWith:c.sourceCoords},...c.maxDistanceFromSource!==void 0&&{maxDistance:c.maxDistanceFromSource},...c.range&&{range:c.range}},n??0,r.players)){let g=null;if(c.sourceCoords){const{row:C,col:k}=c.sourceCoords;C>=0&&C<w&&k>=0&&k<r.board[C].length&&(g=r.board[C][k].card)}if(g)return S({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:c.type,count:c.count,targetOwnerId:c.targetOwnerId,onlyOpponents:c.onlyOpponents,onlyFaceDown:c.onlyFaceDown,...c.range&&{range:c.range},...c.requiredTargetStatus&&{requiredTargetStatus:c.requiredTargetStatus},cleanupCommand:!0},sourceCard:g,sourceCoords:c.sourceCoords},t),!0}return!1}if(a&&a.mode==="SPAWN_TOKEN"){const{sourceCoords:m,payload:g,sourceCard:C,isDeployAbility:k,readyStatusToRemove:R}=a;if(!m||!(g!=null&&g.tokenName)||!(Math.abs(t.row-m.row)+Math.abs(t.col-m.col)===1))return!1;const U=(C==null?void 0:C.ownerId)??((T=a.sourceCard)==null?void 0:T.ownerId);return I(t,g.tokenName,U),f(m,k,!1,R),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="SELECT_CELL"){const{sourceCoords:m,sourceCard:g,isDeployAbility:C,readyStatusToRemove:k,payload:R}=a,O=(()=>{var M;if(m&&m.row>=0)return m;if(!g)return null;for(let G=0;G<r.board.length;G++)for(let x=0;x<r.board.length;x++)if(((M=r.board[G][x].card)==null?void 0:M.id)===g.id)return{row:G,col:x};return null})();if(!O||!g)return!1;let U=!1;if((R==null?void 0:R.range)==="line")U=t.row===O.row||t.col===O.col;else if((R==null?void 0:R.range)==="global")U=!0;else if((R==null?void 0:R.range)===2){const M=Math.abs(t.row-O.row)+Math.abs(t.col-O.col);if(M===1)U=!0;else if(M===2){const G=O.row,x=O.col,q=t.row,Z=t.col;U=[{r:q,c:x},{r:G,c:Z},{r:(G+q)/2,c:(x+Z)/2}].some(de=>{if(!Number.isInteger(de.r)||!Number.isInteger(de.c))return!1;const pe=Math.floor((r.board.length-r.activeGridSize)/2),j=pe,De=pe+r.activeGridSize-1;return de.r<j||de.r>De||de.c<j||de.c>De||Math.abs(de.r-G)+Math.abs(de.c-x)!==1?!1:!r.board[de.r][de.c].card})}}else R!=null&&R.filter?U=R.filter(null,t.row,t.col):U=Math.abs(t.row-O.row)+Math.abs(t.col-O.col)===1;if(!U)return!1;if(R!=null&&R.moveFromHand&&i.selectedHandCard){const{playerId:M,cardIndex:G}=i.selectedHandCard,x=r.players.find(Z=>Z.id===M),q=x==null?void 0:x.hand[G];if(q)return A({card:q,source:"hand",playerId:M,cardIndex:G,isManual:!0},{target:"board",boardCoords:t}),f(m||t,C,!1,k),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0}if(!((R==null?void 0:R.allowSelf)&&t.row===O.row&&t.col===O.col)){const M=r.board[O.row][O.col].card;M&&A({card:M,source:"board",boardCoords:O,bypassOwnershipCheck:!0},{target:"board",boardCoords:t})}if(R!=null&&R.recordContext&&s({lastMovedCardCoords:t,lastMovedCardId:g.id}),f(m||t,C,!1,k),R!=null&&R.chainedAction){const M={...R.chainedAction};M.targetOwnerId===-2&&(M.targetOwnerId=g.ownerId),R.recordContext&&(M.payload||(M.payload={}),M.payload._tempContextId=g.id),o(null),setTimeout(()=>{S(M,t)},ie.MODE_CLEAR_DELAY)}else setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY);return!0}if(a&&a.mode==="PATROL_MOVE"){const{sourceCoords:m,sourceCard:g,isDeployAbility:C,readyStatusToRemove:k}=a;if(!m||!g)return!1;if(t.row===m.row&&t.col===m.col)return f(m,C,!1,k),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0;const R=t.row===m.row,O=t.col===m.col;return!R&&!O||r.board[t.row][t.col].card!==null?!1:(A({card:g,source:"board",boardCoords:m},{target:"board",boardCoords:t}),f(t,C,!1,k),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0)}if(a&&a.mode==="RIOT_MOVE"){const{sourceCoords:m,sourceCard:g,isDeployAbility:C,readyStatusToRemove:k,payload:R}=a;return!m||!g||!(R!=null&&R.vacatedCoords)?!1:t.row===R.vacatedCoords.row&&t.col===R.vacatedCoords.col?(A({card:g,source:"board",boardCoords:m},{target:"board",boardCoords:t}),f(t,C,!1,k),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0):(f(m,C,!1,k),o(null),!0)}if(a&&a.mode==="IMMUNIS_RETRIEVE"){const{sourceCoords:m,payload:g,isDeployAbility:C,readyStatusToRemove:k,sourceCard:R}=a;if(!m||!(Math.abs(t.row-m.row)+Math.abs(t.col-m.col)===1))return!1;if((g==null?void 0:g.selectedCardIndex)!==void 0){const U=(R==null?void 0:R.ownerId)||0;return p(U,g.selectedCardIndex,t),f(m,C,!1,k),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0}return!1}if(a&&a.mode==="INTEGRATOR_LINE_SELECT"){const{sourceCoords:m,sourceCard:g,isDeployAbility:C,readyStatusToRemove:k}=a;if(!m||m.row<0)return!1;const R=t.row===m.row,O=t.col===m.col;if(!R&&!O)return!1;const U=(g==null?void 0:g.ownerId)||0;let $=0;if(R)for(let M=0;M<w;M++){const G=r.board[t.row][M].card;G!=null&&G.statuses&&($+=G.statuses.filter(x=>x.type==="Exploit"&&x.addedByPlayerId===U).length)}else for(let M=0;M<w;M++){const G=r.board[M][t.col].card;M!==m.row&&G!=null&&G.statuses&&($+=G.statuses.filter(x=>x.type==="Exploit"&&x.addedByPlayerId===U).length)}return $>0&&(_(U,$),D({row:m.row,col:m.col,text:`+${$}`,playerId:U})),f(m,C,!1,k),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="IP_AGENT_THREAT_SCORING"){const{sourceCoords:m,sourceCard:g,isDeployAbility:C,readyStatusToRemove:k}=a;if(!m)return!1;const R=t.row===m.row,O=t.col===m.col;if(!R&&!O)return!1;const U=(g==null?void 0:g.ownerId)||0;let $=0;if(R)for(let G=0;G<w;G++){const x=r.board[t.row][G].card;x!=null&&x.statuses&&($+=x.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===U).length)}else for(let G=0;G<w;G++){const x=r.board[G][t.col].card;G!==m.row&&x!=null&&x.statuses&&($+=x.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===U).length)}const M=$*2;return M>0&&(_(U,M),D({row:m.row,col:m.col,text:`+${M}`,playerId:U})),f(m,C,!1,k),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="ZIUS_LINE_SELECT"){const{sourceCoords:m,sourceCard:g,isDeployAbility:C,readyStatusToRemove:k}=a,R=i.lastMovedCardCoords||m;if(!R)return!1;const O=t.row===R.row,U=t.col===R.col;if(!O&&!U)return!1;const $=(g==null?void 0:g.ownerId)||0;let M=0;const G=[];if(O)for(let x=0;x<w;x++){const q=r.board[t.row][x].card;if(q!=null&&q.statuses){const Z=q.statuses.filter(J=>J.type==="Exploit"&&J.addedByPlayerId===$);M+=Z.length,Z.length>0&&G.push({row:t.row,col:x})}}else for(let x=0;x<w;x++){const q=r.board[x][t.col].card;if(x!==R.row&&q!=null&&q.statuses){const Z=q.statuses.filter(J=>J.type==="Exploit"&&J.addedByPlayerId===$);M+=Z.length,Z.length>0&&G.push({row:x,col:t.col})}}return M>0&&(_($,M),G.forEach(x=>{D({row:x.row,col:x.col,text:"+1",playerId:$})})),f(m||R,C,!1,k),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0}return a!=null&&a.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","SELECT_LINE_START","SELECT_DIAGONAL"].includes(a.mode)?(u(t),!0):d!=null&&d.card&&d.sourceCoords?(y({card:d.card,source:"hand",playerId:d.playerId,cardIndex:d.cardIndex},{location:"board",row:t.row,col:t.col}),!0):!1}function Gi(t,e,r,n){var _;const{gameState:a,localPlayerId:o,abilityMode:c,cursorStack:i,interactionLock:s,setCommandContext:d,setAbilityMode:E,moveItem:P,markAbilityUsed:S,handleActionExecution:y,triggerHandCardSelection:A,setCursorStack:f,clearTargetingMode:I,clearValidTargets:p}=n;if(!s.current){if(i){if(["Aim","Exploit","Stun","Shield"].includes(i.type))return;const u={targetOwnerId:i.targetOwnerId,excludeOwnerId:i.excludeOwnerId,onlyOpponents:i.onlyOpponents||i.targetOwnerId===-1,onlyFaceDown:i.onlyFaceDown,targetType:i.targetType,requiredTargetStatus:i.requiredTargetStatus,tokenType:i.type};if(lt({card:e,ownerId:t.id,location:"hand"},u,a.activePlayerId,a.players)&&i.type==="Revealed"){const T=((_=i.sourceCard)==null?void 0:_.ownerId)??a.activePlayerId??o??1;e.statuses||(e.statuses=[]),e.statuses.some(g=>g.type==="Revealed"&&g.addedByPlayerId===T)||(e.statuses.push({type:"Revealed",addedByPlayerId:T}),P({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:t.id,cardIndex:r}),i.sourceCoords&&i.sourceCoords.row>=0&&S(i.sourceCoords,i.isDeployAbility,!1,i.readyStatusToRemove),i.count>1?f(g=>g?{...g,count:g.count-1}:null):(I(),p==null||p(),i.chainedAction&&y(i.chainedAction,i.sourceCoords||{row:-1,col:-1}),f(null)))}return}if((c==null?void 0:c.type)==="ENTER_MODE"&&c.mode==="SELECT_TARGET"){const{payload:D,sourceCoords:u,isDeployAbility:w,sourceCard:T,readyStatusToRemove:m}=c;if(A(t.id,r,a.activePlayerId??o??1),D.actionType==="SELECT_HAND_FOR_DEPLOY"){if(D.filter&&!D.filter(e))return;d(g=>({...g,selectedHandCard:{playerId:t.id,cardIndex:r}})),E({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,payload:{range:"global",moveFromHand:!0}});return}if(D.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(D.filter&&!D.filter(e)||t.id!==(T==null?void 0:T.ownerId))return;P({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),I(),p==null||p();const g={type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:T,sourceCoords:u,isDeployAbility:w,payload:{tokenName:D.tokenName}};E(g),u&&u.row>=0&&setTimeout(()=>{y(g,u)},0);return}if(D.actionType==="LUCIUS_SETUP"){if(t.id!==(T==null?void 0:T.ownerId))return;P({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),y({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:T,sourceCoords:u,isDeployAbility:w,payload:{filterType:"Command"}},u||{row:-1,col:-1}),E(null);return}if(D.actionType==="DESTROY"){if(D.filter&&!D.filter(e))return;P({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),u&&u.row>=0&&S(u,w,!1,m),setTimeout(()=>E(null),ie.MODE_CLEAR_DELAY)}}}}function Ui(t,e,r){const{abilityMode:n,cursorStack:a,interactionLock:o,gameState:c,activateAbility:i}=r;n||a||o.current||c.isGameStarted&&c.activePlayerId===t.id&&ws(e,"setup",c.currentPhase)&&i(e,{row:-1,col:-1})}function xi(t,e){var w,T,m,g,C;const{gameState:r,localPlayerId:n,abilityMode:a,interactionLock:o,setAbilityMode:c,markAbilityUsed:i,updatePlayerScore:s,triggerFloatingText:d,nextPhase:E,modifyBoardCardPower:P,scoreLine:S,scoreDiagonal:y,commandContext:A}=e;if(!a)return!1;const{mode:f,sourceCard:I,sourceCoords:p,payload:_,isDeployAbility:D,readyStatusToRemove:u}=a;if(f==="SCORE_LAST_PLAYED_LINE"&&a.sourceCoords){if(o.current)return!0;const{row:k,col:R}=a.sourceCoords,{row:O,col:U}=t;if(k!==O&&R!==U)return!0;o.current=!0;const $=r.activePlayerId,M=r.board.length;let G=k,x=k,q=R,Z=R;if(k===O)G=k,x=k,q=0,Z=M-1;else if(R===U)q=U,Z=U,G=0,x=M-1;else return o.current=!1,!0;const J=r.board.some(j=>j.some(De=>{var Oe,Re;return((Oe=De.card)==null?void 0:Oe.ownerId)===$&&De.card.name.toLowerCase().includes("data liberator")&&((Re=De.card.statuses)==null?void 0:Re.some(Ge=>Ge.type==="Support"))}));let de=0;const pe=[];for(let j=G;j<=x;j++)for(let De=q;De<=Z;De++){const Re=r.board[j][De].card;if(Re&&!((w=Re.statuses)!=null&&w.some(Ge=>Ge.type==="Stun"))){const Ge=Re.ownerId===$,Me=(T=Re.statuses)==null?void 0:T.some(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===$);if(Ge||J&&Me&&Re.ownerId!==$){const _e=Math.max(0,Re.power+(Re.powerModifier||0)+(Re.bonusPower||0));_e>0&&(de+=_e,pe.push({row:j,col:De,text:`+${_e}`,playerId:$}))}}}return c(null),pe.length>0&&d(pe),de>0&&s($,de),E(),setTimeout(()=>{o.current=!1},200),!0}if(f==="SELECT_LINE_START")return c({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:I,sourceCoords:p,isDeployAbility:D,payload:{..._,firstCoords:t}}),!0;if(f==="SELECT_LINE_END"&&(_!=null&&_.firstCoords)){const{row:k,col:R}=_.firstCoords,{row:O,col:U}=t;if(k!==O&&R!==U)return!0;const $=_.actionType,M=(I==null?void 0:I.ownerId)??((m=r.players.find(G=>G.id===r.activePlayerId))!=null&&m.isDummy?r.activePlayerId:n||r.activePlayerId);if($==="ZIUS_SCORING"){const G=A.lastMovedCardCoords;if(G){const j=k===O&&G.row===k,De=R===U&&G.col===R;if(!j&&!De)return!0}const x=r.board.length;let q=0,Z=x-1,J=0,de=x-1;if(k===O)q=Z=k;else if(R===U)J=de=R;else return!0;let pe=0;for(let j=q;j<=Z;j++)for(let De=J;De<=de;De++){const Oe=r.board[j][De];Oe.card&&(pe+=((g=Oe.card.statuses)==null?void 0:g.filter(Re=>Re.type==="Exploit"&&Re.addedByPlayerId===M).length)||0)}pe>0&&M&&(p&&d({row:p.row,col:p.col,text:`+${pe}`,playerId:M}),s(M,pe)),p&&p.row>=0&&i(p,D,!1,u)}else if($==="CENTURION_BUFF"&&I&&p&&M){const G=r.board.length;let x=0,q=G-1,Z=0,J=G-1;k===O?x=q=k:Z=J=R;for(let de=x;de<=q;de++)for(let pe=Z;pe<=J;pe++){const j=r.board[de][pe].card;if(j){const De=j.id===I.id,Oe=j.ownerId===M,Re=r.players.find(_e=>_e.id===M),Ge=r.players.find(_e=>_e.id===j.ownerId),Me=(Re==null?void 0:Re.teamId)!==void 0&&(Ge==null?void 0:Ge.teamId)!==void 0&&Re.teamId===Ge.teamId;!De&&(Oe||Me)&&P({row:de,col:pe},1)}}i(p,D,!1,u)}else($==="SCORE_LINE"||!$)&&(S(k,R,O,U,M),_.skipNextPhase||E());return setTimeout(()=>c(null),ie.MODE_CLEAR_DELAY),!0}if(f==="SELECT_DIAGONAL"&&_.actionType==="SCORE_DIAGONAL"){const k=(I==null?void 0:I.ownerId)??((C=r.players.find(R=>R.id===r.activePlayerId))!=null&&C.isDummy?r.activePlayerId:n||r.activePlayerId);if(_.firstCoords){const{row:R,col:O}=_.firstCoords,{row:U,col:$}=t;return Math.abs(R-U)!==Math.abs(O-$)?(c(null),!0):(y(R,O,U,$,k,_.bonusType),_.skipNextPhase||E(),c(null),!0)}else return c({...a,payload:{..._,firstCoords:t}}),!0}return!1}function $i(t,e,r){const{gameState:n,localPlayerId:a,abilityMode:o,interactionLock:c,handleLineSelection:i}=r;if(!o||o.type!=="ENTER_MODE"||c.current||o.sourceCard&&o.sourceCard.id===t.id&&o.mode!=="SELECT_LINE_START"&&o.mode!=="INTEGRATOR_LINE_SELECT"&&o.mode!=="ZIUS_LINE_SELECT"&&o.mode!=="IP_AGENT_THREAT_SCORING"&&o.mode!=="SELECT_UNIT_FOR_MOVE"&&o.mode!=="SELECT_TARGET"&&o.mode!=="RIOT_PUSH"&&o.mode!=="RIOT_MOVE"&&o.mode!=="REVEREND_DOUBLE_EXPLOIT"&&o.mode!=="SHIELD_SELF_THEN_RIOT_PUSH")return!1;const{mode:s,payload:d,sourceCard:E}=o;return s==="SELECT_LINE_START"||s==="SELECT_LINE_END"?(i(e),!0):s==="SELECT_TARGET"&&d.tokenType?Hi(t,e,r):s==="SELECT_TARGET"?Fi(t,e,r):s==="RIOT_PUSH"?Wi(t,e,r):s==="SHIELD_SELF_THEN_RIOT_PUSH"?Yi(t,e,r):s==="RIOT_MOVE"?Bi(t,e,r):s==="SWAP_POSITIONS"?zi(t,e,r):s==="TRANSFER_STATUS_SELECT"||s==="TRANSFER_ALL_STATUSES"?Ki(t,e,r):s==="ZEALOUS_WEAKEN"?qi(t,e,r):s==="REVEREND_DOUBLE_EXPLOIT"?Vi(t,e,r):s==="SELECT_UNIT_FOR_MOVE"?ji(t,e,r):s==="PATROL_MOVE"?Ji(t,e,r):s==="SPAWN_TOKEN"?Xi(t,e,r):s==="REVEAL_ENEMY"?Zi(t,e,r):s==="SELECT_CELL"?Qi(t,e,r):s==="IMMUNIS_RETRIEVE"?ed(t,e,r):s==="INTEGRATOR_LINE_SELECT"?td(t,e,r):s==="IP_AGENT_THREAT_SCORING"?rd(t,e,r):s==="ZIUS_LINE_SELECT"?nd(t,e,r):s==="SELECT_DIAGONAL"?ad(t,e,r):s==="SCORE_LAST_PLAYED_LINE"?od(t,e,r):s==="SEARCH_DECK"?sd(t,e,r):s==="RETRIEVE_DEVICE"?id(t,e,r):s==="SELECT_DECK"?dd(t,e,r):!1}function Hi(t,e,r){const{abilityMode:n,triggerClickWave:a,moveItem:o,markAbilityUsed:c,setAbilityMode:i,setCommandContext:s,handleActionExecution:d,clearValidTargets:E}=r,{payload:P,sourceCoords:S,isDeployAbility:y,readyStatusToRemove:A}=n;if(P.filter&&!P.filter(t,e.row,e.col))return!1;if(o({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:P.tokenType,count:P.count||1},{target:"board",boardCoords:e}),a("board",e),P.recordContext&&s({lastMovedCardCoords:e,lastMovedCardId:t.id}),P.chainedAction){const f={...P.chainedAction,sourceCard:P.chainedAction.sourceCard??t,sourceCoords:P.chainedAction.sourceCoords??e,isDeployAbility:y,recordContext:!0};d(f,e),setTimeout(()=>a("board",e),100),f.type!=="ENTER_MODE"&&(i(null),E())}else S&&S.row>=0&&c(S,y,!1,A),setTimeout(()=>{i(null),E()},ie.MODE_CLEAR_DELAY);return!0}function Fi(t,e,r){var T,m,g,C,k;const{abilityMode:n,markAbilityUsed:a,setAbilityMode:o,moveItem:c,modifyBoardCardPower:i,addBoardCardStatus:s,removeBoardCardStatus:d,removeBoardCardStatusByOwner:E,removeStatusByType:P,resetDeployStatus:S,setCounterSelectionData:y,handleActionExecution:A,gameState:f,destroyCard:I}=r,{payload:p,sourceCoords:_,isDeployAbility:D,readyStatusToRemove:u}=n,w=((T=n.sourceCard)==null?void 0:T.ownerId)??((m=f.players.find(R=>R.id===f.activePlayerId))!=null&&m.isDummy?f.activePlayerId:r.localPlayerId||f.activePlayerId);if(p.actionType==="OPEN_COUNTER_MODAL")return p.filter&&!p.filter(t)?!1:(y({card:t,callbackAction:p.rewardType}),o(null),!0);if(p.actionType==="SACRIFICE_AND_BUFF_LINES"){if(p.filter&&!p.filter(t,e.row,e.col))return!1;const R=((g=n.sourceCard)==null?void 0:g.ownerId)??w;c({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"discard",playerId:t.ownerId});const O=f.board.length,{row:U,col:$}=e;for(let M=0;M<O;M++){if(M===$)continue;const x=f.board[U][M].card;x&&x.ownerId===R&&i({row:U,col:M},1)}for(let M=0;M<O;M++){if(M===U)continue;const x=f.board[M][$].card;x&&x.ownerId===R&&i({row:M,col:$},1)}return a(_||e,D,!1,u),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0}if(p.actionType==="SHIELD_AND_REMOVE_AIM")return p.filter&&!p.filter(t)?!1:(s(e,"Shield",w),P(e,"Aim"),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0);if(p.actionType==="RESET_DEPLOY")return p.filter&&!p.filter(t)?!1:(S(e),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0);if(p.actionType==="MODIFY_POWER")return p.filter&&!p.filter(t)?!1:(p.amount&&i(e,p.amount),_&&_.row>=0&&a(_,D,!1,u),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0);if(p.actionType==="DESTROY")return p.filter&&!p.filter(t)?!1:((C=t.statuses)==null?void 0:C.some(O=>O.type==="Shield"))?(d(e,"Shield"),a(_||e,D,!1,u),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0):(I(t,e),a(_||e,D,!1,u),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0);if(p.actionType==="LUCIUS_SETUP")return p.filter&&!p.filter(t)?!1:(c({card:t,source:"board",boardCoords:e},{target:"discard",playerId:t.ownerId}),p.chainedAction&&A(p.chainedAction,e),!0);if(p.actionType==="CENSOR_SWAP"){if(p.filter&&!p.filter(t))return!1;const R=((k=t.statuses)==null?void 0:k.filter(O=>O.type==="Exploit"&&O.addedByPlayerId===w).length)||0;if(R>0){E(e,"Exploit",w);for(let O=0;O<R;O++)s(e,"Stun",w)}return a(_||e,D,!1,u),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0}if(p.actionType==="REVEAL_ENEMY_CHAINED"){if(p.filter&&!p.filter(t,e.row,e.col))return!1;const R=t.ownerId;if(n.chainedAction){const O={...n.chainedAction,targetOwnerId:R,sourceCoords:_||e,sourceCard:n.sourceCard};A(O,e)}return a(_||e,D,!1,u),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0}return!1}function Wi(t,e,r){const{abilityMode:n,gameState:a,setAbilityMode:o,moveItem:c,markAbilityUsed:i,interactionLock:s}=r;if(s.current)return!1;const{sourceCoords:d,isDeployAbility:E,readyStatusToRemove:P,sourceCard:S}=n;if(!d||d.row<0)return!1;if(e.row===d.row&&e.col===d.col)return i(d,E,!1,P),setTimeout(()=>o(null),ie.MODE_CLEAR_DELAY),!0;const y=Math.abs(e.row-d.row)+Math.abs(e.col-d.col)===1,A=a.players.find(C=>C.id===t.ownerId),f=a.players.find(C=>C.id===(S==null?void 0:S.ownerId)),I=(A==null?void 0:A.teamId)!==void 0&&(f==null?void 0:f.teamId)!==void 0&&A.teamId===f.teamId;if(!y||t.ownerId===(S==null?void 0:S.ownerId)||I)return!1;const p=e.row-d.row,_=e.col-d.col,D=e.row+p,u=e.col+_,w=a.board.length,T=Math.floor((w-a.activeGridSize)/2),m=T,g=T+a.activeGridSize-1;return D<m||D>g||u<m||u>g||a.board[D][u].card!==null?!1:(c({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:D,col:u}}),o({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:S,sourceCoords:d,isDeployAbility:E,payload:{vacatedCoords:e}}),!0)}function Bi(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:o,setAbilityMode:c}=r;if(!n||n.mode!=="RIOT_MOVE")return!1;const{sourceCoords:i,sourceCard:s,isDeployAbility:d,readyStatusToRemove:E,payload:P}=n;return!i||!s||!(P!=null&&P.vacatedCoords)?!1:e.row===P.vacatedCoords.row&&e.col===P.vacatedCoords.col?(a({card:s,source:"board",boardCoords:i},{target:"board",boardCoords:e}),o(e,d,!1,E),setTimeout(()=>c(null),ie.MODE_CLEAR_DELAY),!0):(o(i,d,!1,E),c(null),!0)}function Yi(t,e,r){const{abilityMode:n,gameState:a,setAbilityMode:o,addBoardCardStatus:c,markAbilityUsed:i,interactionLock:s,setTargetingMode:d,commandContext:E,moveItem:P}=r;if(s.current)return!1;const{sourceCoords:S,isDeployAbility:y,readyStatusToRemove:A,sourceCard:f}=n;if(!S||S.row<0||!f)return!1;const I=f.ownerId;if(e.row===S.row&&e.col===S.col){c(S,"Shield",I);const w={type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:f,sourceCoords:S,isDeployAbility:y,readyStatusToRemove:A,payload:{}};o(w);const T=S.row,m=S.col,g=[],C=[[-1,0],[1,0],[0,-1],[0,1]],k=a.board.length,R=Math.floor((k-a.activeGridSize)/2),O=R,U=R+a.activeGridSize-1;for(const[$,M]of C){const G=T+$,x=m+M;if(G>=O&&G<=U&&x>=O&&x<=U){const q=a.board[G][x];if(q.card){const Z=a.players.find(pe=>pe.id===q.card.ownerId),J=a.players.find(pe=>pe.id===I),de=(Z==null?void 0:Z.teamId)!==void 0&&(J==null?void 0:J.teamId)!==void 0&&Z.teamId===J.teamId;q.card.ownerId!==I&&!de&&g.push({row:G,col:x})}}}return d(w,I,S,g,E),!0}const p=Math.abs(e.row-S.row)+Math.abs(e.col-S.col)===1,_=a.players.find(w=>w.id===t.ownerId),D=a.players.find(w=>w.id===I),u=(_==null?void 0:_.teamId)!==void 0&&(D==null?void 0:D.teamId)!==void 0&&_.teamId===D.teamId;if(p&&t.ownerId!==I&&!u){const w=e.row-S.row,T=e.col-S.col,m=e.row+w,g=e.col+T,C=a.board.length,k=Math.floor((C-a.activeGridSize)/2),R=k,O=k+a.activeGridSize-1;return m<R||m>O||g<R||g>O||a.board[m][g].card!==null?!1:(P({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:m,col:g}}),o({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:f,sourceCoords:S,isDeployAbility:y,payload:{vacatedCoords:e}}),!0)}return!1}function zi(t,e,r){const{abilityMode:n,gameState:a,swapCards:o,markAbilityUsed:c,setAbilityMode:i,validTargets:s}=r;if(!n||n.mode!=="SWAP_POSITIONS")return!1;const{sourceCoords:d,sourceCard:E,isDeployAbility:P,readyStatusToRemove:S,payload:y}=n;if(!d||d.row<0)return!1;const A=a.board[d.row][d.col].card;return!A||A.id!==(E==null?void 0:E.id)?(i(null),!1):E&&E.id===t.id||y.filter&&!y.filter(t,e.row,e.col)||!y.filter&&s&&!s.some(I=>I.row===e.row&&I.col===e.col)?!1:(o(d,e),c(e,P,!1,S),setTimeout(()=>i(null),ie.MODE_CLEAR_DELAY),!0)}function Ki(t,e,r){const{abilityMode:n,transferAllStatusesWithoutException:a,markAbilityUsed:o,setAbilityMode:c}=r;if(!n||n.mode!=="TRANSFER_STATUS_SELECT"&&n.mode!=="TRANSFER_ALL_STATUSES")return!1;const{sourceCoords:i,sourceCard:s,isDeployAbility:d,readyStatusToRemove:E,payload:P}=n;if(!i||i.row<0||s&&s.id===t.id||P!=null&&P.filter&&!P.filter(t))return!1;if(n.mode==="TRANSFER_ALL_STATUSES"){if(!t.statuses||t.statuses.length===0)return!1;const S=["Aim","Exploit","Rule","Shield","Stun"];if(!t.statuses.some(y=>S.includes(y.type)))return!1}return n.mode==="TRANSFER_ALL_STATUSES"&&a(e,i),o(i,d,!1,E),setTimeout(()=>c(null),ie.MODE_CLEAR_DELAY),!0}function qi(t,e,r){const{abilityMode:n,modifyBoardCardPower:a,markAbilityUsed:o,setAbilityMode:c}=r;if(!n||n.mode!=="ZEALOUS_WEAKEN")return!1;const{payload:i,sourceCoords:s,isDeployAbility:d,readyStatusToRemove:E}=n;return i.filter&&!i.filter(t)?!1:(a(e,-1),o(s||e,d,!1,E),setTimeout(()=>c(null),ie.MODE_CLEAR_DELAY),!0)}function Vi(t,e,r){const{abilityMode:n,addBoardCardStatus:a,markAbilityUsed:o,triggerFloatingText:c,setAbilityMode:i}=r;if(!n||n.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:E,readyStatusToRemove:P}=n,S=(d==null?void 0:d.ownerId)||0,y=(t.statuses||[]).filter(A=>A.type==="Exploit"&&A.addedByPlayerId===S).length;if(y>0){for(let A=0;A<y;A++)a(e,"Exploit",S);c({row:e.row,col:e.col,text:`+${y}`,playerId:S,timestamp:Date.now()})}return o(s||e,E,!1,P),setTimeout(()=>i(null),ie.MODE_CLEAR_DELAY),!0}function ji(t,e,r){const{abilityMode:n,setAbilityMode:a}=r;if(!n||n.mode!=="SELECT_UNIT_FOR_MOVE")return!1;const{sourceCard:o,payload:c,isDeployAbility:i,readyStatusToRemove:s}=n;return o&&o.id===t.id||c.filter&&!c.filter(t,e.row,e.col)?!1:(a({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,sourceCoords:e,isDeployAbility:i,readyStatusToRemove:s,payload:{range:c.range||2,moveFromHand:c.moveFromHand||!1,selectedCard:t,allowSelf:!1}}),!0)}function Ji(t,e,r){const{abilityMode:n,gameState:a,moveItem:o,markAbilityUsed:c,setAbilityMode:i}=r;if(!n||n.mode!=="PATROL_MOVE")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:E,readyStatusToRemove:P}=n;if(!s||!d)return!1;if(e.row===s.row&&e.col===s.col)return c(s,E,!1,P),setTimeout(()=>i(null),ie.MODE_CLEAR_DELAY),!0;const S=e.row===s.row,y=e.col===s.col;return!S&&!y||a.board[e.row][e.col].card!==null?!1:(o({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:e}),c(e,E,!1,P),setTimeout(()=>i(null),ie.MODE_CLEAR_DELAY),!0)}function Xi(t,e,r){var A;const{abilityMode:n,spawnToken:a,markAbilityUsed:o,setAbilityMode:c}=r;if(!n||n.mode!=="SPAWN_TOKEN")return!1;const{sourceCoords:i,payload:s,isDeployAbility:d,readyStatusToRemove:E,sourceCard:P}=n;if(!i||!(s!=null&&s.tokenName)||!(Math.abs(e.row-i.row)+Math.abs(e.col-i.col)===1))return!1;const y=(P==null?void 0:P.ownerId)??((A=n.sourceCard)==null?void 0:A.ownerId);return a(e,s.tokenName,y),o(i,d,!1,E),setTimeout(()=>c(null),ie.MODE_CLEAR_DELAY),!0}function Zi(t,e,r){var D;const{abilityMode:n,setAbilityMode:a,setCursorStack:o,markAbilityUsed:c,gameState:i,localPlayerId:s}=r;if(!n||n.mode!=="REVEAL_ENEMY")return!1;const{sourceCoords:d,sourceCard:E,isDeployAbility:P,readyStatusToRemove:S}=n;if(!d||!E||!(Math.abs(e.row-d.row)+Math.abs(e.col-d.col)===1)||t.deck==="Tokens"||((D=t.types)==null?void 0:D.includes("Token")))return!1;const f=t.ownerId,I=i.players.find(u=>u.id===i.activePlayerId),p=I!=null&&I.isDummy&&i.activePlayerId!==null?i.activePlayerId:s??0;return o(Tr("Revealed",p,null,{targetOwnerId:f,onlyFaceDown:!0,sourceCoords:e,sourceCard:t,isDeployAbility:P,readyStatusToRemove:S})),c(d,P,!1,S),setTimeout(()=>a(null),ie.MODE_CLEAR_DELAY),!0}function Qi(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:o,setAbilityMode:c}=r;if(!n||n.mode!=="SELECT_CELL")return!1;const{sourceCoords:i,sourceCard:s,isDeployAbility:d,readyStatusToRemove:E,payload:P}=n;return P!=null&&P.filter&&!P.filter(null,e.row,e.col)?!1:(P!=null&&P.moveFromHand&&(P!=null&&P.selectedCard)?a({card:P.selectedCard,source:"hand"},{target:"board",boardCoords:e}):i&&i.row>=0&&s&&a({card:s,source:"board",boardCoords:i},{target:"board",boardCoords:e}),o(i||e,d,!1,E),setTimeout(()=>c(null),ie.MODE_CLEAR_DELAY),!0)}function ed(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:o,setAbilityMode:c}=r;if(!n||n.mode!=="IMMUNIS_RETRIEVE")return!1;const{sourceCoords:i,payload:s,isDeployAbility:d,readyStatusToRemove:E}=n;return!i||!(Math.abs(e.row-i.row)+Math.abs(e.col-i.col)===1)?!1:s!=null&&s.selectedCard?(a({card:s.selectedCard,source:"discard"},{target:"board",boardCoords:e}),o(i,d,!1,E),setTimeout(()=>c(null),ie.MODE_CLEAR_DELAY),!0):!1}function td(t,e,r){const{abilityMode:n,gameState:a,markAbilityUsed:o,updatePlayerScore:c,triggerFloatingText:i,setAbilityMode:s}=r;if(!n||n.mode!=="INTEGRATOR_LINE_SELECT")return!1;const{sourceCoords:d,sourceCard:E,isDeployAbility:P,readyStatusToRemove:S}=n,y=(E==null?void 0:E.ownerId)||0,A=d!==void 0&&e.row===d.row,f=d!==void 0&&e.col===d.col;if(!A&&!f)return!1;let I=0;if(A&&d)for(let p=0;p<a.board.length;p++){const _=a.board[e.row][p].card;_!=null&&_.statuses&&(I+=_.statuses.filter(D=>D.type==="Exploit"&&D.addedByPlayerId===y).length)}else if(d)for(let p=0;p<a.board.length;p++){const _=a.board[p][e.col].card;p!==d.row&&_!=null&&_.statuses&&(I+=_.statuses.filter(D=>D.type==="Exploit"&&D.addedByPlayerId===y).length)}return I>0&&(c(y,I),i({row:d.row,col:d.col,text:`+${I}`,playerId:y,timestamp:Date.now()})),o(d||e,P,!1,S),setTimeout(()=>s(null),ie.MODE_CLEAR_DELAY),!0}function rd(t,e,r){const{abilityMode:n,gameState:a,updatePlayerScore:o,triggerFloatingText:c,markAbilityUsed:i,setAbilityMode:s}=r;if(!n||n.mode!=="IP_AGENT_THREAT_SCORING")return!1;const{sourceCoords:d,sourceCard:E,isDeployAbility:P,readyStatusToRemove:S}=n,y=(E==null?void 0:E.ownerId)||0;if(!d)return!1;const A=e.row===d.row,f=e.col===d.col;if(!A&&!f)return!1;let I=0;if(A)for(let _=0;_<a.board.length;_++){const D=a.board[e.row][_].card;D!=null&&D.statuses&&(I+=D.statuses.filter(u=>u.type==="Threat"&&u.addedByPlayerId===y).length)}else for(let _=0;_<a.board.length;_++){const D=a.board[_][e.col].card;_!==d.row&&D!=null&&D.statuses&&(I+=D.statuses.filter(u=>u.type==="Threat"&&u.addedByPlayerId===y).length)}const p=I*2;return p>0&&(o(y,p),c({row:d.row,col:d.col,text:`+${p}`,playerId:y,timestamp:Date.now()})),i(d||e,P,!1,S),setTimeout(()=>s(null),ie.MODE_CLEAR_DELAY),!0}function nd(t,e,r){const{abilityMode:n,gameState:a,commandContext:o,updatePlayerScore:c,triggerFloatingText:i,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="ZIUS_LINE_SELECT")return!1;const{sourceCoords:E,sourceCard:P,isDeployAbility:S,readyStatusToRemove:y}=n,A=(P==null?void 0:P.ownerId)||0,f=o.lastMovedCardCoords||E;if(!f)return!1;const I=e.row===f.row,p=e.col===f.col;if(!I&&!p)return!1;let _=0;const D=[];if(I)for(let u=0;u<a.board.length;u++){const w=a.board[e.row][u].card;if(w!=null&&w.statuses){const T=w.statuses.filter(m=>m.type==="Exploit"&&m.addedByPlayerId===A);_+=T.length,T.length>0&&D.push({row:e.row,col:u})}}else for(let u=0;u<a.board.length;u++){const w=a.board[u][e.col].card;if(u!==f.row&&w!=null&&w.statuses){const T=w.statuses.filter(m=>m.type==="Exploit"&&m.addedByPlayerId===A);_+=T.length,T.length>0&&D.push({row:u,col:e.col})}}return _>0&&(c(A,_),D.forEach(u=>{i({row:u.row,col:u.col,text:"+1",playerId:A,timestamp:Date.now()})})),s(E||e,S,!1,y),setTimeout(()=>d(null),ie.MODE_CLEAR_DELAY),!0}function ad(t,e,r){var m;const{abilityMode:n,gameState:a,markAbilityUsed:o,updatePlayerScore:c,triggerFloatingText:i,setAbilityMode:s}=r;if(!n||n.mode!=="SELECT_DIAGONAL")return!1;const{sourceCoords:d,sourceCard:E,isDeployAbility:P,readyStatusToRemove:S,payload:y}=n,A=(E==null?void 0:E.ownerId)||0,{row:f,col:I}=e,{row:p,col:_}=d||{row:0,col:0},D=f-I===p-_,u=f+I===p+_;if(!D&&!u)return!1;if(y!=null&&y.selectForMove&&t)return y.chainedAction&&r.handleActionExecution(y.chainedAction,e),!0;let w=0;const T=a.board.length;if(D){const g=p-_;for(let C=0;C<T;C++){const k=g+C,R=C;if(k>=0&&k<T&&R>=0&&R<T){const O=a.board[k][R].card;O!=null&&O.statuses&&(w+=O.statuses.filter(U=>U.type==="Exploit"&&U.addedByPlayerId===A).length)}}}if(u){const g=p+_;for(let C=0;C<T;C++){const k=C,R=g-k;if(k>=0&&k<T&&R>=0&&R<T){const O=a.board[k][R].card;O!=null&&O.statuses&&(w+=O.statuses.filter(U=>U.type==="Exploit"&&U.addedByPlayerId===A).length)}}}return y!=null&&y.bonusForSupport&&((m=E==null?void 0:E.statuses)!=null&&m.some(g=>g.type==="Support"))&&(w+=y.bonusForSupport),w>0&&(c(A,w),i({row:(d==null?void 0:d.row)||e.row,col:(d==null?void 0:d.col)||e.col,text:`+${w}`,playerId:A,timestamp:Date.now()})),o(d||e,P,!1,S),setTimeout(()=>s(null),ie.MODE_CLEAR_DELAY),!0}function od(t,e,r){const{abilityMode:n,gameState:a,commandContext:o,markAbilityUsed:c,updatePlayerScore:i,triggerFloatingText:s,setAbilityMode:d}=r;if(!n||n.mode!=="SCORE_LAST_PLAYED_LINE")return!1;const{sourceCoords:E,sourceCard:P,isDeployAbility:S,readyStatusToRemove:y,payload:A}=n,f=(P==null?void 0:P.ownerId)||0,I=o.lastMovedCardCoords;if(!I)return!1;const p=a.board[I.row][I.col].card;if(!p)return!1;const _=e.row===I.row,D=e.col===I.col;if(!_&&!D)return!1;const u=Math.max(0,p.power+(p.powerModifier||0));return(A==null?void 0:A.rewardType)==="SCORE"?(i(f,u),s({row:I.row,col:I.col,text:`+${u}`,playerId:f,timestamp:Date.now()})):A==null||A.rewardType,c(E||e,S,!1,y),setTimeout(()=>d(null),ie.MODE_CLEAR_DELAY),!0}function sd(t,e,r){const{abilityMode:n,setViewingDiscard:a,markAbilityUsed:o,setAbilityMode:c}=r;if(!n||n.mode!=="SEARCH_DECK")return!1;const{sourceCoords:i,isDeployAbility:s,readyStatusToRemove:d}=n;return a(!0),o(i||e,s,!1,d),c(null),!0}function id(t,e,r){const{abilityMode:n,setViewingDiscard:a,markAbilityUsed:o,setAbilityMode:c}=r;if(!n||n.mode!=="RETRIEVE_DEVICE")return!1;const{sourceCoords:i,isDeployAbility:s,readyStatusToRemove:d}=n;return a(!0),o(i||e,s,!1,d),c(null),!0}function dd(t,e,r){const{abilityMode:n,triggerDeckSelection:a,markAbilityUsed:o,setAbilityMode:c}=r;if(!n||n.mode!=="SELECT_DECK")return!1;const{sourceCoords:i,isDeployAbility:s,readyStatusToRemove:d}=n;return a(t.ownerId??0),o(i||e,s,!1,d),setTimeout(()=>c(null),ie.MODE_CLEAR_DELAY),!0}const Md=({gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,setCursorStack:o,commandContext:c,setCommandContext:i,setViewingDiscard:s,triggerNoTarget:d,triggerClickWave:E,playMode:P,setPlayMode:S,setCounterSelectionData:y,interactionLock:A,onAbilityComplete:f,moveItem:I,destroyCard:p,drawCardsBatch:_,updatePlayerScore:D,markAbilityUsed:u,applyGlobalEffect:w,swapCards:T,transferStatus:m,transferAllCounters:g,transferAllStatusesWithoutException:C,resurrectDiscardedCard:k,spawnToken:R,scoreLine:O,nextPhase:U,modifyBoardCardPower:$,addBoardCardStatus:M,removeBoardCardStatus:G,removeBoardCardStatusByOwner:x,resetDeployStatus:q,scoreDiagonal:Z,removeStatusByType:J,triggerFloatingText:de,triggerHandCardSelection:pe,clearValidTargets:j,setTargetingMode:De,clearTargetingMode:Oe,validTargets:Re})=>{const Ge=H.useRef(()=>{}),Me=H.useCallback(ve=>{xi(ve,{gameState:t,localPlayerId:e,abilityMode:r,interactionLock:A,setAbilityMode:n,markAbilityUsed:u,updatePlayerScore:D,triggerFloatingText:de,nextPhase:U,modifyBoardCardPower:$,scoreLine:O,scoreDiagonal:Z,commandContext:c})},[r,t,e,A,n,u,D,de,U,$,O,Z,c]);Ge.current=Me;const _e=H.useCallback((ve,We)=>{Pi(ve,We,{gameState:t,localPlayerId:e,setAbilityMode:n,setCursorStack:o,commandContext:c,markAbilityUsed:u,triggerNoTarget:d,handleActionExecution:_e,modifyBoardCardPower:$,addBoardCardStatus:M,removeBoardCardStatus:G,removeStatusByType:J,updatePlayerScore:D,triggerFloatingText:de,setViewingDiscard:s,handleLineSelection:Ge.current,onAbilityComplete:f,applyGlobalEffect:w,drawCardsBatch:_,setTargetingMode:De})},[t,e,r,n,a,o,c,i,S,u,d,A,I,p,T,m,g,C,R,$,M,G,x,J,q,D,de,y,s,Re,f,w,_,De]);H.useEffect(()=>{(r==null?void 0:r.type)==="GLOBAL_AUTO_APPLY"&&(_e(r,r.sourceCoords||{row:-1,col:-1}),n(null))},[r,_e,n]),H.useEffect(()=>{r||Oe()},[r,Oe]);const qe=H.useCallback((ve,We)=>{da(ve,We,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,handleActionExecution:_e,markAbilityUsed:u,addBoardCardStatus:M})},[t,e,r,a,_e,u,M]),qt=H.useCallback((ve,We)=>{var Qe,yt,bt;if(a&&S!==null&&S!==void 0){const rt={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};if(lt({card:ve,ownerId:ve.ownerId??0,location:"board"},rt,t.activePlayerId,t.players)){if(a.type==="Revealed"){const nt=((Qe=a.sourceCard)==null?void 0:Qe.ownerId)??t.activePlayerId??e??1;if((yt=ve.statuses)==null?void 0:yt.some(ge=>ge.type==="Revealed"&&ge.addedByPlayerId===nt))return}const Vt=a.originalOwnerId??((bt=a.sourceCard)==null?void 0:bt.ownerId)??t.activePlayerId??e??1;I({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:a.type,ownerId:Vt,count:1},{target:"board",boardCoords:We}),a.sourceCoords&&a.sourceCoords.row>=0&&u(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?o(nt=>nt?{...nt,count:nt.count-1}:null):(Oe(),j(),a.chainedAction&&_e(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),o(null))}return}if(!A.current){if(!r&&!a&&t.isGameStarted&&Ea(ve,t)){qe(ve,We);return}if(r&&(r.mode==="SCORE_LAST_PLAYED_LINE"||r.mode==="SELECT_LINE_END")){Me(We);return}(r==null?void 0:r.type)==="ENTER_MODE"&&$i(ve,We,{gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,setCursorStack:o,commandContext:c,setCommandContext:i,playMode:null,setPlayMode:S,draggedItem:null,setDraggedItem:()=>{},openContextMenu:()=>{},markAbilityUsed:u,triggerNoTarget:d,triggerClickWave:E,triggerDeckSelection:()=>{},handleActionExecution:_e,interactionLock:A,moveItem:I,swapCards:T,transferStatus:m,transferAllCounters:g,transferAllStatusesWithoutException:C,destroyCard:p,spawnToken:R,modifyBoardCardPower:$,addBoardCardStatus:M,removeBoardCardStatus:G,removeBoardCardStatusByOwner:x,removeStatusByType:J,resetDeployStatus:q,updatePlayerScore:D,triggerFloatingText:de,setCounterSelectionData:y,setViewingDiscard:s,clearValidTargets:j,validTargets:Re,handleLineSelection:Me})||!r&&!a&&qe(ve,We)}},[a,S,t,e,A,r,Me,I,p,u,o,_e,n,i,y,s,R,T,m,g,$,M,G,x,J,q,D,de,d,E,Re,Oe,qe]),pt=H.useCallback(ve=>{Li(ve,{gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,commandContext:c,setCommandContext:i,playMode:P,draggedItem:null,interactionLock:A,handleActionExecution:_e,handleDrop:I,moveItem:I,markAbilityUsed:u,spawnToken:R,resurrectDiscardedCard:k,updatePlayerScore:D,triggerFloatingText:de,handleLineSelection:Me})},[t,e,r,n,a,c,i,P,A,_e,I,o,d,u,R,k,D,de,Me]),je=H.useCallback((ve,We,Qe)=>{Gi(ve,We,Qe,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,interactionLock:A,setCommandContext:i,setAbilityMode:n,moveItem:I,markAbilityUsed:u,handleActionExecution:_e,triggerHandCardSelection:pe,setCursorStack:o,clearTargetingMode:Oe,clearValidTargets:j})},[r,a,t,e,_e,u,n,i,pe,I,o,Oe,j,A]),K=H.useCallback((ve,We)=>{Ui(ve,We,{gameState:t,abilityMode:r,cursorStack:a,interactionLock:A,activateAbility:(Qe,yt)=>da(Qe,yt,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,handleActionExecution:_e,markAbilityUsed:u,addBoardCardStatus:M})})},[r,a,t,e,_e,u,n,i,pe,I,o,Oe,j,A]);return{activateAbility:qe,executeAction:_e,handleLineSelection:Me,handleBoardCardClick:qt,handleEmptyCellClick:pt,handleHandCardClick:je,handleAnnouncedCardDoubleClick:K}},ir=(t,e,r,n,a)=>{const o=(r.baseId||t.split("_")[1]||t).toLowerCase(),c=e===-1,i=[];o==="overwatch"?c?i.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):e===0?i.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},targetOwnerId:-1,onlyOpponents:!0,sourceCard:r}):e===1&&i.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:a,baseCount:0}},sourceCard:r}):o==="tacticalmaneuver"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:d=>d.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:r}}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:d=>d.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:r}}}):o==="inspiration"?c&&i.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"OPEN_COUNTER_MODAL",filter:d=>d.ownerId===a}}):o==="datainterception"?c?i.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r}):e===0?i.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:d=>{var E;return((E=d.statuses)==null?void 0:E.some(P=>P.type==="Exploit"&&P.addedByPlayerId===a))||!1}}}):o==="falseorders"?c?i.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):e===0?i.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:a,sourceCard:r,originalOwnerId:r.ownerId}}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:a}}}}):o==="experimentalstimulants"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"RESET_DEPLOY",filter:d=>{var E;return d.ownerId===a&&((E=d.types)==null?void 0:E.includes("Unit"))}}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:"line",filter:d=>d.ownerId===a}}):o==="logisticschain"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):o==="quickresponseteam"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:d=>{var E;return d.ownerId===a&&((E=d.types)==null?void 0:E.includes("Unit"))}}}):e===1&&i.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:r,payload:{filterType:"Unit"}}):o==="temporaryshelter"?e===0?i.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:r,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):e===1&&i.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:r,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):o==="enhancedinterrogation"?c?i.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):e===0?i.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:d=>{var E;return((E=d.statuses)==null?void 0:E.some(P=>P.type==="Aim"&&P.addedByPlayerId===a))||!1}}}):(o==="mobilization1"||o==="linebreach")&&c&&i.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:r,payload:{actionType:"SCORE_LINE"}});const s=r.ownerId||a;return i.forEach(d=>{d.originalOwnerId=s,d.sourceCard&&!d.sourceCard.ownerId&&(d.sourceCard.ownerId=s)}),i},Nd=({gameState:t,localPlayerId:e,setActionQueue:r,setCommandContext:n,setCommandModalCard:a,setCounterSelectionData:o,moveItem:c,updatePlayerScore:i,updateState:s})=>{const d=H.useCallback((S,y)=>{if(e===null)return;const A=t.players.find(_=>_.id===y.playerId);if(!(y.playerId===e||(A==null?void 0:A.isDummy)))return;c(y,{target:"announced",playerId:y.playerId}),n({});const I=(S.baseId||S.id.split("_")[1]||S.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(_=>I.includes(_)))a(S);else{const _=ir(S.id,-1,S,t,y.playerId);_.length>0?r([..._,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:S,ownerId:y.playerId},sourceCard:S}]):r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:S,ownerId:y.playerId},sourceCard:S}])}},[t,e,c,r,n,a]),E=H.useCallback((S,y)=>{var D,u;if(!y||e===null)return;const A=y.ownerId||e,f=[],I=ir(y.id,-1,y,t,A);let p;(D=y.baseId)!=null&&D.toLowerCase().includes("inspiration")&&(p=S===0?"DRAW_REMOVED":"SCORE_REMOVED",I.length>0&&I[0].type==="ENTER_MODE"&&(I[0]={...I[0],payload:{...I[0].payload,rewardType:p}})),I.forEach(w=>{f.push(w)}),ir(y.id,S,y,t,A).forEach(w=>{f.push(w)}),(u=y.baseId)!=null&&u.toLowerCase().includes("inspiration")||f.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:y,ownerId:A},sourceCard:y}),r(f),a(null)},[t,e,r,a]),P=H.useCallback((S,y)=>{var p;if(e===null)return;const A=y.card.ownerId||e;let f=null;for(let _=0;_<t.board.length;_++){for(let D=0;D<t.board[_].length;D++)if(((p=t.board[_][D].card)==null?void 0:p.id)===y.card.id){f={row:_,col:D};break}if(f)break}if(!f){l.warn(`Card ${y.card.id} not found on board during counter removal`),o(null);return}if(s(_=>{if(!_.isGameStarted)return _;const D=fe(_),u=D.board[f.row][f.col].card;let w=0;const T=(u==null?void 0:u.statuses)??[];if(Object.entries(S).forEach(([m,g])=>{for(let C=0;C<g;C++){const k=T.map(R=>R.type).lastIndexOf(m);k>-1&&(u!=null&&u.statuses)&&(u.statuses.splice(k,1),w++)}}),!(u!=null&&u.statuses)&&u&&(u.statuses=[]),D.board=Le(D),w>0&&y.callbackAction==="DRAW_REMOVED"){const m=D.players.find(g=>g.id===A);if(m){const g=Math.min(w,m.deck.length);for(let C=0;C<g;C++){const k=m.deck.shift();k&&m.hand.push(k)}}}return D}),y.callbackAction==="SCORE_REMOVED"){const _=Object.values(S).reduce((D,u)=>D+u,0);_>0&&i(A,_)}const I=t.players.find(_=>_.id===A);I!=null&&I.announcedCard&&r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:I.announcedCard,ownerId:A},sourceCard:I.announcedCard}]),o(null)},[e,i,r,o,t,s]);return{playCommandCard:d,handleCommandConfirm:E,handleCounterSelectionConfirm:P}},Ld=({gameState:t,localPlayerId:e,handleDrop:r,markAbilityUsed:n,requestCardReveal:a,interactionLock:o,setCommandContext:c,onAction:i,cursorStack:s,setCursorStack:d,setAbilityMode:E,triggerClickWave:P,clearTargetingMode:S})=>{const y=H.useRef(null),A=H.useRef({x:0,y:0});return H.useLayoutEffect(()=>{if(s&&y.current){const{x:I,y:p}=A.current;y.current.style.transform=`translate(${I-24}px, ${p-24}px)`}},[s]),H.useEffect(()=>{const I=p=>{A.current={x:p.clientX,y:p.clientY},y.current&&(y.current.style.transform=`translate(${p.clientX-24}px, ${p.clientY-24}px)`)};return window.addEventListener("mousemove",I),()=>window.removeEventListener("mousemove",I)},[]),H.useEffect(()=>{const I=p=>{var w,T,m,g,C,k;if(p.button!==0||!s)return;const _=document.elementFromPoint(p.clientX,p.clientY);let D=e;if(s.originalOwnerId!==void 0)D=s.originalOwnerId;else if((w=s.sourceCard)!=null&&w.ownerId)D=s.sourceCard.ownerId;else if(s.sourceCoords&&s.sourceCoords.row>=0){const{row:R,col:O}=s.sourceCoords;if(R>=0&&R<t.board.length&&O>=0&&O<((T=t.board[R])==null?void 0:T.length)){const U=t.board[R][O].card;U&&(D=U.ownerId||e)}}else if(t.activePlayerId){const R=t.players.find(O=>O.id===t.activePlayerId);R!=null&&R.isDummy&&(D=R.id)}let u=_==null?void 0:_.closest("[data-hand-card]");if(!u&&_)if(_.getAttribute("data-hand-card"))u=_;else{const R=_.querySelectorAll("[data-hand-card]");if(R.length>0){let O=1/0,U=null;const $=p.clientX,M=p.clientY;for(const G of Array.from(R)){const x=G.getBoundingClientRect();if($>=x.left&&$<=x.right&&M>=x.top&&M<=x.bottom){const q=x.left+x.width/2,Z=x.top+x.height/2,J=Math.hypot($-q,M-Z);J<O&&(O=J,U=G)}}u=U}}if(u){const R=u.getAttribute("data-hand-card");if(R){const[O,U]=R.split(","),$=parseInt(O,10),M=parseInt(U,10),G=t.players.find(q=>q.id===$),x=G==null?void 0:G.hand[M];if(G&&x){if(s.type==="Revealed"&&!G.isDummy){if((m=x.statuses)==null?void 0:m.some(pe=>pe.type==="Revealed"&&pe.addedByPlayerId===D))return;s.count===1&&(s.chainedAction&&i(s.chainedAction,s.sourceCoords||{row:-1,col:-1}),S()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:s.originalOwnerId??((g=s.sourceCard)==null?void 0:g.ownerId)??D??void 0,statusType:s.type,count:1},{target:"hand",playerId:$,cardIndex:M,boardCoords:void 0}),s.sourceCoords&&s.sourceCoords.row>=0&&n(s.sourceCoords,s.isDeployAbility),s.count>1?d(pe=>pe?{...pe,count:pe.count-1}:null):d(null),o.current=!0,setTimeout(()=>{o.current=!1},300);return}const Z={targetOwnerId:s.targetOwnerId,excludeOwnerId:s.excludeOwnerId,onlyOpponents:s.onlyOpponents||s.targetOwnerId===-1,onlyFaceDown:s.onlyFaceDown,targetType:s.targetType,requiredTargetStatus:s.requiredTargetStatus,tokenType:s.type};if(!lt({card:x,ownerId:$,location:"hand"},Z,D,t.players))return;s.count===1&&(s.chainedAction&&i(s.chainedAction,s.sourceCoords||{row:-1,col:-1}),S()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:s.originalOwnerId??((C=s.sourceCard)==null?void 0:C.ownerId),statusType:s.type,replaceStatusType:s.replaceStatus?s.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:$,cardIndex:M,boardCoords:void 0}),s.sourceCoords&&s.sourceCoords.row>=0&&n(s.sourceCoords,s.isDeployAbility),s.count>1?d(de=>de?{...de,count:de.count-1}:null):d(null),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}}if(!u){const R=_==null?void 0:_.closest("[data-board-coords]");if(R){const O=R.getAttribute("data-board-coords");if(O){const[U,$]=O.split(","),M=parseInt(U,10),G=parseInt($,10);if(!isNaN(M)&&!isNaN(G)&&M>=0&&M<t.board.length&&t.board[M]&&G>=0&&G<t.board[M].length&&t.board[M][G]){const x=t.board[M][G].card;if((x==null?void 0:x.ownerId)!==void 0){const q={targetOwnerId:s.targetOwnerId,excludeOwnerId:s.excludeOwnerId,onlyOpponents:s.onlyOpponents||s.targetOwnerId===-1,onlyFaceDown:s.onlyFaceDown,targetType:s.targetType,requiredTargetStatus:s.requiredTargetStatus,mustBeAdjacentToSource:s.mustBeAdjacentToSource,mustBeInLineWithSource:s.mustBeInLineWithSource,sourceCoords:s.sourceCoords,tokenType:s.type};if(!lt({card:x,ownerId:x.ownerId,location:"board",boardCoords:{row:M,col:G}},q,D,t.players))return}if(x){const q=s.placeAllAtOnce?s.count:1;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:s.originalOwnerId??((k=s.sourceCard)==null?void 0:k.ownerId),statusType:s.type,replaceStatusType:s.replaceStatus?s.requiredTargetStatus:void 0,count:q},{target:"board",boardCoords:{row:M,col:G}}),P("board",{row:M,col:G}),s.recordContext&&c(J=>({...J,lastMovedCardCoords:{row:M,col:G},lastMovedCardId:x.id})),s.sourceCoords&&s.sourceCoords.row>=0&&n(s.sourceCoords,s.isDeployAbility);const Z=s.count-q;if(Z>0)d(J=>J?{...J,count:Z}:null);else{if(s.chainedAction){const J={...s.chainedAction};s.recordContext&&(J.mode==="SELECT_CELL"&&(J.sourceCard=x,J.sourceCoords={row:M,col:G},J.recordContext=!0),J.type==="GLOBAL_AUTO_APPLY"&&(J.sourceCoords={row:M,col:G}),J.type==="CREATE_STACK"&&(J.sourceCoords={row:M,col:G},J.originalOwnerId||(J.sourceCard=x)),J.mode==="ZIUS_LINE_SELECT"&&(J.sourceCoords={row:M,col:G})),J.type==="CREATE_STACK"&&E(null),i(J,{row:M,col:G})}S(),d(null)}o.current=!0,setTimeout(()=>{o.current=!1},300)}}}}else{const O=_==null?void 0:_.closest(".counter-modal-content"),U=(_==null?void 0:_.closest("[data-board-coords]"))!==null,$=(_==null?void 0:_.closest("[data-hand-card]"))!==null;s.isDragging?O?d(M=>M?{...M,isDragging:!1}:null):!U&&!$&&(S(),d(null)):!O&&!U&&!$&&(S(),d(null))}}};return window.addEventListener("mouseup",I),()=>{window.removeEventListener("mouseup",I)}},[s,r,t,e,a,n,o,c,i,d,E,P]),H.useEffect(()=>{const I=p=>{s&&(p.preventDefault(),S(),d(null))};return window.addEventListener("contextmenu",I),()=>{window.removeEventListener("contextmenu",I)}},[s,d,S]),{cursorFollowerRef:y,handleCounterMouseDown:(I,p)=>{A.current={x:p.clientX,y:p.clientY};const _=t.players.find(u=>u.id===t.activePlayerId),D=_!=null&&_.isDummy&&t.activePlayerId!==null?t.activePlayerId:e??0;d(u=>Tr(I,D,u))}}};export{Kt as A,vd as B,Cd as C,Ed as D,Od as E,Td as F,md as G,Nd as H,Md as I,Ld as J,fd as K,Bt as L,ds as M,ir as N,lt as O,cs as P,wt as Q,fe as R,wd as S,ie as T,ma as U,Ir as V,pd as W,is as X,ut as a,Id as b,ns as c,Rs as d,Ce as e,Sd as f,Be as g,Ea as h,yd as i,os as j,Ad as k,l,pr as m,Fe as n,gd as o,ss as p,ls as q,bd as r,hd as s,as as t,_d as u,Pd as v,kd as w,Rd as x,Dd as y,at as z};
