import{c as Dn,d as Cn,a as bn,e as Rn}from"./vendor-DN327hFn.js";import{r as $}from"./vendor-react-CUDkF-OL.js";import{$ as Yt}from"./vendor-webrtc-BkE-feJi.js";var Je=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(Je||{}),gr=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(gr||{});const Sn={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253319/SYN_IP_DEPT_AGENT_mhwphu.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253342/SYN_TACTICAL_AGENT_xbb7i0.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253325/SYN_PATROL_AGENT_ioetlu.png",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253337/SYN_RIOT_AGENT_jurf4t.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253338/SYN_THREAT_ANALYST_sqnpgw.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678622/Mr._Pearl_Director_of_BioSynch_mo0cil.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253315/HOO_RECKLESS_PROVOCATEUR_hi7a9z.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253317/HOO_DATA_LIBERATOR_lbtqa2.png",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253309/HOO_CAUTIOUS_AVENGER_x4g4g3.png",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253311/HOO_VIGILANT_SPOTTER_eiephm.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253313/HOO_INVENTIVE_MAKER_uzrbg1.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764637482/Finn_nehk0r.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253324/OPT_FABER_d7uxew.png",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253321/OPT_CENSOR_wtxtc2.png",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253332/OPT_PRINCEPS_w3o5lq.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253327/OPT_IMMUNIS_bjlncl.png",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253330/OPT_CENTURION_aaushl.png",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678954/Lucius_The_Immortal_z0lemw.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253298/FUS_CODE_KEEPER_qotsym.png",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253305/FUS_DEVOUT_SYNTHETIC_bavg9k.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253303/FUS_UNWAVERING_INTEGRATOR_emret1.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253299/FUS_SIGNAL_PROPHET_nzd7w3.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253301/FUS_ZEALOUS_MISSIONARY_mfv9xl.png",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678937/Reverend_of_The_Choir_vts8im.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253291/CMD_OVERWATCH_hrba9x.png",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253296/CMD_REPOSITIONING_m7k4kf.png",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763260942/CMD_INSPIRATION_nxifhu.png",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253290/CMD_DATA_INTERCEPTION_ks4lcv.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763640484/CMD_FALSE_ORDERS_ghi01y.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Experimental_Stimulants_x8ns1g.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Logistics_Chain_d4irtq.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507609/Quick_Response_Team_rw2cut.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Temporary_Shelter_o0embx.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Enhanced_Interrogation_suzvxe.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764626980/Autonomous_Battle_Robot_Gawain_uoyjm5.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Reclaimed_Gawain_sg6257.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764767153/Secret_informant_eb0nkm.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Michael_Falk_wcxjnp.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Edith_Byron_v6691r.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Pinkunoneko_nhmjfv.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Maria_Eleftheria_Damanaki_bmx6xv.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Zius_cwd92f.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},An={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253333/TKN_RECON_DRONE_esfknf.png",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253307/TKN_WALKING_TURRET_uq6owm.png",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},On={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Aim_dcct45.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Exploit_foomty.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Revealed_w1gbe7.png",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Stun_cwqroz.png",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Shield_z9sjr1.png",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Support_ui9qpl.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Threat_i1pbko.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1768321040/Resurrected_tscgk9.png",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},Pn=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],or={cardDatabase:Sn,tokenDatabase:An,countersDatabase:On,deckFiles:Pn};let ca=null,_t=new Map,yr=new Map,Nt={},Vt=[],hr={};const ha=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function xo(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const r=await fetch("/api/content/database");if(r.ok){const a=await r.json(),n=a.cards.map(([s,m])=>[s,m]),o=a.tokens.map(([s,m])=>[s,m]);e={cardDatabase:Object.fromEntries(n),tokenDatabase:Object.fromEntries(o),countersDatabase:Object.fromEntries(a.counters),deckFiles:a.deckFiles}}else e=or}catch{e=or}else e=or;ca=e,_t=new Map(Object.entries(e.cardDatabase)),yr=new Map(Object.entries(e.tokenDatabase)),Nt=e.countersDatabase,Vt=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(Nt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(r){console.warn("Could not save counters database to localStorage:",r)}ct=ca,Nn=_t,kn=yr,At=Nt,Ln=Vt,hr=vn(),Mn=hr}catch(e){throw console.error("Failed to load content database:",e),e}}function vn(){const e={};for(const t of Vt){const r=[];for(const a of t.cards){const n=_t.get(a.cardId);if(!n){console.warn(`Card definition not found for ID: ${a.cardId} in deck: ${t.name}`);continue}const o=ha.has(a.cardId);for(let s=0;s<a.quantity;s++){const i=a.cardId.replace(/-/g,"--DASH--").toUpperCase();o?r.push({...n,deck:Je.Command,id:`CMD_${i}_${s+1}`,baseId:a.cardId,faction:n.faction||"Command"}):r.push({...n,deck:t.id,id:`${t.id.substring(0,3).toUpperCase()}_${i}_${s+1}`,baseId:a.cardId,faction:n.faction||t.id})}}e[t.id]=r}return e[Je.Tokens]=Array.from(yr.entries()).map(([t,r])=>{const a=r.types?[...r.types]:[];return{id:`TKN_${r.name.toUpperCase().replace(/\s/g,"_")}`,baseId:t,deck:Je.Tokens,name:r.name,imageUrl:r.imageUrl,fallbackImage:r.fallbackImage,power:r.power,ability:r.ability,color:r.color,types:a,flavorText:r.flavorText,faction:"Tokens"}}),e}let ct=null,Nn=new Map,kn=new Map,At={};try{const e=localStorage.getItem("counters_database");e&&(Nt=JSON.parse(e),At=Nt)}catch{}let Ln=[],Mn={};const Gn=ha,$o=()=>Vt.filter(e=>e.isSelectable);function xn(e){return _t.get(e)}function sr(e){return Array.from(_t.values()).find(t=>t.name===e)}function Ho(){return Array.from(_t.entries()).map(([e,t])=>({id:e,card:t}))}function Uo(){return _t}function _r(){return hr}const $n=4,Wo={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764252181/medal_rgbw8d.png"},Fo={[Je.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[Je.Hoods]:{prefix:"HOO",color:"border-purple-500"},[Je.Optimates]:{prefix:"OPT",color:"border-red-500"},[Je.Fusion]:{prefix:"FUS",color:"border-green-400"},[Je.Command]:{prefix:"CMD",color:"border-yellow-500"},[Je.Tokens]:{prefix:"TKN",color:"border-gray-400"},[Je.Custom]:{prefix:"CUS",color:"border-purple-400"},[Je.Neutral]:{prefix:"NEU",color:"border-gray-400"},[Je.Random]:{prefix:"RND",color:"border-gray-400"}},Bo={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},Hn={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},Yo={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},Jt=["blue","purple","red","green","yellow","orange","pink","brown"],jo=["Setup","Main","Commit","Scoring"],jt=()=>Object.fromEntries(Object.entries(At).map(([e,t])=>[e,t.imageUrl])),zo=new Proxy({},{get(e,t){return jt()[t]},ownKeys(){return Object.keys(jt())},has(e,t){return t in jt()},getOwnPropertyDescriptor(e,t){const r=jt()[t];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),zt=()=>Object.fromEntries(Object.entries(At).map(([e,t])=>[e,t.description])),Ko=new Proxy({},{get(e,t){return zt()[t]},ownKeys(){return Object.keys(zt())},has(e,t){return t in zt()},getOwnPropertyDescriptor(e,t){const r=zt()[t];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),Un=()=>Object.entries(At).filter(([,e])=>!e.allowedPanels||e.allowedPanels.includes("COUNTER_PANEL")).sort(([,e],[,t])=>e.sortOrder-t.sortOrder).map(([e,t])=>({type:e,label:t.name}));Un();const xt="readyDeploy",$t="readySetup",Ht="readyCommit",wt=(e,t,r,a)=>Math.abs(e-r)+Math.abs(t-a)===1,ze=(e,t,r)=>e.statuses?e.statuses.some(a=>a.type===t&&(r===void 0||a.addedByPlayerId===r)):!1,Rt=(e,t)=>e.statuses?e.statuses.some(r=>r.type===t):!1,Wn=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>ze(n,"Aim",r)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"threatAnalyst",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>{let n=0;return t.board.forEach(o=>{o.forEach(s=>{var m;(m=s.card)!=null&&m.statuses&&(n+=s.card.statuses.filter(i=>i.type==="Exploit"&&i.addedByPlayerId===r).length)})}),n===0?null:{type:"CREATE_STACK",tokenType:"Revealed",count:n,onlyFaceDown:!0}}},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,t,r,a)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,t,r,a)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>{var o;return n.ownerId!==r&&((o=n.statuses)==null?void 0:o.some(s=>s.type==="Threat"))}},sourceCard:e,sourceCoords:a})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.ownerId!==r&&ze(n,"Exploit",r)}})},{baseId:"centurion",activationType:"commit",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(n,o,s)=>{var m;return n.ownerId===r&&((m=n.types)==null?void 0:m.includes("Unit"))&&o!==void 0&&s!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:a,payload:{filter:(n,o,s)=>wt(o,s,a.row,a.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.id===e.id?!1:n.ownerId===r}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:a,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>ze(n,"Aim",r)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:a,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,originalOwnerId:r,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:n=>n.ownerId===r}})},{baseId:"censor",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:a,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>ze(n,"Aim",r)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,t,r,a)=>ze(e,"Support",r)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:a,payload:{filter:(n,o)=>wt(n,o,a.row,a.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:(n,o,s)=>wt(o,s,a.row,a.col)&&n.ownerId!==r&&(ze(n,"Threat",r)||ze(n,"Stun",r))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,t,r,a)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>n.ownerId===r&&ze(n,"Support",r)},sourceCard:e,sourceCoords:a})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.ownerId===r&&ze(n,"Exploit",r)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:a,payload:{filter:n=>ze(n,"Exploit",r)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"MODIFY_POWER",amount:-1,filter:n=>ze(n,"Aim",r)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:a,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"REVEAL_ENEMY",sourceCard:e,sourceCoords:a,payload:{filter:(n,o,s)=>wt(o,s,a.row,a.col)&&n.ownerId!==r}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>ze(n,"Aim",r)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:(n,o,s)=>wt(o,s,a.row,a.col)&&n.ownerId!==r&&(ze(n,"Threat",r)||ze(n,"Stun",r))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,t,r,a)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"edithByron",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:a,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:(n,o,s)=>wt(o,s,a.row,a.col)&&(ze(n,"Threat",r)||ze(n,"Stun",r)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>ze(n,"Aim",r)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:a,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:a,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,t,r,a)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:a,ownerId:r})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"LUCIUS_SETUP",filter:n=>n.ownerId===r}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.ownerId===r,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,t,r,a)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:a})}],wr=e=>{const t=e.baseId||"";return Wn.filter(r=>{var a;return r.baseId===t||((a=r.baseIdAlt)==null?void 0:a.includes(t))})},Fn=e=>{const r=wr(e).map(a=>a.activationType);return[...new Set(r)]},mr=(e,t,r,a)=>{var s;if(r!==e.ownerId)return!1;if(a&&e.ownerId!==void 0){const m=a.players.find(i=>i.id===e.ownerId);if(m!=null&&m.isDummy&&a.activePlayerId!==e.ownerId)return!1}if((s=e.statuses)!=null&&s.some(m=>m.type==="Stun"))return!1;const n=wr(e),o=t===1&&n.some(m=>m.activationType==="setup")||t===3&&n.some(m=>m.activationType==="commit");if(t===1){const m=n.find(i=>i.activationType==="setup");if(m&&Rt(e,$t))return!(m.supportRequired&&!ze(e,"Support",r))}if(t===3){const m=n.find(i=>i.activationType==="commit");if(m&&Rt(e,Ht))return!(m.supportRequired&&!ze(e,"Support",r))}if(!o){const m=n.find(i=>i.activationType==="deploy");if(m&&Rt(e,xt))return!(m.supportRequired&&!ze(e,"Support",r))}return!1},Bn=(e,t,r,a)=>{if(r!==e.ownerId)if(e.ownerId!==void 0){const i=t.players.find(d=>d.id===e.ownerId);if(!(i!=null&&i.isDummy))return null}else return null;const n=wr(e),o=e.ownerId??r??0,s=t.currentPhase,m=s===1&&n.some(i=>i.activationType==="setup")||s===3&&n.some(i=>i.activationType==="commit");if(s===1){const i=n.find(d=>d.activationType==="setup");if(i&&Rt(e,$t)){if(i.supportRequired&&!ze(e,"Support",o))return null;const d=i.getAction(e,t,o,a);if(d)return{...d,readyStatusToRemove:$t}}}if(s===3){const i=n.find(d=>d.activationType==="commit");if(i&&Rt(e,Ht)){if(i.supportRequired&&!ze(e,"Support",o))return null;const d=i.getAction(e,t,o,a);if(d)return{...d,readyStatusToRemove:Ht}}}if(!m){const i=n.find(d=>d.activationType==="deploy");if(i&&Rt(e,xt)){if(i.supportRequired&&!ze(e,"Support",o))return null;const d=i.getAction(e,t,o,a);if(d)return{...d,isDeployAbility:!0,readyStatusToRemove:xt}}}return null},Yn=(e,t,r)=>{let a,n;return typeof t=="object"?(a=t.currentPhase,r=t.activePlayerId??void 0,n=t):a=t,mr(e,a,r??void 0,n)},Dr=(e,t)=>{e.statuses||(e.statuses=[]);const r=e.statuses.length,a=e.statuses.map(o=>o.type),n=Fn(e);console.log(`[initializeReadyStatuses] Card: ${e.name} (${e.id}), ownerId: ${t}, abilities: [${n.join(", ")}]`);for(const o of n){let s="";o==="deploy"?s=xt:o==="setup"?s=$t:o==="commit"&&(s=Ht),s&&!e.statuses.some(m=>m.type===s)&&(e.statuses.push({type:s,addedByPlayerId:t}),console.log(`[initializeReadyStatuses] Added status: ${s} to ${e.name}`))}e.statuses.length!==r&&console.log(`[initializeReadyStatuses] Card ${e.name}: statuses changed from [${a.join(", ")}] to [${e.statuses.map(o=>o.type).join(", ")}]`)},ir=e=>{e.statuses&&(e.statuses=e.statuses.filter(t=>t.type!==xt&&t.type!==$t&&t.type!==Ht))};function Ne(e){const t=e,r=t==null?void 0:t.targetingMode;r&&delete t.targetingMode;let a;return typeof structuredClone<"u"?a=structuredClone(e):a=JSON.parse(JSON.stringify(e)),r&&(a.targetingMode=r,t.targetingMode=r),a}const we={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function qo(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function Vo(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}function Jo(e,t){return e?Hn[e]:t}const er=Dn()(Cn((e,t)=>({openModal:null,modalData:{},modalSize:"lg",open:(r,a={},n="lg")=>e({openModal:r,modalData:a,modalSize:n}),close:()=>e({openModal:null,modalData:{},modalSize:"lg"}),isOpen:r=>t().openModal===r,getData:()=>t().modalData,getSize:()=>t().modalSize}),{name:"ModalsStore"})),Xo=()=>{const{open:e,close:t,isOpen:r}=er();return{isOpen:r("rules"),open:()=>e("rules",{},"full"),close:t}},Zo=()=>{const{open:e,close:t,isOpen:r}=er();return{isOpen:r("settings"),open:()=>e("settings",{},"md"),close:t}},Qo=()=>{const{open:e,close:t,isOpen:r,getData:a}=er();return{isOpen:r("joinGame"),open:n=>e("joinGame",n,"lg"),close:t,getData:()=>a()}},es=()=>{const{open:e,close:t,isOpen:r}=er();return{isOpen:r("deckBuilder"),open:()=>e("deckBuilder",{},"full"),close:t}},f={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},kt="webrtc_game_state",Lt="webrtc_host_data",Mt="webrtc_guest_data",jn="webrtc_current_host_peerId",zn=30*60*1e3;function Cr(){return Date.now()}function Ut(e){return Date.now()-e<zn}function Kn(e){try{const t={...e,timestamp:Cr()};localStorage.setItem(Lt,JSON.stringify(t)),f.info("[WebRTC Persistence] Saved host data:",{peerId:t.peerId})}catch(t){f.error("[WebRTC Persistence] Failed to save host data:",t)}}function dr(e){try{const t={...e,timestamp:Cr()};localStorage.setItem(Mt,JSON.stringify(t)),f.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId})}catch(t){f.error("[WebRTC Persistence] Failed to save guest data:",t)}}function Ot(e){try{const t={...e,timestamp:Cr()};localStorage.setItem(kt,JSON.stringify(t)),f.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(t.timestamp).toISOString())}catch(t){f.error("[WebRTC Persistence] Failed to save game state:",t)}}function ma(){try{const e=localStorage.getItem(Lt);if(!e)return null;const t=JSON.parse(e);return Ut(t.timestamp)?(f.info("[WebRTC Persistence] Loaded valid host data:",{peerId:t.peerId}),t):(f.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(Lt),null)}catch(e){return f.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(Lt),null}}function Ea(){try{const e=localStorage.getItem(Mt);if(!e)return null;const t=JSON.parse(e);return Ut(t.timestamp)?(f.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId}),t):(f.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(Mt),null)}catch(e){return f.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(Mt),null}}function la(){try{const e=localStorage.getItem(kt);if(!e)return null;const t=JSON.parse(e);return Ut(t.timestamp)?(f.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(t.timestamp).toISOString()),t):(f.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(kt),null)}catch(e){return f.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(kt),null}}function Dt(){localStorage.removeItem(kt),localStorage.removeItem(Lt),localStorage.removeItem(Mt),localStorage.removeItem(jn)}function Er(e,t){try{const r=`webrtc_host_${t}`,a={peerId:e,gameId:t,timestamp:Date.now()};localStorage.setItem(r,JSON.stringify(a)),f.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${t}:`,e)}catch(r){f.error("[WebRTC Persistence] Failed to broadcast host peerId:",r)}}function cr(e){try{const t=`webrtc_host_${e}`,r=localStorage.getItem(t);if(!r)return null;const a=JSON.parse(r);return Date.now()-a.timestamp>15e3?null:{peerId:a.peerId,timestamp:a.timestamp}}catch(t){return f.error("[WebRTC Persistence] Failed to get host peerId:",t),null}}function qn(e){try{const t=`webrtc_host_${e}`;localStorage.removeItem(t),f.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(t){f.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",t)}}function Vn(){const e=sessionStorage.getItem("invite_host_id"),t=sessionStorage.getItem("invite_auto_join");if(e&&t)return"none";const r=ma();if(r&&Ut(r.timestamp))return"host";const a=Ea();return a&&Ut(a.timestamp)?"guest":"none"}const ua=7,lr="mrPearlDoF",Jn="reverendOfTheChoir",Xn="threatAnalyst";function Zn(e,t){return e!=null&&e.statuses?e.statuses.some(r=>r.type==="Exploit"&&r.addedByPlayerId!==void 0&&t.has(r.addedByPlayerId)):!1}function Qn(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const Ia=()=>Array(ua).fill(null).map(()=>Array(ua).fill(null).map(()=>({card:null}))),Qe=e=>{var _,g,y,S,w;const{board:t,activeGridSize:r,players:a}=e,n=Qn(t),o=n.length,s=Math.floor((o-r)/2),m=new Map;a.forEach(c=>m.set(c.id,c.teamId));for(let c=0;c<o;c++)for(let P=0;P<o;P++){const T=n[c][P].card;T&&(T.statuses&&(T.statuses=T.statuses.filter(L=>L.type!=="Support"&&L.type!=="Threat")),delete T.bonusPower)}for(let c=0;c<o;c++)for(let P=0;P<o;P++){const T=n[c][P].card;if((T==null?void 0:T.ownerId)===void 0||T.isFaceDown)continue;const L=T.ownerId,E=m.get(L),O=[{r:c-1,c:P},{r:c+1,c:P},{r:c,c:P-1},{r:c,c:P+1}],D={};let k=!1;for(const j of O){const{r:z,c:V}=j;if(z>=0&&z<o&&V>=0&&V<o){const J=n[z][V].card,fe=(_=J==null?void 0:J.statuses)==null?void 0:_.some(he=>he.type==="Stun");if((J==null?void 0:J.ownerId)!==void 0&&!J.isFaceDown&&!fe){const he=J.ownerId,Re=m.get(he);L===he||E!==void 0&&E===Re?k=!0:(D[he]||(D[he]=[]),D[he].push({r:z,c:V}))}}}k&&(T.statuses||(T.statuses=[]),T.statuses.some(j=>j.type==="Support")||T.statuses.push({type:"Support",addedByPlayerId:L}));let A=null;for(const j in D){const z=D[j];if(z&&z.length>=2){A=parseInt(j,10);break}}if(A===null&&c>=s&&c<s+r&&P>=s&&P<s+r){const z=c===s||c===s+r-1||P===s||P===s+r-1,V=Object.keys(D).length>0;if(z&&V){const J=Object.keys(D)[0];J&&(A=parseInt(J,10))}}A!==null&&(T.statuses||(T.statuses=[]),T.statuses.some(j=>j.type==="Threat")||T.statuses.push({type:"Threat",addedByPlayerId:A}))}const i=new Set;for(let c=0;c<o;c++)for(let P=0;P<o;P++){const T=n[c][P].card,L=(g=T==null?void 0:T.statuses)==null?void 0:g.some(E=>E.type==="Stun");if((T==null?void 0:T.baseId)===Xn&&!T.isFaceDown&&T.ownerId!==void 0&&!L){const E=[{r:c-1,c:P},{r:c+1,c:P},{r:c,c:P-1},{r:c,c:P+1}];let O=!1;const D=T.ownerId,k=m.get(D);for(const A of E){const{r:j,c:z}=A;if(j>=0&&j<o&&z>=0&&z<o){const V=n[j][z].card;if((V==null?void 0:V.ownerId)!==void 0&&!V.isFaceDown){const J=V.ownerId,fe=m.get(J),he=D===J||k!==void 0&&k===fe,Re=(y=V==null?void 0:V.statuses)==null?void 0:y.some(Te=>Te.type==="Stun");if(he&&!Re){O=!0;break}}}}O&&i.add(D)}}for(let c=0;c<o;c++)for(let P=0;P<o;P++){const T=n[c][P].card;if(!T||T.isFaceDown||T.ownerId===void 0)continue;const L=T.ownerId,E=m.get(L),O=[{r:c-1,c:P},{r:c+1,c:P},{r:c,c:P-1},{r:c,c:P+1}],D={};for(const A of O){const{r:j,c:z}=A;if(j>=0&&j<o&&z>=0&&z<o){const V=n[j][z].card,J=(S=V==null?void 0:V.statuses)==null?void 0:S.some(fe=>fe.type==="Stun");if((V==null?void 0:V.ownerId)!==void 0&&!V.isFaceDown&&!J){const fe=V.ownerId,he=m.get(fe);if(!(L===fe||E!==void 0&&E===he)){const Te=i.has(fe),Ie=Zn(T,i);Te&&Ie&&(D[fe]||(D[fe]=0),D[fe]++)}}}}if(Object.keys(D).length>0){T.statuses||(T.statuses=[]);const A=Object.keys(D).map(j=>parseInt(j,10));for(const j of A)T.statuses.some(z=>z.type==="Threat"&&z.addedByPlayerId===j)||T.statuses.push({type:"Threat",addedByPlayerId:j})}}const d=[],h=[];for(let c=0;c<o;c++)for(let P=0;P<o;P++){const T=n[c][P].card,L=(w=T==null?void 0:T.statuses)==null?void 0:w.some(E=>E.type==="Stun");T!=null&&T.baseId&&!T.isFaceDown&&T.ownerId!==void 0&&!L&&(T.baseId===Jn?d.push({r:c,c:P,ownerId:T.ownerId,baseId:T.baseId}):T.baseId===lr&&h.push({r:c,c:P,ownerId:T.ownerId,baseId:T.baseId}))}const R=new Set,p=new Set;for(const c of d){const{r:P,c:T,ownerId:L}=c,E=`${P}-${L}`;if(!R.has(E)){R.add(E);for(let D=0;D<o;D++){const k=n[P][D].card;k&&k.ownerId===L&&!k.isFaceDown&&(k.statuses||(k.statuses=[]),k.statuses.some(A=>A.type==="Support")||k.statuses.push({type:"Support",addedByPlayerId:L}))}}const O=`${T}-${L}`;if(!p.has(O)){p.add(O);for(let D=0;D<o;D++){const k=n[D][T].card;k&&k.ownerId===L&&!k.isFaceDown&&(k.statuses||(k.statuses=[]),k.statuses.some(A=>A.type==="Support")||k.statuses.push({type:"Support",addedByPlayerId:L}))}}}const I=new Set,b=new Set;for(const c of h){const{r:P,c:T,ownerId:L}=c,E=`${P}-${L}`;if(!I.has(E)){I.add(E);for(let D=0;D<o;D++){const k=n[P][D].card;k&&k.ownerId===L&&!k.isFaceDown&&k.baseId!==lr&&(k.bonusPower=(k.bonusPower||0)+1)}}const O=`${T}-${L}`;if(!b.has(O)){b.add(O);for(let D=0;D<o;D++){const k=n[D][T].card;k&&k.ownerId===L&&!k.isFaceDown&&k.baseId!==lr&&(k.bonusPower=(k.bonusPower||0)+1)}}}return n};function eo(e){var t,r;return!!e&&(e.deck==="Tokens"||e.deck==="counter"||((t=e.types)==null?void 0:t.includes("Token"))||((r=e.types)==null?void 0:r.includes("Token Unit")))}function Ir(e){var r,a;eo(e);const t={i:e.id,b:e.baseId,p:e.power,o:e.ownerId};return e.name&&(t.n=e.name),e.powerModifier&&(t.pm=e.powerModifier),e.bonusPower&&(t.bp=e.bonusPower),e.ownerName&&(t.on=e.ownerName),e.enteredThisTurn&&(t.et=!0),e.isFaceDown&&(t.ifd=!0),e.revealedTo&&(t.rt=e.revealedTo),(r=e.types)!=null&&r.length&&(t.t=e.types),e.faction&&(t.f=e.faction),e.deck&&(t.d=e.deck),(a=e.statuses)!=null&&a.length&&(t.s=e.statuses.map(n=>({t:n.type,a:n.addedByPlayerId}))),t}function Tr(e){const t={id:e.i,baseId:e.b,power:e.p,ownerId:e.o};return e.n&&(t.name=e.n),e.pm!==void 0&&(t.powerModifier=e.pm),e.bp!==void 0&&(t.bonusPower=e.bp),e.on&&(t.ownerName=e.on),e.et&&(t.enteredThisTurn=!0),e.ifd&&(t.isFaceDown=!0),e.rt&&(t.revealedTo=e.rt),e.t&&(t.types=e.t),e.f&&(t.faction=e.f),e.d&&(t.deck=e.d),e.s&&(t.statuses=e.s.map(r=>({type:r.t,addedByPlayerId:r.a}))),t}function to(e){var r,a,n;const t={t:e.timestamp,s:e.sourcePlayerId||0};if(e.playerDeltas){t.pd={};for(const[o,s]of Object.entries(e.playerDeltas)){const m=parseInt(o),i={i:m};s.name&&(i.n=s.name),s.color&&(i.c=s.color),s.score!==void 0&&(i.s=s.score),s.handSizeDelta&&(i.hs=s.handSizeDelta),s.deckSizeDelta&&(i.ds=s.deckSizeDelta),s.discardSizeDelta&&(i.dis=s.discardSizeDelta),s.handAdd&&(i.ha=s.handAdd),s.handRemove&&(i.hr=s.handRemove),s.deckRemove&&(i.dr=s.deckRemove),s.deckAdd&&(i.da=s.deckAdd),s.discardAdd&&(i.disa=s.discardAdd),s.announcedCard!==void 0&&(i.ac=s.announcedCard),s.boardHistory&&(i.bh=s.boardHistory),s.removed&&(i.rm=!0),s.isReady!==void 0&&(i.r=s.isReady),s.isDisconnected!==void 0&&(i.d=s.isDisconnected),s.selectedDeck&&(i.sc=s.selectedDeck),s.teamId!==void 0&&(i.tid=s.teamId),t.pd[m]=i}}return(r=e.boardCells)!=null&&r.length&&(t.bc=e.boardCells.map(o=>({r:o.row,c:o.col,...ro(o.card)?{rm:!0}:{},...o.card?{ca:Ir(o.card)}:{}}))),e.phaseDelta&&(t.ph={p:e.phaseDelta.phase,...e.phaseDelta.nextPlayer!==void 0&&{n:e.phaseDelta.nextPlayer}}),e.roundDelta&&(t.rd={r:e.roundDelta.round,...e.roundDelta.roundWinners&&{rw:e.roundDelta.roundWinners},...e.roundDelta.sweepWinners&&{sw:e.roundDelta.sweepWinners}}),e.settingsDelta&&(t.sd={},e.settingsDelta.gameMode&&(t.sd.gm=e.settingsDelta.gameMode),e.settingsDelta.isPrivate!==void 0&&(t.sd.pr=e.settingsDelta.isPrivate),e.settingsDelta.activeGridSize&&(t.sd.gs=e.settingsDelta.activeGridSize),e.settingsDelta.dummyPlayerCount&&(t.sd.dc=e.settingsDelta.dummyPlayerCount),e.settingsDelta.autoAbilitiesEnabled!==void 0&&(t.sd.aa=e.settingsDelta.autoAbilitiesEnabled)),e.highlightsDelta&&(t.hd={},(a=e.highlightsDelta.add)!=null&&a.length&&(t.hd.a=e.highlightsDelta.add.map(o=>({r:o.row,c:o.col,cid:o.cardId}))),e.highlightsDelta.clear&&(t.hd.cl=!0)),(n=e.floatingTextsDelta)!=null&&n.length&&(t.ftd=e.floatingTextsDelta.map(o=>({r:o.row,c:o.col,txt:o.text,pi:o.playerId}))),e.targetingModeDelta&&(t.tmd=e.targetingModeDelta),e.abilityModeDelta&&(t.amd=e.abilityModeDelta),t}function ro(e){return e===null}function ao(e){var r;const t={timestamp:e.t,sourcePlayerId:e.s};if(e.pd){t.playerDeltas={};for(const[a,n]of Object.entries(e.pd)){const o={id:parseInt(a)};n.n&&(o.name=n.n),n.c&&(o.color=n.c),n.s!==void 0&&(o.score=n.s),n.hs&&(o.handSizeDelta=n.hs),n.ds&&(o.deckSizeDelta=n.ds),n.dis&&(o.discardSizeDelta=n.dis),n.ha&&(o.handAdd=n.ha),n.hr&&(o.handRemove=n.hr),n.dr&&(o.deckRemove=n.dr),n.da&&(o.deckAdd=n.da),n.disa&&(o.discardAdd=n.disa),n.ac!==void 0&&(o.announcedCard=n.ac),n.bh&&(o.boardHistory=n.bh),n.rm&&(o.removed=!0),n.r!==void 0&&(o.isReady=n.r),n.d!==void 0&&(o.isDisconnected=n.d),n.sc&&(o.selectedDeck=n.sc),n.tid!==void 0&&(o.teamId=n.tid),t.playerDeltas[o.id]=o}}return(r=e.bc)!=null&&r.length&&(t.boardCells=e.bc.map(a=>({row:a.r,col:a.c,card:a.rm?null:a.ca?Tr(a.ca):null}))),e.ph&&(t.phaseDelta={phase:e.ph.p,...e.ph.n!==void 0&&{nextPlayer:e.ph.n}}),e.rd&&(t.roundDelta={round:e.rd.r,...e.rd.rw&&{roundWinners:e.rd.rw},...e.rd.sw&&{sweepWinners:e.rd.sw}}),e.sd&&(t.settingsDelta={},e.sd.gm&&(t.settingsDelta.gameMode=e.sd.gm),e.sd.pr!==void 0&&(t.settingsDelta.isPrivate=e.sd.pr),e.sd.gs&&(t.settingsDelta.activeGridSize=e.sd.gs),e.sd.dc&&(t.settingsDelta.dummyPlayerCount=e.sd.dc),e.sd.aa!==void 0&&(t.settingsDelta.autoAbilitiesEnabled=e.sd.aa)),e.hd&&(t.highlightsDelta={},e.hd.a&&(t.highlightsDelta.add=e.hd.a.map(a=>({row:a.r,col:a.c,cardId:a.cid}))),e.hd.cl&&(t.highlightsDelta.clear=!0)),e.ftd&&(t.floatingTextsDelta=e.ftd.map(a=>({row:a.r,col:a.c,text:a.txt,playerId:a.pi}))),e.tmd&&(t.targetingModeDelta=e.tmd),e.amd&&(t.abilityModeDelta=e.amd),t}function Ta(e){try{return Rn(e)}catch(t){return f.error("[serializeToBinary] Failed to encode:",t),new TextEncoder().encode(JSON.stringify(e))}}function ga(e){try{return bn(e)}catch(t){return f.error("[deserializeFromBinary] Failed to decode:",t),JSON.parse(new TextDecoder().decode(e))}}function fa(e){const t=to(e);return Ta(t)}function no(e){const t=ga(e);return ao(t)}function oo(e){return{gi:e.gameId||"",gm:e.gameMode,p:e.currentPhase,ap:e.activePlayerId,sp:e.startingPlayerId,rd:e.currentRound,tn:e.turnNumber,iss:e.isScoringStep,igs:e.isGameStarted,pl:e.players.map(t=>({i:t.id,n:t.name,c:typeof t.color=="string"?t.color:"blue",id:t.isDummy??!1,sc:t.selectedDeck,r:t.isReady??!1,s:t.score||0,hs:t.hand.length,ds:t.deck.length,diss:t.discard.length,ac:t.announcedCard?Ir(t.announcedCard):void 0,tid:t.teamId})),bd:e.board.map(t=>t.map(r=>({c:r.card?Ir(r.card):null})))}}function so(e){const t=oo(e);return Ta(t)}function io(e){return{gameId:e.gi,gameMode:e.gm,currentPhase:e.p,activePlayerId:e.ap,startingPlayerId:e.sp,currentRound:e.rd,turnNumber:e.tn,isScoringStep:e.iss,isGameStarted:e.igs,players:e.pl.map(r=>{const a={id:r.i,name:r.n,color:r.c,isDummy:r.id,selectedDeck:r.sc,isReady:r.r,score:r.s,teamId:r.tid};return r.id?(a.hand=[],a.deck=[],a.discard=[]):(a.hand=new Array(r.hs),a.deck=new Array(r.ds),a.discard=new Array(r.diss)),r.ac&&(a.announcedCard=Tr(r.ac)),a}),board:e.bd.map(r=>r.map(a=>({card:a.c?Tr(a.c):null})))}}const co=!0;class lo{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,localStorage.getItem("webrtc_enabled")}async initializeAsHost(t){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((r,a)=>{this.peer=t?new Yt(t):new Yt,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),r(n)}),this.peer.on("connection",n=>{f.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{f.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),a(n)}),this.peer.on("close",()=>{f.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(t){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((r,a)=>{this.peer=new Yt,this.peer.on("open",n=>{const o=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(o),o.on("open",()=>{this.hostConnection=o,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"JOIN_REQUEST",senderId:n,timestamp:Date.now()}),r()}),o.on("error",s=>{f.error("Host connection error:",s),this.emitEvent({type:"error",data:s}),a(s)})}),this.peer.on("error",n=>{f.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),a(n)})})}async initializeAsReconnectingGuest(t,r){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((a,n)=>{this.peer=new Yt,this.peer.on("open",o=>{const s=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(s),s.on("open",()=>{this.hostConnection=s,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:o,playerId:r,timestamp:Date.now()}),this.isReconnecting=!1,a()}),s.on("error",m=>{f.error("Host connection error:",m),this.emitEvent({type:"error",data:m}),this.isReconnecting=!1,n(m)})}),this.peer.on("error",o=>{f.error("WebRTC Peer error:",o),this.emitEvent({type:"error",data:o}),this.isReconnecting=!1,n(o)})})}handleGuestConnection(t){this.connections.set(t.peer,t),t.on("open",()=>{f.info(`Guest connected: ${t.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:t.peer}})}),t.on("data",r=>{this.handleMessage(r,t)}),t.on("close",()=>{f.info(`Guest disconnected: ${t.peer}`),this.connections.delete(t.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:t.peer}})}),t.on("error",r=>{f.error(`Guest connection error (${t.peer}):`,r)})}setupHostConnection(t){this.hostConnection=t,t.on("data",r=>{this.handleMessage(r,t)}),t.on("close",()=>{f.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),t.on("error",r=>{f.error("Host connection error:",r)})}handleMessage(t,r){f.debug("Received WebRTC message:",t.type),this.emitEvent({type:"message_received",data:t})}sendMessageToHost(t){if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(t),!0}catch(r){return f.error("Failed to send message to host:",r),!1}return!1}broadcastToGuests(t,r){if(!this.isHost){f.warn("Only host can broadcast to guests");return}let a=0;this.connections.forEach((n,o)=>{if(n.open&&o!==r)try{n.send(t),a++}catch(s){f.error(`Failed to send to guest ${o}:`,s)}}),f.debug(`Broadcast to ${a}/${this.connections.size} guests`)}sendToGuest(t,r){if(!this.isHost)return f.warn("Only host can send to specific guest"),!1;const a=this.connections.get(t);if(!a)return f.error(`[sendToGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!a.open)return f.error(`[sendToGuest] Connection for guest ${t} is not open`),!1;try{return a.send(r),f.debug(`Sent message to guest ${t}`),!0}catch(n){return f.error(`[sendToGuest] Failed to send message to ${t}:`,n),!1}}acceptGuest(t,r,a){var o;const n=this.connections.get(t);if(!n){f.error(`[acceptGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){f.error(`[acceptGuest] Connection for guest ${t} is not open`);return}try{if(co){const s=so(r),m={type:"JOIN_ACCEPT_BINARY",senderId:(o=this.peer)==null?void 0:o.id,playerId:a,data:s,timestamp:Date.now()};n.send(m),f.info(`Accepted guest ${t} as player ${a} (BINARY, ${s.byteLength} bytes)`)}}catch(s){f.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${t}:`,s)}}acceptGuestMinimal(t,r,a){var s;const n=this.connections.get(t);if(!n){f.error(`[acceptGuestMinimal] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){f.error(`[acceptGuestMinimal] Connection for guest ${t} is not open`);return}const o={type:"JOIN_ACCEPT_MINIMAL",senderId:(s=this.peer)==null?void 0:s.id,playerId:a,data:r,timestamp:Date.now()};try{n.send(o),f.info(`Accepted guest ${t} as player ${a} (minimal)`)}catch(m){f.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${t}:`,m)}}broadcastGameState(t,r){var n;const a={type:"STATE_UPDATE",senderId:(n=this.peer)==null?void 0:n.id,data:{gameState:t},timestamp:Date.now()};this.broadcastToGuests(a,r)}broadcastStateDelta(t,r){var a,n;{const o=fa(t),s={type:"STATE_DELTA_BINARY",senderId:(a=this.peer)==null?void 0:a.id,data:o,timestamp:Date.now()};f.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA: ${o.byteLength} bytes, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, boardCells=${((n=t.boardCells)==null?void 0:n.length)||0}`),this.broadcastToGuests(s,r),f.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${t.sourcePlayerId} to ${this.connections.size} guests`)}}sendAction(t,r){var n;const a={type:"ACTION",senderId:(n=this.peer)==null?void 0:n.id,data:{actionType:t,actionData:r},timestamp:Date.now()};return this.sendMessageToHost(a)}sendStateDelta(t){var r;{const a=fa(t),n={type:"STATE_DELTA_BINARY",senderId:(r=this.peer)==null?void 0:r.id,data:a,timestamp:Date.now()};return this.sendMessageToHost(n)}}getConnectionInfo(){const t=[];return this.isHost?this.connections.forEach((r,a)=>{t.push({peerId:a,playerId:null,playerName:null,connected:r.open})}):this.hostConnection&&t.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),t}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getHostPeerId(){var t,r;return this.isHost?((t=this.peer)==null?void 0:t.id)||null:((r=this.hostConnection)==null?void 0:r.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var t;return this.isHost?this.connections.size:(t=this.hostConnection)!=null&&t.open?1:0}on(t){return this.eventHandlers.add(t),()=>this.eventHandlers.delete(t)}emitEvent(t){this.eventHandlers.forEach(r=>{try{r(t)}catch(a){f.error("Error in WebRTC event handler:",a)}})}cleanup(){this.connections.forEach(t=>t.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let ur=null;const uo=()=>(ur||(ur=new lo),ur);function fo(e){return 10+e*10}function br(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const t=e.currentPhase===1,r=e.activePlayerId===e.startingPlayerId;if(!t||!r)return{shouldEnd:!1,roundWinners:[]};const a=e.currentRound||1,n=fo(a),o=[];for(const m of e.players)!m.isDummy&&!m.isDisconnected&&m.score>=n&&o.push(m.id);return{shouldEnd:o.length>0,roundWinners:o}}function _a(e){const{shouldEnd:t,roundWinners:r}=br(e);if(!t)return e;const a=e.currentRound||1,n={...e.roundWinners,[a]:r},o=new Map;for(const[,m]of Object.entries(n))for(const i of m){const d=o.get(i)||0;o.set(i,d+1)}let s=null;for(const[m,i]of o.entries())if(i>=2){s=m;break}return f.info(`[endRound] Round ${a} ended. Winners: [${r.join(", ")}], Game winner: ${s||"none"}`),{...e,roundWinners:n,gameWinner:s,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function Rr(e,t){if(e.currentPhase!==0)return f.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const r=e.players.find(o=>o.id===t);if(!r)return f.error(`[performPreparationPhase] Active player ${t} not found!`),e;f.info(`[performPreparationPhase] Player ${t} has deck size: ${r.deck.length}, hand size: ${r.hand.length}`);const a=e.players.map(o=>{if(o.id===t&&o.deck.length>0){const s=o.deck[0],m=[...o.deck.slice(1)],i=[...o.hand,s];return f.info(`[performPreparationPhase] Player ${t} drew card ${(s==null?void 0:s.id)||"unknown"}, deck now: ${m.length}, hand: ${i.length}`),{...o,deck:m,hand:i,readySetup:!1,readyCommit:!1}}return o}),n={...e,players:a,currentPhase:1};return br(n).shouldEnd?_a(n):(f.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${n.activePlayerId}`),n)}function wa(e,t){const r=e.activePlayerId;if(r===t){const m={...e,activePlayerId:null};return t===e.startingPlayerId&&e.currentPhase===1&&br(m).shouldEnd?_a(m):m}if(!e.players.filter(m=>!m.isDisconnected).find(m=>m.id===t))return f.warn(`[toggleActivePlayer] Player ${t} not found or disconnected`),e;let o=e.turnNumber||1;t===e.startingPlayerId&&r!==null&&o++;const s={...e,activePlayerId:t,turnNumber:o,currentPhase:0};return Rr(s,t)}function po(e,t){const r=e.players.filter(o=>!o.isDisconnected).sort((o,s)=>o.id-s.id);if(r.length===0)return null;if(t===null)return r[0].id;const a=r.findIndex(o=>o.id===t);if(a===-1)return r[0].id;const n=(a+1)%r.length;return r[n].id}function yo(e,t){var r;for(const a of e.board)for(const n of a)if(((r=n.card)==null?void 0:r.ownerId)===t)return!0;return!1}function Xt(e){const t=po(e,e.activePlayerId);if(t===null)return f.warn("[passTurnToNextPlayer] No next player found"),e;f.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${t}`);let r={...e,board:e.board.map(a=>a.map(n=>{var o;return((o=n.card)==null?void 0:o.ownerId)===e.activePlayerId&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(s=>s.type!=="Stun")}}:n}))};return r={...r,board:r.board.map(a=>a.map(n=>n.card&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(o=>o.type!=="enteredThisTurn")}}:n))},r={...r,activePlayerId:t,currentPhase:0,isScoringStep:!1},Rr(r,t)}function tr(e){const t=[...e];for(let r=t.length-1;r>0;r--){const a=Math.floor(Math.random()*(r+1));[t[r],t[a]]=[t[a],t[r]]}return t}function ho(e,t,r){const a=_r();let n=e;if(e==="Random"||!a[e]){const m=Object.keys(a);if(m.length===0)return f.error("[createDeckLocally] No decks loaded yet!"),[];n=m[0]}const o=a[n];if(!o)return f.error(`[createDeckLocally] Deck data for ${n} not found!`),[];const s=[...o].map(m=>({...m,ownerId:t,ownerName:r}));return tr(s)}function fr(e,t,r){var n,o;f.debug(`[applyStateDelta] Applying delta: sourcePlayerId=${t.sourcePlayerId}, boardCells=${((n=t.boardCells)==null?void 0:n.length)||0}, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, phase=${!!t.phaseDelta}`);const a={...e};if(t.playerDeltas){const s=[],m=new Set;f.debug(`[applyStateDelta] Processing player deltas for ${Object.keys(t.playerDeltas).length} players`);for(const i of e.players){const d=t.playerDeltas[i.id];if(d!=null&&d.removed){f.debug(`[applyStateDelta] Player ${i.id} removed, filtering out`);continue}if(m.add(i.id),d){const h={...i},R=i.id===r,p=h.isDummy||i.isDummy;if(p&&(d.hand&&(f.debug(`[applyStateDelta] Dummy player ${i.id}: using full hand from delta (${d.hand.length} cards)`),h.hand=d.hand),d.deck&&(f.debug(`[applyStateDelta] Dummy player ${i.id}: using full deck from delta (${d.deck.length} cards)`),h.deck=d.deck),d.discard&&(f.debug(`[applyStateDelta] Dummy player ${i.id}: using full discard from delta (${d.discard.length} cards)`),h.discard=d.discard)),!p||!d.hand&&!d.deck&&!d.discard){if(d.handSizeDelta!==void 0)if(R)f.debug(`[applyStateDelta] Local player ${i.id}: handSizeDelta=${d.handSizeDelta} (informational, skipping)`);else{const I=i.hand.length+d.handSizeDelta;if(f.debug(`[applyStateDelta] Player ${i.id}: hand ${i.hand.length} -> ${I} (delta: ${d.handSizeDelta})`),I<i.hand.length)h.hand=i.hand.slice(0,I);else if(I>i.hand.length){const b=[];for(let _=i.hand.length;_<I;_++)b.push({id:`placeholder_${i.id}_${_}`,name:"?",isPlaceholder:!0});h.hand=[...i.hand,...b],f.debug(`[applyStateDelta] Added ${b.length} placeholder cards to player ${i.id} hand`)}}if(d.deckSizeDelta!==void 0&&!R){const I=i.deck.length+d.deckSizeDelta;if(f.debug(`[applyStateDelta] Player ${i.id}: deck ${i.deck.length} -> ${I} (delta: ${d.deckSizeDelta})`),I<i.deck.length)h.deck=i.deck.slice(0,I);else if(I>i.deck.length){const b=[];for(let _=i.deck.length;_<I;_++)b.push({id:`placeholder_${i.id}_deck_${_}`,name:"?",isPlaceholder:!0});h.deck=[...i.deck,...b]}}if(d.discardAdd&&(h.discard=[...h.discard,...d.discardAdd]),d.discardClear&&(h.discard=[]),d.discardSizeDelta!==void 0&&!d.discardAdd&&!R){const I=i.discard.length+d.discardSizeDelta;if(I<i.discard.length)h.discard=i.discard.slice(0,I);else if(I>i.discard.length){const b=[];for(let _=i.discard.length;_<I;_++)b.push({id:`placeholder_${i.id}_discard_${_}`,name:"?",isPlaceholder:!0});h.discard=[...i.discard,...b]}}}d.scoreDelta!==void 0&&(h.score=Math.max(0,i.score+d.scoreDelta)),d.isReady!==void 0&&(h.isReady=d.isReady),d.selectedDeck!==void 0&&(h.selectedDeck=d.selectedDeck),d.name!==void 0&&(h.name=d.name),d.color!==void 0&&(h.color=d.color),d.isDisconnected!==void 0&&(h.isDisconnected=d.isDisconnected),d.isDummy!==void 0&&(h.isDummy=d.isDummy),d.announcedCard!==void 0&&(f.debug(`[applyStateDelta] Player ${i.id} announcedCard updated:`,((o=d.announcedCard)==null?void 0:o.id)||"null"),h.announcedCard=d.announcedCard),d.boardHistory!==void 0&&(h.boardHistory=[...d.boardHistory]),d.teamId!==void 0&&(h.teamId=d.teamId),d.autoDrawEnabled!==void 0&&(h.autoDrawEnabled=d.autoDrawEnabled),s.push(h)}else s.push(i)}for(const[i,d]of Object.entries(t.playerDeltas)){const h=Number(i);if(!m.has(h)&&!d.removed){f.debug(`[applyStateDelta] Adding new player ${h} (${d.name||"Unknown"}), isDummy=${d.isDummy}`);const R={id:h,name:d.name||`Player ${h}`,color:d.color||"blue",isDummy:d.isDummy||!1,isReady:d.isReady||!1,score:0,selectedDeck:d.selectedDeck||"Random",boardHistory:d.boardHistory||[],isDisconnected:d.isDisconnected||!1,autoDrawEnabled:d.autoDrawEnabled!==void 0?d.autoDrawEnabled:!0},p=(I,b)=>({id:`placeholder_${h}_${b}_${I}`,name:"?",isPlaceholder:!0,ownerId:h,color:R.color,deck:R.selectedDeck});if(d.isDummy){if(d.hand)R.hand=d.hand,f.debug(`[applyStateDelta] New dummy player ${h}: using full hand from delta (${R.hand.length} cards)`);else{const I=d.handSizeDelta||0;R.hand=[];for(let b=0;b<I;b++)R.hand.push(p(b,"hand"))}if(d.deck)R.deck=d.deck,f.debug(`[applyStateDelta] New dummy player ${h}: using full deck from delta (${R.deck.length} cards)`);else{const I=R.selectedDeck||"Random",b=ho(I,h,R.name),_=d.deckSizeDelta||b.length;if(b.length>_){const g=b.length-_;R.deck=b.slice(g)}else R.deck=b;f.debug(`[applyStateDelta] New dummy player ${h}: generated deck locally (${R.deck.length} cards, deckType=${I})`)}if(d.discard)R.discard=d.discard,f.debug(`[applyStateDelta] New dummy player ${h}: using full discard from delta (${R.discard.length} cards)`);else{const I=d.discardSizeDelta||0;R.discard=[];for(let b=0;b<I;b++)R.discard.push(p(b,"discard"))}f.debug(`[applyStateDelta] New dummy player ${h}: hand=${R.hand.length}, deck=${R.deck.length}, discard=${R.discard.length}`)}else{const I=d.handSizeDelta||0,b=d.deckSizeDelta||0,_=d.discardSizeDelta||0;R.hand=[];for(let g=0;g<I;g++)R.hand.push(p(g,"hand"));R.deck=[];for(let g=0;g<b;g++)R.deck.push(p(g,"deck"));R.discard=[];for(let g=0;g<_;g++)R.discard.push(p(g,"discard"))}d.announcedCard!==void 0?R.announcedCard=d.announcedCard:R.announcedCard=null,s.push(R)}}f.debug(`[applyStateDelta] Player count: ${e.players.length} -> ${s.length}`),a.players=s}if(t.boardCells&&t.boardCells.length>0&&(f.debug(`[applyStateDelta] Applying ${t.boardCells.length} board cell changes`),a.board=e.board.map((s,m)=>s.map((i,d)=>{var p,I,b,_,g,y,S;const h=t.boardCells.find(w=>w.row===m&&w.col===d);if(!h)return i;const R={...i};if(h.card!==void 0){const w=((I=(p=h.card)==null?void 0:p.statuses)==null?void 0:I.length)||0,c=((_=(b=h.card)==null?void 0:b.statuses)==null?void 0:_.map(P=>P.type).join(","))||"none";f.debug(`[applyStateDelta] Cell [${m},${d}]: card ${h.card?"added":"removed"}, name: ${((g=h.card)==null?void 0:g.name)||"N/A"}, statuses: [${c}] (count: ${w})`),R.card=h.card}if(h.cardStatuses&&R.card){f.debug(`[applyStateDelta] Cell [${m},${d}]: applying cardStatuses, remove=${(y=h.cardStatuses.remove)==null?void 0:y.join(",")}, add count=${((S=h.cardStatuses.add)==null?void 0:S.length)||0}`);const w={...R.card};if(w.statuses||(w.statuses=[]),h.cardStatuses.clear)w.statuses=[];else{if(h.cardStatuses.remove&&h.cardStatuses.remove.length>0){const c=h.cardStatuses.remove,P=w.statuses.length;w.statuses=w.statuses.filter(L=>!c.includes(L.type));const T=w.statuses.length;P!==T&&f.debug(`[applyStateDelta] Cell [${m},${d}]: removed ${P-T} statuses with types: ${c.join(",")}`)}h.cardStatuses.add&&h.cardStatuses.add.length>0&&(w.statuses=[...w.statuses,...h.cardStatuses.add],f.debug(`[applyStateDelta] Cell [${m},${d}]: added ${h.cardStatuses.add.length} statuses`))}R.card=w}if(h.cardPowerDelta!==void 0&&R.card){const w={...R.card};w.power=Number(w.power??0)+h.cardPowerDelta,R.card=w}if(h.cardPowerModifier!==void 0&&R.card){f.debug(`[applyStateDelta] Applying powerModifier at [${m},${d}]: ${R.card.powerModifier} -> ${h.cardPowerModifier}`);const w={...R.card};w.powerModifier=h.cardPowerModifier,R.card=w}return R}))),t.phaseDelta&&(t.phaseDelta.currentPhase!==void 0&&(a.currentPhase=t.phaseDelta.currentPhase),t.phaseDelta.isScoringStep!==void 0&&(a.isScoringStep=t.phaseDelta.isScoringStep),t.phaseDelta.activePlayerId!==void 0&&(a.activePlayerId=t.phaseDelta.activePlayerId),t.phaseDelta.startingPlayerId!==void 0&&(a.startingPlayerId=t.phaseDelta.startingPlayerId)),t.roundDelta&&(t.roundDelta.currentRound!==void 0&&(a.currentRound=t.roundDelta.currentRound),t.roundDelta.turnNumber!==void 0&&(a.turnNumber=t.roundDelta.turnNumber),t.roundDelta.roundEndTriggered!==void 0&&(a.roundEndTriggered=t.roundDelta.roundEndTriggered),t.roundDelta.roundWinners!==void 0&&(a.roundWinners={...t.roundDelta.roundWinners}),t.roundDelta.gameWinner!==void 0&&(a.gameWinner=t.roundDelta.gameWinner),t.roundDelta.isRoundEndModalOpen!==void 0&&(a.isRoundEndModalOpen=t.roundDelta.isRoundEndModalOpen)),t.settingsDelta){if(t.settingsDelta.activeGridSize!==void 0&&(a.activeGridSize=t.settingsDelta.activeGridSize,e.board.length!==t.settingsDelta.activeGridSize)){const s=t.settingsDelta.activeGridSize;a.board=[];for(let m=0;m<s;m++){const i=[];for(let d=0;d<s;d++)i.push({card:null});a.board.push(i)}}t.settingsDelta.gameMode!==void 0&&(a.gameMode=t.settingsDelta.gameMode,f.debug(`[applyStateDelta] Game mode changed to ${t.settingsDelta.gameMode}`)),t.settingsDelta.isPrivate!==void 0&&(a.isPrivate=t.settingsDelta.isPrivate,f.debug(`[applyStateDelta] Game privacy changed to ${t.settingsDelta.isPrivate}`)),t.settingsDelta.dummyPlayerCount!==void 0&&(a.dummyPlayerCount=t.settingsDelta.dummyPlayerCount,f.debug(`[applyStateDelta] Dummy player count changed to ${t.settingsDelta.dummyPlayerCount}`))}if(t.highlightsDelta)if(t.highlightsDelta.clear)a.highlights=[];else{let s=[...e.highlights];t.highlightsDelta.remove&&(s=s.filter(m=>!t.highlightsDelta.remove.includes(m.timestamp))),t.highlightsDelta.add&&(s=[...s,...t.highlightsDelta.add]),a.highlights=s}return t.floatingTextsDelta&&(t.floatingTextsDelta.clear?a.floatingTexts=[]:t.floatingTextsDelta.add&&(a.floatingTexts=[...e.floatingTexts,...t.floatingTextsDelta.add])),t.targetingModeDelta&&(t.targetingModeDelta.clear?a.targetingMode=null:t.targetingModeDelta.set&&(a.targetingMode=t.targetingModeDelta.set)),t.abilityModeDelta&&(a.abilityMode=t.abilityModeDelta),a}function Ct(e,t,r){var m,i,d,h,R,p,I,b,_,g,y,S,w,c,P,T,L,E,O,D,k;const a={timestamp:Date.now(),sourcePlayerId:r};(e.currentPhase!==t.currentPhase||e.isScoringStep!==t.isScoringStep||e.activePlayerId!==t.activePlayerId||e.startingPlayerId!==t.startingPlayerId)&&(a.phaseDelta={...e.currentPhase!==t.currentPhase&&{currentPhase:t.currentPhase},...e.isScoringStep!==t.isScoringStep&&{isScoringStep:t.isScoringStep},...e.activePlayerId!==t.activePlayerId&&{activePlayerId:t.activePlayerId},...e.startingPlayerId!==t.startingPlayerId&&{startingPlayerId:t.startingPlayerId}}),(e.currentRound!==t.currentRound||e.turnNumber!==t.turnNumber||e.roundEndTriggered!==t.roundEndTriggered||e.gameWinner!==t.gameWinner||e.isRoundEndModalOpen!==t.isRoundEndModalOpen)&&(a.roundDelta={...e.currentRound!==t.currentRound&&{currentRound:t.currentRound},...e.turnNumber!==t.turnNumber&&{turnNumber:t.turnNumber},...e.roundEndTriggered!==t.roundEndTriggered&&{roundEndTriggered:t.roundEndTriggered},...e.gameWinner!==t.gameWinner&&{gameWinner:t.gameWinner},...e.isRoundEndModalOpen!==t.isRoundEndModalOpen&&{isRoundEndModalOpen:t.isRoundEndModalOpen}}),(e.activeGridSize!==t.activeGridSize||e.gameMode!==t.gameMode||e.isPrivate!==t.isPrivate||e.dummyPlayerCount!==t.dummyPlayerCount)&&(a.settingsDelta={...e.activeGridSize!==t.activeGridSize&&{activeGridSize:t.activeGridSize},...e.gameMode!==t.gameMode&&{gameMode:t.gameMode},...e.isPrivate!==t.isPrivate&&{isPrivate:t.isPrivate},...e.dummyPlayerCount!==t.dummyPlayerCount&&{dummyPlayerCount:t.dummyPlayerCount}},f.debug("[createDeltaFromStates] Settings changed:",a.settingsDelta));const n=[],o=Math.max(e.board.length,t.board.length);for(let A=0;A<o;A++){const j=Math.max(((m=e.board[A])==null?void 0:m.length)||0,((i=t.board[A])==null?void 0:i.length)||0);for(let z=0;z<j;z++){const V=(d=e.board[A])==null?void 0:d[z],J=(h=t.board[A])==null?void 0:h[z];if(!V&&!J)continue;const fe=(R=V==null?void 0:V.card)==null?void 0:R.id,he=(p=J==null?void 0:J.card)==null?void 0:p.id;if(fe!==he){const Re=((b=(I=J==null?void 0:J.card)==null?void 0:I.statuses)==null?void 0:b.length)||0,Te=((g=(_=J==null?void 0:J.card)==null?void 0:_.statuses)==null?void 0:g.map(Ie=>Ie.type).join(","))||"none";f.debug(`[createDeltaFromStates] Cell [${A},${z}]: card changed, new card: ${((y=J==null?void 0:J.card)==null?void 0:y.name)||"null"}, statuses: [${Te}] (count: ${Re})`),n.push({row:A,col:z,card:(J==null?void 0:J.card)||null})}else if(V!=null&&V.card&&(J!=null&&J.card)){const Re={row:A,col:z},Te=((S=V==null?void 0:V.card)==null?void 0:S.statuses)||[],Ie=((w=J==null?void 0:J.card)==null?void 0:w.statuses)||[];if(Te.length>0||Ie.length>0){const $e=Te.map(Pe=>Pe.type).join(","),pe=Ie.map(Pe=>Pe.type).join(",");$e!==pe&&f.debug(`[createDeltaFromStates] Cell [${A},${z}] (${J.card.name}): statuses differ - old: [${$e}], new: [${pe}]`)}const Ke=[],ae=[];if(Te.length!==Ie.length){const $e=new Map,pe=new Map;for(const Pe of Te){const qe=`${Pe.type}_${Pe.addedByPlayerId}`;$e.has(qe)||$e.set(qe,[]),$e.get(qe).push(Pe)}for(const Pe of Ie){const qe=`${Pe.type}_${Pe.addedByPlayerId}`;pe.has(qe)||pe.set(qe,[]),pe.get(qe).push(Pe)}for(const[Pe,qe]of $e){const u=pe.get(Pe),M=qe.length,Q=u?u.length:0;if(Q<M){const Ee=M-Q;for(let x=0;x<Ee;x++)ae.push(qe[x].type)}}for(const[Pe,qe]of pe){const u=$e.get(Pe),M=qe.length,Q=u?u.length:0;if(M>Q)for(let Ee=Q;Ee<M;Ee++)Ke.push(qe[Ee])}f.debug(`[createDeltaFromStates] Cell [${A},${z}]: status length changed ${Te.length} -> ${Ie.length}, added: ${Ke.length}, removed: ${ae.join(",")}`)}else for(let $e=0;$e<Te.length;$e++){const pe=Te[$e],Pe=Ie[$e];(pe.type!==Pe.type||pe.addedByPlayerId!==Pe.addedByPlayerId)&&(ae.push(pe.type),Ke.push(Pe),f.debug(`[createDeltaFromStates] Cell [${A},${z}]: status replaced at index ${$e}: ${pe.type} -> ${Pe.type}`))}(Ke.length>0||ae.length>0)&&(Re.cardStatuses={...Ke.length>0&&{add:Ke},...ae.length>0&&{remove:ae}},f.debug(`[createDeltaFromStates] Cell [${A},${z}]: cardStatuses delta created, remove: [${ae.join(",")}], add: ${Ke.map($e=>$e.type).join(",")}`));const lt=Number(((c=V==null?void 0:V.card)==null?void 0:c.power)??0),Ue=Number(((P=J==null?void 0:J.card)==null?void 0:P.power)??0);lt!==Ue&&(Re.cardPowerDelta=Ue-lt);const ut=(T=V==null?void 0:V.card)==null?void 0:T.powerModifier,Xe=(L=J==null?void 0:J.card)==null?void 0:L.powerModifier;ut!==Xe&&(Re.cardPowerModifier=Xe),Object.keys(Re).length>2&&n.push(Re)}}}n.length>0&&(a.boardCells=n);const s={};for(const A of t.players){const j=e.players.find(he=>he.id===A.id);if(!j){f.debug(`[createDeltaFromStates] New player added: ${A.id} (${A.name}), isDummy=${A.isDummy}`);const he={id:A.id,name:A.name,color:A.color,isDummy:A.isDummy,isReady:A.isReady,selectedDeck:A.selectedDeck,isDisconnected:A.isDisconnected,handSizeDelta:A.hand.length,deckSizeDelta:A.deck.length,discardSizeDelta:A.discard.length,announcedCard:A.announcedCard};s[A.id]=he,f.debug(`[createDeltaFromStates] New player delta: sizes hand=${A.hand.length}, deck=${A.deck.length}, discard=${A.discard.length}`);continue}const z={id:A.id};j.score!==A.score&&(z.scoreDelta=A.score-j.score),j.isReady!==A.isReady&&(z.isReady=A.isReady),j.selectedDeck!==A.selectedDeck&&(z.selectedDeck=A.selectedDeck),j.name!==A.name&&(z.name=A.name),j.color!==A.color&&(z.color=A.color),j.isDisconnected!==A.isDisconnected&&(z.isDisconnected=A.isDisconnected),A.isDummy?(z.isDummy=!0,j.hand.length===0&&A.hand.length>0&&A.hand.length>0&&(z.hand=[...A.hand],f.debug(`[createDeltaFromStates] Dummy player ${A.id}: game start, sending full hand (${A.hand.length} cards)`)),j.hand.length!==A.hand.length&&(z.handSizeDelta=A.hand.length-j.hand.length,f.debug(`[createDeltaFromStates] Dummy player ${A.id}: hand size delta: ${z.handSizeDelta}`)),j.deck.length!==A.deck.length&&(z.deckSizeDelta=A.deck.length-j.deck.length,f.debug(`[createDeltaFromStates] Dummy player ${A.id}: deck size delta: ${z.deckSizeDelta}`)),j.discard.length!==A.discard.length&&(z.discardSizeDelta=A.discard.length-j.discard.length,f.debug(`[createDeltaFromStates] Dummy player ${A.id}: discard size delta: ${z.discardSizeDelta}`))):(j.hand.length!==A.hand.length&&(z.handSizeDelta=A.hand.length-j.hand.length),j.deck.length!==A.deck.length&&(z.deckSizeDelta=A.deck.length-j.deck.length),j.discard.length!==A.discard.length&&(z.discardSizeDelta=A.discard.length-j.discard.length,A.discard.length>j.discard.length&&(z.discardAdd=A.discard.slice(j.discard.length))));const V=j.announcedCard,J=A.announcedCard;(!V!=!J||V&&J&&(V.id!==J.id||V.power!==J.power||V.powerModifier!==J.powerModifier||(((E=V.statuses)==null?void 0:E.length)??0)!==(((O=J.statuses)==null?void 0:O.length)??0)||JSON.stringify(V.statuses)!==JSON.stringify(J.statuses)))&&(z.announcedCard=J?{...J}:null,f.debug(`[createDeltaFromStates] Player ${A.id} announcedCard changed:`,V==null?void 0:V.id,"->",J==null?void 0:J.id)),JSON.stringify(j.boardHistory)!==JSON.stringify(A.boardHistory)&&(z.boardHistory=[...A.boardHistory]),j.teamId!==A.teamId&&(z.teamId=A.teamId),j.autoDrawEnabled!==A.autoDrawEnabled&&(z.autoDrawEnabled=A.autoDrawEnabled),j.selectedDeck!==A.selectedDeck&&(z.selectedDeck=A.selectedDeck,f.debug(`[createDeltaFromStates] Player ${A.id} selectedDeck changed: ${j.selectedDeck} -> ${A.selectedDeck}`)),Object.keys(z).length>1&&(s[A.id]=z)}for(const A of e.players)t.players.find(z=>z.id===A.id)||(f.debug(`[createDeltaFromStates] Player removed: ${A.id} (${A.name})`),s[A.id]={id:A.id,removed:!0});return Object.keys(s).length>0&&(a.playerDeltas=s),JSON.stringify(e.abilityMode)!==JSON.stringify(t.abilityMode)&&(a.abilityModeDelta=t.abilityMode,f.debug("[createDeltaFromStates] abilityMode changed:",(D=e.abilityMode)==null?void 0:D.mode,"->",(k=t.abilityMode)==null?void 0:k.mode)),JSON.stringify(e.targetingMode)!==JSON.stringify(t.targetingMode)&&(t.targetingMode===null?a.targetingModeDelta={clear:!0}:a.targetingModeDelta={set:t.targetingMode}),a}function bt(e){var t;return!e.phaseDelta&&!e.roundDelta&&!e.settingsDelta&&!((t=e.boardCells)!=null&&t.length)&&!e.playerDeltas&&!e.highlightsDelta&&!e.floatingTextsDelta&&!e.targetingModeDelta&&!e.abilityModeDelta}function mo(e,t){return{type:"RECONNECT_SNAPSHOT",data:{gameId:e.gameId??"",gameMode:e.gameMode,isPrivate:e.isPrivate,isGameStarted:e.isGameStarted,isReadyCheckActive:e.isReadyCheckActive,activeGridSize:e.activeGridSize,currentPhase:e.currentPhase,isScoringStep:e.isScoringStep,activePlayerId:e.activePlayerId,startingPlayerId:e.startingPlayerId,currentRound:e.currentRound,turnNumber:e.turnNumber,roundWinners:e.roundWinners,gameWinner:e.gameWinner,isRoundEndModalOpen:e.isRoundEndModalOpen,dummyPlayerCount:e.dummyPlayerCount,players:e.players.map(r=>({id:r.id,name:r.name,color:typeof r.color=="string"?r.color:"blue",isDummy:r.isDummy??!1,isReady:r.isReady??!1,isDisconnected:r.isDisconnected??!1,score:r.score,selectedDeck:r.selectedDeck,autoDrawEnabled:r.autoDrawEnabled??!1,teamId:r.teamId,handSize:r.hand.length,deckSize:r.deck.length,discardSize:r.discard.length,announcedCard:r.announcedCard,boardHistory:r.boardHistory??[]})),board:e.board}}}const Zt="avalon_game_state",Tt="reconnection_data";function Da(e,t){var a;e.forEach(n=>n.forEach(o=>{var s;(s=o.card)!=null&&s.statuses&&(o.card.statuses=o.card.statuses.filter(m=>!(m.type==="LastPlayed"&&m.addedByPlayerId===t.id)))})),t.boardHistory||(t.boardHistory=[]);let r=!1;for(;t.boardHistory.length>0&&!r;){const n=t.boardHistory[t.boardHistory.length-1];for(let o=0;o<e.length;o++){for(let s=0;s<e[o].length;s++)if(((a=e[o][s].card)==null?void 0:a.id)===n){const m=e[o][s].card;if(!m||m.ownerId!==t.id)continue;m.statuses||(m.statuses=[]),m.statuses.push({type:"LastPlayed",addedByPlayerId:t.id}),r=!0;break}if(r)break}r||t.boardHistory.pop()}}function Pt(e){var a;if(!e||!ct)return e;const{cardDatabase:t,tokenDatabase:r}=ct;if(e.deck===Je.Tokens||(a=e.id)!=null&&a.startsWith("TKN_")){if(e.baseId&&r[e.baseId]){const o=r[e.baseId];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage}}const n=Object.keys(r).find(o=>r[o].name===e.name);if(n){const o=r[n];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage,baseId:n}}}else if(e.baseId&&t[e.baseId]){const n=t[e.baseId];return{...e,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage}}return e}function Gt(e){var a,n;if(!ct)return e;const t=((a=e.board)==null?void 0:a.map(o=>o.map(s=>({...s,card:s.card?Pt(s.card):null}))))||e.board,r=((n=e.players)==null?void 0:n.map(o=>{var s,m,i;return{...o,hand:((s=o.hand)==null?void 0:s.map(Pt))||[],deck:((m=o.deck)==null?void 0:m.map(Pt))||[],discard:((i=o.discard)==null?void 0:i.map(Pt))||[],announcedCard:o.announcedCard?Pt(o.announcedCard):null}}))||e.players;return{...e,board:t,players:r,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}}function pa(e,t,r){try{const a=Gt(e),n={gameState:a,localPlayerId:t,playerToken:r,timestamp:Date.now()};localStorage.setItem(Zt,JSON.stringify(n)),a.gameId&&t!==null&&localStorage.setItem(Tt,JSON.stringify({gameId:a.gameId,playerId:t,playerToken:r||null,timestamp:Date.now()}))}catch(a){console.warn("Failed to save game state:",a)}}function Eo(){try{const e=localStorage.getItem(Zt);if(!e)return null;const t=JSON.parse(e),r=24*60*60*1e3;if(Date.now()-t.timestamp>r)return localStorage.removeItem(Zt),localStorage.removeItem(Tt),null;const a=t.gameState;return{gameState:Gt(a),localPlayerId:t.localPlayerId,playerToken:t.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}}function St(){localStorage.removeItem(Zt),localStorage.removeItem(Tt)}function Ca(){return Math.random().toString(36).substring(2,18).toUpperCase()}function mt(e,t,r){const a=_r();let n=e;if(e==="Random"||!a[e]){const m=Object.keys(a);if(m.length===0)return console.error("[createDeck] No decks loaded yet!"),[];n=m[0],e==="Random"?console.log(`[createDeck] Random deck selected, using ${n} instead`):console.warn(`[createDeck] Deck ${e} not found, using ${n} instead`)}const o=a[n];if(!o)return console.error(`Deck data for ${n} not loaded! Returning empty deck. Available decks:`,Object.keys(a)),[];const s=[...o].map(m=>({...m,ownerId:t,ownerName:r}));return tr(s)}function ba(e,t=!1){const r=_r(),a=Object.keys(r);if(a.length===0)return console.error("[createNewPlayer] No decks loaded yet!"),{id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:Jt[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};const n=a[0],o={id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:n,color:Jt[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};return o.deck=mt(n,e,o.name),o}function It(){return{players:[],spectators:[],board:Ia(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:gr.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}function Io(){const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return f.warn("No custom WebSocket URL configured in settings."),null;let t=e.trim();return t.endsWith("/")&&(t=t.slice(0,-1)),t.startsWith("https://")?t=t.replace("https://","wss://"):t.startsWith("http://")&&(t=t.replace("http://","ws://")),!t.startsWith("ws://")&&!t.startsWith("wss://")?(f.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",t),t)}const ya=-1,To=-2,vt=1,Kt=2,gt=(e,t,r,a)=>{var m,i,d,h,R;const{card:n,ownerId:o,location:s}=e;if(t.targetOwnerId!==void 0&&t.targetOwnerId!==ya&&t.targetOwnerId!==To&&t.targetOwnerId!==o||t.excludeOwnerId!==void 0&&t.excludeOwnerId===o)return!1;if(t.onlyOpponents||t.targetOwnerId===ya){if(o===r)return!1;const p=a.find(b=>b.id===r),I=a.find(b=>b.id===o);if(p&&I&&p.teamId!==void 0&&p.teamId===I.teamId)return!1}if(t.targetType&&!((m=n.types)!=null&&m.includes(t.targetType))||t.onlyFaceDown&&((i=n.statuses)!=null&&i.some(p=>p.type==="Revealed"&&p.addedByPlayerId===r)||s==="board"&&!n.isFaceDown)||t.tokenType==="Revealed"&&(d=n.statuses)!=null&&d.some(p=>p.type==="Revealed"&&p.addedByPlayerId===r)||t.requiredTargetStatus&&(!((h=n.statuses)!=null&&h.some(p=>p.type===t.requiredTargetStatus))||t.requireStatusFromSourceOwner&&r!==null&&!((R=n.statuses)==null?void 0:R.some(I=>I.type===t.requiredTargetStatus&&I.addedByPlayerId===r))))return!1;if(t.mustBeAdjacentToSource&&t.sourceCoords&&e.boardCoords){const{row:p,col:I}=t.sourceCoords,{row:b,col:_}=e.boardCoords;if(Math.abs(p-b)+Math.abs(I-_)!==vt)return!1}if(t.mustBeInLineWithSource&&t.sourceCoords&&e.boardCoords){const{row:p,col:I}=t.sourceCoords,{row:b,col:_}=e.boardCoords;if(p!==b&&I!==_)return!1}if(t.maxDistanceFromSource!==void 0&&t.sourceCoords&&e.boardCoords){const{row:p,col:I}=t.sourceCoords,{row:b,col:_}=e.boardCoords;if(Math.max(Math.abs(p-b),Math.abs(I-_))>t.maxDistanceFromSource)return!1}if(t.maxOrthogonalDistance!==void 0&&t.sourceCoords&&e.boardCoords){const{row:p,col:I}=t.sourceCoords,{row:b,col:_}=e.boardCoords;if(Math.abs(p-b)+Math.abs(I-_)>t.maxOrthogonalDistance)return!1}return!0},Qt=(e,t,r,a)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const n=[],o=t.board,s=o.length,m=t.activeGridSize,i=Math.floor((s-m)/2),d=i,h=i+m-1;if(e.type==="CREATE_STACK"){const _={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let g=d;g<=h;g++)for(let y=d;y<=h;y++){const S=o[g][y];S.card&&S.card.ownerId!==void 0&&gt({card:S.card,ownerId:S.card.ownerId,location:"board",boardCoords:{row:g,col:y}},_,r,t.players)&&n.push({row:g,col:y})}return n}const{mode:R,payload:p,sourceCoords:I,contextCheck:b}=e;if(R==="REVEREND_DOUBLE_EXPLOIT"){for(let _=d;_<=h;_++)for(let g=d;g<=h;g++)o[_][g].card&&n.push({row:_,col:g});return n}if((R==="SELECT_TARGET"||R==="CENSOR_SWAP"||R==="ZEALOUS_WEAKEN"||R==="CENTURION_BUFF"||R==="SELECT_UNIT_FOR_MOVE")&&p.filter&&typeof p.filter=="function"){if(p.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||p.actionType==="LUCIUS_SETUP"||p.actionType==="SELECT_HAND_FOR_DEPLOY"||p.handOnly)return[];for(let _=d;_<=h;_++)for(let g=d;g<=h;g++){const y=o[_][g];let S=y.card&&p.filter(y.card,_,g);if(S&&b==="ADJACENT_TO_LAST_MOVE"&&(a!=null&&a.lastMovedCardCoords)){const{row:w,col:c}=a.lastMovedCardCoords;Math.abs(_-w)+Math.abs(g-c)===1||(S=!1)}S&&n.push({row:_,col:g})}}else if(R==="SELECT_TARGET"&&(p.actionType==="ENHANCED_INT_REVEAL"||p.actionType==="ENHANCED_INT_MOVE"))for(let _=d;_<=h;_++)for(let g=d;g<=h;g++)o[_][g].card&&n.push({row:_,col:g});else if(R==="PATROL_MOVE"&&I)for(let _=d;_<=h;_++)for(let g=d;g<=h;g++){const y=_===I.row||g===I.col,S=_===I.row&&g===I.col,w=!o[_][g].card;y&&(w||S)&&n.push({row:_,col:g})}else if(R==="RIOT_PUSH"&&I){const _=[{r:I.row-1,c:I.col},{r:I.row+1,c:I.col},{r:I.row,c:I.col-1},{r:I.row,c:I.col+1}],g=(y,S)=>y>=d&&y<=h&&S>=d&&S<=h;_.forEach(y=>{if(g(y.r,y.c)){const S=o[y.r][y.c].card;if(S&&S.ownerId!==r){const w=t.players.find(T=>T.id===r),c=t.players.find(T=>T.id===S.ownerId);if(!((w==null?void 0:w.teamId)!==void 0&&(c==null?void 0:c.teamId)!==void 0&&w.teamId===c.teamId)){const T=y.r-I.row,L=y.c-I.col,E=y.r+T,O=y.c+L;g(E,O)&&(o[E][O].card||n.push({row:y.r,col:y.c}))}}}})}else if(R==="RIOT_MOVE"&&p.vacatedCoords)n.push(p.vacatedCoords),I&&n.push(I);else if(R==="SWAP_POSITIONS"&&p.filter)for(let _=d;_<=h;_++)for(let g=d;g<=h;g++){const y=o[_][g];y.card&&p.filter(y.card,_,g)&&n.push({row:_,col:g})}else if((R==="TRANSFER_STATUS_SELECT"||R==="TRANSFER_ALL_STATUSES")&&p.filter)for(let _=d;_<=h;_++)for(let g=d;g<=h;g++){const y=o[_][g];y.card&&p.filter(y.card,_,g)&&n.push({row:_,col:g})}else if(R==="SPAWN_TOKEN"||R==="SELECT_CELL"||R==="IMMUNIS_RETRIEVE")for(let _=d;_<=h;_++)for(let g=d;g<=h;g++){const y=!o[_][g].card;if(R==="IMMUNIS_RETRIEVE"&&p.filter){y&&p.filter(_,g)&&n.push({row:_,col:g});continue}if(R==="SELECT_CELL"){if(p.moveFromHand){y&&n.push({row:_,col:g});continue}if(!I)continue;const S=_===I.row&&g===I.col,w=p.range==="global";let c=!1;if(w)c=!0;else if(p.range==="line")c=_===I.row||g===I.col;else if(p.range===Kt){const P=Math.abs(_-I.row),T=Math.abs(g-I.col),L=P+T;if(L===vt)c=!0;else if(L===Kt){const E=[];P===Kt&&T===0?E.push({r:(_+I.row)/2,c:g}):P===0&&T===Kt?E.push({r:_,c:(g+I.col)/2}):P===vt&&T===vt&&(E.push({r:_,c:I.col}),E.push({r:I.row,c:g})),c=E.some(O=>O.r<0||O.r>=s||O.c<0||O.c>=s?!1:!o[O.r][O.c].card)}}else c=Math.abs(_-I.row)+Math.abs(g-I.col)===vt;(y&&c||p.allowSelf&&S)&&n.push({row:_,col:g})}else if(R==="SPAWN_TOKEN"&&I){const S=Math.abs(_-I.row)+Math.abs(g-I.col)===1;y&&S&&n.push({row:_,col:g})}}else if(R==="REVEAL_ENEMY"&&p.filter)for(let _=d;_<=h;_++)for(let g=d;g<=h;g++){const y=o[_][g];y.card&&p.filter(y.card,_,g)&&n.push({row:_,col:g})}else if(R==="SELECT_LINE_START")for(let _=d;_<=h;_++)for(let g=d;g<=h;g++)n.push({row:_,col:g});else if(R==="SELECT_LINE_END"&&p.firstCoords){const{row:_,col:g}=p.firstCoords;for(let y=d;y<=h;y++)n.push({row:_,col:y});for(let y=d;y<=h;y++)n.push({row:y,col:g})}else if(R==="INTEGRATOR_LINE_SELECT"&&I){const{row:_,col:g}=I;for(let y=d;y<=h;y++)n.push({row:_,col:y});for(let y=d;y<=h;y++)n.push({row:y,col:g})}else if(R==="ZIUS_LINE_SELECT"&&I){const{row:_,col:g}=I;for(let y=d;y<=h;y++)n.push({row:_,col:y});for(let y=d;y<=h;y++)n.push({row:y,col:g})}else if(R==="IP_AGENT_THREAT_SCORING"&&I){const{row:_,col:g}=I;for(let y=d;y<=h;y++)n.push({row:_,col:y});for(let y=d;y<=h;y++)n.push({row:y,col:g})}else if(R==="SELECT_DIAGONAL")if(p.firstCoords){const{row:_,col:g}=p.firstCoords;for(let y=d;y<=h;y++)for(let S=d;S<=h;S++)Math.abs(y-_)===Math.abs(S-g)&&n.push({row:y,col:S})}else for(let _=d;_<=h;_++)for(let g=d;g<=h;g++)n.push({row:_,col:g});return n},qt=(e,t,r,a)=>{var o,s,m,i,d;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let h=0;h<t.board.length;h++)for(let R=0;R<t.board[h].length;R++)if(t.board[h][R].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((o=e.payload)!=null&&o.actionType)){const h=e.payload.actionType;if(h==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||h==="LUCIUS_SETUP"||h==="SELECT_HAND_FOR_DEPLOY"){const R=((s=e.sourceCard)==null?void 0:s.ownerId)||r;if(R!==null){const p=t.players.find(I=>I.id===R);if(p&&p.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(Qt(e,t,r,a).length>0)return!0;if(e.tokenType==="Revealed"||(m=e.tokenType)!=null&&m.startsWith("Power"))for(const R of t.players)for(let p=0;p<R.hand.length;p++){const I={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(gt({card:R.hand[p],ownerId:R.id,location:"hand"},I,r,t.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((i=e.payload)!=null&&i.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const h of t.players)if(h.hand.some(R=>e.payload.filter(R))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return Qt(e,t,r,a).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((d=e.payload)!=null&&d.filter),!1)};function go(e){const{ws:t,webrtcManager:r,gameStateRef:a,localPlayerIdRef:n,webrtcIsHostRef:o,setLatestHighlight:s,setLatestFloatingTexts:m,setLatestNoTarget:i,setLatestDeckSelections:d,setLatestHandCardSelections:h,setTargetSelectionEffects:R,setGameState:p}=e,I=$.useCallback(T=>{var E;const L={...T,timestamp:Date.now()};if(s(L),((E=t.current)==null?void 0:E.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:a.current.gameId,highlightData:L}));else if(r.current){const O={type:"HIGHLIGHT_TRIGGERED",senderId:r.current.getPeerId(),data:L,timestamp:Date.now()};o.current?r.current.broadcastToGuests(O):r.current.sendMessageToHost(O)}},[t,r,a,o,s]),b=$.useCallback(T=>{var D;const L=Array.isArray(T)?T:[T],E=Date.now(),O=L.map((k,A)=>({...k,timestamp:E+A}));if(m(O),((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:a.current.gameId,batch:O}));else if(r.current){const k={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:r.current.getPeerId(),data:{batch:O},timestamp:Date.now()};o.current?r.current.broadcastToGuests(k):r.current.sendMessageToHost(k)}},[t,r,a,o,m]),_=$.useCallback(T=>{var E;const L=Date.now();if(i({coords:T,timestamp:L}),((E=t.current)==null?void 0:E.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:a.current.gameId,coords:T,timestamp:L}));else if(r.current){const O={type:"NO_TARGET_TRIGGERED",senderId:r.current.getPeerId(),data:{coords:T,timestamp:L},timestamp:Date.now()};o.current?r.current.broadcastToGuests(O):r.current.sendMessageToHost(O)}},[t,r,a,o,i]),g=$.useCallback((T,L)=>{var O;const E={playerId:T,selectedByPlayerId:L,timestamp:Date.now()};if(d(D=>[...D,E]),((O=t.current)==null?void 0:O.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:a.current.gameId,deckSelectionData:E}));else if(r.current){const D={type:"DECK_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:E,timestamp:Date.now()};o.current?r.current.broadcastToGuests(D):r.current.sendMessageToHost(D)}setTimeout(()=>{d(D=>D.filter(k=>k.timestamp!==E.timestamp))},1e3)},[t,r,a,o,d]),y=$.useCallback((T,L,E)=>{var D;const O={playerId:T,cardIndex:L,selectedByPlayerId:E,timestamp:Date.now()};if(h(k=>[...k,O]),((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:a.current.gameId,handCardSelectionData:O}));else if(r.current){const k={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:O,timestamp:Date.now()};o.current?r.current.broadcastToGuests(k):r.current.sendMessageToHost(k)}setTimeout(()=>{h(k=>k.filter(A=>A.timestamp!==O.timestamp))},1e3)},[t,r,a,o,h]),S=$.useCallback(T=>{var L;if(((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"SYNC_VALID_TARGETS",gameId:a.current.gameId,playerId:n.current,...T}));else if(r.current){const E={type:"SYNC_VALID_TARGETS",senderId:r.current.getPeerId(),data:{playerId:n.current,...T},timestamp:Date.now()};o.current?r.current.broadcastToGuests(E):r.current.sendMessageToHost(E)}},[t,r,a,o,n]),w=$.useCallback((T,L,E)=>{var D;if(n.current===null)return;const O={timestamp:Date.now(),location:T,boardCoords:L,handTarget:E,selectedByPlayerId:n.current};if(R(k=>[...k,O]),((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_TARGET_SELECTION",gameId:a.current.gameId,effect:O}));else if(r.current)if(o.current){const k={type:"TARGET_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:O,timestamp:Date.now()};r.current.broadcastToGuests(k)}else{const k={type:"SET_TARGETING_MODE",senderId:r.current.getPeerId(),data:O,timestamp:Date.now()};r.current.sendMessageToHost(k)}setTimeout(()=>{R(k=>k.filter(A=>A.timestamp!==O.timestamp))},1e3)},[t,r,a,o,n,R]),c=$.useCallback((T,L,E,O,D)=>{var z;const k=a.current;if(!k||!k.board){console.warn("[setTargetingMode] No game state or board available");return}let A;O?A=O:E&&(A=Qt(T,k,L,D));const j={playerId:L,action:T,sourceCoords:E,timestamp:Date.now(),boardTargets:A};if(p(V=>({...V,targetingMode:j})),((z=t.current)==null?void 0:z.readyState)===WebSocket.OPEN&&k.gameId)t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:k.gameId,targetingMode:j}));else if(r.current){const V={type:"SET_TARGETING_MODE",senderId:r.current.getPeerId(),data:j,timestamp:Date.now()};o.current?r.current.broadcastToGuests(V):r.current.sendMessageToHost(V)}},[t,r,a,o,p]),P=$.useCallback(()=>{var L;const T=a.current;if(p(E=>({...E,targetingMode:null})),((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&(T!=null&&T.gameId))t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:T.gameId}));else if(r.current){const E={type:"CLEAR_TARGETING_MODE",senderId:r.current.getPeerId(),data:{},timestamp:Date.now()};o.current?r.current.broadcastToGuests(E):r.current.sendMessageToHost(E)}},[t,r,a,o,p]);return{triggerHighlight:I,triggerFloatingText:b,triggerNoTarget:_,triggerDeckSelection:g,triggerHandCardSelection:y,syncValidTargets:S,triggerTargetSelection:w,setTargetingMode:c,clearTargetingMode:P}}function _o(e){const{ws:t,webrtcManager:r,gameStateRef:a,webrtcIsHostRef:n,setGameState:o,updateState:s}=e,m=$.useCallback(p=>{var b;if(localStorage.getItem("webrtc_enabled")==="true"&&r.current&&n.current){o(_=>{const g=_.players.map(y=>{let S=1;for(const[w,c]of Object.entries(p))if(c.includes(y.id)){S=parseInt(w);break}return{...y,teamId:S}});return{..._,players:g}}),r.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:r.current.getPeerId(),data:{assignments:p},timestamp:Date.now()});return}((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:a.current.gameId,assignments:p}))},[t,r,a,n,o]),i=$.useCallback(p=>{var b;if(localStorage.getItem("webrtc_enabled")==="true"&&r.current&&n.current){o(_=>({..._,gameMode:p})),r.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:r.current.getPeerId(),data:{mode:p},timestamp:Date.now()});return}((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:a.current.gameId,mode:p}))},[t,r,a,n,o]),d=$.useCallback(p=>{var b;if(localStorage.getItem("webrtc_enabled")==="true"&&r.current&&n.current){o(_=>({..._,isPrivate:p})),r.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:r.current.getPeerId(),data:{isPrivate:p},timestamp:Date.now()});return}((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:a.current.gameId,isPrivate:p}))},[t,r,a,n,o]),h=$.useCallback(p=>{s(I=>{if(I.isGameStarted)return I;const b={...I,activeGridSize:p};if(I.board.length!==p){b.board=[];for(let g=0;g<p;g++){const y=[];for(let S=0;S<p;S++)y.push({card:null});b.board.push(y)}}return b})},[s]),R=$.useCallback(p=>{s(I=>{if(I.isGameStarted)return I;const b=I.players.filter(y=>!y.isDummy);if(b.length+p>$n)return I;const _=[...b],g=Math.max(...b.map(y=>y.id),0);for(let y=0;y<p;y++){const S=g+y+1,w=ba(S,!0);w.name=`Dummy ${y+1}`,_.push(w)}return{...I,players:_,dummyPlayerCount:p}})},[s]);return{assignTeams:m,setGameMode:i,setGamePrivacy:d,setActiveGridSize:h,setDummyPlayerCount:R}}function wo(e){const{ws:t,webrtcManager:r,gameStateRef:a,localPlayerIdRef:n,webrtcIsHostRef:o,setGameState:s}=e,m=$.useCallback(()=>{var R;if(localStorage.getItem("webrtc_enabled")==="true"&&r.current&&o.current){s(p=>({...p,isReadyCheckActive:!0,isPrivate:!0})),r.current.broadcastToGuests({type:"START_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:a.current.gameId}))},[t,r,a,o,s]),i=$.useCallback(()=>{var R;if(localStorage.getItem("webrtc_enabled")==="true"&&r.current&&o.current){s(p=>({...p,isReadyCheckActive:!1})),r.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&a.current.gameId?t.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:a.current.gameId})):s(p=>({...p,isReadyCheckActive:!1}))},[t,r,a,o,s]),d=$.useCallback(()=>{var R;const h=localStorage.getItem("webrtc_enabled")==="true";if(h&&r.current&&o.current&&n.current!==null){s(p=>{const I=p.players.map(y=>y.id===n.current?{...y,isReady:!0}:y),b={...p,players:I},_=b.players.filter(y=>!y.isDummy&&!y.isDisconnected);if(_.length>0&&_.every(y=>y.isReady)&&b.isReadyCheckActive&&!b.isGameStarted){const y=b.players.filter(L=>!L.isDisconnected),S=Math.floor(Math.random()*y.length),w=y[S].id,c={...b};c.isReadyCheckActive=!1,c.isGameStarted=!0,c.startingPlayerId=w,c.activePlayerId=w,c.currentPhase=0,c.players=c.players.map(L=>{if(L.hand.length===0&&L.deck.length>0){const O=[...L.hand],D=[...L.deck];for(let k=0;k<6&&k<D.length;k++){const A=D[0];D.splice(0,1),O.push(A)}return f.info(`[playerReady] Drew initial ${O.length} cards for player ${L.id}`),{...L,hand:O,deck:D}}return L});const P=c.players.find(L=>L.id===w);if(P&&P.deck.length>0){const L=P.deck[0],E=[...P.deck.slice(1)],O=[...P.hand,L];c.players=c.players.map(D=>D.id===w?{...D,deck:E,hand:O,readySetup:!1,readyCommit:!1}:D),c.currentPhase=1}const T=Ct(b,c,n.current||0);return r.current.broadcastToGuests({type:"GAME_START",senderId:r.current.getPeerId(),data:{startingPlayerId:w,activePlayerId:w,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{bt(T)||r.current.broadcastStateDelta(T)},50),c}return r.current.broadcastToGuests({type:"HOST_READY",senderId:r.current.getPeerId(),playerId:n.current??void 0,timestamp:Date.now()}),b});return}if(h&&r.current&&!o.current&&n.current!==null){r.current.sendMessageToHost({type:"PLAYER_READY",senderId:r.current.getPeerId(),playerId:n.current,timestamp:Date.now()}),s(p=>({...p,players:p.players.map(I=>I.id===n.current?{...I,isReady:!0}:I)}));return}((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&a.current.gameId&&n.current!==null&&t.current.send(JSON.stringify({type:"PLAYER_READY",gameId:a.current.gameId,playerId:n.current}))},[t,r,a,n,o,s]);return{startReadyCheck:m,cancelReadyCheck:i,playerReady:d}}function Do(e){const{updateState:t}=e,r=$.useCallback((n,o)=>{t(s=>s.isGameStarted?s:{...s,players:s.players.map(m=>m.id===n?{...m,name:o}:m)})},[t]),a=$.useCallback((n,o)=>{t(s=>({...s,players:s.players.map(m=>m.id===n?{...m,color:o}:m)}))},[t]);return{updatePlayerName:r,changePlayerColor:a}}function Co(e){const{updateState:t}=e,r=$.useCallback(m=>{t(i=>{if(!i.isGameStarted)return i;const d=i.players.find(I=>I.id===m);if(!d||d.deck.length===0)return i;const h=Ne(i),R=h.players.find(I=>I.id===m),p=R.deck.shift();return p&&R.hand.push(p),h})},[t]),a=$.useCallback((m,i)=>{i<=0||t(d=>{if(!d.isGameStarted)return d;const h=d.players.find(b=>b.id===m);if(!h||h.deck.length===0)return d;const R=Ne(d),p=R.players.find(b=>b.id===m),I=Math.min(i,p.deck.length);for(let b=0;b<I;b++){const _=p.deck.shift();_&&p.hand.push(_)}return R})},[t]),n=$.useCallback(m=>{t(i=>{if(!i.isGameStarted||!i.players.find(p=>p.id===m))return i;const h=Ne(i),R=h.players.find(p=>p.id===m);return R.deck=tr([...R.deck]),h})},[t]),o=$.useCallback(m=>{t(i=>{if(!i.isGameStarted)return i;const d={...i},h=d.board[m.row][m.col].card;return h&&(h.isFaceDown=!1),{...d,board:Qe(d)}})},[t]),s=$.useCallback(m=>{t(i=>{if(!i.isGameStarted)return i;const d={...i},h=d.board[m.row][m.col].card;return h&&(h.isFaceDown=!0),{...d,board:Qe(d)}})},[t]);return{drawCard:r,drawCardsBatch:a,shufflePlayerDeck:n,flipBoardCard:o,flipBoardCardFaceDown:s}}function bo(e){const{localPlayerIdRef:t,updateState:r}=e,a=$.useCallback((y,S,w)=>{r(c=>{var L,E;if(!c.isGameStarted)return c;const P=Ne(c),T=P.board[y.row][y.col].card;if(T){if(S==="Stun"&&(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius")&&((L=T.types)!=null&&L.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(S)&&((E=T.statuses)==null?void 0:E.some(D=>D.type===S&&D.addedByPlayerId===w)))return c;T.statuses||(T.statuses=[]),T.statuses.push({type:S,addedByPlayerId:w})}return P})},[r]),n=$.useCallback((y,S)=>{r(w=>{if(!w.isGameStarted)return w;const c=Ne(w),P=c.board[y.row][y.col].card;if(P!=null&&P.statuses){const T=P.statuses.map(L=>L.type).lastIndexOf(S);T>-1&&P.statuses.splice(T,1)}return c.board=Qe(c),c})},[r]),o=$.useCallback((y,S,w)=>{r(c=>{if(!c.isGameStarted)return c;const P=Ne(c),T=P.board[y.row][y.col].card;if(T!=null&&T.statuses){const L=T.statuses.findIndex(E=>E.type===S&&E.addedByPlayerId===w);L>-1&&T.statuses.splice(L,1)}return P.board=Qe(P),P})},[r]),s=$.useCallback((y,S)=>{r(w=>{if(!w.isGameStarted)return w;const c=Ne(w),P=c.board[y.row][y.col].card;return P&&(P.powerModifier===void 0&&(P.powerModifier=0),P.powerModifier+=S),c})},[r]),m=$.useCallback((y,S,w)=>{r(c=>{var L;if(!c.isGameStarted)return c;const P=Ne(c),T=P.players.find(E=>E.id===y);if(T!=null&&T.announcedCard){if(["Support","Threat","Revealed"].includes(S)&&((L=T.announcedCard.statuses)==null?void 0:L.some(O=>O.type===S&&O.addedByPlayerId===w)))return c;T.announcedCard.statuses||(T.announcedCard.statuses=[]),T.announcedCard.statuses.push({type:S,addedByPlayerId:w})}return P})},[r]),i=$.useCallback((y,S)=>{r(w=>{var T;if(!w.isGameStarted)return w;const c=Ne(w),P=c.players.find(L=>L.id===y);if((T=P==null?void 0:P.announcedCard)!=null&&T.statuses){const L=P.announcedCard.statuses.map(E=>E.type).lastIndexOf(S);L>-1&&P.announcedCard.statuses.splice(L,1)}return c})},[r]),d=$.useCallback((y,S)=>{r(w=>{if(!w.isGameStarted)return w;const c=Ne(w),P=c.players.find(T=>T.id===y);return P!=null&&P.announcedCard&&(P.announcedCard.powerModifier===void 0&&(P.announcedCard.powerModifier=0),P.announcedCard.powerModifier+=S),c})},[r]),h=$.useCallback((y,S,w,c)=>{r(P=>{var E;if(!P.isGameStarted)return P;const T=Ne(P),L=T.players.find(O=>O.id===y);if(L!=null&&L.hand[S]){const O=L.hand[S];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(w)&&((E=O.statuses)==null?void 0:E.some(k=>k.type===w&&k.addedByPlayerId===c)))return P;O.statuses||(O.statuses=[]),O.statuses.push({type:w,addedByPlayerId:c})}return T})},[r]),R=$.useCallback((y,S,w)=>{r(c=>{if(!c.isGameStarted)return c;const P=Ne(c),T=P.players.find(E=>E.id===y),L=T==null?void 0:T.hand[S];if(L!=null&&L.statuses){const E=L.statuses.map(O=>O.type).lastIndexOf(w);E>-1&&L.statuses.splice(E,1),w==="Revealed"&&(L.statuses.some(D=>D.type==="Revealed")||delete L.revealedTo)}return P})},[r]),p=$.useCallback((y,S,w)=>{r(c=>{const P=c.players.find(E=>E.id===y);if(!(P!=null&&P.hand[S]))return c;const T=Ne(c),L=T.players.find(E=>E.id===y).hand[S];if(w==="all")L.revealedTo="all",L.statuses||(L.statuses=[]),L.statuses.some(E=>E.type==="Revealed"&&E.addedByPlayerId===y)||L.statuses.push({type:"Revealed",addedByPlayerId:y});else{(!L.revealedTo||L.revealedTo==="all"||!Array.isArray(L.revealedTo))&&(L.revealedTo=[]);const E=w.filter(O=>!L.revealedTo.includes(O));L.revealedTo.push(...E)}return T})},[r]),I=$.useCallback((y,S)=>{r(w=>{if(!w.board[y.row][y.col].card)return w;const P=Ne(w),T=P.board[y.row][y.col].card,L=T.ownerId;if(S==="all")T.revealedTo="all",L!==void 0&&(T.statuses||(T.statuses=[]),T.statuses.some(E=>E.type==="Revealed"&&E.addedByPlayerId===L)||T.statuses.push({type:"Revealed",addedByPlayerId:L}));else{(!T.revealedTo||T.revealedTo==="all"||!Array.isArray(T.revealedTo))&&(T.revealedTo=[]);const E=S.filter(O=>!T.revealedTo.includes(O));T.revealedTo.push(...E)}return P})},[r]),b=$.useCallback((y,S)=>{r(w=>{var L;const c=y.boardCoords?(L=w.board[y.boardCoords.row][y.boardCoords.col].card)==null?void 0:L.ownerId:y.ownerId;if(!c)return w;const P=Ne(w),T=P.revealRequests.find(E=>E.fromPlayerId===S&&E.toPlayerId===c);return T?T.cardIdentifiers.some(O=>JSON.stringify(O)===JSON.stringify(y))||T.cardIdentifiers.push(y):P.revealRequests.push({fromPlayerId:S,toPlayerId:c,cardIdentifiers:[y]}),P})},[r]),_=$.useCallback((y,S)=>{r(w=>{const c=w.revealRequests.findIndex(L=>L.toPlayerId===t.current&&L.fromPlayerId===y);if(c===-1)return w;const P=Ne(w),T=P.revealRequests[c];if(S){const{cardIdentifiers:L}=T;for(const E of L){let O=null;if(E.source==="board"&&E.boardCoords)O=P.board[E.boardCoords.row][E.boardCoords.col].card;else if(E.source==="hand"&&E.ownerId&&E.cardIndex!==void 0){const D=P.players.find(k=>k.id===E.ownerId);D&&(O=D.hand[E.cardIndex])}O&&(O.statuses||(O.statuses=[]),O.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===y)||O.statuses.push({type:"Revealed",addedByPlayerId:y}))}}return P.revealRequests.splice(c,1),P})},[r,t]),g=$.useCallback(y=>{r(S=>{const w=Ne(S);let c=null;if(y.source==="board"&&y.boardCoords)c=w.board[y.boardCoords.row][y.boardCoords.col].card;else if(y.source==="hand"&&y.playerId&&y.cardIndex!==void 0){const P=w.players.find(T=>T.id===y.playerId);P&&(c=P.hand[y.cardIndex])}return c&&(c.statuses&&(c.statuses=c.statuses.filter(P=>P.type!=="Revealed")),delete c.revealedTo),w})},[r]);return{addBoardCardStatus:a,removeBoardCardStatus:n,removeBoardCardStatusByOwner:o,modifyBoardCardPower:s,addAnnouncedCardStatus:m,removeAnnouncedCardStatus:i,modifyAnnouncedCardPower:d,addHandCardStatus:h,removeHandCardStatus:R,revealHandCard:p,revealBoardCard:I,requestCardReveal:b,respondToRevealRequest:_,removeRevealedStatus:g}}function Ro(e){const{webrtcIsHostRef:t,sendWebrtcAction:r,getCardDefinition:a,commandCardIds:n,createDeck:o,updateState:s}=e,m=$.useCallback((I,b)=>{const _=localStorage.getItem("webrtc_enabled")==="true";s(g=>g.isGameStarted?g:{...g,players:g.players.map(y=>y.id===I?{...y,deck:o(b,I,y.name),selectedDeck:b,hand:[],discard:[],announcedCard:null,boardHistory:[]}:y)}),_&&!t.current&&r&&r("CHANGE_PLAYER_DECK",{playerId:I,deckType:b})},[s,o,r,t]),i=$.useCallback((I,b)=>{s(_=>{if(_.isGameStarted)return _;const g=_.players.find(w=>w.id===I);if(!g)return _;const y=[],S=new Map;for(const{cardId:w,quantity:c}of b.cards){const P=a(w);if(!P)continue;const T=n.has(w),L=T?Je.Command:Je.Custom,E=T?"CMD":"CUS";for(let O=0;O<c;O++){const D=(S.get(w)||0)+1;S.set(w,D),y.push({...P,id:`${E}_${w.toUpperCase()}_${D}`,baseId:w,deck:L,ownerId:I,ownerName:g.name})}}return{..._,players:_.players.map(w=>w.id===I?{...w,deck:tr(y),selectedDeck:Je.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:w)}})},[s,a,n]),d=$.useCallback((I,b,_,g)=>{s(y=>{if(!y.isGameStarted||y.board[_.row][_.col].card!==null)return y;const S=Ne(y),w=S.players.find(c=>c.id===I);if(w&&w.discard.length>b){const[c]=w.discard.splice(b,1);c.enteredThisTurn=!0,Dr(c,I),(c.baseId==="luciusTheImmortal"||c.name.includes("Lucius"))&&(c.powerModifier===void 0&&(c.powerModifier=0),c.powerModifier+=2),c.statuses||(c.statuses=[]),c.statuses.push({type:"Resurrected",addedByPlayerId:I}),g&&g.forEach(P=>{var T;P.type!=="Resurrected"&&((T=c.statuses)==null||T.push({type:P.type,addedByPlayerId:I}))}),w.boardHistory||(w.boardHistory=[]),w.boardHistory.push(c.id),S.board[_.row][_.col].card=c,Da(S.board,w),S.board=Qe(S)}return S})},[s]),h=$.useCallback((I,b)=>{s(_=>{const g=Ne(_),y=g.players.find(S=>S.id===I);if(y&&b.length>0){const S=new Set(b.map(c=>c.id)),w=y.deck.filter(c=>!S.has(c.id));y.deck=[...b,...w]}return g})},[s]),R=$.useCallback((I,b,_)=>{s(g=>{const y=Ne(g),S=y.players.find(w=>w.id===I);return S&&(_==="deck"?S.deck=b:_==="discard"&&(S.discard=b)),y})},[s]),p=$.useCallback((I,b)=>{s(_=>{if(!_.isGameStarted)return _;const g=Ne(_),y=g.players.find(S=>S.id===I);if(y&&y.discard.length>b){const[S]=y.discard.splice(b,1);y.hand.push(S)}return g})},[s]);return{changePlayerDeck:m,loadCustomDeck:i,resurrectDiscardedCard:d,reorderTopDeck:h,reorderCards:R,recoverDiscardedCard:p}}function So(e){const{ws:t,webrtcManagerRef:r,webrtcIsHostRef:a,gameStateRef:n,scoreDeltaAccumulator:o,setGameState:s,updateState:m,abilityMode:i,setAbilityMode:d,createDeck:h}=e,R=$.useCallback(w=>{localStorage.getItem("webrtc_enabled")==="true"&&r.current?a.current?s(P=>{const T=wa(P,w);return r.current&&r.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:r.current.getPeerId(),data:{activePlayerId:T.activePlayerId,currentPhase:T.currentPhase,turnNumber:T.turnNumber},timestamp:Date.now()}),T}):r.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:w},timestamp:Date.now()}):t.current&&t.current.readyState===WebSocket.OPEN&&(o.forEach((P,T)=>{clearTimeout(P.timerId),f.info(`[ScoreFlush] Flushing on toggle: player=${T}, delta=${P.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:n.current.gameId,playerId:T,delta:P.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:n.current.gameId,playerId:w})))},[t,r,a,n,o,s]),p=$.useCallback((w,c)=>{t.current&&t.current.readyState===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:n.current.gameId,playerId:w,enabled:c}))},[]),I=$.useCallback(w=>{const c=i&&d&&i.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(i.mode);c&&d(null),m(P=>{if(!P.isGameStarted)return P;const T=Math.max(1,Math.min(w,4));return{...P,currentPhase:T,...T===4&&!c?{isScoringStep:!0}:{},...c?{isScoringStep:!1}:{}}})},[m,i,d]),b=$.useCallback(()=>{var P;i&&d&&i.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(i.mode)&&d(null);const w=n.current,c=localStorage.getItem("webrtc_enabled")==="true";if(w.isGameStarted&&w.currentPhase===4&&w.isScoringStep&&!c){((P=t.current)==null?void 0:P.readyState)===WebSocket.OPEN&&(o.forEach((T,L)=>{clearTimeout(T.timerId),f.info(`[ScoreFlush] Flushing pending score: player=${L}, delta=${T.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:w.gameId,playerId:L,delta:T.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:w.gameId})));return}if(c&&w.isGameStarted&&w.currentPhase===4&&w.isScoringStep){m(T=>Xt(T));return}m(T=>{if(!T.isGameStarted)return T;const L=Ne(T),E=T.currentPhase+1;return T.preserveDeployAbilities||L.board.forEach(O=>{O.forEach(D=>{var k;(k=D.card)!=null&&k.statuses&&(D.card.statuses=D.card.statuses.filter(A=>A.type!=="readyDeploy"))})}),c&&E===4&&T.currentPhase===3?yo(T,T.activePlayerId)?(L.isScoringStep=!0,L.currentPhase=4,L):(f.info(`[nextPhase] Player ${T.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),Xt(T)):E===4&&T.currentPhase===3?(L.isScoringStep=!0,L.currentPhase=4,L):(L.board.forEach(O=>{O.forEach(D=>{var k;if((k=D.card)!=null&&k.statuses){const A=D.card.statuses.findIndex(j=>j.type==="Resurrected");if(A!==-1){const j=D.card.statuses[A].addedByPlayerId;D.card.statuses.splice(A,1),D.card.baseId!=="luciusTheImmortal"&&(D.card.statuses.push({type:"Stun",addedByPlayerId:j}),D.card.statuses.push({type:"Stun",addedByPlayerId:j}))}}})}),L.board=Qe(L),L.currentPhase=E,L)})},[m,i,d,n,t,o]),_=$.useCallback(()=>{m(w=>w.isGameStarted?(i&&d&&i.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(i.mode)&&d(null),w.isScoringStep?{...w,isScoringStep:!1,currentPhase:Math.max(1,w.currentPhase-1)}:{...w,currentPhase:Math.max(1,w.currentPhase-1)}):w)},[m,i,d]),g=$.useCallback(()=>{var c;localStorage.getItem("webrtc_enabled")==="true"?m(P=>({...P,isRoundEndModalOpen:!1,currentRound:(P.currentRound||1)+1,players:P.players.map(T=>({...T,score:0}))})):((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&n.current.gameId&&(s(P=>({...P,isRoundEndModalOpen:!1,currentRound:(P.currentRound||1)+1,players:P.players.map(T=>({...T,score:0}))})),t.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:n.current.gameId})))},[s,m,t,n]),y=$.useCallback(()=>{s(w=>({...w,isRoundEndModalOpen:!1}))},[s]),S=$.useCallback(()=>{var c;if(localStorage.getItem("webrtc_enabled")==="true"){const P=n.current,T=P.players.map(D=>{const k=D.selectedDeck||"SynchroTech";return{...D,hand:[],deck:h(k,D.id,D.name),discard:[],score:0,isReady:!1,announcedCard:null,boardHistory:[]}}),L=P.activeGridSize||8,E=[];for(let D=0;D<L;D++){const k=[];for(let A=0;A<L;A++)k.push({card:null});E.push(k)}const O={...P,players:T,board:E,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};s(O),n.current=O,r.current&&r.current.broadcastToGuests({type:"GAME_RESET",senderId:r.current.getPeerId(),data:{players:T.map(D=>({id:D.id,name:D.name,color:D.color,selectedDeck:D.selectedDeck,isDummy:D.isDummy,isDisconnected:D.isDisconnected,autoDrawEnabled:D.autoDrawEnabled,handSize:D.hand.length,deckSize:D.deck.length,discardSize:D.discard.length,...D.isDummy&&{hand:D.hand.map(k=>({id:k.id,baseId:k.baseId,name:k.name,imageUrl:k.imageUrl,power:k.power,powerModifier:k.powerModifier,ability:k.ability,ownerId:k.ownerId,color:k.color,deck:k.deck,isFaceDown:k.isFaceDown,types:k.types,faction:k.faction,statuses:k.statuses})),deck:D.deck.map(k=>({id:k.id,baseId:k.baseId,name:k.name,imageUrl:k.imageUrl,power:k.power,powerModifier:k.powerModifier,ability:k.ability,ownerId:k.ownerId,color:k.color,deck:k.deck,isFaceDown:k.isFaceDown,types:k.types,faction:k.faction,statuses:k.statuses})),discard:D.discard.map(k=>({id:k.id,baseId:k.baseId,name:k.name,imageUrl:k.imageUrl,power:k.power,powerModifier:k.powerModifier,ability:k.ability,ownerId:k.ownerId,color:k.color,deck:k.deck,isFaceDown:k.isFaceDown,types:k.types,faction:k.faction,statuses:k.statuses}))},score:D.score,isReady:D.isReady,announcedCard:D.announcedCard})),gameMode:O.gameMode,isPrivate:O.isPrivate,activeGridSize:O.activeGridSize,dummyPlayerCount:O.dummyPlayerCount,autoAbilitiesEnabled:O.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"RESET_GAME",gameId:n.current.gameId}))},[t,r,n,s,h]);return{toggleActivePlayer:R,toggleAutoDraw:p,setPhase:I,nextPhase:b,prevPhase:_,closeRoundEndModal:g,closeRoundEndModalOnly:y,resetGame:S}}function Ao(e){const{ws:t,gameStateRef:r,updateState:a,updatePlayerScore:n,triggerFloatingText:o}=e,s=$.useCallback((i,d,h,R,p)=>{var L,E;const I=r.current;if(!I.isGameStarted||I.isRoundEndModalOpen)return;const b=I.board.some(O=>O.some(D=>{var k,A;return((k=D.card)==null?void 0:k.ownerId)===p&&D.card.name.toLowerCase().includes("data liberator")&&((A=D.card.statuses)==null?void 0:A.some(j=>j.type==="Support"))})),_=I.board.length;let g=i,y=i,S=d,w=d;if(i===h)g=i,y=i,S=0,w=_-1;else if(d===R)S=d,w=d,g=0,y=_-1;else return;let c=0;const P=[];for(let O=g;O<=y;O++)for(let D=S;D<=w;D++){const A=I.board[O][D].card;if(A&&!((L=A.statuses)!=null&&L.some(j=>j.type==="Stun"))){const j=A.ownerId===p,z=(E=A.statuses)==null?void 0:E.some(V=>V.type==="Exploit"&&V.addedByPlayerId===p);if(j||b&&z&&A.ownerId!==p){const V=Math.max(0,A.power+(A.powerModifier||0)+(A.bonusPower||0));V>0&&(c+=V,P.push({row:O,col:D,text:`+${V}`,playerId:p}))}}}P.length>0&&o(P);const T=localStorage.getItem("webrtc_enabled")==="true";T?a(O=>({...O,players:O.players.map(D=>D.id===p?{...D,score:Math.max(0,(D.score||0)+c)}:D)})):n(p,c),T||n(p,c),c>0&&I.currentPhase===4&&I.activePlayerId===p&&setTimeout(()=>{var O;T?a(D=>Xt(D)):((O=t.current)==null?void 0:O.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:I.gameId}))},100)},[o,n,a,t,r]),m=$.useCallback((i,d,h,R,p,I)=>{var T,L;const b=r.current;if(!b.isGameStarted||b.isRoundEndModalOpen)return;const _=h>i?1:-1,g=R>d?1:-1,y=Math.abs(i-h);let S=0,w=0;const c=[];for(let E=0;E<=y;E++){const O=i+E*_,D=d+E*g;if(O<0||O>=b.board.length||D<0||D>=b.board.length)continue;const A=b.board[O][D].card;if(A&&!((T=A.statuses)!=null&&T.some(j=>j.type==="Stun"))&&A.ownerId===p){const z=Math.max(0,A.power+(A.powerModifier||0)+(A.bonusPower||0));z>0&&(S+=z,c.push({row:O,col:D,text:`+${z}`,playerId:p})),I&&((L=A.statuses)!=null&&L.some(V=>V.type==="Support"&&V.addedByPlayerId===p))&&(w+=1)}}I==="point_per_support"&&w>0&&(S+=w),c.length>0&&o(c);const P=localStorage.getItem("webrtc_enabled")==="true";P?a(E=>({...E,players:E.players.map(O=>O.id===p?{...O,score:Math.max(0,(O.score||0)+S)}:O)})):n(p,S),P||n(p,S),I==="draw_per_support"&&w>0&&a(E=>{const O=Ne(E),D=O.players.find(k=>k.id===p);if(D&&D.deck.length>0)for(let k=0;k<w;k++)D.deck.length>0&&D.hand.push(D.deck.shift());return O}),S>0&&b.currentPhase===4&&b.activePlayerId===p&&setTimeout(()=>{var E;P?a(O=>Xt(O)):((E=t.current)==null?void 0:E.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:b.gameId}))},500)},[o,n,a,t,r]);return{scoreLine:s,scoreDiagonal:m}}const Oo=e=>{const{updateState:t,rawJsonData:r}=e,a=$.useCallback((R,p,I,b)=>{t(_=>{if(!_.isGameStarted)return _;const g=Ne(_),y=g.board[R.row][R.col].card;if(y){const S=y.statuses?y.statuses.map(w=>w.type):[];if(b&&y.statuses){y.statuses=y.statuses.filter(c=>c.type!==b);const w=y.statuses.map(c=>c.type);console.log(`[markAbilityUsed] Removed status '${b}' from ${y.name} at [${R.row},${R.col}]: [${S.join(", ")}] -> [${w.join(", ")}]`)}else console.log(`[markAbilityUsed] Called for ${y.name} at [${R.row},${R.col}] but no readyStatusToRemove specified. Current statuses: [${S.join(", ")}]`)}return g})},[t]),n=$.useCallback(R=>{t(p=>{if(!p.isGameStarted)return p;const I=Ne(p),b=I.board[R.row][R.col].card;if(b&&(b.statuses||(b.statuses=[]),(b.ability||"").toLowerCase().includes("deploy:")&&!b.statuses.some(g=>g.type==="readyDeploy"))){const g=b.ownerId;if(g==null||g===0)return p;b.statuses.push({type:"readyDeploy",addedByPlayerId:g})}return I})},[t]),o=$.useCallback((R,p)=>{t(I=>{if(!I.isGameStarted)return I;const b=Ne(I),_=b.board[R.row][R.col].card;return _!=null&&_.statuses&&(_.statuses=_.statuses.filter(g=>g.type!==p)),b.board=Qe(b),b})},[t]),s=$.useCallback((R,p,I,b,_)=>{t(g=>{if(!g.isGameStarted)return g;const y=Ne(g);return p.forEach(({row:S,col:w})=>{var P;const c=y.board[S][w].card;if(c){if(I==="Stun"&&(c.baseId==="luciusTheImmortal"||c.name.includes("Lucius")&&((P=c.types)!=null&&P.includes("Hero"))))return;c.statuses||(c.statuses=[]),["Support","Threat","Revealed"].includes(I)?c.statuses.some(L=>L.type===I&&L.addedByPlayerId===b)||c.statuses.push({type:I,addedByPlayerId:b}):c.statuses.push({type:I,addedByPlayerId:b})}}),y})},[t]),m=$.useCallback((R,p)=>{t(I=>{if(!I.isGameStarted)return I;const b=Ne(I),_=b.board[R.row][R.col].card,g=b.board[p.row][p.col].card;return b.board[R.row][R.col].card=g,b.board[p.row][p.col].card=_,b.board=Qe(b),b})},[t]),i=$.useCallback((R,p,I)=>{t(b=>{if(!b.isGameStarted)return b;const _=Ne(b),g=_.board[R.row][R.col].card,y=_.board[p.row][p.col].card;if(g&&y&&g.statuses){const S=g.statuses.findIndex(w=>w.type===I);if(S>-1){const[w]=g.statuses.splice(S,1);y.statuses||(y.statuses=[]),y.statuses.push(w)}}return _.board=Qe(_),_})},[t]),d=$.useCallback((R,p)=>{t(I=>{if(!I.isGameStarted)return I;const b=Ne(I),_=b.board[R.row][R.col].card,g=b.board[p.row][p.col].card,y=["Support","Threat","LastPlayed"];if(_&&g&&_.statuses){const S=_.statuses.filter(c=>!y.includes(c.type)),w=_.statuses.filter(c=>y.includes(c.type));S.length>0&&(g.statuses||(g.statuses=[]),g.statuses.push(...S),_.statuses=w)}return b.board=Qe(b),b})},[t]),h=$.useCallback((R,p,I)=>{t(b=>{if(!b.isGameStarted)return b;const _=Ne(b);if(!r)return b;const g=r.tokenDatabase,y=Object.keys(g).find(c=>g[c].name===p);if(!y)return b;const S=g[y],w=_.players.find(c=>c.id===I);if(S&&_.board[R.row][R.col].card===null){const c={id:`TKN_${p.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:Je.Tokens,name:p,baseId:S.baseId||y,imageUrl:S.imageUrl,fallbackImage:S.fallbackImage,power:S.power,ability:S.ability,flavorText:S.flavorText,color:S.color,types:S.types||["Unit"],faction:"Tokens",ownerId:I,ownerName:w==null?void 0:w.name,enteredThisTurn:!0,statuses:[]};Dr(c,I),_.board[R.row][R.col].card=c}return _.board=Qe(_),_})},[t,r]);return{markAbilityUsed:a,applyGlobalEffect:s,swapCards:m,transferStatus:i,transferAllCounters:d,spawnToken:h,resetDeployStatus:n,removeStatusByType:o}};function Po(e){const{updateState:t,localPlayerIdRef:r,updatePlayerScore:a}=e;return{moveItem:$.useCallback((o,s)=>{t(m=>{var b,_,g,y,S,w,c,P,T,L;if(!m.isGameStarted||s.target==="board"&&s.boardCoords&&m.board[s.boardCoords.row][s.boardCoords.col].card!==null&&o.source!=="counter_panel")return m;let i=!1;try{const E=localStorage.getItem("auto_abilities_enabled");i=E===null?!0:E==="true"}catch{i=!0}const d=i&&m.currentPhase===1&&o.source==="hand"&&s.target==="board"&&(((b=o.card.types)==null?void 0:b.includes("Unit"))||((_=o.card.types)==null?void 0:_.includes("Command"))),h=Ne(m);if(o.source==="board"&&["hand","deck","discard"].includes(s.target)&&!o.bypassOwnershipCheck){const E=o.card.ownerId,O=h.players.find(A=>A.id===E),D=E===r.current,k=!!(O!=null&&O.isDummy);if(!D&&!k)return m}let R=null;if(o.source==="board"&&s.target==="board"&&o.boardCoords){const E=h.board[o.boardCoords.row][o.boardCoords.col];E.card&&(R=E.card);const D=m.board[o.boardCoords.row][o.boardCoords.col].card||R;if(D&&((g=D.statuses)==null?void 0:g.some(A=>A.type==="Stun"))){const A=r.current,j=D.ownerId,z=m.players.find(he=>he.id===A),V=m.players.find(he=>he.id===j),J=A===j,fe=(z==null?void 0:z.teamId)!==void 0&&(V==null?void 0:V.teamId)!==void 0&&z.teamId===V.teamId;if((J||fe)&&!o.isManual)return m}}if(o.source==="counter_panel"&&o.statusType){const E=At[o.statusType];if(!((E==null?void 0:E.allowedTargets)??["board","hand"]).includes(s.target))return m;let D=null;if(s.target==="board"&&s.boardCoords)D=h.board[s.boardCoords.row][s.boardCoords.col].card;else if(s.playerId!==void 0){const k=h.players.find(A=>A.id===s.playerId);k&&(s.target==="hand"&&s.cardIndex!==void 0&&(D=k.hand[s.cardIndex]),s.target==="announced"&&(D=k.announcedCard||null),s.target==="deck"&&k.deck.length>0?s.deckPosition==="top"||!s.deckPosition?D=k.deck[0]:D=k.deck[k.deck.length-1]:s.target==="discard"&&k.discard.length>0&&(D=k.discard[k.discard.length-1]))}if(D){if(o.statusType==="Stun"&&(D.baseId==="luciusTheImmortal"||D.name.includes("Lucius")&&((y=D.types)!=null&&y.includes("Hero"))))return h;const k=o.count||1;let A;if(o.ownerId!==void 0)A=o.ownerId;else if(o.card.ownerId!==void 0)A=o.card.ownerId;else{const j=h.players.find(z=>z.id===h.activePlayerId);A=j!=null&&j.isDummy?j.id:r.current!==null?r.current:0}if(o.statusType==="Power+")D.powerModifier===void 0&&(D.powerModifier=0),D.powerModifier+=1*k;else if(o.statusType==="Power-")D.powerModifier===void 0&&(D.powerModifier=0),D.powerModifier-=1*k;else if(D.statuses||(D.statuses=[]),o.replaceStatusType&&o.statusType)for(let j=0;j<k;j++){const z=D.statuses.findIndex(V=>V.type===o.replaceStatusType&&V.addedByPlayerId===A);z!==-1?D.statuses[z]={type:o.statusType,addedByPlayerId:A}:D.statuses.push({type:o.statusType,addedByPlayerId:A})}else for(let j=0;j<k;j++)["Support","Threat","Revealed"].includes(o.statusType)?D.statuses.some(V=>V.type===o.statusType&&V.addedByPlayerId===A)||D.statuses.push({type:o.statusType,addedByPlayerId:A}):D.statuses.push({type:o.statusType,addedByPlayerId:A});return s.target==="board"&&(h.board=Qe(h)),h}return m}const p=R?{...R}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const E=h.players.find(O=>O.id===o.playerId);if(E){const O=E.hand[o.cardIndex];if(O&&O.id===o.card.id&&O.ownerId===o.card.ownerId)E.hand.splice(o.cardIndex,1);else{const D=E.hand.findIndex(k=>k.id===o.card.id&&k.ownerId===o.card.ownerId);if(D!==-1)E.hand.splice(D,1);else return m}}}else if(o.source==="board"&&o.boardCoords){const E=h.board[o.boardCoords.row][o.boardCoords.col];if(E.card&&E.card.id===o.card.id&&E.card.ownerId===o.card.ownerId)h.board[o.boardCoords.row][o.boardCoords.col].card=null;else return m}else if(o.source==="discard"&&o.playerId!==void 0){const E=h.players.find(O=>O.id===o.playerId);if(E){let O=!1;if(o.cardIndex!==void 0){const D=E.discard[o.cardIndex];D&&D.id===o.card.id&&D.ownerId===o.card.ownerId&&(E.discard.splice(o.cardIndex,1),O=!0)}if(!O){const D=E.discard.findIndex(k=>k.id===o.card.id&&k.ownerId===o.card.ownerId);if(D!==-1)E.discard.splice(D,1);else return m}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const E=h.players.find(O=>O.id===o.playerId);if(E){const O=E.deck[o.cardIndex];if(O&&O.id===o.card.id&&O.ownerId===o.card.ownerId)E.deck.splice(o.cardIndex,1);else{const D=E.deck.findIndex(k=>k.id===o.card.id&&k.ownerId===o.card.ownerId);if(D!==-1)E.deck.splice(D,1);else return m}}}else if(o.source==="announced"&&o.playerId!==void 0){const E=h.players.find(O=>O.id===o.playerId);if(E)if(E.announcedCard&&E.announcedCard.id===o.card.id)E.announcedCard=null;else return m}if(["hand","deck","discard"].includes(s.target))p.statuses&&(p.statuses=p.statuses.filter(E=>E.type==="Revealed")),p.isFaceDown=!1,delete p.powerModifier,delete p.bonusPower,delete p.enteredThisTurn;else if(s.target==="board"&&(p.statuses||(p.statuses=[]),o.source!=="board"&&p.isFaceDown===void 0&&(p.isFaceDown=!1),o.source!=="board")){p.enteredThisTurn=!0;let E=p.ownerId;E===void 0&&(o.source==="token_panel"?E=h.activePlayerId??r.current??0:o.playerId!==void 0?E=o.playerId:E=r.current??0,p.ownerId=E),Dr(p,E),o.source==="discard"&&(p.baseId==="luciusTheImmortal"||p.name.includes("Lucius"))&&(p.powerModifier===void 0&&(p.powerModifier=0),p.powerModifier+=2)}if(s.target==="hand"&&s.playerId!==void 0){if((p.deck===Je.Tokens||p.deck==="counter")&&(((S=p.types)==null?void 0:S.includes("Token"))||((w=p.types)==null?void 0:w.includes("Token Unit"))))return m;ir(p);const O=h.players.find(k=>k.id===s.playerId);if(!O)return m;let D=s.cardIndex!==void 0?s.cardIndex:O.hand.length;if(o.source==="hand"&&o.playerId===s.playerId&&o.cardIndex!==void 0&&(o.cardIndex<D&&(D-=1),o.cardIndex===D))return m;O.hand.splice(D,0,p)}else if(s.target==="board"&&s.boardCoords){if(h.board[s.boardCoords.row][s.boardCoords.col].card===null){if(p.ownerId===void 0&&r.current!==null){const E=h.players.find(O=>O.id===r.current);E&&(p.ownerId=E.id,p.ownerName=E.name)}if(o.source!=="board"&&p.ownerId!==void 0){const E=h.players.find(O=>O.id===p.ownerId);E&&(E.boardHistory||(E.boardHistory=[]),E.boardHistory.push(p.id))}h.board[s.boardCoords.row][s.boardCoords.col].card=p}}else if(s.target==="discard"&&s.playerId!==void 0){if(!(p.deck===Je.Tokens||p.deck==="counter")){ir(p),p.statuses&&(p.statuses=p.statuses.filter(O=>O.type!=="Revealed"));const E=h.players.find(O=>O.id===s.playerId);E&&(p.ownerId===void 0&&(p.ownerId=s.playerId,p.ownerName=E.name),E.discard.some(D=>D.id===p.id)||E.discard.push(p))}}else if(s.target==="deck"&&s.playerId!==void 0){if((p.deck===Je.Tokens||p.deck==="counter")&&(((c=p.types)==null?void 0:c.includes("Token"))||((P=p.types)==null?void 0:P.includes("Token Unit"))))return m;ir(p),p.statuses&&(p.statuses=p.statuses.filter(D=>D.type!=="Revealed"));const O=h.players.find(D=>D.id===s.playerId);if(!O)return m;p.ownerId===void 0&&(p.ownerId=s.playerId,p.ownerName=O.name),s.deckPosition==="top"||!s.deckPosition?O.deck.unshift(p):O.deck.push(p)}else if(s.target==="announced"&&s.playerId!==void 0){const E=h.players.find(O=>O.id===s.playerId);E&&(E.announcedCard&&(E.announcedCard.statuses&&(E.announcedCard.statuses=E.announcedCard.statuses.filter(O=>O.type==="Revealed")),delete E.announcedCard.enteredThisTurn,delete E.announcedCard.powerModifier,delete E.announcedCard.bonusPower,E.hand.push(E.announcedCard)),E.announcedCard=p)}if(o.source==="board"&&s.target!=="board"&&p.ownerId!==void 0){const E=h.players.find(O=>O.id===p.ownerId);E&&(E.boardHistory||(E.boardHistory=[]),E.boardHistory=E.boardHistory.filter(O=>O!==p.id))}if((o.source==="board"||s.target==="board")&&p.ownerId!==void 0){const E=h.players.find(O=>O.id===p.ownerId);E&&Da(h.board,E)}if(o.source==="hand"&&s.target==="board"){const E=p;if(E.revealedTo==="all"||((T=E.statuses)==null?void 0:T.some(D=>D.type==="Revealed"))){const D=h.board.length;for(let k=0;k<D;k++)for(let A=0;A<D;A++){const j=h.board[k][A].card;if(j&&j.name.toLowerCase().includes("vigilant spotter")&&j.ownerId!==E.ownerId&&(h.board=Qe(h),(L=h.board[k][A].card.statuses)!=null&&L.some(V=>V.type==="Support"))){const V=h.players.find(J=>J.id===j.ownerId);V&&setTimeout(()=>{a(V.id,2)},0)}}}}return(o.source==="board"||s.target==="board")&&(h.board=Qe(h)),d&&(h.currentPhase=2),h})},[t,r,a])}}function vo(e){const{ws:t,webrtcManager:r,gameStateRef:a,webrtcIsHostRef:n,setGameState:o}=e,s=$.useCallback((i,d,h,R,p)=>{var S,w,c,P,T,L,E;const I=a.current;let b=[];R?b=R:b=Qt(i,I,d,p);const _=[],g=i.mode==="SELECT_DECK";if((S=i.payload)!=null&&S.filter&&i.mode==="SELECT_TARGET"){const O=((w=i.sourceCard)==null?void 0:w.ownerId)||i.originalOwnerId||d,D=I.players.find(k=>k.id===O);D&&D.hand&&D.hand.forEach((k,A)=>{try{i.payload.filter(k)&&_.push({playerId:D.id,cardIndex:A})}catch{}})}const y={playerId:d,action:i,sourceCoords:h,timestamp:Date.now(),boardTargets:b,handTargets:_.length>0?_:void 0,isDeckSelectable:g||void 0,originalOwnerId:i.originalOwnerId};o(O=>({...O,targetingMode:y})),a.current.targetingMode=y,((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&I.gameId&&t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:I.gameId,targetingMode:y})),r.current&&(n.current?r.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((T=(P=r.current).getPeerId)==null?void 0:T.call(P))??void 0,data:{targetingMode:y},timestamp:Date.now()}):r.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((E=(L=r.current).getPeerId)==null?void 0:E.call(L))??void 0,data:{targetingMode:y},timestamp:Date.now()})),f.info(`[TargetingMode] Player ${d} activated targeting mode`,{mode:i.mode,boardTargetsCount:b.length})},[t,r,a,n,o]),m=$.useCallback(()=>{var d,h,R,p,I;const i=a.current;o(b=>({...b,targetingMode:null})),a.current.targetingMode=null,((d=t.current)==null?void 0:d.readyState)===WebSocket.OPEN&&i.gameId&&t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:i.gameId})),r.current&&(n.current?r.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((R=(h=r.current).getPeerId)==null?void 0:R.call(h))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):r.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((I=(p=r.current).getPeerId)==null?void 0:I.call(p))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[t,r,a,n,o]);return{setTargetingMode:s,clearTargetingMode:m}}function No(e){const{webrtcManagerRef:t,webrtcIsHostRef:r,setWebrtcIsHost:a,setConnectionStatus:n,setWebrtcHostId:o,gameStateRef:s,localPlayerIdRef:m}=e,i=$.useCallback(async()=>{var R;if(!t.current)return f.error("WebRTC manager not initialized"),null;try{a(!0),n("Connecting");const p=await t.current.initializeAsHost();o(p),n("Connected");const I=s.current.gameId;I&&Er(p,I);const b=(R=s.current.players)==null?void 0:R.find(_=>_.id===m.current);return Kn({peerId:p,isHost:!0,playerName:(b==null?void 0:b.name)||null}),f.info("[initializeWebrtcHost] Saved host data for auto-restore"),p}catch(p){return f.error("Failed to initialize WebRTC host:",p),n("Disconnected"),null}},[t,a,n,o,s,m]),d=$.useCallback(async R=>{if(!t.current)return f.error("WebRTC manager not initialized"),!1;try{return a(!1),o(R),n("Connecting"),await t.current.initializeAsGuest(R),!0}catch(p){return f.error("Failed to connect as guest:",p),n("Disconnected"),!1}},[t,a,n,o]),h=$.useCallback((R,p)=>!t.current||r.current?!1:t.current.sendAction(R,p),[t,r]);return{initializeWebrtcHost:i,connectAsGuest:d,sendWebrtcAction:h}}function ko(e){const{ws:t,gameStateRef:r,localPlayerIdRef:a,isRestoringSessionRef:n,isManualExitRef:o,webrtcIsHostRef:s,receivedServerStateRef:m,joiningGameIdRef:i,setGameState:d,setLocalPlayerId:h,connectWebSocket:R,updateState:p}=e,I=$.useCallback(()=>{t.current&&(t.current.readyState===WebSocket.OPEN||t.current.readyState===WebSocket.CONNECTING)?t.current.close():R()},[t,R]),b=$.useCallback(S=>{var w;if(o.current=!1,((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN){i.current=S;let c=null;try{const T=localStorage.getItem(Tt);T&&(c=JSON.parse(T))}catch{St()}const P={type:"JOIN_GAME",gameId:S};(c==null?void 0:c.gameId)===S&&c.playerToken?(P.playerToken=c.playerToken,f.info(`JoinGame: Sending reconnection with token ${c.playerToken.substring(0,8)}... for player ${c.playerId}`)):f.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${c==null?void 0:c.gameId}, requestedGameId=${S}`),t.current.send(JSON.stringify(P))}else R(),i.current=S},[t,o,i,R]),_=$.useCallback(()=>{o.current=!1,St();const S=Ca(),w={...It(),gameId:S,players:[ba(1)]};m.current=!0,p(w),setTimeout(()=>{var c;((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&(t.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:S})),t.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ct})))},we.DECK_SYNC_DELAY)},[p,o,m,t]),g=$.useCallback(()=>{var S;((S=t.current)==null?void 0:S.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[t]),y=$.useCallback(()=>{var c;if(n.current)return;o.current=!0;const S=r.current.gameId,w=a.current;S&&s.current&&qn(S);try{Dt(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),f.info("[exitGame] Cleared WebRTC persistence data")}catch(P){f.warn("[exitGame] Failed to clear WebRTC data:",P)}d(It()),h(null),St(),t.current&&(t.current.onclose=null),((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&S&&w!==null&&t.current.send(JSON.stringify({type:"EXIT_GAME",gameId:S,playerId:w})),t.current&&t.current.close(),setTimeout(()=>{o.current=!1,R()},we.RECONNECT_DELAY)},[n,o,r,a,s,d,h,t,R]);return{createGame:_,requestGamesList:g,exitGame:y,forceReconnect:I,joinGame:b}}const ht=new Map,ts=(e={})=>{const{abilityMode:t,setAbilityMode:r}=e,[a,n]=$.useState(It()),o=$.useRef(It()),s=$.useCallback((l,ee)=>{n(v=>{const B=typeof l=="function"?l(v):l;return o.current=v,localStorage.getItem("webrtc_enabled")==="true"&&ae.current&&setTimeout(()=>{var re;const ne=Ct(v,B,ee||h.current||0);!bt(ne)&&x.current&&(x.current.broadcastStateDelta(ne),f.debug(`[setGameStateWithDelta] Broadcast delta: phase=${!!ne.phaseDelta}, round=${!!ne.roundDelta}, board=${((re=ne.boardCells)==null?void 0:re.length)||0}, players=${Object.keys(ne.playerDeltas||{}).length}`))},0),B})},[]),[m,i]=$.useState(null),d=$.useRef(a),h=$.useRef(m),[R,p]=$.useState(null),[I,b]=$.useState("Connecting"),[_,g]=$.useState([]),[y,S]=$.useState(null),[w,c]=$.useState(null),[P,T]=$.useState(null),[L,E]=$.useState([]),[O,D]=$.useState([]),[k,A]=$.useState([]),[j,z]=$.useState(null),[V,J]=$.useState(!!ct),[fe,he]=$.useState(!1),[Re,Te]=$.useState(null),[Ie,Ke]=$.useState(!1),ae=$.useRef(!1),[lt,Ue]=$.useState(!1),[ut,Xe]=$.useState(null),$e=$.useRef(!1),pe=$.useRef(null),Pe=$.useRef(null),qe=$.useRef(null),u=$.useRef(!1),M=$.useRef(!1),Q=$.useRef(void 0),Ee=$.useRef(!1),x=$.useRef(null),ve=$.useRef(()=>{}),Le=No({webrtcManagerRef:x,webrtcIsHostRef:ae,setWebrtcIsHost:Ke,setConnectionStatus:b,setWebrtcHostId:Te,gameStateRef:d,localPlayerIdRef:h}),{initializeWebrtcHost:Fe,connectAsGuest:Oe,sendWebrtcAction:Ze}=Le;$.useEffect(()=>{ve.current=s},[s]),$.useEffect(()=>{ae.current=Ie},[Ie]),$.useEffect(()=>{const l=localStorage.getItem("webrtc_enabled")==="true";if(he(l),l){x.current=uo();const ee=x.current.on(v=>{Me(v)});return()=>{ee()}}},[]),$.useEffect(()=>{if(!(localStorage.getItem("webrtc_enabled")==="true"))return;const ee=window.location.hash.slice(1);if(ee&&new URLSearchParams(ee).get("hostId"))return;const v="webrtc_auto_restore_attempted";if(sessionStorage.getItem(v))return;sessionStorage.setItem(v,"true");const B=Vn();if(B==="none"){sessionStorage.removeItem(v);return}setTimeout(async()=>{var Z,ne;if(!x.current){f.warn("[Auto-restore] WebRTC manager not ready");return}try{if(B==="host"){Ve.current=!0,f.info("[Auto-restore] Setting restoration flag to prevent premature exit");const re=ma(),q=la();if(!re||!q){f.warn("[Auto-restore] Missing host data or state data"),Dt(),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}f.info(`[Auto-restore] Restoring host session: old peerId=${re.peerId}`);const De=await x.current.initializeAsHost();ae.current=!0,Ke(!0),Te(De),b("Connected"),(Z=q.gameState)!=null&&Z.gameId&&(Er(De,q.gameState.gameId),f.info(`[Auto-restore] Broadcasted NEW host peerId ${De} for game ${q.gameState.gameId}`)),(q.gameState||q.localPlayerId!==null)&&(q.gameState&&(d.current=q.gameState),q.localPlayerId!==null&&(h.current=q.localPlayerId),$e.current=!0,setTimeout(()=>{$e.current=!1},1e4),setTimeout(()=>{var ue;q.gameState&&(n(q.gameState),f.info(`[Auto-restore] Restored game state with ${((ue=q.gameState.players)==null?void 0:ue.length)||0} players, gameId=${q.gameState.gameId}`)),q.localPlayerId!==null&&(i(q.localPlayerId),f.info(`[Auto-restore] Restored local player ID: ${q.localPlayerId}`))},0)),setTimeout(()=>{Ve.current=!1,f.info("[Auto-restore] Cleared restoration flag")},100),f.info("[Auto-restore] Host session restoration initiated")}else if(B==="guest"){Ve.current=!0,f.info("[Auto-restore] Setting restoration flag to prevent premature exit");const re=Ea(),q=la();if(!re||!q){f.warn("[Auto-restore] Missing guest data or state data"),Dt(),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}f.info(`[Auto-restore] Restoring guest session: old hostPeerId=${re.hostPeerId}, playerId=${re.playerId}`),ae.current=!1,Ke(!1),b("Connecting");let De=re.hostPeerId;if((ne=q.gameState)!=null&&ne.gameId){const ue=cr(q.gameState.gameId);ue&&ue.peerId&&(De=ue.peerId,f.info(`[Auto-restore] Found NEW host peerId in localStorage: ${De}`))}if(Te(De),re.playerId!==null){f.info(`[Auto-restore] Reconnecting as existing player ${re.playerId} to host ${De}`);try{await x.current.initializeAsReconnectingGuest(De,re.playerId),b("Connected"),f.info("[Auto-restore] Successfully reconnected to host")}catch(ue){f.error("[Auto-restore] Failed to reconnect to host:",ue),b("Disconnected"),Dt(),f.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else f.info("[Auto-restore] Connecting as new player"),await x.current.initializeAsGuest(De),b("Connected");(q.gameState||q.localPlayerId!==null)&&(q.gameState&&(d.current=q.gameState),q.localPlayerId!==null&&(h.current=q.localPlayerId),$e.current=!0,setTimeout(()=>{$e.current=!1},1e4),setTimeout(()=>{var ue,ke;if(q.gameState&&(n(q.gameState),f.info(`[Auto-restore] Restored game state with ${((ue=q.gameState.players)==null?void 0:ue.length)||0} players, gameId=${q.gameState.gameId}, isGameStarted=${q.gameState.isGameStarted}`),q.localPlayerId!==null)){const Wt=(ke=q.gameState.players)==null?void 0:ke.some(Ft=>Ft.id===q.localPlayerId);f.info(`[Auto-restore] Player ${q.localPlayerId} exists in restored state: ${Wt}`)}q.localPlayerId!==null&&(i(q.localPlayerId),f.info(`[Auto-restore] Restored local player ID: ${q.localPlayerId}`))},0)),setTimeout(()=>{Ve.current=!1,f.info("[Auto-restore] Cleared restoration flag")},100),f.info("[Auto-restore] Guest session restoration initiated")}}catch(re){f.error("[Auto-restore] Failed to restore session:",re),Dt(),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),$.useEffect(()=>{if(!fe||!x.current)return;const l=window.location.hash.slice(1);if(!l)return;const v=new URLSearchParams(l).get("hostId");v&&Oe(v)},[fe]),$.useEffect(()=>{d.current=a},[a]),$.useEffect(()=>{h.current=m},[m]);const nt=go({ws:pe,webrtcManager:x,gameStateRef:d,localPlayerIdRef:h,webrtcIsHostRef:ae,setLatestHighlight:S,setLatestFloatingTexts:c,setLatestNoTarget:T,setLatestDeckSelections:E,setLatestHandCardSelections:D,setTargetSelectionEffects:A,setGameState:n}),Ve=$.useRef(!1);$.useEffect(()=>{if(!fe||!ae.current||!(a!=null&&a.gameId))return;const l=a.gameId,ee=()=>{var Z;const B=(Z=x.current)==null?void 0:Z.getPeerId();B&&l&&Er(B,l)};ee();const v=setInterval(ee,2e3);return()=>clearInterval(v)},[fe,a==null?void 0:a.gameId]),$.useEffect(()=>{if(!fe||ae.current||!(a!=null&&a.gameId))return;const l=a.gameId,ee=Z=>{var ne;Te(Z),b("Connecting"),(ne=x.current)==null||ne.initializeAsReconnectingGuest(Z,h.current||0).then(()=>{b("Connected")}).catch(re=>{f.error("[Guest Auto-Reconnect] Failed to reconnect:",re),b("Disconnected")})},v=Z=>{const ne=`webrtc_host_${l}`;if(!(Z.key!==ne||!Z.newValue))try{const q=JSON.parse(Z.newValue).peerId;q&&q!==Re&&ee(q)}catch(re){f.error("[Guest Auto-Reconnect] Failed to parse storage event:",re)}},B=setInterval(()=>{const Z=cr(l);Z&&Z.peerId!==Re&&(f.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${Z.peerId}`),ee(Z.peerId))},2e3);return window.addEventListener("storage",v),()=>{window.removeEventListener("storage",v),clearInterval(B)}},[fe,a==null?void 0:a.gameId,Re]),$.useEffect(()=>{const l=setInterval(()=>{n(ee=>{const v=Date.now(),B=ee.floatingTexts||[],Z=B.filter(ne=>v-ne.timestamp<we.FLOATING_TEXT_DURATION);return Z.length!==B.length?{...ee,floatingTexts:Z}:ee})},we.DECK_SYNC_DELAY);return()=>clearInterval(l)},[]);const Me=$.useCallback(l=>{var ee,v,B;switch(l.type){case"peer_open":(ee=l.data)!=null&&ee.peerId&&(Te(l.data.peerId),f.info(`WebRTC peer opened with ID: ${l.data.peerId}`));break;case"guest_connected":f.info("Guest connected via WebRTC:",(v=l.data)==null?void 0:v.peerId);break;case"connected_to_host":(B=l.data)!=null&&B.hostPeerId&&Re!==l.data.hostPeerId&&(Te(l.data.hostPeerId),f.info(`Updated webrtcHostId to: ${l.data.hostPeerId}`)),b("Connected"),Ue(!1),Xe(null),$e.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(f.warn("WebRTC peer disconnected"),b("Disconnected"),Ue(!0),!ae.current&&Re&&a)try{const Z={hostPeerId:Re,playerId:m,gameState:a,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(Z)),f.info("[Reconnection] Stored reconnection data before disconnect"),F(Re)}catch(Z){f.error("[Reconnection] Failed to store data:",Z)}break;case"message_received":te(l.data);break;case"error":f.error("WebRTC error:",l.data);break}},[a,m,Re,Ie]),Ge=$.useCallback(l=>{if(f.info(`[handleWebrtcGuestJoin] Called for guest ${l}, isHost: ${ae.current}`),!ae.current||!x.current){f.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}n(ee=>{if(!ee)return f.error("[handleWebrtcGuestJoin] No previous state"),ee;f.info(`[handleWebrtcGuestJoin] Current state has ${ee.players.length} players`);const v=ee.players.map(ue=>ue.id);let B=1;for(;v.includes(B);)B++;const Z={id:B,name:`Player ${B}`,color:Jt[v.length%Jt.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:"Random",boardHistory:[],autoDrawEnabled:!0},ne={...ee,players:[...ee.players,Z]},re=ee.board.map(ue=>ue.map(ke=>({...ke,card:ke.card?{id:ke.card.id,baseId:ke.card.baseId,ownerId:ke.card.ownerId,name:ke.card.name,imageUrl:ke.card.imageUrl,power:ke.card.power,ability:ke.card.ability,isFaceDown:ke.card.isFaceDown,statuses:ke.card.statuses||[]}:null}))),q=ue=>ue.map(ke=>({id:ke.id,baseId:ke.baseId,name:ke.name,imageUrl:ke.imageUrl,power:ke.power,powerModifier:ke.powerModifier,ability:ke.ability,ownerId:ke.ownerId,color:ke.color,deck:ke.deck,isFaceDown:ke.isFaceDown,types:ke.types,faction:ke.faction,statuses:ke.statuses}));x.current.acceptGuestMinimal(l,{playerId:B,gameId:ee.gameId,isGameStarted:ee.isGameStarted,players:ne.players.map(ue=>ue.isDummy?{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,hand:q(ue.hand||[]),deck:q(ue.deck||[]),discard:q(ue.discard||[]),handSize:ue.hand.length,deckSize:ue.deck.length,discardSize:ue.discard.length}:{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,deckSize:ue.deck.length,handSize:ue.hand.length,discardSize:ue.discard.length}),deckSelections:ne.players.map(ue=>({id:ue.id,selectedDeck:ue.selectedDeck})),gameMode:ee.gameMode,currentRound:ee.currentRound,currentPhase:ee.currentPhase,activePlayerId:ee.activePlayerId,startingPlayerId:ee.startingPlayerId,activeGridSize:ee.activeGridSize,board:re},B);const De=Ct(ee,ne,B);return bt(De)||x.current.broadcastStateDelta(De,l),x.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:x.current.getPeerId(),data:{playerId:B,selectedDeck:"Random"},timestamp:Date.now()}),ne})},[]),Be=$.useCallback(l=>{const ee={...l,players:l.players.map(v=>{if(v.isDummy||!1){const ne=re=>re.map(q=>({id:q.id,baseId:q.baseId,name:q.name,imageUrl:q.imageUrl,power:q.power,powerModifier:q.powerModifier,ability:q.ability,ownerId:q.ownerId,color:q.color,deck:q.deck,isFaceDown:q.isFaceDown,types:q.types,faction:q.faction,statuses:q.statuses}));return{id:v.id,name:v.name,color:v.color,isDummy:!0,isReady:v.isReady,score:v.score,isDisconnected:v.isDisconnected,selectedDeck:v.selectedDeck,autoDrawEnabled:v.autoDrawEnabled,boardHistory:v.boardHistory,announcedCard:null,hand:ne(v.hand||[]),deck:ne(v.deck||[]),discard:ne(v.discard||[]),handSize:v.hand.length,deckSize:v.deck.length,discardSize:v.discard.length}}return{id:v.id,name:v.name,color:v.color,isDummy:v.isDummy,isReady:v.isReady,score:v.score,isDisconnected:v.isDisconnected,selectedDeck:v.selectedDeck,autoDrawEnabled:v.autoDrawEnabled,boardHistory:v.boardHistory,announcedCard:null,hand:[],deck:[],discard:[],handSize:v.handSize??v.hand.length,deckSize:v.deckSize??v.deck.length,discardSize:v.discardSize??v.discard.length}})};return ee.board=l.board.map(v=>v.map(B=>({...B,card:B.card?{id:B.card.id,baseId:B.card.baseId,ownerId:B.card.ownerId,name:B.card.name,imageUrl:B.card.imageUrl,power:B.card.power,ability:B.card.ability,isFaceDown:B.card.isFaceDown,deck:B.card.deck}:null}))),ee},[]),He=$.useCallback(l=>{const ee=ae.current;if(f.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!x.current}, webrtcIsHostRef.current=${ee}`),!x.current||!ee){f.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}const v=Be(l);x.current.broadcastGameState(v)},[Be]),te=$.useCallback(l=>{var ee,v,B,Z,ne,re,q,De,ue,ke,Wt,Ft,Pr,vr,Nr,kr,Lr,Mr,Gr,xr,$r,Hr,Ur,Wr,Fr,Br,Yr,jr,zr,Kr,qr,Vr,Jr,Xr,Zr,Qr,ea,ta,ra,aa,na,oa,sa,ia,da;if(!(!l||!l.type))switch(f.info(`[handleWebrtcMessage] Received: ${l.type}`),l.type){case"JOIN_ACCEPT_MINIMAL":if(f.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${l.playerId}`),l.data){const C=l.data;f.info(`[handleWebrtcMessage] Creating minimal state with ${((ee=C.players)==null?void 0:ee.length)||0} players`);const N={gameId:C.gameId||Ca(),isGameStarted:C.isGameStarted||!1,isPrivate:!1,activeGridSize:C.activeGridSize||4,gameMode:C.gameMode||gr.FreeForAll,dummyPlayerCount:0,players:((v=C.players)==null?void 0:v.map(H=>{if((H.isDummy||!1)&&H.hand&&H.deck&&H.discard)return{id:H.id,name:H.name,color:H.color,isDummy:!0,isReady:H.isReady||!1,score:H.score||0,hand:H.hand||[],deck:H.deck||[],discard:H.discard||[],announcedCard:null,selectedDeck:H.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const U=[],le=[],Ae=[];for(let Ce=0;Ce<(H.handSize||0);Ce++)U.push({id:`placeholder_${H.id}_hand_${Ce}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color});for(let Ce=0;Ce<(H.deckSize||0);Ce++)le.push({id:`placeholder_${H.id}_deck_${Ce}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color});for(let Ce=0;Ce<(H.discardSize||0);Ce++)Ae.push({id:`placeholder_${H.id}_discard_${Ce}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color});return{id:H.id,name:H.name,color:H.color,isDummy:!1,isReady:H.isReady||!1,score:H.score||0,hand:U,deck:le,discard:Ae,announcedCard:null,selectedDeck:H.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:C.board||Ia(),hostId:1,currentPhase:C.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:C.currentRound||1,turnNumber:C.turnNumber||1,activePlayerId:C.activePlayerId??null,startingPlayerId:C.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};n(N),l.playerId!==void 0&&(i(l.playerId),f.info(`[handleWebrtcMessage] Set local player ID to ${l.playerId}`)),n(H=>{const ye=H.players.map(U=>{var Ae;const le=(Ae=C.players)==null?void 0:Ae.find(Ce=>Ce.id===U.id);if(U.id===l.playerId){const Ye=U.deck.length===0||U.deck.some(xe=>xe.isPlaceholder)||U.deck.length!==30;if(le!=null&&le.selectedDeck&&Ye){const xe=mt(le.selectedDeck,U.id,U.name);f.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${xe.length} cards from ${le.selectedDeck}`);const We=[...U.hand],je=[...xe];if(C.isGameStarted&&We.length===0&&je.length>0){for(let at=0;at<6&&at<je.length;at++){const dt=je[0];je.splice(0,1),We.push(dt)}f.info(`[JOIN_ACCEPT_MINIMAL] Drew ${We.length} cards, deck now has ${je.length} cards`)}return{...U,deck:je,hand:We,selectedDeck:le.selectedDeck}}}return U});return{...H,players:ye}});const W=N.players.find(H=>H.id===l.playerId);W&&x.current&&(x.current.sendAction("CHANGE_PLAYER_DECK",{playerId:l.playerId,deckType:W.selectedDeck}),f.info(`[JOIN_ACCEPT_MINIMAL] Sent deck selection to host: ${W.selectedDeck}`));try{const H=(B=x.current)==null?void 0:B.getHostPeerId();H&&dr({hostPeerId:H,playerId:l.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(H){f.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",H)}}break;case"JOIN_ACCEPT":if(f.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${l.playerId}, hasState: ${!!((Z=l.data)!=null&&Z.gameState)}`),(ne=l.data)!=null&&ne.gameState){const C=l.data.gameState;if(f.info(`[handleWebrtcMessage] Setting game state with ${((re=C.players)==null?void 0:re.length)||0} players`),n(C),l.playerId!==void 0){i(l.playerId),f.info(`[handleWebrtcMessage] Set local player ID to ${l.playerId}`);try{const N=(q=x.current)==null?void 0:q.getHostPeerId(),W=C.players.find(H=>H.id===l.playerId);N&&dr({hostPeerId:N,playerId:l.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(N){f.warn("[JOIN_ACCEPT] Failed to save guest data:",N)}}}break;case"JOIN_ACCEPT_BINARY":if(f.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${l.playerId}`),l.data instanceof Uint8Array)try{const C=ga(l.data),N=io(C);if(f.info(`[handleWebrtcMessage] Expanded binary state with ${((De=N.players)==null?void 0:De.length)||0} players`),n(N),l.playerId!==void 0){i(l.playerId),f.info(`[handleWebrtcMessage] Set local player ID to ${l.playerId}`);try{const W=(ue=x.current)==null?void 0:ue.getHostPeerId(),H=N.players.find(ye=>ye.id===l.playerId);W&&dr({hostPeerId:W,playerId:l.playerId,playerName:(H==null?void 0:H.name)||null,isHost:!1})}catch(W){f.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",W)}}f.info(`[handleWebrtcMessage] Received optimized binary game state: ${l.data.byteLength} bytes`)}catch(C){f.error("[handleWebrtcMessage] Failed to deserialize binary game state:",C)}break;case"STATE_UPDATE":if(Ee.current=!0,(ke=l.data)!=null&&ke.gameState){const C=l.data.gameState;if($e.current){n(N=>({...N,currentPhase:C.currentPhase,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,isReadyCheckActive:C.isReadyCheckActive,isGameStarted:C.isGameStarted}));return}n(N=>{var ye;const W=C.players.map(U=>{var Ae,Ce,Ye;const le=N.players.find(xe=>xe.id===U.id);if(U.id===h.current&&le){const xe=le.hand.every(je=>je.isPlaceholder)||le.hand.length===0,We=U.handSize??((Ae=U.hand)==null?void 0:Ae.length)??0;if(xe&&U.hand&&U.hand.length>0)return{...U,hand:U.hand,deck:U.deck||le.deck,discard:U.discard||le.discard};{let je=le.hand,rt=le.deck;if(We>le.hand.length&&rt.length>0){const at=We-le.hand.length,dt=[...le.hand],Bt=[...le.deck];for(let nr=0;nr<at&&nr<Bt.length;nr++){const wn=Bt[0];Bt.splice(0,1),dt.push(wn)}je=dt,rt=Bt}return{...U,hand:je,deck:rt,discard:U.discard||le.discard}}}else{if(U.isDummy||!1)return f.info(`[STATE_UPDATE] Using real cards for dummy player ${U.id}`),{...U,hand:U.hand||[],deck:U.deck||[],discard:U.discard||[]};const We=U.deckSize??((Ce=U.deck)==null?void 0:Ce.length)??0,je=U.handSize??((Ye=U.hand)==null?void 0:Ye.length)??0;f.info(`[STATE_UPDATE] Player ${U.id}: deckSize=${We}, handSize=${je}`);const rt=[];for(let dt=0;dt<We;dt++)rt.push({id:`placeholder_${U.id}_deck_${dt}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});const at=[];for(let dt=0;dt<je;dt++)at.push({id:`placeholder_${U.id}_hand_${dt}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});return f.info(`[STATE_UPDATE] Created ${rt.length} deck placeholders and ${at.length} hand placeholders for player ${U.id}`),{...U,hand:at,deck:rt,discard:U.discard||[]}}}),H={...C,players:W};if(!ae.current)try{((ye=x.current)==null?void 0:ye.getHostPeerId())&&h.current!==null&&(Ot({gameState:H,localPlayerId:h.current,isHost:!1}),f.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(U){f.warn("[STATE_UPDATE] Failed to persist guest state:",U)}return H})}break;case"RECONNECT_SNAPSHOT":if(Ee.current=!0,l.data){const C=l.data;n(N=>{const W=h.current,H=C.players.map(U=>{const le=N.players.find(xe=>xe.id===U.id);if(U.id===W&&le&&le.hand.some(We=>!We.isPlaceholder)){let We=[...le.hand];const je=[...le.deck];if(U.handSize>We.length){const rt=U.handSize-We.length;for(let at=0;at<rt&&je.length>0;at++)We.push(je.shift())}else U.handSize<We.length&&(We=We.slice(0,U.handSize));return{...U,hand:We,deck:je,discard:le.discard}}const Ae=[];for(let xe=0;xe<U.handSize;xe++)Ae.push({id:`placeholder_${U.id}_hand_${xe}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});const Ce=[];for(let xe=0;xe<U.deckSize;xe++)Ce.push({id:`placeholder_${U.id}_deck_${xe}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});const Ye=[];for(let xe=0;xe<U.discardSize;xe++)Ye.push({id:`placeholder_${U.id}_discard_${xe}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});return{...U,hand:Ae,deck:Ce,discard:Ye}}),ye={gameId:C.gameId,gameMode:C.gameMode,isPrivate:C.isPrivate,isGameStarted:C.isGameStarted,isReadyCheckActive:C.isReadyCheckActive,activeGridSize:C.activeGridSize,currentPhase:C.currentPhase,isScoringStep:C.isScoringStep,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,currentRound:C.currentRound,turnNumber:C.turnNumber,roundWinners:C.roundWinners||{},gameWinner:C.gameWinner,isRoundEndModalOpen:C.isRoundEndModalOpen,dummyPlayerCount:C.dummyPlayerCount,players:H,board:C.board,spectators:N.spectators,hostId:N.hostId,revealRequests:N.revealRequests,preserveDeployAbilities:N.preserveDeployAbilities,highlights:N.highlights,floatingTexts:N.floatingTexts,targetingMode:N.targetingMode,abilityMode:N.abilityMode};if(!ae.current&&W!==null)try{Ot({gameState:ye,localPlayerId:W,isHost:!1}),f.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(U){f.warn("[RECONNECT_SNAPSHOT] Failed to save state:",U)}return f.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${ye.currentPhase}, players=${ye.players.length}`),ye})}break;case"STATE_DELTA":if(ae.current||(Ee.current=!0),f.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${ae.current}, senderId: ${l.senderId}`),(Wt=l.data)!=null&&Wt.delta){const C=l.data.delta;f.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Ft=C.boardCells)==null?void 0:Ft.length)||0}, phaseDelta=${!!C.phaseDelta}`),C.boardCells&&C.boardCells.length>0&&C.boardCells.forEach(N=>{var W,H;f.info(`[STATE_DELTA] Board cell [${N.row},${N.col}]: card=${((W=N.card)==null?void 0:W.name)||"(empty)"}, owner=${(H=N.card)==null?void 0:H.ownerId}`)}),ae.current&&l.senderId&&x.current&&(f.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${l.senderId} to other guests`),x.current.broadcastStateDelta(C,l.senderId)),C.phaseDelta&&f.info("[STATE_DELTA] phaseDelta:",JSON.stringify(C.phaseDelta)),C.playerDeltas&&Object.entries(C.playerDeltas).forEach(([N,W])=>{f.info(`[STATE_DELTA] Player ${N} delta: handSizeDelta=${W.handSizeDelta}, deckSizeDelta=${W.deckSizeDelta}`)}),n(N=>{const W=h.current||N.localPlayerId;f.info(`[STATE_DELTA] Applying delta with localPlayerId=${W}, currentPhase before=${N.currentPhase}`);const H=fr(N,C,W);f.info(`[STATE_DELTA] Applying delta with localPlayerId=${W}, currentPhase after=${H.currentPhase}`);try{H.gameId&&W!==null&&(Ot({gameState:H,localPlayerId:W,isHost:ae.current}),f.debug(`[STATE_DELTA] Saved state for ${ae.current?"host":"guest"} auto-restore`))}catch(ye){f.warn("[STATE_DELTA] Failed to persist state:",ye)}return H})}break;case"STATE_DELTA_BINARY":if(ae.current||(Ee.current=!0),f.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${ae.current}, senderId: ${l.senderId}`),l.data instanceof Uint8Array)try{const C=no(l.data);f.info(`[STATE_DELTA_BINARY] Deserialized delta: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Pr=C.boardCells)==null?void 0:Pr.length)||0}, phaseDelta=${!!C.phaseDelta}`),ae.current&&l.senderId&&x.current&&(f.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${l.senderId} to other guests`),x.current.broadcastStateDelta(C,l.senderId)),n(N=>{const W=h.current||N.localPlayerId;f.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${W}, currentPhase before=${N.currentPhase}`);const H=fr(N,C,W);f.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${W}, currentPhase after=${H.currentPhase}`);try{H.gameId&&W!==null&&(Ot({gameState:H,localPlayerId:W,isHost:ae.current}),f.debug(`[STATE_DELTA_BINARY] Saved state for ${ae.current?"host":"guest"} auto-restore`))}catch(ye){f.warn("[STATE_DELTA_BINARY] Failed to persist state:",ye)}return H})}catch(C){f.error("[STATE_DELTA_BINARY] Failed to deserialize delta:",C)}break;case"JOIN_REQUEST":f.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${l.senderId}, isHost: ${ae.current}`),ae.current&&l.senderId?(f.info(`Host received JOIN_REQUEST from ${l.senderId}`),Ge(l.senderId)):f.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${ae.current}, senderId: ${l.senderId}`);break;case"ACTION":if(ae.current&&l.data){const{actionType:C,actionData:N}=l.data;if(C==="STATE_UPDATE"&&(N!=null&&N.gameState)){if($e.current){x.current&&l.senderId&&x.current.sendToGuest(l.senderId,{type:"STATE_UPDATE",senderId:x.current.getPeerId(),data:{gameState:d.current},timestamp:Date.now()});break}n(W=>{const H=N.gameState,ye=H.players.map(le=>{const Ae=W.players.find(Ce=>Ce.id===le.id);return Ae&&le.id!==h.current?{...le,deck:Ae.deck||le.deck,discard:Ae.discard||le.discard,score:Ae.score}:le}),U={...H,players:ye};return x.current&&x.current.broadcastToGuests({type:"STATE_UPDATE",senderId:x.current.getPeerId(),data:{gameState:U},timestamp:Date.now()}),U})}else C==="STATE_DELTA"&&(N!=null&&N.delta)?n(W=>{const H=N.delta;let ye=H;$e.current&&H.playerDeltas&&(ye={...H,playerDeltas:Object.fromEntries(Object.entries(H.playerDeltas).map(([Ae,Ce])=>{const Ye={...Ce};return delete Ye.scoreDelta,[Ae,Ye]}))});const U=h.current||W.localPlayerId,le=fr(W,ye,U);return x.current&&x.current.broadcastStateDelta(ye),le}):C==="NEXT_PHASE"?n(W=>{const H=W,ye=H.currentPhase,U=ye===2&&!H.isScoringStep,le=ye+1;return{...H,currentPhase:le,...U&&{isScoringStep:!0}}}):C==="PREV_PHASE"?n(W=>{const H=W;return H.isScoringStep?{...H,isScoringStep:!1,currentPhase:Math.max(1,H.currentPhase-1)}:{...H,currentPhase:Math.max(1,H.currentPhase-1)}}):C==="SET_PHASE"&&(N==null?void 0:N.phaseIndex)!==void 0?n(W=>({...W,currentPhase:N.phaseIndex})):C==="UPDATE_PLAYER_NAME"&&(N==null?void 0:N.playerId)!==void 0&&(N==null?void 0:N.name)!==void 0?n(W=>({...W,players:W.players.map(H=>H.id===N.playerId?{...H,name:N.name}:H)})):C==="CHANGE_PLAYER_COLOR"&&(N==null?void 0:N.playerId)!==void 0&&(N==null?void 0:N.color)!==void 0?n(W=>({...W,players:W.players.map(H=>H.id===N.playerId?{...H,color:N.color}:H)})):C==="UPDATE_PLAYER_SCORE"&&(N==null?void 0:N.playerId)!==void 0&&(N==null?void 0:N.delta)!==void 0?n(W=>({...W,players:W.players.map(H=>H.id===N.playerId?{...H,score:Math.max(0,H.score+N.delta)}:H)})):C==="CHANGE_PLAYER_DECK"&&(N==null?void 0:N.playerId)!==void 0&&(N==null?void 0:N.deckType)!==void 0?n(W=>{const H=W.players.find(U=>U.id===N.playerId);if(!H)return W;const ye=mt(N.deckType,N.playerId,H.name);return f.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${N.playerId} with ${ye.length} cards from ${N.deckType}`),{...W,players:W.players.map(U=>U.id===N.playerId?{...U,selectedDeck:N.deckType,deck:ye}:U)}}):C==="TOGGLE_ACTIVE_PLAYER"&&(N==null?void 0:N.playerId)!==void 0?n(W=>{if(!W.players.find(U=>U.id===N.playerId))return W;const ye=wa(W,N.playerId);if(x.current){const U=Ct(W,ye,N.playerId);x.current.broadcastStateDelta(U)}return ye}):C==="TOGGLE_AUTO_DRAW"&&(N==null?void 0:N.playerId)!==void 0?n(W=>({...W,players:W.players.map(H=>H.id===N.playerId?{...H,autoDrawEnabled:!H.autoDrawEnabled}:H)})):C==="START_NEXT_ROUND"?n(W=>({...W,isRoundEndModalOpen:!1,currentRound:(W.currentRound||1)+1,players:W.players.map(H=>({...H,score:0}))})):C==="RESET_DEPLOY_STATUS"?n(W=>{const H=W.board.map(ye=>ye.map(U=>{var le;return(le=U.card)!=null&&le.statuses?{...U,card:{...U.card,statuses:U.card.statuses.filter(Ae=>Ae.type!=="DeployAbilityUsed")}}:U}));return{...W,board:H,preserveDeployAbilities:!1}}):f.warn(`[ACTION] Unknown action type: ${C}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(f.info(`[PLAYER_RECONNECT] Guest ${l.playerId} reconnecting from ${l.senderId}`),ae.current&&l.playerId!==void 0&&l.senderId){const C=d.current;if(f.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(C!=null&&C.gameId)}, gameId=${C==null?void 0:C.gameId}, hasPlayers=${((vr=C==null?void 0:C.players)==null?void 0:vr.length)||0}`),C&&C.gameId){f.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${l.playerId}`);const N=mo(C,l.playerId);(Nr=x.current)==null||Nr.sendToGuest(l.senderId,{type:"RECONNECT_SNAPSHOT",senderId:x.current.getPeerId(),data:N.data,timestamp:Date.now()}),f.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${l.playerId}`)}else f.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((kr=l.data)==null?void 0:kr.isReadyCheckActive)!==void 0||((Lr=l.data)==null?void 0:Lr.isPrivate)!==void 0)&&n(C=>({...C,isReadyCheckActive:l.data.isReadyCheckActive??!0,isPrivate:l.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((Mr=l.data)==null?void 0:Mr.isReadyCheckActive)!==void 0&&n(C=>({...C,isReadyCheckActive:l.data.isReadyCheckActive}));break;case"PLAYER_READY":ae.current&&l.playerId!==void 0?n(C=>{const N=C.players.map(U=>U.id===l.playerId?{...U,isReady:!0}:U),W={...C,players:N};if(f.info(`Player ${l.playerId} is ready via WebRTC`),x.current){const U=Ct(C,W,l.playerId);bt(U)||(x.current.broadcastStateDelta(U),f.info(`[PLAYER_READY] Broadcasted ready status for player ${l.playerId}`))}const H=W.players.filter(U=>!U.isDummy&&!U.isDisconnected);if(H.length>0&&H.every(U=>U.isReady)&&W.isReadyCheckActive&&!W.isGameStarted){const U=W.players.filter(Ye=>!Ye.isDisconnected),le=Math.floor(Math.random()*U.length),Ae=U[le].id;let Ce={...W};return Ce.isReadyCheckActive=!1,Ce.isGameStarted=!0,Ce.startingPlayerId=Ae,Ce.activePlayerId=Ae,Ce.currentPhase=0,Ce.players=Ce.players.map(Ye=>{if(Ye.hand.length===0&&Ye.deck.length>0){const We=[...Ye.hand],je=[...Ye.deck];for(let rt=0;rt<6&&rt<je.length;rt++){const at=je[0];je.splice(0,1),We.push(at)}return f.info(`[PLAYER_READY] Drew ${We.length} cards for player ${Ye.id}`),{...Ye,hand:We,deck:je}}return Ye}),Ce=Rr(Ce,Ae),f.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${Ce.currentPhase}`),x.current&&(x.current.broadcastToGuests({type:"GAME_START",senderId:x.current.getPeerId(),data:{startingPlayerId:Ae,activePlayerId:Ae,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var Ye,xe;f.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(Ye=Ce.players[0])==null?void 0:Ye.deck.length}, hand=${(xe=Ce.players[0])==null?void 0:xe.hand.length}`),f.info(`[PLAYER_READY] Broadcasting state with currentPhase=${Ce.currentPhase}`),He(Ce)},100)),Ce}return W}):ae.current;break;case"ASSIGN_TEAMS":(Gr=l.data)!=null&&Gr.assignments&&n(C=>{const N=C.players.map(W=>{let H=W.teamId||1;for(const[ye,U]of Object.entries(l.data.assignments))if(U.includes(W.id)){H=parseInt(ye);break}return{...W,teamId:H}});return{...C,players:N}});break;case"SET_GAME_MODE":((xr=l.data)==null?void 0:xr.mode)!==void 0&&n(C=>({...C,gameMode:l.data.mode}));break;case"SET_GAME_PRIVACY":(($r=l.data)==null?void 0:$r.isPrivate)!==void 0&&n(C=>({...C,isPrivate:l.data.isPrivate}));break;case"SET_GRID_SIZE":((Hr=l.data)==null?void 0:Hr.size)!==void 0&&n(C=>{const N=l.data.size,W=[];for(let H=0;H<N;H++){const ye=[];for(let U=0;U<N;U++)ye.push({card:null});W.push(ye)}return{...C,activeGridSize:N,board:W}});break;case"SET_DUMMY_PLAYER_COUNT":((Ur=l.data)==null?void 0:Ur.count)!==void 0&&n(C=>({...C,dummyPlayerCount:l.data.count}));break;case"HOST_READY":l.playerId!==void 0&&(f.info(`[handleWebrtcMessage] Host (player ${l.playerId}) is ready`),n(C=>{const N=C.players.map(W=>W.id===l.playerId?{...W,isReady:!0}:W);return{...C,players:N}}));break;case"GAME_START":Ee.current=!0,f.info("[handleWebrtcMessage] Game starting!",l.data),d.current&&(f.info(`[GAME_START] Current phase before: ${d.current.currentPhase}`),d.current.players.forEach(C=>{f.info(`[GAME_START] Before: Player ${C.id} - deck: ${C.deck.length}, hand: ${C.hand.length}`)})),l.data&&n(C=>{f.info(`[GAME_START] Processing for localPlayerId=${h.current}`),C.players.forEach(ye=>{f.info(`[GAME_START] Player ${ye.id} before: deck=${ye.deck.length}, hand=${ye.hand.length}`)});const N=l.data.startingPlayerId??l.data.activePlayerId,W={...C,isGameStarted:l.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:N,activePlayerId:l.data.activePlayerId,currentPhase:C.currentPhase},H=W.players.find(ye=>ye.id===h.current);if(H&&H.hand.length===0&&H.deck.length>0){const U=[...H.hand],le=[...H.deck];for(let Ae=0;Ae<6&&Ae<le.length;Ae++){const Ce=le[0];le.splice(0,1),U.push(Ce)}W.players=W.players.map(Ae=>Ae.id===h.current?{...Ae,hand:U,deck:le}:Ae),f.info(`[GAME_START] Drew ${U.length} cards for local player ${h.current}, deck now has ${le.length} cards`)}return W.players.forEach(ye=>{f.info(`[GAME_START] Player ${ye.id} after: deck=${ye.deck.length}, hand=${ye.hand.length}`)}),f.info(`[GAME_START] Final state: currentPhase=${W.currentPhase}, activePlayerId=${W.activePlayerId}, startingPlayerId=${W.startingPlayerId}`),W});break;case"ACTIVE_PLAYER_CHANGED":f.info("[handleWebrtcMessage] Active player changed!",l.data),l.data&&n(C=>{const N={...C,activePlayerId:l.data.activePlayerId};if(l.data.currentPhase!==void 0&&(N.currentPhase=l.data.currentPhase),l.data.turnNumber!==void 0&&(N.turnNumber=l.data.turnNumber),N.currentPhase===0&&N.activePlayerId===h.current){const W=N.players.find(H=>H.id===h.current);if(W&&W.deck.length>0){const H=W.deck[0],ye=[...W.deck.slice(1)],U=[...W.hand,H];N.players=N.players.map(le=>le.id===h.current?{...le,deck:ye,hand:U}:le)}N.currentPhase=1}return N});break;case"SYNC_DECK_SELECTIONS":f.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",l.data),l.data&&n(C=>l.data.playerId!==void 0&&l.data.selectedDeck!==void 0?{...C,players:C.players.map(N=>N.id===l.data.playerId?{...N,selectedDeck:l.data.selectedDeck}:N)}:l.data.deckSelections&&Array.isArray(l.data.deckSelections)?{...C,players:C.players.map(N=>{const W=l.data.deckSelections.find(H=>H.id===N.id);return W?{...N,selectedDeck:W.selectedDeck}:N})}:C);break;case"CHANGE_PLAYER_DECK":f.info("[CHANGE_PLAYER_DECK] Received deck change",l.data),ae.current&&l.data?(n(C=>{const N=C.players.find(H=>H.id===l.data.playerId);if(!N)return C;const W=mt(l.data.deckType,l.data.playerId,N.name);return f.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${l.data.playerId} with ${W.length} cards from ${l.data.deckType}`),{...C,players:C.players.map(H=>H.id===l.data.playerId?{...H,selectedDeck:l.data.deckType,deck:W}:H)}}),x.current&&x.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:x.current.getPeerId(),data:l.data,timestamp:Date.now()})):n(C=>({...C,players:C.players.map(N=>N.id===l.data.playerId?{...N,selectedDeck:l.data.deckType}:N)}));break;case"GAME_RESET":n(C=>{const N=l.data.activeGridSize||8,W=[];for(let U=0;U<N;U++){const le=[];for(let Ae=0;Ae<N;Ae++)le.push({card:null});W.push(le)}const H=(l.data.players||[]).map(U=>{if(U.isDummy&&U.hand&&U.deck&&U.discard)return{...U,boardHistory:[]};{const le=U.selectedDeck||"SynchroTech";return{...U,hand:[],deck:mt(le,U.id,U.name),discard:[],boardHistory:[]}}}),ye={...C,players:H,gameMode:l.data.gameMode,isPrivate:l.data.isPrivate,activeGridSize:l.data.activeGridSize,dummyPlayerCount:l.data.dummyPlayerCount,autoAbilitiesEnabled:l.data.autoAbilitiesEnabled,isGameStarted:l.data.isGameStarted,currentPhase:l.data.currentPhase,currentRound:l.data.currentRound,turnNumber:l.data.turnNumber,activePlayerId:l.data.activePlayerId,startingPlayerId:l.data.startingPlayerId,roundWinners:l.data.roundWinners||{},gameWinner:l.data.gameWinner,isRoundEndModalOpen:l.data.isRoundEndModalOpen,isReadyCheckActive:l.data.isReadyCheckActive,board:W,targetingMode:null,floatingTexts:[]};return d.current=ye,ye});break;case"ABILITY_MODE_SET":(Wr=l.data)!=null&&Wr.abilityMode&&(n(C=>({...C,abilityMode:l.data.abilityMode})),f.info("[AbilityMode] Received ability mode from host",{playerId:l.data.abilityMode.playerId,mode:l.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":f.info("[Ability] Target selected",l.data);break;case"ABILITY_COMPLETED":n(C=>({...C,abilityMode:null})),f.info("[Ability] Ability completed",l.data);break;case"ABILITY_CANCELLED":n(C=>({...C,abilityMode:null}));break;case"TRIGGER_HIGHLIGHT":if((Fr=l.data)!=null&&Fr.highlightData){const C=l.data.highlightData;S(C),ae.current&&x.current&&l.senderId&&x.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:l.senderId,data:C,timestamp:Date.now()},l.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(l.data){const C=(Br=x.current)==null?void 0:Br.getPeerId();l.senderId!==C&&S(l.data)}break;case"TRIGGER_FLOATING_TEXT":if((Yr=l.data)!=null&&Yr.textData){const C=l.data.textData;n(N=>({...N,floatingTexts:[...N.floatingTexts,C].filter(W=>Date.now()-W.timestamp<we.FLOATING_TEXT_DURATION)})),ae.current&&x.current&&l.senderId&&x.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:l.senderId,data:C,timestamp:Date.now()},l.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((jr=l.data)!=null&&jr.batch){const C=l.data.batch;n(N=>({...N,floatingTexts:[...N.floatingTexts,...C].filter(W=>Date.now()-W.timestamp<we.FLOATING_TEXT_DURATION)})),ae.current&&x.current&&l.senderId&&x.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:l.senderId,data:{batch:C},timestamp:Date.now()},l.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const C=(zr=x.current)==null?void 0:zr.getPeerId();(Kr=l.data)!=null&&Kr.batch&&l.senderId!==C?n(N=>({...N,floatingTexts:[...N.floatingTexts,...l.data.batch].filter(W=>Date.now()-W.timestamp<we.FLOATING_TEXT_DURATION)})):(qr=l.data)!=null&&qr.textData&&l.senderId!==C&&n(N=>({...N,floatingTexts:[...N.floatingTexts,l.data.textData].filter(W=>Date.now()-W.timestamp<we.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((Vr=l.data)!=null&&Vr.coords){const C=l.data.coords,N=l.data.timestamp;T({coords:C,timestamp:N}),ae.current&&x.current&&l.senderId&&x.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:l.senderId,data:{coords:C,timestamp:N},timestamp:Date.now()},l.senderId)}break;case"NO_TARGET_TRIGGERED":if((Jr=l.data)!=null&&Jr.coords){const C=(Xr=x.current)==null?void 0:Xr.getPeerId();l.senderId!==C&&T({coords:l.data.coords,timestamp:l.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(l.data){const C=l.data;E(N=>[...N,C]),setTimeout(()=>{E(N=>N.filter(W=>W.timestamp!==C.timestamp))},1e3),ae.current&&x.current&&l.senderId&&x.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:l.senderId,data:C,timestamp:Date.now()},l.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(l.data){const C=l.data;D(N=>[...N,C]),setTimeout(()=>{D(N=>N.filter(W=>W.timestamp!==C.timestamp))},1e3),ae.current&&x.current&&l.senderId&&x.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:l.senderId,data:C,timestamp:Date.now()},l.senderId)}break;case"TRIGGER_TARGET_SELECTION":if(l.data){const C=l.data;A(N=>[...N,C]),setTimeout(()=>{A(N=>N.filter(W=>W.timestamp!==C.timestamp))},1e3),ae.current&&x.current&&l.senderId&&x.current.broadcastToGuests({type:"TARGET_SELECTION_TRIGGERED",senderId:l.senderId,data:C,timestamp:Date.now()},l.senderId)}break;case"TARGET_SELECTION_TRIGGERED":l.data&&l.senderId!==((Zr=x.current)==null?void 0:Zr.getPeerId())&&(A(C=>[...C,l.data]),setTimeout(()=>{A(C=>C.filter(N=>N.timestamp!==l.data.timestamp))},1e3));break;case"DECK_SELECTION_TRIGGERED":l.data&&l.senderId!==((Qr=x.current)==null?void 0:Qr.getPeerId())&&(E(C=>[...C,l.data]),setTimeout(()=>{E(C=>C.filter(N=>N.timestamp!==l.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":l.data&&l.senderId!==((ea=x.current)==null?void 0:ea.getPeerId())&&(D(C=>[...C,l.data]),setTimeout(()=>{D(C=>C.filter(N=>N.timestamp!==l.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((ta=l.data)!=null&&ta.targetingMode){const C=l.data.targetingMode;n(N=>({...N,targetingMode:C})),d.current.targetingMode=C,f.info("[TargetingMode] Received targeting mode via WebRTC",{playerId:C.playerId,mode:C.action.mode})}break;case"CLEAR_TARGETING_MODE":n(C=>({...C,targetingMode:null})),d.current.targetingMode=null;break;case"SYNC_VALID_TARGETS":((ra=l.data)==null?void 0:ra.playerId)!==h.current&&(z({playerId:l.data.playerId,validHandTargets:l.data.validHandTargets||[],isDeckSelectable:l.data.isDeckSelectable||!1}),setTimeout(()=>{z(C=>(C==null?void 0:C.playerId)===l.data.playerId?null:C)},1e4));break;case"RECONNECT_ACCEPT":if((aa=l.data)!=null&&aa.gameState){const C=l.data.gameState;n(C),b("Connected"),f.info(`[Reconnection] State restored with ${((na=C.players)==null?void 0:na.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(N){f.warn("[Reconnection] Failed to clear stored data:",N)}}break;case"RECONNECT_REJECT":{const C=((oa=l.data)==null?void 0:oa.reason)||"unknown";f.warn(`[Reconnection] Reconnection rejected: ${C}`),b("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((sa=l.data)==null?void 0:sa.playerId)!==void 0&&(f.info(`[Reconnection] Player ${l.data.playerId} disconnected, reconnection window open`),n(C=>({...C,players:C.players.map(N=>N.id===l.data.playerId?{...N,isDisconnected:!0}:N)})));break;case"PLAYER_RECONNECTED":((ia=l.data)==null?void 0:ia.playerId)!==void 0&&(f.info(`[Reconnection] Player ${l.data.playerId} reconnected`),n(C=>({...C,players:C.players.map(N=>N.id===l.data.playerId?{...N,isDisconnected:!1}:N)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((da=l.data)==null?void 0:da.playerId)!==void 0&&(f.info(`[Reconnection] Player ${l.data.playerId} converted to dummy`),n(C=>({...C,players:C.players.map(N=>N.id===l.data.playerId?{...N,isDummy:!0,isDisconnected:!0}:N)})));break;default:f.warn(`[handleWebrtcMessage] Unknown message type: ${l.type}`,l);break}},[Ie,mt,He,a,m]),F=$.useCallback(l=>{if(!x.current||lt)return;Ue(!0),b("Connecting");const ee=3e4,v=1e3;let B=0;const Z=ee/v;try{const re={hostPeerId:l,playerId:m,gameState:a,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(re))}catch(re){f.error("[Reconnection] Failed to store data:",re)}const ne=async()=>{B++;const re=Math.max(0,ee-B*v);if(Xe({attempt:B,maxAttempts:Z,timeRemaining:re}),re<=0){f.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Ue(!1),Xe(null),Dt();return}let q=l;if(a!=null&&a.gameId){const De=cr(a.gameId);if(De&&De.peerId!==l){q=De.peerId;try{const ue={hostPeerId:q,playerId:m,gameState:a,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ue))}catch(ue){f.error("[Reconnection] Failed to update reconnection data:",ue)}}}try{const De=m||h.current;De!==null?(f.info(`[Reconnection] Reconnecting as existing player ${De} to host ${q}`),await x.current.initializeAsReconnectingGuest(q,De)):(f.info("[Reconnection] No playerId, connecting as new player"),await x.current.initializeAsGuest(q)),f.info("[Reconnection] Successfully reconnected!"),Ue(!1),Xe(null)}catch(De){f.warn("[Reconnection] Reconnection attempt failed:",De),setTimeout(ne,v)}};ne()},[lt,a,m]),K=$.useCallback(l=>{n(ee=>{var Z,ne,re;if(!ee)return f.error("[updateState] prevState is undefined, skipping update"),ee;const v=typeof l=="function"?l(ee):l;if(!v)return f.error("[updateState] newState is undefined, skipping update"),ee;const B=!ee.gameId&&v.gameId;if(!Ee.current&&!B)return v;if(fe&&x.current){const q=Ct(ee,v,h.current||0);if(f.info(`[updateState] WebRTC enabled, isHost=${ae.current}, delta: boardCells=${((Z=q.boardCells)==null?void 0:Z.length)||0}, playerDeltas=${Object.keys(q.playerDeltas||{}).length}, phase=${!!q.phaseDelta}`),ae.current){if(bt(q)||(x.current.broadcastStateDelta(q),f.info(`[updateState] Host broadcast delta: phase=${!!q.phaseDelta}, board=${((ne=q.boardCells)==null?void 0:ne.length)||0}`)),v.gameId&&h.current!==null)try{Ot({gameState:v,localPlayerId:h.current,isHost:!0}),f.debug("[updateState] Saved game state for host auto-restore")}catch(De){f.warn("[updateState] Failed to save game state:",De)}}else if(!bt(q)){const De=x.current.sendStateDelta(q);f.info(`[updateState] Guest sent delta to host: success=${De}, boardCells=${((re=q.boardCells)==null?void 0:re.length)||0}`)}return v}if(pe.current&&pe.current.readyState===WebSocket.OPEN){const q={type:"UPDATE_STATE",gameState:v};Q.current&&(q.playerToken=Q.current),pe.current.send(JSON.stringify(q))}return v})},[fe,Ie,He]),G=_o({ws:pe,webrtcManager:x,gameStateRef:d,webrtcIsHostRef:ae,setGameState:n,updateState:K}),Y=wo({ws:pe,webrtcManager:x,gameStateRef:d,localPlayerIdRef:h,webrtcIsHostRef:ae,setGameState:n}),X=Do({updateState:K}),ce=Co({updateState:K}),ge=bo({localPlayerIdRef:h,updateState:K}),{addBoardCardStatus:ie,removeBoardCardStatus:oe,removeBoardCardStatusByOwner:de,modifyBoardCardPower:me,addAnnouncedCardStatus:se,removeAnnouncedCardStatus:be,modifyAnnouncedCardPower:Se,addHandCardStatus:_e,removeHandCardStatus:et,revealHandCard:ot,revealBoardCard:tt,requestCardReveal:pt,respondToRevealRequest:it,removeRevealedStatus:st}=ge,rr=Ro({webrtcIsHostRef:ae,getCardDefinition:xn,commandCardIds:Gn,createDeck:mt,updateState:K}),{changePlayerDeck:ft,loadCustomDeck:Ra,resurrectDiscardedCard:Sa,reorderTopDeck:Aa,reorderCards:Oa,recoverDiscardedCard:Pa}=rr,va=So({ws:pe,webrtcManagerRef:x,webrtcIsHostRef:ae,gameStateRef:d,scoreDeltaAccumulator:ht,setGameState:n,updateState:K,abilityMode:t,setAbilityMode:r,createDeck:mt}),{toggleActivePlayer:Na,toggleAutoDraw:ka,setPhase:La,nextPhase:Ma,prevPhase:Ga,closeRoundEndModal:xa,closeRoundEndModalOnly:$a,resetGame:Ha}=va,Et=$.useCallback(()=>{if(localStorage.getItem("webrtc_enabled")==="true"){b("Connected");return}if(u.current||pe.current&&(pe.current.readyState===WebSocket.OPEN||pe.current.readyState===WebSocket.CONNECTING))return;const l=Io();if(!l){f.warn("No WebSocket URL configured in settings. Waiting for user input."),b("Disconnected"),Pe.current&&clearTimeout(Pe.current);return}try{pe.current=new WebSocket(l)}catch(ee){console.error("Failed to create WebSocket:",ee),b("Disconnected"),Pe.current&&clearTimeout(Pe.current),Pe.current=window.setTimeout(Et,we.RECONNECT_DELAY);return}b("Connecting"),pe.current.onopen=()=>{var B;Ee.current=!1,b("Connected");const ee=localStorage.getItem("custom_ws_url");ee&&ee.trim()!==""&&localStorage.setItem("websocket_url",ee.trim());const v=d.current;if(f.info("Current gameState on open:",v?`gameId=${v.gameId}`:"null"),f.info("playerTokenRef.current on open:",Q.current?"YES":"NO"),v&&v.gameId&&((B=pe.current)==null?void 0:B.readyState)===WebSocket.OPEN){let Z=Q.current;if(!Z){try{const ne=localStorage.getItem(Tt);if(ne){const re=JSON.parse(ne);f.info("RECONNECTION_DATA_KEY:",re==null?void 0:re.gameId,v.gameId),re!=null&&re.playerToken&&(Z=re.playerToken,Q.current=Z,f.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(ne){console.warn("Failed to parse reconnection data:",ne instanceof Error?ne.message:String(ne))}if(!Z&&v.players&&h.current){const ne=v.players.find(re=>re.id===h.current);ne!=null&&ne.playerToken&&(Z=ne.playerToken,Q.current=Z)}}f.info("JoinGame: Sending reconnection with token:",Z?"YES":"NO","gameId:",v.gameId),pe.current.send(JSON.stringify({type:"JOIN_GAME",gameId:v.gameId,playerToken:Z}))}},pe.current.onmessage=ee=>{try{const v=JSON.parse(ee.data);if(v.type==="GAMES_LIST")g(v.games);else if(v.type==="JOIN_SUCCESS"){if(v.isSpectator){i(null),f.info("Joined as spectator:",v.message||"Spectator mode"),qe.current=null;return}i(v.playerId);const B=qe.current||d.current.gameId;B&&v.playerId!==null&&v.playerToken?(Q.current=v.playerToken,localStorage.setItem(Tt,JSON.stringify({gameId:B,playerId:v.playerId,playerToken:v.playerToken,timestamp:Date.now()})),d.current.gameId===B&&pa(d.current,v.playerId,v.playerToken)):v.playerId===null&&(St(),Q.current=void 0),qe.current=null,v.playerId===1&&setTimeout(()=>{var Z;((Z=pe.current)==null?void 0:Z.readyState)===WebSocket.OPEN&&pe.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ct}))},we.DECK_SYNC_DELAY)}else if(v.type==="CONNECTION_ESTABLISHED"){f.info("Connection acknowledged by server");const B=sessionStorage.getItem("pending_invite_game"),Z=sessionStorage.getItem("pending_invite_name");B&&pe.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),f.info("Auto-joining invite game:",B),pe.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:B,playerName:Z||"Player"})))}else if(v.type==="DECK_DATA_UPDATED")f.info("Deck data synced with server");else if(v.type==="ERROR")if(v.message.includes("not found")||v.message.includes("Dummy")){f.info("Game not found error - clearing state");const B=It();n(B),d.current=B,i(null),St(),qe.current=null}else if(v.message.includes("already started")&&M.current){f.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const B=It();n(B),d.current=B,i(null),St(),qe.current=null,M.current=!1}else console.warn("Server Error:",v.message);else if(v.type==="HIGHLIGHT_TRIGGERED")S(v.highlightData);else if(v.type==="NO_TARGET_TRIGGERED")T({coords:v.coords,timestamp:v.timestamp});else if(v.type==="DECK_SELECTION_TRIGGERED")E(B=>[...B,v.deckSelectionData]),setTimeout(()=>{E(B=>B.filter(Z=>Z.timestamp!==v.deckSelectionData.timestamp))},1e3);else if(v.type==="HAND_CARD_SELECTION_TRIGGERED")D(B=>[...B,v.handCardSelectionData]),setTimeout(()=>{D(B=>B.filter(Z=>Z.timestamp!==v.handCardSelectionData.timestamp))},1e3);else if(v.type==="FLOATING_TEXT_TRIGGERED")n(B=>({...B,floatingTexts:[...B.floatingTexts,v.floatingTextData].filter(Z=>Date.now()-Z.timestamp<we.FLOATING_TEXT_DURATION)}));else if(v.type==="FLOATING_TEXT_BATCH_TRIGGERED")n(B=>({...B,floatingTexts:[...B.floatingTexts,...v.batch].filter(Z=>Date.now()-Z.timestamp<we.FLOATING_TEXT_DURATION)}));else if(v.type==="SYNC_VALID_TARGETS")v.playerId!==h.current&&(z({playerId:v.playerId,validHandTargets:v.validHandTargets||[],isDeckSelectable:v.isDeckSelectable||!1}),setTimeout(()=>{z(B=>(B==null?void 0:B.playerId)===v.playerId?null:B)},1e4));else if(v.type==="TARGET_SELECTION_TRIGGERED")v.effect&&v.playerId!==h.current&&(A(B=>[...B,v.effect]),setTimeout(()=>{A(B=>B.filter(Z=>Z.timestamp!==v.effect.timestamp))},1e3));else if(v.type==="TARGETING_MODE_SET"){const B=v.targetingMode;B&&(n(Z=>({...Z,targetingMode:B})),d.current.targetingMode=B,f.info("[TargetingMode] Received targeting mode from server",{playerId:B.playerId,mode:B.action.mode}))}else if(v.type==="TARGETING_MODE_CLEARED")n(B=>({...B,targetingMode:null})),d.current.targetingMode=null,f.debug("[TargetingMode] Cleared targeting mode from server");else if(v.type==="ABILITY_MODE_SET")v.abilityMode&&(n(B=>({...B,abilityMode:v.abilityMode})),f.info("[AbilityMode] Received ability mode from host",{playerId:v.abilityMode.playerId,mode:v.abilityMode.mode,sourceCard:v.abilityMode.sourceCardName}));else if(v.type==="ABILITY_TARGET_SELECTED")f.info("[Ability] Target selected",v.data);else if(v.type==="ABILITY_COMPLETED")n(B=>({...B,abilityMode:null})),f.info("[Ability] Ability completed",v.data);else if(v.type==="ABILITY_CANCELLED")n(B=>({...B,abilityMode:null})),f.info("[Ability] Ability cancelled");else if(v.type==="GAME_RESET")f.info("[GameReset] Received GAME_RESET message from server"),n(B=>{const Z=v.activeGridSize||8,ne=[];for(let q=0;q<Z;q++){const De=[];for(let ue=0;ue<Z;ue++)De.push({card:null});ne.push(De)}const re={...B,players:v.players||[],gameMode:v.gameMode,isPrivate:v.isPrivate,activeGridSize:v.activeGridSize,dummyPlayerCount:v.dummyPlayerCount,autoAbilitiesEnabled:v.autoAbilitiesEnabled,isGameStarted:v.isGameStarted,currentPhase:v.currentPhase,currentRound:v.currentRound,turnNumber:v.turnNumber,activePlayerId:v.activePlayerId,startingPlayerId:v.startingPlayerId,roundWinners:v.roundWinners||{},gameWinner:v.gameWinner,isRoundEndModalOpen:v.isRoundEndModalOpen,isReadyCheckActive:v.isReadyCheckActive,board:ne,targetingMode:null,floatingTexts:[]};return d.current=re,re});else if(!v.type&&v.players&&v.board){const B=Gt(v),Z=d.current;if(!Z.isScoringStep&&B.isScoringStep&&B.currentPhase!==2){f.debug("Ignoring delayed scoring state update");return}if(Z.isScoringStep&&(B.currentPhase!==Z.currentPhase||B.activePlayerId!==Z.activePlayerId||B.currentPhase!==4)&&(B.isScoringStep=!1),n(B),d.current=B,h.current!==null&&B.gameId){let re;try{const q=localStorage.getItem(Tt);q&&(re=JSON.parse(q).playerToken)}catch{}if(!re&&B.players){const q=B.players.find(De=>De.id===h.current);q!=null&&q.playerToken&&(re=q.playerToken,Q.current=re)}pa(B,h.current,re)}}else console.warn("Unknown message type:",v.type,"keys:",Object.keys(v),"data:",v)}catch(v){console.error("Failed to parse message from server:",ee.data,v)}},pe.current.onclose=()=>{b("Disconnected"),u.current||(Pe.current&&clearTimeout(Pe.current),Pe.current=window.setTimeout(Et,we.RECONNECT_DELAY))},pe.current.onerror=ee=>console.error("WebSocket error event:",ee)},[n,It]),Ua=$.useCallback((l,ee="Player")=>{var v;u.current=!1,((v=pe.current)==null?void 0:v.readyState)===WebSocket.OPEN?pe.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:l,playerName:ee})):(sessionStorage.setItem("pending_invite_game",l),sessionStorage.setItem("pending_invite_name",ee),Et())},[Et]);$.useEffect(()=>{if(u.current=!1,sessionStorage.getItem("invite_game_id"))return Et(),()=>{u.current=!0,Pe.current&&clearTimeout(Pe.current),pe.current&&(pe.current.onclose=null,pe.current.close())};const ee=performance.getEntriesByType("navigation"),v=ee.length>0?ee[0]:null,B=(v==null?void 0:v.type)??0,Z=Eo();return Z&&(f.info(`Restoring saved game state (nav type: ${B}):`,Z.gameState.gameId),n(Z.gameState),i(Z.localPlayerId),d.current=Z.gameState,h.current=Z.localPlayerId,Q.current=Z.playerToken),Et(),()=>{u.current=!0,Pe.current&&clearTimeout(Pe.current),pe.current&&(pe.current.onclose=null,pe.current.close())}},[]),$.useEffect(()=>{if(ct&&d.current&&d.current.gameId){const l=Gt(d.current);l!==d.current&&(n(l),d.current=l)}},[]),$.useEffect(()=>{if(V)return;const l=setInterval(()=>{if(ct&&d.current&&d.current.gameId){const ee=Gt(d.current);n({...ee}),d.current=ee,J(!0),clearInterval(l)}},100);return()=>clearInterval(l)},[V]);const{startReadyCheck:Wa,cancelReadyCheck:Fa,playerReady:Ba}=Y,{updatePlayerName:Ya,changePlayerColor:ja}=X,{drawCard:za,drawCardsBatch:Ka,shufflePlayerDeck:qa,flipBoardCard:Va,flipBoardCardFaceDown:Ja}=ce,{assignTeams:Xa,setGameMode:Za,setGamePrivacy:Qa,setActiveGridSize:en,setDummyPlayerCount:tn}=G,rn=$.useCallback(()=>{var l;if(((l=pe.current)==null?void 0:l.readyState)===WebSocket.OPEN&&d.current.gameId&&h.current===1){pe.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ct}));const ee=d.current,v=Ne(ee);v.players.forEach(B=>{if(["hand","deck","discard"].forEach(ne=>{B[ne]&&(B[ne]=B[ne].map(re=>{const q=sr(re.name);return q?{...re,...q}:re}))}),B.announcedCard){const ne=sr(B.announcedCard.name);ne&&(B.announcedCard={...B.announcedCard,...ne})}}),v.board.forEach(B=>{B.forEach(Z=>{if(Z.card){const ne=sr(Z.card.name);ne&&(Z.card={...Z.card,...ne})}})}),pe.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:v})),n(v)}},[]),ar=$.useCallback((l,ee)=>{var Z;const v=d.current;if(!v.isGameStarted){f.warn("[ScoreUpdate] Blocked: game not started");return}if(v.isRoundEndModalOpen){f.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(ee===0)return;const B=localStorage.getItem("webrtc_enabled")==="true";if(B?K(ne=>({...ne,players:ne.players.map(re=>re.id===l?{...re,score:Math.max(0,(re.score||0)+ee)}:re)})):n(ne=>({...ne,players:ne.players.map(re=>re.id===l?{...re,score:Math.max(0,(re.score||0)+ee)}:re)})),!B){if(((Z=pe.current)==null?void 0:Z.readyState)!==WebSocket.OPEN){f.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const ne=ht.get(l);if(ne){clearTimeout(ne.timerId);const re=ne.delta+ee,q=setTimeout(()=>{var ue;const De=ht.get(l);De&&((ue=pe.current)==null?void 0:ue.readyState)===WebSocket.OPEN&&(f.info(`[ScoreUpdate] Sending accumulated delta: player=${l}, delta=${De.delta}`),pe.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:d.current.gameId,playerId:l,delta:De.delta}))),ht.delete(l)},500);ht.set(l,{delta:re,timerId:q})}else{const re=setTimeout(()=>{var De;const q=ht.get(l);q&&((De=pe.current)==null?void 0:De.readyState)===WebSocket.OPEN&&(f.info(`[ScoreUpdate] Sending delta: player=${l}, delta=${q.delta}`),pe.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:d.current.gameId,playerId:l,delta:q.delta}))),ht.delete(l)},500);ht.set(l,{delta:ee,timerId:re})}}},[n,K]),{triggerHighlight:an,triggerFloatingText:Sr,triggerNoTarget:nn,triggerDeckSelection:on,triggerHandCardSelection:sn,syncValidTargets:dn,triggerTargetSelection:cn}=nt,ln=Ao({ws:pe,gameStateRef:d,updateState:K,updatePlayerScore:ar,triggerFloatingText:Sr}),{scoreLine:un,scoreDiagonal:fn}=ln,yt=Oo({updateState:K,rawJsonData:ct}),pn=Po({updateState:K,localPlayerIdRef:h,updatePlayerScore:ar}),{moveItem:Ar}=pn,yn=vo({ws:pe,webrtcManager:x,gameStateRef:d,webrtcIsHostRef:ae,setGameState:n}),hn=ko({ws:pe,gameStateRef:d,localPlayerIdRef:h,isRestoringSessionRef:Ve,isManualExitRef:u,webrtcIsHostRef:ae,receivedServerStateRef:Ee,joiningGameIdRef:qe,setGameState:n,setLocalPlayerId:i,connectWebSocket:Et,updateState:K}),{setTargetingMode:mn,clearTargetingMode:En}=yn,{createGame:In,joinGame:Or,exitGame:Tn,requestGamesList:gn,forceReconnect:_n}=hn;return{gameState:a,localPlayerId:m,setLocalPlayerId:i,draggedItem:R,setDraggedItem:p,connectionStatus:I,gamesList:_,latestHighlight:y,latestFloatingTexts:w,latestNoTarget:P,latestDeckSelections:L,latestHandCardSelections:O,joinAsInvite:Ua,startReadyCheck:Wa,cancelReadyCheck:Fa,playerReady:Ba,assignTeams:Xa,setGameMode:Za,setGamePrivacy:Qa,setActiveGridSize:en,setDummyPlayerCount:tn,updatePlayerName:Ya,changePlayerColor:ja,updatePlayerScore:ar,changePlayerDeck:ft,loadCustomDeck:Ra,drawCard:za,drawCardsBatch:Ka,shufflePlayerDeck:qa,moveItem:Ar,handleDrop:Ar,addBoardCardStatus:ie,removeBoardCardStatus:oe,removeBoardCardStatusByOwner:de,modifyBoardCardPower:me,addAnnouncedCardStatus:se,removeAnnouncedCardStatus:be,modifyAnnouncedCardPower:Se,addHandCardStatus:_e,removeHandCardStatus:et,flipBoardCard:Va,flipBoardCardFaceDown:Ja,revealHandCard:ot,revealBoardCard:tt,requestCardReveal:pt,respondToRevealRequest:it,syncGame:rn,removeRevealedStatus:st,toggleActivePlayer:Na,toggleAutoDraw:ka,triggerHighlight:an,triggerFloatingText:Sr,triggerNoTarget:nn,triggerDeckSelection:on,triggerHandCardSelection:sn,triggerTargetSelection:cn,targetSelectionEffects:k,syncValidTargets:dn,remoteValidTargets:j,setTargetingMode:mn,clearTargetingMode:En,nextPhase:Ma,prevPhase:Ga,setPhase:La,markAbilityUsed:yt.markAbilityUsed,applyGlobalEffect:yt.applyGlobalEffect,swapCards:yt.swapCards,transferStatus:yt.transferStatus,transferAllCounters:yt.transferAllCounters,spawnToken:yt.spawnToken,resetDeployStatus:yt.resetDeployStatus,removeStatusByType:yt.removeStatusByType,recoverDiscardedCard:Pa,resurrectDiscardedCard:Sa,scoreLine:un,closeRoundEndModal:xa,closeRoundEndModalOnly:$a,resetGame:Ha,scoreDiagonal:fn,reorderTopDeck:Aa,reorderCards:Oa,updateState:K,createGame:In,joinGame:Or,joinGameViaModal:Or,exitGame:Tn,requestGamesList:gn,forceReconnect:_n,webrtcHostId:Re,webrtcIsHost:Ie,initializeWebrtcHost:Fe,connectAsGuest:Oe,sendWebrtcAction:Ze,isReconnecting:lt,reconnectProgress:ut}},rs=({gameState:e,localPlayerId:t,abilityMode:r,setAbilityMode:a,cursorStack:n,setCursorStack:o,commandContext:s,setCommandContext:m,setViewingDiscard:i,triggerNoTarget:d,triggerTargetSelection:h,setPlayMode:R,setCounterSelectionData:p,interactionLock:I,onAbilityComplete:b,updateState:_,moveItem:g,drawCard:y,drawCardsBatch:S,updatePlayerScore:w,markAbilityUsed:c,applyGlobalEffect:P,swapCards:T,transferStatus:L,transferAllCounters:E,resurrectDiscardedCard:O,spawnToken:D,scoreLine:k,nextPhase:A,modifyBoardCardPower:j,addBoardCardStatus:z,removeBoardCardStatus:V,removeBoardCardStatusByOwner:J,resetDeployStatus:fe,scoreDiagonal:he,removeStatusByType:Re,triggerFloatingText:Te,triggerHandCardSelection:Ie,clearValidTargets:Ke,setTargetingMode:ae,clearTargetingMode:lt})=>{const Ue=$.useCallback((u,M)=>{var Ee,x,ve,Le,Fe,Oe,Ze,nt,Ve,Me,Ge,Be,He;if(u.type==="ABILITY_COMPLETE"){b==null||b();return}if(u.type==="REVEREND_SETUP_SCORE"){const te=((Ee=u.sourceCard)==null?void 0:Ee.ownerId)??0;let F=0;for(let K=0;K<e.board.length;K++)for(let G=0;G<e.board[K].length;G++){const Y=(x=e.board[K][G])==null?void 0:x.card;if(Y!=null&&Y.statuses){const X=Y.statuses.filter(ce=>ce.type==="Exploit"&&ce.addedByPlayerId===te);F+=X.length}}F>0?(w(te,F),Te([{row:M.row,col:M.col,text:`+${F}`,playerId:te}])):Te([{row:M.row,col:M.col,text:"+0",playerId:te}]),c(M,!!u.isDeployAbility,!1,u.readyStatusToRemove);return}if(u.type==="GLOBAL_AUTO_APPLY"){if(((ve=u.payload)==null?void 0:ve.customAction)==="FINN_SCORING"){let te=0;const F=(Le=u.sourceCard)==null?void 0:Le.ownerId;if(F===void 0){console.warn("[FINN_SCORING] Source card missing ownerId, skipping scoring"),c(u.sourceCoords||M,!!u.isDeployAbility,!1,u.readyStatusToRemove);return}if(e.players.forEach(K=>{K.id!==F&&K.hand.forEach(G=>{var Y;(Y=G.statuses)!=null&&Y.some(X=>X.type==="Revealed"&&X.addedByPlayerId===F)&&te++})}),e.board.forEach(K=>{K.forEach(G=>{var X;const Y=G.card;if(Y&&Y.ownerId!==F){const ce=((X=Y.statuses)==null?void 0:X.filter(ge=>ge.type==="Revealed"&&ge.addedByPlayerId===F).length)||0;te+=ce}})}),te>0){const K=u.sourceCoords||M;Te({row:K.row,col:K.col,text:`+${te}`,playerId:F}),w(F,te)}c(u.sourceCoords||M,!!u.isDeployAbility,!1,u.readyStatusToRemove);return}if(((Fe=u.payload)==null?void 0:Fe.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){u.sourceCoords&&u.sourceCoords.row>=0?Re(u.sourceCoords,"Aim"):s.lastMovedCardCoords?Re(s.lastMovedCardCoords,"Aim"):M&&M.row>=0&&Re(M,"Aim");return}if(u.payload&&!u.payload.cleanupCommand){const{tokenType:te,filter:F}=u.payload,K=[],G=e.board.length;if(u.payload.contextReward&&u.sourceCard){let Y=0;const X=M&&M.row>=0?M:s.lastMovedCardCoords;if(X){const{row:ce,col:ge}=X;let ie=e.board[ce][ge].card;const oe=u.payload._tempContextId||s.lastMovedCardId;if((!ie||oe&&ie.id!==oe)&&oe)for(let de=0;de<G;de++){for(let me=0;me<G;me++)if(((Oe=e.board[de][me].card)==null?void 0:Oe.id)===oe){ie=e.board[de][me].card;break}if(ie)break}ie&&(Y=Math.max(0,ie.power+(ie.powerModifier||0)+(ie.bonusPower||0)))}if(Y>0){const ce=u.sourceCard.ownerId;if(ce===void 0){console.error("Cannot apply reward: sourceCard has no ownerId");return}const ge=u.payload.contextReward;ge==="DRAW_MOVED_POWER"||ge==="DRAW_EQUAL_POWER"?S(ce,Y):ge==="SCORE_MOVED_POWER"&&(Te({row:M.row,col:M.col,text:`+${Y}`,playerId:ce}),w(ce,Y))}if(u.payload.contextReward==="STUN_MOVED_UNIT"&&X){const ce=u.sourceCard.ownerId;ce!==void 0?z(X,"Stun",ce):console.error("Cannot apply stun: sourceCard has no ownerId")}return}if(F)for(let Y=0;Y<G;Y++)for(let X=0;X<G;X++){const ce=e.board[Y][X].card;ce&&F(ce)&&K.push({row:Y,col:X})}else u.sourceCoords&&u.sourceCoords.row>=0?K.push(u.sourceCoords):M&&M.row>=0?K.push(M):s.lastMovedCardCoords&&K.push(s.lastMovedCardCoords);if(K.length>0){if(te){const Y=u.payload.count||1,X=u.payload.ownerId!==void 0?u.payload.ownerId:((Ze=u.sourceCard)==null?void 0:Ze.ownerId)??t;for(let ce=0;ce<Y;ce++)P(M,K,te,X,!!u.isDeployAbility)}}else d(M),c(M,!!u.isDeployAbility,!1,u.readyStatusToRemove);return}}if(!qt(u,e,((nt=u.sourceCard)==null?void 0:nt.ownerId)||t,s)){d(M),u.chainedAction&&setTimeout(()=>{Ue(u.chainedAction,M)},500);return}if(u.type==="CREATE_STACK"&&u.tokenType){let te=u.count||0;if(u.dynamicCount){const{factor:F,ownerId:K}=u.dynamicCount;let G=0;e.board.forEach(Y=>Y.forEach(X=>{var ce;if((ce=X.card)!=null&&ce.statuses){const ge=X.card.statuses.filter(ie=>ie.type===F&&ie.addedByPlayerId===K);G+=ge.length}})),te=G}te>0?(a(null),o({type:u.tokenType,count:te,isDragging:!1,sourceCoords:M,sourceCard:u.sourceCard,originalOwnerId:u.originalOwnerId,excludeOwnerId:u.excludeOwnerId,onlyOpponents:u.onlyOpponents,onlyFaceDown:u.onlyFaceDown,targetType:u.targetType,isDeployAbility:u.isDeployAbility,readyStatusToRemove:u.readyStatusToRemove,requiredTargetStatus:u.requiredTargetStatus,requireStatusFromSourceOwner:u.requireStatusFromSourceOwner,mustBeAdjacentToSource:u.mustBeAdjacentToSource,mustBeInLineWithSource:u.mustBeInLineWithSource,maxDistanceFromSource:u.maxDistanceFromSource,maxOrthogonalDistance:u.maxOrthogonalDistance,placeAllAtOnce:u.placeAllAtOnce,chainedAction:u.chainedAction,...u.targetOwnerId!==void 0&&{targetOwnerId:u.targetOwnerId},recordContext:u.recordContext,replaceStatus:u.replaceStatus})):d(M)}else if(u.type==="ENTER_MODE"){if(u.mode==="SHIELD_SELF_THEN_SPAWN"){z(M,"Shield",u.sourceCard.ownerId),a({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility,payload:u.payload});return}if(u.mode==="SHIELD_SELF_THEN_RIOT_PUSH"){const G=u.sourceCard.ownerId;z(M,"Shield",G);const Y=e.board.length,X=Math.floor((Y-e.activeGridSize)/2),ce=X,ge=X+e.activeGridSize-1;let ie=!1;const{row:oe,col:de}=M,me=[[-1,0],[1,0],[0,-1],[0,1]];for(const[se,be]of me){const Se=oe+se,_e=de+be;if(Se<ce||Se>ge||_e<ce||_e>ge)continue;const et=e.board[Se][_e];if(!et.card)continue;const ot=e.players.find(ft=>ft.id===et.card.ownerId),tt=e.players.find(ft=>ft.id===G),pt=(ot==null?void 0:ot.teamId)!==void 0&&(tt==null?void 0:tt.teamId)!==void 0&&ot.teamId===tt.teamId;if(et.card.ownerId===G||pt)continue;const it=Se+se,st=_e+be;if(it<ce||it>ge||st<ce||st>ge)continue;if(e.board[it][st].card===null){ie=!0;break}}ie?a({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility,payload:u.payload}):d(M);return}if(u.mode==="PRINCEPS_SHIELD_THEN_AIM"){const G=u.sourceCard.ownerId;z(M,"Shield",G);const Y={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility};qt(Y,e,G,s)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:M,sourceCard:u.sourceCard,originalOwnerId:u.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:u.isDeployAbility,readyStatusToRemove:u.readyStatusToRemove}):d(M);return}if(u.mode==="GAWAIN_DEPLOY_SHIELD_AIM"){const G=u.sourceCard.ownerId;z(M,"Shield",G);const Y={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility};qt(Y,e,G,s)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:M,sourceCard:u.sourceCard,originalOwnerId:u.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:u.isDeployAbility,readyStatusToRemove:u.readyStatusToRemove}):d(M);return}if(u.mode==="ABR_DEPLOY_SHIELD_AIM"){const G=u.sourceCard.ownerId;z(M,"Shield",G);const Y={type:"CREATE_STACK",tokenType:"Aim",requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility};qt(Y,e,G,s)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:M,sourceCard:u.sourceCard,originalOwnerId:u.originalOwnerId,targetOwnerId:G,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,isDeployAbility:u.isDeployAbility,readyStatusToRemove:u.readyStatusToRemove}):d(M);return}if(u.mode==="RIOT_PUSH"&&u.sourceCoords){const G=e.board.length,Y=Math.floor((G-e.activeGridSize)/2),X=Y,ce=Y+e.activeGridSize-1;let ge=!1;const{row:ie,col:oe}=u.sourceCoords,de=(Ve=u.sourceCard)==null?void 0:Ve.ownerId,me=[[-1,0],[1,0],[0,-1],[0,1]];for(const[se,be]of me){const Se=ie+se,_e=oe+be;if(Se<X||Se>ce||_e<X||_e>ce)continue;const et=e.board[Se][_e];if(!et.card||de===void 0)continue;const ot=e.players.find(ft=>ft.id===et.card.ownerId),tt=e.players.find(ft=>ft.id===de),pt=(ot==null?void 0:ot.teamId)!==void 0&&(tt==null?void 0:tt.teamId)!==void 0&&ot.teamId===tt.teamId;if(et.card.ownerId===de||pt)continue;const it=Se+se,st=_e+be;if(it<X||it>ce||st<X||st>ce)continue;if(e.board[it][st].card===null){ge=!0;break}}if(!ge){d(u.sourceCoords);return}}if(u.mode==="SELECT_TARGET"&&((Me=u.payload)==null?void 0:Me.actionType)==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"&&u.sourceCard){const G=u.sourceCard.ownerId,Y=e.players.find(X=>X.id===G);if(Y&&Y.hand.length<1){d(u.sourceCoords||M);return}}if(u.mode==="SELECT_TARGET"&&((Ge=u.payload)==null?void 0:Ge.actionType)==="LUCIUS_SETUP"&&u.sourceCard){const G=u.sourceCard.ownerId,Y=e.players.find(X=>X.id===G);if(Y&&Y.hand.length<1){d(u.sourceCoords||M);return}}let te=u.sourceCard,F=M;if(u.sourceCoords&&u.sourceCoords.row>=0&&(F=u.sourceCoords),u.mode==="SELECT_CELL"&&s.lastMovedCardCoords&&s.lastMovedCardId&&((Be=u.payload)!=null&&Be.useContextCard)){const{row:G,col:Y}=s.lastMovedCardCoords,X=e.board[G][Y].card;X&&(te=X,F=s.lastMovedCardCoords)}a({...u,sourceCard:te,sourceCoords:F});const K=((He=u.sourceCard)==null?void 0:He.ownerId)??e.activePlayerId??t??1;ae(u,K,F,void 0,s)}else if(u.type==="OPEN_MODAL")if(u.mode==="RETRIEVE_DEVICE"){const te=e.players.find(F=>{var K;return F.id===((K=u.sourceCard)==null?void 0:K.ownerId)});te&&(i({player:te,pickConfig:{filterType:"Device",action:"recover"}}),M.row>=0&&c(M,!!u.isDeployAbility,!1,u.readyStatusToRemove))}else if(u.mode==="IMMUNIS_RETRIEVE"){const te=e.players.find(F=>{var K;return F.id===((K=u.sourceCard)==null?void 0:K.ownerId)});te&&(i({player:te,pickConfig:{filterType:"Optimates",action:"resurrect"}}),a({type:"ENTER_MODE",mode:"IMMUNIS_RETRIEVE",sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility,payload:u.payload}))}else if(u.mode==="SEARCH_DECK"){const te=e.players.find(F=>{var K;return F.id===((K=u.sourceCard)==null?void 0:K.ownerId)});te&&(i({player:te,pickConfig:{filterType:u.payload.filterType||"Unit",action:"recover",isDeck:!0}}),M.row>=0&&c(M,!!u.isDeployAbility,!1,u.readyStatusToRemove))}else u.mode==="ZIUS_LINE_SELECT"?s.lastMovedCardCoords?a({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:u.sourceCard,sourceCoords:s.lastMovedCardCoords,isDeployAbility:u.isDeployAbility,payload:u.payload,chainedAction:u.chainedAction}):a({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility,payload:u.payload,chainedAction:u.chainedAction}):u.mode==="SELECT_DECK"?a({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility,payload:u.payload}):u.mode==="ZIUS_EXPLOIT_AND_SCORE"?a({type:"ENTER_MODE",mode:"ZIUS_EXPLOIT_AND_SCORE",sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility,payload:u.payload}):u.mode==="REVEREND_DOUBLE_EXPLOIT"&&a({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:u.sourceCard,sourceCoords:M,isDeployAbility:u.isDeployAbility,payload:u.payload})},[e,t,s,c,a,o,d,P,i,z,w,y,Re,b,Te,ae]);$.useEffect(()=>{(r==null?void 0:r.type)==="GLOBAL_AUTO_APPLY"&&(Ue(r,r.sourceCoords||{row:-1,col:-1}),a(null))},[r,Ue,a]),$.useEffect(()=>{r||lt()},[r,lt]);const ut=$.useCallback((u,M)=>{if(r||n||!e.isGameStarted||t===null)return;const Q=e.players.find(ve=>ve.id===u.ownerId),Ee=t===u.ownerId||(Q==null?void 0:Q.isDummy)&&t===1;if(e.activePlayerId!==u.ownerId||!Ee||!Yn(u,e)||!mr(u,e.currentPhase,e.activePlayerId,e))return;const x=Bn(u,e,u.ownerId,M);if(x){x.readyStatusToRemove&&c(M,!!x.isDeployAbility,!1,x.readyStatusToRemove);const ve={...x,chainedAction:x.chainedAction?{...x.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};Ue(ve,M)}},[r,n,e,t,Ue,c]),Xe=$.useCallback(u=>{var Fe,Oe,Ze,nt,Ve;if(!r)return;const{mode:M,sourceCard:Q,sourceCoords:Ee,payload:x,isDeployAbility:ve,readyStatusToRemove:Le}=r;if(M==="SCORE_LAST_PLAYED_LINE"&&r.sourceCoords){if(I.current)return;const{row:Me,col:Ge}=r.sourceCoords,{row:Be,col:He}=u;if(Me!==Be&&Ge!==He)return;I.current=!0;const te=e.activePlayerId,F=e.board.length;let K=Me,G=Me,Y=Ge,X=Ge;if(Me===Be)K=Me,G=Me,Y=0,X=F-1;else if(Ge===He)Y=He,X=He,K=0,G=F-1;else{I.current=!1;return}const ce=e.board.some(oe=>oe.some(de=>{var me,se;return((me=de.card)==null?void 0:me.ownerId)===te&&de.card.name.toLowerCase().includes("data liberator")&&((se=de.card.statuses)==null?void 0:se.some(be=>be.type==="Support"))}));let ge=0;const ie=[];for(let oe=K;oe<=G;oe++)for(let de=Y;de<=X;de++){const se=e.board[oe][de].card;if(se&&!((Fe=se.statuses)!=null&&Fe.some(be=>be.type==="Stun"))){const be=se.ownerId===te,Se=(Oe=se.statuses)==null?void 0:Oe.some(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===te);if(be||ce&&Se&&se.ownerId!==te){const _e=Math.max(0,se.power+(se.powerModifier||0)+(se.bonusPower||0));_e>0&&(ge+=_e,ie.push({row:oe,col:de,text:`+${_e}`,playerId:te}))}}}a(null),ie.length>0&&Te(ie),ge>0&&w(te,ge),A(),setTimeout(()=>{I.current=!1},200);return}if(M==="SELECT_LINE_START"){a({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:Q,sourceCoords:Ee,isDeployAbility:ve,payload:{...x,firstCoords:u}});return}if(M==="SELECT_LINE_END"&&(x!=null&&x.firstCoords)){const{row:Me,col:Ge}=x.firstCoords,{row:Be,col:He}=u;if(Me!==Be&&Ge!==He)return;const te=x.actionType,F=(Q==null?void 0:Q.ownerId)??((Ze=e.players.find(K=>K.id===e.activePlayerId))!=null&&Ze.isDummy?e.activePlayerId:t||e.activePlayerId);if(te==="ZIUS_SCORING"){const K=s.lastMovedCardCoords;if(K){const oe=Me===Be&&K.row===Me,de=Ge===He&&K.col===Ge;if(!oe&&!de)return}const G=e.board.length;let Y=0,X=G-1,ce=0,ge=G-1;if(Me===Be)Y=X=Me;else if(Ge===He)ce=ge=Ge;else return;let ie=0;for(let oe=Y;oe<=X;oe++)for(let de=ce;de<=ge;de++){const me=e.board[oe][de];me.card&&(ie+=((nt=me.card.statuses)==null?void 0:nt.filter(se=>se.type==="Exploit"&&se.addedByPlayerId===F).length)||0)}ie>0&&F&&(Ee&&Te({row:Ee.row,col:Ee.col,text:`+${ie}`,playerId:F}),w(F,ie)),Ee&&Ee.row>=0&&c(Ee,ve,!1,Le)}else if(te==="CENTURION_BUFF"&&Q&&Ee&&F){const K=e.board.length;let G=0,Y=K-1,X=0,ce=K-1;Me===Be?G=Y=Me:X=ce=Ge;for(let ge=G;ge<=Y;ge++)for(let ie=X;ie<=ce;ie++){const oe=e.board[ge][ie].card;if(oe){const de=oe.id===Q.id,me=oe.ownerId===F,se=e.players.find(_e=>_e.id===F),be=e.players.find(_e=>_e.id===oe.ownerId),Se=(se==null?void 0:se.teamId)!==void 0&&(be==null?void 0:be.teamId)!==void 0&&se.teamId===be.teamId;!de&&(me||Se)&&j({row:ge,col:ie},1)}}c(Ee,ve,!1,Le)}else(te==="SCORE_LINE"||!te)&&(k(Me,Ge,Be,He,F),x.skipNextPhase||A());setTimeout(()=>a(null),we.MODE_CLEAR_DELAY)}if(M==="SELECT_DIAGONAL"&&x.actionType==="SCORE_DIAGONAL"){const Me=(Q==null?void 0:Q.ownerId)??((Ve=e.players.find(Ge=>Ge.id===e.activePlayerId))!=null&&Ve.isDummy?e.activePlayerId:t||e.activePlayerId);if(x.firstCoords){const{row:Ge,col:Be}=x.firstCoords,{row:He,col:te}=u;if(Math.abs(Ge-He)!==Math.abs(Be-te)){a(null);return}he(Ge,Be,He,te,Me,x.bonusType),x.skipNextPhase||A(),a(null);return}else{a({...r,payload:{...x,firstCoords:u}});return}}},[r,e,t,k,A,a,j,c,he,w,Te,s,_]),$e=$.useCallback((u,M)=>{var Q,Ee,x,ve,Le,Fe,Oe,Ze,nt,Ve,Me,Ge,Be,He;if(n&&R!==null&&R!==void 0){const te={targetOwnerId:n.targetOwnerId,excludeOwnerId:n.excludeOwnerId,onlyOpponents:n.onlyOpponents||n.targetOwnerId===-1,onlyFaceDown:n.onlyFaceDown,targetType:n.targetType,requiredTargetStatus:n.requiredTargetStatus,tokenType:n.type};gt({card:u,ownerId:u.ownerId??0,location:"board"},te,e.activePlayerId,e.players)&&n.type==="Aim"&&(g({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Aim",count:1},{target:"board",boardCoords:M}),n.sourceCoords&&n.sourceCoords.row>=0&&c(n.sourceCoords,n.isDeployAbility,!1,n.readyStatusToRemove),n.count>1?o(K=>K?{...K,count:K.count-1}:null):(n.chainedAction&&Ue(n.chainedAction,n.sourceCoords||{row:-1,col:-1}),o(null)));return}if(!I.current){if(r&&(r.mode==="SCORE_LAST_PLAYED_LINE"||r.mode==="SELECT_LINE_END")){Xe(M);return}if((r==null?void 0:r.type)==="ENTER_MODE"){if(r.sourceCard&&r.sourceCard.id===u.id&&r.mode!=="SELECT_LINE_START"&&r.mode!=="INTEGRATOR_LINE_SELECT"&&r.mode!=="ZIUS_LINE_SELECT"&&r.mode!=="IP_AGENT_THREAT_SCORING"&&r.mode!=="SELECT_UNIT_FOR_MOVE"&&r.mode!=="SELECT_TARGET"&&r.mode!=="RIOT_PUSH"&&r.mode!=="RIOT_MOVE"&&r.mode!=="REVEREND_DOUBLE_EXPLOIT")return;const{mode:te,payload:F,sourceCard:K,sourceCoords:G,isDeployAbility:Y,readyStatusToRemove:X,originalOwnerId:ce,recordContext:ge}=r;if(te==="SELECT_LINE_START"||te==="SELECT_LINE_END"){Xe(M);return}const ie=(K==null?void 0:K.ownerId)??((Q=e.players.find(oe=>oe.id===e.activePlayerId))!=null&&Q.isDummy?e.activePlayerId:t||e.activePlayerId);if(te==="SELECT_TARGET"&&F.tokenType){if(F.filter&&!F.filter(u,M.row,M.col))return;if(g({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:F.tokenType,count:F.count||1},{target:"board",boardCoords:M}),h("board",M),ge&&m({lastMovedCardCoords:M,lastMovedCardId:u.id}),F.chainedAction){const oe={...F.chainedAction,sourceCard:F.chainedAction.sourceCard??u,sourceCoords:F.chainedAction.sourceCoords??M,isDeployAbility:Y,recordContext:!0};Ue(oe,M),setTimeout(()=>h("board",M),100),oe.type!=="ENTER_MODE"&&a(null)}else G&&G.row>=0&&c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="OPEN_COUNTER_MODAL"){if(F.filter&&!F.filter(u))return;p({card:u,callbackAction:F.rewardType}),a(null);return}if(te==="SELECT_TARGET"&&F.actionType==="SACRIFICE_AND_BUFF_LINES"){if(F.filter&&!F.filter(u,M.row,M.col))return;g({card:u,source:"board",boardCoords:M,bypassOwnershipCheck:!0},{target:"discard",playerId:u.ownerId});const oe=e.board.length,{row:de,col:me}=M;for(let se=0;se<oe;se++){if(se===me)continue;const Se=e.board[de][se].card;Se&&(Se.ownerId===ie||((Ee=e.players.find(_e=>_e.id===ie))==null?void 0:Ee.teamId)!==void 0&&((x=e.players.find(_e=>_e.id===Se.ownerId))==null?void 0:x.teamId)===((ve=e.players.find(_e=>_e.id===ie))==null?void 0:ve.teamId))&&j({row:de,col:se},1)}for(let se=0;se<oe;se++){if(se===de)continue;const Se=e.board[se][me].card;Se&&(Se.ownerId===ie||((Le=e.players.find(_e=>_e.id===ie))==null?void 0:Le.teamId)!==void 0&&((Fe=e.players.find(_e=>_e.id===Se.ownerId))==null?void 0:Fe.teamId)===((Oe=e.players.find(_e=>_e.id===ie))==null?void 0:Oe.teamId))&&j({row:se,col:me},1)}G&&G.row>=0&&c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="REVEREND_DOUBLE_EXPLOIT"){if(!ie)return;const oe=ie,de=(u.statuses||[]).filter(me=>me.type==="Exploit"&&me.addedByPlayerId===oe).length;for(let me=0;me<de;me++)g({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Exploit",count:1},{target:"board",boardCoords:M});G&&G.row>=0&&c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="DESTROY"){if(F.handOnly||F.filter&&!F.filter(u,M.row,M.col))return;if(((Ze=u.statuses)==null?void 0:Ze.some(de=>de.type==="Shield"))?V(M,"Shield"):g({card:u,source:"board",boardCoords:M,bypassOwnershipCheck:!0},{target:"discard",playerId:u.ownerId}),F.chainedAction){const de={...F.chainedAction,sourceCard:K,sourceCoords:G,isDeployAbility:Y};Ue(de,G),de.type!=="ENTER_MODE"&&a(null)}else G&&G.row>=0&&c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="DRAW_EQUAL_POWER"){if(F.filter&&!F.filter(u))return;const oe=Math.max(0,u.power+(u.powerModifier||0));for(let de=0;de<oe;de++)y(ie);setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="SCORE_EQUAL_POWER"){if(F.filter&&!F.filter(u))return;const oe=Math.max(0,u.power+(u.powerModifier||0));G&&Te({row:G.row,col:G.col,text:`+${oe}`,playerId:ie}),w(ie,oe),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="RESET_DEPLOY"){if(F.filter&&!F.filter(u))return;fe(M),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="SHIELD_AND_REMOVE_AIM"){if(F.filter&&!F.filter(u))return;z(M,"Shield",ie),Re(M,"Aim"),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="MODIFY_POWER"){if(F.filter&&!F.filter(u))return;F.amount&&j(M,F.amount),G&&G.row>=0&&c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="RIOT_PUSH"&&G&&G.row>=0){if(M.row===G.row&&M.col===G.col){c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}const oe=Math.abs(M.row-G.row)+Math.abs(M.col-G.col)===1,de=e.players.find(st=>st.id===u.ownerId),me=e.players.find(st=>st.id===ie),se=(de==null?void 0:de.teamId)!==void 0&&(me==null?void 0:me.teamId)!==void 0&&de.teamId===me.teamId;if(!oe||u.ownerId===ie||se)return;const be=M.row-G.row,Se=M.col-G.col,_e=M.row+be,et=M.col+Se,ot=e.board.length,tt=Math.floor((ot-e.activeGridSize)/2),pt=tt,it=tt+e.activeGridSize-1;if(_e<pt||_e>it||et<pt||et>it||e.board[_e][et].card!==null)return;g({card:u,source:"board",boardCoords:M,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:_e,col:et}}),a({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:K,sourceCoords:G,isDeployAbility:Y,payload:{vacatedCoords:M}});return}if(te==="SWAP_POSITIONS"&&G&&G.row>=0){const oe=e.board[G.row][G.col].card;if(!oe||oe.id!==(K==null?void 0:K.id)){a(null);return}if(K&&K.id===u.id||F.filter&&!F.filter(u,M.row,M.col))return;T(G,M),c(M,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="TRANSFER_STATUS_SELECT"&&G&&G.row>=0){if(K&&K.id===u.id||F.filter&&!F.filter(u,M.row,M.col))return;u.statuses&&u.statuses.length>0&&(L(M,G,u.statuses[0].type),c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY));return}if(te==="TRANSFER_ALL_STATUSES"&&G&&G.row>=0){if(K&&K.id===u.id||F.filter&&!F.filter(u,M.row,M.col))return;E(M,G),c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="REVEAL_ENEMY"){if(K&&K.id===u.id||F.filter&&!F.filter(u,M.row,M.col))return;o({type:"Revealed",count:1,isDragging:!1,sourceCoords:G,sourceCard:K,originalOwnerId:ce,targetOwnerId:u.ownerId,onlyFaceDown:!0,onlyOpponents:!0,isDeployAbility:Y,readyStatusToRemove:X}),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="CENSOR_SWAP"&&G&&G.row>=0){if(F.filter&&!F.filter(u))return;J(M,"Exploit",ie),z(M,"Stun",ie),c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="ZEALOUS_WEAKEN"&&G&&G.row>=0){if(F.filter&&!F.filter(u))return;j(M,-1),c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="CENTURION_BUFF"&&G&&G.row>=0){c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="SELECT_UNIT_FOR_MOVE"&&G&&G.row>=0){if(F.filter&&!F.filter(u))return;a({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:u,sourceCoords:M,isDeployAbility:Y,recordContext:ge,originalOwnerId:ie??void 0,payload:{allowSelf:!1,abilitySourceCoords:G,range:F.range,chainedAction:F.chainedAction,originalActorId:ie??void 0}});return}if(te==="SELECT_UNIT_FOR_MOVE"&&!G){if(F.filter&&!F.filter(u))return;a({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:u,sourceCoords:M,recordContext:ge,originalOwnerId:ie??void 0,payload:{allowSelf:!1,range:F.range,chainedAction:F.chainedAction,originalActorId:ie??void 0}});return}if(te==="INTEGRATOR_LINE_SELECT"&&G&&G.row>=0){if(M.row!==G.row&&M.col!==G.col)return;const oe=e.board.length;let de=0;if(M.row===G.row)for(let me=0;me<oe;me++){const se=e.board[M.row][me];se.card&&(de+=((nt=se.card.statuses)==null?void 0:nt.filter(be=>be.type==="Exploit"&&be.addedByPlayerId===ie).length)||0)}else for(let me=0;me<oe;me++){const se=e.board[me][M.col];se.card&&(de+=((Ve=se.card.statuses)==null?void 0:Ve.filter(be=>be.type==="Exploit"&&be.addedByPlayerId===ie).length)||0)}de>0&&(Te({row:G.row,col:G.col,text:`+${de}`,playerId:ie}),w(ie,de)),c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="IP_AGENT_THREAT_SCORING"&&G&&G.row>=0){if(M.row!==G.row&&M.col!==G.col)return;const oe=e.board.length;let de=0;if(M.row===G.row)for(let se=0;se<oe;se++){const be=e.board[M.row][se];be.card&&(de+=((Me=be.card.statuses)==null?void 0:Me.filter(Se=>Se.type==="Threat"&&Se.addedByPlayerId===ie).length)||0)}else for(let se=0;se<oe;se++){const be=e.board[se][M.col];be.card&&(de+=((Ge=be.card.statuses)==null?void 0:Ge.filter(Se=>Se.type==="Threat"&&Se.addedByPlayerId===ie).length)||0)}const me=de*2;me>0&&(Te({row:G.row,col:G.col,text:`+${me}`,playerId:ie}),w(ie,me)),c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(te==="ZIUS_LINE_SELECT"&&G&&G.row>=0){if(M.row!==G.row&&M.col!==G.col)return;const oe=e.board.length;let de=0;const me=[];if(M.row===G.row)for(let se=0;se<oe;se++){const be=e.board[M.row][se];if(be.card){const Se=((Be=be.card.statuses)==null?void 0:Be.filter(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===ie).length)||0;Se>0&&(de+=Se,me.push({row:M.row,col:se,text:`+${Se}`,playerId:ie,timestamp:Date.now()}))}}else for(let se=0;se<oe;se++){const be=e.board[se][M.col];if(be.card){const Se=((He=be.card.statuses)==null?void 0:He.filter(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===ie).length)||0;Se>0&&(de+=Se,me.push({row:se,col:M.col,text:`+${Se}`,playerId:ie,timestamp:Date.now()}))}}de>0&&(Te(me),w(ie,de)),c(G,Y,!1,X),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}return}!r&&!n&&ut(u,M)}},[r,n,e,t,I,Xe,g,c,a,o,R,V,J,z,j,T,L,E,w,y,ut,p,fe,Re,Ue,m,Te,h,gt]),pe=$.useCallback(u=>{var Ze,nt,Ve,Me,Ge,Be,He,te;if(I.current||(r==null?void 0:r.type)!=="ENTER_MODE")return;const{mode:M,sourceCoords:Q,sourceCard:Ee,payload:x,isDeployAbility:ve,readyStatusToRemove:Le,recordContext:Fe}=r;if(M==="SCORE_LAST_PLAYED_LINE"||M==="SELECT_LINE_END"){Xe(u);return}if(M==="SELECT_LINE_START"){Xe(u);return}if(M==="SELECT_DIAGONAL"){Xe(u);return}const Oe=(Ee==null?void 0:Ee.ownerId)??((Ze=e.players.find(F=>F.id===e.activePlayerId))!=null&&Ze.isDummy?e.activePlayerId:t||e.activePlayerId);if(M==="PATROL_MOVE"&&Q&&Ee&&Q.row>=0){const F=u.row===Q.row,K=u.col===Q.col;if(u.row===Q.row&&u.col===Q.col){c(Q,ve,!1,Le),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}(F||K)&&(c(Q,ve,!1,Le),g({card:Ee,source:"board",boardCoords:Q},{target:"board",boardCoords:u}),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY));return}if(M==="RIOT_MOVE"&&Q&&Ee&&x.vacatedCoords){if(u.row===x.vacatedCoords.row&&u.col===x.vacatedCoords.col){g({card:Ee,source:"board",boardCoords:Q},{target:"board",boardCoords:u}),c(u,ve,!1,Le),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}c(Q,ve,!1,Le),a(null);return}if(M==="SPAWN_TOKEN"&&Q&&x.tokenName&&Q.row>=0){if(Math.abs(u.row-Q.row)+Math.abs(u.col-Q.col)===1){const K=(Ee==null?void 0:Ee.ownerId)??Oe;D(u,x.tokenName,K),c(Q,ve,!1,Le),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY)}return}if(M==="SELECT_CELL"&&Ee){const F=(()=>{var G;if(x.moveFromHand)return null;if(Q&&Q.row>=0)return Q;for(let Y=0;Y<e.board.length;Y++)for(let X=0;X<e.board.length;X++)if(((G=e.board[Y][X].card)==null?void 0:G.id)===Ee.id)return{row:Y,col:X};return null})();if(x.moveFromHand&&s.selectedHandCard){const{playerId:G,cardIndex:Y}=s.selectedHandCard,X=e.players.find(ge=>ge.id===G),ce=X==null?void 0:X.hand[Y];ce&&(g({card:ce,source:"hand",playerId:G,cardIndex:Y,isManual:!0},{target:"board",boardCoords:u}),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY));return}let K=!1;if(F)if(x.range==="line")K=u.row===F.row||u.col===F.col;else if(x.range==="global")K=!0;else if(x.range===2){const G=Math.abs(u.row-F.row)+Math.abs(u.col-F.col);if(G===1)K=!0;else if(G===2){const Y=F.row,X=F.col,ce=u.row,ge=u.col;K=[{r:ce,c:X},{r:Y,c:ge},{r:(Y+ce)/2,c:(X+ge)/2}].some(oe=>{if(!Number.isInteger(oe.r)||!Number.isInteger(oe.c))return!1;const de=Math.floor((e.board.length-e.activeGridSize)/2),me=de,se=de+e.activeGridSize-1;return oe.r<me||oe.r>se||oe.c<me||oe.c>se||Math.abs(oe.r-Y)+Math.abs(oe.c-X)!==1?!1:!e.board[oe.r][oe.c].card})}}else K=Math.abs(u.row-F.row)+Math.abs(u.col-F.col)===1;if(K&&F){const G=x.allowSelf&&u.row===F.row&&u.col===F.col;if(!G){const Y=e.board[F.row][F.col].card;Y&&g({card:Y,source:"board",boardCoords:F,bypassOwnershipCheck:!0},{target:"board",boardCoords:u})}if(Fe&&m({lastMovedCardCoords:u,lastMovedCardId:Ee.id}),x.chainedAction){const Y={...x.chainedAction};Y.targetOwnerId===-2&&(Y.targetOwnerId=Ee.ownerId),Fe&&(Y.payload||(Y.payload={}),Y.payload._tempContextId=Ee.id),a(null),Ke(),setTimeout(()=>{Ue(Y,u)},1)}else{if(x.abilitySourceCoords)c(x.abilitySourceCoords,ve,!1,Le);else{const Y=G?Q:u;Y&&Y.row>=0&&(x.originalActorId===void 0||Ee.ownerId===x.originalActorId)&&c(Y,ve,!1,Le)}setTimeout(()=>a(null),we.MODE_CLEAR_DELAY)}return}return}if(M==="IMMUNIS_RETRIEVE"&&Q&&Q.row>=0){if(x.selectedCardIndex!==void 0&&((nt=x.filter)!=null&&nt.call(x,u.row,u.col))){O(Oe,x.selectedCardIndex,u),c(Q,ve,!1,Le),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(x.selectedCardIndex===void 0)return}if(M==="INTEGRATOR_LINE_SELECT"&&Q&&Q.row>=0){if(u.row!==Q.row&&u.col!==Q.col)return;const F=e.board.length;let K=0;if(u.row===Q.row)for(let G=0;G<F;G++){const Y=e.board[u.row][G];Y.card&&(K+=((Ve=Y.card.statuses)==null?void 0:Ve.filter(X=>X.type==="Exploit"&&X.addedByPlayerId===Oe).length)||0)}else for(let G=0;G<F;G++){const Y=e.board[G][u.col];Y.card&&(K+=((Me=Y.card.statuses)==null?void 0:Me.filter(X=>X.type==="Exploit"&&X.addedByPlayerId===Oe).length)||0)}K>0&&(Te({row:Q.row,col:Q.col,text:`+${K}`,playerId:Oe}),w(Oe,K)),c(Q,ve,!1,Le),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(M==="ZIUS_LINE_SELECT"&&Q&&Q.row>=0){if(u.row!==Q.row&&u.col!==Q.col)return;const F=e.board.length;let K=0;const G=[];if(u.row===Q.row)for(let Y=0;Y<F;Y++){const X=e.board[u.row][Y];if(X.card){const ce=((Ge=X.card.statuses)==null?void 0:Ge.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===Oe).length)||0;ce>0&&(K+=ce,G.push({row:u.row,col:Y,text:`+${ce}`,playerId:Oe,timestamp:Date.now()}))}}else for(let Y=0;Y<F;Y++){const X=e.board[Y][u.col];if(X.card){const ce=((Be=X.card.statuses)==null?void 0:Be.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===Oe).length)||0;ce>0&&(K+=ce,G.push({row:Y,col:u.col,text:`+${ce}`,playerId:Oe,timestamp:Date.now()}))}}K>0&&(Te(G),w(Oe,K)),c(Q,ve,!1,Le),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}if(M==="IP_AGENT_THREAT_SCORING"&&Q&&Q.row>=0){if(u.row!==Q.row&&u.col!==Q.col)return;const F=e.board.length;let K=0;if(u.row===Q.row)for(let Y=0;Y<F;Y++){const X=e.board[u.row][Y];X.card&&(K+=((He=X.card.statuses)==null?void 0:He.filter(ce=>ce.type==="Threat"&&ce.addedByPlayerId===Oe).length)||0)}else for(let Y=0;Y<F;Y++){const X=e.board[Y][u.col];X.card&&(K+=((te=X.card.statuses)==null?void 0:te.filter(ce=>ce.type==="Threat"&&ce.addedByPlayerId===Oe).length)||0)}const G=K*2;G>0&&(Te({row:Q.row,col:Q.col,text:`+${G}`,playerId:Oe}),w(Oe,G)),c(Q,ve,!1,Le),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY);return}},[I,r,e,t,Xe,g,c,a,D,m,O,w,s,Ue,Te,Ke]),Pe=$.useCallback((u,M,Q)=>{var Ee;if(!I.current){if(n&&R!==null&&R!==void 0){const x={targetOwnerId:n.targetOwnerId,excludeOwnerId:n.excludeOwnerId,onlyOpponents:n.onlyOpponents||n.targetOwnerId===-1,onlyFaceDown:n.onlyFaceDown,targetType:n.targetType,requiredTargetStatus:n.requiredTargetStatus,tokenType:n.type};if(gt({card:M,ownerId:u.id,location:"hand"},x,e.activePlayerId,e.players)&&n.type==="Revealed"){const Le=((Ee=n.sourceCard)==null?void 0:Ee.ownerId)??e.activePlayerId??t??1;M.statuses||(M.statuses=[]),M.statuses.some(Oe=>Oe.type==="Revealed"&&Oe.addedByPlayerId===Le)||(M.statuses.push({type:"Revealed",addedByPlayerId:Le}),g({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:u.id,cardIndex:Q}),n.sourceCoords&&n.sourceCoords.row>=0&&c(n.sourceCoords,n.isDeployAbility,!1,n.readyStatusToRemove),n.count>1?o(Oe=>Oe?{...Oe,count:Oe.count-1}:null):(n.chainedAction&&Ue(n.chainedAction,n.sourceCoords||{row:-1,col:-1}),o(null)))}return}if((r==null?void 0:r.type)==="ENTER_MODE"&&r.mode==="SELECT_TARGET"){const{payload:x,sourceCoords:ve,isDeployAbility:Le,sourceCard:Fe,readyStatusToRemove:Oe}=r;if(Ie(u.id,Q,e.activePlayerId??t??1),x.actionType==="SELECT_HAND_FOR_DEPLOY"){if(x.filter&&!x.filter(M))return;m(Ze=>({...Ze,selectedHandCard:{playerId:u.id,cardIndex:Q}})),a({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:M,payload:{range:"global",moveFromHand:!0}});return}if(x.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(x.filter&&!x.filter(M)||u.id!==(Fe==null?void 0:Fe.ownerId))return;g({card:M,source:"hand",playerId:u.id,cardIndex:Q,bypassOwnershipCheck:!0},{target:"discard",playerId:u.id}),a({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:Fe,sourceCoords:ve,isDeployAbility:Le,payload:{tokenName:x.tokenName}});return}if(x.actionType==="LUCIUS_SETUP"){if(u.id!==(Fe==null?void 0:Fe.ownerId))return;g({card:M,source:"hand",playerId:u.id,cardIndex:Q,bypassOwnershipCheck:!0},{target:"discard",playerId:u.id}),Ue({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:Fe,sourceCoords:ve,isDeployAbility:Le,payload:{filterType:"Command"}},ve||{row:-1,col:-1}),a(null);return}if(x.actionType==="DESTROY"){if(x.filter&&!x.filter(M))return;g({card:M,source:"hand",playerId:u.id,cardIndex:Q,bypassOwnershipCheck:!0},{target:"discard",playerId:u.id}),ve&&ve.row>=0&&c(ve,Le,!1,Oe),setTimeout(()=>a(null),we.MODE_CLEAR_DELAY)}}}},[I,r,g,c,a,m,Ue,e,t,Ie,n,o,R]),qe=$.useCallback((u,M)=>{r||n||I.current||e.isGameStarted&&e.activePlayerId===u.id&&mr(M,e.currentPhase,e.activePlayerId,e)&&ut(M,{row:-1,col:-1})},[r,n,I,e,ut]);return{activateAbility:ut,executeAction:Ue,handleLineSelection:Xe,handleBoardCardClick:$e,handleEmptyCellClick:pe,handleHandCardClick:Pe,handleAnnouncedCardDoubleClick:qe}},pr=(e,t,r,a,n)=>{const o=(r.baseId||e.split("_")[1]||e).toLowerCase(),s=t===-1,m=[];o==="overwatch"?s?m.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):t===0?m.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},targetOwnerId:-1,onlyOpponents:!0,sourceCard:r}):t===1&&m.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:n,baseCount:0}},sourceCard:r}):o==="tacticalmaneuver"?t===0?m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:d=>d.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:r}}}):t===1&&m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:d=>d.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:r}}}):o==="inspiration"?s&&m.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"OPEN_COUNTER_MODAL",filter:d=>d.ownerId===n}}):o==="datainterception"?s?m.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r}):t===0?m.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):t===1&&m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:d=>{var h;return((h=d.statuses)==null?void 0:h.some(R=>R.type==="Exploit"&&R.addedByPlayerId===n))||!1}}}):o==="falseorders"?s?m.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):t===0?m.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:n,sourceCard:r,originalOwnerId:r.ownerId}}}):t===1&&m.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:n}}}}):o==="experimentalstimulants"?t===0?m.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"RESET_DEPLOY",filter:d=>{var h;return d.ownerId===n&&((h=d.types)==null?void 0:h.includes("Unit"))}}}):t===1&&m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:"line",filter:d=>d.ownerId===n}}):o==="logisticschain"?t===0?m.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):t===1&&m.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):o==="quickresponseteam"?t===0?m.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:d=>{var h;return d.ownerId===n&&((h=d.types)==null?void 0:h.includes("Unit"))}}}):t===1&&m.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:r,payload:{filterType:"Unit"}}):o==="temporaryshelter"?t===0?m.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:r,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):t===1&&m.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:r,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):o==="enhancedinterrogation"?s?m.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):t===0?m.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):t===1&&m.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:d=>{var h;return((h=d.statuses)==null?void 0:h.some(R=>R.type==="Aim"&&R.addedByPlayerId===n))||!1}}}):(o==="mobilization1"||o==="linebreach")&&s&&m.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:r,payload:{actionType:"SCORE_LINE"}});const i=r.ownerId||n;return m.forEach(d=>{d.originalOwnerId=i,d.sourceCard&&!d.sourceCard.ownerId&&(d.sourceCard.ownerId=i)}),m},as=({gameState:e,localPlayerId:t,setActionQueue:r,setCommandContext:a,setCommandModalCard:n,setCounterSelectionData:o,moveItem:s,updatePlayerScore:m,updateState:i})=>{const d=$.useCallback((p,I)=>{if(t===null)return;const b=e.players.find(S=>S.id===I.playerId);if(!(I.playerId===t||(b==null?void 0:b.isDummy)))return;s(I,{target:"announced",playerId:I.playerId}),a({});const g=(p.baseId||p.id.split("_")[1]||p.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(S=>g.includes(S)))n(p);else{const S=pr(p.id,-1,p,e,I.playerId);S.length>0?r([...S,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:p,ownerId:I.playerId},sourceCard:p}]):r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:p,ownerId:I.playerId},sourceCard:p}])}},[e,t,s,r,a,n]),h=$.useCallback((p,I)=>{var w,c;if(!I||t===null)return;const b=I.ownerId||t,_=[],g=pr(I.id,-1,I,e,b);let y;(w=I.baseId)!=null&&w.toLowerCase().includes("inspiration")&&(y=p===0?"DRAW_REMOVED":"SCORE_REMOVED",g.length>0&&g[0].type==="ENTER_MODE"&&(g[0]={...g[0],payload:{...g[0].payload,rewardType:y}})),g.forEach(P=>{_.push(P)}),pr(I.id,p,I,e,b).forEach(P=>{_.push(P)}),(c=I.baseId)!=null&&c.toLowerCase().includes("inspiration")||_.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:I,ownerId:b},sourceCard:I}),r(_),n(null)},[e,t,r,n]),R=$.useCallback((p,I)=>{var y;if(t===null)return;const b=I.card.ownerId||t;let _=null;for(let S=0;S<e.board.length;S++){for(let w=0;w<e.board[S].length;w++)if(((y=e.board[S][w].card)==null?void 0:y.id)===I.card.id){_={row:S,col:w};break}if(_)break}if(!_){console.warn(`Card ${I.card.id} not found on board during counter removal`),o(null);return}if(i(S=>{if(!S.isGameStarted)return S;const w=Ne(S),c=w.board[_.row][_.col].card;let P=0;const T=(c==null?void 0:c.statuses)??[];if(Object.entries(p).forEach(([L,E])=>{for(let O=0;O<E;O++){const D=T.map(k=>k.type).lastIndexOf(L);D>-1&&(c!=null&&c.statuses)&&(c.statuses.splice(D,1),P++)}}),!(c!=null&&c.statuses)&&c&&(c.statuses=[]),w.board=Qe(w),P>0&&I.callbackAction==="DRAW_REMOVED"){const L=w.players.find(E=>E.id===b);if(L){const E=Math.min(P,L.deck.length);for(let O=0;O<E;O++){const D=L.deck.shift();D&&L.hand.push(D)}}}return w}),I.callbackAction==="SCORE_REMOVED"){const S=Object.values(p).reduce((w,c)=>w+c,0);S>0&&m(b,S)}const g=e.players.find(S=>S.id===b);g!=null&&g.announcedCard&&r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:g.announcedCard,ownerId:b},sourceCard:g.announcedCard}]),o(null)},[t,m,r,o,e,i]);return{playCommandCard:d,handleCommandConfirm:h,handleCounterSelectionConfirm:R}},ns=({gameState:e,localPlayerId:t,handleDrop:r,markAbilityUsed:a,requestCardReveal:n,interactionLock:o,setCommandContext:s,onAction:m,cursorStack:i,setCursorStack:d,setAbilityMode:h,triggerTargetSelection:R})=>{const p=$.useRef(null),I=$.useRef({x:0,y:0});return $.useLayoutEffect(()=>{if(i&&p.current){const{x:_,y:g}=I.current;p.current.style.transform=`translate(${_-24}px, ${g-24}px)`}},[i]),$.useEffect(()=>{const _=g=>{I.current={x:g.clientX,y:g.clientY},p.current&&(p.current.style.transform=`translate(${g.clientX-24}px, ${g.clientY-24}px)`)};return window.addEventListener("mousemove",_),()=>window.removeEventListener("mousemove",_)},[]),$.useEffect(()=>{const _=g=>{var c,P,T,L,E,O,D,k;if(g.button!==0||!i)return;const y=document.elementFromPoint(g.clientX,g.clientY);let S=t;if(i.originalOwnerId!==void 0)S=i.originalOwnerId;else if((c=i.sourceCard)!=null&&c.ownerId)S=i.sourceCard.ownerId;else if(i.sourceCoords&&i.sourceCoords.row>=0){const{row:A,col:j}=i.sourceCoords;if(A>=0&&A<e.board.length&&j>=0&&j<((P=e.board[A])==null?void 0:P.length)){const z=e.board[A][j].card;z&&(S=z.ownerId||t)}}else if(e.activePlayerId){const A=e.players.find(j=>j.id===e.activePlayerId);A!=null&&A.isDummy&&(S=A.id)}let w=y==null?void 0:y.closest("[data-hand-card]");if(!w&&y)if(y.getAttribute("data-hand-card"))w=y;else{const A=y.querySelectorAll("[data-hand-card]");if(A.length>0){let j=1/0,z=null;const V=g.clientX,J=g.clientY;for(const fe of Array.from(A)){const he=fe.getBoundingClientRect();if(V>=he.left&&V<=he.right&&J>=he.top&&J<=he.bottom){const Re=he.left+he.width/2,Te=he.top+he.height/2,Ie=Math.hypot(V-Re,J-Te);Ie<j&&(j=Ie,z=fe)}}w=z}}if(w){const A=w.getAttribute("data-hand-card");if(A){const[j,z]=A.split(","),V=parseInt(j,10),J=parseInt(z,10),fe=e.players.find(Re=>Re.id===V),he=fe==null?void 0:fe.hand[J];if(fe&&he){if(i.type==="Revealed"&&!fe.isDummy){if((T=he.statuses)==null?void 0:T.some(ae=>ae.type==="Revealed"&&ae.addedByPlayerId===S))return;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:i.originalOwnerId??((L=i.sourceCard)==null?void 0:L.ownerId)??S??void 0,statusType:i.type,count:1},{target:"hand",playerId:V,cardIndex:J,boardCoords:void 0}),i.sourceCoords&&i.sourceCoords.row>=0&&a(i.sourceCoords,i.isDeployAbility),i.count>1?d(ae=>ae?{...ae,count:ae.count-1}:null):(i.chainedAction&&m(i.chainedAction,i.sourceCoords||{row:-1,col:-1}),d(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}const Te={targetOwnerId:i.targetOwnerId,excludeOwnerId:i.excludeOwnerId,onlyOpponents:i.onlyOpponents||i.targetOwnerId===-1,onlyFaceDown:i.onlyFaceDown,targetType:i.targetType,requiredTargetStatus:i.requiredTargetStatus,tokenType:i.type};if(!gt({card:he,ownerId:V,location:"hand"},Te,S,e.players))return;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:i.originalOwnerId??((E=i.sourceCard)==null?void 0:E.ownerId),statusType:i.type,replaceStatusType:i.replaceStatus?i.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:V,cardIndex:J,boardCoords:void 0}),i.sourceCoords&&i.sourceCoords.row>=0&&a(i.sourceCoords,i.isDeployAbility),i.count>1?d(Ke=>Ke?{...Ke,count:Ke.count-1}:null):(i.chainedAction&&m(i.chainedAction,i.sourceCoords||{row:-1,col:-1}),d(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}}if(!w){const A=y==null?void 0:y.closest("[data-board-coords]");if(A){const j=A.getAttribute("data-board-coords");if(j){const[z,V]=j.split(","),J=parseInt(z,10),fe=parseInt(V,10);if(!isNaN(J)&&!isNaN(fe)&&J>=0&&J<e.board.length&&e.board[J]&&fe>=0&&fe<e.board[J].length&&e.board[J][fe]){const he=e.board[J][fe].card;if((he==null?void 0:he.ownerId)!==void 0){const Re={targetOwnerId:i.targetOwnerId,excludeOwnerId:i.excludeOwnerId,onlyOpponents:i.onlyOpponents||i.targetOwnerId===-1,onlyFaceDown:i.onlyFaceDown,targetType:i.targetType,requiredTargetStatus:i.requiredTargetStatus,mustBeAdjacentToSource:i.mustBeAdjacentToSource,mustBeInLineWithSource:i.mustBeInLineWithSource,sourceCoords:i.sourceCoords,tokenType:i.type};if(!gt({card:he,ownerId:he.ownerId,location:"board",boardCoords:{row:J,col:fe}},Re,S,e.players))return;const Ie=e.players.find(Ke=>Ke.id===he.ownerId);if(i.type==="Revealed"&&!(Ie!=null&&Ie.isDummy)){if((O=he.statuses)==null?void 0:O.some(ae=>ae.type==="Revealed"&&ae.addedByPlayerId===S))return;he.isFaceDown?t!==null&&n({source:"board",ownerId:he.ownerId,boardCoords:{row:J,col:fe}},t):(r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:i.originalOwnerId??((D=i.sourceCard)==null?void 0:D.ownerId)??S??void 0,statusType:i.type,count:1},{target:"board",boardCoords:{row:J,col:fe}}),R("board",{row:J,col:fe})),i.sourceCoords&&i.sourceCoords.row>=0&&a(i.sourceCoords,i.isDeployAbility),i.count>1?d(ae=>ae?{...ae,count:ae.count-1}:null):(i.chainedAction&&m(i.chainedAction,i.sourceCoords||{row:-1,col:-1}),d(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}if(he){const Re=i.placeAllAtOnce?i.count:1;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:i.originalOwnerId??((k=i.sourceCard)==null?void 0:k.ownerId),statusType:i.type,replaceStatusType:i.replaceStatus?i.requiredTargetStatus:void 0,count:Re},{target:"board",boardCoords:{row:J,col:fe}}),R("board",{row:J,col:fe}),i.recordContext&&s(Ie=>({...Ie,lastMovedCardCoords:{row:J,col:fe},lastMovedCardId:he.id})),i.sourceCoords&&i.sourceCoords.row>=0&&a(i.sourceCoords,i.isDeployAbility);const Te=i.count-Re;if(Te>0)d(Ie=>Ie?{...Ie,count:Te}:null);else{if(i.chainedAction){const Ie={...i.chainedAction};i.recordContext&&(Ie.mode==="SELECT_CELL"&&(Ie.sourceCard=he,Ie.sourceCoords={row:J,col:fe},Ie.recordContext=!0),Ie.type==="GLOBAL_AUTO_APPLY"&&(Ie.sourceCoords={row:J,col:fe}),Ie.type==="CREATE_STACK"&&(Ie.sourceCoords={row:J,col:fe},Ie.originalOwnerId||(Ie.sourceCard=he)),Ie.mode==="ZIUS_LINE_SELECT"&&(Ie.sourceCoords={row:J,col:fe})),Ie.type==="CREATE_STACK"&&h(null),m(Ie,{row:J,col:fe})}d(null)}o.current=!0,setTimeout(()=>{o.current=!1},300)}}}}else{const j=y==null?void 0:y.closest(".counter-modal-content"),z=(y==null?void 0:y.closest("[data-board-coords]"))!==null,V=(y==null?void 0:y.closest("[data-hand-card]"))!==null;i.isDragging?j?d(J=>J?{...J,isDragging:!1}:null):!z&&!V&&d(null):!j&&!z&&!V&&d(null)}}};return window.addEventListener("mouseup",_),()=>{window.removeEventListener("mouseup",_)}},[i,r,e,t,n,a,o,s,m,d,h,R]),$.useEffect(()=>{const _=g=>{i&&(g.preventDefault(),d(null))};return window.addEventListener("contextmenu",_),()=>{window.removeEventListener("contextmenu",_)}},[i,d]),{cursorFollowerRef:p,handleCounterMouseDown:(_,g)=>{I.current={x:g.clientX,y:g.clientY},d(y=>(y==null?void 0:y.type)===_?{type:_,count:y.count+1,isDragging:!0,sourceCoords:y.sourceCoords}:{type:_,count:1,isDragging:!0})}}};export{rs as A,ns as B,xo as C,Fo as D,Qt as E,Yo as F,Wo as G,pr as H,gt as I,qt as J,tr as K,$o as L,$n as M,Gn as N,Bo as P,zo as S,we as T,At as a,Je as b,Nn as c,Hn as d,qo as e,Ho as f,xn as g,Yn as h,Ln as i,Jo as j,gr as k,jo as l,Mn as m,Un as n,Uo as o,Ko as p,es as q,Vo as r,Zo as s,kn as t,Qo as u,Xo as v,Dt as w,er as x,ts as y,as as z};
