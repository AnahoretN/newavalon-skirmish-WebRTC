import{r as x,j as Ho}from"./vendor-react-JYPVbgc1-0.2.11.js";import{$ as $t}from"./vendor-webrtc-BBsnVRmn-0.2.11.js";import{e as ur,d as Bt}from"./vendor-BPR6uEV2-0.2.11.js";var Re=(t=>(t.SynchroTech="SynchroTech",t.Hoods="Hoods",t.Optimates="Optimates",t.Fusion="Fusion",t.Command="Command",t.Tokens="Tokens",t.Custom="Custom",t.Neutral="Neutral",t.Random="Random",t))(Re||{}),fr=(t=>(t.FreeForAll="FFA",t.TwoVTwo="2v2",t.ThreeVOne="3v1",t))(fr||{});const c={info:(...t)=>{},warn:(...t)=>{console.warn(...t)},error:(...t)=>{console.error(...t)},debug:(...t)=>{}},Fo={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365235/SYN_IP_DEPT_AGENT_pbvh9e.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_TACTICAL_AGENT_vquxfm.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_PATROL_AGENT_nlyneg.webp",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_RIOT_AGENT_i4lk5m.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_THREAT_ANALYST_uqxbsp.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367440/HERO_Mr._Pearl_Director_of_BioSynch_lsesol.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_RECKLESS_PROVOCATEUR_wvfdcr.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_DATA_LIBERATOR_qeru3j.webp",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_CAUTIOUS_AVENGER_xzk6pd.webp",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_VIGILANT_SPOTTER_xo8ig7.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_INVENTIVE_MAKER_sicb73.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367436/HERO_Finn_c8637x.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_FABER_cr804w.webp",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365250/OPT_CENSOR_w4qijk.webp",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_PRINCEPS_aaqakx.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_IMMUNIS_hvlxhi.webp",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_CENTURION_grztbi.webp",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367435/HERO_Lucius_The_Immortal_irhhaj.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_CODE_KEEPER_yhowqj.webp",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_DEVOUT_SYNTHETIC_nkr1tx.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_UNWAVERING_INTEGRATOR_g1cbag.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_SIGNAL_PROPHET_rmk9me.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_ZEALOUS_MISSIONARY_v7qjhw.webp",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367438/HERO_Reverend_of_The_Choir_njrrih.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365196/CMD_OVERWATCH_djwlqo.webp",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_REPOSITIONING_uhwvrk.webp",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_INSPIRATION_v0bi3l.webp",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_DATA_INTERCEPTION_gen1qw.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_FALSE_ORDERS_aatcmc.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367418/CMD_Experimental_Stimulants_plsnet.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367415/CMD_Logistics_Chain_odmwxq.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367414/CMD_Quick_Response_Team_xff2yt.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367411/CMD_Temporary_Shelter_podjbj.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367413/CMD_Enhanced_Interrogation_legiod.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367446/N_Autonomous_Battle_Robot_Gawain_oni745.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Reclaimed_Gawain_sjmlsp.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Secret_informant_w0w6g5.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367432/HERO_Michael_Falk_sv5i5c.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367434/HERO_Edith_Byron_ny23vb.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367429/HERO_Pinkunoneko_cqhpuy.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367431/HERO_Maria_Eleftheria_Damanaki_cpw12i.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367428/HERO_Zius_xhuyxa.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},Wo={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_RECON_DRONE_w3elir.webp",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_WALKING_TURRET_c0mttm.webp",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},Bo={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365400/Aim_qzeaqn.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365398/Exploit_pf2zwf.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Revealed_lsan64.webp",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand and face-down cards on board.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board-facedown","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365403/Stun_pbe7ex.webp",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Shield_yilhdt.webp",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365402/Support_hxzufw.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771368527/Threat_dqnnsq.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365394/Resurrected_awaucv.webp",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},Yo=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],Vt={cardDatabase:Fo,tokenDatabase:Wo,countersDatabase:Bo,deckFiles:Yo};let Un=null,st=new Map,sr=new Map,Dt={},Ht=[],ir={};const Qn=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function Fi(){try{let t;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const r=await fetch("/api/content/database");if(r.ok){const n=await r.json(),a=n.cards.map(([o,i])=>[o,i]),s=n.tokens.map(([o,i])=>[o,i]);t={cardDatabase:Object.fromEntries(a),tokenDatabase:Object.fromEntries(s),countersDatabase:Object.fromEntries(n.counters),deckFiles:n.deckFiles}}else t=Vt}catch{t=Vt}else t=Vt;Un=t,st=new Map(Object.entries(t.cardDatabase)),sr=new Map(Object.entries(t.tokenDatabase)),Dt=t.countersDatabase,Ht=t.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(Dt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(r){console.warn("Could not save counters database to localStorage:",r)}qe=Un,ea=st,Ko=sr,dt=Dt,qo=Ht,ir=zo(),Vo=ir}catch(t){throw console.error("Failed to load content database:",t),t}}function zo(){const t={};for(const e of Ht){const r=[];for(const n of e.cards){const a=st.get(n.cardId);if(!a){console.warn(`Card definition not found for ID: ${n.cardId} in deck: ${e.name}`);continue}const s=Qn.has(n.cardId);for(let o=0;o<n.quantity;o++){const d=n.cardId.replace(/-/g,"--DASH--").toUpperCase();s?r.push({...a,deck:Re.Command,id:`CMD_${d}_${o+1}`,baseId:n.cardId,faction:a.faction||"Command"}):r.push({...a,deck:e.id,id:`${e.id.substring(0,3).toUpperCase()}_${d}_${o+1}`,baseId:n.cardId,faction:a.faction||e.id})}}if(t[e.id]=r,e.id==="Optimates"){const n=new Set;let a=!1;r.forEach(s=>{n.has(s.id)&&(c.error(`[buildDecksData] DUPLICATE ID in Optimates: ${s.id}`),a=!0),n.add(s.id),s.baseId||s.id}),a&&c.warn("[buildDecksData] Optimates deck has duplicate IDs!")}}return t[Re.Tokens]=Array.from(sr.entries()).map(([e,r])=>{const n=r.types?[...r.types]:[];return{id:`TKN_${r.name.toUpperCase().replace(/\s/g,"_")}`,baseId:e,deck:Re.Tokens,name:r.name,imageUrl:r.imageUrl,fallbackImage:r.fallbackImage,power:r.power,ability:r.ability,color:r.color,types:n,flavorText:r.flavorText,faction:"Tokens"}}),t}let qe=null,ea=new Map,Ko=new Map,dt={};try{const t=localStorage.getItem("counters_database");t&&(Dt=JSON.parse(t),dt=Dt)}catch{}let qo=[],Vo={};const jo=Qn,Wi=()=>Ht.filter(t=>t.isSelectable);function Ke(t){return st.get(t)}function jt(t){return Array.from(st.values()).find(e=>e.name===t)}function Bi(){return Array.from(st.entries()).map(([t,e])=>({id:t,card:e}))}function Yi(){return st}function ta(){return ir}const Jo=4,zi={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/medal_tavarc.webp"},Ki={[Re.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[Re.Hoods]:{prefix:"HOO",color:"border-purple-500"},[Re.Optimates]:{prefix:"OPT",color:"border-red-500"},[Re.Fusion]:{prefix:"FUS",color:"border-green-400"},[Re.Command]:{prefix:"CMD",color:"border-yellow-500"},[Re.Tokens]:{prefix:"TKN",color:"border-gray-400"},[Re.Custom]:{prefix:"CUS",color:"border-purple-400"},[Re.Neutral]:{prefix:"NEU",color:"border-gray-400"},[Re.Random]:{prefix:"RND",color:"border-gray-400"}},qi={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},Xo={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},Vi={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},Et=["blue","purple","red","green","yellow","orange","pink","brown"],ji=["Setup","Main","Commit","Scoring"],Gt=()=>Object.fromEntries(Object.entries(dt).map(([t,e])=>[t,e.imageUrl])),Ji=new Proxy({},{get(t,e){return Gt()[e]},ownKeys(){return Object.keys(Gt())},has(t,e){return e in Gt()},getOwnPropertyDescriptor(t,e){const r=Gt()[e];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),xt=()=>Object.fromEntries(Object.entries(dt).map(([t,e])=>[t,e.description])),Xi=new Proxy({},{get(t,e){return xt()[e]},ownKeys(){return Object.keys(xt())},has(t,e){return e in xt()},getOwnPropertyDescriptor(t,e){const r=xt()[e];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),Zo=()=>Object.entries(dt).filter(([t,e])=>t!=="Resurrected"&&(!e.allowedPanels||e.allowedPanels.includes("COUNTER_PANEL"))).sort(([,t],[,e])=>t.sortOrder-e.sortOrder).map(([t,e])=>({type:t,label:e.name}));Zo();const Xe="readyDeploy",We="readySetup",ze="readyCommit",ke=(t,e,r)=>t.statuses?t.statuses.some(n=>n.type===e&&(r===void 0||n.addedByPlayerId===r)):!1,$e=(t,e)=>t.statuses?t.statuses.some(r=>r.type===e):!1,Qo=(t,e,r)=>r===1&&$e(t,We),es=(t,e,r,n,a)=>!!(r&&$e(t,Xe)||e===1&&n&&$e(t,We)||e===3&&a&&$e(t,ze)),Jt=t=>{t.statuses&&(t.statuses=t.statuses.filter(e=>e.type!==Xe&&e.type!==We&&e.type!==ze))},pt=(t,e,r,n)=>Math.abs(t-r)+Math.abs(e-n)===1,ra=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"riotAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:t,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"codeKeeper",activationType:"deploy",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>{var s;return a.ownerId!==r&&((s=a.statuses)==null?void 0:s.some(o=>o.type==="Threat"))}},sourceCard:t,sourceCoords:n})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId!==r&&ke(a,"Exploit",r)}})},{baseId:"centurion",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(a,s,o)=>{var i;return a.ownerId===r&&((i=a.types)==null?void 0:i.includes("Unit"))&&s!==void 0&&o!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:t,sourceCoords:n,payload:{filter:(a,s,o)=>pt(s,o,n.row,n.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:t,sourceCoords:n,payload:{filter:a=>{if(a.id===t.id)return!1;if(a.ownerId!==r){const s=e.players.find(i=>i.id===a.ownerId),o=e.players.find(i=>i.id===r);if(!(s!=null&&s.teamId)||!(o!=null&&o.teamId)||s.teamId!==o.teamId)return!1}return a.statuses&&a.statuses.length>0}}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:n,maxOrthogonalDistance:2,sourceCard:t})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:t,sourceCoords:n,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,originalOwnerId:r,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:a=>a.ownerId===r}})},{baseId:"censor",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:n,sourceCard:t,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(t,e,r,n)=>ke(t,"Support",r)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:t,sourceCoords:n,payload:{filter:(a,s)=>pt(a,s,n.row,n.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,s,o)=>pt(s,o,n.row,n.col)&&a.ownerId!==r&&(ke(a,"Threat",r)||ke(a,"Stun",r))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>a.ownerId===r&&ke(a,"Support",r)},sourceCard:t,sourceCoords:n})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId===r&&ke(a,"Exploit",r)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:t,sourceCoords:n,payload:{filter:a=>ke(a,"Exploit",r)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"walkingTurret",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"MODIFY_POWER",amount:-1,filter:a=>ke(a,"Aim",r)}})},{baseId:"reconDrone",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,sourceCoords:n,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"REVEAL_ENEMY_CHAINED",filter:(a,s,o)=>{const i=pt(s,o,n.row,n.col),d=a.ownerId!==r;return i&&d},targetOwnerId:void 0},skipChainedActionOnNoTargets:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:1}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,s,o)=>pt(s,o,n.row,n.col)&&a.ownerId!==r&&(ke(a,"Threat",r)||ke(a,"Stun",r))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:t,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"edithByron",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:t,sourceCoords:n,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,s,o)=>pt(s,o,n.row,n.col)&&(ke(a,"Threat",r)||ke(a,"Stun",r)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:t,sourceCoords:n,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:t,sourceCoords:n,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(t,e,r,n)=>({type:"REVEREND_SETUP_SCORE",sourceCard:t,sourceCoords:n,ownerId:r})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"LUCIUS_SETUP",filter:a=>a.ownerId===r}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId===r,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:t,sourceCoords:n})}],pr=t=>{const e=t.baseId||"";return ra.filter(r=>{var n;return r.baseId===e||((n=r.baseIdAlt)==null?void 0:n.includes(e))})},ts=t=>{const r=pr(t).map(n=>n.activationType);return[...new Set(r)]},na=(t,e,r,n)=>{var o;if(r!==t.ownerId)return!1;if(n&&t.ownerId!==void 0){const i=n.players.find(d=>d.id===t.ownerId);if(i!=null&&i.isDummy&&n.activePlayerId!==t.ownerId)return!1}if((o=t.statuses)!=null&&o.some(i=>i.type==="Stun"))return!1;const a=pr(t),s=e===1&&a.some(i=>i.activationType==="setup")||e===3&&a.some(i=>i.activationType==="commit");if(e===1){const i=a.find(d=>d.activationType==="setup");if(i&&$e(t,We))return!(i.supportRequired&&!ke(t,"Support",r))}if(e===3){const i=a.find(d=>d.activationType==="commit");if(i&&$e(t,ze))return!(i.supportRequired&&!ke(t,"Support",r))}if(!s){const i=a.find(d=>d.activationType==="deploy");if(i&&$e(t,Xe))return!(i.supportRequired&&!ke(t,"Support",r))}return!1},rs=(t,e,r,n)=>{if(r!==t.ownerId)if(t.ownerId!==void 0){const d=e.players.find(l=>l.id===t.ownerId);if(!(d!=null&&d.isDummy))return null}else return null;const a=pr(t),s=t.ownerId??r??0,o=e.currentPhase,i=o===1&&a.some(d=>d.activationType==="setup")||o===3&&a.some(d=>d.activationType==="commit");if(o===1){const d=a.find(l=>l.activationType==="setup");if(d&&$e(t,We)){if(d.supportRequired&&!ke(t,"Support",s))return null;const l=d.getAction(t,e,s,n);if(l)return{...l,readyStatusToRemove:We}}}if(o===3){const d=a.find(l=>l.activationType==="commit");if(d&&$e(t,ze)){if(d.supportRequired&&!ke(t,"Support",s))return null;const l=d.getAction(t,e,s,n);if(l)return{...l,readyStatusToRemove:ze}}}if(!i){const d=a.find(l=>l.activationType==="deploy");if(d&&$e(t,Xe)){if(d.supportRequired&&!ke(t,"Support",s))return null;const l=d.getAction(t,e,s,n);if(l)return{...l,isDeployAbility:!0,readyStatusToRemove:Xe}}}return null},ns=(t,e)=>e===1&&$e(t,We)?We:e===3&&$e(t,ze)?ze:$e(t,Xe)?Xe:null,Zi=(t,e)=>{var o;let r,n;typeof e=="object"?(r=e.currentPhase,n=e):r=e;const a=n==null?void 0:n.activePlayerId;return a===void 0||t.ownerId!==a||(o=t.statuses)!=null&&o.some(i=>i.type==="Stun")||!ns(t,r)?!1:na(t,r,t.ownerId,n)},aa=(t,e,r)=>{var i;let n;if(typeof e=="object"?(n=e.currentPhase,r=e.activePlayerId??void 0):n=e,r===void 0||t.ownerId!==r||(i=t.statuses)!=null&&i.some(d=>d.type==="Stun"))return!1;const a=$e(t,Xe),s=$e(t,We),o=$e(t,ze);return es(t,n,a,s,o)},yr=(t,e)=>{t.statuses||(t.statuses=[]);const r=ts(t);for(const n of r){let a="";n==="deploy"?a=Xe:n==="setup"?a=We:n==="commit"&&(a=ze),a&&(t.statuses.some(o=>o.type===a)||t.statuses.push({type:a,addedByPlayerId:e}))}},dr=(t,e)=>{const r=$n("setup"),n=$n("commit");for(let a=0;a<t.board.length;a++)for(let s=0;s<t.board[a].length;s++){const i=t.board[a][s].card;if(!i||i.ownerId!==e)continue;const d=i.baseId||i.id;if(d){if(c.debug(`[resetReadyStatusesForTurn] Processing card: ${i.name} (baseId: ${d}, ownerId: ${i.ownerId})`),i.statuses||(i.statuses=[]),r.includes(d)){const l=i.statuses.some(g=>g.type===We);i.statuses=i.statuses.filter(g=>g.type!==We),i.statuses.push({type:We,addedByPlayerId:e}),l||c.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_SETUP to ${i.name}`)}else i.statuses=i.statuses.filter(l=>l.type!==We);if(n.includes(d)){const l=i.statuses.some(g=>g.type===ze);i.statuses=i.statuses.filter(g=>g.type!==ze),i.statuses.push({type:ze,addedByPlayerId:e}),l||c.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_COMMIT to ${i.name}`)}else i.statuses=i.statuses.filter(l=>l.type!==ze)}}};function $n(t){const e=[];return ra.forEach(r=>{r.activationType===t&&(e.push(r.baseId),r.baseIdAlt&&e.push(...r.baseIdAlt))}),[...new Set(e)]}class as{constructor(){this.queue=[],this.loading=new Set,this.loaded=new Set,this.minDelayBetweenLoads=1e3,this.lastLoadTime=0,this.isProcessing=!1}preload(e,r="low"){!e||this.loaded.has(e)||this.loading.has(e)||this.queue.some(a=>a.url===e)||(this.queue.push({url:e,priority:r,timestamp:Date.now()}),this.queue.sort((a,s)=>{const o={high:0,normal:1,low:2},i=o[a.priority]-o[s.priority];return i!==0?i:a.timestamp-s.timestamp}),this.processQueue())}preloadMany(e,r="low"){e.forEach(n=>this.preload(n,r))}isLoaded(e){return this.loaded.has(e)}clearQueue(){this.queue=[]}clear(){this.queue=[],this.loading.clear(),this.loaded.clear()}processQueue(){if(this.isProcessing||this.queue.length===0)return;this.isProcessing=!0;const e=()=>{if(this.queue.length===0){this.isProcessing=!1;return}const n=Date.now()-this.lastLoadTime,a=Math.max(0,this.minDelayBetweenLoads-n);setTimeout(()=>{const s=this.queue.shift();if(!s){this.isProcessing=!1;return}this.loadImage(s.url).then(()=>{this.lastLoadTime=Date.now(),e()}).catch(()=>{this.lastLoadTime=Date.now(),e()})},a)};e()}loadImage(e){return new Promise((r,n)=>{this.loading.add(e);const a=new Image;a.onload=()=>{this.loading.delete(e),this.loaded.add(e),r()},a.onerror=()=>{this.loading.delete(e),n(new Error(`Failed to load: ${e}`))},a.src=e})}}const os=new as;function ss(t,e){const r=[];for(const n of t)if(n.id!==e){if(n.hand)for(const a of n.hand)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl);if(n.deck)for(const a of n.deck)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl);if(n.discard)for(const a of n.discard)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl)}return r}function he(t){const e=t,r=e==null?void 0:e.targetingMode;r&&delete e.targetingMode;let n;return typeof structuredClone<"u"?n=structuredClone(t):n=JSON.parse(JSON.stringify(t)),r&&(n.targetingMode=r,e.targetingMode=r),n}const ae={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function Qi(t){return{r:Math.min(255,Math.round(t.r*1.3)),g:Math.min(255,Math.round(t.g*1.3)),b:Math.min(255,Math.round(t.b*1.3))}}function ed(t,e){return`rgba(${t.r}, ${t.g}, ${t.b}, ${e})`}function td(t,e){return t?Xo[t]:e}function ve(){return localStorage.getItem("webrtc_enabled")==="true"}const oa=x.createContext(null),rd=({children:t})=>{const[e,r]=x.useState(null),[n,a]=x.useState({}),[s,o]=x.useState("lg"),i=x.useCallback((h,R={},E="lg")=>{r(h),a(R),o(E)},[]),d=x.useCallback(()=>{r(null),a({}),o("lg")},[]),l=x.useCallback(h=>e===h,[e]),g=x.useCallback(()=>n,[n]),T=x.useCallback(()=>s,[s]),C={openModal:e,modalData:n,modalSize:s,open:i,close:d,isOpen:l,getData:g,getSize:T};return Ho.jsx(oa.Provider,{value:C,children:t})},Yt=()=>{const t=x.useContext(oa);if(!t)throw new Error("useModals must be used within ModalsProvider");return t},nd=()=>{const{open:t,close:e,isOpen:r}=Yt();return{isOpen:r("rules"),open:n=>t("rules",n,"full"),close:e}},ad=()=>{const{open:t,close:e,isOpen:r}=Yt();return{isOpen:r("settings"),open:n=>t("settings",n,"md"),close:e}},od=()=>{const{open:t,close:e,isOpen:r,getData:n}=Yt();return{isOpen:r("joinGame"),open:a=>t("joinGame",a,"lg"),close:e,getData:()=>n()}},sd=()=>{const{open:t,close:e,isOpen:r}=Yt();return{isOpen:r("deckBuilder"),open:n=>t("deckBuilder",n,"full"),close:e}},Rt="webrtc_game_state",Pt="webrtc_host_data",kt="webrtc_guest_data",is="webrtc_current_host_peerId",ds=30*60*1e3;function hr(){return Date.now()}function vt(t){return Date.now()-t<ds}function cs(t){try{const e={...t,timestamp:hr()};localStorage.setItem(Pt,JSON.stringify(e)),c.info("[WebRTC Persistence] Saved host data:",{peerId:e.peerId})}catch(e){c.error("[WebRTC Persistence] Failed to save host data:",e)}}function Xt(t){try{const e={...t,timestamp:hr()};localStorage.setItem(kt,JSON.stringify(e)),c.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:e.hostPeerId,playerId:e.playerId})}catch(e){c.error("[WebRTC Persistence] Failed to save guest data:",e)}}function bt(t){try{const e={...t,timestamp:hr()};localStorage.setItem(Rt,JSON.stringify(e)),c.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(e.timestamp).toISOString())}catch(e){c.error("[WebRTC Persistence] Failed to save game state:",e)}}function sa(){try{const t=localStorage.getItem(Pt);if(!t)return null;const e=JSON.parse(t);return vt(e.timestamp)?(c.info("[WebRTC Persistence] Loaded valid host data:",{peerId:e.peerId}),e):(c.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(Pt),null)}catch(t){return c.error("[WebRTC Persistence] Failed to load host data:",t),localStorage.removeItem(Pt),null}}function ia(){try{const t=localStorage.getItem(kt);if(!t)return null;const e=JSON.parse(t);return vt(e.timestamp)?(c.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:e.hostPeerId,playerId:e.playerId}),e):(c.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(kt),null)}catch(t){return c.error("[WebRTC Persistence] Failed to load guest data:",t),localStorage.removeItem(kt),null}}function Hn(){try{const t=localStorage.getItem(Rt);if(!t)return null;const e=JSON.parse(t);return vt(e.timestamp)?(c.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(e.timestamp).toISOString()),e):(c.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(Rt),null)}catch(t){return c.error("[WebRTC Persistence] Failed to load game state:",t),localStorage.removeItem(Rt),null}}function nt(){localStorage.removeItem(Rt),localStorage.removeItem(Pt),localStorage.removeItem(kt),localStorage.removeItem(is)}function cr(t,e){try{const r=`webrtc_host_${e}`,n={peerId:t,gameId:e,timestamp:Date.now()};localStorage.setItem(r,JSON.stringify(n)),c.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${e}:`,t)}catch(r){c.error("[WebRTC Persistence] Failed to broadcast host peerId:",r)}}function Zt(t){try{const e=`webrtc_host_${t}`,r=localStorage.getItem(e);if(!r)return null;const n=JSON.parse(r);return Date.now()-n.timestamp>15e3?null:{peerId:n.peerId,timestamp:n.timestamp}}catch(e){return c.error("[WebRTC Persistence] Failed to get host peerId:",e),null}}function Fn(t){try{const e=`webrtc_host_${t}`;localStorage.removeItem(e),c.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${t}`)}catch(e){c.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",e)}}function ls(){const t=sessionStorage.getItem("invite_host_id"),e=sessionStorage.getItem("invite_auto_join");if(t&&e)return"none";const r=sa();if(r&&vt(r.timestamp))return"host";const n=ia();return n&&vt(n.timestamp)?"guest":"none"}const Wn=7,Qt="mrPearlDoF",us="reverendOfTheChoir",fs="threatAnalyst";function ps(t,e){return t!=null&&t.statuses?t.statuses.some(r=>r.type==="Exploit"&&r.addedByPlayerId!==void 0&&e.has(r.addedByPlayerId)):!1}function ys(t){return typeof structuredClone<"u"?structuredClone(t):JSON.parse(JSON.stringify(t))}const da=()=>Array(Wn).fill(null).map(()=>Array(Wn).fill(null).map(()=>({card:null}))),xe=t=>{var E,f,m,A,w;const{board:e,activeGridSize:r,players:n}=t,a=ys(e),s=a.length,o=Math.floor((s-r)/2),i=new Map;n.forEach(I=>i.set(I.id,I.teamId));for(let I=0;I<s;I++)for(let u=0;u<s;u++){const p=a[I][u].card;p&&(p.statuses&&(p.statuses=p.statuses.filter(_=>_.type!=="Support"&&_.type!=="Threat")),delete p.bonusPower)}for(let I=0;I<s;I++)for(let u=0;u<s;u++){const p=a[I][u].card;if((p==null?void 0:p.ownerId)===void 0||p.isFaceDown)continue;const _=p.ownerId,D=i.get(_),O=[{r:I-1,c:u},{r:I+1,c:u},{r:I,c:u-1},{r:I,c:u+1}],P={};let b=!1;for(const U of O){const{r:F,c:N}=U;if(F>=0&&F<s&&N>=0&&N<s){const G=a[F][N].card,$=(E=G==null?void 0:G.statuses)==null?void 0:E.some(q=>q.type==="Stun");if((G==null?void 0:G.ownerId)!==void 0&&!G.isFaceDown&&!$){const q=G.ownerId,Z=i.get(q);_===q||D!==void 0&&D===Z?b=!0:(P[q]||(P[q]=[]),P[q].push({r:F,c:N}))}}}b&&(p.statuses||(p.statuses=[]),p.statuses.some(U=>U.type==="Support")||p.statuses.push({type:"Support",addedByPlayerId:_}));let L=null;for(const U in P){const F=P[U];if(F&&F.length>=2){L=parseInt(U,10);break}}if(L===null&&I>=o&&I<o+r&&u>=o&&u<o+r){const F=I===o||I===o+r-1||u===o||u===o+r-1,N=Object.keys(P).length>0;if(F&&N){const G=Object.keys(P)[0];G&&(L=parseInt(G,10))}}L!==null&&(p.statuses||(p.statuses=[]),p.statuses.some(U=>U.type==="Threat")||p.statuses.push({type:"Threat",addedByPlayerId:L}))}const d=new Set;for(let I=0;I<s;I++)for(let u=0;u<s;u++){const p=a[I][u].card,_=(f=p==null?void 0:p.statuses)==null?void 0:f.some(D=>D.type==="Stun");if((p==null?void 0:p.baseId)===fs&&!p.isFaceDown&&p.ownerId!==void 0&&!_){const D=[{r:I-1,c:u},{r:I+1,c:u},{r:I,c:u-1},{r:I,c:u+1}];let O=!1;const P=p.ownerId,b=i.get(P);for(const L of D){const{r:U,c:F}=L;if(U>=0&&U<s&&F>=0&&F<s){const N=a[U][F].card;if((N==null?void 0:N.ownerId)!==void 0&&!N.isFaceDown){const G=N.ownerId,$=i.get(G),q=P===G||b!==void 0&&b===$,Z=(m=N==null?void 0:N.statuses)==null?void 0:m.some(X=>X.type==="Stun");if(q&&!Z){O=!0;break}}}}O&&d.add(P)}}for(let I=0;I<s;I++)for(let u=0;u<s;u++){const p=a[I][u].card;if(!p||p.isFaceDown||p.ownerId===void 0)continue;const _=p.ownerId,D=i.get(_),O=[{r:I-1,c:u},{r:I+1,c:u},{r:I,c:u-1},{r:I,c:u+1}],P={};for(const L of O){const{r:U,c:F}=L;if(U>=0&&U<s&&F>=0&&F<s){const N=a[U][F].card,G=(A=N==null?void 0:N.statuses)==null?void 0:A.some($=>$.type==="Stun");if((N==null?void 0:N.ownerId)!==void 0&&!N.isFaceDown&&!G){const $=N.ownerId,q=i.get($);if(!(_===$||D!==void 0&&D===q)){const X=d.has($),se=ps(p,d);X&&se&&(P[$]||(P[$]=0),P[$]++)}}}}if(Object.keys(P).length>0){p.statuses||(p.statuses=[]);const L=Object.keys(P).map(U=>parseInt(U,10));for(const U of L)p.statuses.some(F=>F.type==="Threat"&&F.addedByPlayerId===U)||p.statuses.push({type:"Threat",addedByPlayerId:U})}}const l=[],g=[];for(let I=0;I<s;I++)for(let u=0;u<s;u++){const p=a[I][u].card,_=(w=p==null?void 0:p.statuses)==null?void 0:w.some(D=>D.type==="Stun");p!=null&&p.baseId&&!p.isFaceDown&&p.ownerId!==void 0&&!_&&(p.baseId===us?l.push({r:I,c:u,ownerId:p.ownerId,baseId:p.baseId}):p.baseId===Qt&&g.push({r:I,c:u,ownerId:p.ownerId,baseId:p.baseId}))}const T=new Set,C=new Set;for(const I of l){const{r:u,c:p,ownerId:_}=I,D=`${u}-${_}`;if(!T.has(D)){T.add(D);for(let P=0;P<s;P++){const b=a[u][P].card;b&&b.ownerId===_&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(L=>L.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:_}))}}const O=`${p}-${_}`;if(!C.has(O)){C.add(O);for(let P=0;P<s;P++){const b=a[P][p].card;b&&b.ownerId===_&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(L=>L.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:_}))}}}const h=new Set,R=new Set;for(const I of g){const{r:u,c:p,ownerId:_}=I,D=`${u}-${_}`;if(!h.has(D)){h.add(D);for(let P=0;P<s;P++){const b=a[u][P].card;b&&b.ownerId===_&&!b.isFaceDown&&b.baseId!==Qt&&(b.bonusPower=(b.bonusPower||0)+1)}}const O=`${p}-${_}`;if(!R.has(O)){R.add(O);for(let P=0;P<s;P++){const b=a[P][p].card;b&&b.ownerId===_&&!b.isFaceDown&&b.baseId!==Qt&&(b.bonusPower=(b.bonusPower||0)+1)}}}return a};var ct=(t=>(t[t.CARD_REGISTRY=1]="CARD_REGISTRY",t[t.CARD_STATE=2]="CARD_STATE",t[t.ABILITY_EFFECT=3]="ABILITY_EFFECT",t[t.SESSION_EVENT=4]="SESSION_EVENT",t))(ct||{}),St=(t=>(t[t.HIGHLIGHT_CELL=1]="HIGHLIGHT_CELL",t[t.FLOATING_TEXT=2]="FLOATING_TEXT",t[t.NO_TARGET=3]="NO_TARGET",t[t.STATUS_ADDED=4]="STATUS_ADDED",t[t.STATUS_REMOVED=5]="STATUS_REMOVED",t[t.POWER_CHANGED=6]="POWER_CHANGED",t[t.CARD_DESTROYED=7]="CARD_DESTROYED",t[t.TARGETING_MODE=8]="TARGETING_MODE",t[t.CLEAR_TARGETING=9]="CLEAR_TARGETING",t))(St||{});function hs(){const t={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},e=new Set,r=Array.from(ea.values());for(const n of r)if(n.baseId&&!e.has(n.baseId)){e.add(n.baseId);const a=t.cardDefinitions.length;t.baseIdToIndex.set(n.baseId,a),t.indexToBaseId.set(a,n.baseId),t.cardDefinitions.push({baseId:n.baseId,name:n.name,imageUrl:n.imageUrl,power:n.power,ability:n.ability||"",types:n.types||[],faction:n.faction||""})}return t.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],c.info(`[CardRegistry] Built registry with ${t.cardDefinitions.length} cards, ${t.statusTypes.length} status types`),t}function ca(t,e){let r=0;for(const n of t||[]){const a=e.statusTypes.indexOf(n.type);a>=0&&a<32&&(r|=1<<a)}return r>>>0}function la(t,e,r){const n=[];for(let a=0;a<32;a++)if(t&1<<a){const s=r.statusTypes[a];s&&n.push({type:s,addedByPlayerId:e})}return n}function ua(t){let e=0;return t.isFaceDown&&(e|=1),t.enteredThisTurn&&(e|=2),t.revealedTo==="all"&&(e|=4),e}function er(t,e){const r=new Uint8Array(13);let n=0;const a=mr(t.id);r[n++]=a>>24&255,r[n++]=a>>16&255,r[n++]=a>>8&255,r[n++]=a&255;const s=t.baseId?e.baseIdToIndex.get(t.baseId)??0:0;r[n++]=s>>8&255,r[n++]=s&255,r[n++]=(t.ownerId??0)&255;const o=Math.round(t.power||0);r[n++]=Math.clamp(o,-128,127)&255,r[n++]=ua(t);const i=ca(t.statuses||[],e);return r[n++]=i>>24&255,r[n++]=i>>16&255,r[n++]=i>>8&255,r[n++]=i&255,r}function ms(t,e,r){const n=new Uint8Array(10);let a=0;const s=mr(t.id);n[a++]=s>>24&255,n[a++]=s>>16&255,n[a++]=s>>8&255,n[a++]=s&255,n[a++]=(t.ownerId??r)&255,n[a++]=ua(t);const o=ca(t.statuses||[],e);return n[a++]=o>>24&255,n[a++]=o>>16&255,n[a++]=o>>8&255,n[a++]=o&255,n}function mr(t){let e=0;for(let r=0;r<t.length;r++){const n=t.charCodeAt(r);e=(e<<5)-e+n,e=e&e}return e>>>0}function Is(t,e,r){var E;const n=[],a=Date.now(),s=new Uint8Array(7);s[0]=ct.CARD_STATE,s[1]=a>>24&255,s[2]=a>>16&255,s[3]=a>>8&255,s[4]=a&255,n.push(s);const o=[],i=Math.min(t.players.length,255);o.push(new Uint8Array([i]));for(const f of t.players){o.push(new Uint8Array([f.id&255]));const m=Et.indexOf(f.color);o.push(new Uint8Array([m>=0?m:0]));const A=Math.min(f.deck.length,255),w=Math.min(f.hand.length,255),I=Math.min(f.discard.length,255);o.push(new Uint8Array([A,w,I,f.announcedCard?1:0])),o.push(new Uint8Array([Math.min(f.score,255)]));const u=Math.min(f.hand.length,255);o.push(new Uint8Array([u]));const p=f.id===r;for(const D of f.hand)p?o.push(er(D,e)):o.push(ms(D,e,f.id));const _=Math.min(f.discard.length,255);o.push(new Uint8Array([_]));for(const D of f.discard){const O=mr(D.id),P=new Uint8Array(4);P[0]=O>>24&255,P[1]=O>>16&255,P[2]=O>>8&255,P[3]=O&255,o.push(P)}f.announcedCard&&o.push(er(f.announcedCard,e))}const d=t.board.length;o.push(new Uint8Array([d,d,d]));const l=[];for(let f=0;f<t.board.length;f++)for(let m=0;m<((E=t.board[f])==null?void 0:E.length);m++){const A=t.board[f][m];A!=null&&A.card&&l.push({row:f,col:m,card:A.card})}const g=l.length,T=new Uint8Array(2);T[0]=g>>8&255,T[1]=g&255,o.push(T);for(const{row:f,col:m,card:A}of l)o.push(new Uint8Array([f,m])),o.push(er(A,e));o.push(new Uint8Array([t.currentPhase===void 0?255:Math.clamp(t.currentPhase,0,254),(t.activePlayerId??255)&255,t.currentRound===void 0?255:Math.clamp(t.currentRound,0,254)]));let C=0;for(const f of o)C+=f.length;s[5]=C>>8&255,s[6]=C&255,n.push(...o);const h=new Uint8Array(n.reduce((f,m)=>f+m.length,0));let R=0;for(const f of n)h.set(f,R),R+=f.length;return c.info(`[GameCodec] Encoded card state: ${h.length} bytes (${g} board cards, ${t.players.length} players)`),h}function Es(t,e,r){let n=0;if(t[n++]!==ct.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++],t[n++]<<8|t[n++];const a=t[n++],s=[];for(let E=0;E<a;E++){const f=t[n++],m=t[n++],A=Et[m]||"blue",w=t[n++];t[n++],t[n++];const I=t[n++]===1,u=t[n++],p=t[n++],_=[],D=f===r;for(let U=0;U<p;U++)if(D)_.push(tr(t,n,e)),n+=13;else{const F=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++],N=t[n++],G=t[n++],$=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++];_.push({id:`card_${F}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:N,isFaceDown:(G&1)!==0,revealedTo:G&4?"all":void 0,statuses:la($,f,e),isPlaceholder:!0})}const O=t[n++],P=[];for(let U=0;U<O;U++){const F=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++];P.push({id:`discard_${F}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:f,isPlaceholder:!0})}let b=null;I&&(b=tr(t,n,e),n+=13);const L=[];for(let U=0;U<w;U++)L.push({id:`deck_${f}_${U}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:f,isPlaceholder:!0});s.push({id:f,name:`Player ${f}`,score:u,hand:_,deck:L,discard:P,announcedCard:b,selectedDeck:"Random",color:A,boardHistory:[]})}const o=t[n++];n++,n++;const i=t[n++]<<8|t[n++],d=[];for(let E=0;E<o;E++){const f=[];for(let m=0;m<o;m++)f.push({card:null});d.push(f)}for(let E=0;E<i;E++){const f=t[n++],m=t[n++],A=tr(t,n,e);n+=13,f<d.length&&m<d[f].length&&(d[f][m]={card:A})}const l=t[n++],g=t[n++],T=t[n++];return{players:s,board:d,currentPhase:l===255?void 0:l,activePlayerId:g===255?null:g,currentRound:T===255?void 0:T}}function tr(t,e,r){const a=`card_${t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++]}_${Date.now()}`,s=t[e++]<<8|t[e++],o=t[e++];let i=t[e++];i>127&&(i=i-256);const d=t[e++],l=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++],g=r.cardDefinitions[s],T=(g==null?void 0:g.baseId)||"";return{id:a,baseId:T,deck:"Random",name:(g==null?void 0:g.name)||"?",imageUrl:(g==null?void 0:g.imageUrl)||"",power:i,ability:(g==null?void 0:g.ability)||"",types:(g==null?void 0:g.types)||[],faction:(g==null?void 0:g.faction)||"",ownerId:o,isFaceDown:(d&1)!==0,enteredThisTurn:(d&2)!==0,revealedTo:d&4?"all":void 0,statuses:la(l,0,r)}}Math.clamp||(Math.clamp=function(t,e,r){return Math.min(Math.max(t,e),r)});let rr=null;function fa(){return rr||(rr=hs()),rr}function Bn(t,e){const r=fa();return Is(t,r,e)}function Ts(t,e){const r=fa();return Es(t,r,e)}function gs(t){return Bt(t)}function pa(t){c.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return ur(t)}catch(e){return c.error("[webrtcSerialization] Failed to serialize delta:",e),new Uint8Array(0)}}function ya(t){c.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Bt(t)}catch(e){return c.error("[webrtcSerialization] Failed to deserialize delta:",e),{}}}function ws(t){const e=pa(t);let r="";const n=new Uint8Array(e),a=n.byteLength;for(let s=0;s<a;s++)r+=String.fromCharCode(n[s]);return btoa(r)}function _s(t){const e=atob(t),r=new Uint8Array(e.length);for(let n=0;n<e.length;n++)r[n]=e.charCodeAt(n);return ya(r)}function bs(t){var e,r,n,a,s;return t?{playerId:t.playerId,mode:((e=t.action)==null?void 0:e.mode)||t.mode,sourceCoords:t.sourceCoords,timestamp:t.timestamp,boardTargets:t.boardTargets,handTargets:t.handTargets,isDeckSelectable:t.isDeckSelectable,originalOwnerId:t.originalOwnerId,sourceCardName:(n=(r=t.action)==null?void 0:r.sourceCard)==null?void 0:n.name,sourceCardId:(s=(a=t.action)==null?void 0:a.sourceCard)==null?void 0:s.id}:null}function As(t){try{const e={...t};e.targetingMode&&(e.targetingMode=bs(e.targetingMode));const r=ur(e),n=String.fromCharCode(...r);return btoa(n)}catch(e){throw c.error("[serializePersonalizedState] Failed to encode:",e),e}}function Yn(t){try{const e=atob(t),r=new Uint8Array(e.length);for(let a=0;a<e.length;a++)r[a]=e.charCodeAt(a);const n=Bt(r);return c.info("[deserializePersonalizedizedState] Decoded state, has players:",!!n.players,"keys:",Object.keys(n)),n}catch(e){throw c.error("[deserializePersonalizedState] Failed to decode:",e),e}}function zn(t){try{const e=t.map(a=>a.baseId||a.id),r=ur(e),n=String.fromCharCode(...r);return btoa(n)}catch(e){throw c.error("[serializeDeckCards] Failed to encode:",e),e}}function Kn(t,e){try{const r=atob(t),n=new Uint8Array(r.length);for(let o=0;o<r.length;o++)n[o]=r.charCodeAt(o);const a=Bt(n),{getCardDefinition:s}=require("../content");return a.map((o,i)=>{const d=s(o);return d?{id:`${e}_deck_${i}_${Date.now()}`,baseId:o,name:d.name,imageUrl:d.imageUrl,power:d.power||0,ability:d.ability||"",types:d.types||[],faction:d.faction||"",color:d.color||"Red",ownerId:e,isFaceDown:!0,statuses:[]}:{id:`${e}_deck_${i}_${Date.now()}`,baseId:o,name:"Unknown",imageUrl:"",power:0,ownerId:e,isFaceDown:!0,statuses:[]}})}catch(r){throw c.error("[deserializeDeckCards] Failed to decode:",r),r}}function Ss(t,e){var T;const r=new TextEncoder,n=[],a=Date.now(),s=new Uint8Array(7);s[0]=ct.ABILITY_EFFECT,s[1]=a>>24&255,s[2]=a>>16&255,s[3]=a>>8&255,s[4]=a&255,n.push(s);const o=[];if(o.push(new Uint8Array([t])),e.sourcePos){const C=(e.sourcePos.row&15)<<4|e.sourcePos.col&15;o.push(new Uint8Array([C]))}else o.push(new Uint8Array([255]));const i=((T=e.targetPositions)==null?void 0:T.length)||0;if(o.push(new Uint8Array([Math.min(i,255)])),e.targetPositions)for(const C of e.targetPositions.slice(0,255)){const h=(C.row&15)<<4|C.col&15;o.push(new Uint8Array([h]))}if(e.text){const C=r.encode(e.text),h=Math.min(C.length,255);o.push(new Uint8Array([h])),o.push(C.slice(0,h))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(e.value??0)&255])),o.push(new Uint8Array([(e.playerId??0)&255]));let d=0;for(const C of o)d+=C.length;s[5]=d>>8&255,s[6]=d&255,n.push(...o);const l=new Uint8Array(n.reduce((C,h)=>C+h.length,0));let g=0;for(const C of n)l.set(C,g),g+=C.length;return c.debug(`[AbilityMessages] Encoded effect type ${t}: ${l.length} bytes`),l}function Cs(t){let e=0;if(t[e++]!==ct.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const r=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];e+=2;const n={effectType:t[e++],timestamp:r,data:{}},a=t[e++];a!==255&&(n.data.sourcePos={row:a>>4&15,col:a&15});const s=t[e++];if(s>0){n.data.targetPositions=[];for(let i=0;i<s;i++){const d=t[e++];n.data.targetPositions.push({row:d>>4&15,col:d&15})}}const o=t[e++];if(o>0){const i=new TextDecoder;n.data.text=i.decode(t.subarray(e,e+o)),e+=o}return n.data.value=t[e++],n.data.playerId=t[e++],n}function Ds(t,e={}){const r=new TextEncoder,n=[],a=Date.now(),s=new Uint8Array(7);s[0]=ct.SESSION_EVENT,s[1]=a>>24&255,s[2]=a>>16&255,s[3]=a>>8&255,s[4]=a&255,n.push(s);const o=[];if(o.push(new Uint8Array([t])),o.push(new Uint8Array([(e.playerId??0)&255])),e.playerName){const T=r.encode(e.playerName),C=Math.min(T.length,255);o.push(new Uint8Array([C])),o.push(T.slice(0,C))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(e.startingPlayerId??0)&255])),o.push(new Uint8Array([Math.min(e.roundNumber??0,255)])),o.push(new Uint8Array([Math.min(e.newPhase??0,255)])),o.push(new Uint8Array([(e.newActivePlayerId??0)&255])),o.push(new Uint8Array([(e.gameWinner??255)&255]));let i=0;if(e.winners)for(const T of e.winners)T<32&&(i|=1<<T);o.push(new Uint8Array([i>>24&255,i>>16&255,i>>8&255,i&255]));let d=0;for(const T of o)d+=T.length;s[5]=d>>8&255,s[6]=d&255,n.push(...o);const l=new Uint8Array(n.reduce((T,C)=>T+C.length,0));let g=0;for(const T of n)l.set(T,g),g+=T.length;return c.debug(`[SessionMessages] Encoded event type ${t}: ${l.length} bytes`),l}function Rs(t){let e=0;if(t[e++]!==ct.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const r=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];e+=2;const n={eventType:t[e++],timestamp:r,data:{}};n.data.playerId=t[e++];const a=t[e++];if(a>0){const i=new TextDecoder;n.data.playerName=i.decode(t.subarray(e,e+a)),e+=a}n.data.startingPlayerId=t[e++],n.data.roundNumber=t[e++],n.data.newPhase=t[e++],n.data.newActivePlayerId=t[e++];const s=t[e++];n.data.gameWinner=s===255?null:s;const o=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];if(o!==0){n.data.winners=[];for(let i=0;i<32;i++)o&1<<i&&n.data.winners.push(i)}return n}function It(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier||0,isFaceDown:t.isFaceDown,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck,ability:t.ability,color:t.color,types:t.types,faction:t.faction,imageUrl:t.imageUrl}}function qn(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck}}function Ye(t){return{id:t.id,baseId:t.baseId||t.id,power:t.power,powerModifier:t.powerModifier||0,isFaceDown:t.isFaceDown??!1,statuses:t.statuses||[]}}function Ps(t,e){const r={...t,players:t.players.map(n=>{const a=e!==null&&n.id===e,s=n.isDummy===!0;if(a){const o=n.deck.length??0,i=n.discard.length??0,d=n.hand.length??0;return c.debug(`[createPersonalizedGameState] Player ${n.id} (own): ${d} hand, ${o} deck, ${i} discard`),{...n,handCards:n.hand.map(l=>Ye(l)),deckCards:n.deck.map(l=>Ye(l)),discardCards:n.discard.map(l=>Ye(l)),hand:[],deck:[],discard:[],announcedCard:n.announcedCard?It(n.announcedCard):null,deckSize:o,discardSize:i,handSize:d}}else if(s){const o=n.deck.length??0,i=n.discard.length??0,d=n.hand.length??0;return c.info(`[createPersonalizedGameState] Player ${n.id} (dummy): sending ${d} hand, ${o} deck, ${i} discard`),{...n,handCards:n.hand.map(l=>Ye(l)),deckCards:n.deck.map(l=>Ye(l)),discardCards:n.discard.map(l=>Ye(l)),hand:[],deck:[],discard:[],announcedCard:n.announcedCard?It(n.announcedCard):null,deckSize:o,discardSize:i,handSize:d}}else{const o=n.deckSize??n.deck.length??0,i=n.hand.filter(d=>!d.isFaceDown).length;return i>0&&c.debug(`[createPersonalizedGameState] Player ${n.id} (other): ${i} revealed, ${n.hand.length-i} face-down`),{...n,hand:n.hand.map(d=>d.isFaceDown?qn(d):{id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier||0,isFaceDown:d.isFaceDown,statuses:d.statuses||[],ownerId:d.ownerId,ownerName:d.ownerName,deck:d.deck}),deck:[],discard:[],announcedCard:n.announcedCard?qn(n.announcedCard):null,deckSize:o,handSize:n.handSize??n.hand.length??0,discardSize:n.discardSize??n.discard.length??0}}}),board:t.board.map(n=>n.map(a=>({...a,card:a.card?It(a.card):null})))};return c.debug(`[createPersonalizedGameState] Created personalized state for recipient=${e}, currentPhase=${r.currentPhase}, activePlayerId=${r.activePlayerId}`),r}function ks(t,e){return{...t,players:t.players.map(r=>{if(r.id===e)return c.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(n=>Ye(n)),deckCards:r.deck.map(n=>Ye(n)),discardCards:r.discard.map(n=>Ye(n)),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?It(r.announcedCard):null,deckSize:r.deck.length,discardSize:r.discard.length,handSize:r.hand.length};{const a=r.hand.filter(i=>i.statuses&&i.statuses.length>0).length>0,s=r.isDummy===!0,o={...r,...a&&{handCards:r.hand.map(i=>Ye(i))},hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0};return s&&(c.info(`[createCompactStateForHost] Dummy player ${r.id}: sending ${r.hand.length} hand, ${r.deck.length} deck, ${r.discard.length} discard`),o.handCards=r.hand.map(i=>Ye(i)),o.deckCards=r.deck.map(i=>Ye(i)),o.discardCards=r.discard.map(i=>Ye(i))),r.id===e?c.info(`[createCompactStateForHost] Local player ${r.id} score: ${r.score}`):c.info(`[createCompactStateForHost] Other player ${r.id} (${s?"dummy":"real"}) score: ${o.score} (from original)`),o}}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?It(n.card):null})))}}class Os{constructor(e={}){this.peer=null,this.connections=new Map,this.guests=new Map,this.eventHandlers=new Set,this.reconnectingPlayers=new Map,this.reconnectionTimeout=3e4,this.config={maxGuests:e.maxGuests??4,autoAcceptGuests:e.autoAcceptGuests??!0,enableReconnection:e.enableReconnection??!1},localStorage.getItem("webrtc_enabled")}async initialize(){return this.peer&&this.cleanup(),new Promise((e,r)=>{this.peer=new $t,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),e(n)}),this.peer.on("connection",n=>{c.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{c.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{c.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}handleGuestConnection(e){const r=e.peer;if(this.config.maxGuests&&this.connections.size>=this.config.maxGuests){c.warn(`Max guests limit reached: ${this.connections.size}/${this.config.maxGuests}`),e.close();return}const n={peerId:r,playerId:null,playerName:null,connected:!1,connectedAt:Date.now()};this.connections.set(r,e),this.guests.set(r,n),e.on("open",()=>{n.connected=!0,this.emitEvent({type:"guest_connected",data:{peerId:r}})}),e.on("data",a=>{this.handleMessage(a,r)}),e.on("close",()=>{const a=this.guests.get(r),s=a==null?void 0:a.playerId;this.connections.delete(r),this.guests.delete(r),s!=null&&this.config.enableReconnection&&this.markPlayerReconnecting(s,r),this.emitEvent({type:"guest_disconnected",data:{peerId:r,playerId:s}})}),e.on("error",a=>{c.error(`Guest connection error (${r}):`,a)})}handleMessage(e,r){var s,o,i;const n=this.guests.get(r),a=(n==null?void 0:n.playerId)??e.playerId??"unknown";e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE"?c.info(`[HostConnectionManager] Received ${e.type} from peer ${r} (player ${a})`,{hasData:!!e.data,hasTargetingMode:!!((s=e.data)!=null&&s.targetingMode),targetingModePlayerId:(i=(o=e.data)==null?void 0:o.targetingMode)==null?void 0:i.playerId,timestamp:e.timestamp}):c.debug(`Received WebRTC message from ${r}:`,e.type),this.emitEvent({type:"message_received",data:{message:e,fromPeerId:r}})}sendToGuest(e,r){const n=this.connections.get(e);if(!n)return c.error(`[sendToGuest] No connection found for ${e}`),!1;if(!n.open)return c.error(`[sendToGuest] Connection for ${e} is not open`),!1;try{return c.info(`[sendToGuest] Sending ${r.type} to ${e}`),n.send(r),c.info(`[sendToGuest] Sent ${r.type} to ${e} successfully`),!0}catch(a){return c.error(`[sendToGuest] Failed to send message to ${e}:`,a),!1}}broadcast(e,r){let n=0;return this.connections.forEach((a,s)=>{if(a.open&&s!==r)try{a.send(e),n++}catch(o){c.error(`Failed to send to guest ${s}:`,o)}}),c.debug(`Broadcast to ${n}/${this.connections.size} guests`),n}acceptGuestMinimal(e,r,n){var i;const a=this.connections.get(e);if(!a)return c.error(`[acceptGuestMinimal] No connection found for ${e}`),!1;if(!a.open)return c.error(`[acceptGuestMinimal] Connection for ${e} is not open`),!1;const s=this.guests.get(e);s&&(s.playerId=n);const o={type:"JOIN_ACCEPT_MINIMAL",senderId:(i=this.peer)==null?void 0:i.id,playerId:n,data:r,timestamp:Date.now()};try{return a.send(o),c.info(`Accepted guest ${e} as player ${n} (minimal)`),!0}catch(d){return c.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${e}:`,d),!1}}acceptGuest(e,r,n){var o;const a=this.connections.get(e);if(!a)return c.error(`[acceptGuest] No connection found for ${e}`),!1;if(!a.open)return c.error(`[acceptGuest] Connection for ${e} is not open`),!1;const s=this.guests.get(e);s&&(s.playerId=n);try{const i=Bn(r,n),d=btoa(String.fromCharCode(...i)),l={type:"JOIN_ACCEPT_BINARY",senderId:(o=this.peer)==null?void 0:o.id,playerId:n,data:d,timestamp:Date.now()};return a.send(l),c.info(`[acceptGuest] Sent JOIN_ACCEPT_BINARY to ${e}, state size: ${d.length} chars`),!0}catch(i){return c.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${e}:`,i),!1}}broadcastGameState(e,r){if(this.connections.size===0)return;const n=e.players.map(s=>`P${s.id}:${s.score}`).join(", ");c.info(`[broadcastGameState] Broadcasting state with scores: ${n}, currentPhase=${e.currentPhase}, activePlayerId=${e.activePlayerId}`);let a=0;this.connections.forEach((s,o)=>{var d;if(!s.open||r&&o===r)return;const i=this.guests.get(o);if(i)try{const l=Ps(e,i.playerId),g=As(l),T={type:"STATE_UPDATE_COMPACT",senderId:(d=this.peer)==null?void 0:d.id,data:{gameState:g,_format:"msgpack"},timestamp:Date.now()};s.send(T),a++}catch(l){c.error(`[broadcastGameState] Failed to send to guest ${o} (player ${i.playerId}):`,l)}}),c.debug(`[broadcastGameState] Sent to ${a}/${this.connections.size} guests`)}broadcastStateDelta(e,r){var n,a;{const s=ws(e),o={type:"STATE_DELTA_BINARY",senderId:(n=this.peer)==null?void 0:n.id,data:s,timestamp:Date.now()};c.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${s.length} chars, playerDeltas=${Object.keys(e.playerDeltas||{}).length}, boardCells=${((a=e.boardCells)==null?void 0:a.length)||0}`),this.broadcast(o,r),c.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${e.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(e,r,n){var a;try{const s=Bn(e,r),o=btoa(String.fromCharCode(...s)),i={type:"CARD_STATE",senderId:(a=this.peer)==null?void 0:a.id,data:o,timestamp:Date.now()},d=this.broadcast(i,n);return c.info(`[broadcastCardState] Sent ${s.length} bytes to ${d} guests`),d}catch(s){return c.error("[broadcastCardState] Failed to encode/broadcast state:",s),0}}broadcastAbilityEffect(e,r,n){var a;try{const s=Ss(e,r),o=btoa(String.fromCharCode(...s)),i={type:"ABILITY_EFFECT",senderId:(a=this.peer)==null?void 0:a.id,data:o,timestamp:Date.now()},d=this.broadcast(i,n);return c.debug(`[broadcastAbilityEffect] Sent effect ${e} to ${d} guests`),d}catch(s){return c.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",s),0}}broadcastSessionEvent(e,r,n){var a;try{const s=Ds(e,r),o=btoa(String.fromCharCode(...s)),i={type:"SESSION_EVENT",senderId:(a=this.peer)==null?void 0:a.id,data:o,timestamp:Date.now()},d=this.broadcast(i,n);return c.debug(`[broadcastSessionEvent] Sent event ${e} to ${d} guests`),d}catch(s){return c.error("[broadcastSessionEvent] Failed to encode/broadcast event:",s),0}}broadcastHighlight(e,r,n,a){return this.broadcastAbilityEffect(St.HIGHLIGHT_CELL,{sourcePos:{row:e,col:r},playerId:n},a)}broadcastFloatingText(e,r,n,a){return this.broadcastAbilityEffect(St.FLOATING_TEXT,{sourcePos:{row:e,col:r},text:n},a)}broadcastTargetingMode(e,r,n){return this.broadcastAbilityEffect(St.TARGETING_MODE,{sourcePos:e,targetPositions:r},n)}broadcastClearTargeting(e){return this.broadcastAbilityEffect(St.CLEAR_TARGETING,{},e)}broadcastPlayerConnected(e,r,n){return this.broadcastSessionEvent(1,{playerId:e,playerName:r},n)}broadcastPlayerDisconnected(e,r){return this.broadcastSessionEvent(2,{playerId:e},r)}broadcastGameStart(e,r){return this.broadcastSessionEvent(3,{startingPlayerId:e},r)}broadcastRoundStart(e,r){return this.broadcastSessionEvent(4,{roundNumber:e},r)}broadcastRoundEnd(e,r,n){return this.broadcastSessionEvent(5,{roundNumber:e,winners:r},n)}broadcastPhaseChange(e,r,n){return this.broadcastSessionEvent(6,{newPhase:e,newActivePlayerId:r},n)}broadcastTurnChange(e,r){return this.broadcastSessionEvent(7,{newActivePlayerId:e},r)}broadcastGameEnd(e,r){return this.broadcastSessionEvent(8,{gameWinner:e},r)}sendAction(e,r){var a;const n={type:"ACTION",senderId:(a=this.peer)==null?void 0:a.id,data:{actionType:e,actionData:r},timestamp:Date.now()};return this.broadcast(n)>0}getConnectionInfo(){const e=[];return this.connections.forEach((r,n)=>{const a=this.guests.get(n);e.push({peerId:n,playerId:(a==null?void 0:a.playerId)||null,playerName:(a==null?void 0:a.playerName)||null,connected:r.open})}),e}getGuest(e){return this.guests.get(e)}getGuestByPlayerId(e){return Array.from(this.guests.values()).find(r=>r.playerId===e)}setGuestPlayerId(e,r){const n=this.guests.get(e);n&&(n.playerId=r)}getPeerId(){var e;return((e=this.peer)==null?void 0:e.id)||null}getGuestCount(){return this.connections.size}hasGuests(){return Array.from(this.connections.values()).some(e=>e.open)}markPlayerReconnecting(e,r){this.reconnectingPlayers.set(e,{disconnectedAt:Date.now(),oldPeerId:r}),setTimeout(()=>{const n=this.reconnectingPlayers.get(e);n&&Date.now()-n.disconnectedAt>=this.reconnectionTimeout&&this.reconnectingPlayers.delete(e)},this.reconnectionTimeout),c.info(`[Reconnection] Player ${e} marked as reconnecting, window: ${this.reconnectionTimeout}ms`)}isPlayerReconnecting(e){const r=this.reconnectingPlayers.get(e);return r?Date.now()-r.disconnectedAt>=this.reconnectionTimeout?(this.reconnectingPlayers.delete(e),!1):!0:!1}getPlayerReconnectTimeRemaining(e){const r=this.reconnectingPlayers.get(e);if(!r)return 0;const n=Date.now()-r.disconnectedAt;return Math.max(0,this.reconnectionTimeout-n)}acceptPlayerReconnect(e,r,n){var o;if(!this.isPlayerReconnecting(r))return c.warn(`[Reconnection] Player ${r} not in reconnection window or expired`),!1;const a=this.connections.get(e);if(!a||!a.open)return c.error(`[Reconnection] No valid connection for ${e}`),!1;this.reconnectingPlayers.delete(r);const s={type:"RECONNECT_ACCEPT",senderId:(o=this.peer)==null?void 0:o.id,playerId:r,data:{gameState:n},timestamp:Date.now()};try{a.send(s),c.info(`[Reconnection] Player ${r} reconnected from ${e}`);const i=this.guests.get(e);return i&&(i.playerId=r),!0}catch(i){return c.error("[Reconnection] Failed to send RECONNECT_ACCEPT:",i),!1}}rejectPlayerReconnect(e,r){var s;const n=this.connections.get(e);if(!n||!n.open)return;const a={type:"RECONNECT_REJECT",senderId:(s=this.peer)==null?void 0:s.id,data:{reason:r},timestamp:Date.now()};try{n.send(a),n.close(),c.info(`[Reconnection] Rejected reconnection from ${e}, reason: ${r}`)}catch(o){c.error("[Reconnection] Failed to send RECONNECT_REJECT:",o)}}getReconnectingPlayers(){const e=Date.now(),r=[];return this.reconnectingPlayers.forEach((n,a)=>{e-n.disconnectedAt<this.reconnectionTimeout?r.push(a):this.reconnectingPlayers.delete(a)}),r}cancelPlayerReconnection(e){this.reconnectingPlayers.delete(e)}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>{try{r(e)}catch(n){c.error("Error in WebRTC event handler:",n)}})}cleanup(){if(this.connections.forEach(e=>e.close()),this.connections.clear(),this.guests.clear(),this.reconnectingPlayers.clear(),this.peer){try{this.peer.destroy()}catch{}this.peer=null}}}class vs{constructor(){this.peer=null,this.connections=new Map,this.eventHandlers=new Set,localStorage.getItem("webrtc_enabled")}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>r(e))}getPeerId(){var e;return((e=this.peer)==null?void 0:e.id)??null}getConnection(e){return this.connections.get(e)}getAllConnections(){return this.connections}isInitialized(){return this.peer!==null}async initializeAsHost(e){return this.peer&&this.cleanup(),new Promise((r,n)=>{this.peer=e?new $t(e):new $t,this.peer.on("open",a=>{this.emitEvent({type:"peer_open",data:{peerId:a}}),r(a)}),this.peer.on("connection",a=>{c.info(`Incoming connection from: ${a.peer}`),this.handleConnection(a)}),this.peer.on("error",a=>{c.error("WebrtcPeer error:",a),this.emitEvent({type:"error",data:a}),n(a)}),this.peer.on("close",()=>{c.warn("WebrtcPeer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(){return this.peer&&this.cleanup(),new Promise((e,r)=>{this.peer=new $t,this.peer.on("open",n=>{e(n)}),this.peer.on("error",n=>{c.error("WebrtcPeer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{c.warn("WebrtcPeer closed"),this.emitEvent({type:"peer_closed"})})})}connectTo(e){if(!this.peer)return c.error("Cannot connect: peer not initialized"),null;const r=this.peer.connect(e,{reliable:!0,serialization:"json"});return this.handleConnection(r),r}handleConnection(e){this.connections.set(e.peer,e),e.on("open",()=>{c.info(`Connection opened: ${e.peer}`),this.emitEvent({type:"connection_open",data:{peerId:e.peer}})}),e.on("data",r=>{this.emitEvent({type:"connection_data",data:{peerId:e.peer,data:r}})}),e.on("close",()=>{c.info(`Connection closed: ${e.peer}`),this.connections.delete(e.peer),this.emitEvent({type:"connection_closed",data:{peerId:e.peer}})}),e.on("error",r=>{c.error(`Connection error (${e.peer}):`,r),this.emitEvent({type:"error",data:{peerId:e.peer,error:r}})})}sendTo(e,r){const n=this.connections.get(e);if(!n)return c.error(`[sendTo] No connection found for peer ${e}`),!1;if(!n.open)return c.error(`[sendTo] Connection for peer ${e} is not open`),!1;try{return n.send(r),!0}catch(a){return c.error(`[sendTo] Failed to send to ${e}:`,a),!1}}broadcast(e,r){let n=0;return this.connections.forEach((a,s)=>{if(a.open&&s!==r)try{a.send(e),n++}catch(o){c.error(`[broadcast] Failed to send to ${s}:`,o)}}),n}closeConnection(e){const r=this.connections.get(e);r&&(r.close(),this.connections.delete(e))}cleanup(){if(this.connections.forEach(e=>{try{e.close()}catch{}}),this.connections.clear(),this.peer){try{this.peer.destroy()}catch{}this.peer=null}}getPeer(){return this.peer}}class Vn{constructor(e={}){this.hostPeerId=null,this.eventHandlers=new Set,this.config=e,this.webrtcPeer=new vs,this.webrtcPeer.on(r=>this.handlePeerEvent(r)),localStorage.getItem("webrtc_enabled")}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>r(e))}handlePeerEvent(e){var r,n,a,s,o,i;switch(e.type){case"peer_open":this.hostPeerId&&this.webrtcPeer.connectTo(this.hostPeerId);break;case"connection_open":c.info(`Connected to host: ${e.data.peerId}`),this.emitEvent({type:"connected_to_host",data:{hostPeerId:e.data.peerId}}),(n=(r=this.config).onHostConnected)==null||n.call(r);break;case"connection_closed":c.warn("Host connection closed"),this.emitEvent({type:"host_disconnected"}),(s=(a=this.config).onHostDisconnected)==null||s.call(a);break;case"connection_data":this.handleMessage(e.data.data);break;case"error":c.error("WebRTC error:",e.data),this.emitEvent({type:"error",data:e.data}),(i=(o=this.config).onError)==null||i.call(o,e.data);break}}handleMessage(e){var r,n;e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE"||e.type==="JOIN_ACCEPT_MINIMAL"||e.type==="JOIN_ACCEPT"?c.info(`[GuestConnection] Received ${e.type} from host`,{senderId:e.senderId,playerId:e.playerId,hasData:!!e.data,timestamp:e.timestamp}):c.info(`[GuestConnection] Received ${e.type} from host`),this.emitEvent({type:"message_received",data:e}),(n=(r=this.config).onMessage)==null||n.call(r,e)}async connect(e){if(this.hostPeerId=e,await this.webrtcPeer.initializeAsGuest(),this.webrtcPeer.isInitialized()){const r=this.webrtcPeer.connectTo(e);if(!r)throw new Error("Failed to create connection to host");return new Promise((n,a)=>{const s=setTimeout(()=>{a(new Error("Connection timeout"))},1e4),o=()=>{clearTimeout(s);let d=null;try{const l=localStorage.getItem("webrtc_preferred_deck");l&&(d=l,c.info(`[connect] Found deck preference in localStorage: ${d}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(l){c.warn("[connect] Failed to read deck preference:",l)}this.sendMessage({type:"JOIN_REQUEST",senderId:this.getPeerId()??void 0,data:{preferredDeck:d||void 0},timestamp:Date.now()}),n()},i=d=>{clearTimeout(s),a(d)};r.once("open",o),r.once("error",i)})}}async connectAsReconnecting(e,r){this.hostPeerId=e,await this.webrtcPeer.initializeAsGuest();const n=this.webrtcPeer.connectTo(e);if(!n)throw new Error("Failed to create connection to host");return new Promise((a,s)=>{const o=setTimeout(()=>{s(new Error("Reconnection timeout"))},1e4),i=()=>{clearTimeout(o),this.sendMessage({type:"PLAYER_RECONNECT",senderId:this.getPeerId()??void 0,playerId:r,timestamp:Date.now()}),a()},d=l=>{clearTimeout(o),s(l)};n.once("open",i),n.once("error",d)})}sendMessage(e){var n,a,s;if(!this.hostPeerId)return c.warn("[GuestConnection] Not connected to host"),!1;const r=this.webrtcPeer.sendTo(this.hostPeerId,e);return(e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE")&&(r?c.info(`[GuestConnection] Sent ${e.type} to host`,{hasData:!!e.data,hasTargetingMode:!!((n=e.data)!=null&&n.targetingMode),targetingModePlayerId:(s=(a=e.data)==null?void 0:a.targetingMode)==null?void 0:s.playerId,timestamp:e.timestamp}):c.warn(`[GuestConnection] Could not send ${e.type} to host`)),r}sendAction(e,r){const n={type:"ACTION",senderId:this.getPeerId()??void 0,data:{actionType:e,actionData:r},timestamp:Date.now()};return this.sendMessage(n)}sendStateDelta(e){{const r=pa(e),n={type:"STATE_DELTA_BINARY",senderId:this.getPeerId()??void 0,data:r,timestamp:Date.now()};return this.sendMessage(n)}}sendStateToHost(e,r){var o,i;if(r===null)return c.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const n=ks(e,r),a=e.players.find(d=>d.id===r);a&&c.info(`[sendStateToHost] Player ${r} sending compact state: hand=${((o=a.hand)==null?void 0:o.length)??0}, deck=${((i=a.deck)==null?void 0:i.length)??0}, score=${a.score}`);const s={type:"STATE_UPDATE_COMPACT",senderId:this.getPeerId()??void 0,playerId:r,data:{gameState:n},timestamp:Date.now()};return this.sendMessage(s)}sendFullDeckToHost(e,r,n){const a={type:"DECK_DATA_UPDATE",senderId:this.getPeerId()??void 0,playerId:e,data:{playerId:e,deck:r.map(s=>It(s)),deckSize:n},timestamp:Date.now()};return this.sendMessage(a)}sendCustomDeckData(e,r,n){if(!n)return!0;c.info(`[sendCustomDeckData] Player ${e} sending ${r.length} custom deck cards to host`);const a=r.map(o=>({id:o.id,baseId:o.baseId,name:o.name,power:o.power,powerModifier:o.powerModifier,ability:o.ability,types:o.types,faction:o.faction,imageUrl:o.imageUrl,color:o.color,deck:o.deck})),s={type:"CUSTOM_DECK_DATA",senderId:this.getPeerId()??void 0,playerId:e,data:{playerId:e,deckCards:a},timestamp:Date.now()};return this.sendMessage(s)}getPeerId(){return this.webrtcPeer.getPeerId()}getHostPeerId(){return this.hostPeerId}isConnected(){if(!this.hostPeerId)return!1;const e=this.webrtcPeer.getConnection(this.hostPeerId);return(e==null?void 0:e.open)??!1}getConnectionCount(){return this.isConnected()?1:0}getConnectionInfo(){if(!this.hostPeerId)return[];const e=this.webrtcPeer.getConnection(this.hostPeerId);return[{peerId:this.hostPeerId,playerId:null,playerName:null,connected:(e==null?void 0:e.open)??!1}]}cleanup(){this.webrtcPeer.cleanup(),this.hostPeerId=null}}class Ns{constructor(){this.mode=null,this.hostManager=null,this.guestManager=null,this.eventHandlers=new Set,this.isReconnecting=!1}async initializeAsHost(e){return this.mode==="guest"&&this.cleanup(),this.mode="host",this.hostManager=new Os({enableReconnection:!0}),this.hostManager.on(r=>this.emitEvent(r)),this.hostManager.initialize()}async initializeAsGuest(e){this.mode==="host"&&this.cleanup(),this.mode="guest",this.guestManager=new Vn({onMessage:r=>this.emitEvent({type:"message_received",data:r}),onHostConnected:()=>this.emitEvent({type:"connected_to_host"}),onHostDisconnected:()=>this.emitEvent({type:"host_disconnected"}),onError:r=>this.emitEvent({type:"error",data:r})}),await this.guestManager.connect(e)}async initializeAsReconnectingGuest(e,r){this.mode==="host"&&this.cleanup(),this.mode="guest",this.isReconnecting=!0,this.guestManager=new Vn({onMessage:n=>this.emitEvent({type:"message_received",data:n}),onHostConnected:()=>{this.isReconnecting=!1,this.emitEvent({type:"connected_to_host"})},onHostDisconnected:()=>this.emitEvent({type:"host_disconnected"}),onError:n=>{this.isReconnecting=!1,this.emitEvent({type:"error",data:n})}}),await this.guestManager.connectAsReconnecting(e,r),this.isReconnecting=!1}acceptGuest(e,r,n){if(!this.hostManager){c.warn("[WebrtcManager] Not in host mode");return}this.hostManager.acceptGuest(e,r,n)}acceptGuestMinimal(e,r,n){if(!this.hostManager){c.warn("[WebrtcManager] Not in host mode");return}this.hostManager.acceptGuestMinimal(e,r,n)}broadcastGameState(e,r){if(!this.hostManager){c.warn("[WebrtcManager] Not in host mode");return}this.hostManager.broadcastGameState(e,r)}broadcastStateDelta(e,r){if(!this.hostManager){c.warn("[WebrtcManager] Not in host mode");return}this.hostManager.broadcastStateDelta(e,r)}broadcastToGuests(e,r){return this.hostManager?this.hostManager.broadcast(e,r):(c.warn("[WebrtcManager] Not in host mode"),0)}sendToGuest(e,r){return this.hostManager?this.hostManager.sendToGuest(e,r):(c.warn("[WebrtcManager] Not in host mode"),!1)}sendAction(e,r){return this.guestManager?this.guestManager.sendAction(e,r):(c.warn("[WebrtcManager] Not in guest mode"),!1)}sendStateDelta(e){return this.guestManager?this.guestManager.sendStateDelta(e):(c.warn("[WebrtcManager] Not in guest mode"),!1)}sendStateToHost(e,r){return this.guestManager?this.guestManager.sendStateToHost(e,r):(c.warn("[WebrtcManager] Not in guest mode"),!1)}sendFullDeckToHost(e,r,n){return this.guestManager?this.guestManager.sendFullDeckToHost(e,r,n):(c.warn("[WebrtcManager] Not in guest mode"),!1)}sendCustomDeckData(e,r,n){return this.guestManager?this.guestManager.sendCustomDeckData(e,r,n):(c.warn("[WebrtcManager] Not in guest mode"),!1)}sendMessageToHost(e){return this.mode!=="guest"||!this.guestManager?!1:this.guestManager.sendMessage(e)}broadcastCardState(e,r,n){return this.hostManager?this.hostManager.broadcastCardState(e,r,n):(c.warn("[WebrtcManager] Not in host mode"),0)}broadcastAbilityEffect(e,r,n){return this.hostManager?this.hostManager.broadcastAbilityEffect(e,r,n):(c.warn("[WebrtcManager] Not in host mode"),0)}broadcastSessionEvent(e,r,n){return this.hostManager?this.hostManager.broadcastSessionEvent(e,r,n):(c.warn("[WebrtcManager] Not in host mode"),0)}getPeerId(){return this.mode==="host"&&this.hostManager?this.hostManager.getPeerId():this.mode==="guest"&&this.guestManager?this.guestManager.getPeerId():null}getHostPeerId(){return this.mode==="guest"&&this.guestManager?this.guestManager.getHostPeerId():this.mode==="host"&&this.hostManager?this.hostManager.getPeerId():null}getConnectionInfo(){return this.mode==="host"&&this.hostManager?this.hostManager.getConnectionInfo():this.mode==="guest"&&this.guestManager?this.guestManager.getConnectionInfo():[]}isConnected(){return this.mode==="host"&&this.hostManager?this.hostManager.hasGuests():this.mode==="guest"&&this.guestManager?this.guestManager.isConnected():!1}isHostMode(){return this.mode==="host"}getConnectionCount(){return this.mode==="host"&&this.hostManager?this.hostManager.getGuestCount():this.mode==="guest"&&this.guestManager?this.guestManager.getConnectionCount():0}getGuest(e){if(this.hostManager)return this.hostManager.getGuest(e)}getGuestByPlayerId(e){if(this.hostManager)return this.hostManager.getGuestByPlayerId(e)}setGuestPlayerId(e,r){this.hostManager&&this.hostManager.setGuestPlayerId(e,r)}isPlayerReconnecting(e){return this.hostManager?this.hostManager.isPlayerReconnecting(e):!1}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>{try{r(e)}catch(n){c.error("Error in WebRTC event handler:",n)}})}cleanup(){this.hostManager&&(this.hostManager.cleanup(),this.hostManager=null),this.guestManager&&(this.guestManager.cleanup(),this.guestManager=null),this.mode=null,this.isReconnecting=!1}get peer(){return this.mode==="host"&&this.hostManager||this.mode==="guest"&&this.guestManager,null}}let nr=null;const lr=()=>(nr||(nr=new Ns),nr);function Ms(t){return 10+t*10}function Ir(t){if(!t.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const e=t.currentPhase===1,r=t.activePlayerId===t.startingPlayerId;if(!e||!r)return{shouldEnd:!1,roundWinners:[]};const n=t.currentRound||1,a=Ms(n),s=[];for(const i of t.players)!i.isDummy&&!i.isDisconnected&&i.score>=a&&s.push(i.id);return{shouldEnd:s.length>0,roundWinners:s}}function ha(t){const{shouldEnd:e,roundWinners:r}=Ir(t);if(!e)return t;const n=t.currentRound||1,a={...t.roundWinners,[n]:r},s=new Map;for(const[,i]of Object.entries(a))for(const d of i){const l=s.get(d)||0;s.set(d,l+1)}let o=null;for(const[i,d]of s.entries())if(d>=2){o=i;break}return c.info(`[endRound] Round ${n} ended. Winners: [${r.join(", ")}], Game winner: ${o||"none"}`),{...t,roundWinners:a,gameWinner:o,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function Er(t,e){if(t.currentPhase!==0)return c.warn(`[performPreparationPhase] Not in Preparation phase (current: ${t.currentPhase})`),t;const r=t.players.find(s=>s.id===e);if(!r)return c.error(`[performPreparationPhase] Active player ${e} not found!`),t;c.info(`[performPreparationPhase] Player ${e} has deck size: ${r.deck.length}, hand size: ${r.hand.length}`);const n=t.players.map(s=>{if(s.id===e&&s.deck.length>0){const o=s.deck[0],i=[...s.deck.slice(1)],d=[...s.hand,o];return c.info(`[performPreparationPhase] Player ${e} drew card ${(o==null?void 0:o.id)||"unknown"}, deck now: ${i.length}, hand: ${d.length}`),{...s,deck:i,hand:d,readySetup:!1,readyCommit:!1}}return s}),a={...t,players:n,currentPhase:1};return dr(a,e),Ir(a).shouldEnd?ha(a):(c.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${a.activePlayerId}`),a)}function ma(t,e){const r=t.activePlayerId;if(r===e){const i={...t,activePlayerId:null};return e===t.startingPlayerId&&t.currentPhase===1&&Ir(i).shouldEnd?ha(i):i}if(!t.players.filter(i=>!i.isDisconnected).find(i=>i.id===e))return c.warn(`[toggleActivePlayer] Player ${e} not found or disconnected`),t;let s=t.turnNumber||1;e===t.startingPlayerId&&r!==null&&s++;const o={...t,activePlayerId:e,turnNumber:s,currentPhase:0};return Er(o,e)}function Ls(t,e){const r=t.players.filter(s=>!s.isDisconnected).sort((s,o)=>s.id-o.id);if(r.length===0)return null;if(e===null)return r[0].id;const n=r.findIndex(s=>s.id===e);if(n===-1)return r[0].id;const a=(n+1)%r.length;return r[a].id}function Gs(t,e){var r;for(const n of t.board)for(const a of n)if(((r=a.card)==null?void 0:r.ownerId)===e)return!0;return!1}function mt(t){const e=Ls(t,t.activePlayerId);if(e===null)return c.warn("[passTurnToNextPlayer] No next player found"),t;c.info(`[passTurnToNextPlayer] Passing turn from ${t.activePlayerId} to ${e}`);let r={...t,board:t.board.map(n=>n.map(a=>{var s;return((s=a.card)==null?void 0:s.ownerId)===t.activePlayerId&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(o=>o.type!=="Stun")}}:a}))};return r={...r,board:r.board.map(n=>n.map(a=>a.card&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(s=>s.type!=="enteredThisTurn")}}:a))},r={...r,activePlayerId:e,currentPhase:0,isScoringStep:!1,targetingMode:null},Er(r,e)}function ar(t,e,r){return c.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),t}function xs(t,e){const{serializePersonalizedState:r}=require("./webrtcSerialization"),{createPersonalizedGameState:n}=require("../host/StatePersonalization"),a=n(t,e??null);return{type:"RECONNECT_SNAPSHOT",data:r(a),_format:"msgpack"}}function Us(t,e,r){var n,a,s,o;try{const i=Ts(t,r);c.info(`[WebRTCCodec] Received card state: ${(n=i.board)==null?void 0:n.length}x${((s=(a=i.board)==null?void 0:a[0])==null?void 0:s.length)||0}, ${((o=i.players)==null?void 0:o.length)||0} players`);const d={...e};return i.players&&(d.players=i.players.map(l=>{const g=e.players.find(T=>T.id===l.id);if(g){const T=l.id===r;return{...g,...l,hand:T?g.hand:l.hand,color:g.color}}return l})),i.board&&(d.board=i.board),i.currentPhase!==void 0&&(d.currentPhase=i.currentPhase),i.activePlayerId!==void 0&&(d.activePlayerId=i.activePlayerId),i.currentRound!==void 0&&(d.currentRound=i.currentRound),d}catch(i){return c.error("[WebRTCCodec] Failed to deserialize card state:",i),e}}function $s(t,e){try{const{effectType:r,timestamp:n,data:a}=Cs(t);c.debug(`[WebRTCCodec] Received ability effect: ${r}`);const s=e;switch(r){case 1:return{gameState:s,effectData:{type:"highlight",...a,timestamp:n}};case 2:return{gameState:s,effectData:{type:"floatingText",...a,timestamp:n}};case 3:return{gameState:s,effectData:{type:"noTarget",...a}};case 8:return{gameState:s,effectData:{type:"targetingMode",...a}};case 9:return{gameState:s,effectData:{type:"clearTargeting"}};default:return c.warn(`[WebRTCCodec] Unknown ability effect type: ${r}`),{gameState:s,effectData:null}}}catch(r){return c.error("[WebRTCCodec] Failed to handle ability effect:",r),{gameState:e,effectData:null}}}function Hs(t,e){var r;try{const{eventType:n,data:a}=Rs(t);c.info(`[WebRTCCodec] Received session event: ${n}`);const s={...e};switch(n){case 1:c.info(`[WebRTCCodec] Player connected: ${a.playerName} (ID: ${a.playerId})`);break;case 2:c.info(`[WebRTCCodec] Player disconnected: ID: ${a.playerId}`),s.players=s.players.map(o=>o.id===a.playerId?{...o,isDisconnected:!0}:o);break;case 3:c.info(`[WebRTCCodec] Game starting, first player: ${a.startingPlayerId}`),s.isGameStarted=!0,a.startingPlayerId!==void 0&&(s.activePlayerId=a.startingPlayerId,s.startingPlayerId=a.startingPlayerId);break;case 4:c.info(`[WebRTCCodec] Round ${a.roundNumber} starting`),s.currentRound=a.roundNumber??1;break;case 5:if(c.info(`[WebRTCCodec] Round ${a.roundNumber} ended, winners: ${(r=a.winners)==null?void 0:r.join(", ")}`),s.isRoundEndModalOpen=!0,a.winners&&a.roundNumber!==void 0){const o=s.roundWinners||{};o[a.roundNumber]=a.winners,s.roundWinners=o}break;case 6:c.info(`[WebRTCCodec] Phase change: ${a.newPhase}`),a.newPhase!==void 0&&(s.currentPhase=a.newPhase),a.newActivePlayerId!==void 0&&(s.activePlayerId=a.newActivePlayerId);break;case 7:c.info(`[WebRTCCodec] Turn change: player ${a.newActivePlayerId}`),a.newActivePlayerId!==void 0&&(s.activePlayerId=a.newActivePlayerId);break;case 8:c.info(`[WebRTCCodec] Game ended, winner: ${a.gameWinner}`),a.gameWinner!==void 0&&(s.gameWinner=a.gameWinner===255?null:a.gameWinner);break;default:c.warn(`[WebRTCCodec] Unknown session event type: ${n}`)}return s}catch(n){return c.error("[WebRTCCodec] Failed to handle session event:",n),e}}function yt(t,e,r,n){return t===2?{gameState:Us(e,r,n)}:t===3?$s(e,r):t===4?{gameState:Hs(e,r)}:(c.warn(`[WebRTCCodec] Unknown codec message type: ${t}`),{gameState:r})}const Ft="avalon_game_state",ot="reconnection_data";function Ia(t,e){var n;t.forEach(a=>a.forEach(s=>{var o;(o=s.card)!=null&&o.statuses&&(s.card.statuses=s.card.statuses.filter(i=>!(i.type==="LastPlayed"&&i.addedByPlayerId===e.id)))})),e.boardHistory||(e.boardHistory=[]);let r=!1;for(;e.boardHistory.length>0&&!r;){const a=e.boardHistory[e.boardHistory.length-1];for(let s=0;s<t.length;s++){for(let o=0;o<t[s].length;o++)if(((n=t[s][o].card)==null?void 0:n.id)===a){const i=t[s][o].card;if(!i||i.ownerId!==e.id)continue;i.statuses||(i.statuses=[]),i.statuses.push({type:"LastPlayed",addedByPlayerId:e.id}),r=!0;break}if(r)break}r||e.boardHistory.pop()}}function At(t){var n;if(!t||!qe)return t;const{cardDatabase:e,tokenDatabase:r}=qe;if(t.deck===Re.Tokens||(n=t.id)!=null&&n.startsWith("TKN_")){if(t.baseId&&r[t.baseId]){const s=r[t.baseId];return{...t,imageUrl:s.imageUrl,fallbackImage:s.fallbackImage}}const a=Object.keys(r).find(s=>r[s].name===t.name);if(a){const s=r[a];return{...t,imageUrl:s.imageUrl,fallbackImage:s.fallbackImage,baseId:a}}}else if(t.baseId&&e[t.baseId]){const a=e[t.baseId];return{...t,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage}}return t}function Nt(t){var n,a;if(!qe)return t;const e=((n=t.board)==null?void 0:n.map(s=>s.map(o=>({...o,card:o.card?At(o.card):null}))))||t.board,r=((a=t.players)==null?void 0:a.map(s=>{var o,i,d;return{...s,hand:((o=s.hand)==null?void 0:o.map(At))||[],deck:((i=s.deck)==null?void 0:i.map(At))||[],discard:((d=s.discard)==null?void 0:d.map(At))||[],announcedCard:s.announcedCard?At(s.announcedCard):null}}))||t.players;return{...t,board:e,players:r,floatingTexts:t.floatingTexts||[],highlights:t.highlights||[]}}function jn(t,e,r){try{const n=Nt(t),a={gameState:n,localPlayerId:e,playerToken:r,timestamp:Date.now()};localStorage.setItem(Ft,JSON.stringify(a)),n.gameId&&e!==null&&localStorage.setItem(ot,JSON.stringify({gameId:n.gameId,playerId:e,playerToken:r||null,timestamp:Date.now()}))}catch(n){console.warn("Failed to save game state:",n)}}function Fs(){try{const t=localStorage.getItem(Ft);if(!t)return null;const e=JSON.parse(t),r=24*60*60*1e3;if(Date.now()-e.timestamp>r)return localStorage.removeItem(Ft),localStorage.removeItem(ot),null;const n=e.gameState;return{gameState:Nt(n),localPlayerId:e.localPlayerId,playerToken:e.playerToken}}catch(t){return console.warn("Failed to load game state:",t),null}}function ht(){localStorage.removeItem(Ft),localStorage.removeItem(ot)}function Tr(t){const e=[...t];for(let r=e.length-1;r>0;r--){const n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function Ea(){return Math.random().toString(36).substring(2,18).toUpperCase()}function et(t,e,r){const n=ta();let a=t;if(t==="Random"||!n[t]){const i=Object.keys(n);if(i.length===0)return c.error("[createDeck] No decks loaded yet!"),[];a=i[0],t==="Random"||c.warn(`[createDeck] Deck ${t} not found, using ${a} instead`)}const s=n[a];if(!s)return c.error(`Deck data for ${a} not loaded! Returning empty deck. Available decks:`,Object.keys(n)),[];if(a==="Optimates"){const i={};s.forEach(d=>{const l=d.baseId||d.id;i[l]=(i[l]||0)+1})}const o=[...s].map(i=>({...i,ownerId:e,ownerName:r}));return Tr(o)}function Ta(t,e=!1){const r=ta(),n=Object.keys(r);if(n.length===0)return c.error("[createNewPlayer] No decks loaded yet!"),{id:t,name:e?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:Et[t-1]||"blue",isDummy:e,isReady:e,boardHistory:[],autoDrawEnabled:!0};const a=n[0],s={id:t,name:e?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:a,color:Et[t-1]||"blue",isDummy:e,isReady:e,boardHistory:[],autoDrawEnabled:!0};return s.deck=et(a,t,s.name),s}function at(){return{players:[],spectators:[],board:da(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:fr.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}const Jn=-1,Ws=-2,Ct=1,Ut=2,it=(t,e,r,n)=>{var i,d,l,g,T;const{card:a,ownerId:s,location:o}=t;if(e.targetOwnerId!==void 0&&e.targetOwnerId!==Jn&&e.targetOwnerId!==Ws&&e.targetOwnerId!==s||e.excludeOwnerId!==void 0&&e.excludeOwnerId===s)return!1;if(e.onlyOpponents||e.targetOwnerId===Jn){if(s===r)return!1;const C=n.find(R=>R.id===r),h=n.find(R=>R.id===s);if(C&&h&&C.teamId!==void 0&&C.teamId===h.teamId)return!1}if(e.targetType&&!((i=a.types)!=null&&i.includes(e.targetType))||e.onlyFaceDown&&((d=a.statuses)!=null&&d.some(C=>C.type==="Revealed"&&C.addedByPlayerId===r)||o==="board"&&!a.isFaceDown)||e.tokenType==="Revealed"&&(l=a.statuses)!=null&&l.some(C=>C.type==="Revealed"&&C.addedByPlayerId===r)||e.requiredTargetStatus&&(!((g=a.statuses)!=null&&g.some(C=>C.type===e.requiredTargetStatus))||e.requireStatusFromSourceOwner&&r!==null&&!((T=a.statuses)==null?void 0:T.some(h=>h.type===e.requiredTargetStatus&&h.addedByPlayerId===r))))return!1;if(e.mustBeAdjacentToSource&&e.sourceCoords&&t.boardCoords){const{row:C,col:h}=e.sourceCoords,{row:R,col:E}=t.boardCoords;if(Math.abs(C-R)+Math.abs(h-E)!==Ct)return!1}if(e.mustBeInLineWithSource&&e.sourceCoords&&t.boardCoords){const{row:C,col:h}=e.sourceCoords,{row:R,col:E}=t.boardCoords;if(C!==R&&h!==E)return!1}if(e.maxDistanceFromSource!==void 0&&e.sourceCoords&&t.boardCoords){const{row:C,col:h}=e.sourceCoords,{row:R,col:E}=t.boardCoords;if(Math.max(Math.abs(C-R),Math.abs(h-E))>e.maxDistanceFromSource)return!1}if(e.maxOrthogonalDistance!==void 0&&e.sourceCoords&&t.boardCoords){const{row:C,col:h}=e.sourceCoords,{row:R,col:E}=t.boardCoords;if(Math.abs(C-R)+Math.abs(h-E)>e.maxOrthogonalDistance)return!1}return!0},Wt=(t,e,r,n)=>{if(!t||t.type!=="ENTER_MODE"&&t.type!=="CREATE_STACK")return[];const a=[],s=e.board,o=s.length,i=e.activeGridSize,d=Math.floor((o-i)/2),l=d,g=d+i-1;if(t.type==="CREATE_STACK"){const E={targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,requiredTargetStatus:t.requiredTargetStatus,requireStatusFromSourceOwner:t.requireStatusFromSourceOwner,mustBeAdjacentToSource:t.mustBeAdjacentToSource,mustBeInLineWithSource:t.mustBeInLineWithSource,maxDistanceFromSource:t.maxDistanceFromSource,maxOrthogonalDistance:t.maxOrthogonalDistance,sourceCoords:t.sourceCoords,tokenType:t.tokenType};for(let f=l;f<=g;f++)for(let m=l;m<=g;m++){const A=s[f][m];A.card&&A.card.ownerId!==void 0&&it({card:A.card,ownerId:A.card.ownerId,location:"board",boardCoords:{row:f,col:m}},E,r,e.players)&&a.push({row:f,col:m})}return a}const{mode:T,payload:C,sourceCoords:h,contextCheck:R}=t;if(T==="REVEREND_DOUBLE_EXPLOIT"){for(let E=l;E<=g;E++)for(let f=l;f<=g;f++)s[E][f].card&&a.push({row:E,col:f});return a}if((T==="SELECT_TARGET"||T==="CENSOR_SWAP"||T==="ZEALOUS_WEAKEN"||T==="CENTURION_BUFF"||T==="SELECT_UNIT_FOR_MOVE")&&C.filter&&typeof C.filter=="function"){if(C.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||C.actionType==="LUCIUS_SETUP"||C.actionType==="SELECT_HAND_FOR_DEPLOY"||C.handOnly)return[];for(let E=l;E<=g;E++)for(let f=l;f<=g;f++){const m=s[E][f];let A=m.card&&C.filter(m.card,E,f);if(A&&R==="ADJACENT_TO_LAST_MOVE"&&(n!=null&&n.lastMovedCardCoords)){const{row:w,col:I}=n.lastMovedCardCoords;Math.abs(E-w)+Math.abs(f-I)===1||(A=!1)}A&&a.push({row:E,col:f})}}else if(T==="SELECT_TARGET"&&(C.actionType==="ENHANCED_INT_REVEAL"||C.actionType==="ENHANCED_INT_MOVE"))for(let E=l;E<=g;E++)for(let f=l;f<=g;f++)s[E][f].card&&a.push({row:E,col:f});else if(T==="PATROL_MOVE"&&h)for(let E=l;E<=g;E++)for(let f=l;f<=g;f++){const m=E===h.row||f===h.col,A=E===h.row&&f===h.col,w=!s[E][f].card;m&&(w||A)&&a.push({row:E,col:f})}else if(T==="RIOT_PUSH"&&h){const E=[{r:h.row-1,c:h.col},{r:h.row+1,c:h.col},{r:h.row,c:h.col-1},{r:h.row,c:h.col+1}],f=(m,A)=>m>=l&&m<=g&&A>=l&&A<=g;E.forEach(m=>{if(f(m.r,m.c)){const A=s[m.r][m.c].card;if(A&&A.ownerId!==r){const w=e.players.find(p=>p.id===r),I=e.players.find(p=>p.id===A.ownerId);if(!((w==null?void 0:w.teamId)!==void 0&&(I==null?void 0:I.teamId)!==void 0&&w.teamId===I.teamId)){const p=m.r-h.row,_=m.c-h.col,D=m.r+p,O=m.c+_;f(D,O)&&(s[D][O].card||a.push({row:m.r,col:m.c}))}}}})}else if(T==="SHIELD_SELF_THEN_RIOT_PUSH"&&h){h&&a.push(h);const E=[{r:h.row-1,c:h.col},{r:h.row+1,c:h.col},{r:h.row,c:h.col-1},{r:h.row,c:h.col+1}],f=(m,A)=>m>=l&&m<=g&&A>=l&&A<=g;E.forEach(m=>{if(f(m.r,m.c)){const A=s[m.r][m.c].card;if(A&&A.ownerId!==r){const w=e.players.find(p=>p.id===r),I=e.players.find(p=>p.id===A.ownerId);if(!((w==null?void 0:w.teamId)!==void 0&&(I==null?void 0:I.teamId)!==void 0&&w.teamId===I.teamId)){const p=m.r-h.row,_=m.c-h.col,D=m.r+p,O=m.c+_;f(D,O)&&(s[D][O].card||a.push({row:m.r,col:m.c}))}}}})}else if(T==="RIOT_MOVE"&&C.vacatedCoords)a.push(C.vacatedCoords),h&&a.push(h);else if(T==="SWAP_POSITIONS"&&C.filter)for(let E=l;E<=g;E++)for(let f=l;f<=g;f++){const m=s[E][f];m.card&&C.filter(m.card,E,f)&&a.push({row:E,col:f})}else if((T==="TRANSFER_STATUS_SELECT"||T==="TRANSFER_ALL_STATUSES")&&C.filter)for(let E=l;E<=g;E++)for(let f=l;f<=g;f++){const m=s[E][f];m.card&&C.filter(m.card,E,f)&&a.push({row:E,col:f})}else if(T==="SPAWN_TOKEN"||T==="SELECT_CELL"||T==="IMMUNIS_RETRIEVE")for(let E=l;E<=g;E++)for(let f=l;f<=g;f++){const m=!s[E][f].card;if(T==="IMMUNIS_RETRIEVE"&&C.filter){m&&C.filter(E,f)&&a.push({row:E,col:f});continue}if(T==="SELECT_CELL"){if(C.moveFromHand){m&&a.push({row:E,col:f});continue}if(!h)continue;const A=E===h.row&&f===h.col,w=C.range==="global";let I=!1;if(w)I=!0;else if(C.range==="line")I=E===h.row||f===h.col;else if(C.range===Ut){const u=Math.abs(E-h.row),p=Math.abs(f-h.col),_=u+p;if(_===Ct)I=!0;else if(_===Ut){const D=[];u===Ut&&p===0?D.push({r:(E+h.row)/2,c:f}):u===0&&p===Ut?D.push({r:E,c:(f+h.col)/2}):u===Ct&&p===Ct&&(D.push({r:E,c:h.col}),D.push({r:h.row,c:f})),I=D.some(O=>O.r<0||O.r>=o||O.c<0||O.c>=o?!1:!s[O.r][O.c].card)}}else I=Math.abs(E-h.row)+Math.abs(f-h.col)===Ct;(m&&I||C.allowSelf&&A)&&a.push({row:E,col:f})}else if(T==="SPAWN_TOKEN"&&h){const A=Math.abs(E-h.row)+Math.abs(f-h.col)===1;m&&A&&a.push({row:E,col:f})}}else if(T==="REVEAL_ENEMY"&&C.filter)for(let E=l;E<=g;E++)for(let f=l;f<=g;f++){const m=s[E][f];m.card&&C.filter(m.card,E,f)&&a.push({row:E,col:f})}else if(T==="SELECT_LINE_START")for(let E=l;E<=g;E++)for(let f=l;f<=g;f++)a.push({row:E,col:f});else if(T==="SELECT_LINE_END"&&C.firstCoords){const{row:E,col:f}=C.firstCoords;for(let m=l;m<=g;m++)a.push({row:E,col:m});for(let m=l;m<=g;m++)a.push({row:m,col:f})}else if(T==="INTEGRATOR_LINE_SELECT"&&h){const{row:E,col:f}=h;for(let m=l;m<=g;m++)a.push({row:E,col:m});for(let m=l;m<=g;m++)a.push({row:m,col:f})}else if(T==="ZIUS_LINE_SELECT"&&h){const{row:E,col:f}=h;for(let m=l;m<=g;m++)a.push({row:E,col:m});for(let m=l;m<=g;m++)a.push({row:m,col:f})}else if(T==="IP_AGENT_THREAT_SCORING"&&h){const{row:E,col:f}=h;for(let m=l;m<=g;m++)a.push({row:E,col:m});for(let m=l;m<=g;m++)a.push({row:m,col:f})}else if(T==="SELECT_DIAGONAL")if(C.firstCoords){const{row:E,col:f}=C.firstCoords;for(let m=l;m<=g;m++)for(let A=l;A<=g;A++)Math.abs(m-E)===Math.abs(A-f)&&a.push({row:m,col:A})}else for(let E=l;E<=g;E++)for(let f=l;f<=g;f++)a.push({row:E,col:f});return a},Ot=(t,e,r,n)=>{var s,o,i,d,l;if(t.type==="OPEN_MODAL"||t.mode==="SELECT_DECK")return!0;if(t.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let g=0;g<e.board.length;g++)for(let T=0;T<e.board[g].length;T++)if(e.board[g][T].card)return!0;return!1}if(t.mode==="PRINCEPS_SHIELD_THEN_AIM"||t.mode==="SHIELD_SELF_THEN_SPAWN"||t.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||t.mode==="ABR_DEPLOY_SHIELD_AIM"||t.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(t.mode==="SELECT_TARGET"&&((s=t.payload)!=null&&s.actionType)){const g=t.payload.actionType;if(g==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||g==="LUCIUS_SETUP"||g==="SELECT_HAND_FOR_DEPLOY"){const T=((o=t.sourceCard)==null?void 0:o.ownerId)||r;if(T!==null){const C=e.players.find(h=>h.id===T);if(C&&C.hand.length>0)return!0}return!1}}if(t.type==="CREATE_STACK"){if(Wt(t,e,r,n).length>0)return!0;const T=["Aim","Exploit","Stun","Shield"];if(!(t.tokenType&&T.includes(t.tokenType))&&(t.tokenType==="Revealed"||(i=t.tokenType)!=null&&i.startsWith("Power")))for(const h of e.players)for(let R=0;R<h.hand.length;R++){const E={targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,tokenType:t.tokenType};if(it({card:h.hand[R],ownerId:h.id,location:"hand"},E,r,e.players))return!0}return!1}if(t.mode==="SELECT_TARGET"&&((d=t.payload)!=null&&d.filter)){if(t.payload.handOnly||t.payload.allowHandTargets||t.payload.actionType==="DESTROY"){for(const g of e.players)if(g.hand.some(T=>t.payload.filter(T))&&t.payload.handOnly)return!0}if(t.payload.handOnly)return!1}return Wt(t,e,r,n).length>0?!0:((t.mode==="CENSOR_SWAP"||t.mode==="ZEALOUS_WEAKEN"||t.mode==="CENTURION_BUFF"||t.mode==="SELECT_UNIT_FOR_MOVE")&&((l=t.payload)!=null&&l.filter),!1)};function Bs(t){const{ws:e,webrtcManager:r,gameStateRef:n,localPlayerIdRef:a,webrtcIsHostRef:s,setLatestHighlight:o,setLatestFloatingTexts:i,setLatestNoTarget:d,setLatestDeckSelections:l,setLatestHandCardSelections:g,setClickWaves:T,setGameState:C}=t,h=x.useRef({}),R=500,E=x.useCallback(D=>{var P;const O={...D,timestamp:Date.now()};if(o(O),((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:n.current.gameId,highlightData:O}));else if(r.current){const b={type:"HIGHLIGHT_TRIGGERED",senderId:r.current.getPeerId(),data:O,timestamp:Date.now()};s.current?r.current.broadcastToGuests(b):r.current.sendMessageToHost(b)}},[e,r,n,s,o]),f=x.useCallback(D=>{var L;const O=Array.isArray(D)?D:[D],P=Date.now(),b=O.map((U,F)=>({...U,timestamp:P+F}));if(i(b),((L=e.current)==null?void 0:L.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:n.current.gameId,batch:b}));else if(r.current){const U={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:r.current.getPeerId(),data:{batch:b},timestamp:Date.now()};s.current?r.current.broadcastToGuests(U):r.current.sendMessageToHost(U)}},[e,r,n,s,i]),m=x.useCallback(D=>{var P;const O=Date.now();if(d({coords:D,timestamp:O}),((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:n.current.gameId,coords:D,timestamp:O}));else if(r.current){const b={type:"NO_TARGET_TRIGGERED",senderId:r.current.getPeerId(),data:{coords:D,timestamp:O},timestamp:Date.now()};s.current?r.current.broadcastToGuests(b):r.current.sendMessageToHost(b)}},[e,r,n,s,d]),A=x.useCallback((D,O)=>{var b;const P={playerId:D,selectedByPlayerId:O,timestamp:Date.now()};if(l(L=>[...L,P]),((b=e.current)==null?void 0:b.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:n.current.gameId,deckSelectionData:P}));else if(r.current){const L={type:"DECK_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:P,timestamp:Date.now()};s.current?r.current.broadcastToGuests(L):r.current.sendMessageToHost(L)}setTimeout(()=>{l(L=>L.filter(U=>U.timestamp!==P.timestamp))},1e3)},[e,r,n,s,l]),w=x.useCallback((D,O,P)=>{var L;const b={playerId:D,cardIndex:O,selectedByPlayerId:P,timestamp:Date.now()};if(g(U=>[...U,b]),((L=e.current)==null?void 0:L.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:n.current.gameId,handCardSelectionData:b}));else if(r.current){const U={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:b,timestamp:Date.now()};s.current?r.current.broadcastToGuests(U):r.current.sendMessageToHost(U)}setTimeout(()=>{g(U=>U.filter(F=>F.timestamp!==b.timestamp))},1e3)},[e,r,n,s,g]),I=x.useCallback(D=>{},[]),u=x.useCallback((D,O,P)=>{var G;if(a.current===null)return;const b=a.current,L=Date.now(),U=h.current[b]||0;if(L-U<R)return;h.current[b]=L;const F=n.current.players.find($=>$.id===b);if(!F)return;const N={timestamp:Date.now(),location:D,boardCoords:O,handTarget:P,clickedByPlayerId:b,playerColor:F.color};if(T($=>[...$,N]),((G=e.current)==null?void 0:G.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_CLICK_WAVE",gameId:n.current.gameId,wave:N}));else if(r.current){const $={type:"CLICK_WAVE_TRIGGERED",senderId:r.current.getPeerId(),data:N,timestamp:Date.now()};s.current?r.current.broadcastToGuests($):r.current.sendMessageToHost($)}setTimeout(()=>{T($=>$.filter(q=>q.timestamp!==N.timestamp))},600)},[e,r,n,s,T]),p=x.useCallback((D,O,P,b,L,U)=>{var $;const F=n.current;if(!F||!F.board){console.warn("[setTargetingMode] No game state or board available");return}let N;b?N=b:P&&(N=Wt(D,F,O,L));const G={playerId:O,action:D,sourceCoords:P,timestamp:Date.now(),boardTargets:N,handTargets:U};if(C(q=>({...q,targetingMode:G})),(($=e.current)==null?void 0:$.readyState)===WebSocket.OPEN&&F.gameId)e.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:F.gameId,targetingMode:G}));else if(r.current){const q={type:"SET_TARGETING_MODE",senderId:r.current.getPeerId(),data:G,timestamp:Date.now()};s.current?r.current.broadcastToGuests(q):r.current.sendMessageToHost(q)}},[e,r,n,s,C]),_=x.useCallback(()=>{var O;const D=n.current;if(C(P=>({...P,targetingMode:null})),((O=e.current)==null?void 0:O.readyState)===WebSocket.OPEN&&(D!=null&&D.gameId))e.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:D.gameId}));else if(r.current){const P={type:"CLEAR_TARGETING_MODE",senderId:r.current.getPeerId(),data:{},timestamp:Date.now()};s.current?r.current.broadcastToGuests(P):r.current.sendMessageToHost(P)}},[e,r,n,s,C]);return{triggerHighlight:E,triggerFloatingText:f,triggerNoTarget:m,triggerDeckSelection:A,triggerHandCardSelection:w,syncValidTargets:I,triggerClickWave:u,setTargetingMode:p,clearTargetingMode:_}}function Ys(t){const{ws:e,webrtcManager:r,gameStateRef:n,webrtcIsHostRef:a,setGameState:s,updateState:o}=t,i=x.useCallback(C=>{var R;if(ve()&&r.current&&a.current){s(E=>{const f=E.players.map(m=>{let A=1;for(const[w,I]of Object.entries(C))if(I.includes(m.id)){A=parseInt(w);break}return{...m,teamId:A}});return{...E,players:f}}),r.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:r.current.getPeerId(),data:{assignments:C},timestamp:Date.now()});return}((R=e.current)==null?void 0:R.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:n.current.gameId,assignments:C}))},[e,r,n,a,s]),d=x.useCallback(C=>{var R;if(ve()&&r.current&&a.current){s(E=>({...E,gameMode:C})),r.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:r.current.getPeerId(),data:{mode:C},timestamp:Date.now()});return}((R=e.current)==null?void 0:R.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:n.current.gameId,mode:C}))},[e,r,n,a,s]),l=x.useCallback(C=>{var R;if(ve()&&r.current&&a.current){s(E=>({...E,isPrivate:C})),r.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:r.current.getPeerId(),data:{isPrivate:C},timestamp:Date.now()});return}((R=e.current)==null?void 0:R.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:n.current.gameId,isPrivate:C}))},[e,r,n,a,s]),g=x.useCallback(C=>{o(h=>{if(h.isGameStarted)return h;const R={...h,activeGridSize:C};if(h.board.length!==C){R.board=[];for(let f=0;f<C;f++){const m=[];for(let A=0;A<C;A++)m.push({card:null});R.board.push(m)}}return R})},[o]),T=x.useCallback(C=>{o(h=>{if(h.isGameStarted)return h;const R=h.players.filter(m=>!m.isDummy);if(R.length+C>Jo)return h;const E=[...R],f=Math.max(...R.map(m=>m.id),0);for(let m=0;m<C;m++){const A=f+m+1,w=Ta(A,!0);w.name=`Dummy ${m+1}`,E.push(w)}return{...h,players:E,dummyPlayerCount:C}})},[o]);return{assignTeams:i,setGameMode:d,setGamePrivacy:l,setActiveGridSize:g,setDummyPlayerCount:T}}function zs(t){const{ws:e,webrtcManager:r,gameStateRef:n,localPlayerIdRef:a,webrtcIsHostRef:s,setGameState:o}=t,i=x.useCallback(()=>{var T;if(ve()&&r.current&&s.current){o(C=>({...C,isReadyCheckActive:!0,isPrivate:!0})),r.current.broadcastToGuests({type:"START_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((T=e.current)==null?void 0:T.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:n.current.gameId}))},[e,r,n,s,o]),d=x.useCallback(()=>{var T;if(ve()&&r.current&&s.current){o(C=>({...C,isReadyCheckActive:!1})),r.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((T=e.current)==null?void 0:T.readyState)===WebSocket.OPEN&&n.current.gameId?e.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:n.current.gameId})):o(C=>({...C,isReadyCheckActive:!1}))},[e,r,n,s,o]),l=x.useCallback(()=>{var T;const g=ve();if(g&&r.current&&s.current&&a.current!==null){o(C=>{const h=C.players.map(m=>m.id===a.current?{...m,isReady:!0}:m),R={...C,players:h},E=R.players.filter(m=>!m.isDummy&&!m.isDisconnected);if(E.length>0&&E.every(m=>m.isReady)&&!R.isGameStarted){const m=R.players.filter(p=>!p.isDisconnected),A=Math.floor(Math.random()*m.length),w=m[A].id,I={...R};I.isReadyCheckActive=!1,I.isGameStarted=!0,I.startingPlayerId=w,I.activePlayerId=w,I.currentPhase=0,I.players=I.players.map(p=>{if(p.hand.length===0&&p.deck.length>0){const D=[...p.hand],O=[...p.deck];for(let P=0;P<6&&P<O.length;P++){const b=O[0];O.splice(0,1),D.push(b)}return c.info(`[playerReady] Drew initial ${D.length} cards for player ${p.id}`),{...p,hand:D,deck:O}}return p});const u=I.players.find(p=>p.id===w);if(u&&u.deck.length>0){const p=u.deck[0],_=[...u.deck.slice(1)],D=[...u.hand,p];I.players=I.players.map(O=>O.id===w?{...O,deck:_,hand:D,readySetup:!1,readyCommit:!1}:O),I.currentPhase=1}return r.current.broadcastGameState(I),r.current.broadcastToGuests({type:"GAME_START",senderId:r.current.getPeerId(),data:{startingPlayerId:w,activePlayerId:w,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),I}return r.current.broadcastToGuests({type:"HOST_READY",senderId:r.current.getPeerId(),playerId:a.current??void 0,timestamp:Date.now()}),R});return}if(g&&r.current&&!s.current&&a.current!==null){r.current.sendMessageToHost({type:"PLAYER_READY",senderId:r.current.getPeerId(),playerId:a.current,timestamp:Date.now()}),o(C=>({...C,players:C.players.map(h=>h.id===a.current?{...h,isReady:!0}:h)}));return}((T=e.current)==null?void 0:T.readyState)===WebSocket.OPEN&&n.current.gameId&&a.current!==null&&e.current.send(JSON.stringify({type:"PLAYER_READY",gameId:n.current.gameId,playerId:a.current}))},[e,r,n,a,s,o]);return{startReadyCheck:i,cancelReadyCheck:d,playerReady:l}}function Ks(t){const{updateState:e,sendWebrtcAction:r,webrtcIsHostRef:n,webrtcManagerRef:a}=t,s=x.useCallback((i,d)=>{e(l=>l.isGameStarted?l:{...l,players:l.players.map(g=>g.id===i?{...g,name:d}:g)})},[e]),o=x.useCallback((i,d)=>{e(g=>({...g,players:g.players.map(T=>T.id===i?{...T,color:d}:T)})),r!==null&&(n!=null&&n.current&&(a!=null&&a.current)?a.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:a.current.getPeerId(),data:{playerId:i,color:d},timestamp:Date.now()}):!(n!=null&&n.current)&&r&&r("CHANGE_PLAYER_COLOR",{playerId:i,color:d}))},[e,r,n,a]);return{updatePlayerName:s,changePlayerColor:o}}function qs(t){const{updateState:e}=t,r=x.useCallback(i=>{e(d=>{if(!d.isGameStarted)return d;const l=d.players.find(h=>h.id===i);if(!l||l.deck.length===0)return d;const g=he(d),T=g.players.find(h=>h.id===i),C=T.deck.shift();return C&&T.hand.push(C),g})},[e]),n=x.useCallback((i,d)=>{d<=0||e(l=>{if(!l.isGameStarted)return l;const g=l.players.find(R=>R.id===i);if(!g||g.deck.length===0)return l;const T=he(l),C=T.players.find(R=>R.id===i),h=Math.min(d,C.deck.length);for(let R=0;R<h;R++){const E=C.deck.shift();E&&C.hand.push(E)}return T})},[e]),a=x.useCallback(i=>{e(d=>{if(!d.isGameStarted||!d.players.find(E=>E.id===i))return d;const g=he(d),T=g.players.find(E=>E.id===i);T.deck=Tr([...T.deck]);const C=t.webrtcManager.current,h=t.webrtcIsHostRef.current,R=t.localPlayerIdRef.current;return C&&d.gameId&&!h&&i===R&&setTimeout(()=>{C.sendFullDeckToHost(i,T.deck,T.deck.length)},0),g})},[e,t]),s=x.useCallback(i=>{e(d=>{if(!d.isGameStarted)return d;const l={...d},g=l.board[i.row][i.col].card;return g&&(g.isFaceDown=!1),{...l,board:xe(l)}})},[e]),o=x.useCallback(i=>{e(d=>{if(!d.isGameStarted)return d;const l={...d},g=l.board[i.row][i.col].card;return g&&(g.isFaceDown=!0),{...l,board:xe(l)}})},[e]);return{drawCard:r,drawCardsBatch:n,shufflePlayerDeck:a,flipBoardCard:s,flipBoardCardFaceDown:o}}function Vs(t){const{localPlayerIdRef:e,updateState:r}=t,n=x.useCallback((m,A,w)=>{r(I=>{var _,D;if(!I.isGameStarted)return I;const u=he(I),p=u.board[m.row][m.col].card;if(p){if(A==="Stun"&&(p.baseId==="luciusTheImmortal"||p.name.includes("Lucius")&&((_=p.types)!=null&&_.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(A)&&((D=p.statuses)==null?void 0:D.some(P=>P.type===A&&P.addedByPlayerId===w)))return I;p.statuses||(p.statuses=[]),p.statuses.push({type:A,addedByPlayerId:w})}return u})},[r]),a=x.useCallback((m,A)=>{r(w=>{if(!w.isGameStarted)return w;const I=he(w),u=I.board[m.row][m.col].card;if(u!=null&&u.statuses){const p=u.statuses.map(_=>_.type).lastIndexOf(A);p>-1&&u.statuses.splice(p,1)}return I.board=xe(I),I})},[r]),s=x.useCallback((m,A,w)=>{r(I=>{if(!I.isGameStarted)return I;const u=he(I),p=u.board[m.row][m.col].card;if(p!=null&&p.statuses){const _=p.statuses.findIndex(D=>D.type===A&&D.addedByPlayerId===w);_>-1&&p.statuses.splice(_,1)}return u.board=xe(u),u})},[r]),o=x.useCallback((m,A)=>{r(w=>{if(!w.isGameStarted)return w;const I=he(w),u=I.board[m.row][m.col].card;return u&&(u.powerModifier===void 0&&(u.powerModifier=0),u.powerModifier+=A),I})},[r]),i=x.useCallback((m,A,w)=>{r(I=>{var _;if(!I.isGameStarted)return I;const u=he(I),p=u.players.find(D=>D.id===m);if(p!=null&&p.announcedCard){if(["Support","Threat","Revealed"].includes(A)&&((_=p.announcedCard.statuses)==null?void 0:_.some(O=>O.type===A&&O.addedByPlayerId===w)))return I;p.announcedCard.statuses||(p.announcedCard.statuses=[]),p.announcedCard.statuses.push({type:A,addedByPlayerId:w})}return u})},[r]),d=x.useCallback((m,A)=>{r(w=>{var p;if(!w.isGameStarted)return w;const I=he(w),u=I.players.find(_=>_.id===m);if((p=u==null?void 0:u.announcedCard)!=null&&p.statuses){const _=u.announcedCard.statuses.map(D=>D.type).lastIndexOf(A);_>-1&&u.announcedCard.statuses.splice(_,1)}return I})},[r]),l=x.useCallback((m,A)=>{r(w=>{if(!w.isGameStarted)return w;const I=he(w),u=I.players.find(p=>p.id===m);return u!=null&&u.announcedCard&&(u.announcedCard.powerModifier===void 0&&(u.announcedCard.powerModifier=0),u.announcedCard.powerModifier+=A),I})},[r]),g=x.useCallback((m,A,w,I)=>{r(u=>{var D;if(!u.isGameStarted)return u;const p=he(u),_=p.players.find(O=>O.id===m);if(_!=null&&_.hand[A]){const O=_.hand[A];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(w)&&((D=O.statuses)==null?void 0:D.some(b=>b.type===w&&b.addedByPlayerId===I)))return u;O.statuses||(O.statuses=[]),O.statuses.push({type:w,addedByPlayerId:I})}return p})},[r]),T=x.useCallback((m,A,w)=>{r(I=>{if(!I.isGameStarted)return I;const u=he(I),p=u.players.find(D=>D.id===m),_=p==null?void 0:p.hand[A];if(_!=null&&_.statuses){const D=_.statuses.map(O=>O.type).lastIndexOf(w);D>-1&&_.statuses.splice(D,1),w==="Revealed"&&(_.statuses.some(P=>P.type==="Revealed")||delete _.revealedTo)}return u})},[r]),C=x.useCallback((m,A,w)=>{r(I=>{const u=I.players.find(D=>D.id===m);if(!(u!=null&&u.hand[A]))return I;const p=he(I),_=p.players.find(D=>D.id===m).hand[A];if(w==="all")_.revealedTo="all",_.statuses||(_.statuses=[]),_.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===m)||_.statuses.push({type:"Revealed",addedByPlayerId:m});else{(!_.revealedTo||_.revealedTo==="all"||!Array.isArray(_.revealedTo))&&(_.revealedTo=[]);const D=w.filter(O=>!_.revealedTo.includes(O));_.revealedTo.push(...D)}return p})},[r]),h=x.useCallback((m,A)=>{r(w=>{if(!w.board[m.row][m.col].card)return w;const u=he(w),p=u.board[m.row][m.col].card,_=p.ownerId;if(A==="all")p.revealedTo="all",_!==void 0&&(p.statuses||(p.statuses=[]),p.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===_)||p.statuses.push({type:"Revealed",addedByPlayerId:_}));else{(!p.revealedTo||p.revealedTo==="all"||!Array.isArray(p.revealedTo))&&(p.revealedTo=[]);const D=A.filter(O=>!p.revealedTo.includes(O));p.revealedTo.push(...D)}return u})},[r]),R=x.useCallback((m,A)=>{r(w=>{var _;const I=m.boardCoords?(_=w.board[m.boardCoords.row][m.boardCoords.col].card)==null?void 0:_.ownerId:m.ownerId;if(!I)return w;const u=he(w),p=u.revealRequests.find(D=>D.fromPlayerId===A&&D.toPlayerId===I);return p?p.cardIdentifiers.some(O=>JSON.stringify(O)===JSON.stringify(m))||p.cardIdentifiers.push(m):u.revealRequests.push({fromPlayerId:A,toPlayerId:I,cardIdentifiers:[m]}),u})},[r]),E=x.useCallback((m,A)=>{r(w=>{const I=w.revealRequests.findIndex(_=>_.toPlayerId===e.current&&_.fromPlayerId===m);if(I===-1)return w;const u=he(w),p=u.revealRequests[I];if(A){const{cardIdentifiers:_}=p;for(const D of _){let O=null;if(D.source==="board"&&D.boardCoords)O=u.board[D.boardCoords.row][D.boardCoords.col].card;else if(D.source==="hand"&&D.ownerId&&D.cardIndex!==void 0){const P=u.players.find(b=>b.id===D.ownerId);P&&(O=P.hand[D.cardIndex])}O&&(O.statuses||(O.statuses=[]),O.statuses.some(P=>P.type==="Revealed"&&P.addedByPlayerId===m)||O.statuses.push({type:"Revealed",addedByPlayerId:m}))}}return u.revealRequests.splice(I,1),u})},[r,e]),f=x.useCallback(m=>{r(A=>{const w=he(A);let I=null;if(m.source==="board"&&m.boardCoords)I=w.board[m.boardCoords.row][m.boardCoords.col].card;else if(m.source==="hand"&&m.playerId&&m.cardIndex!==void 0){const u=w.players.find(p=>p.id===m.playerId);u&&(I=u.hand[m.cardIndex])}return I&&(I.statuses&&(I.statuses=I.statuses.filter(u=>u.type!=="Revealed")),delete I.revealedTo),w})},[r]);return{addBoardCardStatus:n,removeBoardCardStatus:a,removeBoardCardStatusByOwner:s,modifyBoardCardPower:o,addAnnouncedCardStatus:i,removeAnnouncedCardStatus:d,modifyAnnouncedCardPower:l,addHandCardStatus:g,removeHandCardStatus:T,revealHandCard:C,revealBoardCard:h,requestCardReveal:R,respondToRevealRequest:E,removeRevealedStatus:f}}function js(t){const{webrtcIsHostRef:e,sendWebrtcAction:r,webrtcManagerRef:n,localPlayerIdRef:a,getCardDefinition:s,commandCardIds:o,createDeck:i,updateState:d}=t,l=x.useCallback((E,f)=>{const m=ve();let A=!1;if(d(I=>{const u=I.players.find(P=>P.id===E);if(!u)return I;A=u.isDummy||!1;const p=A,_=e.current,D=!p||_;if(m&&!_)try{localStorage.setItem("webrtc_preferred_deck",f),c.info(`[changePlayerDeck] Guest saved deck preference: ${f}`)}catch(P){c.warn("[changePlayerDeck] Failed to save deck preference:",P)}const O=D?i(f,E,u.name):[];return m?_?{...I,players:I.players.map(P=>P.id===E?{...P,deck:O,selectedDeck:f,hand:[],discard:[],announcedCard:null,boardHistory:[]}:P)}:{...I,players:I.players.map(P=>P.id===E?{...P,selectedDeck:f}:P)}:{...I,players:I.players.map(P=>P.id===E?{...P,deck:O,selectedDeck:f,hand:[],discard:[],announcedCard:null,boardHistory:[]}:P)}}),c.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${m}, isHost=${e.current}, hasSendAction=${!!r}, hasManager=${!!(n!=null&&n.current)}`),!m)return;if(e.current){const u=i(f,E,"Player "+E).map(p=>({id:p.id,baseId:p.baseId,power:p.power,powerModifier:p.powerModifier||0,isFaceDown:p.isFaceDown||!1,statuses:p.statuses||[]}));if(f==="Optimates"){const p={};u.forEach(_=>{const D=_.baseId||_.id;p[D]=(p[D]||0)+1}),c.info("[changePlayerDeck] Host sending Optimates deck data:",{totalCards:u.length,baseIdCounts:p})}n!=null&&n.current?(n.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:n.current.getPeerId(),timestamp:Date.now(),data:{playerId:E,deckType:f,deck:u,deckSize:u.length}}),c.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${E}, deck ${f}, ${u.length} cards, isDummy=${A}`)):c.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available")}else r?r("CHANGE_PLAYER_DECK",{playerId:E,deckType:f,deck:void 0,deckSize:0}):c.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[d,i,r,e,n,a]),g=x.useCallback((E,f)=>{const m=ve();let A=[];const w=new Map;for(const{cardId:u,quantity:p}of f.cards){const _=s(u);if(!_)continue;const D=o.has(u),O=D?Re.Command:Re.Custom,P=D?"CMD":"CUS";for(let b=0;b<p;b++){const L=(w.get(u)||0)+1;w.set(u,L),A.push({..._,id:`${P}_${u.toUpperCase()}_${L}`,baseId:u,deck:O,ownerId:E,ownerName:"Player "+E})}}if(A=Tr(A),d(u=>u.isGameStarted||!u.players.find(_=>_.id===E)?u:{...u,players:u.players.map(_=>_.id===E?{..._,deck:A,selectedDeck:Re.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:_)}),!m)return;const I=A.map(u=>({id:u.id,baseId:u.baseId,power:u.power,powerModifier:u.powerModifier||0,isFaceDown:u.isFaceDown||!1,statuses:u.statuses||[]}));e.current?n!=null&&n.current&&(n.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:n.current.getPeerId(),timestamp:Date.now(),data:{playerId:E,deckType:Re.Custom,deck:I,deckSize:I.length}}),c.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${E}, ${I.length} cards`)):r&&(r("CHANGE_PLAYER_DECK",{playerId:E,deckType:Re.Custom,deck:I,deckSize:I.length}),c.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${E}, ${I.length} cards`))},[d,s,o,r,e,n,a]),T=x.useCallback((E,f,m,A)=>{d(w=>{if(!w.isGameStarted||w.board[m.row][m.col].card!==null)return w;const I=he(w),u=I.players.find(p=>p.id===E);if(u&&u.discard.length>f){const[p]=u.discard.splice(f,1);p.enteredThisTurn=!0,yr(p,E),(p.baseId==="luciusTheImmortal"||p.name.includes("Lucius"))&&(p.powerModifier===void 0&&(p.powerModifier=0),p.powerModifier+=2),p.statuses||(p.statuses=[]),p.statuses.push({type:"Resurrected",addedByPlayerId:E}),A&&A.forEach(_=>{var D;_.type!=="Resurrected"&&((D=p.statuses)==null||D.push({type:_.type,addedByPlayerId:E}))}),u.boardHistory||(u.boardHistory=[]),u.boardHistory.push(p.id),I.board[m.row][m.col].card=p,Ia(I.board,u),I.board=xe(I)}return I})},[d]),C=x.useCallback((E,f)=>{d(m=>{const A=he(m),w=A.players.find(I=>I.id===E);if(w&&f.length>0){const I=new Set(f.map(p=>p.id)),u=w.deck.filter(p=>!I.has(p.id));w.deck=[...f,...u]}return A})},[d]),h=x.useCallback((E,f,m)=>{d(A=>{const w=he(A),I=w.players.find(u=>u.id===E);return I&&(m==="deck"?I.deck=f:m==="discard"&&(I.discard=f)),w})},[d]),R=x.useCallback((E,f)=>{d(m=>{if(!m.isGameStarted)return m;const A=he(m),w=A.players.find(I=>I.id===E);if(w&&w.discard.length>f){const[I]=w.discard.splice(f,1);w.hand.push(I)}return A})},[d]);return{changePlayerDeck:l,loadCustomDeck:g,resurrectDiscardedCard:T,reorderTopDeck:C,reorderCards:h,recoverDiscardedCard:R}}function Js(t){const{ws:e,webrtcManagerRef:r,webrtcIsHostRef:n,gameStateRef:a,scoreDeltaAccumulator:s,setGameState:o,updateState:i,abilityMode:d,setAbilityMode:l,createDeck:g}=t,T=x.useCallback(w=>{ve()&&r.current?n.current?o(u=>{const p=ma(u,w);return r.current&&r.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:r.current.getPeerId(),data:{activePlayerId:p.activePlayerId,currentPhase:p.currentPhase,turnNumber:p.turnNumber},timestamp:Date.now()}),p}):r.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:w},timestamp:Date.now()}):e.current&&e.current.readyState===WebSocket.OPEN&&(s.forEach((u,p)=>{clearTimeout(u.timerId),c.info(`[ScoreFlush] Flushing on toggle: player=${p}, delta=${u.delta}`),e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:a.current.gameId,playerId:p,delta:u.delta}))}),s.clear(),e.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:a.current.gameId,playerId:w})))},[e,r,n,a,s,o]),C=x.useCallback((w,I)=>{e.current&&e.current.readyState===WebSocket.OPEN&&e.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:a.current.gameId,playerId:w,enabled:I}))},[]),h=x.useCallback(w=>{const I=d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode);I&&l(null),i(u=>{if(!u.isGameStarted)return u;const p=Math.max(1,Math.min(w,4));return{...u,currentPhase:p,...p===4&&!I?{isScoringStep:!0}:{},...I?{isScoringStep:!1}:{}}})},[i,d,l]),R=x.useCallback(()=>{var u;d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&l(null);const w=a.current,I=ve();if(w.isGameStarted&&w.currentPhase===4&&w.isScoringStep&&!I){((u=e.current)==null?void 0:u.readyState)===WebSocket.OPEN&&(s.forEach((p,_)=>{clearTimeout(p.timerId),c.info(`[ScoreFlush] Flushing pending score: player=${_}, delta=${p.delta}`),e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:w.gameId,playerId:_,delta:p.delta}))}),s.clear(),e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:w.gameId})));return}if(I&&w.isGameStarted&&w.currentPhase===4&&w.isScoringStep){i(p=>mt(p));return}i(p=>{if(!p.isGameStarted)return p;const _=he(p),D=p.currentPhase+1;return p.preserveDeployAbilities||_.board.forEach(O=>{O.forEach(P=>{var b;(b=P.card)!=null&&b.statuses&&(P.card.statuses=P.card.statuses.filter(L=>L.type!=="readyDeploy"))})}),I&&D===4&&p.currentPhase===3?Gs(p,p.activePlayerId)?(_.isScoringStep=!0,_.currentPhase=4,_):(c.info(`[nextPhase] Player ${p.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),mt(p)):D===4&&p.currentPhase===3?(_.isScoringStep=!0,_.currentPhase=4,_):(_.board.forEach(O=>{O.forEach(P=>{var b;if((b=P.card)!=null&&b.statuses){const L=P.card.statuses.findIndex(U=>U.type==="Resurrected");if(L!==-1){const U=P.card.statuses[L].addedByPlayerId;P.card.statuses.splice(L,1),P.card.baseId!=="luciusTheImmortal"&&(P.card.statuses.push({type:"Stun",addedByPlayerId:U}),P.card.statuses.push({type:"Stun",addedByPlayerId:U}))}}})}),_.board=xe(_),_.currentPhase=D,_)})},[i,d,l,a,e,s]),E=x.useCallback(()=>{i(w=>w.isGameStarted?(d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&l(null),w.isScoringStep?{...w,isScoringStep:!1,currentPhase:Math.max(1,w.currentPhase-1)}:{...w,currentPhase:Math.max(1,w.currentPhase-1)}):w)},[i,d,l]),f=x.useCallback(()=>{var I;ve()?i(u=>({...u,isRoundEndModalOpen:!1,currentRound:(u.currentRound||1)+1,players:u.players.map(p=>({...p,score:0}))})):((I=e.current)==null?void 0:I.readyState)===WebSocket.OPEN&&a.current.gameId&&(o(u=>({...u,isRoundEndModalOpen:!1,currentRound:(u.currentRound||1)+1,players:u.players.map(p=>({...p,score:0}))})),e.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:a.current.gameId})))},[o,i,e,a]),m=x.useCallback(()=>{o(w=>({...w,isRoundEndModalOpen:!1}))},[o]),A=x.useCallback(()=>{var I;if(ve()){const u=a.current,p=u.players.map(P=>{const b=P.selectedDeck||"SynchroTech";return{...P,hand:[],deck:g(b,P.id,P.name),discard:[],score:0,isReady:P.isDummy||!1,announcedCard:null,boardHistory:[]}}),_=u.activeGridSize||8,D=[];for(let P=0;P<_;P++){const b=[];for(let L=0;L<_;L++)b.push({card:null});D.push(b)}const O={...u,players:p,board:D,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};o(O),a.current=O,r.current&&r.current.broadcastToGuests({type:"GAME_RESET",senderId:r.current.getPeerId(),data:{players:p.map(P=>({id:P.id,name:P.name,color:P.color,selectedDeck:P.selectedDeck,isDummy:P.isDummy,isDisconnected:P.isDisconnected,autoDrawEnabled:P.autoDrawEnabled,handSize:P.hand.length,deckSize:P.deck.length,discardSize:P.discard.length,...P.isDummy&&{hand:P.hand.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses})),deck:P.deck.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses})),discard:P.discard.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses}))},score:P.score,isReady:P.isReady,announcedCard:P.announcedCard})),gameMode:O.gameMode,isPrivate:O.isPrivate,activeGridSize:O.activeGridSize,dummyPlayerCount:O.dummyPlayerCount,autoAbilitiesEnabled:O.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((I=e.current)==null?void 0:I.readyState)===WebSocket.OPEN&&e.current.send(JSON.stringify({type:"RESET_GAME",gameId:a.current.gameId}))},[e,r,a,o,g]);return{toggleActivePlayer:T,toggleAutoDraw:C,setPhase:h,nextPhase:R,prevPhase:E,closeRoundEndModal:f,closeRoundEndModalOnly:m,resetGame:A}}function Xs(t){const{ws:e,gameStateRef:r,updateState:n,updatePlayerScore:a,triggerFloatingText:s,clearTargetingMode:o}=t,i=x.useCallback((l,g,T,C,h)=>{var D,O;const R=r.current;if(!R.isGameStarted||R.isRoundEndModalOpen)return;const E=R.board.some(P=>P.some(b=>{var L,U;return((L=b.card)==null?void 0:L.ownerId)===h&&b.card.name.toLowerCase().includes("data liberator")&&((U=b.card.statuses)==null?void 0:U.some(F=>F.type==="Support"))})),f=R.board.length;let m=l,A=l,w=g,I=g;if(l===T)m=l,A=l,w=0,I=f-1;else if(g===C)w=g,I=g,m=0,A=f-1;else return;let u=0;const p=[];for(let P=m;P<=A;P++)for(let b=w;b<=I;b++){const U=R.board[P][b].card;if(U&&!((D=U.statuses)!=null&&D.some(F=>F.type==="Stun"))){const F=U.ownerId===h,N=(O=U.statuses)==null?void 0:O.some(G=>G.type==="Exploit"&&G.addedByPlayerId===h);if(F||E&&N){const G=Math.max(0,U.power+(U.powerModifier||0)+(U.bonusPower||0));G>0&&(u+=G,p.push({row:P,col:b,text:`+${G}`,playerId:h}))}}}p.length>0&&s(p);const _=ve();if(_?n(P=>({...P,players:P.players.map(b=>b.id===h?{...b,score:Math.max(0,(b.score||0)+u)}:b)})):a(h,u),_||a(h,u),u>0&&R.currentPhase===4&&R.activePlayerId===h){const P=R.gameId;setTimeout(()=>{var b;o==null||o(),_?n(L=>mt(L)):((b=e.current)==null?void 0:b.readyState)===WebSocket.OPEN&&P&&e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:P}))},100)}},[s,a,n,e,r,o,mt]),d=x.useCallback((l,g,T,C,h,R)=>{var _,D,O;const E=r.current;if(!E.isGameStarted||E.isRoundEndModalOpen)return;const f=T>l?1:-1,m=C>g?1:-1,A=Math.abs(l-T);let w=0,I=0;const u=[];for(let P=0;P<=A;P++){const b=l+P*f,L=g+P*m;if(b<0||b>=E.board.length||L<0||L>=E.board.length)continue;const F=E.board[b][L].card;if(F&&!((_=F.statuses)!=null&&_.some(N=>N.type==="Stun"))){const N=F.ownerId===h,G=(D=F.statuses)==null?void 0:D.some($=>$.type==="Exploit"&&$.addedByPlayerId===h);if(N||G){const $=Math.max(0,F.power+(F.powerModifier||0)+(F.bonusPower||0));$>0&&(w+=$,u.push({row:b,col:L,text:`+${$}`,playerId:h})),R&&((O=F.statuses)!=null&&O.some(q=>q.type==="Support"&&q.addedByPlayerId===h))&&(I+=1)}}}R==="point_per_support"&&I>0&&(w+=I),u.length>0&&s(u);const p=ve();if(p?n(P=>({...P,players:P.players.map(b=>b.id===h?{...b,score:Math.max(0,(b.score||0)+w)}:b)})):a(h,w),p||a(h,w),R==="draw_per_support"&&I>0&&n(P=>{const b=he(P),L=b.players.find(U=>U.id===h);if(L&&L.deck.length>0)for(let U=0;U<I;U++)L.deck.length>0&&L.hand.push(L.deck.shift());return b}),w>0&&E.currentPhase===4&&E.activePlayerId===h){const P=E.gameId;setTimeout(()=>{var b;o==null||o(),p?n(L=>mt(L)):((b=e.current)==null?void 0:b.readyState)===WebSocket.OPEN&&P&&e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:P}))},500)}},[s,a,n,e,r,o,mt]);return{scoreLine:i,scoreDiagonal:d}}const Zs=t=>{const{updateState:e,rawJsonData:r}=t,n=x.useCallback((T,C,h,R)=>{e(E=>{var A,w;if(!E.isGameStarted||T.row<0||T.col<0)return E;const f=he(E),m=(w=(A=f.board[T.row])==null?void 0:A[T.col])==null?void 0:w.card;if(m){const I=m.statuses?m.statuses.map(u=>u.type):[];if(R&&m.statuses){m.statuses=m.statuses.filter(p=>p.type!==R);const u=m.statuses.map(p=>p.type);c.debug(`[markAbilityUsed] Removed status '${R}' from ${m.name} at [${T.row},${T.col}]: [${I.join(", ")}] -> [${u.join(", ")}]`)}else c.debug(`[markAbilityUsed] Called for ${m.name} at [${T.row},${T.col}] but no readyStatusToRemove specified. Current statuses: [${I.join(", ")}]`)}return f})},[e]),a=x.useCallback(T=>{e(C=>{var E,f;if(!C.isGameStarted||T.row<0||T.col<0)return C;const h=he(C),R=(f=(E=h.board[T.row])==null?void 0:E[T.col])==null?void 0:f.card;if(R&&(R.statuses||(R.statuses=[]),(R.ability||"").toLowerCase().includes("deploy:")&&!R.statuses.some(A=>A.type==="readyDeploy"))){const A=R.ownerId;if(A==null||A===0)return C;R.statuses.push({type:"readyDeploy",addedByPlayerId:A})}return h})},[e]),s=x.useCallback((T,C)=>{e(h=>{if(!h.isGameStarted)return h;const R=he(h),E=R.board[T.row][T.col].card;return E!=null&&E.statuses&&(E.statuses=E.statuses.filter(f=>f.type!==C)),R.board=xe(R),R})},[e]),o=x.useCallback((T,C,h,R,E)=>{e(f=>{if(!f.isGameStarted)return f;const m=he(f);return C.forEach(({row:A,col:w})=>{var u;const I=m.board[A][w].card;if(I){if(h==="Stun"&&(I.baseId==="luciusTheImmortal"||I.name.includes("Lucius")&&((u=I.types)!=null&&u.includes("Hero"))))return;I.statuses||(I.statuses=[]),["Support","Threat","Revealed"].includes(h)?I.statuses.some(_=>_.type===h&&_.addedByPlayerId===R)||I.statuses.push({type:h,addedByPlayerId:R}):I.statuses.push({type:h,addedByPlayerId:R})}}),m})},[e]),i=x.useCallback((T,C)=>{e(h=>{if(!h.isGameStarted)return h;const R=he(h),E=R.board[T.row][T.col].card,f=R.board[C.row][C.col].card;return R.board[T.row][T.col].card=f,R.board[C.row][C.col].card=E,R.board=xe(R),R})},[e]),d=x.useCallback((T,C,h)=>{e(R=>{if(!R.isGameStarted)return R;const E=he(R),f=E.board[T.row][T.col].card,m=E.board[C.row][C.col].card;if(f&&m&&f.statuses){const A=f.statuses.findIndex(w=>w.type===h);if(A>-1){const[w]=f.statuses.splice(A,1);m.statuses||(m.statuses=[]),m.statuses.push(w)}}return E.board=xe(E),E})},[e]),l=x.useCallback((T,C)=>{e(h=>{if(!h.isGameStarted)return h;const R=he(h),E=R.board[T.row][T.col].card,f=R.board[C.row][C.col].card,m=["Support","Threat","LastPlayed"];if(E&&f&&E.statuses){const A=E.statuses.filter(I=>!m.includes(I.type)),w=E.statuses.filter(I=>m.includes(I.type));A.length>0&&(f.statuses||(f.statuses=[]),f.statuses.push(...A),E.statuses=w)}return R.board=xe(R),R})},[e]),g=x.useCallback((T,C,h)=>{e(R=>{if(!R.isGameStarted)return R;const E=he(R);if(!r)return R;const f=r.tokenDatabase,m=Object.keys(f).find(I=>f[I].name===C);if(!m)return R;const A=f[m],w=E.players.find(I=>I.id===h);if(A&&E.board[T.row][T.col].card===null){const I={id:`TKN_${C.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:Re.Tokens,name:C,baseId:A.baseId||m,imageUrl:A.imageUrl,fallbackImage:A.fallbackImage,power:A.power,ability:A.ability,flavorText:A.flavorText,color:A.color,types:A.types||["Unit"],faction:"Tokens",ownerId:h,ownerName:w==null?void 0:w.name,enteredThisTurn:!0,statuses:[]};yr(I,h),E.board[T.row][T.col].card=I}return E.board=xe(E),E})},[e,r]);return{markAbilityUsed:n,applyGlobalEffect:o,swapCards:i,transferStatus:d,transferAllCounters:l,spawnToken:g,resetDeployStatus:a,removeStatusByType:s}};function Qs(t){const{updateState:e,localPlayerIdRef:r,updatePlayerScore:n}=t,a=x.useCallback((o,i)=>{e(d=>{var E,f,m,A,w,I;if(!d.isGameStarted||i.target==="board"&&i.boardCoords&&d.board[i.boardCoords.row][i.boardCoords.col].card!==null&&o.source!=="counter_panel")return d;let l=!1;try{const u=localStorage.getItem("auto_abilities_enabled");l=u===null?!0:u==="true"}catch{l=!0}const g=l&&d.currentPhase===1&&o.source==="hand"&&i.target==="board"&&(((E=o.card.types)==null?void 0:E.includes("Unit"))||((f=o.card.types)==null?void 0:f.includes("Command"))),T=he(d);if(o.source==="board"&&["hand","deck","discard"].includes(i.target)&&!o.bypassOwnershipCheck){const u=o.card.ownerId,p=T.players.find(O=>O.id===u),_=u===r.current,D=!!(p!=null&&p.isDummy);if(!_&&!D)return d}let C=null;if(o.source==="board"&&i.target==="board"&&o.boardCoords){const u=T.board[o.boardCoords.row][o.boardCoords.col];u.card&&(C=u.card);const _=d.board[o.boardCoords.row][o.boardCoords.col].card||C;if(_&&((m=_.statuses)==null?void 0:m.some(O=>O.type==="Stun"))){const O=r.current,P=_.ownerId,b=d.players.find(N=>N.id===O),L=d.players.find(N=>N.id===P),U=O===P,F=(b==null?void 0:b.teamId)!==void 0&&(L==null?void 0:L.teamId)!==void 0&&b.teamId===L.teamId;if((U||F)&&!o.isManual)return d}}if(o.source==="counter_panel"&&o.statusType){const u=dt[o.statusType],p=(u==null?void 0:u.allowedTargets)??["board","hand"];if(!p.includes(i.target)&&!p.includes("board-facedown"))return d;let _=null;if(i.target==="board"&&i.boardCoords){if(_=T.board[i.boardCoords.row][i.boardCoords.col].card,p.includes("board-facedown")&&_&&!_.isFaceDown)return d}else if(i.playerId!==void 0){const D=T.players.find(O=>O.id===i.playerId);D&&(i.target==="hand"&&i.cardIndex!==void 0&&(_=D.hand[i.cardIndex]),i.target==="announced"&&(_=D.announcedCard||null),i.target==="deck"&&D.deck.length>0?i.deckPosition==="top"||!i.deckPosition?_=D.deck[0]:_=D.deck[D.deck.length-1]:i.target==="discard"&&D.discard.length>0&&(_=D.discard[D.discard.length-1]))}if(_){if(o.statusType==="Stun"&&(_.baseId==="luciusTheImmortal"||_.name.includes("Lucius")&&((A=_.types)!=null&&A.includes("Hero"))))return T;const D=o.count||1;let O;if(o.ownerId!==void 0)O=o.ownerId;else if(o.card.ownerId!==void 0)O=o.card.ownerId;else{const P=T.players.find(b=>b.id===T.activePlayerId);O=P!=null&&P.isDummy?P.id:r.current!==null?r.current:0}if(o.statusType==="Revealed"&&(i.target==="board"&&_.ownerId===O||i.target==="hand"&&i.playerId===O))return d;if(o.statusType==="Power+")_.powerModifier===void 0&&(_.powerModifier=0),_.powerModifier+=1*D;else if(o.statusType==="Power-")_.powerModifier===void 0&&(_.powerModifier=0),_.powerModifier-=1*D;else if(o.statusType==="Revealed"&&i.target==="hand"){if(_.revealedTo||(_.revealedTo=[]),_.revealedTo!=="all"){const b=Array.isArray(_.revealedTo)?_.revealedTo:[];b.includes(O)||b.push(O),_.revealedTo=b}_.statuses||(_.statuses=[]),_.statuses.some(b=>b.type==="Revealed"&&b.addedByPlayerId===O)||_.statuses.push({type:"Revealed",addedByPlayerId:O})}else if(_.statuses||(_.statuses=[]),o.replaceStatusType&&o.statusType)for(let P=0;P<D;P++){const b=_.statuses.findIndex(L=>L.type===o.replaceStatusType&&L.addedByPlayerId===O);b!==-1?_.statuses[b]={type:o.statusType,addedByPlayerId:O}:_.statuses.push({type:o.statusType,addedByPlayerId:O})}else for(let P=0;P<D;P++)["Support","Threat","Revealed"].includes(o.statusType)?_.statuses.some(L=>L.type===o.statusType&&L.addedByPlayerId===O)||_.statuses.push({type:o.statusType,addedByPlayerId:O}):_.statuses.push({type:o.statusType,addedByPlayerId:O});return i.target==="board"&&(T.board=xe(T)),T}return d}const h=C?{...C}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const u=T.players.find(p=>p.id===o.playerId);if(u){const p=u.hand[o.cardIndex];if(p&&p.id===o.card.id&&p.ownerId===o.card.ownerId)u.hand.splice(o.cardIndex,1);else{const _=u.hand.findIndex(D=>D.id===o.card.id&&D.ownerId===o.card.ownerId);if(_!==-1)u.hand.splice(_,1);else return d}}}else if(o.source==="board"&&o.boardCoords){const u=T.board[o.boardCoords.row][o.boardCoords.col];if(u.card&&u.card.id===o.card.id&&u.card.ownerId===o.card.ownerId)T.board[o.boardCoords.row][o.boardCoords.col].card=null;else return d}else if(o.source==="discard"&&o.playerId!==void 0){const u=T.players.find(p=>p.id===o.playerId);if(u){let p=!1;if(o.cardIndex!==void 0){const _=u.discard[o.cardIndex];_&&_.id===o.card.id&&_.ownerId===o.card.ownerId&&(u.discard.splice(o.cardIndex,1),p=!0)}if(!p){const _=u.discard.findIndex(D=>D.id===o.card.id&&D.ownerId===o.card.ownerId);if(_!==-1)u.discard.splice(_,1);else return d}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const u=T.players.find(p=>p.id===o.playerId);if(u){const p=u.deck[o.cardIndex];if(p&&p.id===o.card.id&&p.ownerId===o.card.ownerId)u.deck.splice(o.cardIndex,1);else{const _=u.deck.findIndex(D=>D.id===o.card.id&&D.ownerId===o.card.ownerId);if(_!==-1)u.deck.splice(_,1);else return d}}}else if(o.source==="announced"&&o.playerId!==void 0){const u=T.players.find(p=>p.id===o.playerId);if(u)if(u.announcedCard&&u.announcedCard.id===o.card.id)u.announcedCard=null;else return d}if(["hand","deck","discard"].includes(i.target))h.statuses&&(h.statuses=h.statuses.filter(u=>u.type==="Revealed")),h.isFaceDown=!1,delete h.powerModifier,delete h.bonusPower,delete h.enteredThisTurn;else if(i.target==="board"&&(h.statuses||(h.statuses=[]),o.source!=="board"&&h.isFaceDown===void 0&&(h.isFaceDown=!1),o.source!=="board")){h.enteredThisTurn=!0;let u=h.ownerId;u===void 0&&(o.source==="token_panel"?o.ownerId!==void 0?u=o.ownerId:u=T.activePlayerId??r.current??0:o.playerId!==void 0?u=o.playerId:u=r.current??0,h.ownerId=u),yr(h,u),o.source==="discard"&&(h.baseId==="luciusTheImmortal"||h.name.includes("Lucius"))&&(h.powerModifier===void 0&&(h.powerModifier=0),h.powerModifier+=2)}if(i.target==="hand"&&i.playerId!==void 0){if(h.deck===Re.Tokens)return T.board[o.boardCoords.row][o.boardCoords.col].card=null,T;Jt(h);const p=T.players.find(D=>D.id===i.playerId);if(!p)return d;let _=i.cardIndex!==void 0?i.cardIndex:p.hand.length;if(o.source==="hand"&&o.playerId===i.playerId&&o.cardIndex!==void 0&&(o.cardIndex<_&&(_-=1),o.cardIndex===_))return d;p.hand.splice(_,0,h)}else if(i.target==="board"&&i.boardCoords){if(T.board[i.boardCoords.row][i.boardCoords.col].card===null){if(h.ownerId===void 0&&r.current!==null){const u=T.players.find(p=>p.id===r.current);u&&(h.ownerId=u.id,h.ownerName=u.name)}if(o.source!=="board"&&h.ownerId!==void 0){const u=T.players.find(p=>p.id===h.ownerId);u&&(u.boardHistory||(u.boardHistory=[]),u.boardHistory.push(h.id))}T.board[i.boardCoords.row][i.boardCoords.col].card=h}}else if(i.target==="discard"&&i.playerId!==void 0){if(h.deck===Re.Tokens)return T.board[o.boardCoords.row][o.boardCoords.col].card=null,T;Jt(h);const p=T.players.find(_=>_.id===i.playerId);p&&(h.ownerId===void 0&&(h.ownerId=i.playerId,h.ownerName=p.name),p.discard.some(D=>D.id===h.id)||p.discard.push(h))}else if(i.target==="deck"&&i.playerId!==void 0){if(h.deck===Re.Tokens)return T.board[o.boardCoords.row][o.boardCoords.col].card=null,T;Jt(h);const p=T.players.find(_=>_.id===i.playerId);if(!p)return d;h.ownerId===void 0&&(h.ownerId=i.playerId,h.ownerName=p.name),i.deckPosition==="top"||!i.deckPosition?p.deck.unshift(h):p.deck.push(h)}else if(i.target==="announced"&&i.playerId!==void 0){const u=T.players.find(p=>p.id===i.playerId);u&&(u.announcedCard&&(u.announcedCard.statuses&&(u.announcedCard.statuses=u.announcedCard.statuses.filter(p=>p.type==="Revealed")),delete u.announcedCard.enteredThisTurn,delete u.announcedCard.powerModifier,delete u.announcedCard.bonusPower,u.hand.push(u.announcedCard)),u.announcedCard=h)}if(o.source==="board"&&i.target!=="board"&&h.ownerId!==void 0){const u=T.players.find(p=>p.id===h.ownerId);u&&(u.boardHistory||(u.boardHistory=[]),u.boardHistory=u.boardHistory.filter(p=>p!==h.id))}if((o.source==="board"||i.target==="board")&&h.ownerId!==void 0){const u=T.players.find(p=>p.id===h.ownerId);u&&Ia(T.board,u)}if(o.source==="hand"&&i.target==="board"){const u=h;if(u.revealedTo==="all"||((w=u.statuses)==null?void 0:w.some(_=>_.type==="Revealed"))){const _=T.board.length;for(let D=0;D<_;D++)for(let O=0;O<_;O++){const P=T.board[D][O].card;if(P&&P.name.toLowerCase().includes("vigilant spotter")&&P.ownerId!==u.ownerId&&(T.board=xe(T),(I=T.board[D][O].card.statuses)!=null&&I.some(L=>L.type==="Support"))){const L=T.players.find(U=>U.id===P.ownerId);L&&setTimeout(()=>{n(L.id,2)},0)}}}}return(o.source==="board"||i.target==="board")&&(T.board=xe(T)),g&&(T.currentPhase=2),T})},[e,r,n]),s=x.useCallback((o,i)=>{e(d=>{if(!d.isGameStarted)return d;const l=he(d),g=l.board.length;if(o.row<0||o.row>=g||o.col<0||o.col>=g||i.row<0||i.row>=g||i.col<0||i.col>=g)return d;const T=l.board[o.row][o.col],C=l.board[i.row][i.col],h=T.card,R=C.card;return!h||!R?d:(l.board[o.row][o.col].card=R,l.board[i.row][i.col].card=h,l.board=xe(l),l)})},[e]);return{moveItem:a,swapBoardCards:s}}function ei(t){const{ws:e,webrtcManager:r,gameStateRef:n,webrtcIsHostRef:a,setGameState:s}=t,o=x.useCallback((d,l,g,T,C,h)=>{var w,I,u,p,_,D,O;const R=n.current;if(typeof l!="number"){c.error(`[TargetingMode] Invalid playerId type: ${typeof l}, value:`,l);return}let E=[];T?E=T:E=Wt(d,R,l,C);let f=[];if(h)f=h;else if(f=[],(w=d.payload)!=null&&w.filter&&d.mode==="SELECT_TARGET"){c.info("[TargetingMode] Calculating hand targets for action",{actionMode:d.mode,filterType:typeof d.payload.filter,hasActionType:!!d.payload.actionType});for(const P of R.players)P.hand&&P.hand.forEach((b,L)=>{try{d.payload.filter(b)&&(f.push({playerId:P.id,cardIndex:L}),c.debug(`[TargetingMode] Found hand target: player ${P.id}, card ${L}, card ${b.name}`))}catch(U){c.warn(`[TargetingMode] Filter failed for card ${b.name}:`,U)}});c.info(`[TargetingMode] Hand targets calculated: ${f.length} targets`)}else c.info("[TargetingMode] No hand targets calculated - no filter or wrong mode",{hasFilter:!!((I=d.payload)!=null&&I.filter),mode:d.mode});const m=d.mode==="SELECT_DECK",A={playerId:l,action:d,sourceCoords:g,timestamp:Date.now(),boardTargets:E,handTargets:f.length>0?f:void 0,isDeckSelectable:m||void 0,originalOwnerId:d.originalOwnerId};if(s(P=>({...P,targetingMode:A})),n.current.targetingMode=A,((u=e.current)==null?void 0:u.readyState)===WebSocket.OPEN&&R.gameId&&e.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:R.gameId,targetingMode:A})),r.current)if(a.current)r.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((_=(p=r.current).getPeerId)==null?void 0:_.call(p))??void 0,data:{targetingMode:A},timestamp:Date.now()});else{const P=r.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((O=(D=r.current).getPeerId)==null?void 0:O.call(D))??void 0,data:{targetingMode:A},timestamp:Date.now()});c.info("[TargetingMode] Guest sent SET_TARGETING_MODE to host",{success:P,playerId:l,boardTargetsCount:E.length,handTargetsCount:f.length})}c.info(`[TargetingMode] Player ${l} (type: ${typeof l}) activated targeting mode`,{mode:d.mode,boardTargetsCount:E.length,handTargetsCount:f.length,isDeckSelectable:m||!1})},[e,r,n,a,s]),i=x.useCallback(()=>{var l,g,T,C,h;const d=n.current;s(R=>({...R,targetingMode:null})),n.current.targetingMode=null,((l=e.current)==null?void 0:l.readyState)===WebSocket.OPEN&&d.gameId&&e.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:d.gameId})),r.current&&(a.current?r.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((T=(g=r.current).getPeerId)==null?void 0:T.call(g))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):r.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((h=(C=r.current).getPeerId)==null?void 0:h.call(C))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[e,r,n,a,s]);return{setTargetingMode:o,clearTargetingMode:i}}function ti(t){const{webrtcManagerRef:e,webrtcIsHostRef:r,setWebrtcIsHost:n,setConnectionStatus:a,setWebrtcHostId:s,gameStateRef:o,localPlayerIdRef:i}=t,d=x.useCallback(async()=>{var R;try{n(!0),a("Connecting");const E=lr();e.current=E;const f=await E.initializeAsHost();s(f),a("Connected");const m=o.current.gameId;m&&cr(f,m);const A=(R=o.current.players)==null?void 0:R.find(w=>w.id===i.current);return cs({peerId:f,isHost:!0,playerName:(A==null?void 0:A.name)||null}),c.info("[initializeWebrtcHost] Saved host data for auto-restore"),f}catch(E){return c.error("Failed to initialize WebRTC host:",E),a("Disconnected"),null}},[n,a,s,o,i,e]),l=x.useCallback(async R=>{try{n(!1),s(R),a("Connecting");const E=lr();return e.current=E,await E.initializeAsGuest(R),!0}catch(E){return c.error("Failed to connect as guest:",E),a("Disconnected"),!1}},[n,a,s,e]),g=x.useCallback((R,E)=>e.current?r.current?(c.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):e.current.sendAction(R,E):(c.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[e,r]),T=x.useCallback(R=>!e.current||r.current?(c.warn("[requestDeckView] Only guests can request deck view from host"),!1):e.current.sendAction("REQUEST_DECK_VIEW",{targetPlayerId:R}),[e,r]),C=x.useCallback((R,E,f)=>!e.current||r.current?(c.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):e.current.sendFullDeckToHost(R,E,f),[e,r]),h=x.useCallback((R,E)=>!e.current||!r.current?(c.warn("[shareHostDeckWithGuests] Only host can share deck data"),!1):e.current.broadcastToGuests({type:"HOST_DECK_DATA",senderId:e.current.getPeerId(),data:{deck:R,deckSize:E},timestamp:Date.now()}),[e,r]);return{initializeWebrtcHost:d,connectAsGuest:l,sendWebrtcAction:g,requestDeckView:T,sendFullDeckToHost:C,shareHostDeckWithGuests:h}}function ri(){const t=localStorage.getItem("custom_ws_url");if(!t||t.trim()==="")return c.warn("No custom WebSocket URL configured in settings."),null;let e=t.trim();return e.endsWith("/")&&(e=e.slice(0,-1)),e.startsWith("https://")?e=e.replace("https://","wss://"):e.startsWith("http://")&&(e=e.replace("http://","ws://")),!e.startsWith("ws://")&&!e.startsWith("wss://")?(c.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",e),e)}function ni(t){const{gameStateRef:e,localPlayerIdRef:r,setGameState:n,setLocalPlayerId:a,setConnectionStatus:s,setGamesList:o,setLatestHighlight:i,setLatestNoTarget:d,setLatestDeckSelections:l,setLatestHandCardSelections:g,setClickWaves:T,setLatestFloatingTexts:C,setRemoteValidTargets:h,isManualExitRef:R,joiningGameIdRef:E,playerTokenRef:f,receivedServerStateRef:m,isJoinAttemptRef:A}=t,w=x.useRef(null),I=x.useRef(null),u=x.useCallback(()=>{if(ve()){s("Connected");return}if(R.current||w.current&&(w.current.readyState===WebSocket.OPEN||w.current.readyState===WebSocket.CONNECTING))return;const L=ri();if(!L){c.warn("No WebSocket URL configured in settings. Waiting for user input."),s("Disconnected"),I.current&&clearTimeout(I.current);return}try{w.current=new WebSocket(L)}catch(U){c.error("Failed to create WebSocket:",U),s("Disconnected"),I.current&&clearTimeout(I.current),I.current=window.setTimeout(u,ae.RECONNECT_DELAY);return}s("Connecting"),w.current.onopen=()=>{var N;m.current=!1,s("Connected");const U=localStorage.getItem("custom_ws_url");U&&U.trim()!==""&&localStorage.setItem("websocket_url",U.trim());const F=e.current;if(c.info("Current gameState on open:",F?`gameId=${F.gameId}`:"null"),c.info("playerTokenRef.current on open:",f.current?"YES":"NO"),F&&F.gameId&&((N=w.current)==null?void 0:N.readyState)===WebSocket.OPEN){let G=f.current;if(!G){try{const $=localStorage.getItem(ot);if($){const q=JSON.parse($);c.info("RECONNECTION_DATA_KEY:",q==null?void 0:q.gameId,F.gameId),q!=null&&q.playerToken&&(G=q.playerToken,f.current=G,c.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch($){console.warn("Failed to parse reconnection data:",$ instanceof Error?$.message:String($))}if(!G&&F.players&&r.current){const $=F.players.find(q=>q.id===r.current);$!=null&&$.playerToken&&(G=$.playerToken,f.current=G)}}c.info("JoinGame: Sending reconnection with token:",G?"YES":"NO","gameId:",F.gameId),w.current.send(JSON.stringify({type:"JOIN_GAME",gameId:F.gameId,playerToken:G}))}},w.current.onmessage=U=>{var F;try{const N=JSON.parse(U.data);if(N.type==="GAMES_LIST")o(N.games);else if(N.type==="JOIN_SUCCESS"){if(N.isSpectator){a(null),c.info("Joined as spectator:",N.message||"Spectator mode"),E.current=null;return}a(N.playerId);const G=E.current||e.current.gameId;G&&N.playerId!==null&&N.playerToken?(f.current=N.playerToken,localStorage.setItem(ot,JSON.stringify({gameId:G,playerId:N.playerId,playerToken:N.playerToken,timestamp:Date.now()})),e.current.gameId===G&&jn(e.current,N.playerId,N.playerToken)):N.playerId===null&&(ht(),f.current=void 0),E.current=null,N.playerId===1&&setTimeout(()=>{var $;(($=w.current)==null?void 0:$.readyState)===WebSocket.OPEN&&w.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:qe}))},ae.DECK_SYNC_DELAY)}else if(N.type==="CONNECTION_ESTABLISHED"){c.info("Connection acknowledged by server");const G=sessionStorage.getItem("pending_invite_game"),$=sessionStorage.getItem("pending_invite_name");G&&w.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),c.info("Auto-joining invite game:",G),w.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:G,playerName:$||"Player"})))}else if(N.type==="DECK_DATA_UPDATED")c.info("Deck data synced with server");else if(N.type==="ERROR")if(N.message.includes("not found")||N.message.includes("Dummy")){c.info("Game not found error - clearing state");const G=at();n(G),e.current=G,a(null),ht(),E.current=null}else if(N.message.includes("already started")&&A.current){c.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const G=at();n(G),e.current=G,a(null),ht(),E.current=null,A.current=!1}else console.warn("Server Error:",N.message);else if(N.type==="HIGHLIGHT_TRIGGERED")i(N.highlightData);else if(N.type==="NO_TARGET_TRIGGERED")d({coords:N.coords,timestamp:N.timestamp});else if(N.type==="DECK_SELECTION_TRIGGERED")l(G=>[...G,N.deckSelectionData]),setTimeout(()=>{l(G=>G.filter($=>$.timestamp!==N.deckSelectionData.timestamp))},1e3);else if(N.type==="HAND_CARD_SELECTION_TRIGGERED")g(G=>[...G,N.handCardSelectionData]),setTimeout(()=>{g(G=>G.filter($=>$.timestamp!==N.handCardSelectionData.timestamp))},1e3);else if(N.type==="FLOATING_TEXT_TRIGGERED")n(G=>({...G,floatingTexts:[...G.floatingTexts,N.floatingTextData].filter($=>Date.now()-$.timestamp<ae.FLOATING_TEXT_DURATION)}));else if(N.type==="FLOATING_TEXT_BATCH_TRIGGERED")n(G=>({...G,floatingTexts:[...G.floatingTexts,...N.batch].filter($=>Date.now()-$.timestamp<ae.FLOATING_TEXT_DURATION)}));else if(N.type==="CLICK_WAVE_TRIGGERED")N.wave&&N.wave.clickedByPlayerId!==r.current&&(T(G=>[...G,N.wave]),setTimeout(()=>{T(G=>G.filter($=>$.timestamp!==N.wave.timestamp))},600));else if(N.type==="TARGETING_MODE_SET"){const G=N.targetingMode;if(G){n(q=>({...q,targetingMode:G})),e.current.targetingMode=G;const $=G.mode||((F=G.action)==null?void 0:F.mode);c.info("[TargetingMode] Received targeting mode from server",{playerId:G.playerId,mode:$})}}else if(N.type==="TARGETING_MODE_CLEARED")n(G=>({...G,targetingMode:null})),e.current.targetingMode=null,c.debug("[TargetingMode] Cleared targeting mode from server");else if(N.type==="ABILITY_MODE_SET")N.abilityMode&&(n(G=>({...G,abilityMode:N.abilityMode})),c.info("[AbilityMode] Received ability mode from host",{playerId:N.abilityMode.playerId,mode:N.abilityMode.mode,sourceCard:N.abilityMode.sourceCardName}));else if(N.type==="ABILITY_TARGET_SELECTED")c.info("[Ability] Target selected",N.data);else if(N.type==="ABILITY_COMPLETED")n(G=>({...G,abilityMode:void 0})),c.info("[Ability] Ability completed",N.data);else if(N.type==="ABILITY_CANCELLED")n(G=>({...G,abilityMode:void 0})),c.info("[Ability] Ability cancelled");else if(N.type==="GAME_RESET")c.info("[GameReset] Received GAME_RESET message from server"),n(G=>{const $=N.activeGridSize||8,q=[];for(let X=0;X<$;X++){const se=[];for(let me=0;me<$;me++)se.push({card:null});q.push(se)}const Z={...G,players:N.players||[],gameMode:N.gameMode,isPrivate:N.isPrivate,activeGridSize:N.activeGridSize,dummyPlayerCount:N.dummyPlayerCount,autoAbilitiesEnabled:N.autoAbilitiesEnabled,isGameStarted:N.isGameStarted,currentPhase:N.currentPhase,currentRound:N.currentRound,turnNumber:N.turnNumber,activePlayerId:N.activePlayerId,startingPlayerId:N.startingPlayerId,roundWinners:N.roundWinners||{},gameWinner:N.gameWinner,isRoundEndModalOpen:N.isRoundEndModalOpen,isReadyCheckActive:N.isReadyCheckActive,board:q,targetingMode:null,floatingTexts:[]};return e.current=Z,Z});else if(!N.type&&N.players&&N.board){const G=Nt(N),$=e.current;if(!$.isScoringStep&&G.isScoringStep&&G.currentPhase!==2){c.debug("Ignoring delayed scoring state update");return}if($.isScoringStep&&(G.currentPhase!==$.currentPhase||G.activePlayerId!==$.activePlayerId||G.currentPhase!==4)&&(G.isScoringStep=!1),n(G),e.current=G,r.current!==null&&G.gameId){let Z;try{const X=localStorage.getItem(ot);X&&(Z=JSON.parse(X).playerToken)}catch{}if(!Z&&G.players){const X=G.players.find(se=>se.id===r.current);X!=null&&X.playerToken&&(Z=X.playerToken,f.current=Z)}jn(G,r.current,Z)}}else console.warn("Unknown message type:",N.type,"keys:",Object.keys(N),"data:",N)}catch(N){c.error("Failed to parse message from server:",U.data,N)}},w.current.onclose=()=>{s("Disconnected"),R.current||(I.current&&clearTimeout(I.current),I.current=window.setTimeout(u,ae.RECONNECT_DELAY))},w.current.onerror=U=>c.error("WebSocket error event:",U)},[n,s,o,i,d,l,g,T,C,h,a,at,R,e,r,f,m,E]),p=x.useCallback(()=>{w.current&&(w.current.readyState===WebSocket.OPEN||w.current.readyState===WebSocket.CONNECTING)?w.current.close():u()},[w,u]),_=x.useCallback(L=>{var U;if(R.current=!1,((U=w.current)==null?void 0:U.readyState)===WebSocket.OPEN){E.current=L;let F=null;try{const G=localStorage.getItem(ot);G&&(F=JSON.parse(G))}catch{ht()}const N={type:"JOIN_GAME",gameId:L};(F==null?void 0:F.gameId)===L&&F.playerToken?(N.playerToken=F.playerToken,c.info(`JoinGame: Sending reconnection with token ${F.playerToken.substring(0,8)}... for player ${F.playerId}`)):c.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${F==null?void 0:F.gameId}, requestedGameId=${L}`),w.current.send(JSON.stringify(N))}else u(),E.current=L},[w,R,E,u]),D=x.useCallback((L,U="Player")=>{var F;R.current=!1,((F=w.current)==null?void 0:F.readyState)===WebSocket.OPEN?w.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:L,playerName:U})):(sessionStorage.setItem("pending_invite_game",L),sessionStorage.setItem("pending_invite_name",U),u())},[u]),O=x.useCallback(()=>{R.current=!1,ht();const L=Ea(),U={...at(),gameId:L,players:[Ta(1)]};return m.current=!0,setTimeout(()=>{var F;((F=w.current)==null?void 0:F.readyState)===WebSocket.OPEN&&(w.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:L})),w.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:qe})))},ae.DECK_SYNC_DELAY),{gameId:L,initialState:U}},[R,m]),P=x.useCallback(()=>{var L;((L=w.current)==null?void 0:L.readyState)===WebSocket.OPEN&&w.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[w]),b=x.useCallback((L,U,F,N)=>{var q;if(L.current)return;R.current=!0;const G=e.current.gameId,$=r.current;G&&U.current&&F(G);try{N(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),c.info("[exitGame] Cleared WebRTC persistence data")}catch(Z){c.warn("[exitGame] Failed to clear WebRTC data:",Z)}n(at()),a(null),ht(),w.current&&(w.current.onclose=null),((q=w.current)==null?void 0:q.readyState)===WebSocket.OPEN&&G&&$!==null&&w.current.send(JSON.stringify({type:"EXIT_GAME",gameId:G,playerId:$})),w.current&&w.current.close(),setTimeout(()=>{R.current=!1,u()},ae.RECONNECT_DELAY)},[e,r,R,n,a,w,u]);return{ws:w,reconnectTimeoutRef:I,connectWebSocket:u,forceReconnect:p,createGame:O,joinGame:_,joinAsInvite:D,exitGame:b,requestGamesList:P}}const Qe=new Map,id=(t={})=>{const{abilityMode:e,setAbilityMode:r}=t,[n,a]=x.useState(at()),s=x.useRef(at()),o=x.useCallback(y=>{a(ne=>{const ee=typeof y=="function"?y(ne):y;return s.current=ne,ve()&&V.current&&setTimeout(()=>{Y.current&&(Y.current.broadcastGameState(ee),c.debug(`[setGameStateWithDelta] Broadcast state: phase=${ee.currentPhase}, round=${ee.currentRound}`))},0),ee})},[]),[i,d]=x.useState(null),l=x.useRef(n),g=x.useRef(i),[T,C]=x.useState(null),[h,R]=x.useState("Connecting"),[E,f]=x.useState([]),[m,A]=x.useState(null),[w,I]=x.useState(null),[u,p]=x.useState(null),[_,D]=x.useState([]),[O,P]=x.useState([]),[b,L]=x.useState([]),[U,F]=x.useState(null),[N,G]=x.useState(!!qe),[$,q]=x.useState(!1),[Z,X]=x.useState(null),[se,me]=x.useState(!1),V=x.useRef(!1),[Ae,Le]=x.useState(!1),[we,Te]=x.useState(null),Ne=x.useRef(!1),He=x.useRef(null),tt=x.useRef(!1),zt=x.useRef(!1),lt=x.useRef(),Se=x.useRef(!1),Y=x.useRef(null),je=x.useRef(new Map),ut=x.useRef(()=>{}),Mt=ti({webrtcManagerRef:Y,webrtcIsHostRef:V,setWebrtcIsHost:me,setConnectionStatus:R,setWebrtcHostId:X,gameStateRef:l,localPlayerIdRef:g}),{initializeWebrtcHost:Tt,connectAsGuest:Kt,sendWebrtcAction:gt,requestDeckView:rt,sendFullDeckToHost:wr,shareHostDeckWithGuests:Lt}=Mt,wt=ni({gameStateRef:l,localPlayerIdRef:g,setGameState:a,setLocalPlayerId:d,setConnectionStatus:R,setGamesList:f,setLatestHighlight:A,setLatestNoTarget:p,setLatestDeckSelections:D,setLatestHandCardSelections:P,setClickWaves:L,setLatestFloatingTexts:I,setRemoteValidTargets:F,isManualExitRef:tt,joiningGameIdRef:He,playerTokenRef:lt,receivedServerStateRef:Se,isJoinAttemptRef:zt}),{ws:Ce,reconnectTimeoutRef:ft,connectWebSocket:_r,forceReconnect:ga,joinGame:br,joinAsInvite:wa,requestGamesList:_a}=wt;x.useEffect(()=>{ut.current=o},[o]),x.useEffect(()=>{V.current=se},[se]),x.useEffect(()=>{const y=ve();if(q(y),y){Y.current=lr();const ne=Y.current.on(ee=>{ka(ee)});return()=>{ne()}}},[]),x.useEffect(()=>{if(!ve())return;const ne=window.location.hash.slice(1);if(ne&&new URLSearchParams(ne).get("hostId"))return;const ee="webrtc_auto_restore_attempted";if(sessionStorage.getItem(ee))return;sessionStorage.setItem(ee,"true");const te=ls();if(te==="none"){sessionStorage.removeItem(ee);return}setTimeout(async()=>{var de,re;if(!Y.current){c.warn("[Auto-restore] WebRTC manager not ready");return}try{if(te==="host"){Ve.current=!0,c.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ie=sa(),J=Hn();if(!ie||!J){c.warn("[Auto-restore] Missing host data or state data"),nt(),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}c.info(`[Auto-restore] Restoring host session: old peerId=${ie.peerId}`);const Ee=await Y.current.initializeAsHost();V.current=!0,me(!0),X(Ee),R("Connected"),(de=J.gameState)!=null&&de.gameId&&(cr(Ee,J.gameState.gameId),c.info(`[Auto-restore] Broadcasted NEW host peerId ${Ee} for game ${J.gameState.gameId}`)),(J.gameState||J.localPlayerId!==null)&&(J.gameState&&(l.current=J.gameState),J.localPlayerId!==null&&(g.current=J.localPlayerId),Ne.current=!0,setTimeout(()=>{Ne.current=!1},1e4),setTimeout(()=>{var _e;J.gameState&&(a(J.gameState),c.info(`[Auto-restore] Restored game state with ${((_e=J.gameState.players)==null?void 0:_e.length)||0} players, gameId=${J.gameState.gameId}`)),J.localPlayerId!==null&&(d(J.localPlayerId),c.info(`[Auto-restore] Restored local player ID: ${J.localPlayerId}`))},0)),setTimeout(()=>{if(Ve.current=!1,c.info("[Auto-restore] Cleared restoration flag"),Y.current&&J.gameState){const _e=J.gameState.players.filter(Ue=>!Ue.isDummy&&Ue.id!==J.localPlayerId);_e.length>0&&(c.info(`[Auto-restore] Requesting deck data from ${_e.length} guest players`),Y.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:Y.current.getPeerId(),timestamp:Date.now()}))}},500),c.info("[Auto-restore] Host session restoration initiated")}else if(te==="guest"){Ve.current=!0,c.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ie=ia(),J=Hn();if(!ie||!J){c.warn("[Auto-restore] Missing guest data or state data"),nt(),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}c.info(`[Auto-restore] Restoring guest session: old hostPeerId=${ie.hostPeerId}, playerId=${ie.playerId}`),V.current=!1,me(!1),R("Connecting");let Ee=ie.hostPeerId;if((re=J.gameState)!=null&&re.gameId){const _e=Zt(J.gameState.gameId);_e&&_e.peerId&&(Ee=_e.peerId,c.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Ee}`))}if(X(Ee),ie.playerId!==null){c.info(`[Auto-restore] Reconnecting as existing player ${ie.playerId} to host ${Ee}`);try{await Y.current.initializeAsReconnectingGuest(Ee,ie.playerId),R("Connected"),c.info("[Auto-restore] Successfully reconnected to host")}catch(_e){c.error("[Auto-restore] Failed to reconnect to host:",_e),R("Disconnected"),nt(),c.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else c.info("[Auto-restore] Connecting as new player"),await Y.current.initializeAsGuest(Ee),R("Connected");(J.gameState||J.localPlayerId!==null)&&(J.gameState&&(l.current=J.gameState),J.localPlayerId!==null&&(g.current=J.localPlayerId),Ne.current=!0,setTimeout(()=>{Ne.current=!1},1e4),setTimeout(()=>{var _e,Ue;if(J.gameState&&(a(J.gameState),c.info(`[Auto-restore] Restored game state with ${((_e=J.gameState.players)==null?void 0:_e.length)||0} players, gameId=${J.gameState.gameId}, isGameStarted=${J.gameState.isGameStarted}`),J.localPlayerId!==null)){const ue=(Ue=J.gameState.players)==null?void 0:Ue.some(fe=>fe.id===J.localPlayerId);c.info(`[Auto-restore] Player ${J.localPlayerId} exists in restored state: ${ue}`)}J.localPlayerId!==null&&(d(J.localPlayerId),c.info(`[Auto-restore] Restored local player ID: ${J.localPlayerId}`))},0)),setTimeout(()=>{Ve.current=!1,c.info("[Auto-restore] Cleared restoration flag")},100),c.info("[Auto-restore] Guest session restoration initiated")}}catch(ie){c.error("[Auto-restore] Failed to restore session:",ie),nt(),Ve.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),x.useEffect(()=>{if(!$||!Y.current)return;const y=window.location.hash.slice(1);if(!y)return;const ee=new URLSearchParams(y).get("hostId");ee&&Kt(ee)},[$]),x.useEffect(()=>{l.current=n},[n]),x.useEffect(()=>{g.current=i},[i]),x.useEffect(()=>{if(!n||!n.players||!i)return;const y=ss(n.players,i);os.preloadMany(y,"low")},[n==null?void 0:n.players,i]);const ba=Bs({ws:Ce,webrtcManager:Y,gameStateRef:l,localPlayerIdRef:g,webrtcIsHostRef:V,setLatestHighlight:A,setLatestFloatingTexts:I,setLatestNoTarget:p,setLatestDeckSelections:D,setLatestHandCardSelections:P,setClickWaves:L,setGameState:a}),{triggerHighlight:Aa,triggerFloatingText:Ar,triggerNoTarget:Sa,triggerDeckSelection:Ca,triggerHandCardSelection:Da,syncValidTargets:Ra,triggerClickWave:Pa}=ba,Ve=x.useRef(!1);x.useEffect(()=>{if(!$||!V.current||!(n!=null&&n.gameId))return;const y=n.gameId,ne=()=>{var de;const te=(de=Y.current)==null?void 0:de.getPeerId();te&&y&&cr(te,y)};ne();const ee=setInterval(ne,2e3);return()=>clearInterval(ee)},[$,n==null?void 0:n.gameId]),x.useEffect(()=>{if(!$||V.current||!(n!=null&&n.gameId))return;const y=n.gameId,ne=de=>{var re;X(de),R("Connecting"),(re=Y.current)==null||re.initializeAsReconnectingGuest(de,g.current||0).then(()=>{R("Connected")}).catch(ie=>{c.error("[Guest Auto-Reconnect] Failed to reconnect:",ie),R("Disconnected")})},ee=de=>{const re=`webrtc_host_${y}`;if(!(de.key!==re||!de.newValue))try{const J=JSON.parse(de.newValue).peerId;J&&J!==Z&&ne(J)}catch(ie){c.error("[Guest Auto-Reconnect] Failed to parse storage event:",ie)}},te=setInterval(()=>{const de=Zt(y);de&&de.peerId!==Z&&(c.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${de.peerId}`),ne(de.peerId))},2e3);return window.addEventListener("storage",ee),()=>{window.removeEventListener("storage",ee),clearInterval(te)}},[$,n==null?void 0:n.gameId,Z]),x.useEffect(()=>{const y=setInterval(()=>{a(ne=>{const ee=Date.now(),te=ne.floatingTexts||[],de=te.filter(re=>ee-re.timestamp<ae.FLOATING_TEXT_DURATION);return de.length!==te.length?{...ne,floatingTexts:de}:ne})},ae.DECK_SYNC_DELAY);return()=>clearInterval(y)},[]);const ka=x.useCallback(y=>{var ne,ee,te;switch(y.type){case"peer_open":(ne=y.data)!=null&&ne.peerId&&(X(y.data.peerId),c.info(`WebRTC peer opened with ID: ${y.data.peerId}`));break;case"guest_connected":c.info("Guest connected via WebRTC:",(ee=y.data)==null?void 0:ee.peerId);break;case"connected_to_host":(te=y.data)!=null&&te.hostPeerId&&Z!==y.data.hostPeerId&&(X(y.data.hostPeerId),c.info(`Updated webrtcHostId to: ${y.data.hostPeerId}`)),R("Connected"),Le(!1),Te(null),Ne.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(c.warn("WebRTC peer disconnected"),R("Disconnected"),Le(!0),!V.current&&Z&&n)try{const re={hostPeerId:Z,playerId:i,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(re)),c.info("[Reconnection] Stored reconnection data before disconnect"),Na(Z)}catch(re){c.error("[Reconnection] Failed to store data:",re)}break;case"message_received":const de=y.data.message||y.data;va(de);break;case"error":c.error("WebRTC error:",y.data);break}},[n,i,Z,se]),Oa=x.useCallback((y,ne)=>{if(c.info(`[handleWebrtcGuestJoin] Called for guest ${y}, isHost: ${V.current}`),!V.current||!Y.current){c.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const ee=(ne==null?void 0:ne.preferredDeck)||"Random";a(te=>{if(!te)return c.error("[handleWebrtcGuestJoin] No previous state"),te;c.info(`[handleWebrtcGuestJoin] Current state has ${te.players.length} players`);const de=te.players.map(ue=>ue.id);let re=1;for(;de.includes(re);)re++;const ie={id:re,name:`Player ${re}`,color:Et[(re-1)%Et.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:ee,boardHistory:[],autoDrawEnabled:!0},J={...te,players:[...te.players,ie]},Ee=te.board.map(ue=>ue.map(fe=>({...fe,card:fe.card?{id:fe.card.id,baseId:fe.card.baseId,ownerId:fe.card.ownerId,name:fe.card.name,imageUrl:fe.card.imageUrl,power:fe.card.power,ability:fe.card.ability,isFaceDown:fe.card.isFaceDown,statuses:fe.card.statuses||[]}:null}))),_e=ue=>ue.map(fe=>({id:fe.id,baseId:fe.baseId,name:fe.name,imageUrl:fe.imageUrl,power:fe.power,powerModifier:fe.powerModifier,ability:fe.ability,ownerId:fe.ownerId,color:fe.color,deck:fe.deck,isFaceDown:fe.isFaceDown,types:fe.types,faction:fe.faction,statuses:fe.statuses}));Y.current.acceptGuestMinimal(y,{playerId:re,gameId:te.gameId,isGameStarted:te.isGameStarted,players:J.players.map(ue=>ue.isDummy?{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,hand:_e(ue.hand||[]),deck:_e(ue.deck||[]),discard:_e(ue.discard||[]),handSize:ue.hand.length,deckSize:ue.deck.length,discardSize:ue.discard.length}:{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,deckSize:ue.deck.length,handSize:ue.hand.length,discardSize:ue.discard.length}),deckSelections:J.players.map(ue=>({id:ue.id,selectedDeck:ue.selectedDeck})),gameMode:te.gameMode,currentRound:te.currentRound,currentPhase:te.currentPhase,activePlayerId:te.activePlayerId,startingPlayerId:te.startingPlayerId,activeGridSize:te.activeGridSize,board:Ee},re),Y.current.broadcastGameState(J,y),Y.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:Y.current.getPeerId(),data:{playerId:re,selectedDeck:ee},timestamp:Date.now()});const Ue=J.players.find(ue=>ue.id===g.current);if(Ue&&Ue.deck.length>0){const ue=Ue.deck.map(fe=>({id:fe.id,baseId:fe.baseId,power:fe.power,powerModifier:fe.powerModifier||0,isFaceDown:fe.isFaceDown||!1,statuses:fe.statuses||[]}));Y.current.sendToGuest(y,{type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:Ue.id,data:{playerId:Ue.id,deckType:Ue.selectedDeck,deck:ue,deckSize:ue.length},timestamp:Date.now()}),c.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${Ue.selectedDeck}, ${ue.length} cards`)}return J})},[]),Sr=x.useCallback(y=>{const ne=V.current;if(c.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!Y.current}, webrtcIsHostRef.current=${ne}`),!Y.current||!ne){c.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}Y.current.broadcastGameState(y)},[]),va=x.useCallback(y=>{var ne,ee,te,de,re,ie,J,Ee,_e,Ue,ue,fe,Rr,Pr,kr,Or,vr,Nr,Mr,Lr,Gr,xr,Ur,$r,Hr,Fr,Wr,Br,Yr,zr,Kr,qr,Vr,jr,Jr,Xr,Zr,Qr,en,tn,rn,nn,an,on,sn,dn,cn,ln,un,fn,pn,yn,hn,mn,In,En,Tn,gn,wn,_n,bn,An,Sn,Cn,Dn,Rn,Pn,kn,On,vn,Nn,Mn,Ln,Gn;if(!(!y||!y.type))switch(c.info(`[handleWebrtcMessage] Received: ${y.type}`),y.type){case"JOIN_ACCEPT_MINIMAL":if(c.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${y.playerId}`),y.data){const S=y.data;c.info(`[handleWebrtcMessage] Creating minimal state with ${((ne=S.players)==null?void 0:ne.length)||0} players`);const k={gameId:S.gameId||Ea(),isGameStarted:S.isGameStarted||!1,isPrivate:!1,activeGridSize:S.activeGridSize||4,gameMode:S.gameMode||fr.FreeForAll,dummyPlayerCount:0,players:((ee=S.players)==null?void 0:ee.map(v=>{if((v.isDummy||!1)&&v.hand&&v.deck&&v.discard)return{id:v.id,name:v.name,color:v.color,isDummy:!0,isReady:v.isReady||!1,score:v.score||0,hand:v.hand||[],deck:v.deck||[],discard:v.discard||[],announcedCard:null,selectedDeck:v.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const B=[],H=[],z=[];for(let M=0;M<(v.handSize||0);M++)B.push({id:`placeholder_${v.id}_hand_${M}`,name:"?",isPlaceholder:!0,ownerId:v.id,deck:v.selectedDeck||"Random",color:v.color});for(let M=0;M<(v.deckSize||0);M++)H.push({id:`placeholder_${v.id}_deck_${M}`,name:"?",isPlaceholder:!0,ownerId:v.id,deck:v.selectedDeck||"Random",color:v.color});for(let M=0;M<(v.discardSize||0);M++)z.push({id:`placeholder_${v.id}_discard_${M}`,name:"?",isPlaceholder:!0,ownerId:v.id,deck:v.selectedDeck||"Random",color:v.color});return{id:v.id,name:v.name,color:v.color,isDummy:!1,isReady:v.isReady||!1,score:v.score||0,hand:B,deck:H,discard:z,announcedCard:null,selectedDeck:v.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:S.board||da(),hostId:1,currentPhase:S.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:S.currentRound||1,turnNumber:S.turnNumber||1,activePlayerId:S.activePlayerId??null,startingPlayerId:S.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};a(k),y.playerId!==void 0&&(d(y.playerId),c.info(`[handleWebrtcMessage] Set local player ID to ${y.playerId}`)),a(v=>{const W=v.players.map(B=>{var z;const H=(z=S.players)==null?void 0:z.find(M=>M.id===B.id);if(B.id===y.playerId){const K=B.deck.length===0||B.deck.some(j=>j.isPlaceholder)||B.deck.length!==30;if(H!=null&&H.selectedDeck&&K){const j=et(H.selectedDeck,B.id,B.name);c.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${j.length} cards from ${H.selectedDeck}`),Y.current&&j.length>0&&setTimeout(()=>{const le=j.map(Q=>({id:Q.id,baseId:Q.baseId,power:Q.power,powerModifier:Q.powerModifier||0,isFaceDown:Q.isFaceDown||!1,statuses:Q.statuses||[]}));Y.current.sendAction("DECK_DATA_UPDATE",{playerId:y.playerId,deck:le,deckSize:le.length}),c.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${H.selectedDeck}, ${le.length} cards`)},0);const oe=[...B.hand],ce=[...j];if(S.isGameStarted&&oe.length===0&&ce.length>0){for(let Q=0;Q<6&&Q<ce.length;Q++){const Ie=ce[0];ce.splice(0,1),oe.push(Ie)}c.info(`[JOIN_ACCEPT_MINIMAL] Drew ${oe.length} cards, deck now has ${ce.length} cards`)}return{...B,deck:ce,hand:oe,selectedDeck:H.selectedDeck}}}return B});return{...v,players:W}});try{const v=(te=Y.current)==null?void 0:te.getHostPeerId();v&&Xt({hostPeerId:v,playerId:y.playerId,playerName:((de=k.players.find(W=>W.id===y.playerId))==null?void 0:de.name)||null,isHost:!1})}catch(v){c.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",v)}}break;case"JOIN_ACCEPT":if(c.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${y.playerId}, hasState: ${!!((re=y.data)!=null&&re.gameState)}`),(ie=y.data)!=null&&ie.gameState){const S=y.data.gameState;if(c.info(`[handleWebrtcMessage] Setting game state with ${((J=S.players)==null?void 0:J.length)||0} players`),a(S),y.playerId!==void 0){d(y.playerId),c.info(`[handleWebrtcMessage] Set local player ID to ${y.playerId}`);try{const k=(Ee=Y.current)==null?void 0:Ee.getHostPeerId(),v=S.players.find(W=>W.id===y.playerId);k&&Xt({hostPeerId:k,playerId:y.playerId,playerName:(v==null?void 0:v.name)||null,isHost:!1})}catch(k){c.warn("[JOIN_ACCEPT] Failed to save guest data:",k)}}}break;case"JOIN_ACCEPT_BINARY":if(c.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${y.playerId}`),y.data instanceof Uint8Array)try{const S=gs(y.data),k=S;if(c.info(`[handleWebrtcMessage] Expanded binary state with ${((_e=k.players)==null?void 0:_e.length)||0} players`),a(k),y.playerId!==void 0){d(y.playerId),c.info(`[handleWebrtcMessage] Set local player ID to ${y.playerId}`);try{const v=(Ue=Y.current)==null?void 0:Ue.getHostPeerId(),W=k.players.find(B=>B.id===y.playerId);v&&Xt({hostPeerId:v,playerId:y.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(v){c.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",v)}}c.info(`[handleWebrtcMessage] Received optimized binary game state: ${y.data.byteLength} bytes`)}catch(S){c.error("[handleWebrtcMessage] Failed to deserialize binary game state:",S)}break;case"STATE_UPDATE_COMPACT":let Me=(ue=y.data)==null?void 0:ue.gameState;if(((fe=y.data)==null?void 0:fe._format)==="msgpack"&&typeof Me=="string")try{Me=Yn(Me),c.info("[STATE_UPDATE_COMPACT] Decoded MessagePack format")}catch(S){c.error("[STATE_UPDATE_COMPACT] Failed to decode MessagePack:",S);break}if(V.current){if(y.senderId&&y.senderId!==((Rr=Y.current)==null?void 0:Rr.getPeerId())&&(c.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${y.senderId}`),Me)){const S=Me;a(k=>{const v=y.playerId;if(v===void 0)return c.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),k;const W=k.players.map(z=>{if(z.id===v){const M=S.players.find(K=>K.id===v);if(M){const K=le=>{const Q=Ke(le.baseId);return Q?{...Q,id:le.id,baseId:le.baseId,ownerId:v,power:le.power,powerModifier:le.powerModifier,isFaceDown:le.isFaceDown,statuses:le.statuses||[]}:{id:le.id,baseId:le.baseId,name:"Unknown",power:0}},j=(M.handCards||[]).map(K),oe=(M.deckCards||[]).map(K),ce=(M.discardCards||[]).map(K);return c.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${v}: hand=${j.length}, deck=${oe.length}, discard=${ce.length}, score=${M.score||0}`),{...z,hand:j,deck:oe,discard:ce,handSize:j.length,deckSize:oe.length,discardSize:ce.length,score:M.score||z.score}}}else{const M=S.players.find(j=>j.id===z.id);if(!M)return z;if(z.isDummy===!0&&(M.handCards&&M.handCards.length>0||M.deckCards&&M.deckCards.length>0||M.discardCards&&M.discardCards.length>0)){const j=Q=>{const Ie=Ke(Q.baseId);return Ie?{...Ie,id:Q.id,baseId:Q.baseId,ownerId:z.id,power:Q.power,powerModifier:Q.powerModifier||0,isFaceDown:Q.isFaceDown||!1,statuses:Q.statuses||[]}:{id:Q.id,baseId:Q.baseId,name:"Unknown",power:0}},oe=(M.handCards||[]).map(j),ce=(M.deckCards||[]).map(j),le=(M.discardCards||[]).map(j);return c.info(`[STATE_UPDATE_COMPACT] Host: Guest ${v} modified dummy player ${z.id}: hand=${oe.length}, deck=${ce.length}, discard=${le.length}`),{...z,hand:oe,deck:ce,discard:le,handSize:oe.length,deckSize:ce.length,discardSize:le.length}}else if(M.handCards&&M.handCards.length>0&&z.hand){const j=M.handCards||[],oe=z.hand.map(ce=>{const le=j.find(Q=>Q.id===ce.id);return le&&le.statuses?{...ce,statuses:le.statuses,isFaceDown:le.isFaceDown}:ce});return{...z,hand:oe,handSize:oe.length}}}return z}),B=S.board?S.board.map(z=>z.map(M=>{if(!M||!M.card)return M;const K=Ke(M.card.baseId||M.card.id);if(K){const j=M.card.ownerId;return{...M,card:{...K,id:M.card.id,baseId:M.card.baseId||M.card.id,ownerId:j,ownerName:M.card.ownerName,power:M.card.power,powerModifier:M.card.powerModifier,isFaceDown:M.card.isFaceDown||!1,statuses:M.card.statuses||[],enteredThisTurn:M.card.enteredThisTurn,deck:M.card.deck}}}return M})):k.board,H={...k,...S,players:W,board:B};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(H,y.senderId)},0),H})}}else if(!V.current&&((Pr=y.data)!=null&&Pr.gameState)){const S=y.data.recipientPlayerId??null;if(c.info(`[STATE_UPDATE_COMPACT] Received compact state for player ${S}, currentPhase=${Me.currentPhase}, activePlayerId=${Me.activePlayerId}`),Ne.current){a(k=>(c.info(`[STATE_UPDATE_COMPACT] Skipping - recently restored from localStorage, updating phase from ${k.currentPhase} to ${Me.currentPhase}`),{...k,currentPhase:Me.currentPhase,activePlayerId:Me.activePlayerId,startingPlayerId:Me.startingPlayerId,isReadyCheckActive:Me.isReadyCheckActive,isGameStarted:Me.isGameStarted}));return}a(k=>{const v=S===null||S===g.current;c.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${S}, local=${g.current}, isForLocal=${v}`);const W=Me.players.map(M=>{var j,oe;const K=k.players.find(ce=>ce.id===M.id);if(M.id===g.current&&K){const ce=Q=>{if(Q.baseId){const be=Ke(Q.baseId);if(be)return{...be,id:Q.id,ownerId:g.current,power:Q.power,powerModifier:Q.powerModifier,isFaceDown:Q.isFaceDown,statuses:Q.statuses||[]}}return K.hand.find(be=>be.id===Q.id)||K.deck.find(be=>be.id===Q.id)||K.discard.find(be=>be.id===Q.id)||{id:Q.id,name:"Unknown",power:0}};if(M.handCards&&M.handCards.length>0||M.deckCards&&M.deckCards.length>0||M.discardCards&&M.discardCards.length>0){const Q=(M.handCards||[]).map(ce),Ie=(M.deckCards||[]).map(ce),be=(M.discardCards||[]).map(ce);return Q.forEach((pe,Ge)=>{var ge,ye;(ye=(ge=M.handCards)==null?void 0:ge[Ge])!=null&&ye.baseId&&!pe.baseId&&(pe.baseId=M.handCards[Ge].baseId)}),Ie.forEach((pe,Ge)=>{var ge,ye;(ye=(ge=M.deckCards)==null?void 0:ge[Ge])!=null&&ye.baseId&&!pe.baseId&&(pe.baseId=M.deckCards[Ge].baseId)}),be.forEach((pe,Ge)=>{var ge,ye;(ye=(ge=M.discardCards)==null?void 0:ge[Ge])!=null&&ye.baseId&&!pe.baseId&&(pe.baseId=M.discardCards[Ge].baseId)}),c.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${Q.length} hand, ${Ie.length} deck, ${be.length} discard`),{...M,hand:Q,deck:Ie,discard:be}}else{const Q=(M.handIds||[]).map(pe=>K.hand.find(ge=>ge.id===pe)||K.deck.find(ge=>ge.id===pe)||K.discard.find(ge=>ge.id===pe)||{id:pe,name:"?",isPlaceholder:!1}),Ie=(M.deckIds||[]).map(pe=>K.deck.find(ge=>ge.id===pe)||K.hand.find(ge=>ge.id===pe)||K.discard.find(ge=>ge.id===pe)||{id:pe,name:"?",isPlaceholder:!1}),be=(M.discardIds||[]).map(pe=>K.discard.find(ge=>ge.id===pe)||K.hand.find(ge=>ge.id===pe)||K.deck.find(ge=>ge.id===pe)||{id:pe,name:"?",isPlaceholder:!1});return c.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${Q.length} hand, ${Ie.length} deck, ${be.length} discard`),{...M,hand:Q,deck:Ie,discard:be}}}else{const ce=M.deckSize??((j=M.deck)==null?void 0:j.length)??0,le=M.handSize??((oe=M.hand)==null?void 0:oe.length)??0,Q=M.deckCards&&M.deckCards.length>0;let Ie;if(Q){const ye=M.deckCards[0];if((ye==null?void 0:ye.name)&&(ye==null?void 0:ye.imageUrl))Ie=M.deckCards.map(De=>({id:De.id,baseId:De.baseId||De.id,name:De.name,imageUrl:De.imageUrl,fallbackImage:De.fallbackImage||"",power:De.power,powerModifier:De.powerModifier||0,isFaceDown:De.isFaceDown??!1,statuses:De.statuses||[],deck:De.deck||"SynchroTech",color:De.color||"Red",ability:De.ability||"",bonusPower:De.bonusPower||0,isPlaceholder:De.isPlaceholder||!1,types:De.types||[],faction:De.faction||"",ownerId:M.id})),c.debug(`[STATE_UPDATE_COMPACT] Using full deck data for player ${M.id}: ${Ie.length} cards`);else{const De=Be=>{if(Be.baseId){const _t=Ke(Be.baseId);if(_t)return{..._t,id:Be.id,baseId:Be.baseId,ownerId:M.id,power:Be.power,powerModifier:Be.powerModifier,isFaceDown:Be.isFaceDown,statuses:Be.statuses||[]}}return{id:Be.id,name:"Unknown",power:0}};if(Ie=M.deckCards.map(De),M.id===3){const Be={};Ie.forEach(_t=>{const xn=_t.baseId||_t.id;Be[xn]=(Be[xn]||0)+1}),c.info(`[STATE_UPDATE_COMPACT] Reconstructed deck for Player 3 (dummy): ${Ie.length} cards`,Be)}c.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${M.id}: ${Ie.length} cards`)}}else if(K&&K.deck.length>0&&K.deck.some(Pe=>!Pe.isPlaceholder)){const Pe=K.deck.length;Ie=K.deck.slice(0,ce),M.id===3&&c.info(`[STATE_UPDATE_COMPACT] Player 3 deck slice: before=${Pe}, remoteDeckSize=${ce}, after=${Ie.length}`),c.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${M.id}: ${Ie.length} cards`)}else{Ie=[];for(let Pe=0;Pe<ce;Pe++)Ie.push({id:`placeholder_${M.id}_deck_${Pe}`,name:"?",isPlaceholder:!0,ownerId:M.id,deck:M.selectedDeck||"Random",color:M.color})}const be=(ye,Pe)=>{if(ye.baseId&&!ye.isPlaceholder&&!ye.isCardBack){const De=Ke(ye.baseId);if(De)return{...De,id:ye.id,baseId:ye.baseId,ownerId:M.id,power:ye.power,powerModifier:ye.powerModifier||0,isFaceDown:ye.isFaceDown||!1,statuses:ye.statuses||[]}}return{id:ye.id||`placeholder_${M.id}_hand_${Pe}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:M.id,deck:M.selectedDeck||"Random",color:M.color}};let pe;const Ge=M.handCards&&M.handCards.length>0,ge=M.hand&&M.hand.length>0;if(Ge)pe=M.handCards.map(Pe=>{const De=Ke(Pe.baseId);return De?{...De,id:Pe.id,baseId:Pe.baseId,ownerId:M.id,power:Pe.power,powerModifier:Pe.powerModifier||0,isFaceDown:Pe.isFaceDown||!1,statuses:Pe.statuses||[]}:{id:Pe.id,baseId:Pe.baseId,name:"Unknown",power:Pe.power||0,ownerId:M.id,isPlaceholder:!1}}),c.info(`[STATE_UPDATE_COMPACT] Reconstructed ${pe.length} hand cards from handCards for player ${M.id}`);else if(ge){pe=M.hand.map((Pe,De)=>be(Pe,De));const ye=pe.filter(Pe=>!Pe.isPlaceholder).length;ye>0&&c.info(`[STATE_UPDATE_COMPACT] Reconstructed ${ye}/${pe.length} revealed hand cards for player ${M.id}`)}else{pe=[];for(let ye=0;ye<le;ye++)pe.push({id:`placeholder_${M.id}_hand_${ye}`,name:"?",isPlaceholder:!0,ownerId:M.id,deck:M.selectedDeck||"Random",color:M.color})}return{...M,hand:pe,deck:Ie,discard:(K==null?void 0:K.discard)||[]}}}),B=Me.board?Me.board.map(M=>M.map(K=>{if(!K||!K.card)return K;const j=Ke(K.card.baseId||K.card.id);return j?{...K,card:{...j,id:K.card.id,baseId:K.card.baseId||K.card.id,ownerId:K.card.ownerId,ownerName:K.card.ownerName,power:K.card.power,powerModifier:K.card.powerModifier,isFaceDown:K.card.isFaceDown||!1,statuses:K.card.statuses||[],enteredThisTurn:K.card.enteredThisTurn,deck:K.card.deck}}:K})):k.board,H=xe({...Me,players:W,board:B}),z={...Me,players:W,board:H};return c.info(`[STATE_UPDATE_COMPACT] Merged state: currentPhase=${z.currentPhase}, activePlayerId=${z.activePlayerId}, startingPlayerId=${z.startingPlayerId}`),z})}break;case"STATE_UPDATE":if(V.current&&y.senderId&&y.senderId!==((kr=Y.current)==null?void 0:kr.getPeerId())){if(c.info(`[STATE_UPDATE] Host received state from guest ${y.senderId}`),(Or=y.data)!=null&&Or.gameState){const S=y.data.gameState;a(k=>{const v=y.playerId;if(v===void 0)return c.warn("[STATE_UPDATE] Guest state missing playerId"),k;const W=k.players.map(z=>{if(z.id===v){const M=S.players.find(K=>K.id===v);if(M){const K=Q=>({...Q,ownerId:v}),j=(M.hand||[]).map(K),oe=(M.deck||[]).map(K),ce=(M.discard||[]).map(K);c.info(`[STATE_UPDATE] Merging guest ${v} state: hand=${j.length}, deck=${oe.length}, discard=${ce.length}`);const le={...z,hand:j,deck:oe,discard:ce,handSize:j.length,deckSize:oe.length,discardSize:ce.length};return c.info(`[STATE_UPDATE] After merge - player ${v}: deckSize=${le.deckSize}, handSize=${le.handSize}`),le}}return z}),B=S.board?S.board.map(z=>z.map(M=>!M||!M.card?M:{...M,card:{...M.card,ownerId:M.card.ownerId}})):k.board,H={...k,players:W,board:B};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(H,y.senderId)},0),H})}break}if(Se.current=!0,(vr=y.data)!=null&&vr.gameState){const S=y.data.gameState;if(Ne.current){a(k=>({...k,currentPhase:S.currentPhase,activePlayerId:S.activePlayerId,startingPlayerId:S.startingPlayerId,isReadyCheckActive:S.isReadyCheckActive,isGameStarted:S.isGameStarted}));return}a(k=>{var B;const v=S.players.map(H=>{var M,K,j;const z=k.players.find(oe=>oe.id===H.id);if(H.id===g.current&&z){const oe=z.hand.every(le=>le.isPlaceholder)||z.hand.length===0,ce=H.handSize??((M=H.hand)==null?void 0:M.length)??0;if(oe&&H.hand&&H.hand.length>0)return{...H,hand:H.hand,deck:H.deck||z.deck,discard:H.discard||z.discard};{let le=z.hand,Q=z.deck;if(ce>z.hand.length&&Q.length>0){const Ie=ce-z.hand.length,be=[...z.hand],pe=[...z.deck];for(let Ge=0;Ge<Ie&&Ge<pe.length;Ge++){const ge=pe[0];pe.splice(0,1),be.push(ge)}le=be,Q=pe}return{...H,hand:le,deck:Q,discard:H.discard||z.discard}}}else{if(H.isDummy||!1)return c.info(`[STATE_UPDATE] Using real cards for dummy player ${H.id}`),{...H,hand:H.hand||[],deck:H.deck||[],discard:H.discard||[]};const ce=H.deckSize??((K=H.deck)==null?void 0:K.length)??0,le=H.handSize??((j=H.hand)==null?void 0:j.length)??0;c.info(`[STATE_UPDATE] Player ${H.id}: deckSize=${ce}, handSize=${le}`);const Q=[];for(let be=0;be<ce;be++)Q.push({id:`placeholder_${H.id}_deck_${be}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color});const Ie=[];for(let be=0;be<le;be++)Ie.push({id:`placeholder_${H.id}_hand_${be}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color});return c.info(`[STATE_UPDATE] Created ${Q.length} deck placeholders and ${Ie.length} hand placeholders for player ${H.id}`),{...H,hand:Ie,deck:Q,discard:H.discard||[]}}}),W={...S,players:v};if(!V.current)try{((B=Y.current)==null?void 0:B.getHostPeerId())&&g.current!==null&&(bt({gameState:W,localPlayerId:g.current,isHost:!1}),c.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(H){c.warn("[STATE_UPDATE] Failed to persist guest state:",H)}return W})}break;case"RECONNECT_SNAPSHOT":Se.current=!0;let Oe=y.data;if(((Nr=y.data)==null?void 0:Nr._format)==="msgpack"&&typeof y.data=="object")try{Oe=Yn(y.data.data||y.data),c.info("[RECONNECT_SNAPSHOT] Decoded MessagePack format")}catch(S){c.error("[RECONNECT_SNAPSHOT] Failed to decode MessagePack:",S),Oe=y.data}Oe&&a(S=>{const k=g.current,v=Oe.players.map(B=>{const H=S.players.find(j=>j.id===B.id);if(B.id===k&&H&&H.hand.some(oe=>!oe.isPlaceholder)){let oe=[...H.hand];const ce=[...H.deck];if(B.handSize>oe.length){const le=B.handSize-oe.length;for(let Q=0;Q<le&&ce.length>0;Q++)oe.push(ce.shift())}else B.handSize<oe.length&&(oe=oe.slice(0,B.handSize));return{...B,hand:oe,deck:ce,discard:H.discard}}const z=[];for(let j=0;j<B.handSize;j++)z.push({id:`placeholder_${B.id}_hand_${j}`,name:"?",isPlaceholder:!0,ownerId:B.id,deck:B.selectedDeck||"Random",color:B.color});const M=[];for(let j=0;j<B.deckSize;j++)M.push({id:`placeholder_${B.id}_deck_${j}`,name:"?",isPlaceholder:!0,ownerId:B.id,deck:B.selectedDeck||"Random",color:B.color});const K=[];for(let j=0;j<B.discardSize;j++)K.push({id:`placeholder_${B.id}_discard_${j}`,name:"?",isPlaceholder:!0,ownerId:B.id,deck:B.selectedDeck||"Random",color:B.color});return{...B,hand:z,deck:M,discard:K}}),W={gameId:Oe.gameId,gameMode:Oe.gameMode,isPrivate:Oe.isPrivate,isGameStarted:Oe.isGameStarted,isReadyCheckActive:Oe.isReadyCheckActive,activeGridSize:Oe.activeGridSize,currentPhase:Oe.currentPhase,isScoringStep:Oe.isScoringStep,activePlayerId:Oe.activePlayerId,startingPlayerId:Oe.startingPlayerId,currentRound:Oe.currentRound,turnNumber:Oe.turnNumber,roundWinners:Oe.roundWinners||{},gameWinner:Oe.gameWinner,isRoundEndModalOpen:Oe.isRoundEndModalOpen,dummyPlayerCount:Oe.dummyPlayerCount,players:v,board:Oe.board,spectators:S.spectators,hostId:S.hostId,revealRequests:S.revealRequests,preserveDeployAbilities:S.preserveDeployAbilities,highlights:S.highlights,floatingTexts:S.floatingTexts,targetingMode:S.targetingMode,abilityMode:S.abilityMode};if(!V.current&&k!==null)try{bt({gameState:W,localPlayerId:k,isHost:!1}),c.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(B){c.warn("[RECONNECT_SNAPSHOT] Failed to save state:",B)}return c.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${W.currentPhase}, players=${W.players.length}`),W});break;case"STATE_DELTA":if(V.current||(Se.current=!0),c.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${V.current}, senderId: ${y.senderId}`),(Mr=y.data)!=null&&Mr.delta){const S=y.data.delta;c.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(S.playerDeltas||{}).length}, boardCells=${((Lr=S.boardCells)==null?void 0:Lr.length)||0}, phaseDelta=${!!S.phaseDelta}`),S.boardCells&&S.boardCells.length>0&&S.boardCells.forEach(k=>{var v,W;c.info(`[STATE_DELTA] Board cell [${k.row},${k.col}]: card=${((v=k.card)==null?void 0:v.name)||"(empty)"}, owner=${(W=k.card)==null?void 0:W.ownerId}`)}),V.current&&y.senderId&&Y.current&&(c.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${y.senderId} to other guests`),Y.current.broadcastStateDelta(S,y.senderId)),S.phaseDelta&&c.info("[STATE_DELTA] phaseDelta:",JSON.stringify(S.phaseDelta)),S.playerDeltas&&Object.entries(S.playerDeltas).forEach(([k,v])=>{c.info(`[STATE_DELTA] Player ${k} delta: handSizeDelta=${v.handSizeDelta}, deckSizeDelta=${v.deckSizeDelta}`)}),a(k=>{const v=g.current||k.localPlayerId;c.info(`[STATE_DELTA] Applying delta with localPlayerId=${v}, currentPhase before=${k.currentPhase}`);const W=ar(k);c.info(`[STATE_DELTA] Applying delta with localPlayerId=${v}, currentPhase after=${W.currentPhase}`);try{W.gameId&&v!==null&&(bt({gameState:W,localPlayerId:v,isHost:V.current}),c.debug(`[STATE_DELTA] Saved state for ${V.current?"host":"guest"} auto-restore`))}catch(B){c.warn("[STATE_DELTA] Failed to persist state:",B)}return W})}break;case"STATE_DELTA_BINARY":{V.current||(Se.current=!0),c.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${V.current}, senderId: ${y.senderId}, dataType=${(xr=(Gr=y.data)==null?void 0:Gr.constructor)==null?void 0:xr.name}, typeof=${typeof y.data}`);let S=null;if(y.data instanceof Uint8Array)try{S=ya(y.data),S&&c.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(S.playerDeltas||{}).length}, boardCells=${((Ur=S.boardCells)==null?void 0:Ur.length)||0}`)}catch(k){c.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",k)}else if(typeof y.data=="string")try{S=_s(y.data),S&&c.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${y.data.length} chars): playerDeltas=${Object.keys(S.playerDeltas||{}).length}, boardCells=${(($r=S.boardCells)==null?void 0:$r.length)||0}, phaseDelta=${!!S.phaseDelta}`)}catch(k){c.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",k)}else c.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof y.data}, constructor: ${(Fr=(Hr=y.data)==null?void 0:Hr.constructor)==null?void 0:Fr.name}`);S&&(V.current&&y.senderId&&Y.current&&(c.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${y.senderId} to other guests`),Y.current.broadcastStateDelta(S,y.senderId)),a(k=>{const v=g.current||k.localPlayerId;c.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${v}, currentPhase before=${k.currentPhase}`);const W=ar(k);c.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${W.currentPhase}, board has ${W.board.flat().filter(B=>B==null?void 0:B.card).length} cards`);try{W.gameId&&v!==null&&(bt({gameState:W,localPlayerId:v,isHost:V.current}),c.debug(`[STATE_DELTA_BINARY] Saved state for ${V.current?"host":"guest"} auto-restore`))}catch(B){c.warn("[STATE_DELTA_BINARY] Failed to persist state:",B)}return W}));break}case"CARD_STATE":if(typeof y.data=="string")try{const S=atob(y.data),k=new Uint8Array(S.length);for(let v=0;v<S.length;v++)k[v]=S.charCodeAt(v);a(v=>yt(2,k,v,g.current||v.localPlayerId).gameState)}catch(S){c.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",S)}else y.data instanceof Uint8Array&&a(S=>yt(2,y.data,S,g.current||S.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof y.data=="string")try{const S=atob(y.data),k=new Uint8Array(S.length);for(let v=0;v<S.length;v++)k[v]=S.charCodeAt(v);a(v=>{const{gameState:W}=yt(3,k,v,g.current||v.localPlayerId);return W})}catch(S){c.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",S)}else y.data instanceof Uint8Array&&a(S=>{const{gameState:k}=yt(3,y.data,S,g.current||S.localPlayerId);return k});break;case"SESSION_EVENT":if(typeof y.data=="string")try{const S=atob(y.data),k=new Uint8Array(S.length);for(let v=0;v<S.length;v++)k[v]=S.charCodeAt(v);a(v=>yt(4,k,v,g.current||v.localPlayerId).gameState)}catch(S){c.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",S)}else y.data instanceof Uint8Array&&a(S=>yt(4,y.data,S,g.current||S.localPlayerId).gameState);break;case"JOIN_REQUEST":c.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${y.senderId}, isHost: ${V.current}`),V.current&&y.senderId?(c.info(`Host received JOIN_REQUEST from ${y.senderId}, data:`,y.data),Oa(y.senderId,y.data)):c.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${V.current}, senderId: ${y.senderId}`);break;case"ACTION":if(V.current&&y.data){const{actionType:S,actionData:k}=y.data;if(S==="STATE_UPDATE"&&(k!=null&&k.gameState)){if(Ne.current){Y.current&&y.senderId&&Y.current.sendToGuest(y.senderId,{type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:l.current},timestamp:Date.now()});break}a(v=>{const W=k.gameState,B=W.players.map(z=>{const M=v.players.find(K=>K.id===z.id);return M&&z.id!==g.current?{...z,deck:M.deck||z.deck,discard:M.discard||z.discard,score:M.score}:z}),H={...W,players:B};return Y.current&&Y.current.broadcastToGuests({type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:H},timestamp:Date.now()}),H})}else if(S==="STATE_DELTA"&&(k!=null&&k.delta))a(v=>{const W=k.delta;let B=W;Ne.current&&W.playerDeltas&&(B={...W,playerDeltas:Object.fromEntries(Object.entries(W.playerDeltas).map(([z,M])=>{const K={...M};return delete K.scoreDelta,[z,K]}))}),g.current||v.localPlayerId;const H=ar(v);return Y.current&&Y.current.broadcastStateDelta(B),H});else if(S==="NEXT_PHASE")a(v=>{const W=v,B=W.currentPhase,H=B===2&&!W.isScoringStep,z=B+1;return{...W,currentPhase:z,...H&&{isScoringStep:!0}}});else if(S==="PREV_PHASE")a(v=>{const W=v;return W.isScoringStep?{...W,isScoringStep:!1,currentPhase:Math.max(1,W.currentPhase-1)}:{...W,currentPhase:Math.max(1,W.currentPhase-1)}});else if(S==="SET_PHASE"&&(k==null?void 0:k.phaseIndex)!==void 0)a(v=>({...v,currentPhase:k.phaseIndex}));else if(S==="UPDATE_PLAYER_NAME"&&(k==null?void 0:k.playerId)!==void 0&&(k==null?void 0:k.name)!==void 0)a(v=>({...v,players:v.players.map(W=>W.id===k.playerId?{...W,name:k.name}:W)}));else if(S==="CHANGE_PLAYER_COLOR"&&(k==null?void 0:k.playerId)!==void 0&&(k==null?void 0:k.color)!==void 0){const v=k.playerId,W=k.color;a(B=>{const H={...B,players:B.players.map(z=>z.id===v?{...z,color:W}:z)};return Y.current&&Y.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:Y.current.getPeerId(),data:{playerId:v,color:W},timestamp:Date.now()}),H})}else if(S==="UPDATE_PLAYER_SCORE"&&(k==null?void 0:k.playerId)!==void 0&&(k==null?void 0:k.delta)!==void 0){const v=k.playerId,W=k.delta;a(B=>{const H={...B,players:B.players.map(z=>z.id===v?{...z,score:Math.max(0,z.score+W)}:z)};return Y.current&&Y.current.broadcastToGuests({type:"UPDATE_PLAYER_SCORE",senderId:Y.current.getPeerId(),data:{playerId:v,delta:W},timestamp:Date.now()}),H})}else if(S==="CHANGE_PLAYER_DECK"&&(k==null?void 0:k.playerId)!==void 0){const v=k.playerId,W=k.deckType,B=k.deck;a(H=>{const z=H.players.find(j=>j.id===v);if(!z)return H;let M;B&&B.length>0?(c.info(`[CHANGE_PLAYER_DECK] Host received ${B.length} cards for player ${v}`),M=B.map(j=>{if(j.baseId){const oe=Ke(j.baseId);if(oe)return{...oe,id:j.id,baseId:j.baseId,deck:W,ownerId:v,ownerName:z.name,power:j.power,powerModifier:j.powerModifier||0,isFaceDown:j.isFaceDown||!1,statuses:j.statuses||[]}}return{id:j.id,baseId:j.id,name:"Unknown",deck:W,ownerId:v,ownerName:z.name,power:j.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(M=et(W,v,z.name),c.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${v} with ${M.length} cards from ${W}`));const K={...H,players:H.players.map(j=>j.id===v?{...j,selectedDeck:W,deck:M,hand:[],discard:[],announcedCard:null,boardHistory:[]}:j)};if(Y.current){const j=M.map(oe=>({id:oe.id,baseId:oe.baseId,power:oe.power,powerModifier:oe.powerModifier||0,isFaceDown:oe.isFaceDown||!1,statuses:oe.statuses||[]}));Y.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:v,data:{playerId:v,deckType:W,deck:j,deckSize:j.length},timestamp:Date.now()})}return K})}else if(S==="TOGGLE_ACTIVE_PLAYER"&&(k==null?void 0:k.playerId)!==void 0)a(v=>{if(!v.players.find(H=>H.id===k.playerId))return v;const B=ma(v,k.playerId);return Y.current&&Y.current.broadcastGameState(B),B});else if(S==="TOGGLE_AUTO_DRAW"&&(k==null?void 0:k.playerId)!==void 0)a(v=>({...v,players:v.players.map(W=>W.id===k.playerId?{...W,autoDrawEnabled:!W.autoDrawEnabled}:W)}));else if(S==="START_NEXT_ROUND")a(v=>({...v,isRoundEndModalOpen:!1,currentRound:(v.currentRound||1)+1,players:v.players.map(W=>({...W,score:0}))}));else if(S==="RESET_DEPLOY_STATUS")a(v=>{const W=v.board.map(B=>B.map(H=>{var z;return(z=H.card)!=null&&z.statuses?{...H,card:{...H.card,statuses:H.card.statuses.filter(M=>M.type!=="DeployAbilityUsed")}}:H}));return{...v,board:W,preserveDeployAbilities:!1}});else if(S==="DECK_DATA_UPDATE"&&(k==null?void 0:k.playerId)!==void 0&&(k!=null&&k.deck)){const v=k.playerId,W=k.deck,B=k.deckSize;c.info(`[ACTION] DECK_DATA_UPDATE: Received ${W.length} cards for guest ${v}`),a(H=>({...H,players:H.players.map(z=>z.id===v?{...z,deck:[...W],deckSize:B||W.length}:z)}))}else c.warn(`[ACTION] Unknown action type: ${S}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(c.info(`[PLAYER_RECONNECT] Guest ${y.playerId} reconnecting from ${y.senderId}`),V.current&&y.playerId!==void 0&&y.senderId){const S=l.current;if(c.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(S!=null&&S.gameId)}, gameId=${S==null?void 0:S.gameId}, hasPlayers=${((Wr=S==null?void 0:S.players)==null?void 0:Wr.length)||0}`),S&&S.gameId){c.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${y.playerId}`);const k=xs(S,y.playerId);(Br=Y.current)==null||Br.sendToGuest(y.senderId,{type:"RECONNECT_SNAPSHOT",senderId:Y.current.getPeerId(),data:k.data,timestamp:Date.now()}),c.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${y.playerId}`)}else c.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((Yr=y.data)==null?void 0:Yr.isReadyCheckActive)!==void 0||((zr=y.data)==null?void 0:zr.isPrivate)!==void 0)&&a(S=>({...S,isReadyCheckActive:y.data.isReadyCheckActive??!0,isPrivate:y.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((Kr=y.data)==null?void 0:Kr.isReadyCheckActive)!==void 0&&a(S=>({...S,isReadyCheckActive:y.data.isReadyCheckActive}));break;case"PLAYER_READY":V.current&&y.playerId!==void 0?a(S=>{const k=S.players.map(H=>H.id===y.playerId?{...H,isReady:!0}:H),v={...S,players:k};c.info(`Player ${y.playerId} is ready via WebRTC`),Y.current&&(Y.current.broadcastGameState(v),c.info(`[PLAYER_READY] Broadcasted ready status for player ${y.playerId}`));const W=v.players.filter(H=>!H.isDummy&&!H.isDisconnected);if(W.length>0&&W.every(H=>H.isReady)&&!v.isGameStarted){const H=v.players.filter(j=>!j.isDisconnected),z=Math.floor(Math.random()*H.length),M=H[z].id;let K={...v};return K.isReadyCheckActive=!1,K.isGameStarted=!0,K.startingPlayerId=M,K.activePlayerId=M,K.currentPhase=0,K.players=K.players.map(j=>{if(j.hand.length===0&&j.deck.length>0){const ce=[...j.hand],le=[...j.deck];for(let Q=0;Q<6&&Q<le.length;Q++){const Ie=le[0];le.splice(0,1),ce.push(Ie)}return c.info(`[PLAYER_READY] Drew ${ce.length} cards for player ${j.id}`),{...j,hand:ce,deck:le}}return j}),K=Er(K,M),c.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${K.currentPhase}`),Y.current&&(Y.current.broadcastToGuests({type:"GAME_START",senderId:Y.current.getPeerId(),data:{startingPlayerId:M,activePlayerId:M,currentPhase:K.currentPhase,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{c.info(`[PLAYER_READY] Sending ACTIVE_PLAYER_CHANGED after game start: activePlayerId=${M}, currentPhase=${K.currentPhase}`),Y.current&&Y.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:Y.current.getPeerId(),data:{activePlayerId:K.activePlayerId,currentPhase:K.currentPhase,turnNumber:K.turnNumber},timestamp:Date.now()})},100)),K}return v}):V.current;break;case"ASSIGN_TEAMS":(qr=y.data)!=null&&qr.assignments&&a(S=>{const k=S.players.map(v=>{let W=v.teamId||1;for(const[B,H]of Object.entries(y.data.assignments))if(H.includes(v.id)){W=parseInt(B);break}return{...v,teamId:W}});return{...S,players:k}});break;case"SET_GAME_MODE":((Vr=y.data)==null?void 0:Vr.mode)!==void 0&&a(S=>({...S,gameMode:y.data.mode}));break;case"SET_GAME_PRIVACY":((jr=y.data)==null?void 0:jr.isPrivate)!==void 0&&a(S=>({...S,isPrivate:y.data.isPrivate}));break;case"SET_GRID_SIZE":((Jr=y.data)==null?void 0:Jr.size)!==void 0&&a(S=>{const k=y.data.size,v=[];for(let W=0;W<k;W++){const B=[];for(let H=0;H<k;H++)B.push({card:null});v.push(B)}return{...S,activeGridSize:k,board:v}});break;case"SET_DUMMY_PLAYER_COUNT":((Xr=y.data)==null?void 0:Xr.count)!==void 0&&a(S=>({...S,dummyPlayerCount:y.data.count}));break;case"HOST_READY":y.playerId!==void 0&&(c.info(`[handleWebrtcMessage] Host (player ${y.playerId}) is ready`),a(S=>{const k=S.players.map(v=>v.id===y.playerId?{...v,isReady:!0}:v);return{...S,players:k}}));break;case"GAME_START":Se.current=!0,c.info("[handleWebrtcMessage] Game starting!",y.data),c.info(`[GAME_START] Received data: startingPlayerId=${(Zr=y.data)==null?void 0:Zr.startingPlayerId}, activePlayerId=${(Qr=y.data)==null?void 0:Qr.activePlayerId}, currentPhase=${(en=y.data)==null?void 0:en.currentPhase}, isGameStarted=${(tn=y.data)==null?void 0:tn.isGameStarted}`),l.current&&(c.info(`[GAME_START] Current phase before: ${l.current.currentPhase}`),l.current.players.forEach(S=>{c.info(`[GAME_START] Before: Player ${S.id} - deck: ${S.deck.length}, hand: ${S.hand.length}`)})),y.data&&a(S=>{c.info(`[GAME_START] Processing for localPlayerId=${g.current}`),S.players.forEach(B=>{c.info(`[GAME_START] Player ${B.id} before: deck=${B.deck.length}, hand=${B.hand.length}`)});const k=y.data.startingPlayerId??y.data.activePlayerId,v={...S,isGameStarted:y.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:k,activePlayerId:y.data.activePlayerId,currentPhase:y.data.currentPhase??S.currentPhase},W=v.players.find(B=>B.id===g.current);if(W&&W.hand.length===0&&W.deck.length>0){const H=[...W.hand],z=[...W.deck];for(let M=0;M<6&&M<z.length;M++){const K=z[0];z.splice(0,1),H.push(K)}v.players=v.players.map(M=>M.id===g.current?{...M,hand:H,deck:z}:M),c.info(`[GAME_START] Drew ${H.length} cards for local player ${g.current}, deck now has ${z.length} cards`)}return v.players.forEach(B=>{c.info(`[GAME_START] Player ${B.id} after: deck=${B.deck.length}, hand=${B.hand.length}`)}),c.info(`[GAME_START] Final state: currentPhase=${v.currentPhase}, activePlayerId=${v.activePlayerId}, startingPlayerId=${v.startingPlayerId}`),v});break;case"ACTIVE_PLAYER_CHANGED":c.info("[handleWebrtcMessage] Active player changed!",y.data),y.data&&a(S=>{const k={...S,activePlayerId:y.data.activePlayerId};if(y.data.currentPhase!==void 0&&(k.currentPhase=y.data.currentPhase),y.data.turnNumber!==void 0&&(k.turnNumber=y.data.turnNumber),k.currentPhase===0&&k.activePlayerId===g.current){const v=k.players.find(W=>W.id===g.current);if(v&&v.deck.length>0){const W=v.deck[0],B=[...v.deck.slice(1)],H=[...v.hand,W];k.players=k.players.map(z=>z.id===g.current?{...z,deck:B,hand:H}:z)}k.currentPhase=1,dr(k,k.activePlayerId)}return k.activePlayerId&&k.activePlayerId!==S.activePlayerId&&dr(k,k.activePlayerId),k});break;case"SYNC_DECK_SELECTIONS":c.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",y.data),y.data&&a(S=>y.data.playerId!==void 0&&y.data.selectedDeck!==void 0?y.data.playerId===g.current?(c.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${y.data.playerId}`),S):{...S,players:S.players.map(k=>k.id===y.data.playerId?{...k,selectedDeck:y.data.selectedDeck}:k)}:y.data.deckSelections&&Array.isArray(y.data.deckSelections)?{...S,players:S.players.map(k=>{if(k.id===g.current)return k;const v=y.data.deckSelections.find(W=>W.id===k.id);return v?{...k,selectedDeck:v.selectedDeck}:k})}:S);break;case"CHANGE_PLAYER_DECK":if(c.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",y.data),!y.data||y.data.playerId===void 0)break;{const S=y.data.playerId,k=y.data.deckType,v=y.data.deck;a(W=>{const B=W.players.find(M=>M.id===S);if(!B)return W;const H=V.current;let z;if(v&&v.length>0)if(z=v.map(M=>{if(M.baseId){const K=Ke(M.baseId);return K?{...K,id:M.id,baseId:M.baseId,deck:k,ownerId:S,ownerName:B.name,power:M.power,powerModifier:M.powerModifier||0,isFaceDown:M.isFaceDown||!1,statuses:M.statuses||[]}:(c.warn(`[CHANGE_PLAYER_DECK] Card definition not found for baseId: ${M.baseId}, id: ${M.id}`),{id:M.id,baseId:M.baseId,name:"Unknown",deck:k,ownerId:S,ownerName:B.name,power:M.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""})}return c.warn(`[CHANGE_PLAYER_DECK] Card without baseId: ${M.id}`),{id:M.id,baseId:M.id,name:"Unknown",deck:k,ownerId:S,ownerName:B.name,power:M.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}),k==="Optimates"||k==="Command"){const M={};z.forEach(K=>{const j=K.baseId||K.id;M[j]=(M[j]||0)+1}),c.info(`[CHANGE_PLAYER_DECK] Reconstructed ${k} deck for player ${S}:`,{totalCards:z.length,cardCounts:M})}else c.info(`[CHANGE_PLAYER_DECK] Reconstructed deck for player ${S} from host data: ${z.length} cards`);else if(!H)z=et(k,S,B.name),c.warn(`[CHANGE_PLAYER_DECK] No deck data from host, creating locally for player ${S} from ${k}`);else return W;return{...W,players:W.players.map(M=>M.id===S?{...M,selectedDeck:k,deck:z,hand:[],discard:[],announcedCard:null,boardHistory:[]}:M)}})}break;case"GAME_RESET":a(S=>{const k=y.data.activeGridSize||8,v=[];for(let H=0;H<k;H++){const z=[];for(let M=0;M<k;M++)z.push({card:null});v.push(z)}const W=(y.data.players||[]).map(H=>{if(H.isDummy&&H.hand&&H.deck&&H.discard)return{...H,boardHistory:[]};{const z=H.selectedDeck||"SynchroTech";return{...H,hand:[],deck:et(z,H.id,H.name),discard:[],boardHistory:[]}}}),B={...S,players:W,gameMode:y.data.gameMode,isPrivate:y.data.isPrivate,activeGridSize:y.data.activeGridSize,dummyPlayerCount:y.data.dummyPlayerCount,autoAbilitiesEnabled:y.data.autoAbilitiesEnabled,isGameStarted:y.data.isGameStarted,currentPhase:y.data.currentPhase,currentRound:y.data.currentRound,turnNumber:y.data.turnNumber,activePlayerId:y.data.activePlayerId,startingPlayerId:y.data.startingPlayerId,roundWinners:y.data.roundWinners||{},gameWinner:y.data.gameWinner,isRoundEndModalOpen:y.data.isRoundEndModalOpen,isReadyCheckActive:y.data.isReadyCheckActive,board:v,targetingMode:null,floatingTexts:[]};return l.current=B,B});break;case"ABILITY_MODE_SET":(rn=y.data)!=null&&rn.abilityMode&&(a(S=>({...S,abilityMode:y.data.abilityMode})),c.info("[AbilityMode] Received ability mode from host",{playerId:y.data.abilityMode.playerId,mode:y.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":c.info("[Ability] Target selected",y.data);break;case"ABILITY_COMPLETED":a(S=>({...S,abilityMode:void 0})),c.info("[Ability] Ability completed",y.data);break;case"ABILITY_CANCELLED":a(S=>({...S,abilityMode:void 0}));break;case"CHANGE_PLAYER_COLOR":if(c.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",y.data),!y.data||y.data.playerId===void 0)break;{const S=y.data.playerId,k=y.data.color;if(S===g.current)break;a(v=>({...v,players:v.players.map(W=>W.id===S?{...W,color:k}:W)}))}break;case"UPDATE_PLAYER_SCORE":if(c.info("[UPDATE_PLAYER_SCORE] Received score update broadcast",y.data),!y.data||y.data.playerId===void 0)break;{const S=y.data.playerId,k=y.data.delta;if(S===g.current)break;a(v=>({...v,players:v.players.map(W=>W.id===S?{...W,score:Math.max(0,W.score+k)}:W)}))}break;case"TRIGGER_HIGHLIGHT":if((nn=y.data)!=null&&nn.highlightData){const S=y.data.highlightData;A(S),V.current&&Y.current&&y.senderId&&Y.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:y.senderId,data:S,timestamp:Date.now()},y.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(y.data){const S=(an=Y.current)==null?void 0:an.getPeerId();y.senderId!==S&&A(y.data)}break;case"TRIGGER_FLOATING_TEXT":if((on=y.data)!=null&&on.textData){const S=y.data.textData;a(k=>({...k,floatingTexts:[...k.floatingTexts,S].filter(v=>Date.now()-v.timestamp<ae.FLOATING_TEXT_DURATION)})),V.current&&Y.current&&y.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:y.senderId,data:S,timestamp:Date.now()},y.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((sn=y.data)!=null&&sn.batch){const S=y.data.batch;a(k=>({...k,floatingTexts:[...k.floatingTexts,...S].filter(v=>Date.now()-v.timestamp<ae.FLOATING_TEXT_DURATION)})),V.current&&Y.current&&y.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:y.senderId,data:{batch:S},timestamp:Date.now()},y.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const S=(dn=Y.current)==null?void 0:dn.getPeerId();(cn=y.data)!=null&&cn.batch&&y.senderId!==S?a(k=>({...k,floatingTexts:[...k.floatingTexts,...y.data.batch].filter(v=>Date.now()-v.timestamp<ae.FLOATING_TEXT_DURATION)})):(ln=y.data)!=null&&ln.textData&&y.senderId!==S&&a(k=>({...k,floatingTexts:[...k.floatingTexts,y.data.textData].filter(v=>Date.now()-v.timestamp<ae.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((un=y.data)!=null&&un.coords){const S=y.data.coords,k=y.data.timestamp;p({coords:S,timestamp:k}),V.current&&Y.current&&y.senderId&&Y.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:y.senderId,data:{coords:S,timestamp:k},timestamp:Date.now()},y.senderId)}break;case"NO_TARGET_TRIGGERED":if((fn=y.data)!=null&&fn.coords){const S=(pn=Y.current)==null?void 0:pn.getPeerId();y.senderId!==S&&p({coords:y.data.coords,timestamp:y.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(y.data){const S=y.data;D(k=>[...k,S]),setTimeout(()=>{D(k=>k.filter(v=>v.timestamp!==S.timestamp))},1e3),V.current&&Y.current&&y.senderId&&Y.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:y.senderId,data:S,timestamp:Date.now()},y.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(y.data){const S=y.data;P(k=>[...k,S]),setTimeout(()=>{P(k=>k.filter(v=>v.timestamp!==S.timestamp))},1e3),V.current&&Y.current&&y.senderId&&Y.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:y.senderId,data:S,timestamp:Date.now()},y.senderId)}break;case"TRIGGER_CLICK_WAVE":if(y.data){const S=y.data;L(k=>[...k,S]),setTimeout(()=>{L(k=>k.filter(v=>v.timestamp!==S.timestamp))},600),V.current&&Y.current&&y.senderId&&Y.current.broadcastToGuests({type:"CLICK_WAVE_TRIGGERED",senderId:y.senderId,data:S,timestamp:Date.now()},y.senderId)}break;case"CLICK_WAVE_TRIGGERED":y.data&&y.senderId!==((yn=Y.current)==null?void 0:yn.getPeerId())&&(L(S=>[...S,y.data]),setTimeout(()=>{L(S=>S.filter(k=>k.timestamp!==y.data.timestamp))},600));break;case"DECK_SELECTION_TRIGGERED":y.data&&y.senderId!==((hn=Y.current)==null?void 0:hn.getPeerId())&&(D(S=>[...S,y.data]),setTimeout(()=>{D(S=>S.filter(k=>k.timestamp!==y.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":y.data&&y.senderId!==((mn=Y.current)==null?void 0:mn.getPeerId())&&(P(S=>[...S,y.data]),setTimeout(()=>{P(S=>S.filter(k=>k.timestamp!==y.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((In=y.data)!=null&&In.targetingMode){const S=y.data.targetingMode,k=S.mode||((En=S.action)==null?void 0:En.mode);c.info("[TargetingMode] Received SET_TARGETING_MODE via WebRTC",{playerId:S.playerId,mode:k,boardTargetsCount:((Tn=S.boardTargets)==null?void 0:Tn.length)||0,handTargetsCount:((gn=S.handTargets)==null?void 0:gn.length)||0,isDeckSelectable:S.isDeckSelectable||!1,timestamp:S.timestamp,isHost:V.current}),a(v=>({...v,targetingMode:S})),l.current.targetingMode=S,V.current&&Y.current&&Y.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((_n=(wn=Y.current).getPeerId)==null?void 0:_n.call(wn))??void 0,data:{targetingMode:S},timestamp:Date.now()})}break;case"CLEAR_TARGETING_MODE":c.info("[TargetingMode] Received CLEAR_TARGETING_MODE via WebRTC",{isHost:V.current}),a(S=>({...S,targetingMode:null})),l.current.targetingMode=null,V.current&&Y.current&&Y.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((An=(bn=Y.current).getPeerId)==null?void 0:An.call(bn))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()});break;case"RECONNECT_ACCEPT":if((Sn=y.data)!=null&&Sn.gameState){const S=y.data.gameState;a(S),R("Connected"),c.info(`[Reconnection] State restored with ${((Cn=S.players)==null?void 0:Cn.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(k){c.warn("[Reconnection] Failed to clear stored data:",k)}}break;case"RECONNECT_REJECT":{const S=((Dn=y.data)==null?void 0:Dn.reason)||"unknown";c.warn(`[Reconnection] Reconnection rejected: ${S}`),R("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((Rn=y.data)==null?void 0:Rn.playerId)!==void 0&&(c.info(`[Reconnection] Player ${y.data.playerId} disconnected, reconnection window open`),a(S=>({...S,players:S.players.map(k=>k.id===y.data.playerId?{...k,isDisconnected:!0}:k)})));break;case"PLAYER_RECONNECTED":((Pn=y.data)==null?void 0:Pn.playerId)!==void 0&&(c.info(`[Reconnection] Player ${y.data.playerId} reconnected`),a(S=>({...S,players:S.players.map(k=>k.id===y.data.playerId?{...k,isDisconnected:!1}:k)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((kn=y.data)==null?void 0:kn.playerId)!==void 0&&(c.info(`[Reconnection] Player ${y.data.playerId} converted to dummy`),a(S=>({...S,players:S.players.map(k=>k.id===y.data.playerId?{...k,isDummy:!0,isDisconnected:!0}:k)})));break;case"REQUEST_DECK_VIEW":if(V.current&&((On=y.data)==null?void 0:On.targetPlayerId)!==void 0){const S=y.data.targetPlayerId;y.playerId;const k=n.players.find(v=>v.id===S);if(k&&Y.current){let v=[];if(S===g.current||k.isDummy)c.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${k.deck.length} cards`),v=k.deck;else{const z=je.current.get(S);z&&z.length>0?(c.info(`[REQUEST_DECK_VIEW] Using stored full deck data for guest ${S}, ${z.length} cards`),v=z):(c.info(`[REQUEST_DECK_VIEW] No stored full deck for guest ${S}, using gameState deck, ${k.deck.length} cards`),v=k.deck)}const W=zn(v),B={targetPlayerId:S,deckCards:W,deckSize:v.length,_format:"baseIdArray"},H={type:"DECK_VIEW_DATA",senderId:Y.current.getPeerId(),data:B,timestamp:Date.now()};Y.current.sendToGuest(y.senderId||"",H),c.info(`[REQUEST_DECK_VIEW] Sent ${B.deckSize} cards (optimized) for player ${S}`)}}break;case"DECK_VIEW_DATA":if(((vn=y.data)==null?void 0:vn.targetPlayerId)!==void 0&&((Nn=y.data)!=null&&Nn.deckCards)){const S=y.data.targetPlayerId,k=y.data.deckCards,v=y.data._format==="baseIdArray";let W;if(v&&typeof k=="string")try{W=Kn(k,S)}catch(B){c.error("[DECK_VIEW_DATA] Failed to deserialize optimized deck:",B);break}else{const B=k;c.info(`[DECK_VIEW_DATA] Received legacy format (${B.length} cards) for player ${S}`);const H=B[0];if((H==null?void 0:H.name)&&(H==null?void 0:H.imageUrl))c.info(`[DECK_VIEW_DATA] Received full card data, using directly. First card: ${H.name}`),W=B.map(M=>({id:M.id,baseId:M.baseId||M.id,name:M.name,imageUrl:M.imageUrl,fallbackImage:M.fallbackImage||"",power:M.power,powerModifier:M.powerModifier||0,isFaceDown:M.isFaceDown??!1,statuses:M.statuses||[],deck:M.deck||Re.SynchroTech,color:M.color||"Red",ability:M.ability||"",bonusPower:M.bonusPower||0,isPlaceholder:M.isPlaceholder||!1,types:M.types||[],faction:M.faction||"",ownerId:M.ownerId||S}));else{const M=K=>{if(K.baseId){const oe=Ke(K.baseId);if(oe)return{...oe,id:K.id,baseId:K.baseId,deck:K.deck||Re.SynchroTech,ownerId:S,power:K.power,powerModifier:K.powerModifier,isFaceDown:K.isFaceDown,statuses:K.statuses||[]};c.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${K.baseId}`)}else c.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${K.id}`);return{id:K.id,baseId:K.baseId||K.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:K.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:Re.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}};W=B.map(M)}}a(B=>({...B,players:B.players.map(H=>H.id===S?{...H,deck:W}:H)}))}break;case"DECK_DATA_UPDATE":if(V.current&&y.playerId!==void 0&&((Mn=y.data)!=null&&Mn.deck)){const S=y.playerId,k=y.data.deck,v=y.data.deckSize,W=y.data._format==="baseIdArray";let B;if(W&&typeof k=="string")try{B=Kn(k,S)}catch(H){c.error("[DECK_DATA_UPDATE] Failed to deserialize optimized deck:",H);break}else{const H=k;c.info(`[DECK_DATA_UPDATE] Received legacy format (${H.length} cards) for guest ${S}, first card: ${(Ln=H[0])==null?void 0:Ln.name}`),B=H.map(z=>({...z,ownerId:z.ownerId??S}))}je.current.set(S,B),a(H=>{const z={...H,players:H.players.map(M=>M.id===S?{...M,deck:B,deckSize:v}:M)};return Y.current&&y.senderId&&setTimeout(()=>{Y.current.broadcastGameState(z,y.senderId)},0),z})}break;case"REQUEST_DECK_DATA":if(!V.current&&Y.current){const S=n.players.find(k=>k.id===g.current);if(S&&S.deck.length>0){c.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${S.deck.length} cards (optimized format)`);const k=zn(S.deck);Y.current.sendAction("DECK_DATA_UPDATE",{playerId:g.current,deck:k,deckSize:S.deck.length,_format:"baseIdArray"})}}break;case"HOST_DECK_DATA":if(!V.current&&((Gn=y.data)!=null&&Gn.deck)){const S=y.data.deck,k=y.data.deckSize,v=1;c.info(`[HOST_DECK_DATA] Received host deck data: ${S.length} cards`),a(W=>({...W,players:W.players.map(B=>B.id===v?{...B,deck:S,deckSize:k}:B)}))}break;default:c.warn(`[handleWebrtcMessage] Unknown message type: ${y.type}`,y);break}},[se,et,Sr,n,i]),Na=x.useCallback(y=>{if(!Y.current||Ae)return;Le(!0),R("Connecting");const ne=3e4,ee=1e3;let te=0;const de=ne/ee;try{const ie={hostPeerId:y,playerId:i,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ie))}catch(ie){c.error("[Reconnection] Failed to store data:",ie)}const re=async()=>{te++;const ie=Math.max(0,ne-te*ee);if(Te({attempt:te,maxAttempts:de,timeRemaining:ie}),ie<=0){c.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Le(!1),Te(null),nt();return}let J=y;if(n!=null&&n.gameId){const Ee=Zt(n.gameId);if(Ee&&Ee.peerId!==y){J=Ee.peerId;try{const _e={hostPeerId:J,playerId:i,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(_e))}catch(_e){c.error("[Reconnection] Failed to update reconnection data:",_e)}}}try{const Ee=i||g.current;Ee!==null?(c.info(`[Reconnection] Reconnecting as existing player ${Ee} to host ${J}`),await Y.current.initializeAsReconnectingGuest(J,Ee)):(c.info("[Reconnection] No playerId, connecting as new player"),await Y.current.initializeAsGuest(J)),c.info("[Reconnection] Successfully reconnected!"),Le(!1),Te(null)}catch(Ee){c.warn("[Reconnection] Reconnection attempt failed:",Ee),setTimeout(re,ee)}};re()},[Ae,n,i]),Fe=x.useCallback(y=>{a(ne=>{if(!ne)return c.error("[updateState] prevState is undefined, skipping update"),ne;const ee=typeof y=="function"?y(ne):y;if(!ee)return c.error("[updateState] newState is undefined, skipping update"),ne;const te=!ne.gameId&&ee.gameId;if(!Se.current&&!te)return ee;if($&&Y.current){if(V.current){if(Y.current.broadcastGameState(ee),c.info(`[updateState] Host broadcast state: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`),ee.gameId&&g.current!==null)try{bt({gameState:ee,localPlayerId:g.current,isHost:!0}),c.debug("[updateState] Saved game state for host auto-restore")}catch(de){c.warn("[updateState] Failed to save game state:",de)}}else Y.current&&(Y.current.sendStateToHost(ee,g.current),c.info(`[updateState] Guest sent state to host: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`));return ee}if(Ce.current&&Ce.current.readyState===WebSocket.OPEN){const de={type:"UPDATE_STATE",gameState:ee};lt.current&&(de.playerToken=lt.current),Ce.current.send(JSON.stringify(de))}return ee})},[$,se,Sr]),Ma=x.useCallback(()=>{const{initialState:y}=wt.createGame();Fe(y)},[wt,Fe]),La=x.useCallback(()=>{wt.exitGame(Ve,V,Fn,nt)},[wt,Ve,V,Fn,nt]),Ga=Ys({ws:Ce,webrtcManager:Y,gameStateRef:l,webrtcIsHostRef:V,setGameState:a,updateState:Fe}),xa=zs({ws:Ce,webrtcManager:Y,gameStateRef:l,localPlayerIdRef:g,webrtcIsHostRef:V,setGameState:a}),Ua=Ks({updateState:Fe,sendWebrtcAction:gt,webrtcIsHostRef:V,webrtcManagerRef:Y}),$a=qs({ws:Ce,webrtcManager:Y,gameStateRef:l,localPlayerIdRef:g,webrtcIsHostRef:V,updateState:Fe}),Ha=Vs({localPlayerIdRef:g,updateState:Fe}),{addBoardCardStatus:Fa,removeBoardCardStatus:Wa,removeBoardCardStatusByOwner:Ba,modifyBoardCardPower:Ya,addAnnouncedCardStatus:za,removeAnnouncedCardStatus:Ka,modifyAnnouncedCardPower:qa,addHandCardStatus:Va,removeHandCardStatus:ja,revealHandCard:Ja,revealBoardCard:Xa,requestCardReveal:Za,respondToRevealRequest:Qa,removeRevealedStatus:eo}=Ha,to=js({webrtcIsHostRef:V,sendWebrtcAction:gt,webrtcManagerRef:Y,localPlayerIdRef:g,getCardDefinition:Ke,commandCardIds:jo,createDeck:et,updateState:Fe}),{changePlayerDeck:ro,loadCustomDeck:no,resurrectDiscardedCard:ao,reorderTopDeck:oo,reorderCards:so,recoverDiscardedCard:io}=to,co=Js({ws:Ce,webrtcManagerRef:Y,webrtcIsHostRef:V,gameStateRef:l,scoreDeltaAccumulator:Qe,setGameState:a,updateState:Fe,abilityMode:e,setAbilityMode:r,createDeck:et}),{toggleActivePlayer:lo,toggleAutoDraw:uo,setPhase:fo,nextPhase:po,prevPhase:yo,closeRoundEndModal:ho,closeRoundEndModalOnly:mo,resetGame:Io}=co;x.useEffect(()=>{tt.current=!1;const y=sessionStorage.getItem("invite_game_id"),ne=sessionStorage.getItem("invite_host_id");if(y&&!ne)return _r(),()=>{tt.current=!0,ft.current&&clearTimeout(ft.current),Ce.current&&(Ce.current.onclose=null,Ce.current.close())};if(y&&ne)return()=>{tt.current=!0,ft.current&&clearTimeout(ft.current),Ce.current&&(Ce.current.onclose=null,Ce.current.close())};const ee=performance.getEntriesByType("navigation"),te=ee.length>0?ee[0]:null,de=(te==null?void 0:te.type)??0,re=Fs();return re&&(c.info(`Restoring saved game state (nav type: ${de}):`,re.gameState.gameId),a(re.gameState),d(re.localPlayerId),l.current=re.gameState,g.current=re.localPlayerId,lt.current=re.playerToken),_r(),()=>{tt.current=!0,ft.current&&clearTimeout(ft.current),Ce.current&&(Ce.current.onclose=null,Ce.current.close())}},[]),x.useEffect(()=>{if(qe&&l.current&&l.current.gameId){const y=Nt(l.current);y!==l.current&&(a(y),l.current=y)}},[]),x.useEffect(()=>{if(N)return;const y=setInterval(()=>{if(qe&&l.current&&l.current.gameId){const ne=Nt(l.current);a({...ne}),l.current=ne,G(!0),clearInterval(y)}},100);return()=>clearInterval(y)},[N]);const{startReadyCheck:Eo,cancelReadyCheck:To,playerReady:go}=xa,{updatePlayerName:wo,changePlayerColor:_o}=Ua,{drawCard:bo,drawCardsBatch:Ao,shufflePlayerDeck:So,flipBoardCard:Co,flipBoardCardFaceDown:Do}=$a,{assignTeams:Ro,setGameMode:Po,setGamePrivacy:ko,setActiveGridSize:Oo,setDummyPlayerCount:vo}=Ga,No=x.useCallback(()=>{var y;if(((y=Ce.current)==null?void 0:y.readyState)===WebSocket.OPEN&&l.current.gameId&&g.current===1){Ce.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:qe}));const ne=l.current,ee=he(ne);ee.players.forEach(te=>{if(["hand","deck","discard"].forEach(re=>{te[re]&&(te[re]=te[re].map(ie=>{const J=jt(ie.name);return J?{...ie,...J}:ie}))}),te.announcedCard){const re=jt(te.announcedCard.name);re&&(te.announcedCard={...te.announcedCard,...re})}}),ee.board.forEach(te=>{te.forEach(de=>{if(de.card){const re=jt(de.card.name);re&&(de.card={...de.card,...re})}})}),Ce.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:ee})),a(ee)}},[]),qt=x.useCallback((y,ne)=>{var de;const ee=l.current;if(!ee.isGameStarted){c.warn("[ScoreUpdate] Blocked: game not started");return}if(ee.isRoundEndModalOpen){c.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(ne===0)return;const te=ve();if(te?Fe(re=>({...re,players:re.players.map(ie=>ie.id===y?{...ie,score:Math.max(0,(ie.score||0)+ne)}:ie)})):a(re=>({...re,players:re.players.map(ie=>ie.id===y?{...ie,score:Math.max(0,(ie.score||0)+ne)}:ie)})),!te){if(((de=Ce.current)==null?void 0:de.readyState)!==WebSocket.OPEN){c.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const re=Qe.get(y);if(re){clearTimeout(re.timerId);const ie=re.delta+ne,J=setTimeout(()=>{var _e;const Ee=Qe.get(y);Ee&&((_e=Ce.current)==null?void 0:_e.readyState)===WebSocket.OPEN&&(c.info(`[ScoreUpdate] Sending accumulated delta: player=${y}, delta=${Ee.delta}`),Ce.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:l.current.gameId,playerId:y,delta:Ee.delta}))),Qe.delete(y)},500);Qe.set(y,{delta:ie,timerId:J})}else{const ie=setTimeout(()=>{var Ee;const J=Qe.get(y);J&&((Ee=Ce.current)==null?void 0:Ee.readyState)===WebSocket.OPEN&&(c.info(`[ScoreUpdate] Sending delta: player=${y}, delta=${J.delta}`),Ce.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:l.current.gameId,playerId:y,delta:J.delta}))),Qe.delete(y)},500);Qe.set(y,{delta:ne,timerId:ie})}}},[a,Fe]),Mo=ei({ws:Ce,webrtcManager:Y,gameStateRef:l,webrtcIsHostRef:V,setGameState:a}),{setTargetingMode:Lo,clearTargetingMode:Cr}=Mo,Go=Xs({ws:Ce,gameStateRef:l,updateState:Fe,updatePlayerScore:qt,triggerFloatingText:Ar,clearTargetingMode:Cr}),{scoreLine:xo,scoreDiagonal:Uo}=Go,Ze=Zs({updateState:Fe,rawJsonData:qe}),$o=Qs({updateState:Fe,localPlayerIdRef:g,updatePlayerScore:qt}),{moveItem:Dr}=$o;return{gameState:n,localPlayerId:i,setLocalPlayerId:d,draggedItem:T,setDraggedItem:C,connectionStatus:h,gamesList:E,latestHighlight:m,latestFloatingTexts:w,latestNoTarget:u,latestDeckSelections:_,latestHandCardSelections:O,joinAsInvite:wa,startReadyCheck:Eo,cancelReadyCheck:To,playerReady:go,assignTeams:Ro,setGameMode:Po,setGamePrivacy:ko,setActiveGridSize:Oo,setDummyPlayerCount:vo,updatePlayerName:wo,changePlayerColor:_o,updatePlayerScore:qt,changePlayerDeck:ro,loadCustomDeck:no,drawCard:bo,drawCardsBatch:Ao,shufflePlayerDeck:So,moveItem:Dr,handleDrop:Dr,addBoardCardStatus:Fa,removeBoardCardStatus:Wa,removeBoardCardStatusByOwner:Ba,modifyBoardCardPower:Ya,addAnnouncedCardStatus:za,removeAnnouncedCardStatus:Ka,modifyAnnouncedCardPower:qa,addHandCardStatus:Va,removeHandCardStatus:ja,flipBoardCard:Co,flipBoardCardFaceDown:Do,revealHandCard:Ja,revealBoardCard:Xa,requestCardReveal:Za,respondToRevealRequest:Qa,syncGame:No,removeRevealedStatus:eo,toggleActivePlayer:lo,toggleAutoDraw:uo,triggerHighlight:Aa,triggerFloatingText:Ar,triggerNoTarget:Sa,triggerDeckSelection:Ca,triggerHandCardSelection:Da,triggerClickWave:Pa,clickWaves:b,syncValidTargets:Ra,setTargetingMode:Lo,clearTargetingMode:Cr,nextPhase:po,prevPhase:yo,setPhase:fo,markAbilityUsed:Ze.markAbilityUsed,applyGlobalEffect:Ze.applyGlobalEffect,swapCards:Ze.swapCards,transferStatus:Ze.transferStatus,transferAllCounters:Ze.transferAllCounters,spawnToken:Ze.spawnToken,resetDeployStatus:Ze.resetDeployStatus,removeStatusByType:Ze.removeStatusByType,recoverDiscardedCard:io,resurrectDiscardedCard:ao,scoreLine:xo,closeRoundEndModal:ho,closeRoundEndModalOnly:mo,resetGame:Io,scoreDiagonal:Uo,reorderTopDeck:oo,reorderCards:so,updateState:Fe,requestDeckView:rt,sendFullDeckToHost:wr,shareHostDeckWithGuests:Lt,createGame:Ma,joinGame:br,joinGameViaModal:br,exitGame:La,requestGamesList:_a,forceReconnect:ga,webrtcHostId:Z,webrtcIsHost:se,initializeWebrtcHost:Tt,connectAsGuest:Kt,sendWebrtcAction:gt,isReconnecting:Ae,reconnectProgress:we}};function Xn(t,e,r){const{gameState:n,localPlayerId:a,abilityMode:s,cursorStack:o,handleActionExecution:i,markAbilityUsed:d}=r;if(s||o||!n.isGameStarted||a===null)return null;const l=n.players.find(C=>C.id===t.ownerId),g=a===t.ownerId||(l==null?void 0:l.isDummy);if(n.activePlayerId!==t.ownerId||!g||!aa(t,n)||!na(t,n.currentPhase,n.activePlayerId,n))return null;const T=rs(t,n,t.ownerId,e);if(T){T.readyStatusToRemove&&d(e,!!T.isDeployAbility,!1,T.readyStatusToRemove);const C={...T,chainedAction:T.chainedAction?{...T.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};return i(C,e),C}return null}function dd(t){const e=dt[t],r=(e==null?void 0:e.allowedTargets)||[];return{allowedTargets:r,allowHand:r.includes("hand"),allowBoard:r.includes("board"),allowBoardFaceDown:r.includes("board-facedown"),allowDeck:r.includes("deck"),allowDiscard:r.includes("discard")}}function gr(t,e,r,n){const a={type:t,count:r?r.count+1:1,isDragging:!0,originalOwnerId:e,sourceCoords:r==null?void 0:r.sourceCoords},s={};return t==="Revealed"&&(s.excludeOwnerId=e,s.onlyFaceDown=!0),{...a,...s,...n,...r&&{chainedAction:r.chainedAction,isDeployAbility:r.isDeployAbility,readyStatusToRemove:r.readyStatusToRemove}}}function Je(t,e){var n;const r=(n=t.sourceCard)==null?void 0:n.ownerId;return typeof r=="number"?r:typeof e=="number"?e:0}function ai(t,e,r){var g;const{gameState:n,localPlayerId:a,commandContext:s,triggerNoTarget:o,onAbilityComplete:i,handleActionExecution:d}=r;if(t.type==="ABILITY_COMPLETE"){i==null||i();return}if(t.type==="REVEREND_SETUP_SCORE"){oi(t,e,r);return}if(t.type==="GLOBAL_AUTO_APPLY"){si(t,e,r);return}if(!Ot(t,n,((g=t.sourceCard)==null?void 0:g.ownerId)||a,s)){o(e),t.chainedAction&&!t.skipChainedActionOnNoTargets&&setTimeout(()=>{d(t.chainedAction,e)},500);return}if(t.type==="CREATE_STACK"){ii(t,e,r);return}if(t.type==="OPEN_MODAL"){di(t,e,r);return}if(t.type==="ENTER_MODE"){ci(t,e,r);return}c.warn("[handleActionExecution] Unknown action type:",t.type)}function oi(t,e,r){var l,g;const{gameState:n,updatePlayerScore:a,triggerFloatingText:s,markAbilityUsed:o}=r,i=((l=t.sourceCard)==null?void 0:l.ownerId)??0;let d=0;for(let T=0;T<n.board.length;T++)for(let C=0;C<n.board[T].length;C++){const h=(g=n.board[T][C])==null?void 0:g.card;if(h!=null&&h.statuses){const R=h.statuses.filter(E=>E.type==="Exploit"&&E.addedByPlayerId===i);d+=R.length}}d>0&&a(i,d),s([{row:e.row,col:e.col,text:`+${d}`,playerId:i}]),o(e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function si(t,e,r){var R,E,f,m,A,w;const{gameState:n,localPlayerId:a,commandContext:s,markAbilityUsed:o,triggerNoTarget:i,triggerFloatingText:d,updatePlayerScore:l,applyGlobalEffect:g,addBoardCardStatus:T,removeStatusByType:C,handleActionExecution:h}=r;if(((R=t.payload)==null?void 0:R.customAction)==="FINN_SCORING"){const I=(E=t.sourceCard)==null?void 0:E.ownerId;if(I===void 0){c.warn("[FINN_SCORING] Source card missing ownerId"),o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}let u=0;if(n.players.forEach(p=>{p.id!==I&&p.hand.forEach(_=>{var D;(D=_.statuses)!=null&&D.some(O=>O.type==="Revealed"&&O.addedByPlayerId===I)&&u++})}),n.board.forEach(p=>{p.forEach(_=>{var O;const D=_.card;if(D&&D.ownerId!==I){const P=((O=D.statuses)==null?void 0:O.filter(b=>b.type==="Revealed"&&b.addedByPlayerId===I).length)||0;u+=P}})}),u>0){const p=t.sourceCoords||e;d({row:p.row,col:p.col,text:`+${u}`,playerId:I}),l(I,u)}o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}if(((f=t.payload)==null?void 0:f.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){t.sourceCoords&&t.sourceCoords.row>=0?C(t.sourceCoords,"Aim"):s.lastMovedCardCoords&&C(s.lastMovedCardCoords,"Aim");return}if((m=t.payload)!=null&&m.tokenType&&t.payload.filter){const{tokenType:I,filter:u}=t.payload,p=[],_=n.board.length;for(let D=0;D<_;D++)for(let O=0;O<_;O++){const P=n.board[D][O].card;P&&u(P,D,O)&&p.push({row:D,col:O})}if(p.length===0){i(t.sourceCoords||e),t.chainedAction&&setTimeout(()=>h(t.chainedAction,e),500),o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}p.forEach(D=>{var O;T(D,I,((O=t.sourceCard)==null?void 0:O.ownerId)||0)}),o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove),t.chainedAction&&setTimeout(()=>h(t.chainedAction,e),ae.MODE_CLEAR_DELAY);return}if((A=t.payload)!=null&&A.contextReward){Zn(t,e,r);return}if(t.payload&&!t.payload.cleanupCommand){const{tokenType:I,filter:u}=t.payload,p=[],_=n.board.length;if(t.payload.contextReward&&t.sourceCard){Zn(t,e,r);return}if(u)for(let D=0;D<_;D++)for(let O=0;O<_;O++){const P=n.board[D][O].card;P&&u(P)&&p.push({row:D,col:O})}else t.sourceCoords&&t.sourceCoords.row>=0?p.push(t.sourceCoords):e&&e.row>=0?p.push(e):s.lastMovedCardCoords&&p.push(s.lastMovedCardCoords);if(p.length>0){if(I){const D=t.payload.count||1,O=t.payload.ownerId!==void 0?t.payload.ownerId:((w=t.sourceCard)==null?void 0:w.ownerId)??a??0;for(let P=0;P<D;P++)g(e,p,I,O,!!t.isDeployAbility)}}else i(e),o(e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}}function ii(t,e,r){var l,g;const{gameState:n,setAbilityMode:a,setCursorStack:s,triggerNoTarget:o,localPlayerId:i}=r;let d=t.count||0;if(t.dynamicCount){const{factor:T,ownerId:C}=t.dynamicCount;let h=0;n.board.forEach(R=>{R.forEach(E=>{var f;if((f=E.card)!=null&&f.statuses){const m=E.card.statuses.filter(A=>A.type===T&&A.addedByPlayerId===C);h+=m.length}})}),d=h}if(d>0){a(null);let T=((l=t.sourceCard)==null?void 0:l.ownerId)??i??0;!((g=t.sourceCard)!=null&&g.ownerId)&&i!==null&&(T=i);const C={count:d,sourceCoords:t.sourceCoords||e,sourceCard:t.sourceCard,isDeployAbility:t.isDeployAbility,readyStatusToRemove:t.readyStatusToRemove,targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,requiredTargetStatus:t.requiredTargetStatus,requireStatusFromSourceOwner:t.requireStatusFromSourceOwner,mustBeAdjacentToSource:t.mustBeAdjacentToSource,mustBeInLineWithSource:t.mustBeInLineWithSource,maxDistanceFromSource:t.maxDistanceFromSource,maxOrthogonalDistance:t.maxOrthogonalDistance,placeAllAtOnce:t.placeAllAtOnce,replaceStatus:t.replaceStatus,chainedAction:t.chainedAction,recordContext:t.recordContext};s(gr(t.tokenType||"Aim",T,null,C))}else o(e)}function di(t,e,r){var l,g;const{gameState:n,localPlayerId:a,commandContext:s,setViewingDiscard:o,markAbilityUsed:i}=r;if(!Ot(t,n,((l=t.sourceCard)==null?void 0:l.ownerId)||a,s)){i(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}if(t.mode==="RETRIEVE_DEVICE"){const T=n.players.find(C=>{var h;return C.id===((h=t.sourceCard)==null?void 0:h.ownerId)});T&&(o({player:T,pickConfig:{filterType:"Device",action:"recover"}}),e.row>=0&&i(e,!!t.isDeployAbility,!1,t.readyStatusToRemove))}else if(t.mode==="IMMUNIS_RETRIEVE"){const T=n.players.find(C=>{var h;return C.id===((h=t.sourceCard)==null?void 0:h.ownerId)});T&&o({player:T,pickConfig:{filterType:"Optimates",action:"resurrect"}})}else if(t.mode==="SEARCH_DECK"){const T=n.players.find(C=>{var h;return C.id===((h=t.sourceCard)==null?void 0:h.ownerId)});T&&(o({player:T,pickConfig:{filterType:((g=t.payload)==null?void 0:g.filterType)||"Unit",action:"recover",isDeck:!0}}),e.row>=0&&i(e,!!t.isDeployAbility,!1,t.readyStatusToRemove))}i(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function ci(t,e,r){var h,R;const{gameState:n,localPlayerId:a,commandContext:s,triggerNoTarget:o,setAbilityMode:i,markAbilityUsed:d,addBoardCardStatus:l,setTargetingMode:g,handleActionExecution:T}=r,C=t.mode;if(C==="SHIELD_SELF_THEN_RIOT_PUSH"){const E=t.sourceCard.ownerId;if(l(e,"Shield",E),!Ot(t,n,E,s)){o(e),d(e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),g(t,Je(t,a),e,void 0,s);return}if(C==="SHIELD_SELF_THEN_SPAWN"){const E=Je(t,a);l(e,"Shield",E),i({...t,payload:{...t.payload,shieldApplied:!0}}),g(t,E,e);return}if(C==="PRINCEPS_SHIELD_THEN_AIM"){const E=Je(t,a);l(e,"Shield",E);const f={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};T(f,e);return}if(C==="GAWAIN_DEPLOY_SHIELD_AIM"){const E=t.sourceCard.ownerId;l(e,"Shield",E);const f={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};T(f,e);return}if(C==="ABR_DEPLOY_SHIELD_AIM"){const E=t.sourceCard.ownerId;l(e,"Shield",E);const f={type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};T(f,e);return}if(C==="RIOT_PUSH"){if(t.isDeployAbility){i(t),g(t,Je(t,a),e);return}if(!Ot(t,n,((h=t.sourceCard)==null?void 0:h.ownerId)||a,s)){o(t.sourceCoords||e),d(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),g(t,Je(t,a),e);return}if(C==="PATROL_MOVE"){i(t),g(t,Je(t,a),e);return}if(C==="SELECT_TARGET"){if(t.isDeployAbility){i(t),g(t,Je(t,a),e,void 0,s);return}if(!Ot(t,n,((R=t.sourceCard)==null?void 0:R.ownerId)||a,s)){o(t.sourceCoords||e),d(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),g(t,Je(t,a),e,void 0,s);return}i(t),g(t,Je(t,a),e)}function Zn(t,e,r){var m,A,w,I,u,p,_;const{gameState:n,commandContext:a,updatePlayerScore:s,triggerFloatingText:o,drawCardsBatch:i,removeBoardCardStatus:d,addBoardCardStatus:l,modifyBoardCardPower:g,markAbilityUsed:T}=r,C=(m=t.payload)==null?void 0:m.contextReward,h=a.lastMovedCardCoords||e;if(!h||h.row<0)return;let R=n.board[h.row][h.col].card;const E=((A=t.payload)==null?void 0:A._tempContextId)||a.lastMovedCardId;if((!R||E&&R.id!==E)&&E)for(let D=0;D<n.board.length;D++){for(let O=0;O<n.board[D].length;O++)if(((w=n.board[D][O].card)==null?void 0:w.id)===E){R=n.board[D][O].card;break}if(R)break}if(!R){c.warn("[ContextReward] No card at coords");return}const f=Math.max(0,R.power+(R.powerModifier||0)+(R.bonusPower||0));C==="DRAW_MOVED_POWER"||C==="DRAW_EQUAL_POWER"?i(((I=t.sourceCard)==null?void 0:I.ownerId)||0,f):C==="SCORE_MOVED_POWER"?(o({row:h.row,col:h.col,text:`+${f}`,playerId:((u=t.sourceCard)==null?void 0:u.ownerId)||0}),s(((p=t.sourceCard)==null?void 0:p.ownerId)||0,f)):C==="STUN_MOVED_UNIT"?l(h,"Stun",((_=t.sourceCard)==null?void 0:_.ownerId)||0):C==="REMOVE_AIM"?d(h,"Aim"):C==="WEAKEN"&&g(h,-1),T(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function li(t,e){var p;const{gameState:r,localPlayerId:n,abilityMode:a,setAbilityMode:s,cursorStack:o,commandContext:i,setCommandContext:d,playMode:l,draggedItem:g,interactionLock:T,handleActionExecution:C,handleDrop:h,moveItem:R,markAbilityUsed:E,spawnToken:f,resurrectDiscardedCard:m,updatePlayerScore:A,triggerFloatingText:w,handleLineSelection:I}=e;if(T.current)return!1;const u=r.board.length;if(g)return t.row>=0&&t.row<u&&t.col>=0&&t.col<r.board[t.row].length?(h(g,{location:"board",row:t.row,col:t.col}),!0):!1;if(o&&o.isDragging){if(it({location:"board",row:t.row,col:t.col},{...o.targetOwnerId!==void 0&&{targetOwnerId:o.targetOwnerId},...o.excludeOwnerId!==void 0&&{excludeOwnerId:o.excludeOwnerId},onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.targetType&&{targetType:o.targetType},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},...o.requireStatusFromSourceOwner!==void 0&&{requireStatusFromSourceOwner:o.requireStatusFromSourceOwner},...o.mustBeAdjacentToSource&&o.sourceCoords&&{mustBeAdjacentTo:o.sourceCoords},...o.mustBeInLineWithSource&&o.sourceCoords&&{mustBeInLineWith:o.sourceCoords},...o.maxDistanceFromSource!==void 0&&{maxDistance:o.maxDistanceFromSource},...o.range&&{range:o.range}},n??0,r.players)){let D=null;if(o.sourceCoords){const{row:O,col:P}=o.sourceCoords;O>=0&&O<u&&P>=0&&P<r.board[O].length&&(D=r.board[O][P].card)}if(D)return C({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:o.type,count:o.count,targetOwnerId:o.targetOwnerId,onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.range&&{range:o.range},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},cleanupCommand:!0},sourceCard:D,sourceCoords:o.sourceCoords},t),!0}return!1}if(a&&a.mode==="SPAWN_TOKEN"){const{sourceCoords:_,payload:D,sourceCard:O,isDeployAbility:P,readyStatusToRemove:b}=a;if(!_||!(D!=null&&D.tokenName)||!(Math.abs(t.row-_.row)+Math.abs(t.col-_.col)===1))return!1;const U=(O==null?void 0:O.ownerId)??((p=a.sourceCard)==null?void 0:p.ownerId);return f(t,D.tokenName,U),E(_,P,!1,b),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="SELECT_CELL"){const{sourceCoords:_,sourceCard:D,isDeployAbility:O,readyStatusToRemove:P,payload:b}=a,L=(()=>{var N;if(_&&_.row>=0)return _;if(!D)return null;for(let G=0;G<r.board.length;G++)for(let $=0;$<r.board.length;$++)if(((N=r.board[G][$].card)==null?void 0:N.id)===D.id)return{row:G,col:$};return null})();if(!L||!D)return!1;let U=!1;if((b==null?void 0:b.range)==="line")U=t.row===L.row||t.col===L.col;else if((b==null?void 0:b.range)==="global")U=!0;else if((b==null?void 0:b.range)===2){const N=Math.abs(t.row-L.row)+Math.abs(t.col-L.col);if(N===1)U=!0;else if(N===2){const G=L.row,$=L.col,q=t.row,Z=t.col;U=[{r:q,c:$},{r:G,c:Z},{r:(G+q)/2,c:($+Z)/2}].some(se=>{if(!Number.isInteger(se.r)||!Number.isInteger(se.c))return!1;const me=Math.floor((r.board.length-r.activeGridSize)/2),V=me,Ae=me+r.activeGridSize-1;return se.r<V||se.r>Ae||se.c<V||se.c>Ae||Math.abs(se.r-G)+Math.abs(se.c-$)!==1?!1:!r.board[se.r][se.c].card})}}else b!=null&&b.filter?U=b.filter(null,t.row,t.col):U=Math.abs(t.row-L.row)+Math.abs(t.col-L.col)===1;if(!U)return!1;if(b!=null&&b.moveFromHand&&i.selectedHandCard){const{playerId:N,cardIndex:G}=i.selectedHandCard,$=r.players.find(Z=>Z.id===N),q=$==null?void 0:$.hand[G];if(q)return R({card:q,source:"hand",playerId:N,cardIndex:G,isManual:!0},{target:"board",boardCoords:t}),E(_||t,O,!1,P),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(!((b==null?void 0:b.allowSelf)&&t.row===L.row&&t.col===L.col)){const N=r.board[L.row][L.col].card;N&&R({card:N,source:"board",boardCoords:L,bypassOwnershipCheck:!0},{target:"board",boardCoords:t})}if(b!=null&&b.recordContext&&d({lastMovedCardCoords:t,lastMovedCardId:D.id}),E(_||t,O,!1,P),b!=null&&b.chainedAction){const N={...b.chainedAction};N.targetOwnerId===-2&&(N.targetOwnerId=D.ownerId),b.recordContext&&(N.payload||(N.payload={}),N.payload._tempContextId=D.id),s(null),setTimeout(()=>{C(N,t)},ae.MODE_CLEAR_DELAY)}else setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY);return!0}if(a&&a.mode==="PATROL_MOVE"){const{sourceCoords:_,sourceCard:D,isDeployAbility:O,readyStatusToRemove:P}=a;if(!_||!D)return!1;if(t.row===_.row&&t.col===_.col)return E(_,O,!1,P),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0;const b=t.row===_.row,L=t.col===_.col;return!b&&!L||r.board[t.row][t.col].card!==null?!1:(R({card:D,source:"board",boardCoords:_},{target:"board",boardCoords:t}),E(t,O,!1,P),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0)}if(a&&a.mode==="RIOT_MOVE"){const{sourceCoords:_,sourceCard:D,isDeployAbility:O,readyStatusToRemove:P,payload:b}=a;return!_||!D||!(b!=null&&b.vacatedCoords)?!1:t.row===b.vacatedCoords.row&&t.col===b.vacatedCoords.col?(R({card:D,source:"board",boardCoords:_},{target:"board",boardCoords:t}),E(t,O,!1,P),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0):(E(_,O,!1,P),s(null),!0)}if(a&&a.mode==="IMMUNIS_RETRIEVE"){const{sourceCoords:_,payload:D,isDeployAbility:O,readyStatusToRemove:P,sourceCard:b}=a;if(!_||!(Math.abs(t.row-_.row)+Math.abs(t.col-_.col)===1))return!1;if((D==null?void 0:D.selectedCardIndex)!==void 0){const U=(b==null?void 0:b.ownerId)||0;return m(U,D.selectedCardIndex,t),E(_,O,!1,P),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}return!1}if(a&&a.mode==="INTEGRATOR_LINE_SELECT"){const{sourceCoords:_,sourceCard:D,isDeployAbility:O,readyStatusToRemove:P}=a;if(!_||_.row<0)return!1;const b=t.row===_.row,L=t.col===_.col;if(!b&&!L)return!1;const U=(D==null?void 0:D.ownerId)||0;let F=0;if(b)for(let N=0;N<u;N++){const G=r.board[t.row][N].card;G!=null&&G.statuses&&(F+=G.statuses.filter($=>$.type==="Exploit"&&$.addedByPlayerId===U).length)}else for(let N=0;N<u;N++){const G=r.board[N][t.col].card;N!==_.row&&G!=null&&G.statuses&&(F+=G.statuses.filter($=>$.type==="Exploit"&&$.addedByPlayerId===U).length)}return F>0&&(A(U,F),w({row:_.row,col:_.col,text:`+${F}`,playerId:U})),E(_,O,!1,P),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="IP_AGENT_THREAT_SCORING"){const{sourceCoords:_,sourceCard:D,isDeployAbility:O,readyStatusToRemove:P}=a;if(!_)return!1;const b=t.row===_.row,L=t.col===_.col;if(!b&&!L)return!1;const U=(D==null?void 0:D.ownerId)||0;let F=0;if(b)for(let G=0;G<u;G++){const $=r.board[t.row][G].card;$!=null&&$.statuses&&(F+=$.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===U).length)}else for(let G=0;G<u;G++){const $=r.board[G][t.col].card;G!==_.row&&$!=null&&$.statuses&&(F+=$.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===U).length)}const N=F*2;return N>0&&(A(U,N),w({row:_.row,col:_.col,text:`+${N}`,playerId:U})),E(_,O,!1,P),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="ZIUS_LINE_SELECT"){const{sourceCoords:_,sourceCard:D,isDeployAbility:O,readyStatusToRemove:P}=a,b=i.lastMovedCardCoords||_;if(!b)return!1;const L=t.row===b.row,U=t.col===b.col;if(!L&&!U)return!1;const F=(D==null?void 0:D.ownerId)||0;let N=0;const G=[];if(L)for(let $=0;$<u;$++){const q=r.board[t.row][$].card;if(q!=null&&q.statuses){const Z=q.statuses.filter(X=>X.type==="Exploit"&&X.addedByPlayerId===F);N+=Z.length,Z.length>0&&G.push({row:t.row,col:$})}}else for(let $=0;$<u;$++){const q=r.board[$][t.col].card;if($!==b.row&&q!=null&&q.statuses){const Z=q.statuses.filter(X=>X.type==="Exploit"&&X.addedByPlayerId===F);N+=Z.length,Z.length>0&&G.push({row:$,col:t.col})}}return N>0&&(A(F,N),G.forEach($=>{w({row:$.row,col:$.col,text:"+1",playerId:F})})),E(_||b,O,!1,P),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}return a!=null&&a.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","SELECT_LINE_START","SELECT_DIAGONAL"].includes(a.mode)?(I(t),!0):l!=null&&l.card&&l.sourceCoords?(h({card:l.card,source:"hand",playerId:l.playerId,cardIndex:l.cardIndex},{location:"board",row:t.row,col:t.col}),!0):!1}function ui(t,e,r,n){var A;const{gameState:a,localPlayerId:s,abilityMode:o,cursorStack:i,interactionLock:d,setCommandContext:l,setAbilityMode:g,moveItem:T,markAbilityUsed:C,handleActionExecution:h,triggerHandCardSelection:R,setCursorStack:E,clearTargetingMode:f,clearValidTargets:m}=n;if(!d.current){if(i){if(["Aim","Exploit","Stun","Shield"].includes(i.type))return;const I={targetOwnerId:i.targetOwnerId,excludeOwnerId:i.excludeOwnerId,onlyOpponents:i.onlyOpponents||i.targetOwnerId===-1,onlyFaceDown:i.onlyFaceDown,targetType:i.targetType,requiredTargetStatus:i.requiredTargetStatus,tokenType:i.type};if(it({card:e,ownerId:t.id,location:"hand"},I,a.activePlayerId,a.players)&&i.type==="Revealed"){const p=((A=i.sourceCard)==null?void 0:A.ownerId)??a.activePlayerId??s??1;e.statuses||(e.statuses=[]),e.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===p)||(e.statuses.push({type:"Revealed",addedByPlayerId:p}),T({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:t.id,cardIndex:r}),i.sourceCoords&&i.sourceCoords.row>=0&&C(i.sourceCoords,i.isDeployAbility,!1,i.readyStatusToRemove),i.count>1?E(D=>D?{...D,count:D.count-1}:null):(f(),m==null||m(),i.chainedAction&&h(i.chainedAction,i.sourceCoords||{row:-1,col:-1}),E(null)))}return}if((o==null?void 0:o.type)==="ENTER_MODE"&&o.mode==="SELECT_TARGET"){const{payload:w,sourceCoords:I,isDeployAbility:u,sourceCard:p,readyStatusToRemove:_}=o;if(R(t.id,r,a.activePlayerId??s??1),w.actionType==="SELECT_HAND_FOR_DEPLOY"){if(w.filter&&!w.filter(e))return;l(D=>({...D,selectedHandCard:{playerId:t.id,cardIndex:r}})),g({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,payload:{range:"global",moveFromHand:!0}});return}if(w.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(w.filter&&!w.filter(e)||t.id!==(p==null?void 0:p.ownerId))return;T({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),f(),m==null||m();const D={type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:p,sourceCoords:I,isDeployAbility:u,payload:{tokenName:w.tokenName}};g(D),I&&I.row>=0&&setTimeout(()=>{h(D,I)},0);return}if(w.actionType==="LUCIUS_SETUP"){if(t.id!==(p==null?void 0:p.ownerId))return;T({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),h({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:p,sourceCoords:I,isDeployAbility:u,payload:{filterType:"Command"}},I||{row:-1,col:-1}),g(null);return}if(w.actionType==="DESTROY"){if(w.filter&&!w.filter(e))return;T({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),I&&I.row>=0&&C(I,u,!1,_),setTimeout(()=>g(null),ae.MODE_CLEAR_DELAY)}}}}function fi(t,e,r){const{abilityMode:n,cursorStack:a,interactionLock:s,gameState:o,activateAbility:i}=r;n||a||s.current||o.isGameStarted&&o.activePlayerId===t.id&&Qo(e,"setup",o.currentPhase)&&i(e,{row:-1,col:-1})}function pi(t,e){var u,p,_,D,O;const{gameState:r,localPlayerId:n,abilityMode:a,interactionLock:s,setAbilityMode:o,markAbilityUsed:i,updatePlayerScore:d,triggerFloatingText:l,nextPhase:g,modifyBoardCardPower:T,scoreLine:C,scoreDiagonal:h,commandContext:R}=e;if(!a)return!1;const{mode:E,sourceCard:f,sourceCoords:m,payload:A,isDeployAbility:w,readyStatusToRemove:I}=a;if(E==="SCORE_LAST_PLAYED_LINE"&&a.sourceCoords){if(s.current)return!0;const{row:P,col:b}=a.sourceCoords,{row:L,col:U}=t;if(P!==L&&b!==U)return!0;s.current=!0;const F=r.activePlayerId,N=r.board.length;let G=P,$=P,q=b,Z=b;if(P===L)G=P,$=P,q=0,Z=N-1;else if(b===U)q=U,Z=U,G=0,$=N-1;else return s.current=!1,!0;const X=r.board.some(V=>V.some(Ae=>{var Le,we;return((Le=Ae.card)==null?void 0:Le.ownerId)===F&&Ae.card.name.toLowerCase().includes("data liberator")&&((we=Ae.card.statuses)==null?void 0:we.some(Te=>Te.type==="Support"))}));let se=0;const me=[];for(let V=G;V<=$;V++)for(let Ae=q;Ae<=Z;Ae++){const we=r.board[V][Ae].card;if(we&&!((u=we.statuses)!=null&&u.some(Te=>Te.type==="Stun"))){const Te=we.ownerId===F,Ne=(p=we.statuses)==null?void 0:p.some(He=>He.type==="Exploit"&&He.addedByPlayerId===F);if(Te||X&&Ne&&we.ownerId!==F){const He=Math.max(0,we.power+(we.powerModifier||0)+(we.bonusPower||0));He>0&&(se+=He,me.push({row:V,col:Ae,text:`+${He}`,playerId:F}))}}}return o(null),me.length>0&&l(me),se>0&&d(F,se),g(),setTimeout(()=>{s.current=!1},200),!0}if(E==="SELECT_LINE_START")return o({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:f,sourceCoords:m,isDeployAbility:w,payload:{...A,firstCoords:t}}),!0;if(E==="SELECT_LINE_END"&&(A!=null&&A.firstCoords)){const{row:P,col:b}=A.firstCoords,{row:L,col:U}=t;if(P!==L&&b!==U)return!0;const F=A.actionType,N=(f==null?void 0:f.ownerId)??((_=r.players.find(G=>G.id===r.activePlayerId))!=null&&_.isDummy?r.activePlayerId:n||r.activePlayerId);if(F==="ZIUS_SCORING"){const G=R.lastMovedCardCoords;if(G){const V=P===L&&G.row===P,Ae=b===U&&G.col===b;if(!V&&!Ae)return!0}const $=r.board.length;let q=0,Z=$-1,X=0,se=$-1;if(P===L)q=Z=P;else if(b===U)X=se=b;else return!0;let me=0;for(let V=q;V<=Z;V++)for(let Ae=X;Ae<=se;Ae++){const Le=r.board[V][Ae];Le.card&&(me+=((D=Le.card.statuses)==null?void 0:D.filter(we=>we.type==="Exploit"&&we.addedByPlayerId===N).length)||0)}me>0&&N&&(m&&l({row:m.row,col:m.col,text:`+${me}`,playerId:N}),d(N,me)),m&&m.row>=0&&i(m,w,!1,I)}else if(F==="CENTURION_BUFF"&&f&&m&&N){const G=r.board.length;let $=0,q=G-1,Z=0,X=G-1;P===L?$=q=P:Z=X=b;for(let se=$;se<=q;se++)for(let me=Z;me<=X;me++){const V=r.board[se][me].card;if(V){const Ae=V.id===f.id,Le=V.ownerId===N,we=r.players.find(He=>He.id===N),Te=r.players.find(He=>He.id===V.ownerId),Ne=(we==null?void 0:we.teamId)!==void 0&&(Te==null?void 0:Te.teamId)!==void 0&&we.teamId===Te.teamId;!Ae&&(Le||Ne)&&T({row:se,col:me},1)}}i(m,w,!1,I)}else(F==="SCORE_LINE"||!F)&&(C(P,b,L,U,N),A.skipNextPhase||g());return setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0}if(E==="SELECT_DIAGONAL"&&A.actionType==="SCORE_DIAGONAL"){const P=(f==null?void 0:f.ownerId)??((O=r.players.find(b=>b.id===r.activePlayerId))!=null&&O.isDummy?r.activePlayerId:n||r.activePlayerId);if(A.firstCoords){const{row:b,col:L}=A.firstCoords,{row:U,col:F}=t;return Math.abs(b-U)!==Math.abs(L-F)?(o(null),!0):(h(b,L,U,F,P,A.bonusType),A.skipNextPhase||g(),o(null),!0)}else return o({...a,payload:{...A,firstCoords:t}}),!0}return!1}function yi(t,e,r){const{gameState:n,localPlayerId:a,abilityMode:s,interactionLock:o,handleLineSelection:i}=r;if(!s||s.type!=="ENTER_MODE"||o.current||s.sourceCard&&s.sourceCard.id===t.id&&s.mode!=="SELECT_LINE_START"&&s.mode!=="INTEGRATOR_LINE_SELECT"&&s.mode!=="ZIUS_LINE_SELECT"&&s.mode!=="IP_AGENT_THREAT_SCORING"&&s.mode!=="SELECT_UNIT_FOR_MOVE"&&s.mode!=="SELECT_TARGET"&&s.mode!=="RIOT_PUSH"&&s.mode!=="RIOT_MOVE"&&s.mode!=="REVEREND_DOUBLE_EXPLOIT"&&s.mode!=="SHIELD_SELF_THEN_RIOT_PUSH")return!1;const{mode:d,payload:l,sourceCard:g}=s;return d==="SELECT_LINE_START"||d==="SELECT_LINE_END"?(i(e),!0):d==="SELECT_TARGET"&&l.tokenType?hi(t,e,r):d==="SELECT_TARGET"?mi(t,e,r):d==="RIOT_PUSH"?Ii(t,e,r):d==="SHIELD_SELF_THEN_RIOT_PUSH"?Ti(t,e,r):d==="RIOT_MOVE"?Ei(t,e,r):d==="SWAP_POSITIONS"?gi(t,e,r):d==="TRANSFER_STATUS_SELECT"?wi(t,e,r):d==="ZEALOUS_WEAKEN"?_i(t,e,r):d==="REVEREND_DOUBLE_EXPLOIT"?bi(t,e,r):d==="SELECT_UNIT_FOR_MOVE"?Ai(t,e,r):d==="PATROL_MOVE"?Si(t,e,r):d==="SPAWN_TOKEN"?Ci(t,e,r):d==="REVEAL_ENEMY"?Di(t,e,r):d==="SELECT_CELL"?Ri(t,e,r):d==="IMMUNIS_RETRIEVE"?Pi(t,e,r):d==="INTEGRATOR_LINE_SELECT"?ki(t,e,r):d==="IP_AGENT_THREAT_SCORING"?Oi(t,e,r):d==="ZIUS_LINE_SELECT"?vi(t,e,r):d==="SELECT_DIAGONAL"?Ni(t,e,r):d==="SCORE_LAST_PLAYED_LINE"?Mi(t,e,r):d==="SEARCH_DECK"?Li(t,e,r):d==="RETRIEVE_DEVICE"?Gi(t,e,r):d==="SELECT_DECK"?xi(t,e,r):!1}function hi(t,e,r){const{abilityMode:n,triggerClickWave:a,moveItem:s,markAbilityUsed:o,setAbilityMode:i,setCommandContext:d,handleActionExecution:l,clearValidTargets:g}=r,{payload:T,sourceCoords:C,isDeployAbility:h,readyStatusToRemove:R}=n;if(T.filter&&!T.filter(t,e.row,e.col))return!1;if(s({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:T.tokenType,count:T.count||1},{target:"board",boardCoords:e}),a("board",e),T.recordContext&&d({lastMovedCardCoords:e,lastMovedCardId:t.id}),T.chainedAction){const E={...T.chainedAction,sourceCard:T.chainedAction.sourceCard??t,sourceCoords:T.chainedAction.sourceCoords??e,isDeployAbility:h,recordContext:!0};l(E,e),setTimeout(()=>a("board",e),100),E.type!=="ENTER_MODE"&&(i(null),g())}else C&&C.row>=0&&o(C,h,!1,R),setTimeout(()=>{i(null),g()},ae.MODE_CLEAR_DELAY);return!0}function mi(t,e,r){var u,p,_,D,O,P;const{abilityMode:n,markAbilityUsed:a,setAbilityMode:s,moveItem:o,modifyBoardCardPower:i,addBoardCardStatus:d,removeBoardCardStatus:l,removeBoardCardStatusByOwner:g,removeStatusByType:T,resetDeployStatus:C,setCounterSelectionData:h,handleActionExecution:R,gameState:E}=r,{payload:f,sourceCoords:m,isDeployAbility:A,readyStatusToRemove:w}=n,I=((u=n.sourceCard)==null?void 0:u.ownerId)??((p=E.players.find(b=>b.id===E.activePlayerId))!=null&&p.isDummy?E.activePlayerId:r.localPlayerId||E.activePlayerId);if(f.actionType==="OPEN_COUNTER_MODAL")return f.filter&&!f.filter(t)?!1:(h({card:t,callbackAction:f.rewardType}),s(null),!0);if(f.actionType==="SACRIFICE_AND_BUFF_LINES"){if(f.filter&&!f.filter(t,e.row,e.col))return!1;const b=((_=n.sourceCard)==null?void 0:_.ownerId)??I;o({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"discard",playerId:t.ownerId});const L=E.board.length,{row:U,col:F}=e;for(let N=0;N<L;N++){if(N===F)continue;const $=E.board[U][N].card;$&&$.ownerId===b&&i({row:U,col:N},1)}for(let N=0;N<L;N++){if(N===U)continue;const $=E.board[N][F].card;$&&$.ownerId===b&&i({row:N,col:F},1)}return a(m||e,A,!1,w),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(f.actionType==="SHIELD_AND_REMOVE_AIM")return f.filter&&!f.filter(t)?!1:(d(e,"Shield",I),T(e,"Aim"),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0);if(f.actionType==="RESET_DEPLOY")return f.filter&&!f.filter(t)?!1:(C(e),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0);if(f.actionType==="MODIFY_POWER")return f.filter&&!f.filter(t)?!1:(f.amount&&i(e,f.amount),m&&m.row>=0&&a(m,A,!1,w),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0);if(f.actionType==="DESTROY")return f.filter&&!f.filter(t)?!1:(((D=t.statuses)==null?void 0:D.some(L=>L.type==="Shield"))?l(e,"Shield"):((O=t.statuses)!=null&&O.find(U=>U.type==="Aim")&&T(e,"Aim"),o({card:t,source:"board",boardCoords:e},{target:"discard",playerId:t.ownerId})),a(m||e,A,!1,w),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0);if(f.actionType==="LUCIUS_SETUP")return f.filter&&!f.filter(t)?!1:(o({card:t,source:"board",boardCoords:e},{target:"discard",playerId:t.ownerId}),f.chainedAction&&R(f.chainedAction,e),!0);if(f.actionType==="CENSOR_SWAP"){if(f.filter&&!f.filter(t))return!1;const b=((P=t.statuses)==null?void 0:P.filter(L=>L.type==="Exploit"&&L.addedByPlayerId===I).length)||0;if(b>0){g(e,"Exploit",I);for(let L=0;L<b;L++)d(e,"Stun",I)}return a(m||e,A,!1,w),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(f.actionType==="REVEAL_ENEMY_CHAINED"){if(f.filter&&!f.filter(t,e.row,e.col))return!1;const b=t.ownerId;if(n.chainedAction){const L={...n.chainedAction,targetOwnerId:b,sourceCoords:m||e,sourceCard:n.sourceCard};R(L,e)}return a(m||e,A,!1,w),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}return!1}function Ii(t,e,r){const{abilityMode:n,gameState:a,setAbilityMode:s,moveItem:o,markAbilityUsed:i,interactionLock:d}=r;if(d.current)return!1;const{sourceCoords:l,isDeployAbility:g,readyStatusToRemove:T,sourceCard:C}=n;if(!l||l.row<0)return!1;if(e.row===l.row&&e.col===l.col)return i(l,g,!1,T),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0;const h=Math.abs(e.row-l.row)+Math.abs(e.col-l.col)===1,R=a.players.find(O=>O.id===t.ownerId),E=a.players.find(O=>O.id===(C==null?void 0:C.ownerId)),f=(R==null?void 0:R.teamId)!==void 0&&(E==null?void 0:E.teamId)!==void 0&&R.teamId===E.teamId;if(!h||t.ownerId===(C==null?void 0:C.ownerId)||f)return!1;const m=e.row-l.row,A=e.col-l.col,w=e.row+m,I=e.col+A,u=a.board.length,p=Math.floor((u-a.activeGridSize)/2),_=p,D=p+a.activeGridSize-1;return w<_||w>D||I<_||I>D||a.board[w][I].card!==null?!1:(o({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:w,col:I}}),s({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:C,sourceCoords:l,isDeployAbility:g,payload:{vacatedCoords:e}}),!0)}function Ei(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="RIOT_MOVE")return!1;const{sourceCoords:i,sourceCard:d,isDeployAbility:l,readyStatusToRemove:g,payload:T}=n;return!i||!d||!(T!=null&&T.vacatedCoords)?!1:e.row===T.vacatedCoords.row&&e.col===T.vacatedCoords.col?(a({card:d,source:"board",boardCoords:i},{target:"board",boardCoords:e}),s(e,l,!1,g),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0):(s(i,l,!1,g),o(null),!0)}function Ti(t,e,r){const{abilityMode:n,gameState:a,setAbilityMode:s,addBoardCardStatus:o,markAbilityUsed:i,interactionLock:d,setTargetingMode:l,commandContext:g}=r;if(d.current)return!1;const{sourceCoords:T,isDeployAbility:C,readyStatusToRemove:h,sourceCard:R}=n;if(!T||T.row<0||!R)return!1;const E=R.ownerId;if(e.row===T.row&&e.col===T.col){o(T,"Shield",E),i(T,C,!1,h);const f={type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:R,sourceCoords:T,isDeployAbility:!1,payload:{}};return s(f),l(f,E,T,void 0,g),!0}return!1}function gi(t,e,r){const{abilityMode:n,gameState:a,swapCards:s,markAbilityUsed:o,setAbilityMode:i,validTargets:d}=r;if(!n||n.mode!=="SWAP_POSITIONS")return!1;const{sourceCoords:l,sourceCard:g,isDeployAbility:T,readyStatusToRemove:C,payload:h}=n;if(!l||l.row<0)return!1;const R=a.board[l.row][l.col].card;return!R||R.id!==(g==null?void 0:g.id)?(i(null),!1):g&&g.id===t.id||h.filter&&!h.filter(t,e.row,e.col)||!h.filter&&d&&!d.some(f=>f.row===e.row&&f.col===e.col)?!1:(s(l,e),o(e,T,!1,C),setTimeout(()=>i(null),ae.MODE_CLEAR_DELAY),!0)}function wi(t,e,r){const{abilityMode:n,transferStatus:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="TRANSFER_STATUS_SELECT")return!1;const{sourceCoords:i,sourceCard:d,isDeployAbility:l,readyStatusToRemove:g}=n;return!i||i.row<0||d&&d.id===t.id||!t.statuses||t.statuses.length===0?!1:(a(e,i,t.statuses[0].type),s(i,l,!1,g),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0)}function _i(t,e,r){const{abilityMode:n,modifyBoardCardPower:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="ZEALOUS_WEAKEN")return!1;const{payload:i,sourceCoords:d,isDeployAbility:l,readyStatusToRemove:g}=n;return i.filter&&!i.filter(t)?!1:(a(e,-1),s(d||e,l,!1,g),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0)}function bi(t,e,r){const{abilityMode:n,addBoardCardStatus:a,markAbilityUsed:s,triggerFloatingText:o,setAbilityMode:i}=r;if(!n||n.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{sourceCoords:d,sourceCard:l,isDeployAbility:g,readyStatusToRemove:T}=n,C=(l==null?void 0:l.ownerId)||0,h=(t.statuses||[]).filter(R=>R.type==="Exploit"&&R.addedByPlayerId===C).length;if(h>0){for(let R=0;R<h;R++)a(e,"Exploit",C);o({row:e.row,col:e.col,text:`+${h}`,playerId:C,timestamp:Date.now()})}return s(d||e,g,!1,T),setTimeout(()=>i(null),ae.MODE_CLEAR_DELAY),!0}function Ai(t,e,r){const{abilityMode:n,setAbilityMode:a}=r;if(!n||n.mode!=="SELECT_UNIT_FOR_MOVE")return!1;const{sourceCard:s,payload:o,isDeployAbility:i,readyStatusToRemove:d}=n;return s&&s.id===t.id||o.filter&&!o.filter(t,e.row,e.col)?!1:(a({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,sourceCoords:e,isDeployAbility:i,readyStatusToRemove:d,payload:{range:o.range||2,moveFromHand:o.moveFromHand||!1,selectedCard:t,allowSelf:!1}}),!0)}function Si(t,e,r){const{abilityMode:n,gameState:a,moveItem:s,markAbilityUsed:o,setAbilityMode:i}=r;if(!n||n.mode!=="PATROL_MOVE")return!1;const{sourceCoords:d,sourceCard:l,isDeployAbility:g,readyStatusToRemove:T}=n;if(!d||!l)return!1;if(e.row===d.row&&e.col===d.col)return o(d,g,!1,T),setTimeout(()=>i(null),ae.MODE_CLEAR_DELAY),!0;const C=e.row===d.row,h=e.col===d.col;return!C&&!h||a.board[e.row][e.col].card!==null?!1:(s({card:l,source:"board",boardCoords:d},{target:"board",boardCoords:e}),o(e,g,!1,T),setTimeout(()=>i(null),ae.MODE_CLEAR_DELAY),!0)}function Ci(t,e,r){var R;const{abilityMode:n,spawnToken:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="SPAWN_TOKEN")return!1;const{sourceCoords:i,payload:d,isDeployAbility:l,readyStatusToRemove:g,sourceCard:T}=n;if(!i||!(d!=null&&d.tokenName)||!(Math.abs(e.row-i.row)+Math.abs(e.col-i.col)===1))return!1;const h=(T==null?void 0:T.ownerId)??((R=n.sourceCard)==null?void 0:R.ownerId);return a(e,d.tokenName,h),s(i,l,!1,g),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0}function Di(t,e,r){var w;const{abilityMode:n,setAbilityMode:a,setCursorStack:s,markAbilityUsed:o,gameState:i,localPlayerId:d}=r;if(!n||n.mode!=="REVEAL_ENEMY")return!1;const{sourceCoords:l,sourceCard:g,isDeployAbility:T,readyStatusToRemove:C}=n;if(!l||!g||!(Math.abs(e.row-l.row)+Math.abs(e.col-l.col)===1)||t.deck==="Tokens"||((w=t.types)==null?void 0:w.includes("Token")))return!1;const E=t.ownerId,f=i.players.find(I=>I.id===i.activePlayerId),m=f!=null&&f.isDummy&&i.activePlayerId!==null?i.activePlayerId:d??0;return s(gr("Revealed",m,null,{targetOwnerId:E,onlyFaceDown:!0,sourceCoords:e,sourceCard:t,isDeployAbility:T,readyStatusToRemove:C})),o(l,T,!1,C),setTimeout(()=>a(null),ae.MODE_CLEAR_DELAY),!0}function Ri(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="SELECT_CELL")return!1;const{sourceCoords:i,sourceCard:d,isDeployAbility:l,readyStatusToRemove:g,payload:T}=n;return T!=null&&T.filter&&!T.filter(null,e.row,e.col)?!1:(T!=null&&T.moveFromHand&&(T!=null&&T.selectedCard)?a({card:T.selectedCard,source:"hand"},{target:"board",boardCoords:e}):i&&i.row>=0&&d&&a({card:d,source:"board",boardCoords:i},{target:"board",boardCoords:e}),s(i||e,l,!1,g),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0)}function Pi(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="IMMUNIS_RETRIEVE")return!1;const{sourceCoords:i,payload:d,isDeployAbility:l,readyStatusToRemove:g}=n;return!i||!(Math.abs(e.row-i.row)+Math.abs(e.col-i.col)===1)?!1:d!=null&&d.selectedCard?(a({card:d.selectedCard,source:"discard"},{target:"board",boardCoords:e}),s(i,l,!1,g),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0):!1}function ki(t,e,r){const{abilityMode:n,gameState:a,markAbilityUsed:s,updatePlayerScore:o,triggerFloatingText:i,setAbilityMode:d}=r;if(!n||n.mode!=="INTEGRATOR_LINE_SELECT")return!1;const{sourceCoords:l,sourceCard:g,isDeployAbility:T,readyStatusToRemove:C}=n,h=(g==null?void 0:g.ownerId)||0,R=l!==void 0&&e.row===l.row,E=l!==void 0&&e.col===l.col;if(!R&&!E)return!1;let f=0;if(R&&l)for(let m=0;m<a.board.length;m++){const A=a.board[e.row][m].card;A!=null&&A.statuses&&(f+=A.statuses.filter(w=>w.type==="Exploit"&&w.addedByPlayerId===h).length)}else if(l)for(let m=0;m<a.board.length;m++){const A=a.board[m][e.col].card;m!==l.row&&A!=null&&A.statuses&&(f+=A.statuses.filter(w=>w.type==="Exploit"&&w.addedByPlayerId===h).length)}return f>0&&(o(h,f),i({row:l.row,col:l.col,text:`+${f}`,playerId:h,timestamp:Date.now()})),s(l||e,T,!1,C),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0}function Oi(t,e,r){const{abilityMode:n,gameState:a,updatePlayerScore:s,triggerFloatingText:o,markAbilityUsed:i,setAbilityMode:d}=r;if(!n||n.mode!=="IP_AGENT_THREAT_SCORING")return!1;const{sourceCoords:l,sourceCard:g,isDeployAbility:T,readyStatusToRemove:C}=n,h=(g==null?void 0:g.ownerId)||0;if(!l)return!1;const R=e.row===l.row,E=e.col===l.col;if(!R&&!E)return!1;let f=0;if(R)for(let A=0;A<a.board.length;A++){const w=a.board[e.row][A].card;w!=null&&w.statuses&&(f+=w.statuses.filter(I=>I.type==="Threat"&&I.addedByPlayerId===h).length)}else for(let A=0;A<a.board.length;A++){const w=a.board[A][e.col].card;A!==l.row&&w!=null&&w.statuses&&(f+=w.statuses.filter(I=>I.type==="Threat"&&I.addedByPlayerId===h).length)}const m=f*2;return m>0&&(s(h,m),o({row:l.row,col:l.col,text:`+${m}`,playerId:h,timestamp:Date.now()})),i(l||e,T,!1,C),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0}function vi(t,e,r){const{abilityMode:n,gameState:a,commandContext:s,updatePlayerScore:o,triggerFloatingText:i,markAbilityUsed:d,setAbilityMode:l}=r;if(!n||n.mode!=="ZIUS_LINE_SELECT")return!1;const{sourceCoords:g,sourceCard:T,isDeployAbility:C,readyStatusToRemove:h}=n,R=(T==null?void 0:T.ownerId)||0,E=s.lastMovedCardCoords||g;if(!E)return!1;const f=e.row===E.row,m=e.col===E.col;if(!f&&!m)return!1;let A=0;const w=[];if(f)for(let I=0;I<a.board.length;I++){const u=a.board[e.row][I].card;if(u!=null&&u.statuses){const p=u.statuses.filter(_=>_.type==="Exploit"&&_.addedByPlayerId===R);A+=p.length,p.length>0&&w.push({row:e.row,col:I})}}else for(let I=0;I<a.board.length;I++){const u=a.board[I][e.col].card;if(I!==E.row&&u!=null&&u.statuses){const p=u.statuses.filter(_=>_.type==="Exploit"&&_.addedByPlayerId===R);A+=p.length,p.length>0&&w.push({row:I,col:e.col})}}return A>0&&(o(R,A),w.forEach(I=>{i({row:I.row,col:I.col,text:"+1",playerId:R,timestamp:Date.now()})})),d(g||e,C,!1,h),setTimeout(()=>l(null),ae.MODE_CLEAR_DELAY),!0}function Ni(t,e,r){var _;const{abilityMode:n,gameState:a,markAbilityUsed:s,updatePlayerScore:o,triggerFloatingText:i,setAbilityMode:d}=r;if(!n||n.mode!=="SELECT_DIAGONAL")return!1;const{sourceCoords:l,sourceCard:g,isDeployAbility:T,readyStatusToRemove:C,payload:h}=n,R=(g==null?void 0:g.ownerId)||0,{row:E,col:f}=e,{row:m,col:A}=l||{row:0,col:0},w=E-f===m-A,I=E+f===m+A;if(!w&&!I)return!1;if(h!=null&&h.selectForMove&&t)return h.chainedAction&&r.handleActionExecution(h.chainedAction,e),!0;let u=0;const p=a.board.length;if(w){const D=m-A;for(let O=0;O<p;O++){const P=D+O,b=O;if(P>=0&&P<p&&b>=0&&b<p){const L=a.board[P][b].card;L!=null&&L.statuses&&(u+=L.statuses.filter(U=>U.type==="Exploit"&&U.addedByPlayerId===R).length)}}}if(I){const D=m+A;for(let O=0;O<p;O++){const P=O,b=D-P;if(P>=0&&P<p&&b>=0&&b<p){const L=a.board[P][b].card;L!=null&&L.statuses&&(u+=L.statuses.filter(U=>U.type==="Exploit"&&U.addedByPlayerId===R).length)}}}return h!=null&&h.bonusForSupport&&((_=g==null?void 0:g.statuses)!=null&&_.some(D=>D.type==="Support"))&&(u+=h.bonusForSupport),u>0&&(o(R,u),i({row:(l==null?void 0:l.row)||e.row,col:(l==null?void 0:l.col)||e.col,text:`+${u}`,playerId:R,timestamp:Date.now()})),s(l||e,T,!1,C),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0}function Mi(t,e,r){const{abilityMode:n,gameState:a,commandContext:s,markAbilityUsed:o,updatePlayerScore:i,triggerFloatingText:d,setAbilityMode:l}=r;if(!n||n.mode!=="SCORE_LAST_PLAYED_LINE")return!1;const{sourceCoords:g,sourceCard:T,isDeployAbility:C,readyStatusToRemove:h,payload:R}=n,E=(T==null?void 0:T.ownerId)||0,f=s.lastMovedCardCoords;if(!f)return!1;const m=a.board[f.row][f.col].card;if(!m)return!1;const A=e.row===f.row,w=e.col===f.col;if(!A&&!w)return!1;const I=Math.max(0,m.power+(m.powerModifier||0));return(R==null?void 0:R.rewardType)==="SCORE"?(i(E,I),d({row:f.row,col:f.col,text:`+${I}`,playerId:E,timestamp:Date.now()})):R==null||R.rewardType,o(g||e,C,!1,h),setTimeout(()=>l(null),ae.MODE_CLEAR_DELAY),!0}function Li(t,e,r){const{abilityMode:n,setViewingDiscard:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="SEARCH_DECK")return!1;const{sourceCoords:i,isDeployAbility:d,readyStatusToRemove:l}=n;return a(!0),s(i||e,d,!1,l),o(null),!0}function Gi(t,e,r){const{abilityMode:n,setViewingDiscard:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="RETRIEVE_DEVICE")return!1;const{sourceCoords:i,isDeployAbility:d,readyStatusToRemove:l}=n;return a(!0),s(i||e,d,!1,l),o(null),!0}function xi(t,e,r){const{abilityMode:n,triggerDeckSelection:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="SELECT_DECK")return!1;const{sourceCoords:i,isDeployAbility:d,readyStatusToRemove:l}=n;return a(t.ownerId??0),s(i||e,d,!1,l),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0}const cd=({gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,setCursorStack:s,commandContext:o,setCommandContext:i,setViewingDiscard:d,triggerNoTarget:l,triggerClickWave:g,playMode:T,setPlayMode:C,setCounterSelectionData:h,interactionLock:R,onAbilityComplete:E,moveItem:f,drawCardsBatch:m,updatePlayerScore:A,markAbilityUsed:w,applyGlobalEffect:I,swapCards:u,transferStatus:p,transferAllCounters:_,resurrectDiscardedCard:D,spawnToken:O,scoreLine:P,nextPhase:b,modifyBoardCardPower:L,addBoardCardStatus:U,removeBoardCardStatus:F,removeBoardCardStatusByOwner:N,resetDeployStatus:G,scoreDiagonal:$,removeStatusByType:q,triggerFloatingText:Z,triggerHandCardSelection:X,clearValidTargets:se,setTargetingMode:me,clearTargetingMode:V,validTargets:Ae})=>{const Le=x.useRef(()=>{}),we=x.useCallback(Se=>{pi(Se,{gameState:t,localPlayerId:e,abilityMode:r,interactionLock:R,setAbilityMode:n,markAbilityUsed:w,updatePlayerScore:A,triggerFloatingText:Z,nextPhase:b,modifyBoardCardPower:L,scoreLine:P,scoreDiagonal:$,commandContext:o})},[r,t,e,R,n,w,A,Z,b,L,P,$,o]);Le.current=we;const Te=x.useCallback((Se,Y)=>{ai(Se,Y,{gameState:t,localPlayerId:e,setAbilityMode:n,setCursorStack:s,commandContext:o,markAbilityUsed:w,triggerNoTarget:l,handleActionExecution:Te,modifyBoardCardPower:L,addBoardCardStatus:U,removeBoardCardStatus:F,removeStatusByType:q,updatePlayerScore:A,triggerFloatingText:Z,setViewingDiscard:d,handleLineSelection:Le.current,onAbilityComplete:E,applyGlobalEffect:I,drawCardsBatch:m,setTargetingMode:me})},[t,e,r,n,a,s,o,i,C,w,l,R,f,u,p,_,O,L,U,F,N,q,G,A,Z,h,d,Ae,E,I,m,me]);x.useEffect(()=>{(r==null?void 0:r.type)==="GLOBAL_AUTO_APPLY"&&(Te(r,r.sourceCoords||{row:-1,col:-1}),n(null))},[r,Te,n]),x.useEffect(()=>{r||V()},[r,V]);const Ne=x.useCallback((Se,Y)=>{Xn(Se,Y,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,handleActionExecution:Te,markAbilityUsed:w})},[t,e,r,a,Te,w]),He=x.useCallback((Se,Y)=>{var je,ut,Mt;if(a&&C!==null&&C!==void 0){const Tt={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};if(it({card:Se,ownerId:Se.ownerId??0,location:"board"},Tt,t.activePlayerId,t.players)){if(a.type==="Revealed"){const rt=((je=a.sourceCard)==null?void 0:je.ownerId)??t.activePlayerId??e??1;if((ut=Se.statuses)==null?void 0:ut.some(Lt=>Lt.type==="Revealed"&&Lt.addedByPlayerId===rt))return}const gt=a.originalOwnerId??((Mt=a.sourceCard)==null?void 0:Mt.ownerId)??t.activePlayerId??e??1;f({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:a.type,ownerId:gt,count:1},{target:"board",boardCoords:Y}),a.sourceCoords&&a.sourceCoords.row>=0&&w(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?s(rt=>rt?{...rt,count:rt.count-1}:null):(V(),se(),a.chainedAction&&Te(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),s(null))}return}if(!R.current){if(!r&&!a&&t.isGameStarted&&aa(Se,t)){Ne(Se,Y);return}if(r&&(r.mode==="SCORE_LAST_PLAYED_LINE"||r.mode==="SELECT_LINE_END")){we(Y);return}(r==null?void 0:r.type)==="ENTER_MODE"&&yi(Se,Y,{gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,setCursorStack:s,commandContext:o,setCommandContext:i,playMode:null,setPlayMode:C,draggedItem:null,setDraggedItem:()=>{},openContextMenu:()=>{},markAbilityUsed:w,triggerNoTarget:l,triggerClickWave:g,triggerDeckSelection:()=>{},handleActionExecution:Te,interactionLock:R,moveItem:f,swapCards:u,transferStatus:p,transferAllCounters:_,spawnToken:O,modifyBoardCardPower:L,addBoardCardStatus:U,removeBoardCardStatus:F,removeBoardCardStatusByOwner:N,removeStatusByType:q,resetDeployStatus:G,updatePlayerScore:A,triggerFloatingText:Z,setCounterSelectionData:h,setViewingDiscard:d,clearValidTargets:se,validTargets:Ae,handleLineSelection:we})||!r&&!a&&Ne(Se,Y)}},[a,C,t,e,R,r,we,f,w,s,Te,n,i,h,d,O,u,p,_,L,U,F,N,q,G,A,Z,l,g,Ae,V,Ne]),tt=x.useCallback(Se=>{li(Se,{gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,commandContext:o,setCommandContext:i,playMode:T,draggedItem:null,interactionLock:R,handleActionExecution:Te,handleDrop:f,moveItem:f,markAbilityUsed:w,spawnToken:O,resurrectDiscardedCard:D,updatePlayerScore:A,triggerFloatingText:Z,handleLineSelection:we})},[t,e,r,n,a,o,i,T,R,Te,f,s,l,w,O,D,A,Z,we]),zt=x.useCallback((Se,Y,je)=>{ui(Se,Y,je,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,interactionLock:R,setCommandContext:i,setAbilityMode:n,moveItem:f,markAbilityUsed:w,handleActionExecution:Te,triggerHandCardSelection:X,setCursorStack:s,clearTargetingMode:V,clearValidTargets:se})},[r,a,t,e,Te,w,n,i,X,f,s,V,se,R]),lt=x.useCallback((Se,Y)=>{fi(Se,Y,{gameState:t,abilityMode:r,cursorStack:a,interactionLock:R,activateAbility:(je,ut)=>Xn(je,ut,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,handleActionExecution:Te,markAbilityUsed:w})})},[r,a,t,e,Te,w,n,i,X,f,s,V,se,R]);return{activateAbility:Ne,executeAction:Te,handleLineSelection:we,handleBoardCardClick:He,handleEmptyCellClick:tt,handleHandCardClick:zt,handleAnnouncedCardDoubleClick:lt}},or=(t,e,r,n,a)=>{const s=(r.baseId||t.split("_")[1]||t).toLowerCase(),o=e===-1,i=[];s==="overwatch"?o?i.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):e===0?i.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},targetOwnerId:-1,onlyOpponents:!0,sourceCard:r}):e===1&&i.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:a,baseCount:0}},sourceCard:r}):s==="tacticalmaneuver"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:l=>l.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:r}}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:l=>l.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:r}}}):s==="inspiration"?o&&i.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"OPEN_COUNTER_MODAL",filter:l=>l.ownerId===a}}):s==="datainterception"?o?i.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r}):e===0?i.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:l=>{var g;return((g=l.statuses)==null?void 0:g.some(T=>T.type==="Exploit"&&T.addedByPlayerId===a))||!1}}}):s==="falseorders"?o?i.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):e===0?i.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:a,sourceCard:r,originalOwnerId:r.ownerId}}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:a}}}}):s==="experimentalstimulants"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"RESET_DEPLOY",filter:l=>{var g;return l.ownerId===a&&((g=l.types)==null?void 0:g.includes("Unit"))}}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:"line",filter:l=>l.ownerId===a}}):s==="logisticschain"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):s==="quickresponseteam"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:l=>{var g;return l.ownerId===a&&((g=l.types)==null?void 0:g.includes("Unit"))}}}):e===1&&i.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:r,payload:{filterType:"Unit"}}):s==="temporaryshelter"?e===0?i.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:r,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):e===1&&i.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:r,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):s==="enhancedinterrogation"?o?i.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):e===0?i.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:l=>{var g;return((g=l.statuses)==null?void 0:g.some(T=>T.type==="Aim"&&T.addedByPlayerId===a))||!1}}}):(s==="mobilization1"||s==="linebreach")&&o&&i.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:r,payload:{actionType:"SCORE_LINE"}});const d=r.ownerId||a;return i.forEach(l=>{l.originalOwnerId=d,l.sourceCard&&!l.sourceCard.ownerId&&(l.sourceCard.ownerId=d)}),i},ld=({gameState:t,localPlayerId:e,setActionQueue:r,setCommandContext:n,setCommandModalCard:a,setCounterSelectionData:s,moveItem:o,updatePlayerScore:i,updateState:d})=>{const l=x.useCallback((C,h)=>{if(e===null)return;const R=t.players.find(A=>A.id===h.playerId);if(!(h.playerId===e||(R==null?void 0:R.isDummy)))return;o(h,{target:"announced",playerId:h.playerId}),n({});const f=(C.baseId||C.id.split("_")[1]||C.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(A=>f.includes(A)))a(C);else{const A=or(C.id,-1,C,t,h.playerId);A.length>0?r([...A,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:C,ownerId:h.playerId},sourceCard:C}]):r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:C,ownerId:h.playerId},sourceCard:C}])}},[t,e,o,r,n,a]),g=x.useCallback((C,h)=>{var w,I;if(!h||e===null)return;const R=h.ownerId||e,E=[],f=or(h.id,-1,h,t,R);let m;(w=h.baseId)!=null&&w.toLowerCase().includes("inspiration")&&(m=C===0?"DRAW_REMOVED":"SCORE_REMOVED",f.length>0&&f[0].type==="ENTER_MODE"&&(f[0]={...f[0],payload:{...f[0].payload,rewardType:m}})),f.forEach(u=>{E.push(u)}),or(h.id,C,h,t,R).forEach(u=>{E.push(u)}),(I=h.baseId)!=null&&I.toLowerCase().includes("inspiration")||E.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:h,ownerId:R},sourceCard:h}),r(E),a(null)},[t,e,r,a]),T=x.useCallback((C,h)=>{var m;if(e===null)return;const R=h.card.ownerId||e;let E=null;for(let A=0;A<t.board.length;A++){for(let w=0;w<t.board[A].length;w++)if(((m=t.board[A][w].card)==null?void 0:m.id)===h.card.id){E={row:A,col:w};break}if(E)break}if(!E){c.warn(`Card ${h.card.id} not found on board during counter removal`),s(null);return}if(d(A=>{if(!A.isGameStarted)return A;const w=he(A),I=w.board[E.row][E.col].card;let u=0;const p=(I==null?void 0:I.statuses)??[];if(Object.entries(C).forEach(([_,D])=>{for(let O=0;O<D;O++){const P=p.map(b=>b.type).lastIndexOf(_);P>-1&&(I!=null&&I.statuses)&&(I.statuses.splice(P,1),u++)}}),!(I!=null&&I.statuses)&&I&&(I.statuses=[]),w.board=xe(w),u>0&&h.callbackAction==="DRAW_REMOVED"){const _=w.players.find(D=>D.id===R);if(_){const D=Math.min(u,_.deck.length);for(let O=0;O<D;O++){const P=_.deck.shift();P&&_.hand.push(P)}}}return w}),h.callbackAction==="SCORE_REMOVED"){const A=Object.values(C).reduce((w,I)=>w+I,0);A>0&&i(R,A)}const f=t.players.find(A=>A.id===R);f!=null&&f.announcedCard&&r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:f.announcedCard,ownerId:R},sourceCard:f.announcedCard}]),s(null)},[e,i,r,s,t,d]);return{playCommandCard:l,handleCommandConfirm:g,handleCounterSelectionConfirm:T}},ud=({gameState:t,localPlayerId:e,handleDrop:r,markAbilityUsed:n,requestCardReveal:a,interactionLock:s,setCommandContext:o,onAction:i,cursorStack:d,setCursorStack:l,setAbilityMode:g,triggerClickWave:T,clearTargetingMode:C})=>{const h=x.useRef(null),R=x.useRef({x:0,y:0});return x.useLayoutEffect(()=>{if(d&&h.current){const{x:f,y:m}=R.current;h.current.style.transform=`translate(${f-24}px, ${m-24}px)`}},[d]),x.useEffect(()=>{const f=m=>{R.current={x:m.clientX,y:m.clientY},h.current&&(h.current.style.transform=`translate(${m.clientX-24}px, ${m.clientY-24}px)`)};return window.addEventListener("mousemove",f),()=>window.removeEventListener("mousemove",f)},[]),x.useEffect(()=>{const f=m=>{var u,p,_,D,O,P;if(m.button!==0||!d)return;const A=document.elementFromPoint(m.clientX,m.clientY);let w=e;if(d.originalOwnerId!==void 0)w=d.originalOwnerId;else if((u=d.sourceCard)!=null&&u.ownerId)w=d.sourceCard.ownerId;else if(d.sourceCoords&&d.sourceCoords.row>=0){const{row:b,col:L}=d.sourceCoords;if(b>=0&&b<t.board.length&&L>=0&&L<((p=t.board[b])==null?void 0:p.length)){const U=t.board[b][L].card;U&&(w=U.ownerId||e)}}else if(t.activePlayerId){const b=t.players.find(L=>L.id===t.activePlayerId);b!=null&&b.isDummy&&(w=b.id)}let I=A==null?void 0:A.closest("[data-hand-card]");if(!I&&A)if(A.getAttribute("data-hand-card"))I=A;else{const b=A.querySelectorAll("[data-hand-card]");if(b.length>0){let L=1/0,U=null;const F=m.clientX,N=m.clientY;for(const G of Array.from(b)){const $=G.getBoundingClientRect();if(F>=$.left&&F<=$.right&&N>=$.top&&N<=$.bottom){const q=$.left+$.width/2,Z=$.top+$.height/2,X=Math.hypot(F-q,N-Z);X<L&&(L=X,U=G)}}I=U}}if(I){const b=I.getAttribute("data-hand-card");if(b){const[L,U]=b.split(","),F=parseInt(L,10),N=parseInt(U,10),G=t.players.find(q=>q.id===F),$=G==null?void 0:G.hand[N];if(G&&$){if(d.type==="Revealed"&&!G.isDummy){if((_=$.statuses)==null?void 0:_.some(me=>me.type==="Revealed"&&me.addedByPlayerId===w))return;d.count===1&&(d.chainedAction&&i(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),C()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((D=d.sourceCard)==null?void 0:D.ownerId)??w??void 0,statusType:d.type,count:1},{target:"hand",playerId:F,cardIndex:N,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&n(d.sourceCoords,d.isDeployAbility),d.count>1?l(me=>me?{...me,count:me.count-1}:null):l(null),s.current=!0,setTimeout(()=>{s.current=!1},300);return}const Z={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,tokenType:d.type};if(!it({card:$,ownerId:F,location:"hand"},Z,w,t.players))return;d.count===1&&(d.chainedAction&&i(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),C()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((O=d.sourceCard)==null?void 0:O.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:F,cardIndex:N,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&n(d.sourceCoords,d.isDeployAbility),d.count>1?l(se=>se?{...se,count:se.count-1}:null):l(null),s.current=!0,setTimeout(()=>{s.current=!1},300);return}}}if(!I){const b=A==null?void 0:A.closest("[data-board-coords]");if(b){const L=b.getAttribute("data-board-coords");if(L){const[U,F]=L.split(","),N=parseInt(U,10),G=parseInt(F,10);if(!isNaN(N)&&!isNaN(G)&&N>=0&&N<t.board.length&&t.board[N]&&G>=0&&G<t.board[N].length&&t.board[N][G]){const $=t.board[N][G].card;if(($==null?void 0:$.ownerId)!==void 0){const q={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,mustBeAdjacentToSource:d.mustBeAdjacentToSource,mustBeInLineWithSource:d.mustBeInLineWithSource,sourceCoords:d.sourceCoords,tokenType:d.type};if(!it({card:$,ownerId:$.ownerId,location:"board",boardCoords:{row:N,col:G}},q,w,t.players))return}if($){const q=d.placeAllAtOnce?d.count:1;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((P=d.sourceCard)==null?void 0:P.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:q},{target:"board",boardCoords:{row:N,col:G}}),T("board",{row:N,col:G}),d.recordContext&&o(X=>({...X,lastMovedCardCoords:{row:N,col:G},lastMovedCardId:$.id})),d.sourceCoords&&d.sourceCoords.row>=0&&n(d.sourceCoords,d.isDeployAbility);const Z=d.count-q;if(Z>0)l(X=>X?{...X,count:Z}:null);else{if(d.chainedAction){const X={...d.chainedAction};d.recordContext&&(X.mode==="SELECT_CELL"&&(X.sourceCard=$,X.sourceCoords={row:N,col:G},X.recordContext=!0),X.type==="GLOBAL_AUTO_APPLY"&&(X.sourceCoords={row:N,col:G}),X.type==="CREATE_STACK"&&(X.sourceCoords={row:N,col:G},X.originalOwnerId||(X.sourceCard=$)),X.mode==="ZIUS_LINE_SELECT"&&(X.sourceCoords={row:N,col:G})),X.type==="CREATE_STACK"&&g(null),i(X,{row:N,col:G})}C(),l(null)}s.current=!0,setTimeout(()=>{s.current=!1},300)}}}}else{const L=A==null?void 0:A.closest(".counter-modal-content"),U=(A==null?void 0:A.closest("[data-board-coords]"))!==null,F=(A==null?void 0:A.closest("[data-hand-card]"))!==null;d.isDragging?L?l(N=>N?{...N,isDragging:!1}:null):!U&&!F&&(C(),l(null)):!L&&!U&&!F&&(C(),l(null))}}};return window.addEventListener("mouseup",f),()=>{window.removeEventListener("mouseup",f)}},[d,r,t,e,a,n,s,o,i,l,g,T]),x.useEffect(()=>{const f=m=>{d&&(m.preventDefault(),C(),l(null))};return window.addEventListener("contextmenu",f),()=>{window.removeEventListener("contextmenu",f)}},[d,l,C]),{cursorFollowerRef:h,handleCounterMouseDown:(f,m)=>{R.current={x:m.clientX,y:m.clientY};const A=t.players.find(I=>I.id===t.activePlayerId),w=A!=null&&A.isDummy&&t.activePlayerId!==null?t.activePlayerId:e??0;l(I=>gr(f,w,I))}}};export{nt as A,Yt as B,dd as C,Ki as D,rd as E,Vi as F,zi as G,id as H,ld as I,cd as J,ud as K,Fi as L,Jo as M,Wt as N,or as O,Xo as P,it as Q,Ot as R,Ji as S,ae as T,Tr as U,Wi as V,jo as W,dt as a,qi as b,ea as c,os as d,Zi as e,Re as f,Qi as g,aa as h,Ke as i,Bi as j,qo as k,td as l,c as m,fr as n,ve as o,ji as p,Vo as q,ed as r,Zo as s,Ko as t,Yi as u,Xi as v,od as w,sd as x,ad as y,nd as z};
