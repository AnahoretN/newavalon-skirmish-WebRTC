import{r as U,j as No}from"./vendor-react-JYPVbgc1-0.2.11.js";import{$ as xt}from"./vendor-webrtc-BBsnVRmn-0.2.11.js";import{d as Yn,e as Mo}from"./vendor-BPR6uEV2-0.2.11.js";var Re=(t=>(t.SynchroTech="SynchroTech",t.Hoods="Hoods",t.Optimates="Optimates",t.Fusion="Fusion",t.Command="Command",t.Tokens="Tokens",t.Custom="Custom",t.Neutral="Neutral",t.Random="Random",t))(Re||{}),ir=(t=>(t.FreeForAll="FFA",t.TwoVTwo="2v2",t.ThreeVOne="3v1",t))(ir||{});const l={info:(...t)=>{},warn:(...t)=>{console.warn(...t)},error:(...t)=>{console.error(...t)},debug:(...t)=>{}},Lo={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365235/SYN_IP_DEPT_AGENT_pbvh9e.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_TACTICAL_AGENT_vquxfm.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_PATROL_AGENT_nlyneg.webp",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_RIOT_AGENT_i4lk5m.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_THREAT_ANALYST_uqxbsp.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367440/HERO_Mr._Pearl_Director_of_BioSynch_lsesol.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_RECKLESS_PROVOCATEUR_wvfdcr.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_DATA_LIBERATOR_qeru3j.webp",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_CAUTIOUS_AVENGER_xzk6pd.webp",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_VIGILANT_SPOTTER_xo8ig7.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_INVENTIVE_MAKER_sicb73.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367436/HERO_Finn_c8637x.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_FABER_cr804w.webp",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365250/OPT_CENSOR_w4qijk.webp",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_PRINCEPS_aaqakx.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_IMMUNIS_hvlxhi.webp",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_CENTURION_grztbi.webp",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367435/HERO_Lucius_The_Immortal_irhhaj.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_CODE_KEEPER_yhowqj.webp",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_DEVOUT_SYNTHETIC_nkr1tx.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_UNWAVERING_INTEGRATOR_g1cbag.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_SIGNAL_PROPHET_rmk9me.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_ZEALOUS_MISSIONARY_v7qjhw.webp",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367438/HERO_Reverend_of_The_Choir_njrrih.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365196/CMD_OVERWATCH_djwlqo.webp",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_REPOSITIONING_uhwvrk.webp",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_INSPIRATION_v0bi3l.webp",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_DATA_INTERCEPTION_gen1qw.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_FALSE_ORDERS_aatcmc.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367418/CMD_Experimental_Stimulants_plsnet.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367415/CMD_Logistics_Chain_odmwxq.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367414/CMD_Quick_Response_Team_xff2yt.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367411/CMD_Temporary_Shelter_podjbj.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367413/CMD_Enhanced_Interrogation_legiod.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367446/N_Autonomous_Battle_Robot_Gawain_oni745.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Reclaimed_Gawain_sjmlsp.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Secret_informant_w0w6g5.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367432/HERO_Michael_Falk_sv5i5c.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367434/HERO_Edith_Byron_ny23vb.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367429/HERO_Pinkunoneko_cqhpuy.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367431/HERO_Maria_Eleftheria_Damanaki_cpw12i.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367428/HERO_Zius_xhuyxa.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},Go={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_RECON_DRONE_w3elir.webp",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_WALKING_TURRET_c0mttm.webp",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},xo={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365400/Aim_qzeaqn.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365398/Exploit_pf2zwf.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Revealed_lsan64.webp",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand and face-down cards on board.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board-facedown","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365403/Stun_pbe7ex.webp",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Shield_yilhdt.webp",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365402/Support_hxzufw.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771368527/Threat_dqnnsq.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365394/Resurrected_awaucv.webp",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},Uo=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],Yt={cardDatabase:Lo,tokenDatabase:Go,countersDatabase:xo,deckFiles:Uo};let vn=null,ot=new Map,rr=new Map,St={},Ut=[],nr={};const zn=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function Ni(){try{let t;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const r=await fetch("/api/content/database");if(r.ok){const n=await r.json(),a=n.cards.map(([o,i])=>[o,i]),s=n.tokens.map(([o,i])=>[o,i]);t={cardDatabase:Object.fromEntries(a),tokenDatabase:Object.fromEntries(s),countersDatabase:Object.fromEntries(n.counters),deckFiles:n.deckFiles}}else t=Yt}catch{t=Yt}else t=Yt;vn=t,ot=new Map(Object.entries(t.cardDatabase)),rr=new Map(Object.entries(t.tokenDatabase)),St=t.countersDatabase,Ut=t.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(St)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(r){console.warn("Could not save counters database to localStorage:",r)}Ke=vn,Kn=ot,Ho=rr,it=St,Fo=Ut,nr=$o(),Wo=nr}catch(t){throw console.error("Failed to load content database:",t),t}}function $o(){const t={};for(const e of Ut){const r=[];for(const n of e.cards){const a=ot.get(n.cardId);if(!a){console.warn(`Card definition not found for ID: ${n.cardId} in deck: ${e.name}`);continue}const s=zn.has(n.cardId);for(let o=0;o<n.quantity;o++){const d=n.cardId.replace(/-/g,"--DASH--").toUpperCase();s?r.push({...a,deck:Re.Command,id:`CMD_${d}_${o+1}`,baseId:n.cardId,faction:a.faction||"Command"}):r.push({...a,deck:e.id,id:`${e.id.substring(0,3).toUpperCase()}_${d}_${o+1}`,baseId:n.cardId,faction:a.faction||e.id})}}if(t[e.id]=r,e.id==="Optimates"){const n=new Set;let a=!1;r.forEach(s=>{n.has(s.id)&&(l.error(`[buildDecksData] DUPLICATE ID in Optimates: ${s.id}`),a=!0),n.add(s.id),s.baseId||s.id}),a&&l.warn("[buildDecksData] Optimates deck has duplicate IDs!")}}return t[Re.Tokens]=Array.from(rr.entries()).map(([e,r])=>{const n=r.types?[...r.types]:[];return{id:`TKN_${r.name.toUpperCase().replace(/\s/g,"_")}`,baseId:e,deck:Re.Tokens,name:r.name,imageUrl:r.imageUrl,fallbackImage:r.fallbackImage,power:r.power,ability:r.ability,color:r.color,types:n,flavorText:r.flavorText,faction:"Tokens"}}),t}let Ke=null,Kn=new Map,Ho=new Map,it={};try{const t=localStorage.getItem("counters_database");t&&(St=JSON.parse(t),it=St)}catch{}let Fo=[],Wo={};const Bo=zn,Mi=()=>Ut.filter(t=>t.isSelectable);function ze(t){return ot.get(t)}function zt(t){return Array.from(ot.values()).find(e=>e.name===t)}function Li(){return Array.from(ot.entries()).map(([t,e])=>({id:t,card:e}))}function Gi(){return ot}function qn(){return nr}const Yo=4,xi={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/medal_tavarc.webp"},Ui={[Re.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[Re.Hoods]:{prefix:"HOO",color:"border-purple-500"},[Re.Optimates]:{prefix:"OPT",color:"border-red-500"},[Re.Fusion]:{prefix:"FUS",color:"border-green-400"},[Re.Command]:{prefix:"CMD",color:"border-yellow-500"},[Re.Tokens]:{prefix:"TKN",color:"border-gray-400"},[Re.Custom]:{prefix:"CUS",color:"border-purple-400"},[Re.Neutral]:{prefix:"NEU",color:"border-gray-400"},[Re.Random]:{prefix:"RND",color:"border-gray-400"}},$i={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},zo={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},Hi={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},It=["blue","purple","red","green","yellow","orange","pink","brown"],Fi=["Setup","Main","Commit","Scoring"],Mt=()=>Object.fromEntries(Object.entries(it).map(([t,e])=>[t,e.imageUrl])),Wi=new Proxy({},{get(t,e){return Mt()[e]},ownKeys(){return Object.keys(Mt())},has(t,e){return e in Mt()},getOwnPropertyDescriptor(t,e){const r=Mt()[e];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),Lt=()=>Object.fromEntries(Object.entries(it).map(([t,e])=>[t,e.description])),Bi=new Proxy({},{get(t,e){return Lt()[e]},ownKeys(){return Object.keys(Lt())},has(t,e){return e in Lt()},getOwnPropertyDescriptor(t,e){const r=Lt()[e];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),Ko=()=>Object.entries(it).filter(([t,e])=>t!=="Resurrected"&&(!e.allowedPanels||e.allowedPanels.includes("COUNTER_PANEL"))).sort(([,t],[,e])=>t.sortOrder-e.sortOrder).map(([t,e])=>({type:t,label:e.name}));Ko();const Je="readyDeploy",Fe="readySetup",Ye="readyCommit",ke=(t,e,r)=>t.statuses?t.statuses.some(n=>n.type===e&&(r===void 0||n.addedByPlayerId===r)):!1,xe=(t,e)=>t.statuses?t.statuses.some(r=>r.type===e):!1,qo=(t,e,r)=>r===1&&xe(t,Fe),Vo=(t,e,r,n,a)=>!!(r&&xe(t,Je)||e===1&&n&&xe(t,Fe)||e===3&&a&&xe(t,Ye)),Kt=t=>{t.statuses&&(t.statuses=t.statuses.filter(e=>e.type!==Je&&e.type!==Fe&&e.type!==Ye))},ft=(t,e,r,n)=>Math.abs(t-r)+Math.abs(e-n)===1,Vn=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"riotAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:t,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"codeKeeper",activationType:"deploy",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>{var s;return a.ownerId!==r&&((s=a.statuses)==null?void 0:s.some(o=>o.type==="Threat"))}},sourceCard:t,sourceCoords:n})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId!==r&&ke(a,"Exploit",r)}})},{baseId:"centurion",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(a,s,o)=>{var i;return a.ownerId===r&&((i=a.types)==null?void 0:i.includes("Unit"))&&s!==void 0&&o!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:t,sourceCoords:n,payload:{filter:(a,s,o)=>ft(s,o,n.row,n.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.id===t.id?!1:a.ownerId===r}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:n,maxOrthogonalDistance:2,sourceCard:t})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:t,sourceCoords:n,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,originalOwnerId:r,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:a=>a.ownerId===r}})},{baseId:"censor",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:n,sourceCard:t,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(t,e,r,n)=>ke(t,"Support",r)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:t,sourceCoords:n,payload:{filter:(a,s)=>ft(a,s,n.row,n.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,s,o)=>ft(s,o,n.row,n.col)&&a.ownerId!==r&&(ke(a,"Threat",r)||ke(a,"Stun",r))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>a.ownerId===r&&ke(a,"Support",r)},sourceCard:t,sourceCoords:n})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId===r&&ke(a,"Exploit",r)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:t,sourceCoords:n,payload:{filter:a=>ke(a,"Exploit",r)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"walkingTurret",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"MODIFY_POWER",amount:-1,filter:a=>ke(a,"Aim",r)}})},{baseId:"reconDrone",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,sourceCoords:n,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"REVEAL_ENEMY_CHAINED",filter:(a,s,o)=>{const i=ft(s,o,n.row,n.col),d=a.ownerId!==r;return i&&d},targetOwnerId:void 0},skipChainedActionOnNoTargets:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:1}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,s,o)=>ft(s,o,n.row,n.col)&&a.ownerId!==r&&(ke(a,"Threat",r)||ke(a,"Stun",r))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:t,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"edithByron",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:t,sourceCoords:n,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,s,o)=>ft(s,o,n.row,n.col)&&(ke(a,"Threat",r)||ke(a,"Stun",r)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>ke(a,"Aim",r)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:t,sourceCoords:n,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:t,sourceCoords:n,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(t,e,r,n)=>({type:"REVEREND_SETUP_SCORE",sourceCard:t,sourceCoords:n,ownerId:r})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"LUCIUS_SETUP",filter:a=>a.ownerId===r}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId===r,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:t,sourceCoords:n})}],dr=t=>{const e=t.baseId||"";return Vn.filter(r=>{var n;return r.baseId===e||((n=r.baseIdAlt)==null?void 0:n.includes(e))})},jo=t=>{const r=dr(t).map(n=>n.activationType);return[...new Set(r)]},jn=(t,e,r,n)=>{var o;if(r!==t.ownerId)return!1;if(n&&t.ownerId!==void 0){const i=n.players.find(d=>d.id===t.ownerId);if(i!=null&&i.isDummy&&n.activePlayerId!==t.ownerId)return!1}if((o=t.statuses)!=null&&o.some(i=>i.type==="Stun"))return!1;const a=dr(t),s=e===1&&a.some(i=>i.activationType==="setup")||e===3&&a.some(i=>i.activationType==="commit");if(e===1){const i=a.find(d=>d.activationType==="setup");if(i&&xe(t,Fe))return!(i.supportRequired&&!ke(t,"Support",r))}if(e===3){const i=a.find(d=>d.activationType==="commit");if(i&&xe(t,Ye))return!(i.supportRequired&&!ke(t,"Support",r))}if(!s){const i=a.find(d=>d.activationType==="deploy");if(i&&xe(t,Je))return!(i.supportRequired&&!ke(t,"Support",r))}return!1},Jo=(t,e,r,n)=>{if(r!==t.ownerId)if(t.ownerId!==void 0){const d=e.players.find(c=>c.id===t.ownerId);if(!(d!=null&&d.isDummy))return null}else return null;const a=dr(t),s=t.ownerId??r??0,o=e.currentPhase,i=o===1&&a.some(d=>d.activationType==="setup")||o===3&&a.some(d=>d.activationType==="commit");if(o===1){const d=a.find(c=>c.activationType==="setup");if(d&&xe(t,Fe)){if(d.supportRequired&&!ke(t,"Support",s))return null;const c=d.getAction(t,e,s,n);if(c)return{...c,readyStatusToRemove:Fe}}}if(o===3){const d=a.find(c=>c.activationType==="commit");if(d&&xe(t,Ye)){if(d.supportRequired&&!ke(t,"Support",s))return null;const c=d.getAction(t,e,s,n);if(c)return{...c,readyStatusToRemove:Ye}}}if(!i){const d=a.find(c=>c.activationType==="deploy");if(d&&xe(t,Je)){if(d.supportRequired&&!ke(t,"Support",s))return null;const c=d.getAction(t,e,s,n);if(c)return{...c,isDeployAbility:!0,readyStatusToRemove:Je}}}return null},Xo=(t,e)=>e===1&&xe(t,Fe)?Fe:e===3&&xe(t,Ye)?Ye:xe(t,Je)?Je:null,Yi=(t,e)=>{var o;let r,n;typeof e=="object"?(r=e.currentPhase,n=e):r=e;const a=n==null?void 0:n.activePlayerId;return a===void 0||t.ownerId!==a||(o=t.statuses)!=null&&o.some(i=>i.type==="Stun")||!Xo(t,r)?!1:jn(t,r,t.ownerId,n)},Jn=(t,e,r)=>{var i;let n;if(typeof e=="object"?(n=e.currentPhase,r=e.activePlayerId??void 0):n=e,r===void 0||t.ownerId!==r||(i=t.statuses)!=null&&i.some(d=>d.type==="Stun"))return!1;const a=xe(t,Je),s=xe(t,Fe),o=xe(t,Ye);return Vo(t,n,a,s,o)},cr=(t,e)=>{t.statuses||(t.statuses=[]);const r=jo(t);for(const n of r){let a="";n==="deploy"?a=Je:n==="setup"?a=Fe:n==="commit"&&(a=Ye),a&&(t.statuses.some(o=>o.type===a)||t.statuses.push({type:a,addedByPlayerId:e}))}},ar=(t,e)=>{const r=Nn("setup"),n=Nn("commit");for(let a=0;a<t.board.length;a++)for(let s=0;s<t.board[a].length;s++){const i=t.board[a][s].card;if(!i||i.ownerId!==e)continue;const d=i.baseId||i.id;if(d){if(l.debug(`[resetReadyStatusesForTurn] Processing card: ${i.name} (baseId: ${d}, ownerId: ${i.ownerId})`),i.statuses||(i.statuses=[]),r.includes(d)){const c=i.statuses.some(E=>E.type===Fe);i.statuses=i.statuses.filter(E=>E.type!==Fe),i.statuses.push({type:Fe,addedByPlayerId:e}),c||l.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_SETUP to ${i.name}`)}else i.statuses=i.statuses.filter(c=>c.type!==Fe);if(n.includes(d)){const c=i.statuses.some(E=>E.type===Ye);i.statuses=i.statuses.filter(E=>E.type!==Ye),i.statuses.push({type:Ye,addedByPlayerId:e}),c||l.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_COMMIT to ${i.name}`)}else i.statuses=i.statuses.filter(c=>c.type!==Ye)}}};function Nn(t){const e=[];return Vn.forEach(r=>{r.activationType===t&&(e.push(r.baseId),r.baseIdAlt&&e.push(...r.baseIdAlt))}),[...new Set(e)]}class Zo{constructor(){this.queue=[],this.loading=new Set,this.loaded=new Set,this.minDelayBetweenLoads=1e3,this.lastLoadTime=0,this.isProcessing=!1}preload(e,r="low"){!e||this.loaded.has(e)||this.loading.has(e)||this.queue.some(a=>a.url===e)||(this.queue.push({url:e,priority:r,timestamp:Date.now()}),this.queue.sort((a,s)=>{const o={high:0,normal:1,low:2},i=o[a.priority]-o[s.priority];return i!==0?i:a.timestamp-s.timestamp}),this.processQueue())}preloadMany(e,r="low"){e.forEach(n=>this.preload(n,r))}isLoaded(e){return this.loaded.has(e)}clearQueue(){this.queue=[]}clear(){this.queue=[],this.loading.clear(),this.loaded.clear()}processQueue(){if(this.isProcessing||this.queue.length===0)return;this.isProcessing=!0;const e=()=>{if(this.queue.length===0){this.isProcessing=!1;return}const n=Date.now()-this.lastLoadTime,a=Math.max(0,this.minDelayBetweenLoads-n);setTimeout(()=>{const s=this.queue.shift();if(!s){this.isProcessing=!1;return}this.loadImage(s.url).then(()=>{this.lastLoadTime=Date.now(),e()}).catch(()=>{this.lastLoadTime=Date.now(),e()})},a)};e()}loadImage(e){return new Promise((r,n)=>{this.loading.add(e);const a=new Image;a.onload=()=>{this.loading.delete(e),this.loaded.add(e),r()},a.onerror=()=>{this.loading.delete(e),n(new Error(`Failed to load: ${e}`))},a.src=e})}}const Qo=new Zo;function es(t,e){const r=[];for(const n of t)if(n.id!==e){if(n.hand)for(const a of n.hand)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl);if(n.deck)for(const a of n.deck)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl);if(n.discard)for(const a of n.discard)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl)}return r}function me(t){const e=t,r=e==null?void 0:e.targetingMode;r&&delete e.targetingMode;let n;return typeof structuredClone<"u"?n=structuredClone(t):n=JSON.parse(JSON.stringify(t)),r&&(n.targetingMode=r,e.targetingMode=r),n}const oe={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function zi(t){return{r:Math.min(255,Math.round(t.r*1.3)),g:Math.min(255,Math.round(t.g*1.3)),b:Math.min(255,Math.round(t.b*1.3))}}function Ki(t,e){return`rgba(${t.r}, ${t.g}, ${t.b}, ${e})`}function qi(t,e){return t?zo[t]:e}function ve(){return localStorage.getItem("webrtc_enabled")==="true"}const Xn=U.createContext(null),Vi=({children:t})=>{const[e,r]=U.useState(null),[n,a]=U.useState({}),[s,o]=U.useState("lg"),i=U.useCallback((y,P={},T="lg")=>{r(y),a(P),o(T)},[]),d=U.useCallback(()=>{r(null),a({}),o("lg")},[]),c=U.useCallback(y=>e===y,[e]),E=U.useCallback(()=>n,[n]),g=U.useCallback(()=>s,[s]),A={openModal:e,modalData:n,modalSize:s,open:i,close:d,isOpen:c,getData:E,getSize:g};return No.jsx(Xn.Provider,{value:A,children:t})},Ft=()=>{const t=U.useContext(Xn);if(!t)throw new Error("useModals must be used within ModalsProvider");return t},ji=()=>{const{open:t,close:e,isOpen:r}=Ft();return{isOpen:r("rules"),open:n=>t("rules",n,"full"),close:e}},Ji=()=>{const{open:t,close:e,isOpen:r}=Ft();return{isOpen:r("settings"),open:n=>t("settings",n,"md"),close:e}},Xi=()=>{const{open:t,close:e,isOpen:r,getData:n}=Ft();return{isOpen:r("joinGame"),open:a=>t("joinGame",a,"lg"),close:e,getData:()=>n()}},Zi=()=>{const{open:t,close:e,isOpen:r}=Ft();return{isOpen:r("deckBuilder"),open:n=>t("deckBuilder",n,"full"),close:e}},Ct="webrtc_game_state",Dt="webrtc_host_data",Rt="webrtc_guest_data",ts="webrtc_current_host_peerId",rs=30*60*1e3;function lr(){return Date.now()}function kt(t){return Date.now()-t<rs}function ns(t){try{const e={...t,timestamp:lr()};localStorage.setItem(Dt,JSON.stringify(e)),l.info("[WebRTC Persistence] Saved host data:",{peerId:e.peerId})}catch(e){l.error("[WebRTC Persistence] Failed to save host data:",e)}}function qt(t){try{const e={...t,timestamp:lr()};localStorage.setItem(Rt,JSON.stringify(e)),l.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:e.hostPeerId,playerId:e.playerId})}catch(e){l.error("[WebRTC Persistence] Failed to save guest data:",e)}}function wt(t){try{const e={...t,timestamp:lr()};localStorage.setItem(Ct,JSON.stringify(e)),l.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(e.timestamp).toISOString())}catch(e){l.error("[WebRTC Persistence] Failed to save game state:",e)}}function Zn(){try{const t=localStorage.getItem(Dt);if(!t)return null;const e=JSON.parse(t);return kt(e.timestamp)?(l.info("[WebRTC Persistence] Loaded valid host data:",{peerId:e.peerId}),e):(l.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(Dt),null)}catch(t){return l.error("[WebRTC Persistence] Failed to load host data:",t),localStorage.removeItem(Dt),null}}function Qn(){try{const t=localStorage.getItem(Rt);if(!t)return null;const e=JSON.parse(t);return kt(e.timestamp)?(l.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:e.hostPeerId,playerId:e.playerId}),e):(l.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(Rt),null)}catch(t){return l.error("[WebRTC Persistence] Failed to load guest data:",t),localStorage.removeItem(Rt),null}}function Mn(){try{const t=localStorage.getItem(Ct);if(!t)return null;const e=JSON.parse(t);return kt(e.timestamp)?(l.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(e.timestamp).toISOString()),e):(l.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(Ct),null)}catch(t){return l.error("[WebRTC Persistence] Failed to load game state:",t),localStorage.removeItem(Ct),null}}function rt(){localStorage.removeItem(Ct),localStorage.removeItem(Dt),localStorage.removeItem(Rt),localStorage.removeItem(ts)}function or(t,e){try{const r=`webrtc_host_${e}`,n={peerId:t,gameId:e,timestamp:Date.now()};localStorage.setItem(r,JSON.stringify(n)),l.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${e}:`,t)}catch(r){l.error("[WebRTC Persistence] Failed to broadcast host peerId:",r)}}function Vt(t){try{const e=`webrtc_host_${t}`,r=localStorage.getItem(e);if(!r)return null;const n=JSON.parse(r);return Date.now()-n.timestamp>15e3?null:{peerId:n.peerId,timestamp:n.timestamp}}catch(e){return l.error("[WebRTC Persistence] Failed to get host peerId:",e),null}}function Ln(t){try{const e=`webrtc_host_${t}`;localStorage.removeItem(e),l.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${t}`)}catch(e){l.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",e)}}function as(){const t=sessionStorage.getItem("invite_host_id"),e=sessionStorage.getItem("invite_auto_join");if(t&&e)return"none";const r=Zn();if(r&&kt(r.timestamp))return"host";const n=Qn();return n&&kt(n.timestamp)?"guest":"none"}const Gn=7,jt="mrPearlDoF",os="reverendOfTheChoir",ss="threatAnalyst";function is(t,e){return t!=null&&t.statuses?t.statuses.some(r=>r.type==="Exploit"&&r.addedByPlayerId!==void 0&&e.has(r.addedByPlayerId)):!1}function ds(t){return typeof structuredClone<"u"?structuredClone(t):JSON.parse(JSON.stringify(t))}const ea=()=>Array(Gn).fill(null).map(()=>Array(Gn).fill(null).map(()=>({card:null}))),Le=t=>{var T,p,m,S,_;const{board:e,activeGridSize:r,players:n}=t,a=ds(e),s=a.length,o=Math.floor((s-r)/2),i=new Map;n.forEach(I=>i.set(I.id,I.teamId));for(let I=0;I<s;I++)for(let u=0;u<s;u++){const f=a[I][u].card;f&&(f.statuses&&(f.statuses=f.statuses.filter(w=>w.type!=="Support"&&w.type!=="Threat")),delete f.bonusPower)}for(let I=0;I<s;I++)for(let u=0;u<s;u++){const f=a[I][u].card;if((f==null?void 0:f.ownerId)===void 0||f.isFaceDown)continue;const w=f.ownerId,D=i.get(w),v=[{r:I-1,c:u},{r:I+1,c:u},{r:I,c:u-1},{r:I,c:u+1}],R={};let b=!1;for(const x of v){const{r:N,c:M}=x;if(N>=0&&N<s&&M>=0&&M<s){const $=a[N][M].card,B=(T=$==null?void 0:$.statuses)==null?void 0:T.some(V=>V.type==="Stun");if(($==null?void 0:$.ownerId)!==void 0&&!$.isFaceDown&&!B){const V=$.ownerId,X=i.get(V);w===V||D!==void 0&&D===X?b=!0:(R[V]||(R[V]=[]),R[V].push({r:N,c:M}))}}}b&&(f.statuses||(f.statuses=[]),f.statuses.some(x=>x.type==="Support")||f.statuses.push({type:"Support",addedByPlayerId:w}));let G=null;for(const x in R){const N=R[x];if(N&&N.length>=2){G=parseInt(x,10);break}}if(G===null&&I>=o&&I<o+r&&u>=o&&u<o+r){const N=I===o||I===o+r-1||u===o||u===o+r-1,M=Object.keys(R).length>0;if(N&&M){const $=Object.keys(R)[0];$&&(G=parseInt($,10))}}G!==null&&(f.statuses||(f.statuses=[]),f.statuses.some(x=>x.type==="Threat")||f.statuses.push({type:"Threat",addedByPlayerId:G}))}const d=new Set;for(let I=0;I<s;I++)for(let u=0;u<s;u++){const f=a[I][u].card,w=(p=f==null?void 0:f.statuses)==null?void 0:p.some(D=>D.type==="Stun");if((f==null?void 0:f.baseId)===ss&&!f.isFaceDown&&f.ownerId!==void 0&&!w){const D=[{r:I-1,c:u},{r:I+1,c:u},{r:I,c:u-1},{r:I,c:u+1}];let v=!1;const R=f.ownerId,b=i.get(R);for(const G of D){const{r:x,c:N}=G;if(x>=0&&x<s&&N>=0&&N<s){const M=a[x][N].card;if((M==null?void 0:M.ownerId)!==void 0&&!M.isFaceDown){const $=M.ownerId,B=i.get($),V=R===$||b!==void 0&&b===B,X=(m=M==null?void 0:M.statuses)==null?void 0:m.some(Z=>Z.type==="Stun");if(V&&!X){v=!0;break}}}}v&&d.add(R)}}for(let I=0;I<s;I++)for(let u=0;u<s;u++){const f=a[I][u].card;if(!f||f.isFaceDown||f.ownerId===void 0)continue;const w=f.ownerId,D=i.get(w),v=[{r:I-1,c:u},{r:I+1,c:u},{r:I,c:u-1},{r:I,c:u+1}],R={};for(const G of v){const{r:x,c:N}=G;if(x>=0&&x<s&&N>=0&&N<s){const M=a[x][N].card,$=(S=M==null?void 0:M.statuses)==null?void 0:S.some(B=>B.type==="Stun");if((M==null?void 0:M.ownerId)!==void 0&&!M.isFaceDown&&!$){const B=M.ownerId,V=i.get(B);if(!(w===B||D!==void 0&&D===V)){const Z=d.has(B),de=is(f,d);Z&&de&&(R[B]||(R[B]=0),R[B]++)}}}}if(Object.keys(R).length>0){f.statuses||(f.statuses=[]);const G=Object.keys(R).map(x=>parseInt(x,10));for(const x of G)f.statuses.some(N=>N.type==="Threat"&&N.addedByPlayerId===x)||f.statuses.push({type:"Threat",addedByPlayerId:x})}}const c=[],E=[];for(let I=0;I<s;I++)for(let u=0;u<s;u++){const f=a[I][u].card,w=(_=f==null?void 0:f.statuses)==null?void 0:_.some(D=>D.type==="Stun");f!=null&&f.baseId&&!f.isFaceDown&&f.ownerId!==void 0&&!w&&(f.baseId===os?c.push({r:I,c:u,ownerId:f.ownerId,baseId:f.baseId}):f.baseId===jt&&E.push({r:I,c:u,ownerId:f.ownerId,baseId:f.baseId}))}const g=new Set,A=new Set;for(const I of c){const{r:u,c:f,ownerId:w}=I,D=`${u}-${w}`;if(!g.has(D)){g.add(D);for(let R=0;R<s;R++){const b=a[u][R].card;b&&b.ownerId===w&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(G=>G.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:w}))}}const v=`${f}-${w}`;if(!A.has(v)){A.add(v);for(let R=0;R<s;R++){const b=a[R][f].card;b&&b.ownerId===w&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(G=>G.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:w}))}}}const y=new Set,P=new Set;for(const I of E){const{r:u,c:f,ownerId:w}=I,D=`${u}-${w}`;if(!y.has(D)){y.add(D);for(let R=0;R<s;R++){const b=a[u][R].card;b&&b.ownerId===w&&!b.isFaceDown&&b.baseId!==jt&&(b.bonusPower=(b.bonusPower||0)+1)}}const v=`${f}-${w}`;if(!P.has(v)){P.add(v);for(let R=0;R<s;R++){const b=a[R][f].card;b&&b.ownerId===w&&!b.isFaceDown&&b.baseId!==jt&&(b.bonusPower=(b.bonusPower||0)+1)}}}return a};var dt=(t=>(t[t.CARD_REGISTRY=1]="CARD_REGISTRY",t[t.CARD_STATE=2]="CARD_STATE",t[t.ABILITY_EFFECT=3]="ABILITY_EFFECT",t[t.SESSION_EVENT=4]="SESSION_EVENT",t))(dt||{}),bt=(t=>(t[t.HIGHLIGHT_CELL=1]="HIGHLIGHT_CELL",t[t.FLOATING_TEXT=2]="FLOATING_TEXT",t[t.NO_TARGET=3]="NO_TARGET",t[t.STATUS_ADDED=4]="STATUS_ADDED",t[t.STATUS_REMOVED=5]="STATUS_REMOVED",t[t.POWER_CHANGED=6]="POWER_CHANGED",t[t.CARD_DESTROYED=7]="CARD_DESTROYED",t[t.TARGETING_MODE=8]="TARGETING_MODE",t[t.CLEAR_TARGETING=9]="CLEAR_TARGETING",t))(bt||{});function cs(){const t={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},e=new Set,r=Array.from(Kn.values());for(const n of r)if(n.baseId&&!e.has(n.baseId)){e.add(n.baseId);const a=t.cardDefinitions.length;t.baseIdToIndex.set(n.baseId,a),t.indexToBaseId.set(a,n.baseId),t.cardDefinitions.push({baseId:n.baseId,name:n.name,imageUrl:n.imageUrl,power:n.power,ability:n.ability||"",types:n.types||[],faction:n.faction||""})}return t.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],l.info(`[CardRegistry] Built registry with ${t.cardDefinitions.length} cards, ${t.statusTypes.length} status types`),t}function ta(t,e){let r=0;for(const n of t||[]){const a=e.statusTypes.indexOf(n.type);a>=0&&a<32&&(r|=1<<a)}return r>>>0}function ra(t,e,r){const n=[];for(let a=0;a<32;a++)if(t&1<<a){const s=r.statusTypes[a];s&&n.push({type:s,addedByPlayerId:e})}return n}function na(t){let e=0;return t.isFaceDown&&(e|=1),t.enteredThisTurn&&(e|=2),t.revealedTo==="all"&&(e|=4),e}function Jt(t,e){const r=new Uint8Array(13);let n=0;const a=ur(t.id);r[n++]=a>>24&255,r[n++]=a>>16&255,r[n++]=a>>8&255,r[n++]=a&255;const s=t.baseId?e.baseIdToIndex.get(t.baseId)??0:0;r[n++]=s>>8&255,r[n++]=s&255,r[n++]=(t.ownerId??0)&255;const o=Math.round(t.power||0);r[n++]=Math.clamp(o,-128,127)&255,r[n++]=na(t);const i=ta(t.statuses||[],e);return r[n++]=i>>24&255,r[n++]=i>>16&255,r[n++]=i>>8&255,r[n++]=i&255,r}function ls(t,e,r){const n=new Uint8Array(10);let a=0;const s=ur(t.id);n[a++]=s>>24&255,n[a++]=s>>16&255,n[a++]=s>>8&255,n[a++]=s&255,n[a++]=(t.ownerId??r)&255,n[a++]=na(t);const o=ta(t.statuses||[],e);return n[a++]=o>>24&255,n[a++]=o>>16&255,n[a++]=o>>8&255,n[a++]=o&255,n}function ur(t){let e=0;for(let r=0;r<t.length;r++){const n=t.charCodeAt(r);e=(e<<5)-e+n,e=e&e}return e>>>0}function us(t,e,r){var T;const n=[],a=Date.now(),s=new Uint8Array(7);s[0]=dt.CARD_STATE,s[1]=a>>24&255,s[2]=a>>16&255,s[3]=a>>8&255,s[4]=a&255,n.push(s);const o=[],i=Math.min(t.players.length,255);o.push(new Uint8Array([i]));for(const p of t.players){o.push(new Uint8Array([p.id&255]));const m=It.indexOf(p.color);o.push(new Uint8Array([m>=0?m:0]));const S=Math.min(p.deck.length,255),_=Math.min(p.hand.length,255),I=Math.min(p.discard.length,255);o.push(new Uint8Array([S,_,I,p.announcedCard?1:0])),o.push(new Uint8Array([Math.min(p.score,255)]));const u=Math.min(p.hand.length,255);o.push(new Uint8Array([u]));const f=p.id===r;for(const D of p.hand)f?o.push(Jt(D,e)):o.push(ls(D,e,p.id));const w=Math.min(p.discard.length,255);o.push(new Uint8Array([w]));for(const D of p.discard){const v=ur(D.id),R=new Uint8Array(4);R[0]=v>>24&255,R[1]=v>>16&255,R[2]=v>>8&255,R[3]=v&255,o.push(R)}p.announcedCard&&o.push(Jt(p.announcedCard,e))}const d=t.board.length;o.push(new Uint8Array([d,d,d]));const c=[];for(let p=0;p<t.board.length;p++)for(let m=0;m<((T=t.board[p])==null?void 0:T.length);m++){const S=t.board[p][m];S!=null&&S.card&&c.push({row:p,col:m,card:S.card})}const E=c.length,g=new Uint8Array(2);g[0]=E>>8&255,g[1]=E&255,o.push(g);for(const{row:p,col:m,card:S}of c)o.push(new Uint8Array([p,m])),o.push(Jt(S,e));o.push(new Uint8Array([t.currentPhase===void 0?255:Math.clamp(t.currentPhase,0,254),(t.activePlayerId??255)&255,t.currentRound===void 0?255:Math.clamp(t.currentRound,0,254)]));let A=0;for(const p of o)A+=p.length;s[5]=A>>8&255,s[6]=A&255,n.push(...o);const y=new Uint8Array(n.reduce((p,m)=>p+m.length,0));let P=0;for(const p of n)y.set(p,P),P+=p.length;return l.info(`[GameCodec] Encoded card state: ${y.length} bytes (${E} board cards, ${t.players.length} players)`),y}function fs(t,e,r){let n=0;if(t[n++]!==dt.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++],t[n++]<<8|t[n++];const a=t[n++],s=[];for(let T=0;T<a;T++){const p=t[n++],m=t[n++],S=It[m]||"blue",_=t[n++];t[n++],t[n++];const I=t[n++]===1,u=t[n++],f=t[n++],w=[],D=p===r;for(let x=0;x<f;x++)if(D)w.push(Xt(t,n,e)),n+=13;else{const N=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++],M=t[n++],$=t[n++],B=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++];w.push({id:`card_${N}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:M,isFaceDown:($&1)!==0,revealedTo:$&4?"all":void 0,statuses:ra(B,p,e),isPlaceholder:!0})}const v=t[n++],R=[];for(let x=0;x<v;x++){const N=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++];R.push({id:`discard_${N}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:p,isPlaceholder:!0})}let b=null;I&&(b=Xt(t,n,e),n+=13);const G=[];for(let x=0;x<_;x++)G.push({id:`deck_${p}_${x}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:p,isPlaceholder:!0});s.push({id:p,name:`Player ${p}`,score:u,hand:w,deck:G,discard:R,announcedCard:b,selectedDeck:"Random",color:S,boardHistory:[]})}const o=t[n++];n++,n++;const i=t[n++]<<8|t[n++],d=[];for(let T=0;T<o;T++){const p=[];for(let m=0;m<o;m++)p.push({card:null});d.push(p)}for(let T=0;T<i;T++){const p=t[n++],m=t[n++],S=Xt(t,n,e);n+=13,p<d.length&&m<d[p].length&&(d[p][m]={card:S})}const c=t[n++],E=t[n++],g=t[n++];return{players:s,board:d,currentPhase:c===255?void 0:c,activePlayerId:E===255?null:E,currentRound:g===255?void 0:g}}function Xt(t,e,r){const a=`card_${t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++]}_${Date.now()}`,s=t[e++]<<8|t[e++],o=t[e++];let i=t[e++];i>127&&(i=i-256);const d=t[e++],c=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++],E=r.cardDefinitions[s],g=(E==null?void 0:E.baseId)||"";return{id:a,baseId:g,deck:"Random",name:(E==null?void 0:E.name)||"?",imageUrl:(E==null?void 0:E.imageUrl)||"",power:i,ability:(E==null?void 0:E.ability)||"",types:(E==null?void 0:E.types)||[],faction:(E==null?void 0:E.faction)||"",ownerId:o,isFaceDown:(d&1)!==0,enteredThisTurn:(d&2)!==0,revealedTo:d&4?"all":void 0,statuses:ra(c,0,r)}}Math.clamp||(Math.clamp=function(t,e,r){return Math.min(Math.max(t,e),r)});let Zt=null;function aa(){return Zt||(Zt=cs()),Zt}function xn(t,e){const r=aa();return us(t,r,e)}function ps(t,e){const r=aa();return fs(t,r,e)}function ys(t){return Yn(t)}function oa(t){l.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return Mo(t)}catch(e){return l.error("[webrtcSerialization] Failed to serialize delta:",e),new Uint8Array(0)}}function sa(t){l.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Yn(t)}catch(e){return l.error("[webrtcSerialization] Failed to deserialize delta:",e),{}}}function hs(t){const e=oa(t);let r="";const n=new Uint8Array(e),a=n.byteLength;for(let s=0;s<a;s++)r+=String.fromCharCode(n[s]);return btoa(r)}function ms(t){const e=atob(t),r=new Uint8Array(e.length);for(let n=0;n<e.length;n++)r[n]=e.charCodeAt(n);return sa(r)}function Is(t,e){var g;const r=new TextEncoder,n=[],a=Date.now(),s=new Uint8Array(7);s[0]=dt.ABILITY_EFFECT,s[1]=a>>24&255,s[2]=a>>16&255,s[3]=a>>8&255,s[4]=a&255,n.push(s);const o=[];if(o.push(new Uint8Array([t])),e.sourcePos){const A=(e.sourcePos.row&15)<<4|e.sourcePos.col&15;o.push(new Uint8Array([A]))}else o.push(new Uint8Array([255]));const i=((g=e.targetPositions)==null?void 0:g.length)||0;if(o.push(new Uint8Array([Math.min(i,255)])),e.targetPositions)for(const A of e.targetPositions.slice(0,255)){const y=(A.row&15)<<4|A.col&15;o.push(new Uint8Array([y]))}if(e.text){const A=r.encode(e.text),y=Math.min(A.length,255);o.push(new Uint8Array([y])),o.push(A.slice(0,y))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(e.value??0)&255])),o.push(new Uint8Array([(e.playerId??0)&255]));let d=0;for(const A of o)d+=A.length;s[5]=d>>8&255,s[6]=d&255,n.push(...o);const c=new Uint8Array(n.reduce((A,y)=>A+y.length,0));let E=0;for(const A of n)c.set(A,E),E+=A.length;return l.debug(`[AbilityMessages] Encoded effect type ${t}: ${c.length} bytes`),c}function Es(t){let e=0;if(t[e++]!==dt.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const r=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];e+=2;const n={effectType:t[e++],timestamp:r,data:{}},a=t[e++];a!==255&&(n.data.sourcePos={row:a>>4&15,col:a&15});const s=t[e++];if(s>0){n.data.targetPositions=[];for(let i=0;i<s;i++){const d=t[e++];n.data.targetPositions.push({row:d>>4&15,col:d&15})}}const o=t[e++];if(o>0){const i=new TextDecoder;n.data.text=i.decode(t.subarray(e,e+o)),e+=o}return n.data.value=t[e++],n.data.playerId=t[e++],n}function Ts(t,e={}){const r=new TextEncoder,n=[],a=Date.now(),s=new Uint8Array(7);s[0]=dt.SESSION_EVENT,s[1]=a>>24&255,s[2]=a>>16&255,s[3]=a>>8&255,s[4]=a&255,n.push(s);const o=[];if(o.push(new Uint8Array([t])),o.push(new Uint8Array([(e.playerId??0)&255])),e.playerName){const g=r.encode(e.playerName),A=Math.min(g.length,255);o.push(new Uint8Array([A])),o.push(g.slice(0,A))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(e.startingPlayerId??0)&255])),o.push(new Uint8Array([Math.min(e.roundNumber??0,255)])),o.push(new Uint8Array([Math.min(e.newPhase??0,255)])),o.push(new Uint8Array([(e.newActivePlayerId??0)&255])),o.push(new Uint8Array([(e.gameWinner??255)&255]));let i=0;if(e.winners)for(const g of e.winners)g<32&&(i|=1<<g);o.push(new Uint8Array([i>>24&255,i>>16&255,i>>8&255,i&255]));let d=0;for(const g of o)d+=g.length;s[5]=d>>8&255,s[6]=d&255,n.push(...o);const c=new Uint8Array(n.reduce((g,A)=>g+A.length,0));let E=0;for(const g of n)c.set(g,E),E+=g.length;return l.debug(`[SessionMessages] Encoded event type ${t}: ${c.length} bytes`),c}function gs(t){let e=0;if(t[e++]!==dt.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const r=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];e+=2;const n={eventType:t[e++],timestamp:r,data:{}};n.data.playerId=t[e++];const a=t[e++];if(a>0){const i=new TextDecoder;n.data.playerName=i.decode(t.subarray(e,e+a)),e+=a}n.data.startingPlayerId=t[e++],n.data.roundNumber=t[e++],n.data.newPhase=t[e++],n.data.newActivePlayerId=t[e++];const s=t[e++];n.data.gameWinner=s===255?null:s;const o=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];if(o!==0){n.data.winners=[];for(let i=0;i<32;i++)o&1<<i&&n.data.winners.push(i)}return n}function mt(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier||0,isFaceDown:t.isFaceDown,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck,ability:t.ability,color:t.color,types:t.types,faction:t.faction,imageUrl:t.imageUrl}}function Un(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck}}function Be(t){return{id:t.id,baseId:t.baseId||t.id,power:t.power,powerModifier:t.powerModifier||0,isFaceDown:t.isFaceDown??!1,statuses:t.statuses||[]}}function ws(t,e){const r={...t,players:t.players.map(n=>{const a=e!==null&&n.id===e,s=n.isDummy===!0;if(a){const o=n.deck.length??0,i=n.discard.length??0,d=n.hand.length??0;return l.debug(`[createPersonalizedGameState] Player ${n.id} (own): ${d} hand, ${o} deck, ${i} discard`),{...n,handCards:n.hand.map(c=>Be(c)),deckCards:n.deck.map(c=>Be(c)),discardCards:n.discard.map(c=>Be(c)),hand:[],deck:[],discard:[],announcedCard:n.announcedCard?mt(n.announcedCard):null,deckSize:o,discardSize:i,handSize:d}}else if(s){const o=n.deck.length??0,i=n.discard.length??0,d=n.hand.length??0;return l.info(`[createPersonalizedGameState] Player ${n.id} (dummy): sending ${d} hand, ${o} deck, ${i} discard`),{...n,handCards:n.hand.map(c=>Be(c)),deckCards:n.deck.map(c=>Be(c)),discardCards:n.discard.map(c=>Be(c)),hand:[],deck:[],discard:[],announcedCard:n.announcedCard?mt(n.announcedCard):null,deckSize:o,discardSize:i,handSize:d}}else{const o=n.deckSize??n.deck.length??0,i=n.hand.filter(d=>!d.isFaceDown).length;return i>0&&l.debug(`[createPersonalizedGameState] Player ${n.id} (other): ${i} revealed, ${n.hand.length-i} face-down`),{...n,hand:n.hand.map(d=>d.isFaceDown?Un(d):{id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier||0,isFaceDown:d.isFaceDown,statuses:d.statuses||[],ownerId:d.ownerId,ownerName:d.ownerName,deck:d.deck}),deck:[],discard:[],announcedCard:n.announcedCard?Un(n.announcedCard):null,deckSize:o,handSize:n.handSize??n.hand.length??0,discardSize:n.discardSize??n.discard.length??0}}}),board:t.board.map(n=>n.map(a=>({...a,card:a.card?mt(a.card):null})))};return l.debug(`[createPersonalizedGameState] Created personalized state for recipient=${e}, currentPhase=${r.currentPhase}, activePlayerId=${r.activePlayerId}`),r}function _s(t,e){return{...t,players:t.players.map(r=>{if(r.id===e)return l.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(n=>Be(n)),deckCards:r.deck.map(n=>Be(n)),discardCards:r.discard.map(n=>Be(n)),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?mt(r.announcedCard):null,deckSize:r.deck.length,discardSize:r.discard.length,handSize:r.hand.length};{const a=r.hand.filter(i=>i.statuses&&i.statuses.length>0).length>0,s=r.isDummy===!0,o={...r,...a&&{handCards:r.hand.map(i=>Be(i))},hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0};return s&&(l.info(`[createCompactStateForHost] Dummy player ${r.id}: sending ${r.hand.length} hand, ${r.deck.length} deck, ${r.discard.length} discard`),o.handCards=r.hand.map(i=>Be(i)),o.deckCards=r.deck.map(i=>Be(i)),o.discardCards=r.discard.map(i=>Be(i))),r.id===e?l.info(`[createCompactStateForHost] Local player ${r.id} score: ${r.score}`):l.info(`[createCompactStateForHost] Other player ${r.id} (${s?"dummy":"real"}) score: ${o.score} (from original)`),o}}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?mt(n.card):null})))}}class bs{constructor(e={}){this.peer=null,this.connections=new Map,this.guests=new Map,this.eventHandlers=new Set,this.reconnectingPlayers=new Map,this.reconnectionTimeout=3e4,this.config={maxGuests:e.maxGuests??4,autoAcceptGuests:e.autoAcceptGuests??!0,enableReconnection:e.enableReconnection??!1},localStorage.getItem("webrtc_enabled")}async initialize(){return this.peer&&this.cleanup(),new Promise((e,r)=>{this.peer=new xt,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),e(n)}),this.peer.on("connection",n=>{l.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{l.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{l.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}handleGuestConnection(e){const r=e.peer;if(this.config.maxGuests&&this.connections.size>=this.config.maxGuests){l.warn(`Max guests limit reached: ${this.connections.size}/${this.config.maxGuests}`),e.close();return}const n={peerId:r,playerId:null,playerName:null,connected:!1,connectedAt:Date.now()};this.connections.set(r,e),this.guests.set(r,n),e.on("open",()=>{n.connected=!0,this.emitEvent({type:"guest_connected",data:{peerId:r}})}),e.on("data",a=>{this.handleMessage(a,r)}),e.on("close",()=>{const a=this.guests.get(r),s=a==null?void 0:a.playerId;this.connections.delete(r),this.guests.delete(r),s!=null&&this.config.enableReconnection&&this.markPlayerReconnecting(s,r),this.emitEvent({type:"guest_disconnected",data:{peerId:r,playerId:s}})}),e.on("error",a=>{l.error(`Guest connection error (${r}):`,a)})}handleMessage(e,r){var s,o,i;const n=this.guests.get(r),a=(n==null?void 0:n.playerId)??e.playerId??"unknown";e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE"?l.info(`[HostConnectionManager] Received ${e.type} from peer ${r} (player ${a})`,{hasData:!!e.data,hasTargetingMode:!!((s=e.data)!=null&&s.targetingMode),targetingModePlayerId:(i=(o=e.data)==null?void 0:o.targetingMode)==null?void 0:i.playerId,timestamp:e.timestamp}):l.debug(`Received WebRTC message from ${r}:`,e.type),this.emitEvent({type:"message_received",data:{message:e,fromPeerId:r}})}sendToGuest(e,r){const n=this.connections.get(e);if(!n)return l.error(`[sendToGuest] No connection found for ${e}`),!1;if(!n.open)return l.error(`[sendToGuest] Connection for ${e} is not open`),!1;try{return l.info(`[sendToGuest] Sending ${r.type} to ${e}`),n.send(r),l.info(`[sendToGuest] Sent ${r.type} to ${e} successfully`),!0}catch(a){return l.error(`[sendToGuest] Failed to send message to ${e}:`,a),!1}}broadcast(e,r){let n=0;return this.connections.forEach((a,s)=>{if(a.open&&s!==r)try{a.send(e),n++}catch(o){l.error(`Failed to send to guest ${s}:`,o)}}),l.debug(`Broadcast to ${n}/${this.connections.size} guests`),n}acceptGuestMinimal(e,r,n){var i;const a=this.connections.get(e);if(!a)return l.error(`[acceptGuestMinimal] No connection found for ${e}`),!1;if(!a.open)return l.error(`[acceptGuestMinimal] Connection for ${e} is not open`),!1;const s=this.guests.get(e);s&&(s.playerId=n);const o={type:"JOIN_ACCEPT_MINIMAL",senderId:(i=this.peer)==null?void 0:i.id,playerId:n,data:r,timestamp:Date.now()};try{return a.send(o),l.info(`Accepted guest ${e} as player ${n} (minimal)`),!0}catch(d){return l.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${e}:`,d),!1}}acceptGuest(e,r,n){var o;const a=this.connections.get(e);if(!a)return l.error(`[acceptGuest] No connection found for ${e}`),!1;if(!a.open)return l.error(`[acceptGuest] Connection for ${e} is not open`),!1;const s=this.guests.get(e);s&&(s.playerId=n);try{const i=xn(r,n),d=btoa(String.fromCharCode(...i)),c={type:"JOIN_ACCEPT_BINARY",senderId:(o=this.peer)==null?void 0:o.id,playerId:n,data:d,timestamp:Date.now()};return a.send(c),l.info(`[acceptGuest] Sent JOIN_ACCEPT_BINARY to ${e}, state size: ${d.length} chars`),!0}catch(i){return l.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${e}:`,i),!1}}broadcastGameState(e,r){if(this.connections.size===0)return;const n=e.players.map(s=>`P${s.id}:${s.score}`).join(", ");l.info(`[broadcastGameState] Broadcasting state with scores: ${n}, currentPhase=${e.currentPhase}, activePlayerId=${e.activePlayerId}`);let a=0;this.connections.forEach((s,o)=>{var d;if(!s.open||r&&o===r)return;const i=this.guests.get(o);if(i)try{const c=ws(e,i.playerId),E={type:"STATE_UPDATE_COMPACT",senderId:(d=this.peer)==null?void 0:d.id,data:{gameState:c},timestamp:Date.now()};s.send(E),a++}catch(c){l.error(`[broadcastGameState] Failed to send to guest ${o} (player ${i.playerId}):`,c)}}),l.debug(`[broadcastGameState] Sent to ${a}/${this.connections.size} guests`)}broadcastStateDelta(e,r){var n,a;{const s=hs(e),o={type:"STATE_DELTA_BINARY",senderId:(n=this.peer)==null?void 0:n.id,data:s,timestamp:Date.now()};l.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${s.length} chars, playerDeltas=${Object.keys(e.playerDeltas||{}).length}, boardCells=${((a=e.boardCells)==null?void 0:a.length)||0}`),this.broadcast(o,r),l.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${e.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(e,r,n){var a;try{const s=xn(e,r),o=btoa(String.fromCharCode(...s)),i={type:"CARD_STATE",senderId:(a=this.peer)==null?void 0:a.id,data:o,timestamp:Date.now()},d=this.broadcast(i,n);return l.info(`[broadcastCardState] Sent ${s.length} bytes to ${d} guests`),d}catch(s){return l.error("[broadcastCardState] Failed to encode/broadcast state:",s),0}}broadcastAbilityEffect(e,r,n){var a;try{const s=Is(e,r),o=btoa(String.fromCharCode(...s)),i={type:"ABILITY_EFFECT",senderId:(a=this.peer)==null?void 0:a.id,data:o,timestamp:Date.now()},d=this.broadcast(i,n);return l.debug(`[broadcastAbilityEffect] Sent effect ${e} to ${d} guests`),d}catch(s){return l.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",s),0}}broadcastSessionEvent(e,r,n){var a;try{const s=Ts(e,r),o=btoa(String.fromCharCode(...s)),i={type:"SESSION_EVENT",senderId:(a=this.peer)==null?void 0:a.id,data:o,timestamp:Date.now()},d=this.broadcast(i,n);return l.debug(`[broadcastSessionEvent] Sent event ${e} to ${d} guests`),d}catch(s){return l.error("[broadcastSessionEvent] Failed to encode/broadcast event:",s),0}}broadcastHighlight(e,r,n,a){return this.broadcastAbilityEffect(bt.HIGHLIGHT_CELL,{sourcePos:{row:e,col:r},playerId:n},a)}broadcastFloatingText(e,r,n,a){return this.broadcastAbilityEffect(bt.FLOATING_TEXT,{sourcePos:{row:e,col:r},text:n},a)}broadcastTargetingMode(e,r,n){return this.broadcastAbilityEffect(bt.TARGETING_MODE,{sourcePos:e,targetPositions:r},n)}broadcastClearTargeting(e){return this.broadcastAbilityEffect(bt.CLEAR_TARGETING,{},e)}broadcastPlayerConnected(e,r,n){return this.broadcastSessionEvent(1,{playerId:e,playerName:r},n)}broadcastPlayerDisconnected(e,r){return this.broadcastSessionEvent(2,{playerId:e},r)}broadcastGameStart(e,r){return this.broadcastSessionEvent(3,{startingPlayerId:e},r)}broadcastRoundStart(e,r){return this.broadcastSessionEvent(4,{roundNumber:e},r)}broadcastRoundEnd(e,r,n){return this.broadcastSessionEvent(5,{roundNumber:e,winners:r},n)}broadcastPhaseChange(e,r,n){return this.broadcastSessionEvent(6,{newPhase:e,newActivePlayerId:r},n)}broadcastTurnChange(e,r){return this.broadcastSessionEvent(7,{newActivePlayerId:e},r)}broadcastGameEnd(e,r){return this.broadcastSessionEvent(8,{gameWinner:e},r)}sendAction(e,r){var a;const n={type:"ACTION",senderId:(a=this.peer)==null?void 0:a.id,data:{actionType:e,actionData:r},timestamp:Date.now()};return this.broadcast(n)>0}getConnectionInfo(){const e=[];return this.connections.forEach((r,n)=>{const a=this.guests.get(n);e.push({peerId:n,playerId:(a==null?void 0:a.playerId)||null,playerName:(a==null?void 0:a.playerName)||null,connected:r.open})}),e}getGuest(e){return this.guests.get(e)}getGuestByPlayerId(e){return Array.from(this.guests.values()).find(r=>r.playerId===e)}setGuestPlayerId(e,r){const n=this.guests.get(e);n&&(n.playerId=r)}getPeerId(){var e;return((e=this.peer)==null?void 0:e.id)||null}getGuestCount(){return this.connections.size}hasGuests(){return Array.from(this.connections.values()).some(e=>e.open)}markPlayerReconnecting(e,r){this.reconnectingPlayers.set(e,{disconnectedAt:Date.now(),oldPeerId:r}),setTimeout(()=>{const n=this.reconnectingPlayers.get(e);n&&Date.now()-n.disconnectedAt>=this.reconnectionTimeout&&this.reconnectingPlayers.delete(e)},this.reconnectionTimeout),l.info(`[Reconnection] Player ${e} marked as reconnecting, window: ${this.reconnectionTimeout}ms`)}isPlayerReconnecting(e){const r=this.reconnectingPlayers.get(e);return r?Date.now()-r.disconnectedAt>=this.reconnectionTimeout?(this.reconnectingPlayers.delete(e),!1):!0:!1}getPlayerReconnectTimeRemaining(e){const r=this.reconnectingPlayers.get(e);if(!r)return 0;const n=Date.now()-r.disconnectedAt;return Math.max(0,this.reconnectionTimeout-n)}acceptPlayerReconnect(e,r,n){var o;if(!this.isPlayerReconnecting(r))return l.warn(`[Reconnection] Player ${r} not in reconnection window or expired`),!1;const a=this.connections.get(e);if(!a||!a.open)return l.error(`[Reconnection] No valid connection for ${e}`),!1;this.reconnectingPlayers.delete(r);const s={type:"RECONNECT_ACCEPT",senderId:(o=this.peer)==null?void 0:o.id,playerId:r,data:{gameState:n},timestamp:Date.now()};try{a.send(s),l.info(`[Reconnection] Player ${r} reconnected from ${e}`);const i=this.guests.get(e);return i&&(i.playerId=r),!0}catch(i){return l.error("[Reconnection] Failed to send RECONNECT_ACCEPT:",i),!1}}rejectPlayerReconnect(e,r){var s;const n=this.connections.get(e);if(!n||!n.open)return;const a={type:"RECONNECT_REJECT",senderId:(s=this.peer)==null?void 0:s.id,data:{reason:r},timestamp:Date.now()};try{n.send(a),n.close(),l.info(`[Reconnection] Rejected reconnection from ${e}, reason: ${r}`)}catch(o){l.error("[Reconnection] Failed to send RECONNECT_REJECT:",o)}}getReconnectingPlayers(){const e=Date.now(),r=[];return this.reconnectingPlayers.forEach((n,a)=>{e-n.disconnectedAt<this.reconnectionTimeout?r.push(a):this.reconnectingPlayers.delete(a)}),r}cancelPlayerReconnection(e){this.reconnectingPlayers.delete(e)}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>{try{r(e)}catch(n){l.error("Error in WebRTC event handler:",n)}})}cleanup(){if(this.connections.forEach(e=>e.close()),this.connections.clear(),this.guests.clear(),this.reconnectingPlayers.clear(),this.peer){try{this.peer.destroy()}catch{}this.peer=null}}}class As{constructor(){this.peer=null,this.connections=new Map,this.eventHandlers=new Set,localStorage.getItem("webrtc_enabled")}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>r(e))}getPeerId(){var e;return((e=this.peer)==null?void 0:e.id)??null}getConnection(e){return this.connections.get(e)}getAllConnections(){return this.connections}isInitialized(){return this.peer!==null}async initializeAsHost(e){return this.peer&&this.cleanup(),new Promise((r,n)=>{this.peer=e?new xt(e):new xt,this.peer.on("open",a=>{this.emitEvent({type:"peer_open",data:{peerId:a}}),r(a)}),this.peer.on("connection",a=>{l.info(`Incoming connection from: ${a.peer}`),this.handleConnection(a)}),this.peer.on("error",a=>{l.error("WebrtcPeer error:",a),this.emitEvent({type:"error",data:a}),n(a)}),this.peer.on("close",()=>{l.warn("WebrtcPeer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(){return this.peer&&this.cleanup(),new Promise((e,r)=>{this.peer=new xt,this.peer.on("open",n=>{e(n)}),this.peer.on("error",n=>{l.error("WebrtcPeer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{l.warn("WebrtcPeer closed"),this.emitEvent({type:"peer_closed"})})})}connectTo(e){if(!this.peer)return l.error("Cannot connect: peer not initialized"),null;const r=this.peer.connect(e,{reliable:!0,serialization:"json"});return this.handleConnection(r),r}handleConnection(e){this.connections.set(e.peer,e),e.on("open",()=>{l.info(`Connection opened: ${e.peer}`),this.emitEvent({type:"connection_open",data:{peerId:e.peer}})}),e.on("data",r=>{this.emitEvent({type:"connection_data",data:{peerId:e.peer,data:r}})}),e.on("close",()=>{l.info(`Connection closed: ${e.peer}`),this.connections.delete(e.peer),this.emitEvent({type:"connection_closed",data:{peerId:e.peer}})}),e.on("error",r=>{l.error(`Connection error (${e.peer}):`,r),this.emitEvent({type:"error",data:{peerId:e.peer,error:r}})})}sendTo(e,r){const n=this.connections.get(e);if(!n)return l.error(`[sendTo] No connection found for peer ${e}`),!1;if(!n.open)return l.error(`[sendTo] Connection for peer ${e} is not open`),!1;try{return n.send(r),!0}catch(a){return l.error(`[sendTo] Failed to send to ${e}:`,a),!1}}broadcast(e,r){let n=0;return this.connections.forEach((a,s)=>{if(a.open&&s!==r)try{a.send(e),n++}catch(o){l.error(`[broadcast] Failed to send to ${s}:`,o)}}),n}closeConnection(e){const r=this.connections.get(e);r&&(r.close(),this.connections.delete(e))}cleanup(){if(this.connections.forEach(e=>{try{e.close()}catch{}}),this.connections.clear(),this.peer){try{this.peer.destroy()}catch{}this.peer=null}}getPeer(){return this.peer}}class $n{constructor(e={}){this.hostPeerId=null,this.eventHandlers=new Set,this.config=e,this.webrtcPeer=new As,this.webrtcPeer.on(r=>this.handlePeerEvent(r)),localStorage.getItem("webrtc_enabled")}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>r(e))}handlePeerEvent(e){var r,n,a,s,o,i;switch(e.type){case"peer_open":this.hostPeerId&&this.webrtcPeer.connectTo(this.hostPeerId);break;case"connection_open":l.info(`Connected to host: ${e.data.peerId}`),this.emitEvent({type:"connected_to_host",data:{hostPeerId:e.data.peerId}}),(n=(r=this.config).onHostConnected)==null||n.call(r);break;case"connection_closed":l.warn("Host connection closed"),this.emitEvent({type:"host_disconnected"}),(s=(a=this.config).onHostDisconnected)==null||s.call(a);break;case"connection_data":this.handleMessage(e.data.data);break;case"error":l.error("WebRTC error:",e.data),this.emitEvent({type:"error",data:e.data}),(i=(o=this.config).onError)==null||i.call(o,e.data);break}}handleMessage(e){var r,n;e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE"||e.type==="JOIN_ACCEPT_MINIMAL"||e.type==="JOIN_ACCEPT"?l.info(`[GuestConnection] Received ${e.type} from host`,{senderId:e.senderId,playerId:e.playerId,hasData:!!e.data,timestamp:e.timestamp}):l.info(`[GuestConnection] Received ${e.type} from host`),this.emitEvent({type:"message_received",data:e}),(n=(r=this.config).onMessage)==null||n.call(r,e)}async connect(e){if(this.hostPeerId=e,await this.webrtcPeer.initializeAsGuest(),this.webrtcPeer.isInitialized()){const r=this.webrtcPeer.connectTo(e);if(!r)throw new Error("Failed to create connection to host");return new Promise((n,a)=>{const s=setTimeout(()=>{a(new Error("Connection timeout"))},1e4),o=()=>{clearTimeout(s);let d=null;try{const c=localStorage.getItem("webrtc_preferred_deck");c&&(d=c,l.info(`[connect] Found deck preference in localStorage: ${d}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(c){l.warn("[connect] Failed to read deck preference:",c)}this.sendMessage({type:"JOIN_REQUEST",senderId:this.getPeerId()??void 0,data:{preferredDeck:d||void 0},timestamp:Date.now()}),n()},i=d=>{clearTimeout(s),a(d)};r.once("open",o),r.once("error",i)})}}async connectAsReconnecting(e,r){this.hostPeerId=e,await this.webrtcPeer.initializeAsGuest();const n=this.webrtcPeer.connectTo(e);if(!n)throw new Error("Failed to create connection to host");return new Promise((a,s)=>{const o=setTimeout(()=>{s(new Error("Reconnection timeout"))},1e4),i=()=>{clearTimeout(o),this.sendMessage({type:"PLAYER_RECONNECT",senderId:this.getPeerId()??void 0,playerId:r,timestamp:Date.now()}),a()},d=c=>{clearTimeout(o),s(c)};n.once("open",i),n.once("error",d)})}sendMessage(e){var n,a,s;if(!this.hostPeerId)return l.warn("[GuestConnection] Not connected to host"),!1;const r=this.webrtcPeer.sendTo(this.hostPeerId,e);return(e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE")&&(r?l.info(`[GuestConnection] Sent ${e.type} to host`,{hasData:!!e.data,hasTargetingMode:!!((n=e.data)!=null&&n.targetingMode),targetingModePlayerId:(s=(a=e.data)==null?void 0:a.targetingMode)==null?void 0:s.playerId,timestamp:e.timestamp}):l.warn(`[GuestConnection] Could not send ${e.type} to host`)),r}sendAction(e,r){const n={type:"ACTION",senderId:this.getPeerId()??void 0,data:{actionType:e,actionData:r},timestamp:Date.now()};return this.sendMessage(n)}sendStateDelta(e){{const r=oa(e),n={type:"STATE_DELTA_BINARY",senderId:this.getPeerId()??void 0,data:r,timestamp:Date.now()};return this.sendMessage(n)}}sendStateToHost(e,r){var o,i;if(r===null)return l.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const n=_s(e,r),a=e.players.find(d=>d.id===r);a&&l.info(`[sendStateToHost] Player ${r} sending compact state: hand=${((o=a.hand)==null?void 0:o.length)??0}, deck=${((i=a.deck)==null?void 0:i.length)??0}, score=${a.score}`);const s={type:"STATE_UPDATE_COMPACT",senderId:this.getPeerId()??void 0,playerId:r,data:{gameState:n},timestamp:Date.now()};return this.sendMessage(s)}sendFullDeckToHost(e,r,n){const a={type:"DECK_DATA_UPDATE",senderId:this.getPeerId()??void 0,playerId:e,data:{playerId:e,deck:r.map(s=>mt(s)),deckSize:n},timestamp:Date.now()};return this.sendMessage(a)}sendCustomDeckData(e,r,n){if(!n)return!0;l.info(`[sendCustomDeckData] Player ${e} sending ${r.length} custom deck cards to host`);const a=r.map(o=>({id:o.id,baseId:o.baseId,name:o.name,power:o.power,powerModifier:o.powerModifier,ability:o.ability,types:o.types,faction:o.faction,imageUrl:o.imageUrl,color:o.color,deck:o.deck})),s={type:"CUSTOM_DECK_DATA",senderId:this.getPeerId()??void 0,playerId:e,data:{playerId:e,deckCards:a},timestamp:Date.now()};return this.sendMessage(s)}getPeerId(){return this.webrtcPeer.getPeerId()}getHostPeerId(){return this.hostPeerId}isConnected(){if(!this.hostPeerId)return!1;const e=this.webrtcPeer.getConnection(this.hostPeerId);return(e==null?void 0:e.open)??!1}getConnectionCount(){return this.isConnected()?1:0}getConnectionInfo(){if(!this.hostPeerId)return[];const e=this.webrtcPeer.getConnection(this.hostPeerId);return[{peerId:this.hostPeerId,playerId:null,playerName:null,connected:(e==null?void 0:e.open)??!1}]}cleanup(){this.webrtcPeer.cleanup(),this.hostPeerId=null}}class Ss{constructor(){this.mode=null,this.hostManager=null,this.guestManager=null,this.eventHandlers=new Set,this.isReconnecting=!1}async initializeAsHost(e){return this.mode==="guest"&&this.cleanup(),this.mode="host",this.hostManager=new bs({enableReconnection:!0}),this.hostManager.on(r=>this.emitEvent(r)),this.hostManager.initialize()}async initializeAsGuest(e){this.mode==="host"&&this.cleanup(),this.mode="guest",this.guestManager=new $n({onMessage:r=>this.emitEvent({type:"message_received",data:r}),onHostConnected:()=>this.emitEvent({type:"connected_to_host"}),onHostDisconnected:()=>this.emitEvent({type:"host_disconnected"}),onError:r=>this.emitEvent({type:"error",data:r})}),await this.guestManager.connect(e)}async initializeAsReconnectingGuest(e,r){this.mode==="host"&&this.cleanup(),this.mode="guest",this.isReconnecting=!0,this.guestManager=new $n({onMessage:n=>this.emitEvent({type:"message_received",data:n}),onHostConnected:()=>{this.isReconnecting=!1,this.emitEvent({type:"connected_to_host"})},onHostDisconnected:()=>this.emitEvent({type:"host_disconnected"}),onError:n=>{this.isReconnecting=!1,this.emitEvent({type:"error",data:n})}}),await this.guestManager.connectAsReconnecting(e,r),this.isReconnecting=!1}acceptGuest(e,r,n){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.acceptGuest(e,r,n)}acceptGuestMinimal(e,r,n){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.acceptGuestMinimal(e,r,n)}broadcastGameState(e,r){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.broadcastGameState(e,r)}broadcastStateDelta(e,r){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.broadcastStateDelta(e,r)}broadcastToGuests(e,r){return this.hostManager?this.hostManager.broadcast(e,r):(l.warn("[WebrtcManager] Not in host mode"),0)}sendToGuest(e,r){return this.hostManager?this.hostManager.sendToGuest(e,r):(l.warn("[WebrtcManager] Not in host mode"),!1)}sendAction(e,r){return this.guestManager?this.guestManager.sendAction(e,r):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendStateDelta(e){return this.guestManager?this.guestManager.sendStateDelta(e):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendStateToHost(e,r){return this.guestManager?this.guestManager.sendStateToHost(e,r):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendFullDeckToHost(e,r,n){return this.guestManager?this.guestManager.sendFullDeckToHost(e,r,n):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendCustomDeckData(e,r,n){return this.guestManager?this.guestManager.sendCustomDeckData(e,r,n):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendMessageToHost(e){return this.mode!=="guest"||!this.guestManager?!1:this.guestManager.sendMessage(e)}broadcastCardState(e,r,n){return this.hostManager?this.hostManager.broadcastCardState(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}broadcastAbilityEffect(e,r,n){return this.hostManager?this.hostManager.broadcastAbilityEffect(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}broadcastSessionEvent(e,r,n){return this.hostManager?this.hostManager.broadcastSessionEvent(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}getPeerId(){return this.mode==="host"&&this.hostManager?this.hostManager.getPeerId():this.mode==="guest"&&this.guestManager?this.guestManager.getPeerId():null}getHostPeerId(){return this.mode==="guest"&&this.guestManager?this.guestManager.getHostPeerId():this.mode==="host"&&this.hostManager?this.hostManager.getPeerId():null}getConnectionInfo(){return this.mode==="host"&&this.hostManager?this.hostManager.getConnectionInfo():this.mode==="guest"&&this.guestManager?this.guestManager.getConnectionInfo():[]}isConnected(){return this.mode==="host"&&this.hostManager?this.hostManager.hasGuests():this.mode==="guest"&&this.guestManager?this.guestManager.isConnected():!1}isHostMode(){return this.mode==="host"}getConnectionCount(){return this.mode==="host"&&this.hostManager?this.hostManager.getGuestCount():this.mode==="guest"&&this.guestManager?this.guestManager.getConnectionCount():0}getGuest(e){if(this.hostManager)return this.hostManager.getGuest(e)}getGuestByPlayerId(e){if(this.hostManager)return this.hostManager.getGuestByPlayerId(e)}setGuestPlayerId(e,r){this.hostManager&&this.hostManager.setGuestPlayerId(e,r)}isPlayerReconnecting(e){return this.hostManager?this.hostManager.isPlayerReconnecting(e):!1}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>{try{r(e)}catch(n){l.error("Error in WebRTC event handler:",n)}})}cleanup(){this.hostManager&&(this.hostManager.cleanup(),this.hostManager=null),this.guestManager&&(this.guestManager.cleanup(),this.guestManager=null),this.mode=null,this.isReconnecting=!1}get peer(){return this.mode==="host"&&this.hostManager||this.mode==="guest"&&this.guestManager,null}}let Qt=null;const sr=()=>(Qt||(Qt=new Ss),Qt);function Cs(t){return 10+t*10}function fr(t){if(!t.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const e=t.currentPhase===1,r=t.activePlayerId===t.startingPlayerId;if(!e||!r)return{shouldEnd:!1,roundWinners:[]};const n=t.currentRound||1,a=Cs(n),s=[];for(const i of t.players)!i.isDummy&&!i.isDisconnected&&i.score>=a&&s.push(i.id);return{shouldEnd:s.length>0,roundWinners:s}}function ia(t){const{shouldEnd:e,roundWinners:r}=fr(t);if(!e)return t;const n=t.currentRound||1,a={...t.roundWinners,[n]:r},s=new Map;for(const[,i]of Object.entries(a))for(const d of i){const c=s.get(d)||0;s.set(d,c+1)}let o=null;for(const[i,d]of s.entries())if(d>=2){o=i;break}return l.info(`[endRound] Round ${n} ended. Winners: [${r.join(", ")}], Game winner: ${o||"none"}`),{...t,roundWinners:a,gameWinner:o,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function pr(t,e){if(t.currentPhase!==0)return l.warn(`[performPreparationPhase] Not in Preparation phase (current: ${t.currentPhase})`),t;const r=t.players.find(s=>s.id===e);if(!r)return l.error(`[performPreparationPhase] Active player ${e} not found!`),t;l.info(`[performPreparationPhase] Player ${e} has deck size: ${r.deck.length}, hand size: ${r.hand.length}`);const n=t.players.map(s=>{if(s.id===e&&s.deck.length>0){const o=s.deck[0],i=[...s.deck.slice(1)],d=[...s.hand,o];return l.info(`[performPreparationPhase] Player ${e} drew card ${(o==null?void 0:o.id)||"unknown"}, deck now: ${i.length}, hand: ${d.length}`),{...s,deck:i,hand:d,readySetup:!1,readyCommit:!1}}return s}),a={...t,players:n,currentPhase:1};return ar(a,e),fr(a).shouldEnd?ia(a):(l.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${a.activePlayerId}`),a)}function da(t,e){const r=t.activePlayerId;if(r===e){const i={...t,activePlayerId:null};return e===t.startingPlayerId&&t.currentPhase===1&&fr(i).shouldEnd?ia(i):i}if(!t.players.filter(i=>!i.isDisconnected).find(i=>i.id===e))return l.warn(`[toggleActivePlayer] Player ${e} not found or disconnected`),t;let s=t.turnNumber||1;e===t.startingPlayerId&&r!==null&&s++;const o={...t,activePlayerId:e,turnNumber:s,currentPhase:0};return pr(o,e)}function Ds(t,e){const r=t.players.filter(s=>!s.isDisconnected).sort((s,o)=>s.id-o.id);if(r.length===0)return null;if(e===null)return r[0].id;const n=r.findIndex(s=>s.id===e);if(n===-1)return r[0].id;const a=(n+1)%r.length;return r[a].id}function Rs(t,e){var r;for(const n of t.board)for(const a of n)if(((r=a.card)==null?void 0:r.ownerId)===e)return!0;return!1}function ht(t){const e=Ds(t,t.activePlayerId);if(e===null)return l.warn("[passTurnToNextPlayer] No next player found"),t;l.info(`[passTurnToNextPlayer] Passing turn from ${t.activePlayerId} to ${e}`);let r={...t,board:t.board.map(n=>n.map(a=>{var s;return((s=a.card)==null?void 0:s.ownerId)===t.activePlayerId&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(o=>o.type!=="Stun")}}:a}))};return r={...r,board:r.board.map(n=>n.map(a=>a.card&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(s=>s.type!=="enteredThisTurn")}}:a))},r={...r,activePlayerId:e,currentPhase:0,isScoringStep:!1,targetingMode:null},pr(r,e)}function er(t,e,r){return l.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),t}function Ps(t,e){return{type:"RECONNECT_SNAPSHOT",data:t}}function ks(t,e,r){var n,a,s,o;try{const i=ps(t,r);l.info(`[WebRTCCodec] Received card state: ${(n=i.board)==null?void 0:n.length}x${((s=(a=i.board)==null?void 0:a[0])==null?void 0:s.length)||0}, ${((o=i.players)==null?void 0:o.length)||0} players`);const d={...e};return i.players&&(d.players=i.players.map(c=>{const E=e.players.find(g=>g.id===c.id);if(E){const g=c.id===r;return{...E,...c,hand:g?E.hand:c.hand,color:E.color}}return c})),i.board&&(d.board=i.board),i.currentPhase!==void 0&&(d.currentPhase=i.currentPhase),i.activePlayerId!==void 0&&(d.activePlayerId=i.activePlayerId),i.currentRound!==void 0&&(d.currentRound=i.currentRound),d}catch(i){return l.error("[WebRTCCodec] Failed to deserialize card state:",i),e}}function Os(t,e){try{const{effectType:r,timestamp:n,data:a}=Es(t);l.debug(`[WebRTCCodec] Received ability effect: ${r}`);const s=e;switch(r){case 1:return{gameState:s,effectData:{type:"highlight",...a,timestamp:n}};case 2:return{gameState:s,effectData:{type:"floatingText",...a,timestamp:n}};case 3:return{gameState:s,effectData:{type:"noTarget",...a}};case 8:return{gameState:s,effectData:{type:"targetingMode",...a}};case 9:return{gameState:s,effectData:{type:"clearTargeting"}};default:return l.warn(`[WebRTCCodec] Unknown ability effect type: ${r}`),{gameState:s,effectData:null}}}catch(r){return l.error("[WebRTCCodec] Failed to handle ability effect:",r),{gameState:e,effectData:null}}}function vs(t,e){var r;try{const{eventType:n,data:a}=gs(t);l.info(`[WebRTCCodec] Received session event: ${n}`);const s={...e};switch(n){case 1:l.info(`[WebRTCCodec] Player connected: ${a.playerName} (ID: ${a.playerId})`);break;case 2:l.info(`[WebRTCCodec] Player disconnected: ID: ${a.playerId}`),s.players=s.players.map(o=>o.id===a.playerId?{...o,isDisconnected:!0}:o);break;case 3:l.info(`[WebRTCCodec] Game starting, first player: ${a.startingPlayerId}`),s.isGameStarted=!0,a.startingPlayerId!==void 0&&(s.activePlayerId=a.startingPlayerId,s.startingPlayerId=a.startingPlayerId);break;case 4:l.info(`[WebRTCCodec] Round ${a.roundNumber} starting`),s.currentRound=a.roundNumber??1;break;case 5:if(l.info(`[WebRTCCodec] Round ${a.roundNumber} ended, winners: ${(r=a.winners)==null?void 0:r.join(", ")}`),s.isRoundEndModalOpen=!0,a.winners&&a.roundNumber!==void 0){const o=s.roundWinners||{};o[a.roundNumber]=a.winners,s.roundWinners=o}break;case 6:l.info(`[WebRTCCodec] Phase change: ${a.newPhase}`),a.newPhase!==void 0&&(s.currentPhase=a.newPhase),a.newActivePlayerId!==void 0&&(s.activePlayerId=a.newActivePlayerId);break;case 7:l.info(`[WebRTCCodec] Turn change: player ${a.newActivePlayerId}`),a.newActivePlayerId!==void 0&&(s.activePlayerId=a.newActivePlayerId);break;case 8:l.info(`[WebRTCCodec] Game ended, winner: ${a.gameWinner}`),a.gameWinner!==void 0&&(s.gameWinner=a.gameWinner===255?null:a.gameWinner);break;default:l.warn(`[WebRTCCodec] Unknown session event type: ${n}`)}return s}catch(n){return l.error("[WebRTCCodec] Failed to handle session event:",n),e}}function pt(t,e,r,n){return t===2?{gameState:ks(e,r,n)}:t===3?Os(e,r):t===4?{gameState:vs(e,r)}:(l.warn(`[WebRTCCodec] Unknown codec message type: ${t}`),{gameState:r})}const $t="avalon_game_state",at="reconnection_data";function ca(t,e){var n;t.forEach(a=>a.forEach(s=>{var o;(o=s.card)!=null&&o.statuses&&(s.card.statuses=s.card.statuses.filter(i=>!(i.type==="LastPlayed"&&i.addedByPlayerId===e.id)))})),e.boardHistory||(e.boardHistory=[]);let r=!1;for(;e.boardHistory.length>0&&!r;){const a=e.boardHistory[e.boardHistory.length-1];for(let s=0;s<t.length;s++){for(let o=0;o<t[s].length;o++)if(((n=t[s][o].card)==null?void 0:n.id)===a){const i=t[s][o].card;if(!i||i.ownerId!==e.id)continue;i.statuses||(i.statuses=[]),i.statuses.push({type:"LastPlayed",addedByPlayerId:e.id}),r=!0;break}if(r)break}r||e.boardHistory.pop()}}function _t(t){var n;if(!t||!Ke)return t;const{cardDatabase:e,tokenDatabase:r}=Ke;if(t.deck===Re.Tokens||(n=t.id)!=null&&n.startsWith("TKN_")){if(t.baseId&&r[t.baseId]){const s=r[t.baseId];return{...t,imageUrl:s.imageUrl,fallbackImage:s.fallbackImage}}const a=Object.keys(r).find(s=>r[s].name===t.name);if(a){const s=r[a];return{...t,imageUrl:s.imageUrl,fallbackImage:s.fallbackImage,baseId:a}}}else if(t.baseId&&e[t.baseId]){const a=e[t.baseId];return{...t,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage}}return t}function Ot(t){var n,a;if(!Ke)return t;const e=((n=t.board)==null?void 0:n.map(s=>s.map(o=>({...o,card:o.card?_t(o.card):null}))))||t.board,r=((a=t.players)==null?void 0:a.map(s=>{var o,i,d;return{...s,hand:((o=s.hand)==null?void 0:o.map(_t))||[],deck:((i=s.deck)==null?void 0:i.map(_t))||[],discard:((d=s.discard)==null?void 0:d.map(_t))||[],announcedCard:s.announcedCard?_t(s.announcedCard):null}}))||t.players;return{...t,board:e,players:r,floatingTexts:t.floatingTexts||[],highlights:t.highlights||[]}}function Hn(t,e,r){try{const n=Ot(t),a={gameState:n,localPlayerId:e,playerToken:r,timestamp:Date.now()};localStorage.setItem($t,JSON.stringify(a)),n.gameId&&e!==null&&localStorage.setItem(at,JSON.stringify({gameId:n.gameId,playerId:e,playerToken:r||null,timestamp:Date.now()}))}catch(n){console.warn("Failed to save game state:",n)}}function Ns(){try{const t=localStorage.getItem($t);if(!t)return null;const e=JSON.parse(t),r=24*60*60*1e3;if(Date.now()-e.timestamp>r)return localStorage.removeItem($t),localStorage.removeItem(at),null;const n=e.gameState;return{gameState:Ot(n),localPlayerId:e.localPlayerId,playerToken:e.playerToken}}catch(t){return console.warn("Failed to load game state:",t),null}}function yt(){localStorage.removeItem($t),localStorage.removeItem(at)}function yr(t){const e=[...t];for(let r=e.length-1;r>0;r--){const n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function la(){return Math.random().toString(36).substring(2,18).toUpperCase()}function et(t,e,r){const n=qn();let a=t;if(t==="Random"||!n[t]){const i=Object.keys(n);if(i.length===0)return l.error("[createDeck] No decks loaded yet!"),[];a=i[0],t==="Random"||l.warn(`[createDeck] Deck ${t} not found, using ${a} instead`)}const s=n[a];if(!s)return l.error(`Deck data for ${a} not loaded! Returning empty deck. Available decks:`,Object.keys(n)),[];if(a==="Optimates"){const i={};s.forEach(d=>{const c=d.baseId||d.id;i[c]=(i[c]||0)+1})}const o=[...s].map(i=>({...i,ownerId:e,ownerName:r}));return yr(o)}function ua(t,e=!1){const r=qn(),n=Object.keys(r);if(n.length===0)return l.error("[createNewPlayer] No decks loaded yet!"),{id:t,name:e?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:It[t-1]||"blue",isDummy:e,isReady:e,boardHistory:[],autoDrawEnabled:!0};const a=n[0],s={id:t,name:e?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:a,color:It[t-1]||"blue",isDummy:e,isReady:e,boardHistory:[],autoDrawEnabled:!0};return s.deck=et(a,t,s.name),s}function nt(){return{players:[],spectators:[],board:ea(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:ir.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}const Fn=-1,Ms=-2,At=1,Gt=2,st=(t,e,r,n)=>{var i,d,c,E,g;const{card:a,ownerId:s,location:o}=t;if(e.targetOwnerId!==void 0&&e.targetOwnerId!==Fn&&e.targetOwnerId!==Ms&&e.targetOwnerId!==s||e.excludeOwnerId!==void 0&&e.excludeOwnerId===s)return!1;if(e.onlyOpponents||e.targetOwnerId===Fn){if(s===r)return!1;const A=n.find(P=>P.id===r),y=n.find(P=>P.id===s);if(A&&y&&A.teamId!==void 0&&A.teamId===y.teamId)return!1}if(e.targetType&&!((i=a.types)!=null&&i.includes(e.targetType))||e.onlyFaceDown&&((d=a.statuses)!=null&&d.some(A=>A.type==="Revealed"&&A.addedByPlayerId===r)||o==="board"&&!a.isFaceDown)||e.tokenType==="Revealed"&&(c=a.statuses)!=null&&c.some(A=>A.type==="Revealed"&&A.addedByPlayerId===r)||e.requiredTargetStatus&&(!((E=a.statuses)!=null&&E.some(A=>A.type===e.requiredTargetStatus))||e.requireStatusFromSourceOwner&&r!==null&&!((g=a.statuses)==null?void 0:g.some(y=>y.type===e.requiredTargetStatus&&y.addedByPlayerId===r))))return!1;if(e.mustBeAdjacentToSource&&e.sourceCoords&&t.boardCoords){const{row:A,col:y}=e.sourceCoords,{row:P,col:T}=t.boardCoords;if(Math.abs(A-P)+Math.abs(y-T)!==At)return!1}if(e.mustBeInLineWithSource&&e.sourceCoords&&t.boardCoords){const{row:A,col:y}=e.sourceCoords,{row:P,col:T}=t.boardCoords;if(A!==P&&y!==T)return!1}if(e.maxDistanceFromSource!==void 0&&e.sourceCoords&&t.boardCoords){const{row:A,col:y}=e.sourceCoords,{row:P,col:T}=t.boardCoords;if(Math.max(Math.abs(A-P),Math.abs(y-T))>e.maxDistanceFromSource)return!1}if(e.maxOrthogonalDistance!==void 0&&e.sourceCoords&&t.boardCoords){const{row:A,col:y}=e.sourceCoords,{row:P,col:T}=t.boardCoords;if(Math.abs(A-P)+Math.abs(y-T)>e.maxOrthogonalDistance)return!1}return!0},Ht=(t,e,r,n)=>{if(!t||t.type!=="ENTER_MODE"&&t.type!=="CREATE_STACK")return[];const a=[],s=e.board,o=s.length,i=e.activeGridSize,d=Math.floor((o-i)/2),c=d,E=d+i-1;if(t.type==="CREATE_STACK"){const T={targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,requiredTargetStatus:t.requiredTargetStatus,requireStatusFromSourceOwner:t.requireStatusFromSourceOwner,mustBeAdjacentToSource:t.mustBeAdjacentToSource,mustBeInLineWithSource:t.mustBeInLineWithSource,maxDistanceFromSource:t.maxDistanceFromSource,maxOrthogonalDistance:t.maxOrthogonalDistance,sourceCoords:t.sourceCoords,tokenType:t.tokenType};for(let p=c;p<=E;p++)for(let m=c;m<=E;m++){const S=s[p][m];S.card&&S.card.ownerId!==void 0&&st({card:S.card,ownerId:S.card.ownerId,location:"board",boardCoords:{row:p,col:m}},T,r,e.players)&&a.push({row:p,col:m})}return a}const{mode:g,payload:A,sourceCoords:y,contextCheck:P}=t;if(g==="REVEREND_DOUBLE_EXPLOIT"){for(let T=c;T<=E;T++)for(let p=c;p<=E;p++)s[T][p].card&&a.push({row:T,col:p});return a}if((g==="SELECT_TARGET"||g==="CENSOR_SWAP"||g==="ZEALOUS_WEAKEN"||g==="CENTURION_BUFF"||g==="SELECT_UNIT_FOR_MOVE")&&A.filter&&typeof A.filter=="function"){if(A.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||A.actionType==="LUCIUS_SETUP"||A.actionType==="SELECT_HAND_FOR_DEPLOY"||A.handOnly)return[];for(let T=c;T<=E;T++)for(let p=c;p<=E;p++){const m=s[T][p];let S=m.card&&A.filter(m.card,T,p);if(S&&P==="ADJACENT_TO_LAST_MOVE"&&(n!=null&&n.lastMovedCardCoords)){const{row:_,col:I}=n.lastMovedCardCoords;Math.abs(T-_)+Math.abs(p-I)===1||(S=!1)}S&&a.push({row:T,col:p})}}else if(g==="SELECT_TARGET"&&(A.actionType==="ENHANCED_INT_REVEAL"||A.actionType==="ENHANCED_INT_MOVE"))for(let T=c;T<=E;T++)for(let p=c;p<=E;p++)s[T][p].card&&a.push({row:T,col:p});else if(g==="PATROL_MOVE"&&y)for(let T=c;T<=E;T++)for(let p=c;p<=E;p++){const m=T===y.row||p===y.col,S=T===y.row&&p===y.col,_=!s[T][p].card;m&&(_||S)&&a.push({row:T,col:p})}else if(g==="RIOT_PUSH"&&y){const T=[{r:y.row-1,c:y.col},{r:y.row+1,c:y.col},{r:y.row,c:y.col-1},{r:y.row,c:y.col+1}],p=(m,S)=>m>=c&&m<=E&&S>=c&&S<=E;T.forEach(m=>{if(p(m.r,m.c)){const S=s[m.r][m.c].card;if(S&&S.ownerId!==r){const _=e.players.find(f=>f.id===r),I=e.players.find(f=>f.id===S.ownerId);if(!((_==null?void 0:_.teamId)!==void 0&&(I==null?void 0:I.teamId)!==void 0&&_.teamId===I.teamId)){const f=m.r-y.row,w=m.c-y.col,D=m.r+f,v=m.c+w;p(D,v)&&(s[D][v].card||a.push({row:m.r,col:m.c}))}}}})}else if(g==="SHIELD_SELF_THEN_RIOT_PUSH"&&y){y&&a.push(y);const T=[{r:y.row-1,c:y.col},{r:y.row+1,c:y.col},{r:y.row,c:y.col-1},{r:y.row,c:y.col+1}],p=(m,S)=>m>=c&&m<=E&&S>=c&&S<=E;T.forEach(m=>{if(p(m.r,m.c)){const S=s[m.r][m.c].card;if(S&&S.ownerId!==r){const _=e.players.find(f=>f.id===r),I=e.players.find(f=>f.id===S.ownerId);if(!((_==null?void 0:_.teamId)!==void 0&&(I==null?void 0:I.teamId)!==void 0&&_.teamId===I.teamId)){const f=m.r-y.row,w=m.c-y.col,D=m.r+f,v=m.c+w;p(D,v)&&(s[D][v].card||a.push({row:m.r,col:m.c}))}}}})}else if(g==="RIOT_MOVE"&&A.vacatedCoords)a.push(A.vacatedCoords),y&&a.push(y);else if(g==="SWAP_POSITIONS"&&A.filter)for(let T=c;T<=E;T++)for(let p=c;p<=E;p++){const m=s[T][p];m.card&&A.filter(m.card,T,p)&&a.push({row:T,col:p})}else if((g==="TRANSFER_STATUS_SELECT"||g==="TRANSFER_ALL_STATUSES")&&A.filter)for(let T=c;T<=E;T++)for(let p=c;p<=E;p++){const m=s[T][p];m.card&&A.filter(m.card,T,p)&&a.push({row:T,col:p})}else if(g==="SPAWN_TOKEN"||g==="SELECT_CELL"||g==="IMMUNIS_RETRIEVE")for(let T=c;T<=E;T++)for(let p=c;p<=E;p++){const m=!s[T][p].card;if(g==="IMMUNIS_RETRIEVE"&&A.filter){m&&A.filter(T,p)&&a.push({row:T,col:p});continue}if(g==="SELECT_CELL"){if(A.moveFromHand){m&&a.push({row:T,col:p});continue}if(!y)continue;const S=T===y.row&&p===y.col,_=A.range==="global";let I=!1;if(_)I=!0;else if(A.range==="line")I=T===y.row||p===y.col;else if(A.range===Gt){const u=Math.abs(T-y.row),f=Math.abs(p-y.col),w=u+f;if(w===At)I=!0;else if(w===Gt){const D=[];u===Gt&&f===0?D.push({r:(T+y.row)/2,c:p}):u===0&&f===Gt?D.push({r:T,c:(p+y.col)/2}):u===At&&f===At&&(D.push({r:T,c:y.col}),D.push({r:y.row,c:p})),I=D.some(v=>v.r<0||v.r>=o||v.c<0||v.c>=o?!1:!s[v.r][v.c].card)}}else I=Math.abs(T-y.row)+Math.abs(p-y.col)===At;(m&&I||A.allowSelf&&S)&&a.push({row:T,col:p})}else if(g==="SPAWN_TOKEN"&&y){const S=Math.abs(T-y.row)+Math.abs(p-y.col)===1;m&&S&&a.push({row:T,col:p})}}else if(g==="REVEAL_ENEMY"&&A.filter)for(let T=c;T<=E;T++)for(let p=c;p<=E;p++){const m=s[T][p];m.card&&A.filter(m.card,T,p)&&a.push({row:T,col:p})}else if(g==="SELECT_LINE_START")for(let T=c;T<=E;T++)for(let p=c;p<=E;p++)a.push({row:T,col:p});else if(g==="SELECT_LINE_END"&&A.firstCoords){const{row:T,col:p}=A.firstCoords;for(let m=c;m<=E;m++)a.push({row:T,col:m});for(let m=c;m<=E;m++)a.push({row:m,col:p})}else if(g==="INTEGRATOR_LINE_SELECT"&&y){const{row:T,col:p}=y;for(let m=c;m<=E;m++)a.push({row:T,col:m});for(let m=c;m<=E;m++)a.push({row:m,col:p})}else if(g==="ZIUS_LINE_SELECT"&&y){const{row:T,col:p}=y;for(let m=c;m<=E;m++)a.push({row:T,col:m});for(let m=c;m<=E;m++)a.push({row:m,col:p})}else if(g==="IP_AGENT_THREAT_SCORING"&&y){const{row:T,col:p}=y;for(let m=c;m<=E;m++)a.push({row:T,col:m});for(let m=c;m<=E;m++)a.push({row:m,col:p})}else if(g==="SELECT_DIAGONAL")if(A.firstCoords){const{row:T,col:p}=A.firstCoords;for(let m=c;m<=E;m++)for(let S=c;S<=E;S++)Math.abs(m-T)===Math.abs(S-p)&&a.push({row:m,col:S})}else for(let T=c;T<=E;T++)for(let p=c;p<=E;p++)a.push({row:T,col:p});return a},Pt=(t,e,r,n)=>{var s,o,i,d,c;if(t.type==="OPEN_MODAL"||t.mode==="SELECT_DECK")return!0;if(t.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let E=0;E<e.board.length;E++)for(let g=0;g<e.board[E].length;g++)if(e.board[E][g].card)return!0;return!1}if(t.mode==="PRINCEPS_SHIELD_THEN_AIM"||t.mode==="SHIELD_SELF_THEN_SPAWN"||t.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||t.mode==="ABR_DEPLOY_SHIELD_AIM"||t.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(t.mode==="SELECT_TARGET"&&((s=t.payload)!=null&&s.actionType)){const E=t.payload.actionType;if(E==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||E==="LUCIUS_SETUP"||E==="SELECT_HAND_FOR_DEPLOY"){const g=((o=t.sourceCard)==null?void 0:o.ownerId)||r;if(g!==null){const A=e.players.find(y=>y.id===g);if(A&&A.hand.length>0)return!0}return!1}}if(t.type==="CREATE_STACK"){if(Ht(t,e,r,n).length>0)return!0;const g=["Aim","Exploit","Stun","Shield"];if(!(t.tokenType&&g.includes(t.tokenType))&&(t.tokenType==="Revealed"||(i=t.tokenType)!=null&&i.startsWith("Power")))for(const y of e.players)for(let P=0;P<y.hand.length;P++){const T={targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,tokenType:t.tokenType};if(st({card:y.hand[P],ownerId:y.id,location:"hand"},T,r,e.players))return!0}return!1}if(t.mode==="SELECT_TARGET"&&((d=t.payload)!=null&&d.filter)){if(t.payload.handOnly||t.payload.allowHandTargets||t.payload.actionType==="DESTROY"){for(const E of e.players)if(E.hand.some(g=>t.payload.filter(g))&&t.payload.handOnly)return!0}if(t.payload.handOnly)return!1}return Ht(t,e,r,n).length>0?!0:((t.mode==="CENSOR_SWAP"||t.mode==="ZEALOUS_WEAKEN"||t.mode==="CENTURION_BUFF"||t.mode==="SELECT_UNIT_FOR_MOVE")&&((c=t.payload)!=null&&c.filter),!1)};function Ls(t){const{ws:e,webrtcManager:r,gameStateRef:n,localPlayerIdRef:a,webrtcIsHostRef:s,setLatestHighlight:o,setLatestFloatingTexts:i,setLatestNoTarget:d,setLatestDeckSelections:c,setLatestHandCardSelections:E,setClickWaves:g,setGameState:A}=t,y=U.useRef({}),P=500,T=U.useCallback(D=>{var R;const v={...D,timestamp:Date.now()};if(o(v),((R=e.current)==null?void 0:R.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:n.current.gameId,highlightData:v}));else if(r.current){const b={type:"HIGHLIGHT_TRIGGERED",senderId:r.current.getPeerId(),data:v,timestamp:Date.now()};s.current?r.current.broadcastToGuests(b):r.current.sendMessageToHost(b)}},[e,r,n,s,o]),p=U.useCallback(D=>{var G;const v=Array.isArray(D)?D:[D],R=Date.now(),b=v.map((x,N)=>({...x,timestamp:R+N}));if(i(b),((G=e.current)==null?void 0:G.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:n.current.gameId,batch:b}));else if(r.current){const x={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:r.current.getPeerId(),data:{batch:b},timestamp:Date.now()};s.current?r.current.broadcastToGuests(x):r.current.sendMessageToHost(x)}},[e,r,n,s,i]),m=U.useCallback(D=>{var R;const v=Date.now();if(d({coords:D,timestamp:v}),((R=e.current)==null?void 0:R.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:n.current.gameId,coords:D,timestamp:v}));else if(r.current){const b={type:"NO_TARGET_TRIGGERED",senderId:r.current.getPeerId(),data:{coords:D,timestamp:v},timestamp:Date.now()};s.current?r.current.broadcastToGuests(b):r.current.sendMessageToHost(b)}},[e,r,n,s,d]),S=U.useCallback((D,v)=>{var b;const R={playerId:D,selectedByPlayerId:v,timestamp:Date.now()};if(c(G=>[...G,R]),((b=e.current)==null?void 0:b.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:n.current.gameId,deckSelectionData:R}));else if(r.current){const G={type:"DECK_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:R,timestamp:Date.now()};s.current?r.current.broadcastToGuests(G):r.current.sendMessageToHost(G)}setTimeout(()=>{c(G=>G.filter(x=>x.timestamp!==R.timestamp))},1e3)},[e,r,n,s,c]),_=U.useCallback((D,v,R)=>{var G;const b={playerId:D,cardIndex:v,selectedByPlayerId:R,timestamp:Date.now()};if(E(x=>[...x,b]),((G=e.current)==null?void 0:G.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:n.current.gameId,handCardSelectionData:b}));else if(r.current){const x={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:b,timestamp:Date.now()};s.current?r.current.broadcastToGuests(x):r.current.sendMessageToHost(x)}setTimeout(()=>{E(x=>x.filter(N=>N.timestamp!==b.timestamp))},1e3)},[e,r,n,s,E]),I=U.useCallback(D=>{},[]),u=U.useCallback((D,v,R)=>{var $;if(a.current===null)return;const b=a.current,G=Date.now(),x=y.current[b]||0;if(G-x<P)return;y.current[b]=G;const N=n.current.players.find(B=>B.id===b);if(!N)return;const M={timestamp:Date.now(),location:D,boardCoords:v,handTarget:R,clickedByPlayerId:b,playerColor:N.color};if(g(B=>[...B,M]),(($=e.current)==null?void 0:$.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_CLICK_WAVE",gameId:n.current.gameId,wave:M}));else if(r.current){const B={type:"CLICK_WAVE_TRIGGERED",senderId:r.current.getPeerId(),data:M,timestamp:Date.now()};s.current?r.current.broadcastToGuests(B):r.current.sendMessageToHost(B)}setTimeout(()=>{g(B=>B.filter(V=>V.timestamp!==M.timestamp))},600)},[e,r,n,s,g]),f=U.useCallback((D,v,R,b,G,x)=>{var B;const N=n.current;if(!N||!N.board){console.warn("[setTargetingMode] No game state or board available");return}let M;b?M=b:R&&(M=Ht(D,N,v,G));const $={playerId:v,action:D,sourceCoords:R,timestamp:Date.now(),boardTargets:M,handTargets:x};if(A(V=>({...V,targetingMode:$})),((B=e.current)==null?void 0:B.readyState)===WebSocket.OPEN&&N.gameId)e.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:N.gameId,targetingMode:$}));else if(r.current){const V={type:"SET_TARGETING_MODE",senderId:r.current.getPeerId(),data:$,timestamp:Date.now()};s.current?r.current.broadcastToGuests(V):r.current.sendMessageToHost(V)}},[e,r,n,s,A]),w=U.useCallback(()=>{var v;const D=n.current;if(A(R=>({...R,targetingMode:null})),((v=e.current)==null?void 0:v.readyState)===WebSocket.OPEN&&(D!=null&&D.gameId))e.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:D.gameId}));else if(r.current){const R={type:"CLEAR_TARGETING_MODE",senderId:r.current.getPeerId(),data:{},timestamp:Date.now()};s.current?r.current.broadcastToGuests(R):r.current.sendMessageToHost(R)}},[e,r,n,s,A]);return{triggerHighlight:T,triggerFloatingText:p,triggerNoTarget:m,triggerDeckSelection:S,triggerHandCardSelection:_,syncValidTargets:I,triggerClickWave:u,setTargetingMode:f,clearTargetingMode:w}}function Gs(t){const{ws:e,webrtcManager:r,gameStateRef:n,webrtcIsHostRef:a,setGameState:s,updateState:o}=t,i=U.useCallback(A=>{var P;if(ve()&&r.current&&a.current){s(T=>{const p=T.players.map(m=>{let S=1;for(const[_,I]of Object.entries(A))if(I.includes(m.id)){S=parseInt(_);break}return{...m,teamId:S}});return{...T,players:p}}),r.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:r.current.getPeerId(),data:{assignments:A},timestamp:Date.now()});return}((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:n.current.gameId,assignments:A}))},[e,r,n,a,s]),d=U.useCallback(A=>{var P;if(ve()&&r.current&&a.current){s(T=>({...T,gameMode:A})),r.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:r.current.getPeerId(),data:{mode:A},timestamp:Date.now()});return}((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:n.current.gameId,mode:A}))},[e,r,n,a,s]),c=U.useCallback(A=>{var P;if(ve()&&r.current&&a.current){s(T=>({...T,isPrivate:A})),r.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:r.current.getPeerId(),data:{isPrivate:A},timestamp:Date.now()});return}((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:n.current.gameId,isPrivate:A}))},[e,r,n,a,s]),E=U.useCallback(A=>{o(y=>{if(y.isGameStarted)return y;const P={...y,activeGridSize:A};if(y.board.length!==A){P.board=[];for(let p=0;p<A;p++){const m=[];for(let S=0;S<A;S++)m.push({card:null});P.board.push(m)}}return P})},[o]),g=U.useCallback(A=>{o(y=>{if(y.isGameStarted)return y;const P=y.players.filter(m=>!m.isDummy);if(P.length+A>Yo)return y;const T=[...P],p=Math.max(...P.map(m=>m.id),0);for(let m=0;m<A;m++){const S=p+m+1,_=ua(S,!0);_.name=`Dummy ${m+1}`,T.push(_)}return{...y,players:T,dummyPlayerCount:A}})},[o]);return{assignTeams:i,setGameMode:d,setGamePrivacy:c,setActiveGridSize:E,setDummyPlayerCount:g}}function xs(t){const{ws:e,webrtcManager:r,gameStateRef:n,localPlayerIdRef:a,webrtcIsHostRef:s,setGameState:o}=t,i=U.useCallback(()=>{var g;if(ve()&&r.current&&s.current){o(A=>({...A,isReadyCheckActive:!0,isPrivate:!0})),r.current.broadcastToGuests({type:"START_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((g=e.current)==null?void 0:g.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:n.current.gameId}))},[e,r,n,s,o]),d=U.useCallback(()=>{var g;if(ve()&&r.current&&s.current){o(A=>({...A,isReadyCheckActive:!1})),r.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((g=e.current)==null?void 0:g.readyState)===WebSocket.OPEN&&n.current.gameId?e.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:n.current.gameId})):o(A=>({...A,isReadyCheckActive:!1}))},[e,r,n,s,o]),c=U.useCallback(()=>{var g;const E=ve();if(E&&r.current&&s.current&&a.current!==null){o(A=>{const y=A.players.map(m=>m.id===a.current?{...m,isReady:!0}:m),P={...A,players:y},T=P.players.filter(m=>!m.isDummy&&!m.isDisconnected);if(T.length>0&&T.every(m=>m.isReady)&&!P.isGameStarted){const m=P.players.filter(f=>!f.isDisconnected),S=Math.floor(Math.random()*m.length),_=m[S].id,I={...P};I.isReadyCheckActive=!1,I.isGameStarted=!0,I.startingPlayerId=_,I.activePlayerId=_,I.currentPhase=0,I.players=I.players.map(f=>{if(f.hand.length===0&&f.deck.length>0){const D=[...f.hand],v=[...f.deck];for(let R=0;R<6&&R<v.length;R++){const b=v[0];v.splice(0,1),D.push(b)}return l.info(`[playerReady] Drew initial ${D.length} cards for player ${f.id}`),{...f,hand:D,deck:v}}return f});const u=I.players.find(f=>f.id===_);if(u&&u.deck.length>0){const f=u.deck[0],w=[...u.deck.slice(1)],D=[...u.hand,f];I.players=I.players.map(v=>v.id===_?{...v,deck:w,hand:D,readySetup:!1,readyCommit:!1}:v),I.currentPhase=1}return r.current.broadcastGameState(I),r.current.broadcastToGuests({type:"GAME_START",senderId:r.current.getPeerId(),data:{startingPlayerId:_,activePlayerId:_,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),I}return r.current.broadcastToGuests({type:"HOST_READY",senderId:r.current.getPeerId(),playerId:a.current??void 0,timestamp:Date.now()}),P});return}if(E&&r.current&&!s.current&&a.current!==null){r.current.sendMessageToHost({type:"PLAYER_READY",senderId:r.current.getPeerId(),playerId:a.current,timestamp:Date.now()}),o(A=>({...A,players:A.players.map(y=>y.id===a.current?{...y,isReady:!0}:y)}));return}((g=e.current)==null?void 0:g.readyState)===WebSocket.OPEN&&n.current.gameId&&a.current!==null&&e.current.send(JSON.stringify({type:"PLAYER_READY",gameId:n.current.gameId,playerId:a.current}))},[e,r,n,a,s,o]);return{startReadyCheck:i,cancelReadyCheck:d,playerReady:c}}function Us(t){const{updateState:e,sendWebrtcAction:r,webrtcIsHostRef:n,webrtcManagerRef:a}=t,s=U.useCallback((i,d)=>{e(c=>c.isGameStarted?c:{...c,players:c.players.map(E=>E.id===i?{...E,name:d}:E)})},[e]),o=U.useCallback((i,d)=>{e(E=>({...E,players:E.players.map(g=>g.id===i?{...g,color:d}:g)})),r!==null&&(n!=null&&n.current&&(a!=null&&a.current)?a.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:a.current.getPeerId(),data:{playerId:i,color:d},timestamp:Date.now()}):!(n!=null&&n.current)&&r&&r("CHANGE_PLAYER_COLOR",{playerId:i,color:d}))},[e,r,n,a]);return{updatePlayerName:s,changePlayerColor:o}}function $s(t){const{updateState:e}=t,r=U.useCallback(i=>{e(d=>{if(!d.isGameStarted)return d;const c=d.players.find(y=>y.id===i);if(!c||c.deck.length===0)return d;const E=me(d),g=E.players.find(y=>y.id===i),A=g.deck.shift();return A&&g.hand.push(A),E})},[e]),n=U.useCallback((i,d)=>{d<=0||e(c=>{if(!c.isGameStarted)return c;const E=c.players.find(P=>P.id===i);if(!E||E.deck.length===0)return c;const g=me(c),A=g.players.find(P=>P.id===i),y=Math.min(d,A.deck.length);for(let P=0;P<y;P++){const T=A.deck.shift();T&&A.hand.push(T)}return g})},[e]),a=U.useCallback(i=>{e(d=>{if(!d.isGameStarted||!d.players.find(A=>A.id===i))return d;const E=me(d),g=E.players.find(A=>A.id===i);return g.deck=yr([...g.deck]),E})},[e]),s=U.useCallback(i=>{e(d=>{if(!d.isGameStarted)return d;const c={...d},E=c.board[i.row][i.col].card;return E&&(E.isFaceDown=!1),{...c,board:Le(c)}})},[e]),o=U.useCallback(i=>{e(d=>{if(!d.isGameStarted)return d;const c={...d},E=c.board[i.row][i.col].card;return E&&(E.isFaceDown=!0),{...c,board:Le(c)}})},[e]);return{drawCard:r,drawCardsBatch:n,shufflePlayerDeck:a,flipBoardCard:s,flipBoardCardFaceDown:o}}function Hs(t){const{localPlayerIdRef:e,updateState:r}=t,n=U.useCallback((m,S,_)=>{r(I=>{var w,D;if(!I.isGameStarted)return I;const u=me(I),f=u.board[m.row][m.col].card;if(f){if(S==="Stun"&&(f.baseId==="luciusTheImmortal"||f.name.includes("Lucius")&&((w=f.types)!=null&&w.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(S)&&((D=f.statuses)==null?void 0:D.some(R=>R.type===S&&R.addedByPlayerId===_)))return I;f.statuses||(f.statuses=[]),f.statuses.push({type:S,addedByPlayerId:_})}return u})},[r]),a=U.useCallback((m,S)=>{r(_=>{if(!_.isGameStarted)return _;const I=me(_),u=I.board[m.row][m.col].card;if(u!=null&&u.statuses){const f=u.statuses.map(w=>w.type).lastIndexOf(S);f>-1&&u.statuses.splice(f,1)}return I.board=Le(I),I})},[r]),s=U.useCallback((m,S,_)=>{r(I=>{if(!I.isGameStarted)return I;const u=me(I),f=u.board[m.row][m.col].card;if(f!=null&&f.statuses){const w=f.statuses.findIndex(D=>D.type===S&&D.addedByPlayerId===_);w>-1&&f.statuses.splice(w,1)}return u.board=Le(u),u})},[r]),o=U.useCallback((m,S)=>{r(_=>{if(!_.isGameStarted)return _;const I=me(_),u=I.board[m.row][m.col].card;return u&&(u.powerModifier===void 0&&(u.powerModifier=0),u.powerModifier+=S),I})},[r]),i=U.useCallback((m,S,_)=>{r(I=>{var w;if(!I.isGameStarted)return I;const u=me(I),f=u.players.find(D=>D.id===m);if(f!=null&&f.announcedCard){if(["Support","Threat","Revealed"].includes(S)&&((w=f.announcedCard.statuses)==null?void 0:w.some(v=>v.type===S&&v.addedByPlayerId===_)))return I;f.announcedCard.statuses||(f.announcedCard.statuses=[]),f.announcedCard.statuses.push({type:S,addedByPlayerId:_})}return u})},[r]),d=U.useCallback((m,S)=>{r(_=>{var f;if(!_.isGameStarted)return _;const I=me(_),u=I.players.find(w=>w.id===m);if((f=u==null?void 0:u.announcedCard)!=null&&f.statuses){const w=u.announcedCard.statuses.map(D=>D.type).lastIndexOf(S);w>-1&&u.announcedCard.statuses.splice(w,1)}return I})},[r]),c=U.useCallback((m,S)=>{r(_=>{if(!_.isGameStarted)return _;const I=me(_),u=I.players.find(f=>f.id===m);return u!=null&&u.announcedCard&&(u.announcedCard.powerModifier===void 0&&(u.announcedCard.powerModifier=0),u.announcedCard.powerModifier+=S),I})},[r]),E=U.useCallback((m,S,_,I)=>{r(u=>{var D;if(!u.isGameStarted)return u;const f=me(u),w=f.players.find(v=>v.id===m);if(w!=null&&w.hand[S]){const v=w.hand[S];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(_)&&((D=v.statuses)==null?void 0:D.some(b=>b.type===_&&b.addedByPlayerId===I)))return u;v.statuses||(v.statuses=[]),v.statuses.push({type:_,addedByPlayerId:I})}return f})},[r]),g=U.useCallback((m,S,_)=>{r(I=>{if(!I.isGameStarted)return I;const u=me(I),f=u.players.find(D=>D.id===m),w=f==null?void 0:f.hand[S];if(w!=null&&w.statuses){const D=w.statuses.map(v=>v.type).lastIndexOf(_);D>-1&&w.statuses.splice(D,1),_==="Revealed"&&(w.statuses.some(R=>R.type==="Revealed")||delete w.revealedTo)}return u})},[r]),A=U.useCallback((m,S,_)=>{r(I=>{const u=I.players.find(D=>D.id===m);if(!(u!=null&&u.hand[S]))return I;const f=me(I),w=f.players.find(D=>D.id===m).hand[S];if(_==="all")w.revealedTo="all",w.statuses||(w.statuses=[]),w.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===m)||w.statuses.push({type:"Revealed",addedByPlayerId:m});else{(!w.revealedTo||w.revealedTo==="all"||!Array.isArray(w.revealedTo))&&(w.revealedTo=[]);const D=_.filter(v=>!w.revealedTo.includes(v));w.revealedTo.push(...D)}return f})},[r]),y=U.useCallback((m,S)=>{r(_=>{if(!_.board[m.row][m.col].card)return _;const u=me(_),f=u.board[m.row][m.col].card,w=f.ownerId;if(S==="all")f.revealedTo="all",w!==void 0&&(f.statuses||(f.statuses=[]),f.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===w)||f.statuses.push({type:"Revealed",addedByPlayerId:w}));else{(!f.revealedTo||f.revealedTo==="all"||!Array.isArray(f.revealedTo))&&(f.revealedTo=[]);const D=S.filter(v=>!f.revealedTo.includes(v));f.revealedTo.push(...D)}return u})},[r]),P=U.useCallback((m,S)=>{r(_=>{var w;const I=m.boardCoords?(w=_.board[m.boardCoords.row][m.boardCoords.col].card)==null?void 0:w.ownerId:m.ownerId;if(!I)return _;const u=me(_),f=u.revealRequests.find(D=>D.fromPlayerId===S&&D.toPlayerId===I);return f?f.cardIdentifiers.some(v=>JSON.stringify(v)===JSON.stringify(m))||f.cardIdentifiers.push(m):u.revealRequests.push({fromPlayerId:S,toPlayerId:I,cardIdentifiers:[m]}),u})},[r]),T=U.useCallback((m,S)=>{r(_=>{const I=_.revealRequests.findIndex(w=>w.toPlayerId===e.current&&w.fromPlayerId===m);if(I===-1)return _;const u=me(_),f=u.revealRequests[I];if(S){const{cardIdentifiers:w}=f;for(const D of w){let v=null;if(D.source==="board"&&D.boardCoords)v=u.board[D.boardCoords.row][D.boardCoords.col].card;else if(D.source==="hand"&&D.ownerId&&D.cardIndex!==void 0){const R=u.players.find(b=>b.id===D.ownerId);R&&(v=R.hand[D.cardIndex])}v&&(v.statuses||(v.statuses=[]),v.statuses.some(R=>R.type==="Revealed"&&R.addedByPlayerId===m)||v.statuses.push({type:"Revealed",addedByPlayerId:m}))}}return u.revealRequests.splice(I,1),u})},[r,e]),p=U.useCallback(m=>{r(S=>{const _=me(S);let I=null;if(m.source==="board"&&m.boardCoords)I=_.board[m.boardCoords.row][m.boardCoords.col].card;else if(m.source==="hand"&&m.playerId&&m.cardIndex!==void 0){const u=_.players.find(f=>f.id===m.playerId);u&&(I=u.hand[m.cardIndex])}return I&&(I.statuses&&(I.statuses=I.statuses.filter(u=>u.type!=="Revealed")),delete I.revealedTo),_})},[r]);return{addBoardCardStatus:n,removeBoardCardStatus:a,removeBoardCardStatusByOwner:s,modifyBoardCardPower:o,addAnnouncedCardStatus:i,removeAnnouncedCardStatus:d,modifyAnnouncedCardPower:c,addHandCardStatus:E,removeHandCardStatus:g,revealHandCard:A,revealBoardCard:y,requestCardReveal:P,respondToRevealRequest:T,removeRevealedStatus:p}}function Fs(t){const{webrtcIsHostRef:e,sendWebrtcAction:r,webrtcManagerRef:n,localPlayerIdRef:a,getCardDefinition:s,commandCardIds:o,createDeck:i,updateState:d}=t,c=U.useCallback((T,p)=>{const m=ve();let S=!1;if(d(I=>{const u=I.players.find(R=>R.id===T);if(!u)return I;S=u.isDummy||!1;const f=S,w=e.current,D=!f||w;if(m&&!w)try{localStorage.setItem("webrtc_preferred_deck",p),l.info(`[changePlayerDeck] Guest saved deck preference: ${p}`)}catch(R){l.warn("[changePlayerDeck] Failed to save deck preference:",R)}const v=D?i(p,T,u.name):[];return m?w?{...I,players:I.players.map(R=>R.id===T?{...R,deck:v,selectedDeck:p,hand:[],discard:[],announcedCard:null,boardHistory:[]}:R)}:{...I,players:I.players.map(R=>R.id===T?{...R,selectedDeck:p}:R)}:{...I,players:I.players.map(R=>R.id===T?{...R,deck:v,selectedDeck:p,hand:[],discard:[],announcedCard:null,boardHistory:[]}:R)}}),l.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${m}, isHost=${e.current}, hasSendAction=${!!r}, hasManager=${!!(n!=null&&n.current)}`),!m)return;if(e.current){const u=i(p,T,"Player "+T).map(f=>({id:f.id,baseId:f.baseId,power:f.power,powerModifier:f.powerModifier||0,isFaceDown:f.isFaceDown||!1,statuses:f.statuses||[]}));if(p==="Optimates"){const f={};u.forEach(w=>{const D=w.baseId||w.id;f[D]=(f[D]||0)+1}),l.info("[changePlayerDeck] Host sending Optimates deck data:",{totalCards:u.length,baseIdCounts:f})}n!=null&&n.current?(n.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:n.current.getPeerId(),timestamp:Date.now(),data:{playerId:T,deckType:p,deck:u,deckSize:u.length}}),l.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${T}, deck ${p}, ${u.length} cards, isDummy=${S}`)):l.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available")}else r?r("CHANGE_PLAYER_DECK",{playerId:T,deckType:p,deck:void 0,deckSize:0}):l.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[d,i,r,e,n,a]),E=U.useCallback((T,p)=>{const m=ve();let S=[];const _=new Map;for(const{cardId:u,quantity:f}of p.cards){const w=s(u);if(!w)continue;const D=o.has(u),v=D?Re.Command:Re.Custom,R=D?"CMD":"CUS";for(let b=0;b<f;b++){const G=(_.get(u)||0)+1;_.set(u,G),S.push({...w,id:`${R}_${u.toUpperCase()}_${G}`,baseId:u,deck:v,ownerId:T,ownerName:"Player "+T})}}if(S=yr(S),d(u=>u.isGameStarted||!u.players.find(w=>w.id===T)?u:{...u,players:u.players.map(w=>w.id===T?{...w,deck:S,selectedDeck:Re.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:w)}),!m)return;const I=S.map(u=>({id:u.id,baseId:u.baseId,power:u.power,powerModifier:u.powerModifier||0,isFaceDown:u.isFaceDown||!1,statuses:u.statuses||[]}));e.current?n!=null&&n.current&&(n.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:n.current.getPeerId(),timestamp:Date.now(),data:{playerId:T,deckType:Re.Custom,deck:I,deckSize:I.length}}),l.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${T}, ${I.length} cards`)):r&&(r("CHANGE_PLAYER_DECK",{playerId:T,deckType:Re.Custom,deck:I,deckSize:I.length}),l.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${T}, ${I.length} cards`))},[d,s,o,r,e,n,a]),g=U.useCallback((T,p,m,S)=>{d(_=>{if(!_.isGameStarted||_.board[m.row][m.col].card!==null)return _;const I=me(_),u=I.players.find(f=>f.id===T);if(u&&u.discard.length>p){const[f]=u.discard.splice(p,1);f.enteredThisTurn=!0,cr(f,T),(f.baseId==="luciusTheImmortal"||f.name.includes("Lucius"))&&(f.powerModifier===void 0&&(f.powerModifier=0),f.powerModifier+=2),f.statuses||(f.statuses=[]),f.statuses.push({type:"Resurrected",addedByPlayerId:T}),S&&S.forEach(w=>{var D;w.type!=="Resurrected"&&((D=f.statuses)==null||D.push({type:w.type,addedByPlayerId:T}))}),u.boardHistory||(u.boardHistory=[]),u.boardHistory.push(f.id),I.board[m.row][m.col].card=f,ca(I.board,u),I.board=Le(I)}return I})},[d]),A=U.useCallback((T,p)=>{d(m=>{const S=me(m),_=S.players.find(I=>I.id===T);if(_&&p.length>0){const I=new Set(p.map(f=>f.id)),u=_.deck.filter(f=>!I.has(f.id));_.deck=[...p,...u]}return S})},[d]),y=U.useCallback((T,p,m)=>{d(S=>{const _=me(S),I=_.players.find(u=>u.id===T);return I&&(m==="deck"?I.deck=p:m==="discard"&&(I.discard=p)),_})},[d]),P=U.useCallback((T,p)=>{d(m=>{if(!m.isGameStarted)return m;const S=me(m),_=S.players.find(I=>I.id===T);if(_&&_.discard.length>p){const[I]=_.discard.splice(p,1);_.hand.push(I)}return S})},[d]);return{changePlayerDeck:c,loadCustomDeck:E,resurrectDiscardedCard:g,reorderTopDeck:A,reorderCards:y,recoverDiscardedCard:P}}function Ws(t){const{ws:e,webrtcManagerRef:r,webrtcIsHostRef:n,gameStateRef:a,scoreDeltaAccumulator:s,setGameState:o,updateState:i,abilityMode:d,setAbilityMode:c,createDeck:E}=t,g=U.useCallback(_=>{ve()&&r.current?n.current?o(u=>{const f=da(u,_);return r.current&&r.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:r.current.getPeerId(),data:{activePlayerId:f.activePlayerId,currentPhase:f.currentPhase,turnNumber:f.turnNumber},timestamp:Date.now()}),f}):r.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:_},timestamp:Date.now()}):e.current&&e.current.readyState===WebSocket.OPEN&&(s.forEach((u,f)=>{clearTimeout(u.timerId),l.info(`[ScoreFlush] Flushing on toggle: player=${f}, delta=${u.delta}`),e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:a.current.gameId,playerId:f,delta:u.delta}))}),s.clear(),e.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:a.current.gameId,playerId:_})))},[e,r,n,a,s,o]),A=U.useCallback((_,I)=>{e.current&&e.current.readyState===WebSocket.OPEN&&e.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:a.current.gameId,playerId:_,enabled:I}))},[]),y=U.useCallback(_=>{const I=d&&c&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode);I&&c(null),i(u=>{if(!u.isGameStarted)return u;const f=Math.max(1,Math.min(_,4));return{...u,currentPhase:f,...f===4&&!I?{isScoringStep:!0}:{},...I?{isScoringStep:!1}:{}}})},[i,d,c]),P=U.useCallback(()=>{var u;d&&c&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&c(null);const _=a.current,I=ve();if(_.isGameStarted&&_.currentPhase===4&&_.isScoringStep&&!I){((u=e.current)==null?void 0:u.readyState)===WebSocket.OPEN&&(s.forEach((f,w)=>{clearTimeout(f.timerId),l.info(`[ScoreFlush] Flushing pending score: player=${w}, delta=${f.delta}`),e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:_.gameId,playerId:w,delta:f.delta}))}),s.clear(),e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:_.gameId})));return}if(I&&_.isGameStarted&&_.currentPhase===4&&_.isScoringStep){i(f=>ht(f));return}i(f=>{if(!f.isGameStarted)return f;const w=me(f),D=f.currentPhase+1;return f.preserveDeployAbilities||w.board.forEach(v=>{v.forEach(R=>{var b;(b=R.card)!=null&&b.statuses&&(R.card.statuses=R.card.statuses.filter(G=>G.type!=="readyDeploy"))})}),I&&D===4&&f.currentPhase===3?Rs(f,f.activePlayerId)?(w.isScoringStep=!0,w.currentPhase=4,w):(l.info(`[nextPhase] Player ${f.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),ht(f)):D===4&&f.currentPhase===3?(w.isScoringStep=!0,w.currentPhase=4,w):(w.board.forEach(v=>{v.forEach(R=>{var b;if((b=R.card)!=null&&b.statuses){const G=R.card.statuses.findIndex(x=>x.type==="Resurrected");if(G!==-1){const x=R.card.statuses[G].addedByPlayerId;R.card.statuses.splice(G,1),R.card.baseId!=="luciusTheImmortal"&&(R.card.statuses.push({type:"Stun",addedByPlayerId:x}),R.card.statuses.push({type:"Stun",addedByPlayerId:x}))}}})}),w.board=Le(w),w.currentPhase=D,w)})},[i,d,c,a,e,s]),T=U.useCallback(()=>{i(_=>_.isGameStarted?(d&&c&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&c(null),_.isScoringStep?{..._,isScoringStep:!1,currentPhase:Math.max(1,_.currentPhase-1)}:{..._,currentPhase:Math.max(1,_.currentPhase-1)}):_)},[i,d,c]),p=U.useCallback(()=>{var I;ve()?i(u=>({...u,isRoundEndModalOpen:!1,currentRound:(u.currentRound||1)+1,players:u.players.map(f=>({...f,score:0}))})):((I=e.current)==null?void 0:I.readyState)===WebSocket.OPEN&&a.current.gameId&&(o(u=>({...u,isRoundEndModalOpen:!1,currentRound:(u.currentRound||1)+1,players:u.players.map(f=>({...f,score:0}))})),e.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:a.current.gameId})))},[o,i,e,a]),m=U.useCallback(()=>{o(_=>({..._,isRoundEndModalOpen:!1}))},[o]),S=U.useCallback(()=>{var I;if(ve()){const u=a.current,f=u.players.map(R=>{const b=R.selectedDeck||"SynchroTech";return{...R,hand:[],deck:E(b,R.id,R.name),discard:[],score:0,isReady:R.isDummy||!1,announcedCard:null,boardHistory:[]}}),w=u.activeGridSize||8,D=[];for(let R=0;R<w;R++){const b=[];for(let G=0;G<w;G++)b.push({card:null});D.push(b)}const v={...u,players:f,board:D,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};o(v),a.current=v,r.current&&r.current.broadcastToGuests({type:"GAME_RESET",senderId:r.current.getPeerId(),data:{players:f.map(R=>({id:R.id,name:R.name,color:R.color,selectedDeck:R.selectedDeck,isDummy:R.isDummy,isDisconnected:R.isDisconnected,autoDrawEnabled:R.autoDrawEnabled,handSize:R.hand.length,deckSize:R.deck.length,discardSize:R.discard.length,...R.isDummy&&{hand:R.hand.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses})),deck:R.deck.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses})),discard:R.discard.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses}))},score:R.score,isReady:R.isReady,announcedCard:R.announcedCard})),gameMode:v.gameMode,isPrivate:v.isPrivate,activeGridSize:v.activeGridSize,dummyPlayerCount:v.dummyPlayerCount,autoAbilitiesEnabled:v.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((I=e.current)==null?void 0:I.readyState)===WebSocket.OPEN&&e.current.send(JSON.stringify({type:"RESET_GAME",gameId:a.current.gameId}))},[e,r,a,o,E]);return{toggleActivePlayer:g,toggleAutoDraw:A,setPhase:y,nextPhase:P,prevPhase:T,closeRoundEndModal:p,closeRoundEndModalOnly:m,resetGame:S}}function Bs(t){const{ws:e,gameStateRef:r,updateState:n,updatePlayerScore:a,triggerFloatingText:s,clearTargetingMode:o}=t,i=U.useCallback((c,E,g,A,y)=>{var D,v;const P=r.current;if(!P.isGameStarted||P.isRoundEndModalOpen)return;const T=P.board.some(R=>R.some(b=>{var G,x;return((G=b.card)==null?void 0:G.ownerId)===y&&b.card.name.toLowerCase().includes("data liberator")&&((x=b.card.statuses)==null?void 0:x.some(N=>N.type==="Support"))})),p=P.board.length;let m=c,S=c,_=E,I=E;if(c===g)m=c,S=c,_=0,I=p-1;else if(E===A)_=E,I=E,m=0,S=p-1;else return;let u=0;const f=[];for(let R=m;R<=S;R++)for(let b=_;b<=I;b++){const x=P.board[R][b].card;if(x&&!((D=x.statuses)!=null&&D.some(N=>N.type==="Stun"))){const N=x.ownerId===y,M=(v=x.statuses)==null?void 0:v.some($=>$.type==="Exploit"&&$.addedByPlayerId===y);if(N||T&&M&&x.ownerId!==y){const $=Math.max(0,x.power+(x.powerModifier||0)+(x.bonusPower||0));$>0&&(u+=$,f.push({row:R,col:b,text:`+${$}`,playerId:y}))}}}f.length>0&&s(f);const w=ve();if(w?n(R=>({...R,players:R.players.map(b=>b.id===y?{...b,score:Math.max(0,(b.score||0)+u)}:b)})):a(y,u),w||a(y,u),u>0&&P.currentPhase===4&&P.activePlayerId===y){const R=P.gameId;setTimeout(()=>{var b;o==null||o(),w?n(G=>ht(G)):((b=e.current)==null?void 0:b.readyState)===WebSocket.OPEN&&R&&e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:R}))},100)}},[s,a,n,e,r,o,ht]),d=U.useCallback((c,E,g,A,y,P)=>{var w,D;const T=r.current;if(!T.isGameStarted||T.isRoundEndModalOpen)return;const p=g>c?1:-1,m=A>E?1:-1,S=Math.abs(c-g);let _=0,I=0;const u=[];for(let v=0;v<=S;v++){const R=c+v*p,b=E+v*m;if(R<0||R>=T.board.length||b<0||b>=T.board.length)continue;const x=T.board[R][b].card;if(x&&!((w=x.statuses)!=null&&w.some(N=>N.type==="Stun"))&&x.ownerId===y){const M=Math.max(0,x.power+(x.powerModifier||0)+(x.bonusPower||0));M>0&&(_+=M,u.push({row:R,col:b,text:`+${M}`,playerId:y})),P&&((D=x.statuses)!=null&&D.some($=>$.type==="Support"&&$.addedByPlayerId===y))&&(I+=1)}}P==="point_per_support"&&I>0&&(_+=I),u.length>0&&s(u);const f=ve();if(f?n(v=>({...v,players:v.players.map(R=>R.id===y?{...R,score:Math.max(0,(R.score||0)+_)}:R)})):a(y,_),f||a(y,_),P==="draw_per_support"&&I>0&&n(v=>{const R=me(v),b=R.players.find(G=>G.id===y);if(b&&b.deck.length>0)for(let G=0;G<I;G++)b.deck.length>0&&b.hand.push(b.deck.shift());return R}),_>0&&T.currentPhase===4&&T.activePlayerId===y){const v=T.gameId;setTimeout(()=>{var R;o==null||o(),f?n(b=>ht(b)):((R=e.current)==null?void 0:R.readyState)===WebSocket.OPEN&&v&&e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:v}))},500)}},[s,a,n,e,r,o,ht]);return{scoreLine:i,scoreDiagonal:d}}const Ys=t=>{const{updateState:e,rawJsonData:r}=t,n=U.useCallback((g,A,y,P)=>{e(T=>{var S,_;if(!T.isGameStarted||g.row<0||g.col<0)return T;const p=me(T),m=(_=(S=p.board[g.row])==null?void 0:S[g.col])==null?void 0:_.card;if(m){const I=m.statuses?m.statuses.map(u=>u.type):[];if(P&&m.statuses){m.statuses=m.statuses.filter(f=>f.type!==P);const u=m.statuses.map(f=>f.type);l.debug(`[markAbilityUsed] Removed status '${P}' from ${m.name} at [${g.row},${g.col}]: [${I.join(", ")}] -> [${u.join(", ")}]`)}else l.debug(`[markAbilityUsed] Called for ${m.name} at [${g.row},${g.col}] but no readyStatusToRemove specified. Current statuses: [${I.join(", ")}]`)}return p})},[e]),a=U.useCallback(g=>{e(A=>{var T,p;if(!A.isGameStarted||g.row<0||g.col<0)return A;const y=me(A),P=(p=(T=y.board[g.row])==null?void 0:T[g.col])==null?void 0:p.card;if(P&&(P.statuses||(P.statuses=[]),(P.ability||"").toLowerCase().includes("deploy:")&&!P.statuses.some(S=>S.type==="readyDeploy"))){const S=P.ownerId;if(S==null||S===0)return A;P.statuses.push({type:"readyDeploy",addedByPlayerId:S})}return y})},[e]),s=U.useCallback((g,A)=>{e(y=>{if(!y.isGameStarted)return y;const P=me(y),T=P.board[g.row][g.col].card;return T!=null&&T.statuses&&(T.statuses=T.statuses.filter(p=>p.type!==A)),P.board=Le(P),P})},[e]),o=U.useCallback((g,A,y,P,T)=>{e(p=>{if(!p.isGameStarted)return p;const m=me(p);return A.forEach(({row:S,col:_})=>{var u;const I=m.board[S][_].card;if(I){if(y==="Stun"&&(I.baseId==="luciusTheImmortal"||I.name.includes("Lucius")&&((u=I.types)!=null&&u.includes("Hero"))))return;I.statuses||(I.statuses=[]),["Support","Threat","Revealed"].includes(y)?I.statuses.some(w=>w.type===y&&w.addedByPlayerId===P)||I.statuses.push({type:y,addedByPlayerId:P}):I.statuses.push({type:y,addedByPlayerId:P})}}),m})},[e]),i=U.useCallback((g,A)=>{e(y=>{if(!y.isGameStarted)return y;const P=me(y),T=P.board[g.row][g.col].card,p=P.board[A.row][A.col].card;return P.board[g.row][g.col].card=p,P.board[A.row][A.col].card=T,P.board=Le(P),P})},[e]),d=U.useCallback((g,A,y)=>{e(P=>{if(!P.isGameStarted)return P;const T=me(P),p=T.board[g.row][g.col].card,m=T.board[A.row][A.col].card;if(p&&m&&p.statuses){const S=p.statuses.findIndex(_=>_.type===y);if(S>-1){const[_]=p.statuses.splice(S,1);m.statuses||(m.statuses=[]),m.statuses.push(_)}}return T.board=Le(T),T})},[e]),c=U.useCallback((g,A)=>{e(y=>{if(!y.isGameStarted)return y;const P=me(y),T=P.board[g.row][g.col].card,p=P.board[A.row][A.col].card,m=["Support","Threat","LastPlayed"];if(T&&p&&T.statuses){const S=T.statuses.filter(I=>!m.includes(I.type)),_=T.statuses.filter(I=>m.includes(I.type));S.length>0&&(p.statuses||(p.statuses=[]),p.statuses.push(...S),T.statuses=_)}return P.board=Le(P),P})},[e]),E=U.useCallback((g,A,y)=>{e(P=>{if(!P.isGameStarted)return P;const T=me(P);if(!r)return P;const p=r.tokenDatabase,m=Object.keys(p).find(I=>p[I].name===A);if(!m)return P;const S=p[m],_=T.players.find(I=>I.id===y);if(S&&T.board[g.row][g.col].card===null){const I={id:`TKN_${A.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:Re.Tokens,name:A,baseId:S.baseId||m,imageUrl:S.imageUrl,fallbackImage:S.fallbackImage,power:S.power,ability:S.ability,flavorText:S.flavorText,color:S.color,types:S.types||["Unit"],faction:"Tokens",ownerId:y,ownerName:_==null?void 0:_.name,enteredThisTurn:!0,statuses:[]};cr(I,y),T.board[g.row][g.col].card=I}return T.board=Le(T),T})},[e,r]);return{markAbilityUsed:n,applyGlobalEffect:o,swapCards:i,transferStatus:d,transferAllCounters:c,spawnToken:E,resetDeployStatus:a,removeStatusByType:s}};function zs(t){const{updateState:e,localPlayerIdRef:r,updatePlayerScore:n}=t,a=U.useCallback((o,i)=>{e(d=>{var T,p,m,S,_,I;if(!d.isGameStarted||i.target==="board"&&i.boardCoords&&d.board[i.boardCoords.row][i.boardCoords.col].card!==null&&o.source!=="counter_panel")return d;let c=!1;try{const u=localStorage.getItem("auto_abilities_enabled");c=u===null?!0:u==="true"}catch{c=!0}const E=c&&d.currentPhase===1&&o.source==="hand"&&i.target==="board"&&(((T=o.card.types)==null?void 0:T.includes("Unit"))||((p=o.card.types)==null?void 0:p.includes("Command"))),g=me(d);if(o.source==="board"&&["hand","deck","discard"].includes(i.target)&&!o.bypassOwnershipCheck){const u=o.card.ownerId,f=g.players.find(v=>v.id===u),w=u===r.current,D=!!(f!=null&&f.isDummy);if(!w&&!D)return d}let A=null;if(o.source==="board"&&i.target==="board"&&o.boardCoords){const u=g.board[o.boardCoords.row][o.boardCoords.col];u.card&&(A=u.card);const w=d.board[o.boardCoords.row][o.boardCoords.col].card||A;if(w&&((m=w.statuses)==null?void 0:m.some(v=>v.type==="Stun"))){const v=r.current,R=w.ownerId,b=d.players.find(M=>M.id===v),G=d.players.find(M=>M.id===R),x=v===R,N=(b==null?void 0:b.teamId)!==void 0&&(G==null?void 0:G.teamId)!==void 0&&b.teamId===G.teamId;if((x||N)&&!o.isManual)return d}}if(o.source==="counter_panel"&&o.statusType){const u=it[o.statusType],f=(u==null?void 0:u.allowedTargets)??["board","hand"];if(!f.includes(i.target)&&!f.includes("board-facedown"))return d;let w=null;if(i.target==="board"&&i.boardCoords){if(w=g.board[i.boardCoords.row][i.boardCoords.col].card,f.includes("board-facedown")&&w&&!w.isFaceDown)return d}else if(i.playerId!==void 0){const D=g.players.find(v=>v.id===i.playerId);D&&(i.target==="hand"&&i.cardIndex!==void 0&&(w=D.hand[i.cardIndex]),i.target==="announced"&&(w=D.announcedCard||null),i.target==="deck"&&D.deck.length>0?i.deckPosition==="top"||!i.deckPosition?w=D.deck[0]:w=D.deck[D.deck.length-1]:i.target==="discard"&&D.discard.length>0&&(w=D.discard[D.discard.length-1]))}if(w){if(o.statusType==="Stun"&&(w.baseId==="luciusTheImmortal"||w.name.includes("Lucius")&&((S=w.types)!=null&&S.includes("Hero"))))return g;const D=o.count||1;let v;if(o.ownerId!==void 0)v=o.ownerId;else if(o.card.ownerId!==void 0)v=o.card.ownerId;else{const R=g.players.find(b=>b.id===g.activePlayerId);v=R!=null&&R.isDummy?R.id:r.current!==null?r.current:0}if(o.statusType==="Revealed"&&(i.target==="board"&&w.ownerId===v||i.target==="hand"&&i.playerId===v))return d;if(o.statusType==="Power+")w.powerModifier===void 0&&(w.powerModifier=0),w.powerModifier+=1*D;else if(o.statusType==="Power-")w.powerModifier===void 0&&(w.powerModifier=0),w.powerModifier-=1*D;else if(o.statusType==="Revealed"&&i.target==="hand"){if(w.revealedTo||(w.revealedTo=[]),w.revealedTo!=="all"){const b=Array.isArray(w.revealedTo)?w.revealedTo:[];b.includes(v)||b.push(v),w.revealedTo=b}w.statuses||(w.statuses=[]),w.statuses.some(b=>b.type==="Revealed"&&b.addedByPlayerId===v)||w.statuses.push({type:"Revealed",addedByPlayerId:v})}else if(w.statuses||(w.statuses=[]),o.replaceStatusType&&o.statusType)for(let R=0;R<D;R++){const b=w.statuses.findIndex(G=>G.type===o.replaceStatusType&&G.addedByPlayerId===v);b!==-1?w.statuses[b]={type:o.statusType,addedByPlayerId:v}:w.statuses.push({type:o.statusType,addedByPlayerId:v})}else for(let R=0;R<D;R++)["Support","Threat","Revealed"].includes(o.statusType)?w.statuses.some(G=>G.type===o.statusType&&G.addedByPlayerId===v)||w.statuses.push({type:o.statusType,addedByPlayerId:v}):w.statuses.push({type:o.statusType,addedByPlayerId:v});return i.target==="board"&&(g.board=Le(g)),g}return d}const y=A?{...A}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const u=g.players.find(f=>f.id===o.playerId);if(u){const f=u.hand[o.cardIndex];if(f&&f.id===o.card.id&&f.ownerId===o.card.ownerId)u.hand.splice(o.cardIndex,1);else{const w=u.hand.findIndex(D=>D.id===o.card.id&&D.ownerId===o.card.ownerId);if(w!==-1)u.hand.splice(w,1);else return d}}}else if(o.source==="board"&&o.boardCoords){const u=g.board[o.boardCoords.row][o.boardCoords.col];if(u.card&&u.card.id===o.card.id&&u.card.ownerId===o.card.ownerId)g.board[o.boardCoords.row][o.boardCoords.col].card=null;else return d}else if(o.source==="discard"&&o.playerId!==void 0){const u=g.players.find(f=>f.id===o.playerId);if(u){let f=!1;if(o.cardIndex!==void 0){const w=u.discard[o.cardIndex];w&&w.id===o.card.id&&w.ownerId===o.card.ownerId&&(u.discard.splice(o.cardIndex,1),f=!0)}if(!f){const w=u.discard.findIndex(D=>D.id===o.card.id&&D.ownerId===o.card.ownerId);if(w!==-1)u.discard.splice(w,1);else return d}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const u=g.players.find(f=>f.id===o.playerId);if(u){const f=u.deck[o.cardIndex];if(f&&f.id===o.card.id&&f.ownerId===o.card.ownerId)u.deck.splice(o.cardIndex,1);else{const w=u.deck.findIndex(D=>D.id===o.card.id&&D.ownerId===o.card.ownerId);if(w!==-1)u.deck.splice(w,1);else return d}}}else if(o.source==="announced"&&o.playerId!==void 0){const u=g.players.find(f=>f.id===o.playerId);if(u)if(u.announcedCard&&u.announcedCard.id===o.card.id)u.announcedCard=null;else return d}if(["hand","deck","discard"].includes(i.target))y.statuses&&(y.statuses=y.statuses.filter(u=>u.type==="Revealed")),y.isFaceDown=!1,delete y.powerModifier,delete y.bonusPower,delete y.enteredThisTurn;else if(i.target==="board"&&(y.statuses||(y.statuses=[]),o.source!=="board"&&y.isFaceDown===void 0&&(y.isFaceDown=!1),o.source!=="board")){y.enteredThisTurn=!0;let u=y.ownerId;u===void 0&&(o.source==="token_panel"?o.ownerId!==void 0?u=o.ownerId:u=g.activePlayerId??r.current??0:o.playerId!==void 0?u=o.playerId:u=r.current??0,y.ownerId=u),cr(y,u),o.source==="discard"&&(y.baseId==="luciusTheImmortal"||y.name.includes("Lucius"))&&(y.powerModifier===void 0&&(y.powerModifier=0),y.powerModifier+=2)}if(i.target==="hand"&&i.playerId!==void 0){if(y.deck===Re.Tokens)return g.board[o.boardCoords.row][o.boardCoords.col].card=null,g;Kt(y);const f=g.players.find(D=>D.id===i.playerId);if(!f)return d;let w=i.cardIndex!==void 0?i.cardIndex:f.hand.length;if(o.source==="hand"&&o.playerId===i.playerId&&o.cardIndex!==void 0&&(o.cardIndex<w&&(w-=1),o.cardIndex===w))return d;f.hand.splice(w,0,y)}else if(i.target==="board"&&i.boardCoords){if(g.board[i.boardCoords.row][i.boardCoords.col].card===null){if(y.ownerId===void 0&&r.current!==null){const u=g.players.find(f=>f.id===r.current);u&&(y.ownerId=u.id,y.ownerName=u.name)}if(o.source!=="board"&&y.ownerId!==void 0){const u=g.players.find(f=>f.id===y.ownerId);u&&(u.boardHistory||(u.boardHistory=[]),u.boardHistory.push(y.id))}g.board[i.boardCoords.row][i.boardCoords.col].card=y}}else if(i.target==="discard"&&i.playerId!==void 0){if(y.deck===Re.Tokens)return g.board[o.boardCoords.row][o.boardCoords.col].card=null,g;Kt(y);const f=g.players.find(w=>w.id===i.playerId);f&&(y.ownerId===void 0&&(y.ownerId=i.playerId,y.ownerName=f.name),f.discard.some(D=>D.id===y.id)||f.discard.push(y))}else if(i.target==="deck"&&i.playerId!==void 0){if(y.deck===Re.Tokens)return g.board[o.boardCoords.row][o.boardCoords.col].card=null,g;Kt(y);const f=g.players.find(w=>w.id===i.playerId);if(!f)return d;y.ownerId===void 0&&(y.ownerId=i.playerId,y.ownerName=f.name),i.deckPosition==="top"||!i.deckPosition?f.deck.unshift(y):f.deck.push(y)}else if(i.target==="announced"&&i.playerId!==void 0){const u=g.players.find(f=>f.id===i.playerId);u&&(u.announcedCard&&(u.announcedCard.statuses&&(u.announcedCard.statuses=u.announcedCard.statuses.filter(f=>f.type==="Revealed")),delete u.announcedCard.enteredThisTurn,delete u.announcedCard.powerModifier,delete u.announcedCard.bonusPower,u.hand.push(u.announcedCard)),u.announcedCard=y)}if(o.source==="board"&&i.target!=="board"&&y.ownerId!==void 0){const u=g.players.find(f=>f.id===y.ownerId);u&&(u.boardHistory||(u.boardHistory=[]),u.boardHistory=u.boardHistory.filter(f=>f!==y.id))}if((o.source==="board"||i.target==="board")&&y.ownerId!==void 0){const u=g.players.find(f=>f.id===y.ownerId);u&&ca(g.board,u)}if(o.source==="hand"&&i.target==="board"){const u=y;if(u.revealedTo==="all"||((_=u.statuses)==null?void 0:_.some(w=>w.type==="Revealed"))){const w=g.board.length;for(let D=0;D<w;D++)for(let v=0;v<w;v++){const R=g.board[D][v].card;if(R&&R.name.toLowerCase().includes("vigilant spotter")&&R.ownerId!==u.ownerId&&(g.board=Le(g),(I=g.board[D][v].card.statuses)!=null&&I.some(G=>G.type==="Support"))){const G=g.players.find(x=>x.id===R.ownerId);G&&setTimeout(()=>{n(G.id,2)},0)}}}}return(o.source==="board"||i.target==="board")&&(g.board=Le(g)),E&&(g.currentPhase=2),g})},[e,r,n]),s=U.useCallback((o,i)=>{e(d=>{if(!d.isGameStarted)return d;const c=me(d),E=c.board.length;if(o.row<0||o.row>=E||o.col<0||o.col>=E||i.row<0||i.row>=E||i.col<0||i.col>=E)return d;const g=c.board[o.row][o.col],A=c.board[i.row][i.col],y=g.card,P=A.card;return!y||!P?d:(c.board[o.row][o.col].card=P,c.board[i.row][i.col].card=y,c.board=Le(c),c)})},[e]);return{moveItem:a,swapBoardCards:s}}function Ks(t){const{ws:e,webrtcManager:r,gameStateRef:n,webrtcIsHostRef:a,setGameState:s}=t,o=U.useCallback((d,c,E,g,A,y)=>{var _,I,u,f,w,D,v;const P=n.current;if(typeof c!="number"){l.error(`[TargetingMode] Invalid playerId type: ${typeof c}, value:`,c);return}let T=[];g?T=g:T=Ht(d,P,c,A);let p=[];if(y)p=y;else if(p=[],(_=d.payload)!=null&&_.filter&&d.mode==="SELECT_TARGET"){l.info("[TargetingMode] Calculating hand targets for action",{actionMode:d.mode,filterType:typeof d.payload.filter,hasActionType:!!d.payload.actionType});for(const R of P.players)R.hand&&R.hand.forEach((b,G)=>{try{d.payload.filter(b)&&(p.push({playerId:R.id,cardIndex:G}),l.debug(`[TargetingMode] Found hand target: player ${R.id}, card ${G}, card ${b.name}`))}catch(x){l.warn(`[TargetingMode] Filter failed for card ${b.name}:`,x)}});l.info(`[TargetingMode] Hand targets calculated: ${p.length} targets`)}else l.info("[TargetingMode] No hand targets calculated - no filter or wrong mode",{hasFilter:!!((I=d.payload)!=null&&I.filter),mode:d.mode});const m=d.mode==="SELECT_DECK",S={playerId:c,action:d,sourceCoords:E,timestamp:Date.now(),boardTargets:T,handTargets:p.length>0?p:void 0,isDeckSelectable:m||void 0,originalOwnerId:d.originalOwnerId};if(s(R=>({...R,targetingMode:S})),n.current.targetingMode=S,((u=e.current)==null?void 0:u.readyState)===WebSocket.OPEN&&P.gameId&&e.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:P.gameId,targetingMode:S})),r.current)if(a.current)r.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((w=(f=r.current).getPeerId)==null?void 0:w.call(f))??void 0,data:{targetingMode:S},timestamp:Date.now()});else{const R=r.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((v=(D=r.current).getPeerId)==null?void 0:v.call(D))??void 0,data:{targetingMode:S},timestamp:Date.now()});l.info("[TargetingMode] Guest sent SET_TARGETING_MODE to host",{success:R,playerId:c,boardTargetsCount:T.length,handTargetsCount:p.length})}l.info(`[TargetingMode] Player ${c} (type: ${typeof c}) activated targeting mode`,{mode:d.mode,boardTargetsCount:T.length,handTargetsCount:p.length,isDeckSelectable:m||!1})},[e,r,n,a,s]),i=U.useCallback(()=>{var c,E,g,A,y;const d=n.current;s(P=>({...P,targetingMode:null})),n.current.targetingMode=null,((c=e.current)==null?void 0:c.readyState)===WebSocket.OPEN&&d.gameId&&e.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:d.gameId})),r.current&&(a.current?r.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((g=(E=r.current).getPeerId)==null?void 0:g.call(E))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):r.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((y=(A=r.current).getPeerId)==null?void 0:y.call(A))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[e,r,n,a,s]);return{setTargetingMode:o,clearTargetingMode:i}}function qs(t){const{webrtcManagerRef:e,webrtcIsHostRef:r,setWebrtcIsHost:n,setConnectionStatus:a,setWebrtcHostId:s,gameStateRef:o,localPlayerIdRef:i}=t,d=U.useCallback(async()=>{var y;try{n(!0),a("Connecting");const P=sr();e.current=P;const T=await P.initializeAsHost();s(T),a("Connected");const p=o.current.gameId;p&&or(T,p);const m=(y=o.current.players)==null?void 0:y.find(S=>S.id===i.current);return ns({peerId:T,isHost:!0,playerName:(m==null?void 0:m.name)||null}),l.info("[initializeWebrtcHost] Saved host data for auto-restore"),T}catch(P){return l.error("Failed to initialize WebRTC host:",P),a("Disconnected"),null}},[n,a,s,o,i,e]),c=U.useCallback(async y=>{try{n(!1),s(y),a("Connecting");const P=sr();return e.current=P,await P.initializeAsGuest(y),!0}catch(P){return l.error("Failed to connect as guest:",P),a("Disconnected"),!1}},[n,a,s,e]),E=U.useCallback((y,P)=>e.current?r.current?(l.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):e.current.sendAction(y,P):(l.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[e,r]),g=U.useCallback(y=>!e.current||r.current?(l.warn("[requestDeckView] Only guests can request deck view from host"),!1):e.current.sendAction("REQUEST_DECK_VIEW",{targetPlayerId:y}),[e,r]),A=U.useCallback((y,P,T)=>!e.current||r.current?(l.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):e.current.sendFullDeckToHost(y,P,T),[e,r]);return{initializeWebrtcHost:d,connectAsGuest:c,sendWebrtcAction:E,requestDeckView:g,sendFullDeckToHost:A}}function Vs(){const t=localStorage.getItem("custom_ws_url");if(!t||t.trim()==="")return l.warn("No custom WebSocket URL configured in settings."),null;let e=t.trim();return e.endsWith("/")&&(e=e.slice(0,-1)),e.startsWith("https://")?e=e.replace("https://","wss://"):e.startsWith("http://")&&(e=e.replace("http://","ws://")),!e.startsWith("ws://")&&!e.startsWith("wss://")?(l.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",e),e)}function js(t){const{gameStateRef:e,localPlayerIdRef:r,setGameState:n,setLocalPlayerId:a,setConnectionStatus:s,setGamesList:o,setLatestHighlight:i,setLatestNoTarget:d,setLatestDeckSelections:c,setLatestHandCardSelections:E,setClickWaves:g,setLatestFloatingTexts:A,setRemoteValidTargets:y,isManualExitRef:P,joiningGameIdRef:T,playerTokenRef:p,receivedServerStateRef:m,isJoinAttemptRef:S}=t,_=U.useRef(null),I=U.useRef(null),u=U.useCallback(()=>{if(ve()){s("Connected");return}if(P.current||_.current&&(_.current.readyState===WebSocket.OPEN||_.current.readyState===WebSocket.CONNECTING))return;const G=Vs();if(!G){l.warn("No WebSocket URL configured in settings. Waiting for user input."),s("Disconnected"),I.current&&clearTimeout(I.current);return}try{_.current=new WebSocket(G)}catch(x){l.error("Failed to create WebSocket:",x),s("Disconnected"),I.current&&clearTimeout(I.current),I.current=window.setTimeout(u,oe.RECONNECT_DELAY);return}s("Connecting"),_.current.onopen=()=>{var M;m.current=!1,s("Connected");const x=localStorage.getItem("custom_ws_url");x&&x.trim()!==""&&localStorage.setItem("websocket_url",x.trim());const N=e.current;if(l.info("Current gameState on open:",N?`gameId=${N.gameId}`:"null"),l.info("playerTokenRef.current on open:",p.current?"YES":"NO"),N&&N.gameId&&((M=_.current)==null?void 0:M.readyState)===WebSocket.OPEN){let $=p.current;if(!$){try{const B=localStorage.getItem(at);if(B){const V=JSON.parse(B);l.info("RECONNECTION_DATA_KEY:",V==null?void 0:V.gameId,N.gameId),V!=null&&V.playerToken&&($=V.playerToken,p.current=$,l.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(B){console.warn("Failed to parse reconnection data:",B instanceof Error?B.message:String(B))}if(!$&&N.players&&r.current){const B=N.players.find(V=>V.id===r.current);B!=null&&B.playerToken&&($=B.playerToken,p.current=$)}}l.info("JoinGame: Sending reconnection with token:",$?"YES":"NO","gameId:",N.gameId),_.current.send(JSON.stringify({type:"JOIN_GAME",gameId:N.gameId,playerToken:$}))}},_.current.onmessage=x=>{try{const N=JSON.parse(x.data);if(N.type==="GAMES_LIST")o(N.games);else if(N.type==="JOIN_SUCCESS"){if(N.isSpectator){a(null),l.info("Joined as spectator:",N.message||"Spectator mode"),T.current=null;return}a(N.playerId);const M=T.current||e.current.gameId;M&&N.playerId!==null&&N.playerToken?(p.current=N.playerToken,localStorage.setItem(at,JSON.stringify({gameId:M,playerId:N.playerId,playerToken:N.playerToken,timestamp:Date.now()})),e.current.gameId===M&&Hn(e.current,N.playerId,N.playerToken)):N.playerId===null&&(yt(),p.current=void 0),T.current=null,N.playerId===1&&setTimeout(()=>{var $;(($=_.current)==null?void 0:$.readyState)===WebSocket.OPEN&&_.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Ke}))},oe.DECK_SYNC_DELAY)}else if(N.type==="CONNECTION_ESTABLISHED"){l.info("Connection acknowledged by server");const M=sessionStorage.getItem("pending_invite_game"),$=sessionStorage.getItem("pending_invite_name");M&&_.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),l.info("Auto-joining invite game:",M),_.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:M,playerName:$||"Player"})))}else if(N.type==="DECK_DATA_UPDATED")l.info("Deck data synced with server");else if(N.type==="ERROR")if(N.message.includes("not found")||N.message.includes("Dummy")){l.info("Game not found error - clearing state");const M=nt();n(M),e.current=M,a(null),yt(),T.current=null}else if(N.message.includes("already started")&&S.current){l.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const M=nt();n(M),e.current=M,a(null),yt(),T.current=null,S.current=!1}else console.warn("Server Error:",N.message);else if(N.type==="HIGHLIGHT_TRIGGERED")i(N.highlightData);else if(N.type==="NO_TARGET_TRIGGERED")d({coords:N.coords,timestamp:N.timestamp});else if(N.type==="DECK_SELECTION_TRIGGERED")c(M=>[...M,N.deckSelectionData]),setTimeout(()=>{c(M=>M.filter($=>$.timestamp!==N.deckSelectionData.timestamp))},1e3);else if(N.type==="HAND_CARD_SELECTION_TRIGGERED")E(M=>[...M,N.handCardSelectionData]),setTimeout(()=>{E(M=>M.filter($=>$.timestamp!==N.handCardSelectionData.timestamp))},1e3);else if(N.type==="FLOATING_TEXT_TRIGGERED")n(M=>({...M,floatingTexts:[...M.floatingTexts,N.floatingTextData].filter($=>Date.now()-$.timestamp<oe.FLOATING_TEXT_DURATION)}));else if(N.type==="FLOATING_TEXT_BATCH_TRIGGERED")n(M=>({...M,floatingTexts:[...M.floatingTexts,...N.batch].filter($=>Date.now()-$.timestamp<oe.FLOATING_TEXT_DURATION)}));else if(N.type==="CLICK_WAVE_TRIGGERED")N.wave&&N.wave.clickedByPlayerId!==r.current&&(g(M=>[...M,N.wave]),setTimeout(()=>{g(M=>M.filter($=>$.timestamp!==N.wave.timestamp))},600));else if(N.type==="TARGETING_MODE_SET"){const M=N.targetingMode;M&&(n($=>({...$,targetingMode:M})),e.current.targetingMode=M,l.info("[TargetingMode] Received targeting mode from server",{playerId:M.playerId,mode:M.action.mode}))}else if(N.type==="TARGETING_MODE_CLEARED")n(M=>({...M,targetingMode:null})),e.current.targetingMode=null,l.debug("[TargetingMode] Cleared targeting mode from server");else if(N.type==="ABILITY_MODE_SET")N.abilityMode&&(n(M=>({...M,abilityMode:N.abilityMode})),l.info("[AbilityMode] Received ability mode from host",{playerId:N.abilityMode.playerId,mode:N.abilityMode.mode,sourceCard:N.abilityMode.sourceCardName}));else if(N.type==="ABILITY_TARGET_SELECTED")l.info("[Ability] Target selected",N.data);else if(N.type==="ABILITY_COMPLETED")n(M=>({...M,abilityMode:void 0})),l.info("[Ability] Ability completed",N.data);else if(N.type==="ABILITY_CANCELLED")n(M=>({...M,abilityMode:void 0})),l.info("[Ability] Ability cancelled");else if(N.type==="GAME_RESET")l.info("[GameReset] Received GAME_RESET message from server"),n(M=>{const $=N.activeGridSize||8,B=[];for(let X=0;X<$;X++){const Z=[];for(let de=0;de<$;de++)Z.push({card:null});B.push(Z)}const V={...M,players:N.players||[],gameMode:N.gameMode,isPrivate:N.isPrivate,activeGridSize:N.activeGridSize,dummyPlayerCount:N.dummyPlayerCount,autoAbilitiesEnabled:N.autoAbilitiesEnabled,isGameStarted:N.isGameStarted,currentPhase:N.currentPhase,currentRound:N.currentRound,turnNumber:N.turnNumber,activePlayerId:N.activePlayerId,startingPlayerId:N.startingPlayerId,roundWinners:N.roundWinners||{},gameWinner:N.gameWinner,isRoundEndModalOpen:N.isRoundEndModalOpen,isReadyCheckActive:N.isReadyCheckActive,board:B,targetingMode:null,floatingTexts:[]};return e.current=V,V});else if(!N.type&&N.players&&N.board){const M=Ot(N),$=e.current;if(!$.isScoringStep&&M.isScoringStep&&M.currentPhase!==2){l.debug("Ignoring delayed scoring state update");return}if($.isScoringStep&&(M.currentPhase!==$.currentPhase||M.activePlayerId!==$.activePlayerId||M.currentPhase!==4)&&(M.isScoringStep=!1),n(M),e.current=M,r.current!==null&&M.gameId){let V;try{const X=localStorage.getItem(at);X&&(V=JSON.parse(X).playerToken)}catch{}if(!V&&M.players){const X=M.players.find(Z=>Z.id===r.current);X!=null&&X.playerToken&&(V=X.playerToken,p.current=V)}Hn(M,r.current,V)}}else console.warn("Unknown message type:",N.type,"keys:",Object.keys(N),"data:",N)}catch(N){l.error("Failed to parse message from server:",x.data,N)}},_.current.onclose=()=>{s("Disconnected"),P.current||(I.current&&clearTimeout(I.current),I.current=window.setTimeout(u,oe.RECONNECT_DELAY))},_.current.onerror=x=>l.error("WebSocket error event:",x)},[n,s,o,i,d,c,E,g,A,y,a,nt,P,e,r,p,m,T]),f=U.useCallback(()=>{_.current&&(_.current.readyState===WebSocket.OPEN||_.current.readyState===WebSocket.CONNECTING)?_.current.close():u()},[_,u]),w=U.useCallback(G=>{var x;if(P.current=!1,((x=_.current)==null?void 0:x.readyState)===WebSocket.OPEN){T.current=G;let N=null;try{const $=localStorage.getItem(at);$&&(N=JSON.parse($))}catch{yt()}const M={type:"JOIN_GAME",gameId:G};(N==null?void 0:N.gameId)===G&&N.playerToken?(M.playerToken=N.playerToken,l.info(`JoinGame: Sending reconnection with token ${N.playerToken.substring(0,8)}... for player ${N.playerId}`)):l.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${N==null?void 0:N.gameId}, requestedGameId=${G}`),_.current.send(JSON.stringify(M))}else u(),T.current=G},[_,P,T,u]),D=U.useCallback((G,x="Player")=>{var N;P.current=!1,((N=_.current)==null?void 0:N.readyState)===WebSocket.OPEN?_.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:G,playerName:x})):(sessionStorage.setItem("pending_invite_game",G),sessionStorage.setItem("pending_invite_name",x),u())},[u]),v=U.useCallback(()=>{P.current=!1,yt();const G=la(),x={...nt(),gameId:G,players:[ua(1)]};return m.current=!0,setTimeout(()=>{var N;((N=_.current)==null?void 0:N.readyState)===WebSocket.OPEN&&(_.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:G})),_.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Ke})))},oe.DECK_SYNC_DELAY),{gameId:G,initialState:x}},[P,m]),R=U.useCallback(()=>{var G;((G=_.current)==null?void 0:G.readyState)===WebSocket.OPEN&&_.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[_]),b=U.useCallback((G,x,N,M)=>{var V;if(G.current)return;P.current=!0;const $=e.current.gameId,B=r.current;$&&x.current&&N($);try{M(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),l.info("[exitGame] Cleared WebRTC persistence data")}catch(X){l.warn("[exitGame] Failed to clear WebRTC data:",X)}n(nt()),a(null),yt(),_.current&&(_.current.onclose=null),((V=_.current)==null?void 0:V.readyState)===WebSocket.OPEN&&$&&B!==null&&_.current.send(JSON.stringify({type:"EXIT_GAME",gameId:$,playerId:B})),_.current&&_.current.close(),setTimeout(()=>{P.current=!1,u()},oe.RECONNECT_DELAY)},[e,r,P,n,a,_,u]);return{ws:_,reconnectTimeoutRef:I,connectWebSocket:u,forceReconnect:f,createGame:v,joinGame:w,joinAsInvite:D,exitGame:b,requestGamesList:R}}const Qe=new Map,Qi=(t={})=>{const{abilityMode:e,setAbilityMode:r}=t,[n,a]=U.useState(nt()),s=U.useRef(nt()),o=U.useCallback(h=>{a(ne=>{const Q=typeof h=="function"?h(ne):h;return s.current=ne,ve()&&j.current&&setTimeout(()=>{Y.current&&(Y.current.broadcastGameState(Q),l.debug(`[setGameStateWithDelta] Broadcast state: phase=${Q.currentPhase}, round=${Q.currentRound}`))},0),Q})},[]),[i,d]=U.useState(null),c=U.useRef(n),E=U.useRef(i),[g,A]=U.useState(null),[y,P]=U.useState("Connecting"),[T,p]=U.useState([]),[m,S]=U.useState(null),[_,I]=U.useState(null),[u,f]=U.useState(null),[w,D]=U.useState([]),[v,R]=U.useState([]),[b,G]=U.useState([]),[x,N]=U.useState(null),[M,$]=U.useState(!!Ke),[B,V]=U.useState(!1),[X,Z]=U.useState(null),[de,ge]=U.useState(!1),j=U.useRef(!1),[Ae,Me]=U.useState(!1),[we,Ee]=U.useState(null),Ne=U.useRef(!1),$e=U.useRef(null),tt=U.useRef(!1),Wt=U.useRef(!1),ct=U.useRef(),Se=U.useRef(!1),Y=U.useRef(null),Ve=U.useRef(new Map),lt=U.useRef(()=>{}),Et=qs({webrtcManagerRef:Y,webrtcIsHostRef:j,setWebrtcIsHost:ge,setConnectionStatus:P,setWebrtcHostId:Z,gameStateRef:c,localPlayerIdRef:E}),{initializeWebrtcHost:mr,connectAsGuest:Xe,sendWebrtcAction:vt,requestDeckView:Nt,sendFullDeckToHost:fa}=Et,Tt=js({gameStateRef:c,localPlayerIdRef:E,setGameState:a,setLocalPlayerId:d,setConnectionStatus:P,setGamesList:p,setLatestHighlight:S,setLatestNoTarget:f,setLatestDeckSelections:D,setLatestHandCardSelections:R,setClickWaves:G,setLatestFloatingTexts:I,setRemoteValidTargets:N,isManualExitRef:tt,joiningGameIdRef:$e,playerTokenRef:ct,receivedServerStateRef:Se,isJoinAttemptRef:Wt}),{ws:De,reconnectTimeoutRef:ut,connectWebSocket:Ir,forceReconnect:pa,joinGame:Er,joinAsInvite:ya,requestGamesList:ha}=Tt;U.useEffect(()=>{lt.current=o},[o]),U.useEffect(()=>{j.current=de},[de]),U.useEffect(()=>{const h=ve();if(V(h),h){Y.current=sr();const ne=Y.current.on(Q=>{ba(Q)});return()=>{ne()}}},[]),U.useEffect(()=>{if(!ve())return;const ne=window.location.hash.slice(1);if(ne&&new URLSearchParams(ne).get("hostId"))return;const Q="webrtc_auto_restore_attempted";if(sessionStorage.getItem(Q))return;sessionStorage.setItem(Q,"true");const ee=as();if(ee==="none"){sessionStorage.removeItem(Q);return}setTimeout(async()=>{var ie,te;if(!Y.current){l.warn("[Auto-restore] WebRTC manager not ready");return}try{if(ee==="host"){qe.current=!0,l.info("[Auto-restore] Setting restoration flag to prevent premature exit");const se=Zn(),J=Mn();if(!se||!J){l.warn("[Auto-restore] Missing host data or state data"),rt(),qe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}l.info(`[Auto-restore] Restoring host session: old peerId=${se.peerId}`);const Ie=await Y.current.initializeAsHost();j.current=!0,ge(!0),Z(Ie),P("Connected"),(ie=J.gameState)!=null&&ie.gameId&&(or(Ie,J.gameState.gameId),l.info(`[Auto-restore] Broadcasted NEW host peerId ${Ie} for game ${J.gameState.gameId}`)),(J.gameState||J.localPlayerId!==null)&&(J.gameState&&(c.current=J.gameState),J.localPlayerId!==null&&(E.current=J.localPlayerId),Ne.current=!0,setTimeout(()=>{Ne.current=!1},1e4),setTimeout(()=>{var _e;J.gameState&&(a(J.gameState),l.info(`[Auto-restore] Restored game state with ${((_e=J.gameState.players)==null?void 0:_e.length)||0} players, gameId=${J.gameState.gameId}`)),J.localPlayerId!==null&&(d(J.localPlayerId),l.info(`[Auto-restore] Restored local player ID: ${J.localPlayerId}`))},0)),setTimeout(()=>{if(qe.current=!1,l.info("[Auto-restore] Cleared restoration flag"),Y.current&&J.gameState){const _e=J.gameState.players.filter(Ge=>!Ge.isDummy&&Ge.id!==J.localPlayerId);_e.length>0&&(l.info(`[Auto-restore] Requesting deck data from ${_e.length} guest players`),Y.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:Y.current.getPeerId(),timestamp:Date.now()}))}},500),l.info("[Auto-restore] Host session restoration initiated")}else if(ee==="guest"){qe.current=!0,l.info("[Auto-restore] Setting restoration flag to prevent premature exit");const se=Qn(),J=Mn();if(!se||!J){l.warn("[Auto-restore] Missing guest data or state data"),rt(),qe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}l.info(`[Auto-restore] Restoring guest session: old hostPeerId=${se.hostPeerId}, playerId=${se.playerId}`),j.current=!1,ge(!1),P("Connecting");let Ie=se.hostPeerId;if((te=J.gameState)!=null&&te.gameId){const _e=Vt(J.gameState.gameId);_e&&_e.peerId&&(Ie=_e.peerId,l.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Ie}`))}if(Z(Ie),se.playerId!==null){l.info(`[Auto-restore] Reconnecting as existing player ${se.playerId} to host ${Ie}`);try{await Y.current.initializeAsReconnectingGuest(Ie,se.playerId),P("Connected"),l.info("[Auto-restore] Successfully reconnected to host")}catch(_e){l.error("[Auto-restore] Failed to reconnect to host:",_e),P("Disconnected"),rt(),l.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),qe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else l.info("[Auto-restore] Connecting as new player"),await Y.current.initializeAsGuest(Ie),P("Connected");(J.gameState||J.localPlayerId!==null)&&(J.gameState&&(c.current=J.gameState),J.localPlayerId!==null&&(E.current=J.localPlayerId),Ne.current=!0,setTimeout(()=>{Ne.current=!1},1e4),setTimeout(()=>{var _e,Ge;if(J.gameState&&(a(J.gameState),l.info(`[Auto-restore] Restored game state with ${((_e=J.gameState.players)==null?void 0:_e.length)||0} players, gameId=${J.gameState.gameId}, isGameStarted=${J.gameState.isGameStarted}`),J.localPlayerId!==null)){const le=(Ge=J.gameState.players)==null?void 0:Ge.some(fe=>fe.id===J.localPlayerId);l.info(`[Auto-restore] Player ${J.localPlayerId} exists in restored state: ${le}`)}J.localPlayerId!==null&&(d(J.localPlayerId),l.info(`[Auto-restore] Restored local player ID: ${J.localPlayerId}`))},0)),setTimeout(()=>{qe.current=!1,l.info("[Auto-restore] Cleared restoration flag")},100),l.info("[Auto-restore] Guest session restoration initiated")}}catch(se){l.error("[Auto-restore] Failed to restore session:",se),rt(),qe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),U.useEffect(()=>{if(!B||!Y.current)return;const h=window.location.hash.slice(1);if(!h)return;const Q=new URLSearchParams(h).get("hostId");Q&&Xe(Q)},[B]),U.useEffect(()=>{c.current=n},[n]),U.useEffect(()=>{E.current=i},[i]),U.useEffect(()=>{if(!n||!n.players||!i)return;const h=es(n.players,i);Qo.preloadMany(h,"low")},[n==null?void 0:n.players,i]);const ma=Ls({ws:De,webrtcManager:Y,gameStateRef:c,localPlayerIdRef:E,webrtcIsHostRef:j,setLatestHighlight:S,setLatestFloatingTexts:I,setLatestNoTarget:f,setLatestDeckSelections:D,setLatestHandCardSelections:R,setClickWaves:G,setGameState:a}),{triggerHighlight:Ia,triggerFloatingText:Tr,triggerNoTarget:Ea,triggerDeckSelection:Ta,triggerHandCardSelection:ga,syncValidTargets:wa,triggerClickWave:_a}=ma,qe=U.useRef(!1);U.useEffect(()=>{if(!B||!j.current||!(n!=null&&n.gameId))return;const h=n.gameId,ne=()=>{var ie;const ee=(ie=Y.current)==null?void 0:ie.getPeerId();ee&&h&&or(ee,h)};ne();const Q=setInterval(ne,2e3);return()=>clearInterval(Q)},[B,n==null?void 0:n.gameId]),U.useEffect(()=>{if(!B||j.current||!(n!=null&&n.gameId))return;const h=n.gameId,ne=ie=>{var te;Z(ie),P("Connecting"),(te=Y.current)==null||te.initializeAsReconnectingGuest(ie,E.current||0).then(()=>{P("Connected")}).catch(se=>{l.error("[Guest Auto-Reconnect] Failed to reconnect:",se),P("Disconnected")})},Q=ie=>{const te=`webrtc_host_${h}`;if(!(ie.key!==te||!ie.newValue))try{const J=JSON.parse(ie.newValue).peerId;J&&J!==X&&ne(J)}catch(se){l.error("[Guest Auto-Reconnect] Failed to parse storage event:",se)}},ee=setInterval(()=>{const ie=Vt(h);ie&&ie.peerId!==X&&(l.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${ie.peerId}`),ne(ie.peerId))},2e3);return window.addEventListener("storage",Q),()=>{window.removeEventListener("storage",Q),clearInterval(ee)}},[B,n==null?void 0:n.gameId,X]),U.useEffect(()=>{const h=setInterval(()=>{a(ne=>{const Q=Date.now(),ee=ne.floatingTexts||[],ie=ee.filter(te=>Q-te.timestamp<oe.FLOATING_TEXT_DURATION);return ie.length!==ee.length?{...ne,floatingTexts:ie}:ne})},oe.DECK_SYNC_DELAY);return()=>clearInterval(h)},[]);const ba=U.useCallback(h=>{var ne,Q,ee;switch(h.type){case"peer_open":(ne=h.data)!=null&&ne.peerId&&(Z(h.data.peerId),l.info(`WebRTC peer opened with ID: ${h.data.peerId}`));break;case"guest_connected":l.info("Guest connected via WebRTC:",(Q=h.data)==null?void 0:Q.peerId);break;case"connected_to_host":(ee=h.data)!=null&&ee.hostPeerId&&X!==h.data.hostPeerId&&(Z(h.data.hostPeerId),l.info(`Updated webrtcHostId to: ${h.data.hostPeerId}`)),P("Connected"),Me(!1),Ee(null),Ne.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(l.warn("WebRTC peer disconnected"),P("Disconnected"),Me(!0),!j.current&&X&&n)try{const te={hostPeerId:X,playerId:i,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(te)),l.info("[Reconnection] Stored reconnection data before disconnect"),Ca(X)}catch(te){l.error("[Reconnection] Failed to store data:",te)}break;case"message_received":const ie=h.data.message||h.data;Sa(ie);break;case"error":l.error("WebRTC error:",h.data);break}},[n,i,X,de]),Aa=U.useCallback((h,ne)=>{if(l.info(`[handleWebrtcGuestJoin] Called for guest ${h}, isHost: ${j.current}`),!j.current||!Y.current){l.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const Q=(ne==null?void 0:ne.preferredDeck)||"Random";a(ee=>{if(!ee)return l.error("[handleWebrtcGuestJoin] No previous state"),ee;l.info(`[handleWebrtcGuestJoin] Current state has ${ee.players.length} players`);const ie=ee.players.map(le=>le.id);let te=1;for(;ie.includes(te);)te++;const se={id:te,name:`Player ${te}`,color:It[(te-1)%It.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:Q,boardHistory:[],autoDrawEnabled:!0},J={...ee,players:[...ee.players,se]},Ie=ee.board.map(le=>le.map(fe=>({...fe,card:fe.card?{id:fe.card.id,baseId:fe.card.baseId,ownerId:fe.card.ownerId,name:fe.card.name,imageUrl:fe.card.imageUrl,power:fe.card.power,ability:fe.card.ability,isFaceDown:fe.card.isFaceDown,statuses:fe.card.statuses||[]}:null}))),_e=le=>le.map(fe=>({id:fe.id,baseId:fe.baseId,name:fe.name,imageUrl:fe.imageUrl,power:fe.power,powerModifier:fe.powerModifier,ability:fe.ability,ownerId:fe.ownerId,color:fe.color,deck:fe.deck,isFaceDown:fe.isFaceDown,types:fe.types,faction:fe.faction,statuses:fe.statuses}));Y.current.acceptGuestMinimal(h,{playerId:te,gameId:ee.gameId,isGameStarted:ee.isGameStarted,players:J.players.map(le=>le.isDummy?{id:le.id,name:le.name,color:le.color,isDummy:le.isDummy,isReady:le.isReady,score:le.score,selectedDeck:le.selectedDeck,hand:_e(le.hand||[]),deck:_e(le.deck||[]),discard:_e(le.discard||[]),handSize:le.hand.length,deckSize:le.deck.length,discardSize:le.discard.length}:{id:le.id,name:le.name,color:le.color,isDummy:le.isDummy,isReady:le.isReady,score:le.score,selectedDeck:le.selectedDeck,deckSize:le.deck.length,handSize:le.hand.length,discardSize:le.discard.length}),deckSelections:J.players.map(le=>({id:le.id,selectedDeck:le.selectedDeck})),gameMode:ee.gameMode,currentRound:ee.currentRound,currentPhase:ee.currentPhase,activePlayerId:ee.activePlayerId,startingPlayerId:ee.startingPlayerId,activeGridSize:ee.activeGridSize,board:Ie},te),Y.current.broadcastGameState(J,h),Y.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:Y.current.getPeerId(),data:{playerId:te,selectedDeck:Q},timestamp:Date.now()});const Ge=J.players.find(le=>le.id===E.current);if(Ge&&Ge.deck.length>0){const le=Ge.deck.map(fe=>({id:fe.id,baseId:fe.baseId,power:fe.power,powerModifier:fe.powerModifier||0,isFaceDown:fe.isFaceDown||!1,statuses:fe.statuses||[]}));Y.current.sendToGuest(h,{type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:Ge.id,data:{playerId:Ge.id,deckType:Ge.selectedDeck,deck:le,deckSize:le.length},timestamp:Date.now()}),l.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${Ge.selectedDeck}, ${le.length} cards`)}return J})},[]),gr=U.useCallback(h=>{const ne=j.current;if(l.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!Y.current}, webrtcIsHostRef.current=${ne}`),!Y.current||!ne){l.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}Y.current.broadcastGameState(h)},[]),Sa=U.useCallback(h=>{var ne,Q,ee,ie,te,se,J,Ie,_e,Ge,le,fe,br,Ar,Sr,Cr,Dr,Rr,Pr,kr,Or,vr,Nr,Mr,Lr,Gr,xr,Ur,$r,Hr,Fr,Wr,Br,Yr,zr,Kr,qr,Vr,jr,Jr,Xr,Zr,Qr,en,tn,rn,nn,an,on,sn,dn,cn,ln,un,fn,pn,yn,hn,mn,In,En,Tn,gn,wn,_n,bn,An,Sn,Cn,Dn,Rn,Pn,kn;if(!(!h||!h.type))switch(l.info(`[handleWebrtcMessage] Received: ${h.type}`),h.type){case"JOIN_ACCEPT_MINIMAL":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${h.playerId}`),h.data){const C=h.data;l.info(`[handleWebrtcMessage] Creating minimal state with ${((ne=C.players)==null?void 0:ne.length)||0} players`);const k={gameId:C.gameId||la(),isGameStarted:C.isGameStarted||!1,isPrivate:!1,activeGridSize:C.activeGridSize||4,gameMode:C.gameMode||ir.FreeForAll,dummyPlayerCount:0,players:((Q=C.players)==null?void 0:Q.map(O=>{if((O.isDummy||!1)&&O.hand&&O.deck&&O.discard)return{id:O.id,name:O.name,color:O.color,isDummy:!0,isReady:O.isReady||!1,score:O.score||0,hand:O.hand||[],deck:O.deck||[],discard:O.discard||[],announcedCard:null,selectedDeck:O.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const q=[],L=[],H=[];for(let F=0;F<(O.handSize||0);F++)q.push({id:`placeholder_${O.id}_hand_${F}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});for(let F=0;F<(O.deckSize||0);F++)L.push({id:`placeholder_${O.id}_deck_${F}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});for(let F=0;F<(O.discardSize||0);F++)H.push({id:`placeholder_${O.id}_discard_${F}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});return{id:O.id,name:O.name,color:O.color,isDummy:!1,isReady:O.isReady||!1,score:O.score||0,hand:q,deck:L,discard:H,announcedCard:null,selectedDeck:O.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:C.board||ea(),hostId:1,currentPhase:C.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:C.currentRound||1,turnNumber:C.turnNumber||1,activePlayerId:C.activePlayerId??null,startingPlayerId:C.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};a(k),h.playerId!==void 0&&(d(h.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${h.playerId}`)),a(O=>{const W=O.players.map(q=>{var H;const L=(H=C.players)==null?void 0:H.find(F=>F.id===q.id);if(q.id===h.playerId){const z=q.deck.length===0||q.deck.some(K=>K.isPlaceholder)||q.deck.length!==30;if(L!=null&&L.selectedDeck&&z){const K=et(L.selectedDeck,q.id,q.name);l.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${K.length} cards from ${L.selectedDeck}`),Y.current&&K.length>0&&setTimeout(()=>{const ae=K.map(ue=>({id:ue.id,baseId:ue.baseId,power:ue.power,powerModifier:ue.powerModifier||0,isFaceDown:ue.isFaceDown||!1,statuses:ue.statuses||[]}));Y.current.sendAction("DECK_DATA_UPDATE",{playerId:h.playerId,deck:ae,deckSize:ae.length}),l.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${L.selectedDeck}, ${ae.length} cards`)},0);const re=[...q.hand],ce=[...K];if(C.isGameStarted&&re.length===0&&ce.length>0){for(let ue=0;ue<6&&ue<ce.length;ue++){const pe=ce[0];ce.splice(0,1),re.push(pe)}l.info(`[JOIN_ACCEPT_MINIMAL] Drew ${re.length} cards, deck now has ${ce.length} cards`)}return{...q,deck:ce,hand:re,selectedDeck:L.selectedDeck}}}return q});return{...O,players:W}});try{const O=(ee=Y.current)==null?void 0:ee.getHostPeerId();O&&qt({hostPeerId:O,playerId:h.playerId,playerName:((ie=k.players.find(W=>W.id===h.playerId))==null?void 0:ie.name)||null,isHost:!1})}catch(O){l.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",O)}}break;case"JOIN_ACCEPT":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${h.playerId}, hasState: ${!!((te=h.data)!=null&&te.gameState)}`),(se=h.data)!=null&&se.gameState){const C=h.data.gameState;if(l.info(`[handleWebrtcMessage] Setting game state with ${((J=C.players)==null?void 0:J.length)||0} players`),a(C),h.playerId!==void 0){d(h.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${h.playerId}`);try{const k=(Ie=Y.current)==null?void 0:Ie.getHostPeerId(),O=C.players.find(W=>W.id===h.playerId);k&&qt({hostPeerId:k,playerId:h.playerId,playerName:(O==null?void 0:O.name)||null,isHost:!1})}catch(k){l.warn("[JOIN_ACCEPT] Failed to save guest data:",k)}}}break;case"JOIN_ACCEPT_BINARY":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${h.playerId}`),h.data instanceof Uint8Array)try{const C=ys(h.data),k=C;if(l.info(`[handleWebrtcMessage] Expanded binary state with ${((_e=k.players)==null?void 0:_e.length)||0} players`),a(k),h.playerId!==void 0){d(h.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${h.playerId}`);try{const O=(Ge=Y.current)==null?void 0:Ge.getHostPeerId(),W=k.players.find(q=>q.id===h.playerId);O&&qt({hostPeerId:O,playerId:h.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(O){l.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",O)}}l.info(`[handleWebrtcMessage] Received optimized binary game state: ${h.data.byteLength} bytes`)}catch(C){l.error("[handleWebrtcMessage] Failed to deserialize binary game state:",C)}break;case"STATE_UPDATE_COMPACT":if(j.current){if(h.senderId&&h.senderId!==((le=Y.current)==null?void 0:le.getPeerId())&&(l.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${h.senderId}`),(fe=h.data)!=null&&fe.gameState)){const C=h.data.gameState;a(k=>{const O=h.playerId;if(O===void 0)return l.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),k;const W=k.players.map(H=>{if(H.id===O){const F=C.players.find(z=>z.id===O);if(F){const z=ae=>{const ue=ze(ae.baseId);return ue?{...ue,id:ae.id,baseId:ae.baseId,ownerId:O,power:ae.power,powerModifier:ae.powerModifier,isFaceDown:ae.isFaceDown,statuses:ae.statuses||[]}:{id:ae.id,baseId:ae.baseId,name:"Unknown",power:0}},K=(F.handCards||[]).map(z),re=(F.deckCards||[]).map(z),ce=(F.discardCards||[]).map(z);return l.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${O}: hand=${K.length}, deck=${re.length}, discard=${ce.length}, score=${F.score||0}`),{...H,hand:K,deck:re,discard:ce,handSize:K.length,deckSize:re.length,discardSize:ce.length,score:F.score||H.score}}}else{const F=C.players.find(K=>K.id===H.id);if(!F)return H;if(H.isDummy===!0&&(F.handCards&&F.handCards.length>0||F.deckCards&&F.deckCards.length>0||F.discardCards&&F.discardCards.length>0)){const K=ue=>{const pe=ze(ue.baseId);return pe?{...pe,id:ue.id,baseId:ue.baseId,ownerId:H.id,power:ue.power,powerModifier:ue.powerModifier||0,isFaceDown:ue.isFaceDown||!1,statuses:ue.statuses||[]}:{id:ue.id,baseId:ue.baseId,name:"Unknown",power:0}},re=(F.handCards||[]).map(K),ce=(F.deckCards||[]).map(K),ae=(F.discardCards||[]).map(K);return l.info(`[STATE_UPDATE_COMPACT] Host: Guest ${O} modified dummy player ${H.id}: hand=${re.length}, deck=${ce.length}, discard=${ae.length}`),{...H,hand:re,deck:ce,discard:ae,handSize:re.length,deckSize:ce.length,discardSize:ae.length}}else if(F.handCards&&F.handCards.length>0&&H.hand){const K=F.handCards||[],re=H.hand.map(ce=>{const ae=K.find(ue=>ue.id===ce.id);return ae&&ae.statuses?{...ce,statuses:ae.statuses,isFaceDown:ae.isFaceDown}:ce});return{...H,hand:re,handSize:re.length}}}return H}),q=C.board?C.board.map(H=>H.map(F=>{if(!F||!F.card)return F;const z=ze(F.card.baseId||F.card.id);if(z){const K=F.card.ownerId;return{...F,card:{...z,id:F.card.id,baseId:F.card.baseId||F.card.id,ownerId:K,ownerName:F.card.ownerName,power:F.card.power,powerModifier:F.card.powerModifier,isFaceDown:F.card.isFaceDown||!1,statuses:F.card.statuses||[],enteredThisTurn:F.card.enteredThisTurn,deck:F.card.deck}}}return F})):k.board,L={...k,...C,players:W,board:q};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(L,h.senderId)},0),L})}}else if(!j.current&&((br=h.data)!=null&&br.gameState)){const C=h.data.recipientPlayerId??null,k=h.data.gameState;if(l.info(`[STATE_UPDATE_COMPACT] Received compact state for player ${C}, currentPhase=${k.currentPhase}, activePlayerId=${k.activePlayerId}`),Ne.current){a(O=>(l.info(`[STATE_UPDATE_COMPACT] Skipping - recently restored from localStorage, updating phase from ${O.currentPhase} to ${k.currentPhase}`),{...O,currentPhase:k.currentPhase,activePlayerId:k.activePlayerId,startingPlayerId:k.startingPlayerId,isReadyCheckActive:k.isReadyCheckActive,isGameStarted:k.isGameStarted}));return}a(O=>{const W=C===null||C===E.current;l.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${C}, local=${E.current}, isForLocal=${W}`);const q=k.players.map(z=>{var re,ce;const K=O.players.find(ae=>ae.id===z.id);if(z.id===E.current&&K){const ae=pe=>{if(pe.baseId){const Oe=ze(pe.baseId);if(Oe)return{...Oe,id:pe.id,ownerId:E.current,power:pe.power,powerModifier:pe.powerModifier,isFaceDown:pe.isFaceDown,statuses:pe.statuses||[]}}return K.hand.find(Oe=>Oe.id===pe.id)||K.deck.find(Oe=>Oe.id===pe.id)||K.discard.find(Oe=>Oe.id===pe.id)||{id:pe.id,name:"Unknown",power:0}};if(z.handCards&&z.handCards.length>0||z.deckCards&&z.deckCards.length>0||z.discardCards&&z.discardCards.length>0){const pe=(z.handCards||[]).map(ae),Te=(z.deckCards||[]).map(ae),Oe=(z.discardCards||[]).map(ae);return pe.forEach((ye,Ue)=>{var be,he;(he=(be=z.handCards)==null?void 0:be[Ue])!=null&&he.baseId&&!ye.baseId&&(ye.baseId=z.handCards[Ue].baseId)}),Te.forEach((ye,Ue)=>{var be,he;(he=(be=z.deckCards)==null?void 0:be[Ue])!=null&&he.baseId&&!ye.baseId&&(ye.baseId=z.deckCards[Ue].baseId)}),Oe.forEach((ye,Ue)=>{var be,he;(he=(be=z.discardCards)==null?void 0:be[Ue])!=null&&he.baseId&&!ye.baseId&&(ye.baseId=z.discardCards[Ue].baseId)}),l.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${pe.length} hand, ${Te.length} deck, ${Oe.length} discard`),{...z,hand:pe,deck:Te,discard:Oe}}else{const pe=(z.handIds||[]).map(ye=>K.hand.find(be=>be.id===ye)||K.deck.find(be=>be.id===ye)||K.discard.find(be=>be.id===ye)||{id:ye,name:"?",isPlaceholder:!1}),Te=(z.deckIds||[]).map(ye=>K.deck.find(be=>be.id===ye)||K.hand.find(be=>be.id===ye)||K.discard.find(be=>be.id===ye)||{id:ye,name:"?",isPlaceholder:!1}),Oe=(z.discardIds||[]).map(ye=>K.discard.find(be=>be.id===ye)||K.hand.find(be=>be.id===ye)||K.deck.find(be=>be.id===ye)||{id:ye,name:"?",isPlaceholder:!1});return l.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${pe.length} hand, ${Te.length} deck, ${Oe.length} discard`),{...z,hand:pe,deck:Te,discard:Oe}}}else{const ae=z.deckSize??((re=z.deck)==null?void 0:re.length)??0,ue=z.handSize??((ce=z.hand)==null?void 0:ce.length)??0,pe=z.deckCards&&z.deckCards.length>0;let Te;if(pe){const he=z.deckCards[0];if((he==null?void 0:he.name)&&(he==null?void 0:he.imageUrl))Te=z.deckCards.map(Ce=>({id:Ce.id,baseId:Ce.baseId||Ce.id,name:Ce.name,imageUrl:Ce.imageUrl,fallbackImage:Ce.fallbackImage||"",power:Ce.power,powerModifier:Ce.powerModifier||0,isFaceDown:Ce.isFaceDown??!1,statuses:Ce.statuses||[],deck:Ce.deck||"SynchroTech",color:Ce.color||"Red",ability:Ce.ability||"",bonusPower:Ce.bonusPower||0,isPlaceholder:Ce.isPlaceholder||!1,types:Ce.types||[],faction:Ce.faction||"",ownerId:z.id})),l.debug(`[STATE_UPDATE_COMPACT] Using full deck data for player ${z.id}: ${Te.length} cards`);else{const Ce=We=>{if(We.baseId){const gt=ze(We.baseId);if(gt)return{...gt,id:We.id,baseId:We.baseId,ownerId:z.id,power:We.power,powerModifier:We.powerModifier,isFaceDown:We.isFaceDown,statuses:We.statuses||[]}}return{id:We.id,name:"Unknown",power:0}};if(Te=z.deckCards.map(Ce),z.id===3){const We={};Te.forEach(gt=>{const On=gt.baseId||gt.id;We[On]=(We[On]||0)+1}),l.info(`[STATE_UPDATE_COMPACT] Reconstructed deck for Player 3 (dummy): ${Te.length} cards`,We)}l.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${z.id}: ${Te.length} cards`)}}else if(K&&K.deck.length>0&&K.deck.some(Pe=>!Pe.isPlaceholder)){const Pe=K.deck.length;Te=K.deck.slice(0,ae),z.id===3&&l.info(`[STATE_UPDATE_COMPACT] Player 3 deck slice: before=${Pe}, remoteDeckSize=${ae}, after=${Te.length}`),l.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${z.id}: ${Te.length} cards`)}else{Te=[];for(let Pe=0;Pe<ae;Pe++)Te.push({id:`placeholder_${z.id}_deck_${Pe}`,name:"?",isPlaceholder:!0,ownerId:z.id,deck:z.selectedDeck||"Random",color:z.color})}const Oe=(he,Pe)=>{if(he.baseId&&!he.isPlaceholder&&!he.isCardBack){const Ce=ze(he.baseId);if(Ce)return{...Ce,id:he.id,baseId:he.baseId,ownerId:z.id,power:he.power,powerModifier:he.powerModifier||0,isFaceDown:he.isFaceDown||!1,statuses:he.statuses||[]}}return{id:he.id||`placeholder_${z.id}_hand_${Pe}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:z.id,deck:z.selectedDeck||"Random",color:z.color}};let ye;const Ue=z.handCards&&z.handCards.length>0,be=z.hand&&z.hand.length>0;if(Ue)ye=z.handCards.map(Pe=>{const Ce=ze(Pe.baseId);return Ce?{...Ce,id:Pe.id,baseId:Pe.baseId,ownerId:z.id,power:Pe.power,powerModifier:Pe.powerModifier||0,isFaceDown:Pe.isFaceDown||!1,statuses:Pe.statuses||[]}:{id:Pe.id,baseId:Pe.baseId,name:"Unknown",power:Pe.power||0,ownerId:z.id,isPlaceholder:!1}}),l.info(`[STATE_UPDATE_COMPACT] Reconstructed ${ye.length} hand cards from handCards for player ${z.id}`);else if(be){ye=z.hand.map((Pe,Ce)=>Oe(Pe,Ce));const he=ye.filter(Pe=>!Pe.isPlaceholder).length;he>0&&l.info(`[STATE_UPDATE_COMPACT] Reconstructed ${he}/${ye.length} revealed hand cards for player ${z.id}`)}else{ye=[];for(let he=0;he<ue;he++)ye.push({id:`placeholder_${z.id}_hand_${he}`,name:"?",isPlaceholder:!0,ownerId:z.id,deck:z.selectedDeck||"Random",color:z.color})}return{...z,hand:ye,deck:Te,discard:(K==null?void 0:K.discard)||[]}}}),L=k.board?k.board.map(z=>z.map(K=>{if(!K||!K.card)return K;const re=ze(K.card.baseId||K.card.id);return re?{...K,card:{...re,id:K.card.id,baseId:K.card.baseId||K.card.id,ownerId:K.card.ownerId,ownerName:K.card.ownerName,power:K.card.power,powerModifier:K.card.powerModifier,isFaceDown:K.card.isFaceDown||!1,statuses:K.card.statuses||[],enteredThisTurn:K.card.enteredThisTurn,deck:K.card.deck}}:K})):O.board,H=Le({...k,players:q,board:L}),F={...k,players:q,board:H};return l.info(`[STATE_UPDATE_COMPACT] Merged state: currentPhase=${F.currentPhase}, activePlayerId=${F.activePlayerId}, startingPlayerId=${F.startingPlayerId}`),F})}break;case"STATE_UPDATE":if(j.current&&h.senderId&&h.senderId!==((Ar=Y.current)==null?void 0:Ar.getPeerId())){if(l.info(`[STATE_UPDATE] Host received state from guest ${h.senderId}`),(Sr=h.data)!=null&&Sr.gameState){const C=h.data.gameState;a(k=>{const O=h.playerId;if(O===void 0)return l.warn("[STATE_UPDATE] Guest state missing playerId"),k;const W=k.players.map(H=>{if(H.id===O){const F=C.players.find(z=>z.id===O);if(F){const z=ue=>({...ue,ownerId:O}),K=(F.hand||[]).map(z),re=(F.deck||[]).map(z),ce=(F.discard||[]).map(z);l.info(`[STATE_UPDATE] Merging guest ${O} state: hand=${K.length}, deck=${re.length}, discard=${ce.length}`);const ae={...H,hand:K,deck:re,discard:ce,handSize:K.length,deckSize:re.length,discardSize:ce.length};return l.info(`[STATE_UPDATE] After merge - player ${O}: deckSize=${ae.deckSize}, handSize=${ae.handSize}`),ae}}return H}),q=C.board?C.board.map(H=>H.map(F=>!F||!F.card?F:{...F,card:{...F.card,ownerId:F.card.ownerId}})):k.board,L={...k,players:W,board:q};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(L,h.senderId)},0),L})}break}if(Se.current=!0,(Cr=h.data)!=null&&Cr.gameState){const C=h.data.gameState;if(Ne.current){a(k=>({...k,currentPhase:C.currentPhase,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,isReadyCheckActive:C.isReadyCheckActive,isGameStarted:C.isGameStarted}));return}a(k=>{var q;const O=C.players.map(L=>{var F,z,K;const H=k.players.find(re=>re.id===L.id);if(L.id===E.current&&H){const re=H.hand.every(ae=>ae.isPlaceholder)||H.hand.length===0,ce=L.handSize??((F=L.hand)==null?void 0:F.length)??0;if(re&&L.hand&&L.hand.length>0)return{...L,hand:L.hand,deck:L.deck||H.deck,discard:L.discard||H.discard};{let ae=H.hand,ue=H.deck;if(ce>H.hand.length&&ue.length>0){const pe=ce-H.hand.length,Te=[...H.hand],Oe=[...H.deck];for(let ye=0;ye<pe&&ye<Oe.length;ye++){const Ue=Oe[0];Oe.splice(0,1),Te.push(Ue)}ae=Te,ue=Oe}return{...L,hand:ae,deck:ue,discard:L.discard||H.discard}}}else{if(L.isDummy||!1)return l.info(`[STATE_UPDATE] Using real cards for dummy player ${L.id}`),{...L,hand:L.hand||[],deck:L.deck||[],discard:L.discard||[]};const ce=L.deckSize??((z=L.deck)==null?void 0:z.length)??0,ae=L.handSize??((K=L.hand)==null?void 0:K.length)??0;l.info(`[STATE_UPDATE] Player ${L.id}: deckSize=${ce}, handSize=${ae}`);const ue=[];for(let Te=0;Te<ce;Te++)ue.push({id:`placeholder_${L.id}_deck_${Te}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color});const pe=[];for(let Te=0;Te<ae;Te++)pe.push({id:`placeholder_${L.id}_hand_${Te}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color});return l.info(`[STATE_UPDATE] Created ${ue.length} deck placeholders and ${pe.length} hand placeholders for player ${L.id}`),{...L,hand:pe,deck:ue,discard:L.discard||[]}}}),W={...C,players:O};if(!j.current)try{((q=Y.current)==null?void 0:q.getHostPeerId())&&E.current!==null&&(wt({gameState:W,localPlayerId:E.current,isHost:!1}),l.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(L){l.warn("[STATE_UPDATE] Failed to persist guest state:",L)}return W})}break;case"RECONNECT_SNAPSHOT":if(Se.current=!0,h.data){const C=h.data;a(k=>{const O=E.current,W=C.players.map(L=>{const H=k.players.find(re=>re.id===L.id);if(L.id===O&&H&&H.hand.some(ce=>!ce.isPlaceholder)){let ce=[...H.hand];const ae=[...H.deck];if(L.handSize>ce.length){const ue=L.handSize-ce.length;for(let pe=0;pe<ue&&ae.length>0;pe++)ce.push(ae.shift())}else L.handSize<ce.length&&(ce=ce.slice(0,L.handSize));return{...L,hand:ce,deck:ae,discard:H.discard}}const F=[];for(let re=0;re<L.handSize;re++)F.push({id:`placeholder_${L.id}_hand_${re}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color});const z=[];for(let re=0;re<L.deckSize;re++)z.push({id:`placeholder_${L.id}_deck_${re}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color});const K=[];for(let re=0;re<L.discardSize;re++)K.push({id:`placeholder_${L.id}_discard_${re}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color});return{...L,hand:F,deck:z,discard:K}}),q={gameId:C.gameId,gameMode:C.gameMode,isPrivate:C.isPrivate,isGameStarted:C.isGameStarted,isReadyCheckActive:C.isReadyCheckActive,activeGridSize:C.activeGridSize,currentPhase:C.currentPhase,isScoringStep:C.isScoringStep,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,currentRound:C.currentRound,turnNumber:C.turnNumber,roundWinners:C.roundWinners||{},gameWinner:C.gameWinner,isRoundEndModalOpen:C.isRoundEndModalOpen,dummyPlayerCount:C.dummyPlayerCount,players:W,board:C.board,spectators:k.spectators,hostId:k.hostId,revealRequests:k.revealRequests,preserveDeployAbilities:k.preserveDeployAbilities,highlights:k.highlights,floatingTexts:k.floatingTexts,targetingMode:k.targetingMode,abilityMode:k.abilityMode};if(!j.current&&O!==null)try{wt({gameState:q,localPlayerId:O,isHost:!1}),l.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(L){l.warn("[RECONNECT_SNAPSHOT] Failed to save state:",L)}return l.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${q.currentPhase}, players=${q.players.length}`),q})}break;case"STATE_DELTA":if(j.current||(Se.current=!0),l.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${j.current}, senderId: ${h.senderId}`),(Dr=h.data)!=null&&Dr.delta){const C=h.data.delta;l.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Rr=C.boardCells)==null?void 0:Rr.length)||0}, phaseDelta=${!!C.phaseDelta}`),C.boardCells&&C.boardCells.length>0&&C.boardCells.forEach(k=>{var O,W;l.info(`[STATE_DELTA] Board cell [${k.row},${k.col}]: card=${((O=k.card)==null?void 0:O.name)||"(empty)"}, owner=${(W=k.card)==null?void 0:W.ownerId}`)}),j.current&&h.senderId&&Y.current&&(l.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${h.senderId} to other guests`),Y.current.broadcastStateDelta(C,h.senderId)),C.phaseDelta&&l.info("[STATE_DELTA] phaseDelta:",JSON.stringify(C.phaseDelta)),C.playerDeltas&&Object.entries(C.playerDeltas).forEach(([k,O])=>{l.info(`[STATE_DELTA] Player ${k} delta: handSizeDelta=${O.handSizeDelta}, deckSizeDelta=${O.deckSizeDelta}`)}),a(k=>{const O=E.current||k.localPlayerId;l.info(`[STATE_DELTA] Applying delta with localPlayerId=${O}, currentPhase before=${k.currentPhase}`);const W=er(k);l.info(`[STATE_DELTA] Applying delta with localPlayerId=${O}, currentPhase after=${W.currentPhase}`);try{W.gameId&&O!==null&&(wt({gameState:W,localPlayerId:O,isHost:j.current}),l.debug(`[STATE_DELTA] Saved state for ${j.current?"host":"guest"} auto-restore`))}catch(q){l.warn("[STATE_DELTA] Failed to persist state:",q)}return W})}break;case"STATE_DELTA_BINARY":{j.current||(Se.current=!0),l.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${j.current}, senderId: ${h.senderId}, dataType=${(kr=(Pr=h.data)==null?void 0:Pr.constructor)==null?void 0:kr.name}, typeof=${typeof h.data}`);let C=null;if(h.data instanceof Uint8Array)try{C=sa(h.data),C&&l.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Or=C.boardCells)==null?void 0:Or.length)||0}`)}catch(k){l.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",k)}else if(typeof h.data=="string")try{C=ms(h.data),C&&l.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${h.data.length} chars): playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((vr=C.boardCells)==null?void 0:vr.length)||0}, phaseDelta=${!!C.phaseDelta}`)}catch(k){l.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",k)}else l.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof h.data}, constructor: ${(Mr=(Nr=h.data)==null?void 0:Nr.constructor)==null?void 0:Mr.name}`);C&&(j.current&&h.senderId&&Y.current&&(l.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${h.senderId} to other guests`),Y.current.broadcastStateDelta(C,h.senderId)),a(k=>{const O=E.current||k.localPlayerId;l.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${O}, currentPhase before=${k.currentPhase}`);const W=er(k);l.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${W.currentPhase}, board has ${W.board.flat().filter(q=>q==null?void 0:q.card).length} cards`);try{W.gameId&&O!==null&&(wt({gameState:W,localPlayerId:O,isHost:j.current}),l.debug(`[STATE_DELTA_BINARY] Saved state for ${j.current?"host":"guest"} auto-restore`))}catch(q){l.warn("[STATE_DELTA_BINARY] Failed to persist state:",q)}return W}));break}case"CARD_STATE":if(typeof h.data=="string")try{const C=atob(h.data),k=new Uint8Array(C.length);for(let O=0;O<C.length;O++)k[O]=C.charCodeAt(O);a(O=>pt(2,k,O,E.current||O.localPlayerId).gameState)}catch(C){l.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",C)}else h.data instanceof Uint8Array&&a(C=>pt(2,h.data,C,E.current||C.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof h.data=="string")try{const C=atob(h.data),k=new Uint8Array(C.length);for(let O=0;O<C.length;O++)k[O]=C.charCodeAt(O);a(O=>{const{gameState:W}=pt(3,k,O,E.current||O.localPlayerId);return W})}catch(C){l.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",C)}else h.data instanceof Uint8Array&&a(C=>{const{gameState:k}=pt(3,h.data,C,E.current||C.localPlayerId);return k});break;case"SESSION_EVENT":if(typeof h.data=="string")try{const C=atob(h.data),k=new Uint8Array(C.length);for(let O=0;O<C.length;O++)k[O]=C.charCodeAt(O);a(O=>pt(4,k,O,E.current||O.localPlayerId).gameState)}catch(C){l.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",C)}else h.data instanceof Uint8Array&&a(C=>pt(4,h.data,C,E.current||C.localPlayerId).gameState);break;case"JOIN_REQUEST":l.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${h.senderId}, isHost: ${j.current}`),j.current&&h.senderId?(l.info(`Host received JOIN_REQUEST from ${h.senderId}, data:`,h.data),Aa(h.senderId,h.data)):l.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${j.current}, senderId: ${h.senderId}`);break;case"ACTION":if(j.current&&h.data){const{actionType:C,actionData:k}=h.data;if(C==="STATE_UPDATE"&&(k!=null&&k.gameState)){if(Ne.current){Y.current&&h.senderId&&Y.current.sendToGuest(h.senderId,{type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:c.current},timestamp:Date.now()});break}a(O=>{const W=k.gameState,q=W.players.map(H=>{const F=O.players.find(z=>z.id===H.id);return F&&H.id!==E.current?{...H,deck:F.deck||H.deck,discard:F.discard||H.discard,score:F.score}:H}),L={...W,players:q};return Y.current&&Y.current.broadcastToGuests({type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:L},timestamp:Date.now()}),L})}else if(C==="STATE_DELTA"&&(k!=null&&k.delta))a(O=>{const W=k.delta;let q=W;Ne.current&&W.playerDeltas&&(q={...W,playerDeltas:Object.fromEntries(Object.entries(W.playerDeltas).map(([H,F])=>{const z={...F};return delete z.scoreDelta,[H,z]}))}),E.current||O.localPlayerId;const L=er(O);return Y.current&&Y.current.broadcastStateDelta(q),L});else if(C==="NEXT_PHASE")a(O=>{const W=O,q=W.currentPhase,L=q===2&&!W.isScoringStep,H=q+1;return{...W,currentPhase:H,...L&&{isScoringStep:!0}}});else if(C==="PREV_PHASE")a(O=>{const W=O;return W.isScoringStep?{...W,isScoringStep:!1,currentPhase:Math.max(1,W.currentPhase-1)}:{...W,currentPhase:Math.max(1,W.currentPhase-1)}});else if(C==="SET_PHASE"&&(k==null?void 0:k.phaseIndex)!==void 0)a(O=>({...O,currentPhase:k.phaseIndex}));else if(C==="UPDATE_PLAYER_NAME"&&(k==null?void 0:k.playerId)!==void 0&&(k==null?void 0:k.name)!==void 0)a(O=>({...O,players:O.players.map(W=>W.id===k.playerId?{...W,name:k.name}:W)}));else if(C==="CHANGE_PLAYER_COLOR"&&(k==null?void 0:k.playerId)!==void 0&&(k==null?void 0:k.color)!==void 0){const O=k.playerId,W=k.color;a(q=>{const L={...q,players:q.players.map(H=>H.id===O?{...H,color:W}:H)};return Y.current&&Y.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:Y.current.getPeerId(),data:{playerId:O,color:W},timestamp:Date.now()}),L})}else if(C==="UPDATE_PLAYER_SCORE"&&(k==null?void 0:k.playerId)!==void 0&&(k==null?void 0:k.delta)!==void 0){const O=k.playerId,W=k.delta;a(q=>{const L={...q,players:q.players.map(H=>H.id===O?{...H,score:Math.max(0,H.score+W)}:H)};return Y.current&&Y.current.broadcastToGuests({type:"UPDATE_PLAYER_SCORE",senderId:Y.current.getPeerId(),data:{playerId:O,delta:W},timestamp:Date.now()}),L})}else if(C==="CHANGE_PLAYER_DECK"&&(k==null?void 0:k.playerId)!==void 0){const O=k.playerId,W=k.deckType,q=k.deck;a(L=>{const H=L.players.find(K=>K.id===O);if(!H)return L;let F;q&&q.length>0?(l.info(`[CHANGE_PLAYER_DECK] Host received ${q.length} cards for player ${O}`),F=q.map(K=>{if(K.baseId){const re=ze(K.baseId);if(re)return{...re,id:K.id,baseId:K.baseId,deck:W,ownerId:O,ownerName:H.name,power:K.power,powerModifier:K.powerModifier||0,isFaceDown:K.isFaceDown||!1,statuses:K.statuses||[]}}return{id:K.id,baseId:K.id,name:"Unknown",deck:W,ownerId:O,ownerName:H.name,power:K.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(F=et(W,O,H.name),l.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${O} with ${F.length} cards from ${W}`));const z={...L,players:L.players.map(K=>K.id===O?{...K,selectedDeck:W,deck:F,hand:[],discard:[],announcedCard:null,boardHistory:[]}:K)};if(Y.current){const K=F.map(re=>({id:re.id,baseId:re.baseId,power:re.power,powerModifier:re.powerModifier||0,isFaceDown:re.isFaceDown||!1,statuses:re.statuses||[]}));Y.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:O,data:{playerId:O,deckType:W,deck:K,deckSize:K.length},timestamp:Date.now()})}return z})}else if(C==="TOGGLE_ACTIVE_PLAYER"&&(k==null?void 0:k.playerId)!==void 0)a(O=>{if(!O.players.find(L=>L.id===k.playerId))return O;const q=da(O,k.playerId);return Y.current&&Y.current.broadcastGameState(q),q});else if(C==="TOGGLE_AUTO_DRAW"&&(k==null?void 0:k.playerId)!==void 0)a(O=>({...O,players:O.players.map(W=>W.id===k.playerId?{...W,autoDrawEnabled:!W.autoDrawEnabled}:W)}));else if(C==="START_NEXT_ROUND")a(O=>({...O,isRoundEndModalOpen:!1,currentRound:(O.currentRound||1)+1,players:O.players.map(W=>({...W,score:0}))}));else if(C==="RESET_DEPLOY_STATUS")a(O=>{const W=O.board.map(q=>q.map(L=>{var H;return(H=L.card)!=null&&H.statuses?{...L,card:{...L.card,statuses:L.card.statuses.filter(F=>F.type!=="DeployAbilityUsed")}}:L}));return{...O,board:W,preserveDeployAbilities:!1}});else if(C==="DECK_DATA_UPDATE"&&(k==null?void 0:k.playerId)!==void 0&&(k!=null&&k.deck)){const O=k.playerId,W=k.deck,q=k.deckSize;l.info(`[ACTION] DECK_DATA_UPDATE: Received ${W.length} cards for guest ${O}`),a(L=>({...L,players:L.players.map(H=>H.id===O?{...H,deck:[...W],deckSize:q||W.length}:H)}))}else l.warn(`[ACTION] Unknown action type: ${C}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(l.info(`[PLAYER_RECONNECT] Guest ${h.playerId} reconnecting from ${h.senderId}`),j.current&&h.playerId!==void 0&&h.senderId){const C=c.current;if(l.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(C!=null&&C.gameId)}, gameId=${C==null?void 0:C.gameId}, hasPlayers=${((Lr=C==null?void 0:C.players)==null?void 0:Lr.length)||0}`),C&&C.gameId){l.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${h.playerId}`);const k=Ps(C,h.playerId);(Gr=Y.current)==null||Gr.sendToGuest(h.senderId,{type:"RECONNECT_SNAPSHOT",senderId:Y.current.getPeerId(),data:k.data,timestamp:Date.now()}),l.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${h.playerId}`)}else l.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((xr=h.data)==null?void 0:xr.isReadyCheckActive)!==void 0||((Ur=h.data)==null?void 0:Ur.isPrivate)!==void 0)&&a(C=>({...C,isReadyCheckActive:h.data.isReadyCheckActive??!0,isPrivate:h.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":(($r=h.data)==null?void 0:$r.isReadyCheckActive)!==void 0&&a(C=>({...C,isReadyCheckActive:h.data.isReadyCheckActive}));break;case"PLAYER_READY":j.current&&h.playerId!==void 0?a(C=>{const k=C.players.map(L=>L.id===h.playerId?{...L,isReady:!0}:L),O={...C,players:k};l.info(`Player ${h.playerId} is ready via WebRTC`),Y.current&&(Y.current.broadcastGameState(O),l.info(`[PLAYER_READY] Broadcasted ready status for player ${h.playerId}`));const W=O.players.filter(L=>!L.isDummy&&!L.isDisconnected);if(W.length>0&&W.every(L=>L.isReady)&&!O.isGameStarted){const L=O.players.filter(K=>!K.isDisconnected),H=Math.floor(Math.random()*L.length),F=L[H].id;let z={...O};return z.isReadyCheckActive=!1,z.isGameStarted=!0,z.startingPlayerId=F,z.activePlayerId=F,z.currentPhase=0,z.players=z.players.map(K=>{if(K.hand.length===0&&K.deck.length>0){const ce=[...K.hand],ae=[...K.deck];for(let ue=0;ue<6&&ue<ae.length;ue++){const pe=ae[0];ae.splice(0,1),ce.push(pe)}return l.info(`[PLAYER_READY] Drew ${ce.length} cards for player ${K.id}`),{...K,hand:ce,deck:ae}}return K}),z=pr(z,F),l.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${z.currentPhase}`),Y.current&&(Y.current.broadcastToGuests({type:"GAME_START",senderId:Y.current.getPeerId(),data:{startingPlayerId:F,activePlayerId:F,currentPhase:z.currentPhase,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{l.info(`[PLAYER_READY] Sending ACTIVE_PLAYER_CHANGED after game start: activePlayerId=${F}, currentPhase=${z.currentPhase}`),Y.current&&Y.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:Y.current.getPeerId(),data:{activePlayerId:z.activePlayerId,currentPhase:z.currentPhase,turnNumber:z.turnNumber},timestamp:Date.now()})},100)),z}return O}):j.current;break;case"ASSIGN_TEAMS":(Hr=h.data)!=null&&Hr.assignments&&a(C=>{const k=C.players.map(O=>{let W=O.teamId||1;for(const[q,L]of Object.entries(h.data.assignments))if(L.includes(O.id)){W=parseInt(q);break}return{...O,teamId:W}});return{...C,players:k}});break;case"SET_GAME_MODE":((Fr=h.data)==null?void 0:Fr.mode)!==void 0&&a(C=>({...C,gameMode:h.data.mode}));break;case"SET_GAME_PRIVACY":((Wr=h.data)==null?void 0:Wr.isPrivate)!==void 0&&a(C=>({...C,isPrivate:h.data.isPrivate}));break;case"SET_GRID_SIZE":((Br=h.data)==null?void 0:Br.size)!==void 0&&a(C=>{const k=h.data.size,O=[];for(let W=0;W<k;W++){const q=[];for(let L=0;L<k;L++)q.push({card:null});O.push(q)}return{...C,activeGridSize:k,board:O}});break;case"SET_DUMMY_PLAYER_COUNT":((Yr=h.data)==null?void 0:Yr.count)!==void 0&&a(C=>({...C,dummyPlayerCount:h.data.count}));break;case"HOST_READY":h.playerId!==void 0&&(l.info(`[handleWebrtcMessage] Host (player ${h.playerId}) is ready`),a(C=>{const k=C.players.map(O=>O.id===h.playerId?{...O,isReady:!0}:O);return{...C,players:k}}));break;case"GAME_START":Se.current=!0,l.info("[handleWebrtcMessage] Game starting!",h.data),l.info(`[GAME_START] Received data: startingPlayerId=${(zr=h.data)==null?void 0:zr.startingPlayerId}, activePlayerId=${(Kr=h.data)==null?void 0:Kr.activePlayerId}, currentPhase=${(qr=h.data)==null?void 0:qr.currentPhase}, isGameStarted=${(Vr=h.data)==null?void 0:Vr.isGameStarted}`),c.current&&(l.info(`[GAME_START] Current phase before: ${c.current.currentPhase}`),c.current.players.forEach(C=>{l.info(`[GAME_START] Before: Player ${C.id} - deck: ${C.deck.length}, hand: ${C.hand.length}`)})),h.data&&a(C=>{l.info(`[GAME_START] Processing for localPlayerId=${E.current}`),C.players.forEach(q=>{l.info(`[GAME_START] Player ${q.id} before: deck=${q.deck.length}, hand=${q.hand.length}`)});const k=h.data.startingPlayerId??h.data.activePlayerId,O={...C,isGameStarted:h.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:k,activePlayerId:h.data.activePlayerId,currentPhase:h.data.currentPhase??C.currentPhase},W=O.players.find(q=>q.id===E.current);if(W&&W.hand.length===0&&W.deck.length>0){const L=[...W.hand],H=[...W.deck];for(let F=0;F<6&&F<H.length;F++){const z=H[0];H.splice(0,1),L.push(z)}O.players=O.players.map(F=>F.id===E.current?{...F,hand:L,deck:H}:F),l.info(`[GAME_START] Drew ${L.length} cards for local player ${E.current}, deck now has ${H.length} cards`)}return O.players.forEach(q=>{l.info(`[GAME_START] Player ${q.id} after: deck=${q.deck.length}, hand=${q.hand.length}`)}),l.info(`[GAME_START] Final state: currentPhase=${O.currentPhase}, activePlayerId=${O.activePlayerId}, startingPlayerId=${O.startingPlayerId}`),O});break;case"ACTIVE_PLAYER_CHANGED":l.info("[handleWebrtcMessage] Active player changed!",h.data),h.data&&a(C=>{const k={...C,activePlayerId:h.data.activePlayerId};if(h.data.currentPhase!==void 0&&(k.currentPhase=h.data.currentPhase),h.data.turnNumber!==void 0&&(k.turnNumber=h.data.turnNumber),k.currentPhase===0&&k.activePlayerId===E.current){const O=k.players.find(W=>W.id===E.current);if(O&&O.deck.length>0){const W=O.deck[0],q=[...O.deck.slice(1)],L=[...O.hand,W];k.players=k.players.map(H=>H.id===E.current?{...H,deck:q,hand:L}:H)}k.currentPhase=1,ar(k,k.activePlayerId)}return k.activePlayerId&&k.activePlayerId!==C.activePlayerId&&ar(k,k.activePlayerId),k});break;case"SYNC_DECK_SELECTIONS":l.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",h.data),h.data&&a(C=>h.data.playerId!==void 0&&h.data.selectedDeck!==void 0?h.data.playerId===E.current?(l.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${h.data.playerId}`),C):{...C,players:C.players.map(k=>k.id===h.data.playerId?{...k,selectedDeck:h.data.selectedDeck}:k)}:h.data.deckSelections&&Array.isArray(h.data.deckSelections)?{...C,players:C.players.map(k=>{if(k.id===E.current)return k;const O=h.data.deckSelections.find(W=>W.id===k.id);return O?{...k,selectedDeck:O.selectedDeck}:k})}:C);break;case"CHANGE_PLAYER_DECK":if(l.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",h.data),!h.data||h.data.playerId===void 0)break;{const C=h.data.playerId,k=h.data.deckType,O=h.data.deck;a(W=>{const q=W.players.find(F=>F.id===C);if(!q)return W;const L=j.current;let H;if(O&&O.length>0)if(H=O.map(F=>{if(F.baseId){const z=ze(F.baseId);return z?{...z,id:F.id,baseId:F.baseId,deck:k,ownerId:C,ownerName:q.name,power:F.power,powerModifier:F.powerModifier||0,isFaceDown:F.isFaceDown||!1,statuses:F.statuses||[]}:(l.warn(`[CHANGE_PLAYER_DECK] Card definition not found for baseId: ${F.baseId}, id: ${F.id}`),{id:F.id,baseId:F.baseId,name:"Unknown",deck:k,ownerId:C,ownerName:q.name,power:F.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""})}return l.warn(`[CHANGE_PLAYER_DECK] Card without baseId: ${F.id}`),{id:F.id,baseId:F.id,name:"Unknown",deck:k,ownerId:C,ownerName:q.name,power:F.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}),k==="Optimates"||k==="Command"){const F={};H.forEach(z=>{const K=z.baseId||z.id;F[K]=(F[K]||0)+1}),l.info(`[CHANGE_PLAYER_DECK] Reconstructed ${k} deck for player ${C}:`,{totalCards:H.length,cardCounts:F})}else l.info(`[CHANGE_PLAYER_DECK] Reconstructed deck for player ${C} from host data: ${H.length} cards`);else if(!L)H=et(k,C,q.name),l.warn(`[CHANGE_PLAYER_DECK] No deck data from host, creating locally for player ${C} from ${k}`);else return W;return{...W,players:W.players.map(F=>F.id===C?{...F,selectedDeck:k,deck:H,hand:[],discard:[],announcedCard:null,boardHistory:[]}:F)}})}break;case"GAME_RESET":a(C=>{const k=h.data.activeGridSize||8,O=[];for(let L=0;L<k;L++){const H=[];for(let F=0;F<k;F++)H.push({card:null});O.push(H)}const W=(h.data.players||[]).map(L=>{if(L.isDummy&&L.hand&&L.deck&&L.discard)return{...L,boardHistory:[]};{const H=L.selectedDeck||"SynchroTech";return{...L,hand:[],deck:et(H,L.id,L.name),discard:[],boardHistory:[]}}}),q={...C,players:W,gameMode:h.data.gameMode,isPrivate:h.data.isPrivate,activeGridSize:h.data.activeGridSize,dummyPlayerCount:h.data.dummyPlayerCount,autoAbilitiesEnabled:h.data.autoAbilitiesEnabled,isGameStarted:h.data.isGameStarted,currentPhase:h.data.currentPhase,currentRound:h.data.currentRound,turnNumber:h.data.turnNumber,activePlayerId:h.data.activePlayerId,startingPlayerId:h.data.startingPlayerId,roundWinners:h.data.roundWinners||{},gameWinner:h.data.gameWinner,isRoundEndModalOpen:h.data.isRoundEndModalOpen,isReadyCheckActive:h.data.isReadyCheckActive,board:O,targetingMode:null,floatingTexts:[]};return c.current=q,q});break;case"ABILITY_MODE_SET":(jr=h.data)!=null&&jr.abilityMode&&(a(C=>({...C,abilityMode:h.data.abilityMode})),l.info("[AbilityMode] Received ability mode from host",{playerId:h.data.abilityMode.playerId,mode:h.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":l.info("[Ability] Target selected",h.data);break;case"ABILITY_COMPLETED":a(C=>({...C,abilityMode:void 0})),l.info("[Ability] Ability completed",h.data);break;case"ABILITY_CANCELLED":a(C=>({...C,abilityMode:void 0}));break;case"CHANGE_PLAYER_COLOR":if(l.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",h.data),!h.data||h.data.playerId===void 0)break;{const C=h.data.playerId,k=h.data.color;if(C===E.current)break;a(O=>({...O,players:O.players.map(W=>W.id===C?{...W,color:k}:W)}))}break;case"UPDATE_PLAYER_SCORE":if(l.info("[UPDATE_PLAYER_SCORE] Received score update broadcast",h.data),!h.data||h.data.playerId===void 0)break;{const C=h.data.playerId,k=h.data.delta;if(C===E.current)break;a(O=>({...O,players:O.players.map(W=>W.id===C?{...W,score:Math.max(0,W.score+k)}:W)}))}break;case"TRIGGER_HIGHLIGHT":if((Jr=h.data)!=null&&Jr.highlightData){const C=h.data.highlightData;S(C),j.current&&Y.current&&h.senderId&&Y.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:h.senderId,data:C,timestamp:Date.now()},h.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(h.data){const C=(Xr=Y.current)==null?void 0:Xr.getPeerId();h.senderId!==C&&S(h.data)}break;case"TRIGGER_FLOATING_TEXT":if((Zr=h.data)!=null&&Zr.textData){const C=h.data.textData;a(k=>({...k,floatingTexts:[...k.floatingTexts,C].filter(O=>Date.now()-O.timestamp<oe.FLOATING_TEXT_DURATION)})),j.current&&Y.current&&h.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:h.senderId,data:C,timestamp:Date.now()},h.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((Qr=h.data)!=null&&Qr.batch){const C=h.data.batch;a(k=>({...k,floatingTexts:[...k.floatingTexts,...C].filter(O=>Date.now()-O.timestamp<oe.FLOATING_TEXT_DURATION)})),j.current&&Y.current&&h.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:h.senderId,data:{batch:C},timestamp:Date.now()},h.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const C=(en=Y.current)==null?void 0:en.getPeerId();(tn=h.data)!=null&&tn.batch&&h.senderId!==C?a(k=>({...k,floatingTexts:[...k.floatingTexts,...h.data.batch].filter(O=>Date.now()-O.timestamp<oe.FLOATING_TEXT_DURATION)})):(rn=h.data)!=null&&rn.textData&&h.senderId!==C&&a(k=>({...k,floatingTexts:[...k.floatingTexts,h.data.textData].filter(O=>Date.now()-O.timestamp<oe.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((nn=h.data)!=null&&nn.coords){const C=h.data.coords,k=h.data.timestamp;f({coords:C,timestamp:k}),j.current&&Y.current&&h.senderId&&Y.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:h.senderId,data:{coords:C,timestamp:k},timestamp:Date.now()},h.senderId)}break;case"NO_TARGET_TRIGGERED":if((an=h.data)!=null&&an.coords){const C=(on=Y.current)==null?void 0:on.getPeerId();h.senderId!==C&&f({coords:h.data.coords,timestamp:h.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(h.data){const C=h.data;D(k=>[...k,C]),setTimeout(()=>{D(k=>k.filter(O=>O.timestamp!==C.timestamp))},1e3),j.current&&Y.current&&h.senderId&&Y.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:h.senderId,data:C,timestamp:Date.now()},h.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(h.data){const C=h.data;R(k=>[...k,C]),setTimeout(()=>{R(k=>k.filter(O=>O.timestamp!==C.timestamp))},1e3),j.current&&Y.current&&h.senderId&&Y.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:h.senderId,data:C,timestamp:Date.now()},h.senderId)}break;case"TRIGGER_CLICK_WAVE":if(h.data){const C=h.data;G(k=>[...k,C]),setTimeout(()=>{G(k=>k.filter(O=>O.timestamp!==C.timestamp))},600),j.current&&Y.current&&h.senderId&&Y.current.broadcastToGuests({type:"CLICK_WAVE_TRIGGERED",senderId:h.senderId,data:C,timestamp:Date.now()},h.senderId)}break;case"CLICK_WAVE_TRIGGERED":h.data&&h.senderId!==((sn=Y.current)==null?void 0:sn.getPeerId())&&(G(C=>[...C,h.data]),setTimeout(()=>{G(C=>C.filter(k=>k.timestamp!==h.data.timestamp))},600));break;case"DECK_SELECTION_TRIGGERED":h.data&&h.senderId!==((dn=Y.current)==null?void 0:dn.getPeerId())&&(D(C=>[...C,h.data]),setTimeout(()=>{D(C=>C.filter(k=>k.timestamp!==h.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":h.data&&h.senderId!==((cn=Y.current)==null?void 0:cn.getPeerId())&&(R(C=>[...C,h.data]),setTimeout(()=>{R(C=>C.filter(k=>k.timestamp!==h.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((ln=h.data)!=null&&ln.targetingMode){const C=h.data.targetingMode;l.info("[TargetingMode] Received SET_TARGETING_MODE via WebRTC",{playerId:C.playerId,mode:C.action.mode,boardTargetsCount:((un=C.boardTargets)==null?void 0:un.length)||0,handTargetsCount:((fn=C.handTargets)==null?void 0:fn.length)||0,isDeckSelectable:C.isDeckSelectable||!1,timestamp:C.timestamp,isHost:j.current}),a(k=>({...k,targetingMode:C})),c.current.targetingMode=C,j.current&&Y.current&&Y.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((yn=(pn=Y.current).getPeerId)==null?void 0:yn.call(pn))??void 0,data:{targetingMode:C},timestamp:Date.now()})}break;case"CLEAR_TARGETING_MODE":l.info("[TargetingMode] Received CLEAR_TARGETING_MODE via WebRTC",{isHost:j.current}),a(C=>({...C,targetingMode:null})),c.current.targetingMode=null,j.current&&Y.current&&Y.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((mn=(hn=Y.current).getPeerId)==null?void 0:mn.call(hn))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()});break;case"RECONNECT_ACCEPT":if((In=h.data)!=null&&In.gameState){const C=h.data.gameState;a(C),P("Connected"),l.info(`[Reconnection] State restored with ${((En=C.players)==null?void 0:En.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(k){l.warn("[Reconnection] Failed to clear stored data:",k)}}break;case"RECONNECT_REJECT":{const C=((Tn=h.data)==null?void 0:Tn.reason)||"unknown";l.warn(`[Reconnection] Reconnection rejected: ${C}`),P("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((gn=h.data)==null?void 0:gn.playerId)!==void 0&&(l.info(`[Reconnection] Player ${h.data.playerId} disconnected, reconnection window open`),a(C=>({...C,players:C.players.map(k=>k.id===h.data.playerId?{...k,isDisconnected:!0}:k)})));break;case"PLAYER_RECONNECTED":((wn=h.data)==null?void 0:wn.playerId)!==void 0&&(l.info(`[Reconnection] Player ${h.data.playerId} reconnected`),a(C=>({...C,players:C.players.map(k=>k.id===h.data.playerId?{...k,isDisconnected:!1}:k)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((_n=h.data)==null?void 0:_n.playerId)!==void 0&&(l.info(`[Reconnection] Player ${h.data.playerId} converted to dummy`),a(C=>({...C,players:C.players.map(k=>k.id===h.data.playerId?{...k,isDummy:!0,isDisconnected:!0}:k)})));break;case"REQUEST_DECK_VIEW":if(j.current&&((bn=h.data)==null?void 0:bn.targetPlayerId)!==void 0){const C=h.data.targetPlayerId;h.playerId;const k=n.players.find(O=>O.id===C);if(k&&Y.current){let O=[];if(C===E.current||k.isDummy)l.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${k.deck.length} cards, first card: ${(An=k.deck[0])==null?void 0:An.name}`),O=k.deck.map(L=>({id:L.id,baseId:L.baseId,name:L.name,imageUrl:L.imageUrl,power:L.power,powerModifier:L.powerModifier||0,isFaceDown:L.isFaceDown??!1,statuses:L.statuses||[],ownerId:L.ownerId,deck:L.deck,ability:L.ability,color:L.color,types:L.types,faction:L.faction}));else{const L=Ve.current.get(C);L&&L.length>0?(l.info(`[REQUEST_DECK_VIEW] Using stored full deck data for guest ${C}, ${L.length} cards, first card: ${(Sn=L[0])==null?void 0:Sn.name}`),O=L):(l.info(`[REQUEST_DECK_VIEW] No stored full deck for guest ${C}, using gameState deck, ${k.deck.length} cards`),O=k.deck.map(H=>({id:H.id,baseId:H.baseId,name:H.name,imageUrl:H.imageUrl,power:H.power,powerModifier:H.powerModifier||0,isFaceDown:H.isFaceDown??!1,statuses:H.statuses||[],ownerId:H.ownerId,deck:H.deck,ability:H.ability,color:H.color,types:H.types,faction:H.faction})))}const W={targetPlayerId:C,deckCards:O,deckSize:O.length},q={type:"DECK_VIEW_DATA",senderId:Y.current.getPeerId(),data:W,timestamp:Date.now()};Y.current.sendToGuest(h.senderId||"",q),l.info(`[REQUEST_DECK_VIEW] Sent ${W.deckCards.length} cards for player ${C}, first card: ${(Cn=W.deckCards[0])==null?void 0:Cn.name}`)}}break;case"DECK_VIEW_DATA":if(((Dn=h.data)==null?void 0:Dn.targetPlayerId)!==void 0&&((Rn=h.data)!=null&&Rn.deckCards)){const C=h.data.targetPlayerId,k=h.data.deckCards;l.info(`[DECK_VIEW_DATA] Received ${k.length} deck cards for player ${C}`);const O=k[0],W=(O==null?void 0:O.name)&&(O==null?void 0:O.imageUrl);let q;if(W)l.info(`[DECK_VIEW_DATA] Received full card data, using directly. First card: ${O.name}`),q=k.map(L=>({id:L.id,baseId:L.baseId||L.id,name:L.name,imageUrl:L.imageUrl,fallbackImage:L.fallbackImage||"",power:L.power,powerModifier:L.powerModifier||0,isFaceDown:L.isFaceDown??!1,statuses:L.statuses||[],deck:L.deck||Re.SynchroTech,color:L.color||"Red",ability:L.ability||"",bonusPower:L.bonusPower||0,isPlaceholder:L.isPlaceholder||!1,types:L.types||[],faction:L.faction||"",ownerId:L.ownerId||C}));else{const L=H=>{if(H.baseId){const z=ze(H.baseId);if(z)return{...z,id:H.id,baseId:H.baseId,deck:H.deck||Re.SynchroTech,ownerId:C,power:H.power,powerModifier:H.powerModifier,isFaceDown:H.isFaceDown,statuses:H.statuses||[]};l.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${H.baseId}`)}else l.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${H.id}`);return{id:H.id,baseId:H.baseId||H.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:H.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:Re.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}};q=k.map(L)}a(L=>({...L,players:L.players.map(H=>H.id===C?{...H,deck:q}:H)}))}break;case"DECK_DATA_UPDATE":if(j.current&&h.playerId!==void 0&&((Pn=h.data)!=null&&Pn.deck)){const C=h.playerId,k=h.data.deck,O=h.data.deckSize;l.info(`[DECK_DATA_UPDATE] Received ${k.length} cards for guest ${C}, deckSize=${O}, first card: ${(kn=k[0])==null?void 0:kn.name}`);const W=k.map(q=>({...q,ownerId:q.ownerId??C}));Ve.current.set(C,W),a(q=>({...q,players:q.players.map(L=>L.id===C?{...L,deck:W,deckSize:O}:L)}))}break;case"REQUEST_DECK_DATA":if(!j.current&&Y.current){const C=n.players.find(k=>k.id===E.current);if(C&&C.deck.length>0){l.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${C.deck.length} cards`);const k=C.deck.map(O=>({id:O.id,baseId:O.baseId,ownerId:O.ownerId??E.current,power:O.power,powerModifier:O.powerModifier||0,isFaceDown:O.isFaceDown||!1,statuses:O.statuses||[]}));Y.current.sendAction("DECK_DATA_UPDATE",{playerId:E.current,deck:k,deckSize:k.length})}}break;default:l.warn(`[handleWebrtcMessage] Unknown message type: ${h.type}`,h);break}},[de,et,gr,n,i]),Ca=U.useCallback(h=>{if(!Y.current||Ae)return;Me(!0),P("Connecting");const ne=3e4,Q=1e3;let ee=0;const ie=ne/Q;try{const se={hostPeerId:h,playerId:i,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(se))}catch(se){l.error("[Reconnection] Failed to store data:",se)}const te=async()=>{ee++;const se=Math.max(0,ne-ee*Q);if(Ee({attempt:ee,maxAttempts:ie,timeRemaining:se}),se<=0){l.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Me(!1),Ee(null),rt();return}let J=h;if(n!=null&&n.gameId){const Ie=Vt(n.gameId);if(Ie&&Ie.peerId!==h){J=Ie.peerId;try{const _e={hostPeerId:J,playerId:i,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(_e))}catch(_e){l.error("[Reconnection] Failed to update reconnection data:",_e)}}}try{const Ie=i||E.current;Ie!==null?(l.info(`[Reconnection] Reconnecting as existing player ${Ie} to host ${J}`),await Y.current.initializeAsReconnectingGuest(J,Ie)):(l.info("[Reconnection] No playerId, connecting as new player"),await Y.current.initializeAsGuest(J)),l.info("[Reconnection] Successfully reconnected!"),Me(!1),Ee(null)}catch(Ie){l.warn("[Reconnection] Reconnection attempt failed:",Ie),setTimeout(te,Q)}};te()},[Ae,n,i]),He=U.useCallback(h=>{a(ne=>{if(!ne)return l.error("[updateState] prevState is undefined, skipping update"),ne;const Q=typeof h=="function"?h(ne):h;if(!Q)return l.error("[updateState] newState is undefined, skipping update"),ne;const ee=!ne.gameId&&Q.gameId;if(!Se.current&&!ee)return Q;if(B&&Y.current){if(j.current){if(Y.current.broadcastGameState(Q),l.info(`[updateState] Host broadcast state: phase=${Q.currentPhase}, activePlayer=${Q.activePlayerId}`),Q.gameId&&E.current!==null)try{wt({gameState:Q,localPlayerId:E.current,isHost:!0}),l.debug("[updateState] Saved game state for host auto-restore")}catch(ie){l.warn("[updateState] Failed to save game state:",ie)}}else Y.current&&(Y.current.sendStateToHost(Q,E.current),l.info(`[updateState] Guest sent state to host: phase=${Q.currentPhase}, activePlayer=${Q.activePlayerId}`));return Q}if(De.current&&De.current.readyState===WebSocket.OPEN){const ie={type:"UPDATE_STATE",gameState:Q};ct.current&&(ie.playerToken=ct.current),De.current.send(JSON.stringify(ie))}return Q})},[B,de,gr]),Da=U.useCallback(()=>{const{initialState:h}=Tt.createGame();He(h)},[Tt,He]),Ra=U.useCallback(()=>{Tt.exitGame(qe,j,Ln,rt)},[Tt,qe,j,Ln,rt]),Pa=Gs({ws:De,webrtcManager:Y,gameStateRef:c,webrtcIsHostRef:j,setGameState:a,updateState:He}),ka=xs({ws:De,webrtcManager:Y,gameStateRef:c,localPlayerIdRef:E,webrtcIsHostRef:j,setGameState:a}),Oa=Us({updateState:He,sendWebrtcAction:vt,webrtcIsHostRef:j,webrtcManagerRef:Y}),va=$s({updateState:He}),Na=Hs({localPlayerIdRef:E,updateState:He}),{addBoardCardStatus:Ma,removeBoardCardStatus:La,removeBoardCardStatusByOwner:Ga,modifyBoardCardPower:xa,addAnnouncedCardStatus:Ua,removeAnnouncedCardStatus:$a,modifyAnnouncedCardPower:Ha,addHandCardStatus:Fa,removeHandCardStatus:Wa,revealHandCard:Ba,revealBoardCard:Ya,requestCardReveal:za,respondToRevealRequest:Ka,removeRevealedStatus:qa}=Na,Va=Fs({webrtcIsHostRef:j,sendWebrtcAction:vt,webrtcManagerRef:Y,localPlayerIdRef:E,getCardDefinition:ze,commandCardIds:Bo,createDeck:et,updateState:He}),{changePlayerDeck:ja,loadCustomDeck:Ja,resurrectDiscardedCard:Xa,reorderTopDeck:Za,reorderCards:Qa,recoverDiscardedCard:eo}=Va,to=Ws({ws:De,webrtcManagerRef:Y,webrtcIsHostRef:j,gameStateRef:c,scoreDeltaAccumulator:Qe,setGameState:a,updateState:He,abilityMode:e,setAbilityMode:r,createDeck:et}),{toggleActivePlayer:ro,toggleAutoDraw:no,setPhase:ao,nextPhase:oo,prevPhase:so,closeRoundEndModal:io,closeRoundEndModalOnly:co,resetGame:lo}=to;U.useEffect(()=>{tt.current=!1;const h=sessionStorage.getItem("invite_game_id"),ne=sessionStorage.getItem("invite_host_id");if(h&&!ne)return Ir(),()=>{tt.current=!0,ut.current&&clearTimeout(ut.current),De.current&&(De.current.onclose=null,De.current.close())};if(h&&ne)return()=>{tt.current=!0,ut.current&&clearTimeout(ut.current),De.current&&(De.current.onclose=null,De.current.close())};const Q=performance.getEntriesByType("navigation"),ee=Q.length>0?Q[0]:null,ie=(ee==null?void 0:ee.type)??0,te=Ns();return te&&(l.info(`Restoring saved game state (nav type: ${ie}):`,te.gameState.gameId),a(te.gameState),d(te.localPlayerId),c.current=te.gameState,E.current=te.localPlayerId,ct.current=te.playerToken),Ir(),()=>{tt.current=!0,ut.current&&clearTimeout(ut.current),De.current&&(De.current.onclose=null,De.current.close())}},[]),U.useEffect(()=>{if(Ke&&c.current&&c.current.gameId){const h=Ot(c.current);h!==c.current&&(a(h),c.current=h)}},[]),U.useEffect(()=>{if(M)return;const h=setInterval(()=>{if(Ke&&c.current&&c.current.gameId){const ne=Ot(c.current);a({...ne}),c.current=ne,$(!0),clearInterval(h)}},100);return()=>clearInterval(h)},[M]);const{startReadyCheck:uo,cancelReadyCheck:fo,playerReady:po}=ka,{updatePlayerName:yo,changePlayerColor:ho}=Oa,{drawCard:mo,drawCardsBatch:Io,shufflePlayerDeck:Eo,flipBoardCard:To,flipBoardCardFaceDown:go}=va,{assignTeams:wo,setGameMode:_o,setGamePrivacy:bo,setActiveGridSize:Ao,setDummyPlayerCount:So}=Pa,Co=U.useCallback(()=>{var h;if(((h=De.current)==null?void 0:h.readyState)===WebSocket.OPEN&&c.current.gameId&&E.current===1){De.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Ke}));const ne=c.current,Q=me(ne);Q.players.forEach(ee=>{if(["hand","deck","discard"].forEach(te=>{ee[te]&&(ee[te]=ee[te].map(se=>{const J=zt(se.name);return J?{...se,...J}:se}))}),ee.announcedCard){const te=zt(ee.announcedCard.name);te&&(ee.announcedCard={...ee.announcedCard,...te})}}),Q.board.forEach(ee=>{ee.forEach(ie=>{if(ie.card){const te=zt(ie.card.name);te&&(ie.card={...ie.card,...te})}})}),De.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:Q})),a(Q)}},[]),Bt=U.useCallback((h,ne)=>{var ie;const Q=c.current;if(!Q.isGameStarted){l.warn("[ScoreUpdate] Blocked: game not started");return}if(Q.isRoundEndModalOpen){l.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(ne===0)return;const ee=ve();if(ee?He(te=>({...te,players:te.players.map(se=>se.id===h?{...se,score:Math.max(0,(se.score||0)+ne)}:se)})):a(te=>({...te,players:te.players.map(se=>se.id===h?{...se,score:Math.max(0,(se.score||0)+ne)}:se)})),!ee){if(((ie=De.current)==null?void 0:ie.readyState)!==WebSocket.OPEN){l.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const te=Qe.get(h);if(te){clearTimeout(te.timerId);const se=te.delta+ne,J=setTimeout(()=>{var _e;const Ie=Qe.get(h);Ie&&((_e=De.current)==null?void 0:_e.readyState)===WebSocket.OPEN&&(l.info(`[ScoreUpdate] Sending accumulated delta: player=${h}, delta=${Ie.delta}`),De.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:c.current.gameId,playerId:h,delta:Ie.delta}))),Qe.delete(h)},500);Qe.set(h,{delta:se,timerId:J})}else{const se=setTimeout(()=>{var Ie;const J=Qe.get(h);J&&((Ie=De.current)==null?void 0:Ie.readyState)===WebSocket.OPEN&&(l.info(`[ScoreUpdate] Sending delta: player=${h}, delta=${J.delta}`),De.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:c.current.gameId,playerId:h,delta:J.delta}))),Qe.delete(h)},500);Qe.set(h,{delta:ne,timerId:se})}}},[a,He]),Do=Ks({ws:De,webrtcManager:Y,gameStateRef:c,webrtcIsHostRef:j,setGameState:a}),{setTargetingMode:Ro,clearTargetingMode:wr}=Do,Po=Bs({ws:De,gameStateRef:c,updateState:He,updatePlayerScore:Bt,triggerFloatingText:Tr,clearTargetingMode:wr}),{scoreLine:ko,scoreDiagonal:Oo}=Po,Ze=Ys({updateState:He,rawJsonData:Ke}),vo=zs({updateState:He,localPlayerIdRef:E,updatePlayerScore:Bt}),{moveItem:_r}=vo;return{gameState:n,localPlayerId:i,setLocalPlayerId:d,draggedItem:g,setDraggedItem:A,connectionStatus:y,gamesList:T,latestHighlight:m,latestFloatingTexts:_,latestNoTarget:u,latestDeckSelections:w,latestHandCardSelections:v,joinAsInvite:ya,startReadyCheck:uo,cancelReadyCheck:fo,playerReady:po,assignTeams:wo,setGameMode:_o,setGamePrivacy:bo,setActiveGridSize:Ao,setDummyPlayerCount:So,updatePlayerName:yo,changePlayerColor:ho,updatePlayerScore:Bt,changePlayerDeck:ja,loadCustomDeck:Ja,drawCard:mo,drawCardsBatch:Io,shufflePlayerDeck:Eo,moveItem:_r,handleDrop:_r,addBoardCardStatus:Ma,removeBoardCardStatus:La,removeBoardCardStatusByOwner:Ga,modifyBoardCardPower:xa,addAnnouncedCardStatus:Ua,removeAnnouncedCardStatus:$a,modifyAnnouncedCardPower:Ha,addHandCardStatus:Fa,removeHandCardStatus:Wa,flipBoardCard:To,flipBoardCardFaceDown:go,revealHandCard:Ba,revealBoardCard:Ya,requestCardReveal:za,respondToRevealRequest:Ka,syncGame:Co,removeRevealedStatus:qa,toggleActivePlayer:ro,toggleAutoDraw:no,triggerHighlight:Ia,triggerFloatingText:Tr,triggerNoTarget:Ea,triggerDeckSelection:Ta,triggerHandCardSelection:ga,triggerClickWave:_a,clickWaves:b,syncValidTargets:wa,setTargetingMode:Ro,clearTargetingMode:wr,nextPhase:oo,prevPhase:so,setPhase:ao,markAbilityUsed:Ze.markAbilityUsed,applyGlobalEffect:Ze.applyGlobalEffect,swapCards:Ze.swapCards,transferStatus:Ze.transferStatus,transferAllCounters:Ze.transferAllCounters,spawnToken:Ze.spawnToken,resetDeployStatus:Ze.resetDeployStatus,removeStatusByType:Ze.removeStatusByType,recoverDiscardedCard:eo,resurrectDiscardedCard:Xa,scoreLine:ko,closeRoundEndModal:io,closeRoundEndModalOnly:co,resetGame:lo,scoreDiagonal:Oo,reorderTopDeck:Za,reorderCards:Qa,updateState:He,requestDeckView:Nt,sendFullDeckToHost:fa,createGame:Da,joinGame:Er,joinGameViaModal:Er,exitGame:Ra,requestGamesList:ha,forceReconnect:pa,webrtcHostId:X,webrtcIsHost:de,initializeWebrtcHost:mr,connectAsGuest:Xe,sendWebrtcAction:vt,isReconnecting:Ae,reconnectProgress:we}};function Wn(t,e,r){const{gameState:n,localPlayerId:a,abilityMode:s,cursorStack:o,handleActionExecution:i,markAbilityUsed:d}=r;if(s||o||!n.isGameStarted||a===null)return null;const c=n.players.find(A=>A.id===t.ownerId),E=a===t.ownerId||(c==null?void 0:c.isDummy);if(n.activePlayerId!==t.ownerId||!E||!Jn(t,n)||!jn(t,n.currentPhase,n.activePlayerId,n))return null;const g=Jo(t,n,t.ownerId,e);if(g){g.readyStatusToRemove&&d(e,!!g.isDeployAbility,!1,g.readyStatusToRemove);const A={...g,chainedAction:g.chainedAction?{...g.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};return i(A,e),A}return null}function ed(t){const e=it[t],r=(e==null?void 0:e.allowedTargets)||[];return{allowedTargets:r,allowHand:r.includes("hand"),allowBoard:r.includes("board"),allowBoardFaceDown:r.includes("board-facedown"),allowDeck:r.includes("deck"),allowDiscard:r.includes("discard")}}function hr(t,e,r,n){const a={type:t,count:r?r.count+1:1,isDragging:!0,originalOwnerId:e,sourceCoords:r==null?void 0:r.sourceCoords},s={};return t==="Revealed"&&(s.excludeOwnerId=e,s.onlyFaceDown=!0),{...a,...s,...n,...r&&{chainedAction:r.chainedAction,isDeployAbility:r.isDeployAbility,readyStatusToRemove:r.readyStatusToRemove}}}function je(t,e){var n;const r=(n=t.sourceCard)==null?void 0:n.ownerId;return typeof r=="number"?r:typeof e=="number"?e:0}function Js(t,e,r){var E;const{gameState:n,localPlayerId:a,commandContext:s,triggerNoTarget:o,onAbilityComplete:i,handleActionExecution:d}=r;if(t.type==="ABILITY_COMPLETE"){i==null||i();return}if(t.type==="REVEREND_SETUP_SCORE"){Xs(t,e,r);return}if(t.type==="GLOBAL_AUTO_APPLY"){Zs(t,e,r);return}if(!Pt(t,n,((E=t.sourceCard)==null?void 0:E.ownerId)||a,s)){o(e),t.chainedAction&&!t.skipChainedActionOnNoTargets&&setTimeout(()=>{d(t.chainedAction,e)},500);return}if(t.type==="CREATE_STACK"){Qs(t,e,r);return}if(t.type==="OPEN_MODAL"){ei(t,e,r);return}if(t.type==="ENTER_MODE"){ti(t,e,r);return}l.warn("[handleActionExecution] Unknown action type:",t.type)}function Xs(t,e,r){var c,E;const{gameState:n,updatePlayerScore:a,triggerFloatingText:s,markAbilityUsed:o}=r,i=((c=t.sourceCard)==null?void 0:c.ownerId)??0;let d=0;for(let g=0;g<n.board.length;g++)for(let A=0;A<n.board[g].length;A++){const y=(E=n.board[g][A])==null?void 0:E.card;if(y!=null&&y.statuses){const P=y.statuses.filter(T=>T.type==="Exploit"&&T.addedByPlayerId===i);d+=P.length}}d>0&&a(i,d),s([{row:e.row,col:e.col,text:`+${d}`,playerId:i}]),o(e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function Zs(t,e,r){var P,T,p,m,S,_;const{gameState:n,localPlayerId:a,commandContext:s,markAbilityUsed:o,triggerNoTarget:i,triggerFloatingText:d,updatePlayerScore:c,applyGlobalEffect:E,addBoardCardStatus:g,removeStatusByType:A,handleActionExecution:y}=r;if(((P=t.payload)==null?void 0:P.customAction)==="FINN_SCORING"){const I=(T=t.sourceCard)==null?void 0:T.ownerId;if(I===void 0){l.warn("[FINN_SCORING] Source card missing ownerId"),o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}let u=0;if(n.players.forEach(f=>{f.id!==I&&f.hand.forEach(w=>{var D;(D=w.statuses)!=null&&D.some(v=>v.type==="Revealed"&&v.addedByPlayerId===I)&&u++})}),n.board.forEach(f=>{f.forEach(w=>{var v;const D=w.card;if(D&&D.ownerId!==I){const R=((v=D.statuses)==null?void 0:v.filter(b=>b.type==="Revealed"&&b.addedByPlayerId===I).length)||0;u+=R}})}),u>0){const f=t.sourceCoords||e;d({row:f.row,col:f.col,text:`+${u}`,playerId:I}),c(I,u)}o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}if(((p=t.payload)==null?void 0:p.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){t.sourceCoords&&t.sourceCoords.row>=0?A(t.sourceCoords,"Aim"):s.lastMovedCardCoords&&A(s.lastMovedCardCoords,"Aim");return}if((m=t.payload)!=null&&m.tokenType&&t.payload.filter){const{tokenType:I,filter:u}=t.payload,f=[],w=n.board.length;for(let D=0;D<w;D++)for(let v=0;v<w;v++){const R=n.board[D][v].card;R&&u(R,D,v)&&f.push({row:D,col:v})}if(f.length===0){i(t.sourceCoords||e),t.chainedAction&&setTimeout(()=>y(t.chainedAction,e),500),o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}f.forEach(D=>{var v;g(D,I,((v=t.sourceCard)==null?void 0:v.ownerId)||0)}),o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove),t.chainedAction&&setTimeout(()=>y(t.chainedAction,e),oe.MODE_CLEAR_DELAY);return}if((S=t.payload)!=null&&S.contextReward){Bn(t,e,r);return}if(t.payload&&!t.payload.cleanupCommand){const{tokenType:I,filter:u}=t.payload,f=[],w=n.board.length;if(t.payload.contextReward&&t.sourceCard){Bn(t,e,r);return}if(u)for(let D=0;D<w;D++)for(let v=0;v<w;v++){const R=n.board[D][v].card;R&&u(R)&&f.push({row:D,col:v})}else t.sourceCoords&&t.sourceCoords.row>=0?f.push(t.sourceCoords):e&&e.row>=0?f.push(e):s.lastMovedCardCoords&&f.push(s.lastMovedCardCoords);if(f.length>0){if(I){const D=t.payload.count||1,v=t.payload.ownerId!==void 0?t.payload.ownerId:((_=t.sourceCard)==null?void 0:_.ownerId)??a??0;for(let R=0;R<D;R++)E(e,f,I,v,!!t.isDeployAbility)}}else i(e),o(e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}}function Qs(t,e,r){var c,E;const{gameState:n,setAbilityMode:a,setCursorStack:s,triggerNoTarget:o,localPlayerId:i}=r;let d=t.count||0;if(t.dynamicCount){const{factor:g,ownerId:A}=t.dynamicCount;let y=0;n.board.forEach(P=>{P.forEach(T=>{var p;if((p=T.card)!=null&&p.statuses){const m=T.card.statuses.filter(S=>S.type===g&&S.addedByPlayerId===A);y+=m.length}})}),d=y}if(d>0){a(null);let g=((c=t.sourceCard)==null?void 0:c.ownerId)??i??0;!((E=t.sourceCard)!=null&&E.ownerId)&&i!==null&&(g=i);const A={count:d,sourceCoords:t.sourceCoords||e,sourceCard:t.sourceCard,isDeployAbility:t.isDeployAbility,readyStatusToRemove:t.readyStatusToRemove,targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,requiredTargetStatus:t.requiredTargetStatus,requireStatusFromSourceOwner:t.requireStatusFromSourceOwner,mustBeAdjacentToSource:t.mustBeAdjacentToSource,mustBeInLineWithSource:t.mustBeInLineWithSource,maxDistanceFromSource:t.maxDistanceFromSource,maxOrthogonalDistance:t.maxOrthogonalDistance,placeAllAtOnce:t.placeAllAtOnce,replaceStatus:t.replaceStatus,chainedAction:t.chainedAction,recordContext:t.recordContext};s(hr(t.tokenType||"Aim",g,null,A))}else o(e)}function ei(t,e,r){var c,E;const{gameState:n,localPlayerId:a,commandContext:s,setViewingDiscard:o,markAbilityUsed:i}=r;if(!Pt(t,n,((c=t.sourceCard)==null?void 0:c.ownerId)||a,s)){i(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}if(t.mode==="RETRIEVE_DEVICE"){const g=n.players.find(A=>{var y;return A.id===((y=t.sourceCard)==null?void 0:y.ownerId)});g&&(o({player:g,pickConfig:{filterType:"Device",action:"recover"}}),e.row>=0&&i(e,!!t.isDeployAbility,!1,t.readyStatusToRemove))}else if(t.mode==="IMMUNIS_RETRIEVE"){const g=n.players.find(A=>{var y;return A.id===((y=t.sourceCard)==null?void 0:y.ownerId)});g&&o({player:g,pickConfig:{filterType:"Optimates",action:"resurrect"}})}else if(t.mode==="SEARCH_DECK"){const g=n.players.find(A=>{var y;return A.id===((y=t.sourceCard)==null?void 0:y.ownerId)});g&&(o({player:g,pickConfig:{filterType:((E=t.payload)==null?void 0:E.filterType)||"Unit",action:"recover",isDeck:!0}}),e.row>=0&&i(e,!!t.isDeployAbility,!1,t.readyStatusToRemove))}i(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function ti(t,e,r){var y,P;const{gameState:n,localPlayerId:a,commandContext:s,triggerNoTarget:o,setAbilityMode:i,markAbilityUsed:d,addBoardCardStatus:c,setTargetingMode:E,handleActionExecution:g}=r,A=t.mode;if(A==="SHIELD_SELF_THEN_RIOT_PUSH"){const T=t.sourceCard.ownerId;if(c(e,"Shield",T),!Pt(t,n,T,s)){o(e),d(e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),E(t,je(t,a),e,void 0,s);return}if(A==="SHIELD_SELF_THEN_SPAWN"){const T=je(t,a);c(e,"Shield",T),i({...t,payload:{...t.payload,shieldApplied:!0}}),E(t,T,e);return}if(A==="PRINCEPS_SHIELD_THEN_AIM"){const T=je(t,a);c(e,"Shield",T);const p={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};g(p,e);return}if(A==="GAWAIN_DEPLOY_SHIELD_AIM"){const T=t.sourceCard.ownerId;c(e,"Shield",T);const p={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};g(p,e);return}if(A==="ABR_DEPLOY_SHIELD_AIM"){const T=t.sourceCard.ownerId;c(e,"Shield",T);const p={type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};g(p,e);return}if(A==="RIOT_PUSH"){if(t.isDeployAbility){i(t),E(t,je(t,a),e);return}if(!Pt(t,n,((y=t.sourceCard)==null?void 0:y.ownerId)||a,s)){o(t.sourceCoords||e),d(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),E(t,je(t,a),e);return}if(A==="PATROL_MOVE"){i(t),E(t,je(t,a),e);return}if(A==="SELECT_TARGET"){if(t.isDeployAbility){i(t),E(t,je(t,a),e,void 0,s);return}if(!Pt(t,n,((P=t.sourceCard)==null?void 0:P.ownerId)||a,s)){o(t.sourceCoords||e),d(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}i(t),E(t,je(t,a),e,void 0,s);return}i(t),E(t,je(t,a),e)}function Bn(t,e,r){var m,S,_,I,u,f,w;const{gameState:n,commandContext:a,updatePlayerScore:s,triggerFloatingText:o,drawCardsBatch:i,removeBoardCardStatus:d,addBoardCardStatus:c,modifyBoardCardPower:E,markAbilityUsed:g}=r,A=(m=t.payload)==null?void 0:m.contextReward,y=a.lastMovedCardCoords||e;if(!y||y.row<0)return;let P=n.board[y.row][y.col].card;const T=((S=t.payload)==null?void 0:S._tempContextId)||a.lastMovedCardId;if((!P||T&&P.id!==T)&&T)for(let D=0;D<n.board.length;D++){for(let v=0;v<n.board[D].length;v++)if(((_=n.board[D][v].card)==null?void 0:_.id)===T){P=n.board[D][v].card;break}if(P)break}if(!P){l.warn("[ContextReward] No card at coords");return}const p=Math.max(0,P.power+(P.powerModifier||0)+(P.bonusPower||0));A==="DRAW_MOVED_POWER"||A==="DRAW_EQUAL_POWER"?i(((I=t.sourceCard)==null?void 0:I.ownerId)||0,p):A==="SCORE_MOVED_POWER"?(o({row:y.row,col:y.col,text:`+${p}`,playerId:((u=t.sourceCard)==null?void 0:u.ownerId)||0}),s(((f=t.sourceCard)==null?void 0:f.ownerId)||0,p)):A==="STUN_MOVED_UNIT"?c(y,"Stun",((w=t.sourceCard)==null?void 0:w.ownerId)||0):A==="REMOVE_AIM"?d(y,"Aim"):A==="WEAKEN"&&E(y,-1),g(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function ri(t,e){var f;const{gameState:r,localPlayerId:n,abilityMode:a,setAbilityMode:s,cursorStack:o,commandContext:i,setCommandContext:d,playMode:c,draggedItem:E,interactionLock:g,handleActionExecution:A,handleDrop:y,moveItem:P,markAbilityUsed:T,spawnToken:p,resurrectDiscardedCard:m,updatePlayerScore:S,triggerFloatingText:_,handleLineSelection:I}=e;if(g.current)return!1;const u=r.board.length;if(E)return t.row>=0&&t.row<u&&t.col>=0&&t.col<r.board[t.row].length?(y(E,{location:"board",row:t.row,col:t.col}),!0):!1;if(o&&o.isDragging){if(st({location:"board",row:t.row,col:t.col},{...o.targetOwnerId!==void 0&&{targetOwnerId:o.targetOwnerId},...o.excludeOwnerId!==void 0&&{excludeOwnerId:o.excludeOwnerId},onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.targetType&&{targetType:o.targetType},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},...o.requireStatusFromSourceOwner!==void 0&&{requireStatusFromSourceOwner:o.requireStatusFromSourceOwner},...o.mustBeAdjacentToSource&&o.sourceCoords&&{mustBeAdjacentTo:o.sourceCoords},...o.mustBeInLineWithSource&&o.sourceCoords&&{mustBeInLineWith:o.sourceCoords},...o.maxDistanceFromSource!==void 0&&{maxDistance:o.maxDistanceFromSource},...o.range&&{range:o.range}},n??0,r.players)){let D=null;if(o.sourceCoords){const{row:v,col:R}=o.sourceCoords;v>=0&&v<u&&R>=0&&R<r.board[v].length&&(D=r.board[v][R].card)}if(D)return A({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:o.type,count:o.count,targetOwnerId:o.targetOwnerId,onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.range&&{range:o.range},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},cleanupCommand:!0},sourceCard:D,sourceCoords:o.sourceCoords},t),!0}return!1}if(a&&a.mode==="SPAWN_TOKEN"){const{sourceCoords:w,payload:D,sourceCard:v,isDeployAbility:R,readyStatusToRemove:b}=a;if(!w||!(D!=null&&D.tokenName)||!(Math.abs(t.row-w.row)+Math.abs(t.col-w.col)===1))return!1;const x=(v==null?void 0:v.ownerId)??((f=a.sourceCard)==null?void 0:f.ownerId);return p(t,D.tokenName,x),T(w,R,!1,b),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="SELECT_CELL"){const{sourceCoords:w,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R,payload:b}=a,G=(()=>{var M;if(w&&w.row>=0)return w;if(!D)return null;for(let $=0;$<r.board.length;$++)for(let B=0;B<r.board.length;B++)if(((M=r.board[$][B].card)==null?void 0:M.id)===D.id)return{row:$,col:B};return null})();if(!G||!D)return!1;let x=!1;if((b==null?void 0:b.range)==="line")x=t.row===G.row||t.col===G.col;else if((b==null?void 0:b.range)==="global")x=!0;else if((b==null?void 0:b.range)===2){const M=Math.abs(t.row-G.row)+Math.abs(t.col-G.col);if(M===1)x=!0;else if(M===2){const $=G.row,B=G.col,V=t.row,X=t.col;x=[{r:V,c:B},{r:$,c:X},{r:($+V)/2,c:(B+X)/2}].some(de=>{if(!Number.isInteger(de.r)||!Number.isInteger(de.c))return!1;const ge=Math.floor((r.board.length-r.activeGridSize)/2),j=ge,Ae=ge+r.activeGridSize-1;return de.r<j||de.r>Ae||de.c<j||de.c>Ae||Math.abs(de.r-$)+Math.abs(de.c-B)!==1?!1:!r.board[de.r][de.c].card})}}else b!=null&&b.filter?x=b.filter(null,t.row,t.col):x=Math.abs(t.row-G.row)+Math.abs(t.col-G.col)===1;if(!x)return!1;if(b!=null&&b.moveFromHand&&i.selectedHandCard){const{playerId:M,cardIndex:$}=i.selectedHandCard,B=r.players.find(X=>X.id===M),V=B==null?void 0:B.hand[$];if(V)return P({card:V,source:"hand",playerId:M,cardIndex:$,isManual:!0},{target:"board",boardCoords:t}),T(w||t,v,!1,R),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0}if(!((b==null?void 0:b.allowSelf)&&t.row===G.row&&t.col===G.col)){const M=r.board[G.row][G.col].card;M&&P({card:M,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"board",boardCoords:t})}if(b!=null&&b.recordContext&&d({lastMovedCardCoords:t,lastMovedCardId:D.id}),T(w||t,v,!1,R),b!=null&&b.chainedAction){const M={...b.chainedAction};M.targetOwnerId===-2&&(M.targetOwnerId=D.ownerId),b.recordContext&&(M.payload||(M.payload={}),M.payload._tempContextId=D.id),s(null),setTimeout(()=>{A(M,t)},oe.MODE_CLEAR_DELAY)}else setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY);return!0}if(a&&a.mode==="PATROL_MOVE"){const{sourceCoords:w,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R}=a;if(!w||!D)return!1;if(t.row===w.row&&t.col===w.col)return T(w,v,!1,R),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0;const b=t.row===w.row,G=t.col===w.col;return!b&&!G||r.board[t.row][t.col].card!==null?!1:(P({card:D,source:"board",boardCoords:w},{target:"board",boardCoords:t}),T(t,v,!1,R),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0)}if(a&&a.mode==="RIOT_MOVE"){const{sourceCoords:w,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R,payload:b}=a;return!w||!D||!(b!=null&&b.vacatedCoords)?!1:t.row===b.vacatedCoords.row&&t.col===b.vacatedCoords.col?(P({card:D,source:"board",boardCoords:w},{target:"board",boardCoords:t}),T(t,v,!1,R),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0):(T(w,v,!1,R),s(null),!0)}if(a&&a.mode==="IMMUNIS_RETRIEVE"){const{sourceCoords:w,payload:D,isDeployAbility:v,readyStatusToRemove:R,sourceCard:b}=a;if(!w||!(Math.abs(t.row-w.row)+Math.abs(t.col-w.col)===1))return!1;if((D==null?void 0:D.selectedCardIndex)!==void 0){const x=(b==null?void 0:b.ownerId)||0;return m(x,D.selectedCardIndex,t),T(w,v,!1,R),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0}return!1}if(a&&a.mode==="INTEGRATOR_LINE_SELECT"){const{sourceCoords:w,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R}=a;if(!w||w.row<0)return!1;const b=t.row===w.row,G=t.col===w.col;if(!b&&!G)return!1;const x=(D==null?void 0:D.ownerId)||0;let N=0;if(b)for(let M=0;M<u;M++){const $=r.board[t.row][M].card;$!=null&&$.statuses&&(N+=$.statuses.filter(B=>B.type==="Exploit"&&B.addedByPlayerId===x).length)}else for(let M=0;M<u;M++){const $=r.board[M][t.col].card;M!==w.row&&$!=null&&$.statuses&&(N+=$.statuses.filter(B=>B.type==="Exploit"&&B.addedByPlayerId===x).length)}return N>0&&(S(x,N),_({row:w.row,col:w.col,text:`+${N}`,playerId:x})),T(w,v,!1,R),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="IP_AGENT_THREAT_SCORING"){const{sourceCoords:w,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R}=a;if(!w)return!1;const b=t.row===w.row,G=t.col===w.col;if(!b&&!G)return!1;const x=(D==null?void 0:D.ownerId)||0;let N=0;if(b)for(let $=0;$<u;$++){const B=r.board[t.row][$].card;B!=null&&B.statuses&&(N+=B.statuses.filter(V=>V.type==="Threat"&&V.addedByPlayerId===x).length)}else for(let $=0;$<u;$++){const B=r.board[$][t.col].card;$!==w.row&&B!=null&&B.statuses&&(N+=B.statuses.filter(V=>V.type==="Threat"&&V.addedByPlayerId===x).length)}const M=N*2;return M>0&&(S(x,M),_({row:w.row,col:w.col,text:`+${M}`,playerId:x})),T(w,v,!1,R),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="ZIUS_LINE_SELECT"){const{sourceCoords:w,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R}=a,b=i.lastMovedCardCoords||w;if(!b)return!1;const G=t.row===b.row,x=t.col===b.col;if(!G&&!x)return!1;const N=(D==null?void 0:D.ownerId)||0;let M=0;const $=[];if(G)for(let B=0;B<u;B++){const V=r.board[t.row][B].card;if(V!=null&&V.statuses){const X=V.statuses.filter(Z=>Z.type==="Exploit"&&Z.addedByPlayerId===N);M+=X.length,X.length>0&&$.push({row:t.row,col:B})}}else for(let B=0;B<u;B++){const V=r.board[B][t.col].card;if(B!==b.row&&V!=null&&V.statuses){const X=V.statuses.filter(Z=>Z.type==="Exploit"&&Z.addedByPlayerId===N);M+=X.length,X.length>0&&$.push({row:B,col:t.col})}}return M>0&&(S(N,M),$.forEach(B=>{_({row:B.row,col:B.col,text:"+1",playerId:N})})),T(w||b,v,!1,R),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0}return a!=null&&a.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","SELECT_LINE_START","SELECT_DIAGONAL"].includes(a.mode)?(I(t),!0):c!=null&&c.card&&c.sourceCoords?(y({card:c.card,source:"hand",playerId:c.playerId,cardIndex:c.cardIndex},{location:"board",row:t.row,col:t.col}),!0):!1}function ni(t,e,r,n){var S;const{gameState:a,localPlayerId:s,abilityMode:o,cursorStack:i,interactionLock:d,setCommandContext:c,setAbilityMode:E,moveItem:g,markAbilityUsed:A,handleActionExecution:y,triggerHandCardSelection:P,setCursorStack:T,clearTargetingMode:p,clearValidTargets:m}=n;if(!d.current){if(i){if(["Aim","Exploit","Stun","Shield"].includes(i.type))return;const I={targetOwnerId:i.targetOwnerId,excludeOwnerId:i.excludeOwnerId,onlyOpponents:i.onlyOpponents||i.targetOwnerId===-1,onlyFaceDown:i.onlyFaceDown,targetType:i.targetType,requiredTargetStatus:i.requiredTargetStatus,tokenType:i.type};if(st({card:e,ownerId:t.id,location:"hand"},I,a.activePlayerId,a.players)&&i.type==="Revealed"){const f=((S=i.sourceCard)==null?void 0:S.ownerId)??a.activePlayerId??s??1;e.statuses||(e.statuses=[]),e.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===f)||(e.statuses.push({type:"Revealed",addedByPlayerId:f}),g({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:t.id,cardIndex:r}),i.sourceCoords&&i.sourceCoords.row>=0&&A(i.sourceCoords,i.isDeployAbility,!1,i.readyStatusToRemove),i.count>1?T(D=>D?{...D,count:D.count-1}:null):(p(),m==null||m(),i.chainedAction&&y(i.chainedAction,i.sourceCoords||{row:-1,col:-1}),T(null)))}return}if((o==null?void 0:o.type)==="ENTER_MODE"&&o.mode==="SELECT_TARGET"){const{payload:_,sourceCoords:I,isDeployAbility:u,sourceCard:f,readyStatusToRemove:w}=o;if(P(t.id,r,a.activePlayerId??s??1),_.actionType==="SELECT_HAND_FOR_DEPLOY"){if(_.filter&&!_.filter(e))return;c(D=>({...D,selectedHandCard:{playerId:t.id,cardIndex:r}})),E({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,payload:{range:"global",moveFromHand:!0}});return}if(_.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(_.filter&&!_.filter(e)||t.id!==(f==null?void 0:f.ownerId))return;g({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),p(),m==null||m();const D={type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:f,sourceCoords:I,isDeployAbility:u,payload:{tokenName:_.tokenName}};E(D),I&&I.row>=0&&setTimeout(()=>{y(D,I)},0);return}if(_.actionType==="LUCIUS_SETUP"){if(t.id!==(f==null?void 0:f.ownerId))return;g({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),y({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:f,sourceCoords:I,isDeployAbility:u,payload:{filterType:"Command"}},I||{row:-1,col:-1}),E(null);return}if(_.actionType==="DESTROY"){if(_.filter&&!_.filter(e))return;g({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),I&&I.row>=0&&A(I,u,!1,w),setTimeout(()=>E(null),oe.MODE_CLEAR_DELAY)}}}}function ai(t,e,r){const{abilityMode:n,cursorStack:a,interactionLock:s,gameState:o,activateAbility:i}=r;n||a||s.current||o.isGameStarted&&o.activePlayerId===t.id&&qo(e,"setup",o.currentPhase)&&i(e,{row:-1,col:-1})}function oi(t,e){var u,f,w,D,v;const{gameState:r,localPlayerId:n,abilityMode:a,interactionLock:s,setAbilityMode:o,markAbilityUsed:i,updatePlayerScore:d,triggerFloatingText:c,nextPhase:E,modifyBoardCardPower:g,scoreLine:A,scoreDiagonal:y,commandContext:P}=e;if(!a)return!1;const{mode:T,sourceCard:p,sourceCoords:m,payload:S,isDeployAbility:_,readyStatusToRemove:I}=a;if(T==="SCORE_LAST_PLAYED_LINE"&&a.sourceCoords){if(s.current)return!0;const{row:R,col:b}=a.sourceCoords,{row:G,col:x}=t;if(R!==G&&b!==x)return!0;s.current=!0;const N=r.activePlayerId,M=r.board.length;let $=R,B=R,V=b,X=b;if(R===G)$=R,B=R,V=0,X=M-1;else if(b===x)V=x,X=x,$=0,B=M-1;else return s.current=!1,!0;const Z=r.board.some(j=>j.some(Ae=>{var Me,we;return((Me=Ae.card)==null?void 0:Me.ownerId)===N&&Ae.card.name.toLowerCase().includes("data liberator")&&((we=Ae.card.statuses)==null?void 0:we.some(Ee=>Ee.type==="Support"))}));let de=0;const ge=[];for(let j=$;j<=B;j++)for(let Ae=V;Ae<=X;Ae++){const we=r.board[j][Ae].card;if(we&&!((u=we.statuses)!=null&&u.some(Ee=>Ee.type==="Stun"))){const Ee=we.ownerId===N,Ne=(f=we.statuses)==null?void 0:f.some($e=>$e.type==="Exploit"&&$e.addedByPlayerId===N);if(Ee||Z&&Ne&&we.ownerId!==N){const $e=Math.max(0,we.power+(we.powerModifier||0)+(we.bonusPower||0));$e>0&&(de+=$e,ge.push({row:j,col:Ae,text:`+${$e}`,playerId:N}))}}}return o(null),ge.length>0&&c(ge),de>0&&d(N,de),E(),setTimeout(()=>{s.current=!1},200),!0}if(T==="SELECT_LINE_START")return o({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:p,sourceCoords:m,isDeployAbility:_,payload:{...S,firstCoords:t}}),!0;if(T==="SELECT_LINE_END"&&(S!=null&&S.firstCoords)){const{row:R,col:b}=S.firstCoords,{row:G,col:x}=t;if(R!==G&&b!==x)return!0;const N=S.actionType,M=(p==null?void 0:p.ownerId)??((w=r.players.find($=>$.id===r.activePlayerId))!=null&&w.isDummy?r.activePlayerId:n||r.activePlayerId);if(N==="ZIUS_SCORING"){const $=P.lastMovedCardCoords;if($){const j=R===G&&$.row===R,Ae=b===x&&$.col===b;if(!j&&!Ae)return!0}const B=r.board.length;let V=0,X=B-1,Z=0,de=B-1;if(R===G)V=X=R;else if(b===x)Z=de=b;else return!0;let ge=0;for(let j=V;j<=X;j++)for(let Ae=Z;Ae<=de;Ae++){const Me=r.board[j][Ae];Me.card&&(ge+=((D=Me.card.statuses)==null?void 0:D.filter(we=>we.type==="Exploit"&&we.addedByPlayerId===M).length)||0)}ge>0&&M&&(m&&c({row:m.row,col:m.col,text:`+${ge}`,playerId:M}),d(M,ge)),m&&m.row>=0&&i(m,_,!1,I)}else if(N==="CENTURION_BUFF"&&p&&m&&M){const $=r.board.length;let B=0,V=$-1,X=0,Z=$-1;R===G?B=V=R:X=Z=b;for(let de=B;de<=V;de++)for(let ge=X;ge<=Z;ge++){const j=r.board[de][ge].card;if(j){const Ae=j.id===p.id,Me=j.ownerId===M,we=r.players.find($e=>$e.id===M),Ee=r.players.find($e=>$e.id===j.ownerId),Ne=(we==null?void 0:we.teamId)!==void 0&&(Ee==null?void 0:Ee.teamId)!==void 0&&we.teamId===Ee.teamId;!Ae&&(Me||Ne)&&g({row:de,col:ge},1)}}i(m,_,!1,I)}else(N==="SCORE_LINE"||!N)&&(A(R,b,G,x,M),S.skipNextPhase||E());return setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}if(T==="SELECT_DIAGONAL"&&S.actionType==="SCORE_DIAGONAL"){const R=(p==null?void 0:p.ownerId)??((v=r.players.find(b=>b.id===r.activePlayerId))!=null&&v.isDummy?r.activePlayerId:n||r.activePlayerId);if(S.firstCoords){const{row:b,col:G}=S.firstCoords,{row:x,col:N}=t;return Math.abs(b-x)!==Math.abs(G-N)?(o(null),!0):(y(b,G,x,N,R,S.bonusType),S.skipNextPhase||E(),o(null),!0)}else return o({...a,payload:{...S,firstCoords:t}}),!0}return!1}function si(t,e,r){const{gameState:n,localPlayerId:a,abilityMode:s,interactionLock:o,handleLineSelection:i}=r;if(!s||s.type!=="ENTER_MODE"||o.current||s.sourceCard&&s.sourceCard.id===t.id&&s.mode!=="SELECT_LINE_START"&&s.mode!=="INTEGRATOR_LINE_SELECT"&&s.mode!=="ZIUS_LINE_SELECT"&&s.mode!=="IP_AGENT_THREAT_SCORING"&&s.mode!=="SELECT_UNIT_FOR_MOVE"&&s.mode!=="SELECT_TARGET"&&s.mode!=="RIOT_PUSH"&&s.mode!=="RIOT_MOVE"&&s.mode!=="REVEREND_DOUBLE_EXPLOIT"&&s.mode!=="SHIELD_SELF_THEN_RIOT_PUSH")return!1;const{mode:d,payload:c,sourceCard:E}=s;return d==="SELECT_LINE_START"||d==="SELECT_LINE_END"?(i(e),!0):d==="SELECT_TARGET"&&c.tokenType?ii(t,e,r):d==="SELECT_TARGET"?di(t,e,r):d==="RIOT_PUSH"?ci(t,e,r):d==="SHIELD_SELF_THEN_RIOT_PUSH"?ui(t,e,r):d==="RIOT_MOVE"?li(t,e,r):d==="SWAP_POSITIONS"?fi(t,e,r):d==="TRANSFER_STATUS_SELECT"?pi(t,e,r):d==="ZEALOUS_WEAKEN"?yi(t,e,r):d==="REVEREND_DOUBLE_EXPLOIT"?hi(t,e,r):d==="SELECT_UNIT_FOR_MOVE"?mi(t,e,r):d==="PATROL_MOVE"?Ii(t,e,r):d==="SPAWN_TOKEN"?Ei(t,e,r):d==="REVEAL_ENEMY"?Ti(t,e,r):d==="SELECT_CELL"?gi(t,e,r):d==="IMMUNIS_RETRIEVE"?wi(t,e,r):d==="INTEGRATOR_LINE_SELECT"?_i(t,e,r):d==="IP_AGENT_THREAT_SCORING"?bi(t,e,r):d==="ZIUS_LINE_SELECT"?Ai(t,e,r):d==="SELECT_DIAGONAL"?Si(t,e,r):d==="SCORE_LAST_PLAYED_LINE"?Ci(t,e,r):d==="SEARCH_DECK"?Di(t,e,r):d==="RETRIEVE_DEVICE"?Ri(t,e,r):d==="SELECT_DECK"?Pi(t,e,r):!1}function ii(t,e,r){const{abilityMode:n,triggerClickWave:a,moveItem:s,markAbilityUsed:o,setAbilityMode:i,setCommandContext:d,handleActionExecution:c,clearValidTargets:E}=r,{payload:g,sourceCoords:A,isDeployAbility:y,readyStatusToRemove:P}=n;if(g.filter&&!g.filter(t,e.row,e.col))return!1;if(s({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:g.tokenType,count:g.count||1},{target:"board",boardCoords:e}),a("board",e),g.recordContext&&d({lastMovedCardCoords:e,lastMovedCardId:t.id}),g.chainedAction){const T={...g.chainedAction,sourceCard:g.chainedAction.sourceCard??t,sourceCoords:g.chainedAction.sourceCoords??e,isDeployAbility:y,recordContext:!0};c(T,e),setTimeout(()=>a("board",e),100),T.type!=="ENTER_MODE"&&(i(null),E())}else A&&A.row>=0&&o(A,y,!1,P),setTimeout(()=>{i(null),E()},oe.MODE_CLEAR_DELAY);return!0}function di(t,e,r){var u,f,w,D,v;const{abilityMode:n,markAbilityUsed:a,setAbilityMode:s,moveItem:o,modifyBoardCardPower:i,addBoardCardStatus:d,removeBoardCardStatus:c,removeBoardCardStatusByOwner:E,removeStatusByType:g,resetDeployStatus:A,setCounterSelectionData:y,handleActionExecution:P,gameState:T}=r,{payload:p,sourceCoords:m,isDeployAbility:S,readyStatusToRemove:_}=n,I=((u=n.sourceCard)==null?void 0:u.ownerId)??((f=T.players.find(R=>R.id===T.activePlayerId))!=null&&f.isDummy?T.activePlayerId:r.localPlayerId||T.activePlayerId);if(p.actionType==="OPEN_COUNTER_MODAL")return p.filter&&!p.filter(t)?!1:(y({card:t,callbackAction:p.rewardType}),s(null),!0);if(p.actionType==="SACRIFICE_AND_BUFF_LINES"){if(p.filter&&!p.filter(t,e.row,e.col))return!1;const R=((w=n.sourceCard)==null?void 0:w.ownerId)??I;o({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"discard",playerId:t.ownerId});const b=T.board.length,{row:G,col:x}=e;for(let N=0;N<b;N++){if(N===x)continue;const $=T.board[G][N].card;$&&$.ownerId===R&&i({row:G,col:N},1)}for(let N=0;N<b;N++){if(N===G)continue;const $=T.board[N][x].card;$&&$.ownerId===R&&i({row:N,col:x},1)}return a(m||e,S,!1,_),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0}if(p.actionType==="SHIELD_AND_REMOVE_AIM")return p.filter&&!p.filter(t)?!1:(d(e,"Shield",I),g(e,"Aim"),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0);if(p.actionType==="RESET_DEPLOY")return p.filter&&!p.filter(t)?!1:(A(e),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0);if(p.actionType==="MODIFY_POWER")return p.filter&&!p.filter(t)?!1:(p.amount&&i(e,p.amount),m&&m.row>=0&&a(m,S,!1,_),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0);if(p.actionType==="DESTROY")return p.filter&&!p.filter(t)?!1:(((D=t.statuses)==null?void 0:D.some(b=>b.type==="Shield"))?c(e,"Shield"):o({card:t,source:"board",boardCoords:e},{target:"discard",playerId:t.ownerId}),a(m||e,S,!1,_),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0);if(p.actionType==="LUCIUS_SETUP")return p.filter&&!p.filter(t)?!1:(o({card:t,source:"board",boardCoords:e},{target:"discard",playerId:t.ownerId}),p.chainedAction&&P(p.chainedAction,e),!0);if(p.actionType==="CENSOR_SWAP"){if(p.filter&&!p.filter(t))return!1;const R=((v=t.statuses)==null?void 0:v.filter(b=>b.type==="Exploit"&&b.addedByPlayerId===I).length)||0;if(R>0){E(e,"Exploit",I);for(let b=0;b<R;b++)d(e,"Stun",I)}return a(m||e,S,!1,_),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0}if(p.actionType==="REVEAL_ENEMY_CHAINED"){if(p.filter&&!p.filter(t,e.row,e.col))return!1;const R=t.ownerId;if(n.chainedAction){const b={...n.chainedAction,targetOwnerId:R,sourceCoords:m||e,sourceCard:n.sourceCard};P(b,e)}return a(m||e,S,!1,_),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0}return!1}function ci(t,e,r){const{abilityMode:n,gameState:a,setAbilityMode:s,moveItem:o,markAbilityUsed:i,interactionLock:d}=r;if(d.current)return!1;const{sourceCoords:c,isDeployAbility:E,readyStatusToRemove:g,sourceCard:A}=n;if(!c||c.row<0)return!1;if(e.row===c.row&&e.col===c.col)return i(c,E,!1,g),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0;const y=Math.abs(e.row-c.row)+Math.abs(e.col-c.col)===1,P=a.players.find(v=>v.id===t.ownerId),T=a.players.find(v=>v.id===(A==null?void 0:A.ownerId)),p=(P==null?void 0:P.teamId)!==void 0&&(T==null?void 0:T.teamId)!==void 0&&P.teamId===T.teamId;if(!y||t.ownerId===(A==null?void 0:A.ownerId)||p)return!1;const m=e.row-c.row,S=e.col-c.col,_=e.row+m,I=e.col+S,u=a.board.length,f=Math.floor((u-a.activeGridSize)/2),w=f,D=f+a.activeGridSize-1;return _<w||_>D||I<w||I>D||a.board[_][I].card!==null?!1:(o({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:_,col:I}}),s({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:A,sourceCoords:c,isDeployAbility:E,payload:{vacatedCoords:e}}),!0)}function li(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="RIOT_MOVE")return!1;const{sourceCoords:i,sourceCard:d,isDeployAbility:c,readyStatusToRemove:E,payload:g}=n;return!i||!d||!(g!=null&&g.vacatedCoords)?!1:e.row===g.vacatedCoords.row&&e.col===g.vacatedCoords.col?(a({card:d,source:"board",boardCoords:i},{target:"board",boardCoords:e}),s(e,c,!1,E),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0):(s(i,c,!1,E),o(null),!0)}function ui(t,e,r){const{abilityMode:n,setAbilityMode:a,addBoardCardStatus:s,markAbilityUsed:o,interactionLock:i}=r;if(i.current)return!1;const{sourceCoords:d,isDeployAbility:c,readyStatusToRemove:E,sourceCard:g}=n;if(!d||d.row<0||!g)return!1;const A=g.ownerId;return e.row===d.row&&e.col===d.col?(s(d,"Shield",A),o(d,c,!1,E),setTimeout(()=>a(null),oe.MODE_CLEAR_DELAY),!0):(s(d,"Shield",A),a({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:g,sourceCoords:d,isDeployAbility:c,readyStatusToRemove:E,payload:{}}),!0)}function fi(t,e,r){const{abilityMode:n,gameState:a,swapCards:s,markAbilityUsed:o,setAbilityMode:i,validTargets:d}=r;if(!n||n.mode!=="SWAP_POSITIONS")return!1;const{sourceCoords:c,sourceCard:E,isDeployAbility:g,readyStatusToRemove:A,payload:y}=n;if(!c||c.row<0)return!1;const P=a.board[c.row][c.col].card;return!P||P.id!==(E==null?void 0:E.id)?(i(null),!1):E&&E.id===t.id||y.filter&&!y.filter(t,e.row,e.col)||!y.filter&&d&&!d.some(p=>p.row===e.row&&p.col===e.col)?!1:(s(c,e),o(e,g,!1,A),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0)}function pi(t,e,r){const{abilityMode:n,transferStatus:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="TRANSFER_STATUS_SELECT")return!1;const{sourceCoords:i,sourceCard:d,isDeployAbility:c,readyStatusToRemove:E}=n;return!i||i.row<0||d&&d.id===t.id||!t.statuses||t.statuses.length===0?!1:(a(e,i,t.statuses[0].type),s(i,c,!1,E),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0)}function yi(t,e,r){const{abilityMode:n,modifyBoardCardPower:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="ZEALOUS_WEAKEN")return!1;const{payload:i,sourceCoords:d,isDeployAbility:c,readyStatusToRemove:E}=n;return i.filter&&!i.filter(t)?!1:(a(e,-1),s(d||e,c,!1,E),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0)}function hi(t,e,r){const{abilityMode:n,addBoardCardStatus:a,markAbilityUsed:s,triggerFloatingText:o,setAbilityMode:i}=r;if(!n||n.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{sourceCoords:d,sourceCard:c,isDeployAbility:E,readyStatusToRemove:g}=n,A=(c==null?void 0:c.ownerId)||0,y=(t.statuses||[]).filter(P=>P.type==="Exploit"&&P.addedByPlayerId===A).length;if(y>0){for(let P=0;P<y;P++)a(e,"Exploit",A);o({row:e.row,col:e.col,text:`+${y}`,playerId:A,timestamp:Date.now()})}return s(d||e,E,!1,g),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}function mi(t,e,r){const{abilityMode:n,setAbilityMode:a}=r;if(!n||n.mode!=="SELECT_UNIT_FOR_MOVE")return!1;const{sourceCard:s,payload:o,isDeployAbility:i,readyStatusToRemove:d}=n;return s&&s.id===t.id||o.filter&&!o.filter(t,e.row,e.col)?!1:(a({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,sourceCoords:e,isDeployAbility:i,readyStatusToRemove:d,payload:{range:o.range||2,moveFromHand:o.moveFromHand||!1,selectedCard:t,allowSelf:!1}}),!0)}function Ii(t,e,r){const{abilityMode:n,gameState:a,moveItem:s,markAbilityUsed:o,setAbilityMode:i}=r;if(!n||n.mode!=="PATROL_MOVE")return!1;const{sourceCoords:d,sourceCard:c,isDeployAbility:E,readyStatusToRemove:g}=n;if(!d||!c)return!1;if(e.row===d.row&&e.col===d.col)return o(d,E,!1,g),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0;const A=e.row===d.row,y=e.col===d.col;return!A&&!y||a.board[e.row][e.col].card!==null?!1:(s({card:c,source:"board",boardCoords:d},{target:"board",boardCoords:e}),o(e,E,!1,g),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0)}function Ei(t,e,r){var P;const{abilityMode:n,spawnToken:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="SPAWN_TOKEN")return!1;const{sourceCoords:i,payload:d,isDeployAbility:c,readyStatusToRemove:E,sourceCard:g}=n;if(!i||!(d!=null&&d.tokenName)||!(Math.abs(e.row-i.row)+Math.abs(e.col-i.col)===1))return!1;const y=(g==null?void 0:g.ownerId)??((P=n.sourceCard)==null?void 0:P.ownerId);return a(e,d.tokenName,y),s(i,c,!1,E),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}function Ti(t,e,r){var _;const{abilityMode:n,setAbilityMode:a,setCursorStack:s,markAbilityUsed:o,gameState:i,localPlayerId:d}=r;if(!n||n.mode!=="REVEAL_ENEMY")return!1;const{sourceCoords:c,sourceCard:E,isDeployAbility:g,readyStatusToRemove:A}=n;if(!c||!E||!(Math.abs(e.row-c.row)+Math.abs(e.col-c.col)===1)||t.deck==="Tokens"||((_=t.types)==null?void 0:_.includes("Token")))return!1;const T=t.ownerId,p=i.players.find(I=>I.id===i.activePlayerId),m=p!=null&&p.isDummy&&i.activePlayerId!==null?i.activePlayerId:d??0;return s(hr("Revealed",m,null,{targetOwnerId:T,onlyFaceDown:!0,sourceCoords:e,sourceCard:t,isDeployAbility:g,readyStatusToRemove:A})),o(c,g,!1,A),setTimeout(()=>a(null),oe.MODE_CLEAR_DELAY),!0}function gi(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="SELECT_CELL")return!1;const{sourceCoords:i,sourceCard:d,isDeployAbility:c,readyStatusToRemove:E,payload:g}=n;return g!=null&&g.filter&&!g.filter(null,e.row,e.col)?!1:(g!=null&&g.moveFromHand&&(g!=null&&g.selectedCard)?a({card:g.selectedCard,source:"hand"},{target:"board",boardCoords:e}):i&&i.row>=0&&d&&a({card:d,source:"board",boardCoords:i},{target:"board",boardCoords:e}),s(i||e,c,!1,E),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0)}function wi(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="IMMUNIS_RETRIEVE")return!1;const{sourceCoords:i,payload:d,isDeployAbility:c,readyStatusToRemove:E}=n;return!i||!(Math.abs(e.row-i.row)+Math.abs(e.col-i.col)===1)?!1:d!=null&&d.selectedCard?(a({card:d.selectedCard,source:"discard"},{target:"board",boardCoords:e}),s(i,c,!1,E),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0):!1}function _i(t,e,r){const{abilityMode:n,gameState:a,markAbilityUsed:s,updatePlayerScore:o,triggerFloatingText:i,setAbilityMode:d}=r;if(!n||n.mode!=="INTEGRATOR_LINE_SELECT")return!1;const{sourceCoords:c,sourceCard:E,isDeployAbility:g,readyStatusToRemove:A}=n,y=(E==null?void 0:E.ownerId)||0,P=c!==void 0&&e.row===c.row,T=c!==void 0&&e.col===c.col;if(!P&&!T)return!1;let p=0;if(P&&c)for(let m=0;m<a.board.length;m++){const S=a.board[e.row][m].card;S!=null&&S.statuses&&(p+=S.statuses.filter(_=>_.type==="Exploit"&&_.addedByPlayerId===y).length)}else if(c)for(let m=0;m<a.board.length;m++){const S=a.board[m][e.col].card;m!==c.row&&S!=null&&S.statuses&&(p+=S.statuses.filter(_=>_.type==="Exploit"&&_.addedByPlayerId===y).length)}return p>0&&(o(y,p),i({row:c.row,col:c.col,text:`+${p}`,playerId:y,timestamp:Date.now()})),s(c||e,g,!1,A),setTimeout(()=>d(null),oe.MODE_CLEAR_DELAY),!0}function bi(t,e,r){const{abilityMode:n,gameState:a,updatePlayerScore:s,triggerFloatingText:o,markAbilityUsed:i,setAbilityMode:d}=r;if(!n||n.mode!=="IP_AGENT_THREAT_SCORING")return!1;const{sourceCoords:c,sourceCard:E,isDeployAbility:g,readyStatusToRemove:A}=n,y=(E==null?void 0:E.ownerId)||0;if(!c)return!1;const P=e.row===c.row,T=e.col===c.col;if(!P&&!T)return!1;let p=0;if(P)for(let S=0;S<a.board.length;S++){const _=a.board[e.row][S].card;_!=null&&_.statuses&&(p+=_.statuses.filter(I=>I.type==="Threat"&&I.addedByPlayerId===y).length)}else for(let S=0;S<a.board.length;S++){const _=a.board[S][e.col].card;S!==c.row&&_!=null&&_.statuses&&(p+=_.statuses.filter(I=>I.type==="Threat"&&I.addedByPlayerId===y).length)}const m=p*2;return m>0&&(s(y,m),o({row:c.row,col:c.col,text:`+${m}`,playerId:y,timestamp:Date.now()})),i(c||e,g,!1,A),setTimeout(()=>d(null),oe.MODE_CLEAR_DELAY),!0}function Ai(t,e,r){const{abilityMode:n,gameState:a,commandContext:s,updatePlayerScore:o,triggerFloatingText:i,markAbilityUsed:d,setAbilityMode:c}=r;if(!n||n.mode!=="ZIUS_LINE_SELECT")return!1;const{sourceCoords:E,sourceCard:g,isDeployAbility:A,readyStatusToRemove:y}=n,P=(g==null?void 0:g.ownerId)||0,T=s.lastMovedCardCoords||E;if(!T)return!1;const p=e.row===T.row,m=e.col===T.col;if(!p&&!m)return!1;let S=0;const _=[];if(p)for(let I=0;I<a.board.length;I++){const u=a.board[e.row][I].card;if(u!=null&&u.statuses){const f=u.statuses.filter(w=>w.type==="Exploit"&&w.addedByPlayerId===P);S+=f.length,f.length>0&&_.push({row:e.row,col:I})}}else for(let I=0;I<a.board.length;I++){const u=a.board[I][e.col].card;if(I!==T.row&&u!=null&&u.statuses){const f=u.statuses.filter(w=>w.type==="Exploit"&&w.addedByPlayerId===P);S+=f.length,f.length>0&&_.push({row:I,col:e.col})}}return S>0&&(o(P,S),_.forEach(I=>{i({row:I.row,col:I.col,text:"+1",playerId:P,timestamp:Date.now()})})),d(E||e,A,!1,y),setTimeout(()=>c(null),oe.MODE_CLEAR_DELAY),!0}function Si(t,e,r){var w;const{abilityMode:n,gameState:a,markAbilityUsed:s,updatePlayerScore:o,triggerFloatingText:i,setAbilityMode:d}=r;if(!n||n.mode!=="SELECT_DIAGONAL")return!1;const{sourceCoords:c,sourceCard:E,isDeployAbility:g,readyStatusToRemove:A,payload:y}=n,P=(E==null?void 0:E.ownerId)||0,{row:T,col:p}=e,{row:m,col:S}=c||{row:0,col:0},_=T-p===m-S,I=T+p===m+S;if(!_&&!I)return!1;if(y!=null&&y.selectForMove&&t)return y.chainedAction&&r.handleActionExecution(y.chainedAction,e),!0;let u=0;const f=a.board.length;if(_){const D=m-S;for(let v=0;v<f;v++){const R=D+v,b=v;if(R>=0&&R<f&&b>=0&&b<f){const G=a.board[R][b].card;G!=null&&G.statuses&&(u+=G.statuses.filter(x=>x.type==="Exploit"&&x.addedByPlayerId===P).length)}}}if(I){const D=m+S;for(let v=0;v<f;v++){const R=v,b=D-R;if(R>=0&&R<f&&b>=0&&b<f){const G=a.board[R][b].card;G!=null&&G.statuses&&(u+=G.statuses.filter(x=>x.type==="Exploit"&&x.addedByPlayerId===P).length)}}}return y!=null&&y.bonusForSupport&&((w=E==null?void 0:E.statuses)!=null&&w.some(D=>D.type==="Support"))&&(u+=y.bonusForSupport),u>0&&(o(P,u),i({row:(c==null?void 0:c.row)||e.row,col:(c==null?void 0:c.col)||e.col,text:`+${u}`,playerId:P,timestamp:Date.now()})),s(c||e,g,!1,A),setTimeout(()=>d(null),oe.MODE_CLEAR_DELAY),!0}function Ci(t,e,r){const{abilityMode:n,gameState:a,commandContext:s,markAbilityUsed:o,updatePlayerScore:i,triggerFloatingText:d,setAbilityMode:c}=r;if(!n||n.mode!=="SCORE_LAST_PLAYED_LINE")return!1;const{sourceCoords:E,sourceCard:g,isDeployAbility:A,readyStatusToRemove:y,payload:P}=n,T=(g==null?void 0:g.ownerId)||0,p=s.lastMovedCardCoords;if(!p)return!1;const m=a.board[p.row][p.col].card;if(!m)return!1;const S=e.row===p.row,_=e.col===p.col;if(!S&&!_)return!1;const I=Math.max(0,m.power+(m.powerModifier||0));return(P==null?void 0:P.rewardType)==="SCORE"?(i(T,I),d({row:p.row,col:p.col,text:`+${I}`,playerId:T,timestamp:Date.now()})):P==null||P.rewardType,o(E||e,A,!1,y),setTimeout(()=>c(null),oe.MODE_CLEAR_DELAY),!0}function Di(t,e,r){const{abilityMode:n,setViewingDiscard:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="SEARCH_DECK")return!1;const{sourceCoords:i,isDeployAbility:d,readyStatusToRemove:c}=n;return a(!0),s(i||e,d,!1,c),o(null),!0}function Ri(t,e,r){const{abilityMode:n,setViewingDiscard:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="RETRIEVE_DEVICE")return!1;const{sourceCoords:i,isDeployAbility:d,readyStatusToRemove:c}=n;return a(!0),s(i||e,d,!1,c),o(null),!0}function Pi(t,e,r){const{abilityMode:n,triggerDeckSelection:a,markAbilityUsed:s,setAbilityMode:o}=r;if(!n||n.mode!=="SELECT_DECK")return!1;const{sourceCoords:i,isDeployAbility:d,readyStatusToRemove:c}=n;return a(t.ownerId??0),s(i||e,d,!1,c),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}const td=({gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,setCursorStack:s,commandContext:o,setCommandContext:i,setViewingDiscard:d,triggerNoTarget:c,triggerClickWave:E,playMode:g,setPlayMode:A,setCounterSelectionData:y,interactionLock:P,onAbilityComplete:T,moveItem:p,drawCardsBatch:m,updatePlayerScore:S,markAbilityUsed:_,applyGlobalEffect:I,swapCards:u,transferStatus:f,transferAllCounters:w,resurrectDiscardedCard:D,spawnToken:v,scoreLine:R,nextPhase:b,modifyBoardCardPower:G,addBoardCardStatus:x,removeBoardCardStatus:N,removeBoardCardStatusByOwner:M,resetDeployStatus:$,scoreDiagonal:B,removeStatusByType:V,triggerFloatingText:X,triggerHandCardSelection:Z,clearValidTargets:de,setTargetingMode:ge,clearTargetingMode:j,validTargets:Ae})=>{const Me=U.useRef(()=>{}),we=U.useCallback(Se=>{oi(Se,{gameState:t,localPlayerId:e,abilityMode:r,interactionLock:P,setAbilityMode:n,markAbilityUsed:_,updatePlayerScore:S,triggerFloatingText:X,nextPhase:b,modifyBoardCardPower:G,scoreLine:R,scoreDiagonal:B,commandContext:o})},[r,t,e,P,n,_,S,X,b,G,R,B,o]);Me.current=we;const Ee=U.useCallback((Se,Y)=>{Js(Se,Y,{gameState:t,localPlayerId:e,setAbilityMode:n,setCursorStack:s,commandContext:o,markAbilityUsed:_,triggerNoTarget:c,handleActionExecution:Ee,modifyBoardCardPower:G,addBoardCardStatus:x,removeBoardCardStatus:N,removeStatusByType:V,updatePlayerScore:S,triggerFloatingText:X,setViewingDiscard:d,handleLineSelection:Me.current,onAbilityComplete:T,applyGlobalEffect:I,drawCardsBatch:m,setTargetingMode:ge})},[t,e,r,n,a,s,o,i,A,_,c,P,p,u,f,w,v,G,x,N,M,V,$,S,X,y,d,Ae,T,I,m,ge]);U.useEffect(()=>{(r==null?void 0:r.type)==="GLOBAL_AUTO_APPLY"&&(Ee(r,r.sourceCoords||{row:-1,col:-1}),n(null))},[r,Ee,n]),U.useEffect(()=>{r||j()},[r,j]);const Ne=U.useCallback((Se,Y)=>{Wn(Se,Y,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,handleActionExecution:Ee,markAbilityUsed:_})},[t,e,r,a,Ee,_]),$e=U.useCallback((Se,Y)=>{var Ve,lt;if(a&&A!==null&&A!==void 0){const Et={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};if(st({card:Se,ownerId:Se.ownerId??0,location:"board"},Et,t.activePlayerId,t.players)){if(a.type==="Revealed"){const Xe=((Ve=a.sourceCard)==null?void 0:Ve.ownerId)??t.activePlayerId??e??1;if((lt=Se.statuses)==null?void 0:lt.some(Nt=>Nt.type==="Revealed"&&Nt.addedByPlayerId===Xe))return}p({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:a.type,count:1},{target:"board",boardCoords:Y}),a.sourceCoords&&a.sourceCoords.row>=0&&_(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?s(Xe=>Xe?{...Xe,count:Xe.count-1}:null):(j(),de(),a.chainedAction&&Ee(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),s(null))}return}if(!P.current){if(!r&&!a&&t.isGameStarted&&Jn(Se,t)){Ne(Se,Y);return}if(r&&(r.mode==="SCORE_LAST_PLAYED_LINE"||r.mode==="SELECT_LINE_END")){we(Y);return}(r==null?void 0:r.type)==="ENTER_MODE"&&si(Se,Y,{gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,setCursorStack:s,commandContext:o,setCommandContext:i,playMode:null,setPlayMode:A,draggedItem:null,setDraggedItem:()=>{},openContextMenu:()=>{},markAbilityUsed:_,triggerNoTarget:c,triggerClickWave:E,triggerDeckSelection:()=>{},handleActionExecution:Ee,interactionLock:P,moveItem:p,swapCards:u,transferStatus:f,transferAllCounters:w,spawnToken:v,modifyBoardCardPower:G,addBoardCardStatus:x,removeBoardCardStatus:N,removeBoardCardStatusByOwner:M,removeStatusByType:V,resetDeployStatus:$,updatePlayerScore:S,triggerFloatingText:X,setCounterSelectionData:y,setViewingDiscard:d,clearValidTargets:de,validTargets:Ae,handleLineSelection:we})||!r&&!a&&Ne(Se,Y)}},[a,A,t,e,P,r,we,p,_,s,Ee,n,i,y,d,v,u,f,w,G,x,N,M,V,$,S,X,c,E,Ae,j,Ne]),tt=U.useCallback(Se=>{ri(Se,{gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,commandContext:o,setCommandContext:i,playMode:g,draggedItem:null,interactionLock:P,handleActionExecution:Ee,handleDrop:p,moveItem:p,markAbilityUsed:_,spawnToken:v,resurrectDiscardedCard:D,updatePlayerScore:S,triggerFloatingText:X,handleLineSelection:we})},[t,e,r,n,a,o,i,g,P,Ee,p,s,c,_,v,D,S,X,we]),Wt=U.useCallback((Se,Y,Ve)=>{ni(Se,Y,Ve,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,interactionLock:P,setCommandContext:i,setAbilityMode:n,moveItem:p,markAbilityUsed:_,handleActionExecution:Ee,triggerHandCardSelection:Z,setCursorStack:s,clearTargetingMode:j,clearValidTargets:de})},[r,a,t,e,Ee,_,n,i,Z,p,s,j,de,P]),ct=U.useCallback((Se,Y)=>{ai(Se,Y,{gameState:t,abilityMode:r,cursorStack:a,interactionLock:P,activateAbility:(Ve,lt)=>Wn(Ve,lt,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,handleActionExecution:Ee,markAbilityUsed:_})})},[r,a,t,e,Ee,_,n,i,Z,p,s,j,de,P]);return{activateAbility:Ne,executeAction:Ee,handleLineSelection:we,handleBoardCardClick:$e,handleEmptyCellClick:tt,handleHandCardClick:Wt,handleAnnouncedCardDoubleClick:ct}},tr=(t,e,r,n,a)=>{const s=(r.baseId||t.split("_")[1]||t).toLowerCase(),o=e===-1,i=[];s==="overwatch"?o?i.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):e===0?i.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},targetOwnerId:-1,onlyOpponents:!0,sourceCard:r}):e===1&&i.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:a,baseCount:0}},sourceCard:r}):s==="tacticalmaneuver"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:c=>c.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:r}}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:c=>c.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:r}}}):s==="inspiration"?o&&i.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"OPEN_COUNTER_MODAL",filter:c=>c.ownerId===a}}):s==="datainterception"?o?i.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r}):e===0?i.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:c=>{var E;return((E=c.statuses)==null?void 0:E.some(g=>g.type==="Exploit"&&g.addedByPlayerId===a))||!1}}}):s==="falseorders"?o?i.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):e===0?i.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:a,sourceCard:r,originalOwnerId:r.ownerId}}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:a}}}}):s==="experimentalstimulants"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"RESET_DEPLOY",filter:c=>{var E;return c.ownerId===a&&((E=c.types)==null?void 0:E.includes("Unit"))}}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:"line",filter:c=>c.ownerId===a}}):s==="logisticschain"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):s==="quickresponseteam"?e===0?i.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:c=>{var E;return c.ownerId===a&&((E=c.types)==null?void 0:E.includes("Unit"))}}}):e===1&&i.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:r,payload:{filterType:"Unit"}}):s==="temporaryshelter"?e===0?i.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:r,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):e===1&&i.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:r,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):s==="enhancedinterrogation"?o?i.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):e===0?i.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):e===1&&i.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:c=>{var E;return((E=c.statuses)==null?void 0:E.some(g=>g.type==="Aim"&&g.addedByPlayerId===a))||!1}}}):(s==="mobilization1"||s==="linebreach")&&o&&i.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:r,payload:{actionType:"SCORE_LINE"}});const d=r.ownerId||a;return i.forEach(c=>{c.originalOwnerId=d,c.sourceCard&&!c.sourceCard.ownerId&&(c.sourceCard.ownerId=d)}),i},rd=({gameState:t,localPlayerId:e,setActionQueue:r,setCommandContext:n,setCommandModalCard:a,setCounterSelectionData:s,moveItem:o,updatePlayerScore:i,updateState:d})=>{const c=U.useCallback((A,y)=>{if(e===null)return;const P=t.players.find(S=>S.id===y.playerId);if(!(y.playerId===e||(P==null?void 0:P.isDummy)))return;o(y,{target:"announced",playerId:y.playerId}),n({});const p=(A.baseId||A.id.split("_")[1]||A.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(S=>p.includes(S)))a(A);else{const S=tr(A.id,-1,A,t,y.playerId);S.length>0?r([...S,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:A,ownerId:y.playerId},sourceCard:A}]):r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:A,ownerId:y.playerId},sourceCard:A}])}},[t,e,o,r,n,a]),E=U.useCallback((A,y)=>{var _,I;if(!y||e===null)return;const P=y.ownerId||e,T=[],p=tr(y.id,-1,y,t,P);let m;(_=y.baseId)!=null&&_.toLowerCase().includes("inspiration")&&(m=A===0?"DRAW_REMOVED":"SCORE_REMOVED",p.length>0&&p[0].type==="ENTER_MODE"&&(p[0]={...p[0],payload:{...p[0].payload,rewardType:m}})),p.forEach(u=>{T.push(u)}),tr(y.id,A,y,t,P).forEach(u=>{T.push(u)}),(I=y.baseId)!=null&&I.toLowerCase().includes("inspiration")||T.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:y,ownerId:P},sourceCard:y}),r(T),a(null)},[t,e,r,a]),g=U.useCallback((A,y)=>{var m;if(e===null)return;const P=y.card.ownerId||e;let T=null;for(let S=0;S<t.board.length;S++){for(let _=0;_<t.board[S].length;_++)if(((m=t.board[S][_].card)==null?void 0:m.id)===y.card.id){T={row:S,col:_};break}if(T)break}if(!T){l.warn(`Card ${y.card.id} not found on board during counter removal`),s(null);return}if(d(S=>{if(!S.isGameStarted)return S;const _=me(S),I=_.board[T.row][T.col].card;let u=0;const f=(I==null?void 0:I.statuses)??[];if(Object.entries(A).forEach(([w,D])=>{for(let v=0;v<D;v++){const R=f.map(b=>b.type).lastIndexOf(w);R>-1&&(I!=null&&I.statuses)&&(I.statuses.splice(R,1),u++)}}),!(I!=null&&I.statuses)&&I&&(I.statuses=[]),_.board=Le(_),u>0&&y.callbackAction==="DRAW_REMOVED"){const w=_.players.find(D=>D.id===P);if(w){const D=Math.min(u,w.deck.length);for(let v=0;v<D;v++){const R=w.deck.shift();R&&w.hand.push(R)}}}return _}),y.callbackAction==="SCORE_REMOVED"){const S=Object.values(A).reduce((_,I)=>_+I,0);S>0&&i(P,S)}const p=t.players.find(S=>S.id===P);p!=null&&p.announcedCard&&r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:p.announcedCard,ownerId:P},sourceCard:p.announcedCard}]),s(null)},[e,i,r,s,t,d]);return{playCommandCard:c,handleCommandConfirm:E,handleCounterSelectionConfirm:g}},nd=({gameState:t,localPlayerId:e,handleDrop:r,markAbilityUsed:n,requestCardReveal:a,interactionLock:s,setCommandContext:o,onAction:i,cursorStack:d,setCursorStack:c,setAbilityMode:E,triggerClickWave:g,clearTargetingMode:A})=>{const y=U.useRef(null),P=U.useRef({x:0,y:0});return U.useLayoutEffect(()=>{if(d&&y.current){const{x:p,y:m}=P.current;y.current.style.transform=`translate(${p-24}px, ${m-24}px)`}},[d]),U.useEffect(()=>{const p=m=>{P.current={x:m.clientX,y:m.clientY},y.current&&(y.current.style.transform=`translate(${m.clientX-24}px, ${m.clientY-24}px)`)};return window.addEventListener("mousemove",p),()=>window.removeEventListener("mousemove",p)},[]),U.useEffect(()=>{const p=m=>{var u,f,w,D,v,R;if(m.button!==0||!d)return;const S=document.elementFromPoint(m.clientX,m.clientY);let _=e;if(d.originalOwnerId!==void 0)_=d.originalOwnerId;else if((u=d.sourceCard)!=null&&u.ownerId)_=d.sourceCard.ownerId;else if(d.sourceCoords&&d.sourceCoords.row>=0){const{row:b,col:G}=d.sourceCoords;if(b>=0&&b<t.board.length&&G>=0&&G<((f=t.board[b])==null?void 0:f.length)){const x=t.board[b][G].card;x&&(_=x.ownerId||e)}}else if(t.activePlayerId){const b=t.players.find(G=>G.id===t.activePlayerId);b!=null&&b.isDummy&&(_=b.id)}let I=S==null?void 0:S.closest("[data-hand-card]");if(!I&&S)if(S.getAttribute("data-hand-card"))I=S;else{const b=S.querySelectorAll("[data-hand-card]");if(b.length>0){let G=1/0,x=null;const N=m.clientX,M=m.clientY;for(const $ of Array.from(b)){const B=$.getBoundingClientRect();if(N>=B.left&&N<=B.right&&M>=B.top&&M<=B.bottom){const V=B.left+B.width/2,X=B.top+B.height/2,Z=Math.hypot(N-V,M-X);Z<G&&(G=Z,x=$)}}I=x}}if(I){const b=I.getAttribute("data-hand-card");if(b){const[G,x]=b.split(","),N=parseInt(G,10),M=parseInt(x,10),$=t.players.find(V=>V.id===N),B=$==null?void 0:$.hand[M];if($&&B){if(d.type==="Revealed"&&!$.isDummy){if((w=B.statuses)==null?void 0:w.some(ge=>ge.type==="Revealed"&&ge.addedByPlayerId===_))return;d.count===1&&(d.chainedAction&&i(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),A()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((D=d.sourceCard)==null?void 0:D.ownerId)??_??void 0,statusType:d.type,count:1},{target:"hand",playerId:N,cardIndex:M,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&n(d.sourceCoords,d.isDeployAbility),d.count>1?c(ge=>ge?{...ge,count:ge.count-1}:null):c(null),s.current=!0,setTimeout(()=>{s.current=!1},300);return}const X={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,tokenType:d.type};if(!st({card:B,ownerId:N,location:"hand"},X,_,t.players))return;d.count===1&&(d.chainedAction&&i(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),A()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((v=d.sourceCard)==null?void 0:v.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:N,cardIndex:M,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&n(d.sourceCoords,d.isDeployAbility),d.count>1?c(de=>de?{...de,count:de.count-1}:null):c(null),s.current=!0,setTimeout(()=>{s.current=!1},300);return}}}if(!I){const b=S==null?void 0:S.closest("[data-board-coords]");if(b){const G=b.getAttribute("data-board-coords");if(G){const[x,N]=G.split(","),M=parseInt(x,10),$=parseInt(N,10);if(!isNaN(M)&&!isNaN($)&&M>=0&&M<t.board.length&&t.board[M]&&$>=0&&$<t.board[M].length&&t.board[M][$]){const B=t.board[M][$].card;if((B==null?void 0:B.ownerId)!==void 0){const V={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,mustBeAdjacentToSource:d.mustBeAdjacentToSource,mustBeInLineWithSource:d.mustBeInLineWithSource,sourceCoords:d.sourceCoords,tokenType:d.type};if(!st({card:B,ownerId:B.ownerId,location:"board",boardCoords:{row:M,col:$}},V,_,t.players))return}if(B){const V=d.placeAllAtOnce?d.count:1;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((R=d.sourceCard)==null?void 0:R.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:V},{target:"board",boardCoords:{row:M,col:$}}),g("board",{row:M,col:$}),d.recordContext&&o(Z=>({...Z,lastMovedCardCoords:{row:M,col:$},lastMovedCardId:B.id})),d.sourceCoords&&d.sourceCoords.row>=0&&n(d.sourceCoords,d.isDeployAbility);const X=d.count-V;if(X>0)c(Z=>Z?{...Z,count:X}:null);else{if(d.chainedAction){const Z={...d.chainedAction};d.recordContext&&(Z.mode==="SELECT_CELL"&&(Z.sourceCard=B,Z.sourceCoords={row:M,col:$},Z.recordContext=!0),Z.type==="GLOBAL_AUTO_APPLY"&&(Z.sourceCoords={row:M,col:$}),Z.type==="CREATE_STACK"&&(Z.sourceCoords={row:M,col:$},Z.originalOwnerId||(Z.sourceCard=B)),Z.mode==="ZIUS_LINE_SELECT"&&(Z.sourceCoords={row:M,col:$})),Z.type==="CREATE_STACK"&&E(null),i(Z,{row:M,col:$})}A(),c(null)}s.current=!0,setTimeout(()=>{s.current=!1},300)}}}}else{const G=S==null?void 0:S.closest(".counter-modal-content"),x=(S==null?void 0:S.closest("[data-board-coords]"))!==null,N=(S==null?void 0:S.closest("[data-hand-card]"))!==null;d.isDragging?G?c(M=>M?{...M,isDragging:!1}:null):!x&&!N&&(A(),c(null)):!G&&!x&&!N&&(A(),c(null))}}};return window.addEventListener("mouseup",p),()=>{window.removeEventListener("mouseup",p)}},[d,r,t,e,a,n,s,o,i,c,E,g]),U.useEffect(()=>{const p=m=>{d&&(m.preventDefault(),A(),c(null))};return window.addEventListener("contextmenu",p),()=>{window.removeEventListener("contextmenu",p)}},[d,c,A]),{cursorFollowerRef:y,handleCounterMouseDown:(p,m)=>{P.current={x:m.clientX,y:m.clientY};const S=t.players.find(I=>I.id===t.activePlayerId),_=S!=null&&S.isDummy&&t.activePlayerId!==null?t.activePlayerId:e??0;c(I=>hr(p,_,I))}}};export{rt as A,Ft as B,ed as C,Ui as D,Vi as E,Hi as F,xi as G,Qi as H,rd as I,td as J,nd as K,Ni as L,Yo as M,Ht as N,tr as O,zo as P,st as Q,Pt as R,Wi as S,oe as T,yr as U,Mi as V,Bo as W,it as a,$i as b,Kn as c,Qo as d,Yi as e,Re as f,zi as g,Jn as h,ze as i,Li as j,Fo as k,qi as l,l as m,ir as n,ve as o,Fi as p,Wo as q,Ki as r,Ko as s,Ho as t,Gi as u,Bi as v,Xi as w,Zi as x,Ji as y,ji as z};
