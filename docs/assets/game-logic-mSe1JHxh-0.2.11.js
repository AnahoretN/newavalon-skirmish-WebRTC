import{r as H,j as Bo}from"./vendor-react-JYPVbgc1-0.2.11.js";import{$ as $t}from"./vendor-webrtc-BBsnVRmn-0.2.11.js";import{e as pr,d as Yt}from"./vendor-BPR6uEV2-0.2.11.js";var Ce=(t=>(t.SynchroTech="SynchroTech",t.Hoods="Hoods",t.Optimates="Optimates",t.Fusion="Fusion",t.Command="Command",t.Tokens="Tokens",t.Custom="Custom",t.Neutral="Neutral",t.Random="Random",t))(Ce||{}),yr=(t=>(t.FreeForAll="FFA",t.TwoVTwo="2v2",t.ThreeVOne="3v1",t))(yr||{});const l={info:(...t)=>{},warn:(...t)=>{console.warn(...t)},error:(...t)=>{console.error(...t)},debug:(...t)=>{}},Yo={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365235/SYN_IP_DEPT_AGENT_pbvh9e.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_TACTICAL_AGENT_vquxfm.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_PATROL_AGENT_nlyneg.webp",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_RIOT_AGENT_i4lk5m.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_THREAT_ANALYST_uqxbsp.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367440/HERO_Mr._Pearl_Director_of_BioSynch_lsesol.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_RECKLESS_PROVOCATEUR_wvfdcr.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_DATA_LIBERATOR_qeru3j.webp",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_CAUTIOUS_AVENGER_xzk6pd.webp",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_VIGILANT_SPOTTER_xo8ig7.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_INVENTIVE_MAKER_sicb73.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367436/HERO_Finn_c8637x.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_FABER_cr804w.webp",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365250/OPT_CENSOR_w4qijk.webp",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_PRINCEPS_aaqakx.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_IMMUNIS_hvlxhi.webp",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_CENTURION_grztbi.webp",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367435/HERO_Lucius_The_Immortal_irhhaj.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_CODE_KEEPER_yhowqj.webp",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_DEVOUT_SYNTHETIC_nkr1tx.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_UNWAVERING_INTEGRATOR_g1cbag.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_SIGNAL_PROPHET_rmk9me.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_ZEALOUS_MISSIONARY_v7qjhw.webp",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367438/HERO_Reverend_of_The_Choir_njrrih.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365196/CMD_OVERWATCH_djwlqo.webp",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_REPOSITIONING_uhwvrk.webp",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_INSPIRATION_v0bi3l.webp",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_DATA_INTERCEPTION_gen1qw.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_FALSE_ORDERS_aatcmc.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367418/CMD_Experimental_Stimulants_plsnet.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367415/CMD_Logistics_Chain_odmwxq.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367414/CMD_Quick_Response_Team_xff2yt.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367411/CMD_Temporary_Shelter_podjbj.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367413/CMD_Enhanced_Interrogation_legiod.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367446/N_Autonomous_Battle_Robot_Gawain_oni745.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Reclaimed_Gawain_sjmlsp.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Secret_informant_w0w6g5.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367432/HERO_Michael_Falk_sv5i5c.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367434/HERO_Edith_Byron_ny23vb.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367429/HERO_Pinkunoneko_cqhpuy.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367431/HERO_Maria_Eleftheria_Damanaki_cpw12i.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367428/HERO_Zius_xhuyxa.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},zo={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_RECON_DRONE_w3elir.webp",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_WALKING_TURRET_c0mttm.webp",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},Ko={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365400/Aim_qzeaqn.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365398/Exploit_pf2zwf.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Revealed_lsan64.webp",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand and face-down cards on board.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board-facedown","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365403/Stun_pbe7ex.webp",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Shield_yilhdt.webp",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365402/Support_hxzufw.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771368527/Threat_dqnnsq.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365394/Resurrected_awaucv.webp",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},qo=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],jt={cardDatabase:Yo,tokenDatabase:zo,countersDatabase:Ko,deckFiles:qo};let Fn=null,ct=new Map,dr=new Map,Pt={},Ht=[],cr={};const ta=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function Wi(){try{let t;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const r=await fetch("/api/content/database");if(r.ok){const n=await r.json(),a=n.cards.map(([d,c])=>[d,c]),s=n.tokens.map(([d,c])=>[d,c]);t={cardDatabase:Object.fromEntries(a),tokenDatabase:Object.fromEntries(s),countersDatabase:Object.fromEntries(n.counters),deckFiles:n.deckFiles}}else t=jt}catch{t=jt}else t=jt;Fn=t,ct=new Map(Object.entries(t.cardDatabase)),dr=new Map(Object.entries(t.tokenDatabase)),Pt=t.countersDatabase,Ht=t.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(Pt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(r){console.warn("Could not save counters database to localStorage:",r)}qe=Fn,ra=ct,jo=dr,ut=Pt,Jo=Ht,cr=Vo(),Xo=cr}catch(t){throw console.error("Failed to load content database:",t),t}}function Vo(){const t={};for(const e of Ht){const r=[];for(const n of e.cards){const a=ct.get(n.cardId);if(!a){console.warn(`Card definition not found for ID: ${n.cardId} in deck: ${e.name}`);continue}const s=ta.has(n.cardId);for(let d=0;d<n.quantity;d++){const o=n.cardId.replace(/-/g,"--DASH--").toUpperCase();s?r.push({...a,deck:Ce.Command,id:`CMD_${o}_${d+1}`,baseId:n.cardId,faction:a.faction||"Command"}):r.push({...a,deck:e.id,id:`${e.id.substring(0,3).toUpperCase()}_${o}_${d+1}`,baseId:n.cardId,faction:a.faction||e.id})}}if(t[e.id]=r,e.id==="Optimates"){const n=new Set;let a=!1;r.forEach(s=>{n.has(s.id)&&(l.error(`[buildDecksData] DUPLICATE ID in Optimates: ${s.id}`),a=!0),n.add(s.id),s.baseId||s.id}),a&&l.warn("[buildDecksData] Optimates deck has duplicate IDs!")}}return t[Ce.Tokens]=Array.from(dr.entries()).map(([e,r])=>{const n=r.types?[...r.types]:[];return{id:`TKN_${r.name.toUpperCase().replace(/\s/g,"_")}`,baseId:e,deck:Ce.Tokens,name:r.name,imageUrl:r.imageUrl,fallbackImage:r.fallbackImage,power:r.power,ability:r.ability,color:r.color,types:n,flavorText:r.flavorText,faction:"Tokens"}}),t}let qe=null,ra=new Map,jo=new Map,ut={};try{const t=localStorage.getItem("counters_database");t&&(Pt=JSON.parse(t),ut=Pt)}catch{}let Jo=[],Xo={};const Zo=ta,Bi=()=>Ht.filter(t=>t.isSelectable);function Ke(t){return ct.get(t)}function Jt(t){return Array.from(ct.values()).find(e=>e.name===t)}function Yi(){return Array.from(ct.entries()).map(([t,e])=>({id:t,card:e}))}function zi(){return ct}function na(){return cr}const Qo=4,Ki={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/medal_tavarc.webp"},qi={[Ce.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[Ce.Hoods]:{prefix:"HOO",color:"border-purple-500"},[Ce.Optimates]:{prefix:"OPT",color:"border-red-500"},[Ce.Fusion]:{prefix:"FUS",color:"border-green-400"},[Ce.Command]:{prefix:"CMD",color:"border-yellow-500"},[Ce.Tokens]:{prefix:"TKN",color:"border-gray-400"},[Ce.Custom]:{prefix:"CUS",color:"border-purple-400"},[Ce.Neutral]:{prefix:"NEU",color:"border-gray-400"},[Ce.Random]:{prefix:"RND",color:"border-gray-400"}},Vi={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},es={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},ji={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},_t=["blue","purple","red","green","yellow","orange","pink","brown"],Ji=["Setup","Main","Commit","Scoring"],Gt=()=>Object.fromEntries(Object.entries(ut).map(([t,e])=>[t,e.imageUrl])),Xi=new Proxy({},{get(t,e){return Gt()[e]},ownKeys(){return Object.keys(Gt())},has(t,e){return e in Gt()},getOwnPropertyDescriptor(t,e){const r=Gt()[e];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),xt=()=>Object.fromEntries(Object.entries(ut).map(([t,e])=>[t,e.description])),Zi=new Proxy({},{get(t,e){return xt()[e]},ownKeys(){return Object.keys(xt())},has(t,e){return e in xt()},getOwnPropertyDescriptor(t,e){const r=xt()[e];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),ts=()=>Object.entries(ut).filter(([t,e])=>t!=="Resurrected"&&(!e.allowedPanels||e.allowedPanels.includes("COUNTER_PANEL"))).sort(([,t],[,e])=>t.sortOrder-e.sortOrder).map(([t,e])=>({type:t,label:e.name}));ts();const Ve="readyDeploy",Me="readySetup",Ge="readyCommit",Pe=(t,e,r)=>t.statuses?t.statuses.some(n=>n.type===e&&(r===void 0||n.addedByPlayerId===r)):!1,Xe=(t,e)=>t.statuses?t.statuses.some(r=>r.type===e):!1,rs=(t,e,r)=>r===1&&Xe(t,Me),Xt=t=>{t.statuses&&(t.statuses=t.statuses.filter(e=>e.type!==Ve&&e.type!==Me&&e.type!==Ge))},It=(t,e,r,n)=>Math.abs(t-r)+Math.abs(e-n)===1,aa=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>Pe(a,"Aim",r)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"riotAgent",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:t,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"codeKeeper",activationType:"deploy",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>{var s;return a.ownerId!==r&&((s=a.statuses)==null?void 0:s.some(d=>d.type==="Threat"))}},sourceCard:t,sourceCoords:n})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId!==r&&Pe(a,"Exploit",r)}})},{baseId:"centurion",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(a,s,d)=>{var c;return a.ownerId===r&&((c=a.types)==null?void 0:c.includes("Unit"))&&s!==void 0&&d!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:t,sourceCoords:n,payload:{filter:(a,s,d)=>It(s,d,n.row,n.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:t,sourceCoords:n,payload:{filter:a=>{if(a.id===t.id)return!1;if(a.ownerId!==r){const s=e.players.find(c=>c.id===a.ownerId),d=e.players.find(c=>c.id===r);if(!(s!=null&&s.teamId)||!(d!=null&&d.teamId)||s.teamId!==d.teamId)return!1}return a.statuses&&a.statuses.length>0}}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:n,maxOrthogonalDistance:2,sourceCard:t})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>Pe(a,"Aim",r)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:t,sourceCoords:n,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,originalOwnerId:r,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:a=>a.ownerId===r}})},{baseId:"censor",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:n,sourceCard:t,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>Pe(a,"Aim",r)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(t,e,r,n)=>Pe(t,"Support",r)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:t,sourceCoords:n,payload:{filter:(a,s)=>It(a,s,n.row,n.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,s,d)=>It(s,d,n.row,n.col)&&a.ownerId!==r&&(Pe(a,"Threat",r)||Pe(a,"Stun",r))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>a.ownerId===r&&Pe(a,"Support",r)},sourceCard:t,sourceCoords:n})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId===r&&Pe(a,"Exploit",r)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:t,sourceCoords:n,payload:{filter:a=>Pe(a,"Exploit",r)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"walkingTurret",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"MODIFY_POWER",amount:-1,filter:a=>Pe(a,"Aim",r)}})},{baseId:"reconDrone",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,sourceCoords:n,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"REVEAL_ENEMY_CHAINED",filter:(a,s,d)=>{const c=It(s,d,n.row,n.col),o=a.ownerId!==r;return c&&o},targetOwnerId:void 0},skipChainedActionOnNoTargets:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:1}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>Pe(a,"Aim",r)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,s,d)=>It(s,d,n.row,n.col)&&a.ownerId!==r&&(Pe(a,"Threat",r)||Pe(a,"Stun",r))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(t,e,r,n)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:t,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"edithByron",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:t,sourceCoords:n,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:n,sourceCard:t})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:(a,s,d)=>It(s,d,n.row,n.col)&&(Pe(a,"Threat",r)||Pe(a,"Stun",r)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"DESTROY",filter:a=>Pe(a,"Aim",r)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(t,e,r,n)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:t,sourceCoords:n,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:t,sourceCoords:n,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(t,e,r,n)=>({type:"REVEREND_SETUP_SCORE",sourceCard:t,sourceCoords:n,ownerId:r})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:t,sourceCoords:n,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:t,sourceCoords:n,payload:{actionType:"LUCIUS_SETUP",filter:a=>a.ownerId===r}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(t,e,r,n)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:t,sourceCoords:n,payload:{filter:a=>a.ownerId===r,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(t,e,r,n)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:t,sourceCoords:n})}],hr=t=>{const e=t.baseId||"";return aa.filter(r=>{var n;return r.baseId===e||((n=r.baseIdAlt)==null?void 0:n.includes(e))})},ns=t=>{const r=hr(t).map(n=>n.activationType);return[...new Set(r)]},mr=(t,e,r,n)=>{var d;if(r!==t.ownerId)return!1;if(n&&t.ownerId!==void 0){const c=n.players.find(o=>o.id===t.ownerId);if(c!=null&&c.isDummy&&n.activePlayerId!==t.ownerId)return!1}if((d=t.statuses)!=null&&d.some(c=>c.type==="Stun"))return!1;const a=hr(t),s=e===1&&a.some(c=>c.activationType==="setup")||e===3&&a.some(c=>c.activationType==="commit");if(e===1){const c=a.find(o=>o.activationType==="setup");if(c&&Xe(t,Me))return!(c.supportRequired&&!Pe(t,"Support",r))}if(e===3){const c=a.find(o=>o.activationType==="commit");if(c&&Xe(t,Ge))return!(c.supportRequired&&!Pe(t,"Support",r))}if(!s){const c=a.find(o=>o.activationType==="deploy");if(c&&Xe(t,Ve))return!(c.supportRequired&&!Pe(t,"Support",r))}return!1},as=(t,e,r,n)=>{if(r!==t.ownerId)if(t.ownerId!==void 0){const o=e.players.find(i=>i.id===t.ownerId);if(!(o!=null&&o.isDummy))return null}else return null;const a=hr(t),s=t.ownerId??r??0,d=e.currentPhase,c=d===1&&a.some(o=>o.activationType==="setup")||d===3&&a.some(o=>o.activationType==="commit");if(d===1){const o=a.find(i=>i.activationType==="setup");if(o&&Xe(t,Me)){if(o.supportRequired&&!Pe(t,"Support",s))return null;const i=o.getAction(t,e,s,n);if(i)return{...i,readyStatusToRemove:Me}}}if(d===3){const o=a.find(i=>i.activationType==="commit");if(o&&Xe(t,Ge)){if(o.supportRequired&&!Pe(t,"Support",s))return null;const i=o.getAction(t,e,s,n);if(i)return{...i,readyStatusToRemove:Ge}}}if(!c){const o=a.find(i=>i.activationType==="deploy");if(o&&Xe(t,Ve)){if(o.supportRequired&&!Pe(t,"Support",s))return null;const i=o.getAction(t,e,s,n);if(i)return{...i,isDeployAbility:!0,readyStatusToRemove:Ve}}}return null},oa=(t,e)=>e===1&&Xe(t,Me)?Me:e===3&&Xe(t,Ge)?Ge:Xe(t,Ve)?Ve:null,Qi=(t,e)=>{let r;return typeof e=="object"?r=e.currentPhase:r=e,oa(t,r)!==null},sa=(t,e,r)=>{let n;return typeof e=="object"?(n=e.currentPhase,e.activePlayerId):n=e,oa(t,n)!==null},Ir=(t,e)=>{t.statuses||(t.statuses=[]);const r=ns(t);for(const n of r){let a="";n==="deploy"?a=Ve:n==="setup"?a=Me:n==="commit"&&(a=Ge),a&&(t.statuses.some(d=>d.type===a)||t.statuses.push({type:a,addedByPlayerId:e}))}},lr=(t,e)=>{const r=kt("setup"),n=kt("commit"),a=t.currentPhase;for(let s=0;s<t.board.length;s++)for(let d=0;d<t.board[s].length;d++){const o=t.board[s][d].card;if(!o||o.ownerId!==e)continue;const i=o.baseId||o.id;if(!i)continue;if(l.debug(`[resetReadyStatusesForTurn] Processing card: ${o.name} (baseId: ${i}, ownerId: ${o.ownerId})`),o.statuses||(o.statuses=[]),o.statuses.some(T=>T.type==="Stun")){o.statuses=o.statuses.filter(T=>T.type!==Me&&T.type!==Ge),l.debug(`[resetReadyStatusesForTurn] Card ${o.name} is stunned, removing ready statuses`);continue}if(!mr(o,a,e,t)){o.statuses=o.statuses.filter(T=>T.type!==Me&&T.type!==Ge),l.debug(`[resetReadyStatusesForTurn] Card ${o.name} cannot activate (missing Support?), removing ready statuses`);continue}if(r.includes(i)){const T=o.statuses.some(f=>f.type===Me);o.statuses=o.statuses.filter(f=>f.type!==Me),o.statuses.push({type:Me,addedByPlayerId:e}),T||l.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_SETUP to ${o.name}`)}else o.statuses=o.statuses.filter(T=>T.type!==Me);if(n.includes(i)){const T=o.statuses.some(f=>f.type===Ge);o.statuses=o.statuses.filter(f=>f.type!==Ge),o.statuses.push({type:Ge,addedByPlayerId:e}),T||l.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_COMMIT to ${o.name}`)}else o.statuses=o.statuses.filter(T=>T.type!==Ge)}},Zt=(t,e)=>{if(!t.ownerId)return;const r=t.ownerId,n=e.activePlayerId===r;t.statuses||(t.statuses=[]);const a=t.baseId||t.id;if(!a)return;const s=kt("setup"),d=kt("commit"),c=kt("deploy");let o=!1,i=!1;if(!n){t.statuses=t.statuses.filter(D=>D.type!==Me&&D.type!==Ge&&D.type!==Ve),l.debug(`[recheckReadyStatuses] Card ${t.name} owner not active, removed all ready statuses`);return}if(t.statuses.some(D=>D.type==="Stun")){t.statuses=t.statuses.filter(D=>D.type!==Me&&D.type!==Ge&&D.type!==Ve),l.debug(`[recheckReadyStatuses] Card ${t.name} is stunned, removed all ready statuses`);return}if(!mr(t,e.currentPhase,r,e)){t.statuses=t.statuses.filter(D=>D.type!==Me&&D.type!==Ge&&D.type!==Ve),l.debug(`[recheckReadyStatuses] Card ${t.name} cannot activate (missing Support?), removed all ready statuses`);return}s.includes(a)&&(o=!0),d.includes(a)&&(i=!0),c.includes(a)&&t.statuses.some(D=>D.type===Ve);const T=t.statuses.some(D=>D.type===Me);o&&!T?(t.statuses.push({type:Me,addedByPlayerId:r}),l.debug(`[recheckReadyStatuses] Added READY_STATUS_SETUP to ${t.name}`)):!o&&T&&(t.statuses=t.statuses.filter(D=>D.type!==Me),l.debug(`[recheckReadyStatuses] Removed READY_STATUS_SETUP from ${t.name}`));const f=t.statuses.some(D=>D.type===Ge);i&&!f?(t.statuses.push({type:Ge,addedByPlayerId:r}),l.debug(`[recheckReadyStatuses] Added READY_STATUS_COMMIT to ${t.name}`)):!i&&f&&(t.statuses=t.statuses.filter(D=>D.type!==Ge),l.debug(`[recheckReadyStatuses] Removed READY_STATUS_COMMIT from ${t.name}`))};function kt(t){const e=[];return aa.forEach(r=>{r.activationType===t&&(e.push(r.baseId),r.baseIdAlt&&e.push(...r.baseIdAlt))}),[...new Set(e)]}class os{constructor(){this.queue=[],this.loading=new Set,this.loaded=new Set,this.minDelayBetweenLoads=1e3,this.lastLoadTime=0,this.isProcessing=!1}preload(e,r="low"){!e||this.loaded.has(e)||this.loading.has(e)||this.queue.some(a=>a.url===e)||(this.queue.push({url:e,priority:r,timestamp:Date.now()}),this.queue.sort((a,s)=>{const d={high:0,normal:1,low:2},c=d[a.priority]-d[s.priority];return c!==0?c:a.timestamp-s.timestamp}),this.processQueue())}preloadMany(e,r="low"){e.forEach(n=>this.preload(n,r))}isLoaded(e){return this.loaded.has(e)}clearQueue(){this.queue=[]}clear(){this.queue=[],this.loading.clear(),this.loaded.clear()}processQueue(){if(this.isProcessing||this.queue.length===0)return;this.isProcessing=!0;const e=()=>{if(this.queue.length===0){this.isProcessing=!1;return}const n=Date.now()-this.lastLoadTime,a=Math.max(0,this.minDelayBetweenLoads-n);setTimeout(()=>{const s=this.queue.shift();if(!s){this.isProcessing=!1;return}this.loadImage(s.url).then(()=>{this.lastLoadTime=Date.now(),e()}).catch(()=>{this.lastLoadTime=Date.now(),e()})},a)};e()}loadImage(e){return new Promise((r,n)=>{this.loading.add(e);const a=new Image;a.onload=()=>{this.loading.delete(e),this.loaded.add(e),r()},a.onerror=()=>{this.loading.delete(e),n(new Error(`Failed to load: ${e}`))},a.src=e})}}const ss=new os;function is(t,e){const r=[];for(const n of t)if(n.id!==e){if(n.hand)for(const a of n.hand)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl);if(n.deck)for(const a of n.deck)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl);if(n.discard)for(const a of n.discard)a.imageUrl&&!r.includes(a.imageUrl)&&r.push(a.imageUrl)}return r}function fe(t){const e=t,r=e==null?void 0:e.targetingMode;r&&delete e.targetingMode;let n;return typeof structuredClone<"u"?n=structuredClone(t):n=JSON.parse(JSON.stringify(t)),r&&(n.targetingMode=r,e.targetingMode=r),n}const ae={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function ed(t){return{r:Math.min(255,Math.round(t.r*1.3)),g:Math.min(255,Math.round(t.g*1.3)),b:Math.min(255,Math.round(t.b*1.3))}}function td(t,e){return`rgba(${t.r}, ${t.g}, ${t.b}, ${e})`}function rd(t,e){return t?es[t]:e}function We(){return localStorage.getItem("webrtc_enabled")==="true"}const ia=H.createContext(null),nd=({children:t})=>{const[e,r]=H.useState(null),[n,a]=H.useState({}),[s,d]=H.useState("lg"),c=H.useCallback((f,D={},u="lg")=>{r(f),a(D),d(u)},[]),o=H.useCallback(()=>{r(null),a({}),d("lg")},[]),i=H.useCallback(f=>e===f,[e]),E=H.useCallback(()=>n,[n]),P=H.useCallback(()=>s,[s]),T={openModal:e,modalData:n,modalSize:s,open:c,close:o,isOpen:i,getData:E,getSize:P};return Bo.jsx(ia.Provider,{value:T,children:t})},zt=()=>{const t=H.useContext(ia);if(!t)throw new Error("useModals must be used within ModalsProvider");return t},ad=()=>{const{open:t,close:e,isOpen:r}=zt();return{isOpen:r("rules"),open:n=>t("rules",n,"full"),close:e}},od=()=>{const{open:t,close:e,isOpen:r}=zt();return{isOpen:r("settings"),open:n=>t("settings",n,"md"),close:e}},sd=()=>{const{open:t,close:e,isOpen:r,getData:n}=zt();return{isOpen:r("joinGame"),open:a=>t("joinGame",a,"lg"),close:e,getData:()=>n()}},id=()=>{const{open:t,close:e,isOpen:r}=zt();return{isOpen:r("deckBuilder"),open:n=>t("deckBuilder",n,"full"),close:e}},Ot="webrtc_game_state",vt="webrtc_host_data",Nt="webrtc_guest_data",ds="webrtc_current_host_peerId",cs=30*60*1e3;function Er(){return Date.now()}function Mt(t){return Date.now()-t<cs}function ls(t){try{const e={...t,timestamp:Er()};localStorage.setItem(vt,JSON.stringify(e)),l.info("[WebRTC Persistence] Saved host data:",{peerId:e.peerId})}catch(e){l.error("[WebRTC Persistence] Failed to save host data:",e)}}function Qt(t){try{const e={...t,timestamp:Er()};localStorage.setItem(Nt,JSON.stringify(e)),l.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:e.hostPeerId,playerId:e.playerId})}catch(e){l.error("[WebRTC Persistence] Failed to save guest data:",e)}}function St(t){try{const e={...t,timestamp:Er()};localStorage.setItem(Ot,JSON.stringify(e)),l.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(e.timestamp).toISOString())}catch(e){l.error("[WebRTC Persistence] Failed to save game state:",e)}}function da(){try{const t=localStorage.getItem(vt);if(!t)return null;const e=JSON.parse(t);return Mt(e.timestamp)?(l.info("[WebRTC Persistence] Loaded valid host data:",{peerId:e.peerId}),e):(l.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(vt),null)}catch(t){return l.error("[WebRTC Persistence] Failed to load host data:",t),localStorage.removeItem(vt),null}}function ca(){try{const t=localStorage.getItem(Nt);if(!t)return null;const e=JSON.parse(t);return Mt(e.timestamp)?(l.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:e.hostPeerId,playerId:e.playerId}),e):(l.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(Nt),null)}catch(t){return l.error("[WebRTC Persistence] Failed to load guest data:",t),localStorage.removeItem(Nt),null}}function Wn(){try{const t=localStorage.getItem(Ot);if(!t)return null;const e=JSON.parse(t);return Mt(e.timestamp)?(l.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(e.timestamp).toISOString()),e):(l.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(Ot),null)}catch(t){return l.error("[WebRTC Persistence] Failed to load game state:",t),localStorage.removeItem(Ot),null}}function st(){localStorage.removeItem(Ot),localStorage.removeItem(vt),localStorage.removeItem(Nt),localStorage.removeItem(ds)}function ur(t,e){try{const r=`webrtc_host_${e}`,n={peerId:t,gameId:e,timestamp:Date.now()};localStorage.setItem(r,JSON.stringify(n)),l.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${e}:`,t)}catch(r){l.error("[WebRTC Persistence] Failed to broadcast host peerId:",r)}}function er(t){try{const e=`webrtc_host_${t}`,r=localStorage.getItem(e);if(!r)return null;const n=JSON.parse(r);return Date.now()-n.timestamp>15e3?null:{peerId:n.peerId,timestamp:n.timestamp}}catch(e){return l.error("[WebRTC Persistence] Failed to get host peerId:",e),null}}function Bn(t){try{const e=`webrtc_host_${t}`;localStorage.removeItem(e),l.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${t}`)}catch(e){l.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",e)}}function us(){const t=sessionStorage.getItem("invite_host_id"),e=sessionStorage.getItem("invite_auto_join");if(t&&e)return"none";const r=da();if(r&&Mt(r.timestamp))return"host";const n=ca();return n&&Mt(n.timestamp)?"guest":"none"}const Yn=7,tr="mrPearlDoF",fs="reverendOfTheChoir",ps="threatAnalyst";function ys(t,e){return t!=null&&t.statuses?t.statuses.some(r=>r.type==="Exploit"&&r.addedByPlayerId!==void 0&&e.has(r.addedByPlayerId)):!1}function hs(t){return typeof structuredClone<"u"?structuredClone(t):JSON.parse(JSON.stringify(t))}const la=()=>Array(Yn).fill(null).map(()=>Array(Yn).fill(null).map(()=>({card:null}))),Le=t=>{var u,y,p,A,S;const{board:e,activeGridSize:r,players:n}=t,a=hs(e),s=a.length,d=Math.floor((s-r)/2),c=new Map;n.forEach(h=>c.set(h.id,h.teamId));for(let h=0;h<s;h++)for(let w=0;w<s;w++){const _=a[h][w].card;_&&(_.statuses&&(_.statuses=_.statuses.filter(m=>m.type!=="Support"&&m.type!=="Threat")),delete _.bonusPower)}for(let h=0;h<s;h++)for(let w=0;w<s;w++){const _=a[h][w].card;if((_==null?void 0:_.ownerId)===void 0||_.isFaceDown)continue;const m=_.ownerId,g=c.get(m),k=[{r:h-1,c:w},{r:h+1,c:w},{r:h,c:w-1},{r:h,c:w+1}],R={};let b=!1;for(const x of k){const{r:U,c:N}=x;if(U>=0&&U<s&&N>=0&&N<s){const G=a[U][N].card,$=(u=G==null?void 0:G.statuses)==null?void 0:u.some(q=>q.type==="Stun");if((G==null?void 0:G.ownerId)!==void 0&&!G.isFaceDown&&!$){const q=G.ownerId,Q=c.get(q);m===q||g!==void 0&&g===Q?b=!0:(R[q]||(R[q]=[]),R[q].push({r:U,c:N}))}}}b&&(_.statuses||(_.statuses=[]),_.statuses.some(x=>x.type==="Support")||_.statuses.push({type:"Support",addedByPlayerId:m}));let O=null;for(const x in R){const U=R[x];if(U&&U.length>=2){O=parseInt(x,10);break}}if(O===null&&h>=d&&h<d+r&&w>=d&&w<d+r){const U=h===d||h===d+r-1||w===d||w===d+r-1,N=Object.keys(R).length>0;if(U&&N){const G=Object.keys(R)[0];G&&(O=parseInt(G,10))}}O!==null&&(_.statuses||(_.statuses=[]),_.statuses.some(x=>x.type==="Threat")||_.statuses.push({type:"Threat",addedByPlayerId:O}))}const o=new Set;for(let h=0;h<s;h++)for(let w=0;w<s;w++){const _=a[h][w].card,m=(y=_==null?void 0:_.statuses)==null?void 0:y.some(g=>g.type==="Stun");if((_==null?void 0:_.baseId)===ps&&!_.isFaceDown&&_.ownerId!==void 0&&!m){const g=[{r:h-1,c:w},{r:h+1,c:w},{r:h,c:w-1},{r:h,c:w+1}];let k=!1;const R=_.ownerId,b=c.get(R);for(const O of g){const{r:x,c:U}=O;if(x>=0&&x<s&&U>=0&&U<s){const N=a[x][U].card;if((N==null?void 0:N.ownerId)!==void 0&&!N.isFaceDown){const G=N.ownerId,$=c.get(G),q=R===G||b!==void 0&&b===$,Q=(p=N==null?void 0:N.statuses)==null?void 0:p.some(J=>J.type==="Stun");if(q&&!Q){k=!0;break}}}}k&&o.add(R)}}for(let h=0;h<s;h++)for(let w=0;w<s;w++){const _=a[h][w].card;if(!_||_.isFaceDown||_.ownerId===void 0)continue;const m=_.ownerId,g=c.get(m),k=[{r:h-1,c:w},{r:h+1,c:w},{r:h,c:w-1},{r:h,c:w+1}],R={};for(const O of k){const{r:x,c:U}=O;if(x>=0&&x<s&&U>=0&&U<s){const N=a[x][U].card,G=(A=N==null?void 0:N.statuses)==null?void 0:A.some($=>$.type==="Stun");if((N==null?void 0:N.ownerId)!==void 0&&!N.isFaceDown&&!G){const $=N.ownerId,q=c.get($);if(!(m===$||g!==void 0&&g===q)){const J=o.has($),oe=ys(_,o);J&&oe&&(R[$]||(R[$]=0),R[$]++)}}}}if(Object.keys(R).length>0){_.statuses||(_.statuses=[]);const O=Object.keys(R).map(x=>parseInt(x,10));for(const x of O)_.statuses.some(U=>U.type==="Threat"&&U.addedByPlayerId===x)||_.statuses.push({type:"Threat",addedByPlayerId:x})}}const i=[],E=[];for(let h=0;h<s;h++)for(let w=0;w<s;w++){const _=a[h][w].card,m=(S=_==null?void 0:_.statuses)==null?void 0:S.some(g=>g.type==="Stun");_!=null&&_.baseId&&!_.isFaceDown&&_.ownerId!==void 0&&!m&&(_.baseId===fs?i.push({r:h,c:w,ownerId:_.ownerId,baseId:_.baseId}):_.baseId===tr&&E.push({r:h,c:w,ownerId:_.ownerId,baseId:_.baseId}))}const P=new Set,T=new Set;for(const h of i){const{r:w,c:_,ownerId:m}=h,g=`${w}-${m}`;if(!P.has(g)){P.add(g);for(let R=0;R<s;R++){const b=a[w][R].card;b&&b.ownerId===m&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(O=>O.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:m}))}}const k=`${_}-${m}`;if(!T.has(k)){T.add(k);for(let R=0;R<s;R++){const b=a[R][_].card;b&&b.ownerId===m&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(O=>O.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:m}))}}}const f=new Set,D=new Set;for(const h of E){const{r:w,c:_,ownerId:m}=h,g=`${w}-${m}`;if(!f.has(g)){f.add(g);for(let R=0;R<s;R++){const b=a[w][R].card;b&&b.ownerId===m&&!b.isFaceDown&&b.baseId!==tr&&(b.bonusPower=(b.bonusPower||0)+1)}}const k=`${_}-${m}`;if(!D.has(k)){D.add(k);for(let R=0;R<s;R++){const b=a[R][_].card;b&&b.ownerId===m&&!b.isFaceDown&&b.baseId!==tr&&(b.bonusPower=(b.bonusPower||0)+1)}}}return a};var ft=(t=>(t[t.CARD_REGISTRY=1]="CARD_REGISTRY",t[t.CARD_STATE=2]="CARD_STATE",t[t.ABILITY_EFFECT=3]="ABILITY_EFFECT",t[t.SESSION_EVENT=4]="SESSION_EVENT",t))(ft||{}),Dt=(t=>(t[t.HIGHLIGHT_CELL=1]="HIGHLIGHT_CELL",t[t.FLOATING_TEXT=2]="FLOATING_TEXT",t[t.NO_TARGET=3]="NO_TARGET",t[t.STATUS_ADDED=4]="STATUS_ADDED",t[t.STATUS_REMOVED=5]="STATUS_REMOVED",t[t.POWER_CHANGED=6]="POWER_CHANGED",t[t.CARD_DESTROYED=7]="CARD_DESTROYED",t[t.TARGETING_MODE=8]="TARGETING_MODE",t[t.CLEAR_TARGETING=9]="CLEAR_TARGETING",t))(Dt||{});function ms(){const t={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},e=new Set,r=Array.from(ra.values());for(const n of r)if(n.baseId&&!e.has(n.baseId)){e.add(n.baseId);const a=t.cardDefinitions.length;t.baseIdToIndex.set(n.baseId,a),t.indexToBaseId.set(a,n.baseId),t.cardDefinitions.push({baseId:n.baseId,name:n.name,imageUrl:n.imageUrl,power:n.power,ability:n.ability||"",types:n.types||[],faction:n.faction||""})}return t.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],l.info(`[CardRegistry] Built registry with ${t.cardDefinitions.length} cards, ${t.statusTypes.length} status types`),t}function ua(t,e){let r=0;for(const n of t||[]){const a=e.statusTypes.indexOf(n.type);a>=0&&a<32&&(r|=1<<a)}return r>>>0}function fa(t,e,r){const n=[];for(let a=0;a<32;a++)if(t&1<<a){const s=r.statusTypes[a];s&&n.push({type:s,addedByPlayerId:e})}return n}function pa(t){let e=0;return t.isFaceDown&&(e|=1),t.enteredThisTurn&&(e|=2),t.revealedTo==="all"&&(e|=4),e}function rr(t,e){const r=new Uint8Array(13);let n=0;const a=Tr(t.id);r[n++]=a>>24&255,r[n++]=a>>16&255,r[n++]=a>>8&255,r[n++]=a&255;const s=t.baseId?e.baseIdToIndex.get(t.baseId)??0:0;r[n++]=s>>8&255,r[n++]=s&255,r[n++]=(t.ownerId??0)&255;const d=Math.round(t.power||0);r[n++]=Math.clamp(d,-128,127)&255,r[n++]=pa(t);const c=ua(t.statuses||[],e);return r[n++]=c>>24&255,r[n++]=c>>16&255,r[n++]=c>>8&255,r[n++]=c&255,r}function Is(t,e,r){const n=new Uint8Array(10);let a=0;const s=Tr(t.id);n[a++]=s>>24&255,n[a++]=s>>16&255,n[a++]=s>>8&255,n[a++]=s&255,n[a++]=(t.ownerId??r)&255,n[a++]=pa(t);const d=ua(t.statuses||[],e);return n[a++]=d>>24&255,n[a++]=d>>16&255,n[a++]=d>>8&255,n[a++]=d&255,n}function Tr(t){let e=0;for(let r=0;r<t.length;r++){const n=t.charCodeAt(r);e=(e<<5)-e+n,e=e&e}return e>>>0}function Es(t,e,r){var u;const n=[],a=Date.now(),s=new Uint8Array(7);s[0]=ft.CARD_STATE,s[1]=a>>24&255,s[2]=a>>16&255,s[3]=a>>8&255,s[4]=a&255,n.push(s);const d=[],c=Math.min(t.players.length,255);d.push(new Uint8Array([c]));for(const y of t.players){d.push(new Uint8Array([y.id&255]));const p=_t.indexOf(y.color);d.push(new Uint8Array([p>=0?p:0]));const A=Math.min(y.deck.length,255),S=Math.min(y.hand.length,255),h=Math.min(y.discard.length,255);d.push(new Uint8Array([A,S,h,y.announcedCard?1:0])),d.push(new Uint8Array([Math.min(y.score,255)]));const w=Math.min(y.hand.length,255);d.push(new Uint8Array([w]));const _=y.id===r;for(const g of y.hand)_?d.push(rr(g,e)):d.push(Is(g,e,y.id));const m=Math.min(y.discard.length,255);d.push(new Uint8Array([m]));for(const g of y.discard){const k=Tr(g.id),R=new Uint8Array(4);R[0]=k>>24&255,R[1]=k>>16&255,R[2]=k>>8&255,R[3]=k&255,d.push(R)}y.announcedCard&&d.push(rr(y.announcedCard,e))}const o=t.board.length;d.push(new Uint8Array([o,o,o]));const i=[];for(let y=0;y<t.board.length;y++)for(let p=0;p<((u=t.board[y])==null?void 0:u.length);p++){const A=t.board[y][p];A!=null&&A.card&&i.push({row:y,col:p,card:A.card})}const E=i.length,P=new Uint8Array(2);P[0]=E>>8&255,P[1]=E&255,d.push(P);for(const{row:y,col:p,card:A}of i)d.push(new Uint8Array([y,p])),d.push(rr(A,e));d.push(new Uint8Array([t.currentPhase===void 0?255:Math.clamp(t.currentPhase,0,254),(t.activePlayerId??255)&255,t.currentRound===void 0?255:Math.clamp(t.currentRound,0,254)]));let T=0;for(const y of d)T+=y.length;s[5]=T>>8&255,s[6]=T&255,n.push(...d);const f=new Uint8Array(n.reduce((y,p)=>y+p.length,0));let D=0;for(const y of n)f.set(y,D),D+=y.length;return l.info(`[GameCodec] Encoded card state: ${f.length} bytes (${E} board cards, ${t.players.length} players)`),f}function Ts(t,e,r){let n=0;if(t[n++]!==ft.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++],t[n++]<<8|t[n++];const a=t[n++],s=[];for(let u=0;u<a;u++){const y=t[n++],p=t[n++],A=_t[p]||"blue",S=t[n++];t[n++],t[n++];const h=t[n++]===1,w=t[n++],_=t[n++],m=[],g=y===r;for(let x=0;x<_;x++)if(g)m.push(nr(t,n,e)),n+=13;else{const U=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++],N=t[n++],G=t[n++],$=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++];m.push({id:`card_${U}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:N,isFaceDown:(G&1)!==0,revealedTo:G&4?"all":void 0,statuses:fa($,y,e),isPlaceholder:!0})}const k=t[n++],R=[];for(let x=0;x<k;x++){const U=t[n++]<<24|t[n++]<<16|t[n++]<<8|t[n++];R.push({id:`discard_${U}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:y,isPlaceholder:!0})}let b=null;h&&(b=nr(t,n,e),n+=13);const O=[];for(let x=0;x<S;x++)O.push({id:`deck_${y}_${x}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:y,isPlaceholder:!0});s.push({id:y,name:`Player ${y}`,score:w,hand:m,deck:O,discard:R,announcedCard:b,selectedDeck:"Random",color:A,boardHistory:[]})}const d=t[n++];n++,n++;const c=t[n++]<<8|t[n++],o=[];for(let u=0;u<d;u++){const y=[];for(let p=0;p<d;p++)y.push({card:null});o.push(y)}for(let u=0;u<c;u++){const y=t[n++],p=t[n++],A=nr(t,n,e);n+=13,y<o.length&&p<o[y].length&&(o[y][p]={card:A})}const i=t[n++],E=t[n++],P=t[n++];return{players:s,board:o,currentPhase:i===255?void 0:i,activePlayerId:E===255?null:E,currentRound:P===255?void 0:P}}function nr(t,e,r){const a=`card_${t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++]}_${Date.now()}`,s=t[e++]<<8|t[e++],d=t[e++];let c=t[e++];c>127&&(c=c-256);const o=t[e++],i=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++],E=r.cardDefinitions[s],P=(E==null?void 0:E.baseId)||"";return{id:a,baseId:P,deck:"Random",name:(E==null?void 0:E.name)||"?",imageUrl:(E==null?void 0:E.imageUrl)||"",power:c,ability:(E==null?void 0:E.ability)||"",types:(E==null?void 0:E.types)||[],faction:(E==null?void 0:E.faction)||"",ownerId:d,isFaceDown:(o&1)!==0,enteredThisTurn:(o&2)!==0,revealedTo:o&4?"all":void 0,statuses:fa(i,0,r)}}Math.clamp||(Math.clamp=function(t,e,r){return Math.min(Math.max(t,e),r)});let ar=null;function ya(){return ar||(ar=ms()),ar}function zn(t,e){const r=ya();return Es(t,r,e)}function gs(t,e){const r=ya();return Ts(t,r,e)}function ws(t){return Yt(t)}function ha(t){l.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return pr(t)}catch(e){return l.error("[webrtcSerialization] Failed to serialize delta:",e),new Uint8Array(0)}}function ma(t){l.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Yt(t)}catch(e){return l.error("[webrtcSerialization] Failed to deserialize delta:",e),{}}}function _s(t){const e=ha(t);let r="";const n=new Uint8Array(e),a=n.byteLength;for(let s=0;s<a;s++)r+=String.fromCharCode(n[s]);return btoa(r)}function bs(t){const e=atob(t),r=new Uint8Array(e.length);for(let n=0;n<e.length;n++)r[n]=e.charCodeAt(n);return ma(r)}function As(t){var e,r,n,a,s;return t?{playerId:t.playerId,mode:((e=t.action)==null?void 0:e.mode)||t.mode,sourceCoords:t.sourceCoords,timestamp:t.timestamp,boardTargets:t.boardTargets,handTargets:t.handTargets,isDeckSelectable:t.isDeckSelectable,originalOwnerId:t.originalOwnerId,sourceCardName:(n=(r=t.action)==null?void 0:r.sourceCard)==null?void 0:n.name,sourceCardId:(s=(a=t.action)==null?void 0:a.sourceCard)==null?void 0:s.id}:null}function Ss(t){try{const e={...t};e.targetingMode&&(e.targetingMode=As(e.targetingMode));const r=pr(e),n=String.fromCharCode(...r);return btoa(n)}catch(e){throw l.error("[serializePersonalizedState] Failed to encode:",e),e}}function Kn(t){try{const e=atob(t),r=new Uint8Array(e.length);for(let a=0;a<e.length;a++)r[a]=e.charCodeAt(a);const n=Yt(r);return l.info("[deserializePersonalizedizedState] Decoded state, has players:",!!n.players,"keys:",Object.keys(n)),n}catch(e){throw l.error("[deserializePersonalizedState] Failed to decode:",e),e}}function qn(t){try{const e=t.map(a=>a.baseId||a.id),r=pr(e),n=String.fromCharCode(...r);return btoa(n)}catch(e){throw l.error("[serializeDeckCards] Failed to encode:",e),e}}function Vn(t,e){try{const r=atob(t),n=new Uint8Array(r.length);for(let d=0;d<r.length;d++)n[d]=r.charCodeAt(d);const a=Yt(n),{getCardDefinition:s}=require("../content");return a.map((d,c)=>{const o=s(d);return o?{id:`${e}_deck_${c}_${Date.now()}`,baseId:d,name:o.name,imageUrl:o.imageUrl,power:o.power||0,ability:o.ability||"",types:o.types||[],faction:o.faction||"",color:o.color||"Red",ownerId:e,isFaceDown:!0,statuses:[]}:{id:`${e}_deck_${c}_${Date.now()}`,baseId:d,name:"Unknown",imageUrl:"",power:0,ownerId:e,isFaceDown:!0,statuses:[]}})}catch(r){throw l.error("[deserializeDeckCards] Failed to decode:",r),r}}function Cs(t,e){var P;const r=new TextEncoder,n=[],a=Date.now(),s=new Uint8Array(7);s[0]=ft.ABILITY_EFFECT,s[1]=a>>24&255,s[2]=a>>16&255,s[3]=a>>8&255,s[4]=a&255,n.push(s);const d=[];if(d.push(new Uint8Array([t])),e.sourcePos){const T=(e.sourcePos.row&15)<<4|e.sourcePos.col&15;d.push(new Uint8Array([T]))}else d.push(new Uint8Array([255]));const c=((P=e.targetPositions)==null?void 0:P.length)||0;if(d.push(new Uint8Array([Math.min(c,255)])),e.targetPositions)for(const T of e.targetPositions.slice(0,255)){const f=(T.row&15)<<4|T.col&15;d.push(new Uint8Array([f]))}if(e.text){const T=r.encode(e.text),f=Math.min(T.length,255);d.push(new Uint8Array([f])),d.push(T.slice(0,f))}else d.push(new Uint8Array([0]));d.push(new Uint8Array([(e.value??0)&255])),d.push(new Uint8Array([(e.playerId??0)&255]));let o=0;for(const T of d)o+=T.length;s[5]=o>>8&255,s[6]=o&255,n.push(...d);const i=new Uint8Array(n.reduce((T,f)=>T+f.length,0));let E=0;for(const T of n)i.set(T,E),E+=T.length;return l.debug(`[AbilityMessages] Encoded effect type ${t}: ${i.length} bytes`),i}function Ds(t){let e=0;if(t[e++]!==ft.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const r=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];e+=2;const n={effectType:t[e++],timestamp:r,data:{}},a=t[e++];a!==255&&(n.data.sourcePos={row:a>>4&15,col:a&15});const s=t[e++];if(s>0){n.data.targetPositions=[];for(let c=0;c<s;c++){const o=t[e++];n.data.targetPositions.push({row:o>>4&15,col:o&15})}}const d=t[e++];if(d>0){const c=new TextDecoder;n.data.text=c.decode(t.subarray(e,e+d)),e+=d}return n.data.value=t[e++],n.data.playerId=t[e++],n}function Rs(t,e={}){const r=new TextEncoder,n=[],a=Date.now(),s=new Uint8Array(7);s[0]=ft.SESSION_EVENT,s[1]=a>>24&255,s[2]=a>>16&255,s[3]=a>>8&255,s[4]=a&255,n.push(s);const d=[];if(d.push(new Uint8Array([t])),d.push(new Uint8Array([(e.playerId??0)&255])),e.playerName){const P=r.encode(e.playerName),T=Math.min(P.length,255);d.push(new Uint8Array([T])),d.push(P.slice(0,T))}else d.push(new Uint8Array([0]));d.push(new Uint8Array([(e.startingPlayerId??0)&255])),d.push(new Uint8Array([Math.min(e.roundNumber??0,255)])),d.push(new Uint8Array([Math.min(e.newPhase??0,255)])),d.push(new Uint8Array([(e.newActivePlayerId??0)&255])),d.push(new Uint8Array([(e.gameWinner??255)&255]));let c=0;if(e.winners)for(const P of e.winners)P<32&&(c|=1<<P);d.push(new Uint8Array([c>>24&255,c>>16&255,c>>8&255,c&255]));let o=0;for(const P of d)o+=P.length;s[5]=o>>8&255,s[6]=o&255,n.push(...d);const i=new Uint8Array(n.reduce((P,T)=>P+T.length,0));let E=0;for(const P of n)i.set(P,E),E+=P.length;return l.debug(`[SessionMessages] Encoded event type ${t}: ${i.length} bytes`),i}function Ps(t){let e=0;if(t[e++]!==ft.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const r=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];e+=2;const n={eventType:t[e++],timestamp:r,data:{}};n.data.playerId=t[e++];const a=t[e++];if(a>0){const c=new TextDecoder;n.data.playerName=c.decode(t.subarray(e,e+a)),e+=a}n.data.startingPlayerId=t[e++],n.data.roundNumber=t[e++],n.data.newPhase=t[e++],n.data.newActivePlayerId=t[e++];const s=t[e++];n.data.gameWinner=s===255?null:s;const d=t[e++]<<24|t[e++]<<16|t[e++]<<8|t[e++];if(d!==0){n.data.winners=[];for(let c=0;c<32;c++)d&1<<c&&n.data.winners.push(c)}return n}function wt(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier||0,isFaceDown:t.isFaceDown,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck,ability:t.ability,color:t.color,types:t.types,faction:t.faction,imageUrl:t.imageUrl}}function jn(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck}}function ze(t){return{id:t.id,baseId:t.baseId||t.id,power:t.power,powerModifier:t.powerModifier||0,isFaceDown:t.isFaceDown??!1,statuses:t.statuses||[]}}function ks(t,e){const r={...t,players:t.players.map(n=>{const a=e!==null&&n.id===e,s=n.isDummy===!0;if(a){const d=n.deck.length??0,c=n.discard.length??0,o=n.hand.length??0;return l.debug(`[createPersonalizedGameState] Player ${n.id} (own): ${o} hand, ${d} deck, ${c} discard`),{...n,handCards:n.hand.map(i=>ze(i)),deckCards:n.deck.map(i=>ze(i)),discardCards:n.discard.map(i=>ze(i)),hand:[],deck:[],discard:[],announcedCard:n.announcedCard?wt(n.announcedCard):null,deckSize:d,discardSize:c,handSize:o}}else if(s){const d=n.deck.length??0,c=n.discard.length??0,o=n.hand.length??0;return l.info(`[createPersonalizedGameState] Player ${n.id} (dummy): sending ${o} hand, ${d} deck, ${c} discard`),{...n,handCards:n.hand.map(i=>ze(i)),deckCards:n.deck.map(i=>ze(i)),discardCards:n.discard.map(i=>ze(i)),hand:[],deck:[],discard:[],announcedCard:n.announcedCard?wt(n.announcedCard):null,deckSize:d,discardSize:c,handSize:o}}else{const d=n.deckSize??n.deck.length??0,c=n.hand.filter(o=>!o.isFaceDown).length;return c>0&&l.debug(`[createPersonalizedGameState] Player ${n.id} (other): ${c} revealed, ${n.hand.length-c} face-down`),{...n,hand:n.hand.map(o=>o.isFaceDown?jn(o):{id:o.id,baseId:o.baseId,power:o.power,powerModifier:o.powerModifier||0,isFaceDown:o.isFaceDown,statuses:o.statuses||[],ownerId:o.ownerId,ownerName:o.ownerName,deck:o.deck}),deck:[],discard:[],announcedCard:n.announcedCard?jn(n.announcedCard):null,deckSize:d,handSize:n.handSize??n.hand.length??0,discardSize:n.discardSize??n.discard.length??0}}}),board:t.board.map(n=>n.map(a=>({...a,card:a.card?wt(a.card):null})))};return l.debug(`[createPersonalizedGameState] Created personalized state for recipient=${e}, currentPhase=${r.currentPhase}, activePlayerId=${r.activePlayerId}`),r}function Os(t,e){return{...t,players:t.players.map(r=>{if(r.id===e)return l.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(n=>ze(n)),deckCards:r.deck.map(n=>ze(n)),discardCards:r.discard.map(n=>ze(n)),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?wt(r.announcedCard):null,deckSize:r.deck.length,discardSize:r.discard.length,handSize:r.hand.length};{const a=r.hand.filter(c=>c.statuses&&c.statuses.length>0).length>0,s=r.isDummy===!0,d={...r,...a&&{handCards:r.hand.map(c=>ze(c))},hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0};return s&&(l.info(`[createCompactStateForHost] Dummy player ${r.id}: sending ${r.hand.length} hand, ${r.deck.length} deck, ${r.discard.length} discard`),d.handCards=r.hand.map(c=>ze(c)),d.deckCards=r.deck.map(c=>ze(c)),d.discardCards=r.discard.map(c=>ze(c))),r.id===e?l.info(`[createCompactStateForHost] Local player ${r.id} score: ${r.score}`):l.info(`[createCompactStateForHost] Other player ${r.id} (${s?"dummy":"real"}) score: ${d.score} (from original)`),d}}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?wt(n.card):null})))}}class vs{constructor(e={}){this.peer=null,this.connections=new Map,this.guests=new Map,this.eventHandlers=new Set,this.reconnectingPlayers=new Map,this.reconnectionTimeout=3e4,this.config={maxGuests:e.maxGuests??4,autoAcceptGuests:e.autoAcceptGuests??!0,enableReconnection:e.enableReconnection??!1},localStorage.getItem("webrtc_enabled")}async initialize(){return this.peer&&this.cleanup(),new Promise((e,r)=>{this.peer=new $t,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),e(n)}),this.peer.on("connection",n=>{l.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{l.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{l.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}handleGuestConnection(e){const r=e.peer;if(this.config.maxGuests&&this.connections.size>=this.config.maxGuests){l.warn(`Max guests limit reached: ${this.connections.size}/${this.config.maxGuests}`),e.close();return}const n={peerId:r,playerId:null,playerName:null,connected:!1,connectedAt:Date.now()};this.connections.set(r,e),this.guests.set(r,n),e.on("open",()=>{n.connected=!0,this.emitEvent({type:"guest_connected",data:{peerId:r}})}),e.on("data",a=>{this.handleMessage(a,r)}),e.on("close",()=>{const a=this.guests.get(r),s=a==null?void 0:a.playerId;this.connections.delete(r),this.guests.delete(r),s!=null&&this.config.enableReconnection&&this.markPlayerReconnecting(s,r),this.emitEvent({type:"guest_disconnected",data:{peerId:r,playerId:s}})}),e.on("error",a=>{l.error(`Guest connection error (${r}):`,a)})}handleMessage(e,r){var s,d,c;const n=this.guests.get(r),a=(n==null?void 0:n.playerId)??e.playerId??"unknown";e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE"?l.info(`[HostConnectionManager] Received ${e.type} from peer ${r} (player ${a})`,{hasData:!!e.data,hasTargetingMode:!!((s=e.data)!=null&&s.targetingMode),targetingModePlayerId:(c=(d=e.data)==null?void 0:d.targetingMode)==null?void 0:c.playerId,timestamp:e.timestamp}):l.debug(`Received WebRTC message from ${r}:`,e.type),this.emitEvent({type:"message_received",data:{message:e,fromPeerId:r}})}sendToGuest(e,r){const n=this.connections.get(e);if(!n)return l.error(`[sendToGuest] No connection found for ${e}`),!1;if(!n.open)return l.error(`[sendToGuest] Connection for ${e} is not open`),!1;try{return l.info(`[sendToGuest] Sending ${r.type} to ${e}`),n.send(r),l.info(`[sendToGuest] Sent ${r.type} to ${e} successfully`),!0}catch(a){return l.error(`[sendToGuest] Failed to send message to ${e}:`,a),!1}}broadcast(e,r){let n=0;return this.connections.forEach((a,s)=>{if(a.open&&s!==r)try{a.send(e),n++}catch(d){l.error(`Failed to send to guest ${s}:`,d)}}),l.debug(`Broadcast to ${n}/${this.connections.size} guests`),n}acceptGuestMinimal(e,r,n){var c;const a=this.connections.get(e);if(!a)return l.error(`[acceptGuestMinimal] No connection found for ${e}`),!1;if(!a.open)return l.error(`[acceptGuestMinimal] Connection for ${e} is not open`),!1;const s=this.guests.get(e);s&&(s.playerId=n);const d={type:"JOIN_ACCEPT_MINIMAL",senderId:(c=this.peer)==null?void 0:c.id,playerId:n,data:r,timestamp:Date.now()};try{return a.send(d),l.info(`Accepted guest ${e} as player ${n} (minimal)`),!0}catch(o){return l.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${e}:`,o),!1}}acceptGuest(e,r,n){var d;const a=this.connections.get(e);if(!a)return l.error(`[acceptGuest] No connection found for ${e}`),!1;if(!a.open)return l.error(`[acceptGuest] Connection for ${e} is not open`),!1;const s=this.guests.get(e);s&&(s.playerId=n);try{const c=zn(r,n),o=btoa(String.fromCharCode(...c)),i={type:"JOIN_ACCEPT_BINARY",senderId:(d=this.peer)==null?void 0:d.id,playerId:n,data:o,timestamp:Date.now()};return a.send(i),l.info(`[acceptGuest] Sent JOIN_ACCEPT_BINARY to ${e}, state size: ${o.length} chars`),!0}catch(c){return l.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${e}:`,c),!1}}broadcastGameState(e,r){if(this.connections.size===0)return;const n=e.players.map(s=>`P${s.id}:${s.score}`).join(", ");l.info(`[broadcastGameState] Broadcasting state with scores: ${n}, currentPhase=${e.currentPhase}, activePlayerId=${e.activePlayerId}`);let a=0;this.connections.forEach((s,d)=>{var o;if(!s.open||r&&d===r)return;const c=this.guests.get(d);if(c)try{const i=ks(e,c.playerId),E=Ss(i),P={type:"STATE_UPDATE_COMPACT",senderId:(o=this.peer)==null?void 0:o.id,data:{gameState:E,_format:"msgpack"},timestamp:Date.now()};s.send(P),a++}catch(i){l.error(`[broadcastGameState] Failed to send to guest ${d} (player ${c.playerId}):`,i)}}),l.debug(`[broadcastGameState] Sent to ${a}/${this.connections.size} guests`)}broadcastStateDelta(e,r){var n,a;{const s=_s(e),d={type:"STATE_DELTA_BINARY",senderId:(n=this.peer)==null?void 0:n.id,data:s,timestamp:Date.now()};l.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${s.length} chars, playerDeltas=${Object.keys(e.playerDeltas||{}).length}, boardCells=${((a=e.boardCells)==null?void 0:a.length)||0}`),this.broadcast(d,r),l.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${e.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(e,r,n){var a;try{const s=zn(e,r),d=btoa(String.fromCharCode(...s)),c={type:"CARD_STATE",senderId:(a=this.peer)==null?void 0:a.id,data:d,timestamp:Date.now()},o=this.broadcast(c,n);return l.info(`[broadcastCardState] Sent ${s.length} bytes to ${o} guests`),o}catch(s){return l.error("[broadcastCardState] Failed to encode/broadcast state:",s),0}}broadcastAbilityEffect(e,r,n){var a;try{const s=Cs(e,r),d=btoa(String.fromCharCode(...s)),c={type:"ABILITY_EFFECT",senderId:(a=this.peer)==null?void 0:a.id,data:d,timestamp:Date.now()},o=this.broadcast(c,n);return l.debug(`[broadcastAbilityEffect] Sent effect ${e} to ${o} guests`),o}catch(s){return l.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",s),0}}broadcastSessionEvent(e,r,n){var a;try{const s=Rs(e,r),d=btoa(String.fromCharCode(...s)),c={type:"SESSION_EVENT",senderId:(a=this.peer)==null?void 0:a.id,data:d,timestamp:Date.now()},o=this.broadcast(c,n);return l.debug(`[broadcastSessionEvent] Sent event ${e} to ${o} guests`),o}catch(s){return l.error("[broadcastSessionEvent] Failed to encode/broadcast event:",s),0}}broadcastHighlight(e,r,n,a){return this.broadcastAbilityEffect(Dt.HIGHLIGHT_CELL,{sourcePos:{row:e,col:r},playerId:n},a)}broadcastFloatingText(e,r,n,a){return this.broadcastAbilityEffect(Dt.FLOATING_TEXT,{sourcePos:{row:e,col:r},text:n},a)}broadcastTargetingMode(e,r,n){return this.broadcastAbilityEffect(Dt.TARGETING_MODE,{sourcePos:e,targetPositions:r},n)}broadcastClearTargeting(e){return this.broadcastAbilityEffect(Dt.CLEAR_TARGETING,{},e)}broadcastPlayerConnected(e,r,n){return this.broadcastSessionEvent(1,{playerId:e,playerName:r},n)}broadcastPlayerDisconnected(e,r){return this.broadcastSessionEvent(2,{playerId:e},r)}broadcastGameStart(e,r){return this.broadcastSessionEvent(3,{startingPlayerId:e},r)}broadcastRoundStart(e,r){return this.broadcastSessionEvent(4,{roundNumber:e},r)}broadcastRoundEnd(e,r,n){return this.broadcastSessionEvent(5,{roundNumber:e,winners:r},n)}broadcastPhaseChange(e,r,n){return this.broadcastSessionEvent(6,{newPhase:e,newActivePlayerId:r},n)}broadcastTurnChange(e,r){return this.broadcastSessionEvent(7,{newActivePlayerId:e},r)}broadcastGameEnd(e,r){return this.broadcastSessionEvent(8,{gameWinner:e},r)}sendAction(e,r){var a;const n={type:"ACTION",senderId:(a=this.peer)==null?void 0:a.id,data:{actionType:e,actionData:r},timestamp:Date.now()};return this.broadcast(n)>0}getConnectionInfo(){const e=[];return this.connections.forEach((r,n)=>{const a=this.guests.get(n);e.push({peerId:n,playerId:(a==null?void 0:a.playerId)||null,playerName:(a==null?void 0:a.playerName)||null,connected:r.open})}),e}getGuest(e){return this.guests.get(e)}getGuestByPlayerId(e){return Array.from(this.guests.values()).find(r=>r.playerId===e)}setGuestPlayerId(e,r){const n=this.guests.get(e);n&&(n.playerId=r)}getPeerId(){var e;return((e=this.peer)==null?void 0:e.id)||null}getGuestCount(){return this.connections.size}hasGuests(){return Array.from(this.connections.values()).some(e=>e.open)}markPlayerReconnecting(e,r){this.reconnectingPlayers.set(e,{disconnectedAt:Date.now(),oldPeerId:r}),setTimeout(()=>{const n=this.reconnectingPlayers.get(e);n&&Date.now()-n.disconnectedAt>=this.reconnectionTimeout&&this.reconnectingPlayers.delete(e)},this.reconnectionTimeout),l.info(`[Reconnection] Player ${e} marked as reconnecting, window: ${this.reconnectionTimeout}ms`)}isPlayerReconnecting(e){const r=this.reconnectingPlayers.get(e);return r?Date.now()-r.disconnectedAt>=this.reconnectionTimeout?(this.reconnectingPlayers.delete(e),!1):!0:!1}getPlayerReconnectTimeRemaining(e){const r=this.reconnectingPlayers.get(e);if(!r)return 0;const n=Date.now()-r.disconnectedAt;return Math.max(0,this.reconnectionTimeout-n)}acceptPlayerReconnect(e,r,n){var d;if(!this.isPlayerReconnecting(r))return l.warn(`[Reconnection] Player ${r} not in reconnection window or expired`),!1;const a=this.connections.get(e);if(!a||!a.open)return l.error(`[Reconnection] No valid connection for ${e}`),!1;this.reconnectingPlayers.delete(r);const s={type:"RECONNECT_ACCEPT",senderId:(d=this.peer)==null?void 0:d.id,playerId:r,data:{gameState:n},timestamp:Date.now()};try{a.send(s),l.info(`[Reconnection] Player ${r} reconnected from ${e}`);const c=this.guests.get(e);return c&&(c.playerId=r),!0}catch(c){return l.error("[Reconnection] Failed to send RECONNECT_ACCEPT:",c),!1}}rejectPlayerReconnect(e,r){var s;const n=this.connections.get(e);if(!n||!n.open)return;const a={type:"RECONNECT_REJECT",senderId:(s=this.peer)==null?void 0:s.id,data:{reason:r},timestamp:Date.now()};try{n.send(a),n.close(),l.info(`[Reconnection] Rejected reconnection from ${e}, reason: ${r}`)}catch(d){l.error("[Reconnection] Failed to send RECONNECT_REJECT:",d)}}getReconnectingPlayers(){const e=Date.now(),r=[];return this.reconnectingPlayers.forEach((n,a)=>{e-n.disconnectedAt<this.reconnectionTimeout?r.push(a):this.reconnectingPlayers.delete(a)}),r}cancelPlayerReconnection(e){this.reconnectingPlayers.delete(e)}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>{try{r(e)}catch(n){l.error("Error in WebRTC event handler:",n)}})}cleanup(){if(this.connections.forEach(e=>e.close()),this.connections.clear(),this.guests.clear(),this.reconnectingPlayers.clear(),this.peer){try{this.peer.destroy()}catch{}this.peer=null}}}class Ns{constructor(){this.peer=null,this.connections=new Map,this.eventHandlers=new Set,localStorage.getItem("webrtc_enabled")}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>r(e))}getPeerId(){var e;return((e=this.peer)==null?void 0:e.id)??null}getConnection(e){return this.connections.get(e)}getAllConnections(){return this.connections}isInitialized(){return this.peer!==null}async initializeAsHost(e){return this.peer&&this.cleanup(),new Promise((r,n)=>{this.peer=e?new $t(e):new $t,this.peer.on("open",a=>{this.emitEvent({type:"peer_open",data:{peerId:a}}),r(a)}),this.peer.on("connection",a=>{l.info(`Incoming connection from: ${a.peer}`),this.handleConnection(a)}),this.peer.on("error",a=>{l.error("WebrtcPeer error:",a),this.emitEvent({type:"error",data:a}),n(a)}),this.peer.on("close",()=>{l.warn("WebrtcPeer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(){return this.peer&&this.cleanup(),new Promise((e,r)=>{this.peer=new $t,this.peer.on("open",n=>{e(n)}),this.peer.on("error",n=>{l.error("WebrtcPeer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{l.warn("WebrtcPeer closed"),this.emitEvent({type:"peer_closed"})})})}connectTo(e){if(!this.peer)return l.error("Cannot connect: peer not initialized"),null;const r=this.peer.connect(e,{reliable:!0,serialization:"json"});return this.handleConnection(r),r}handleConnection(e){this.connections.set(e.peer,e),e.on("open",()=>{l.info(`Connection opened: ${e.peer}`),this.emitEvent({type:"connection_open",data:{peerId:e.peer}})}),e.on("data",r=>{this.emitEvent({type:"connection_data",data:{peerId:e.peer,data:r}})}),e.on("close",()=>{l.info(`Connection closed: ${e.peer}`),this.connections.delete(e.peer),this.emitEvent({type:"connection_closed",data:{peerId:e.peer}})}),e.on("error",r=>{l.error(`Connection error (${e.peer}):`,r),this.emitEvent({type:"error",data:{peerId:e.peer,error:r}})})}sendTo(e,r){const n=this.connections.get(e);if(!n)return l.error(`[sendTo] No connection found for peer ${e}`),!1;if(!n.open)return l.error(`[sendTo] Connection for peer ${e} is not open`),!1;try{return n.send(r),!0}catch(a){return l.error(`[sendTo] Failed to send to ${e}:`,a),!1}}broadcast(e,r){let n=0;return this.connections.forEach((a,s)=>{if(a.open&&s!==r)try{a.send(e),n++}catch(d){l.error(`[broadcast] Failed to send to ${s}:`,d)}}),n}closeConnection(e){const r=this.connections.get(e);r&&(r.close(),this.connections.delete(e))}cleanup(){if(this.connections.forEach(e=>{try{e.close()}catch{}}),this.connections.clear(),this.peer){try{this.peer.destroy()}catch{}this.peer=null}}getPeer(){return this.peer}}class Jn{constructor(e={}){this.hostPeerId=null,this.eventHandlers=new Set,this.config=e,this.webrtcPeer=new Ns,this.webrtcPeer.on(r=>this.handlePeerEvent(r)),localStorage.getItem("webrtc_enabled")}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>r(e))}handlePeerEvent(e){var r,n,a,s,d,c;switch(e.type){case"peer_open":this.hostPeerId&&this.webrtcPeer.connectTo(this.hostPeerId);break;case"connection_open":l.info(`Connected to host: ${e.data.peerId}`),this.emitEvent({type:"connected_to_host",data:{hostPeerId:e.data.peerId}}),(n=(r=this.config).onHostConnected)==null||n.call(r);break;case"connection_closed":l.warn("Host connection closed"),this.emitEvent({type:"host_disconnected"}),(s=(a=this.config).onHostDisconnected)==null||s.call(a);break;case"connection_data":this.handleMessage(e.data.data);break;case"error":l.error("WebRTC error:",e.data),this.emitEvent({type:"error",data:e.data}),(c=(d=this.config).onError)==null||c.call(d,e.data);break}}handleMessage(e){var r,n;e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE"||e.type==="JOIN_ACCEPT_MINIMAL"||e.type==="JOIN_ACCEPT"?l.info(`[GuestConnection] Received ${e.type} from host`,{senderId:e.senderId,playerId:e.playerId,hasData:!!e.data,timestamp:e.timestamp}):l.info(`[GuestConnection] Received ${e.type} from host`),this.emitEvent({type:"message_received",data:e}),(n=(r=this.config).onMessage)==null||n.call(r,e)}async connect(e){if(this.hostPeerId=e,await this.webrtcPeer.initializeAsGuest(),this.webrtcPeer.isInitialized()){const r=this.webrtcPeer.connectTo(e);if(!r)throw new Error("Failed to create connection to host");return new Promise((n,a)=>{const s=setTimeout(()=>{a(new Error("Connection timeout"))},1e4),d=()=>{clearTimeout(s);let o=null;try{const i=localStorage.getItem("webrtc_preferred_deck");i&&(o=i,l.info(`[connect] Found deck preference in localStorage: ${o}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(i){l.warn("[connect] Failed to read deck preference:",i)}this.sendMessage({type:"JOIN_REQUEST",senderId:this.getPeerId()??void 0,data:{preferredDeck:o||void 0},timestamp:Date.now()}),n()},c=o=>{clearTimeout(s),a(o)};r.once("open",d),r.once("error",c)})}}async connectAsReconnecting(e,r){this.hostPeerId=e,await this.webrtcPeer.initializeAsGuest();const n=this.webrtcPeer.connectTo(e);if(!n)throw new Error("Failed to create connection to host");return new Promise((a,s)=>{const d=setTimeout(()=>{s(new Error("Reconnection timeout"))},1e4),c=()=>{clearTimeout(d),this.sendMessage({type:"PLAYER_RECONNECT",senderId:this.getPeerId()??void 0,playerId:r,timestamp:Date.now()}),a()},o=i=>{clearTimeout(d),s(i)};n.once("open",c),n.once("error",o)})}sendMessage(e){var n,a,s;if(!this.hostPeerId)return l.warn("[GuestConnection] Not connected to host"),!1;const r=this.webrtcPeer.sendTo(this.hostPeerId,e);return(e.type==="SET_TARGETING_MODE"||e.type==="CLEAR_TARGETING_MODE")&&(r?l.info(`[GuestConnection] Sent ${e.type} to host`,{hasData:!!e.data,hasTargetingMode:!!((n=e.data)!=null&&n.targetingMode),targetingModePlayerId:(s=(a=e.data)==null?void 0:a.targetingMode)==null?void 0:s.playerId,timestamp:e.timestamp}):l.warn(`[GuestConnection] Could not send ${e.type} to host`)),r}sendAction(e,r){const n={type:"ACTION",senderId:this.getPeerId()??void 0,data:{actionType:e,actionData:r},timestamp:Date.now()};return this.sendMessage(n)}sendStateDelta(e){{const r=ha(e),n={type:"STATE_DELTA_BINARY",senderId:this.getPeerId()??void 0,data:r,timestamp:Date.now()};return this.sendMessage(n)}}sendStateToHost(e,r){var d,c;if(r===null)return l.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const n=Os(e,r),a=e.players.find(o=>o.id===r);a&&l.info(`[sendStateToHost] Player ${r} sending compact state: hand=${((d=a.hand)==null?void 0:d.length)??0}, deck=${((c=a.deck)==null?void 0:c.length)??0}, score=${a.score}`);const s={type:"STATE_UPDATE_COMPACT",senderId:this.getPeerId()??void 0,playerId:r,data:{gameState:n},timestamp:Date.now()};return this.sendMessage(s)}sendFullDeckToHost(e,r,n){const a={type:"DECK_DATA_UPDATE",senderId:this.getPeerId()??void 0,playerId:e,data:{playerId:e,deck:r.map(s=>wt(s)),deckSize:n},timestamp:Date.now()};return this.sendMessage(a)}sendCustomDeckData(e,r,n){if(!n)return!0;l.info(`[sendCustomDeckData] Player ${e} sending ${r.length} custom deck cards to host`);const a=r.map(d=>({id:d.id,baseId:d.baseId,name:d.name,power:d.power,powerModifier:d.powerModifier,ability:d.ability,types:d.types,faction:d.faction,imageUrl:d.imageUrl,color:d.color,deck:d.deck})),s={type:"CUSTOM_DECK_DATA",senderId:this.getPeerId()??void 0,playerId:e,data:{playerId:e,deckCards:a},timestamp:Date.now()};return this.sendMessage(s)}getPeerId(){return this.webrtcPeer.getPeerId()}getHostPeerId(){return this.hostPeerId}isConnected(){if(!this.hostPeerId)return!1;const e=this.webrtcPeer.getConnection(this.hostPeerId);return(e==null?void 0:e.open)??!1}getConnectionCount(){return this.isConnected()?1:0}getConnectionInfo(){if(!this.hostPeerId)return[];const e=this.webrtcPeer.getConnection(this.hostPeerId);return[{peerId:this.hostPeerId,playerId:null,playerName:null,connected:(e==null?void 0:e.open)??!1}]}cleanup(){this.webrtcPeer.cleanup(),this.hostPeerId=null}}class Ms{constructor(){this.mode=null,this.hostManager=null,this.guestManager=null,this.eventHandlers=new Set,this.isReconnecting=!1}async initializeAsHost(e){return this.mode==="guest"&&this.cleanup(),this.mode="host",this.hostManager=new vs({enableReconnection:!0}),this.hostManager.on(r=>this.emitEvent(r)),this.hostManager.initialize()}async initializeAsGuest(e){this.mode==="host"&&this.cleanup(),this.mode="guest",this.guestManager=new Jn({onMessage:r=>this.emitEvent({type:"message_received",data:r}),onHostConnected:()=>this.emitEvent({type:"connected_to_host"}),onHostDisconnected:()=>this.emitEvent({type:"host_disconnected"}),onError:r=>this.emitEvent({type:"error",data:r})}),await this.guestManager.connect(e)}async initializeAsReconnectingGuest(e,r){this.mode==="host"&&this.cleanup(),this.mode="guest",this.isReconnecting=!0,this.guestManager=new Jn({onMessage:n=>this.emitEvent({type:"message_received",data:n}),onHostConnected:()=>{this.isReconnecting=!1,this.emitEvent({type:"connected_to_host"})},onHostDisconnected:()=>this.emitEvent({type:"host_disconnected"}),onError:n=>{this.isReconnecting=!1,this.emitEvent({type:"error",data:n})}}),await this.guestManager.connectAsReconnecting(e,r),this.isReconnecting=!1}acceptGuest(e,r,n){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.acceptGuest(e,r,n)}acceptGuestMinimal(e,r,n){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.acceptGuestMinimal(e,r,n)}broadcastGameState(e,r){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.broadcastGameState(e,r)}broadcastStateDelta(e,r){if(!this.hostManager){l.warn("[WebrtcManager] Not in host mode");return}this.hostManager.broadcastStateDelta(e,r)}broadcastToGuests(e,r){return this.hostManager?this.hostManager.broadcast(e,r):(l.warn("[WebrtcManager] Not in host mode"),0)}sendToGuest(e,r){return this.hostManager?this.hostManager.sendToGuest(e,r):(l.warn("[WebrtcManager] Not in host mode"),!1)}sendAction(e,r){return this.guestManager?this.guestManager.sendAction(e,r):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendStateDelta(e){return this.guestManager?this.guestManager.sendStateDelta(e):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendStateToHost(e,r){return this.guestManager?this.guestManager.sendStateToHost(e,r):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendFullDeckToHost(e,r,n){return this.guestManager?this.guestManager.sendFullDeckToHost(e,r,n):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendCustomDeckData(e,r,n){return this.guestManager?this.guestManager.sendCustomDeckData(e,r,n):(l.warn("[WebrtcManager] Not in guest mode"),!1)}sendMessageToHost(e){return this.mode!=="guest"||!this.guestManager?!1:this.guestManager.sendMessage(e)}broadcastCardState(e,r,n){return this.hostManager?this.hostManager.broadcastCardState(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}broadcastAbilityEffect(e,r,n){return this.hostManager?this.hostManager.broadcastAbilityEffect(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}broadcastSessionEvent(e,r,n){return this.hostManager?this.hostManager.broadcastSessionEvent(e,r,n):(l.warn("[WebrtcManager] Not in host mode"),0)}getPeerId(){return this.mode==="host"&&this.hostManager?this.hostManager.getPeerId():this.mode==="guest"&&this.guestManager?this.guestManager.getPeerId():null}getHostPeerId(){return this.mode==="guest"&&this.guestManager?this.guestManager.getHostPeerId():this.mode==="host"&&this.hostManager?this.hostManager.getPeerId():null}getConnectionInfo(){return this.mode==="host"&&this.hostManager?this.hostManager.getConnectionInfo():this.mode==="guest"&&this.guestManager?this.guestManager.getConnectionInfo():[]}isConnected(){return this.mode==="host"&&this.hostManager?this.hostManager.hasGuests():this.mode==="guest"&&this.guestManager?this.guestManager.isConnected():!1}isHostMode(){return this.mode==="host"}getConnectionCount(){return this.mode==="host"&&this.hostManager?this.hostManager.getGuestCount():this.mode==="guest"&&this.guestManager?this.guestManager.getConnectionCount():0}getGuest(e){if(this.hostManager)return this.hostManager.getGuest(e)}getGuestByPlayerId(e){if(this.hostManager)return this.hostManager.getGuestByPlayerId(e)}setGuestPlayerId(e,r){this.hostManager&&this.hostManager.setGuestPlayerId(e,r)}isPlayerReconnecting(e){return this.hostManager?this.hostManager.isPlayerReconnecting(e):!1}on(e){return this.eventHandlers.add(e),()=>this.eventHandlers.delete(e)}emitEvent(e){this.eventHandlers.forEach(r=>{try{r(e)}catch(n){l.error("Error in WebRTC event handler:",n)}})}cleanup(){this.hostManager&&(this.hostManager.cleanup(),this.hostManager=null),this.guestManager&&(this.guestManager.cleanup(),this.guestManager=null),this.mode=null,this.isReconnecting=!1}get peer(){return this.mode==="host"&&this.hostManager||this.mode==="guest"&&this.guestManager,null}}let or=null;const fr=()=>(or||(or=new Ms),or);function Ls(t){return 10+t*10}function gr(t){if(!t.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const e=t.currentPhase===1,r=t.activePlayerId===t.startingPlayerId;if(!e||!r)return{shouldEnd:!1,roundWinners:[]};const n=t.currentRound||1,a=Ls(n),s=[];for(const c of t.players)!c.isDummy&&!c.isDisconnected&&c.score>=a&&s.push(c.id);return{shouldEnd:s.length>0,roundWinners:s}}function Ia(t){const{shouldEnd:e,roundWinners:r}=gr(t);if(!e)return t;const n=t.currentRound||1,a={...t.roundWinners,[n]:r},s=new Map;for(const[,c]of Object.entries(a))for(const o of c){const i=s.get(o)||0;s.set(o,i+1)}let d=null;for(const[c,o]of s.entries())if(o>=2){d=c;break}return l.info(`[endRound] Round ${n} ended. Winners: [${r.join(", ")}], Game winner: ${d||"none"}`),{...t,roundWinners:a,gameWinner:d,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function wr(t,e){if(t.currentPhase!==0)return l.warn(`[performPreparationPhase] Not in Preparation phase (current: ${t.currentPhase})`),t;const r=t.players.find(s=>s.id===e);if(!r)return l.error(`[performPreparationPhase] Active player ${e} not found!`),t;l.info(`[performPreparationPhase] Player ${e} has deck size: ${r.deck.length}, hand size: ${r.hand.length}`);const n=t.players.map(s=>{if(s.id===e&&s.deck.length>0){const d=s.deck[0],c=[...s.deck.slice(1)],o=[...s.hand,d];return l.info(`[performPreparationPhase] Player ${e} drew card ${(d==null?void 0:d.id)||"unknown"}, deck now: ${c.length}, hand: ${o.length}`),{...s,deck:c,hand:o,readySetup:!1,readyCommit:!1}}return s}),a={...t,players:n,currentPhase:1};return lr(a,e),gr(a).shouldEnd?Ia(a):(l.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${a.activePlayerId}`),a)}function Ea(t,e){const r=t.activePlayerId;if(r===e){const c={...t,activePlayerId:null};return e===t.startingPlayerId&&t.currentPhase===1&&gr(c).shouldEnd?Ia(c):c}if(!t.players.filter(c=>!c.isDisconnected).find(c=>c.id===e))return l.warn(`[toggleActivePlayer] Player ${e} not found or disconnected`),t;let s=t.turnNumber||1;e===t.startingPlayerId&&r!==null&&s++;const d={...t,activePlayerId:e,turnNumber:s,currentPhase:0};return wr(d,e)}function Gs(t,e){const r=t.players.filter(s=>!s.isDisconnected).sort((s,d)=>s.id-d.id);if(r.length===0)return null;if(e===null)return r[0].id;const n=r.findIndex(s=>s.id===e);if(n===-1)return r[0].id;const a=(n+1)%r.length;return r[a].id}function xs(t,e){var r;for(const n of t.board)for(const a of n)if(((r=a.card)==null?void 0:r.ownerId)===e)return!0;return!1}function gt(t){const e=Gs(t,t.activePlayerId);if(e===null)return l.warn("[passTurnToNextPlayer] No next player found"),t;l.info(`[passTurnToNextPlayer] Passing turn from ${t.activePlayerId} to ${e}`);let r={...t,board:t.board.map(n=>n.map(a=>{var s;return((s=a.card)==null?void 0:s.ownerId)===t.activePlayerId&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(d=>d.type!=="Stun")}}:a}))};return r={...r,board:r.board.map(n=>n.map(a=>a.card&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(s=>s.type!=="enteredThisTurn")}}:a))},r={...r,activePlayerId:e,currentPhase:0,isScoringStep:!1,targetingMode:null},wr(r,e)}function sr(t,e,r){return l.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),t}function Us(t,e){const{serializePersonalizedState:r}=require("./webrtcSerialization"),{createPersonalizedGameState:n}=require("../host/StatePersonalization"),a=n(t,e??null);return{type:"RECONNECT_SNAPSHOT",data:r(a),_format:"msgpack"}}function $s(t,e,r){var n,a,s,d;try{const c=gs(t,r);l.info(`[WebRTCCodec] Received card state: ${(n=c.board)==null?void 0:n.length}x${((s=(a=c.board)==null?void 0:a[0])==null?void 0:s.length)||0}, ${((d=c.players)==null?void 0:d.length)||0} players`);const o={...e};return c.players&&(o.players=c.players.map(i=>{const E=e.players.find(P=>P.id===i.id);if(E){const P=i.id===r;return{...E,...i,hand:P?E.hand:i.hand,color:E.color}}return i})),c.board&&(o.board=c.board),c.currentPhase!==void 0&&(o.currentPhase=c.currentPhase),c.activePlayerId!==void 0&&(o.activePlayerId=c.activePlayerId),c.currentRound!==void 0&&(o.currentRound=c.currentRound),o}catch(c){return l.error("[WebRTCCodec] Failed to deserialize card state:",c),e}}function Hs(t,e){try{const{effectType:r,timestamp:n,data:a}=Ds(t);l.debug(`[WebRTCCodec] Received ability effect: ${r}`);const s=e;switch(r){case 1:return{gameState:s,effectData:{type:"highlight",...a,timestamp:n}};case 2:return{gameState:s,effectData:{type:"floatingText",...a,timestamp:n}};case 3:return{gameState:s,effectData:{type:"noTarget",...a}};case 8:return{gameState:s,effectData:{type:"targetingMode",...a}};case 9:return{gameState:s,effectData:{type:"clearTargeting"}};default:return l.warn(`[WebRTCCodec] Unknown ability effect type: ${r}`),{gameState:s,effectData:null}}}catch(r){return l.error("[WebRTCCodec] Failed to handle ability effect:",r),{gameState:e,effectData:null}}}function Fs(t,e){var r;try{const{eventType:n,data:a}=Ps(t);l.info(`[WebRTCCodec] Received session event: ${n}`);const s={...e};switch(n){case 1:l.info(`[WebRTCCodec] Player connected: ${a.playerName} (ID: ${a.playerId})`);break;case 2:l.info(`[WebRTCCodec] Player disconnected: ID: ${a.playerId}`),s.players=s.players.map(d=>d.id===a.playerId?{...d,isDisconnected:!0}:d);break;case 3:l.info(`[WebRTCCodec] Game starting, first player: ${a.startingPlayerId}`),s.isGameStarted=!0,a.startingPlayerId!==void 0&&(s.activePlayerId=a.startingPlayerId,s.startingPlayerId=a.startingPlayerId);break;case 4:l.info(`[WebRTCCodec] Round ${a.roundNumber} starting`),s.currentRound=a.roundNumber??1;break;case 5:if(l.info(`[WebRTCCodec] Round ${a.roundNumber} ended, winners: ${(r=a.winners)==null?void 0:r.join(", ")}`),s.isRoundEndModalOpen=!0,a.winners&&a.roundNumber!==void 0){const d=s.roundWinners||{};d[a.roundNumber]=a.winners,s.roundWinners=d}break;case 6:l.info(`[WebRTCCodec] Phase change: ${a.newPhase}`),a.newPhase!==void 0&&(s.currentPhase=a.newPhase),a.newActivePlayerId!==void 0&&(s.activePlayerId=a.newActivePlayerId);break;case 7:l.info(`[WebRTCCodec] Turn change: player ${a.newActivePlayerId}`),a.newActivePlayerId!==void 0&&(s.activePlayerId=a.newActivePlayerId);break;case 8:l.info(`[WebRTCCodec] Game ended, winner: ${a.gameWinner}`),a.gameWinner!==void 0&&(s.gameWinner=a.gameWinner===255?null:a.gameWinner);break;default:l.warn(`[WebRTCCodec] Unknown session event type: ${n}`)}return s}catch(n){return l.error("[WebRTCCodec] Failed to handle session event:",n),e}}function Et(t,e,r,n){return t===2?{gameState:$s(e,r,n)}:t===3?Hs(e,r):t===4?{gameState:Fs(e,r)}:(l.warn(`[WebRTCCodec] Unknown codec message type: ${t}`),{gameState:r})}const Ft="avalon_game_state",dt="reconnection_data";function Ta(t,e){var n;t.forEach(a=>a.forEach(s=>{var d;(d=s.card)!=null&&d.statuses&&(s.card.statuses=s.card.statuses.filter(c=>!(c.type==="LastPlayed"&&c.addedByPlayerId===e.id)))})),e.boardHistory||(e.boardHistory=[]);let r=!1;for(;e.boardHistory.length>0&&!r;){const a=e.boardHistory[e.boardHistory.length-1];for(let s=0;s<t.length;s++){for(let d=0;d<t[s].length;d++)if(((n=t[s][d].card)==null?void 0:n.id)===a){const c=t[s][d].card;if(!c||c.ownerId!==e.id)continue;c.statuses||(c.statuses=[]),c.statuses.push({type:"LastPlayed",addedByPlayerId:e.id}),r=!0;break}if(r)break}r||e.boardHistory.pop()}}function Ct(t){var n;if(!t||!qe)return t;const{cardDatabase:e,tokenDatabase:r}=qe;if(t.deck===Ce.Tokens||(n=t.id)!=null&&n.startsWith("TKN_")){if(t.baseId&&r[t.baseId]){const s=r[t.baseId];return{...t,imageUrl:s.imageUrl,fallbackImage:s.fallbackImage}}const a=Object.keys(r).find(s=>r[s].name===t.name);if(a){const s=r[a];return{...t,imageUrl:s.imageUrl,fallbackImage:s.fallbackImage,baseId:a}}}else if(t.baseId&&e[t.baseId]){const a=e[t.baseId];return{...t,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage}}return t}function Lt(t){var n,a;if(!qe)return t;const e=((n=t.board)==null?void 0:n.map(s=>s.map(d=>({...d,card:d.card?Ct(d.card):null}))))||t.board,r=((a=t.players)==null?void 0:a.map(s=>{var d,c,o;return{...s,hand:((d=s.hand)==null?void 0:d.map(Ct))||[],deck:((c=s.deck)==null?void 0:c.map(Ct))||[],discard:((o=s.discard)==null?void 0:o.map(Ct))||[],announcedCard:s.announcedCard?Ct(s.announcedCard):null}}))||t.players;return{...t,board:e,players:r,floatingTexts:t.floatingTexts||[],highlights:t.highlights||[]}}function Xn(t,e,r){try{const n=Lt(t),a={gameState:n,localPlayerId:e,playerToken:r,timestamp:Date.now()};localStorage.setItem(Ft,JSON.stringify(a)),n.gameId&&e!==null&&localStorage.setItem(dt,JSON.stringify({gameId:n.gameId,playerId:e,playerToken:r||null,timestamp:Date.now()}))}catch(n){console.warn("Failed to save game state:",n)}}function Ws(){try{const t=localStorage.getItem(Ft);if(!t)return null;const e=JSON.parse(t),r=24*60*60*1e3;if(Date.now()-e.timestamp>r)return localStorage.removeItem(Ft),localStorage.removeItem(dt),null;const n=e.gameState;return{gameState:Lt(n),localPlayerId:e.localPlayerId,playerToken:e.playerToken}}catch(t){return console.warn("Failed to load game state:",t),null}}function Tt(){localStorage.removeItem(Ft),localStorage.removeItem(dt)}function _r(t){const e=[...t];for(let r=e.length-1;r>0;r--){const n=Math.floor(Math.random()*(r+1));[e[r],e[n]]=[e[n],e[r]]}return e}function ga(){return Math.random().toString(36).substring(2,18).toUpperCase()}function nt(t,e,r){const n=na();let a=t;if(t==="Random"||!n[t]){const c=Object.keys(n);if(c.length===0)return l.error("[createDeck] No decks loaded yet!"),[];a=c[0],t==="Random"||l.warn(`[createDeck] Deck ${t} not found, using ${a} instead`)}const s=n[a];if(!s)return l.error(`Deck data for ${a} not loaded! Returning empty deck. Available decks:`,Object.keys(n)),[];if(a==="Optimates"){const c={};s.forEach(o=>{const i=o.baseId||o.id;c[i]=(c[i]||0)+1})}const d=[...s].map(c=>({...c,ownerId:e,ownerName:r}));return _r(d)}function wa(t,e=!1){const r=na(),n=Object.keys(r);if(n.length===0)return l.error("[createNewPlayer] No decks loaded yet!"),{id:t,name:e?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:_t[t-1]||"blue",isDummy:e,isReady:e,boardHistory:[],autoDrawEnabled:!0};const a=n[0],s={id:t,name:e?`Dummy ${t-1}`:`Player ${t}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:a,color:_t[t-1]||"blue",isDummy:e,isReady:e,boardHistory:[],autoDrawEnabled:!0};return s.deck=nt(a,t,s.name),s}function it(){return{players:[],spectators:[],board:la(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:yr.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}const Zn=-1,Bs=-2,Rt=1,Ut=2,lt=(t,e,r,n)=>{var c,o,i,E,P;const{card:a,ownerId:s,location:d}=t;if(e.targetOwnerId!==void 0&&e.targetOwnerId!==Zn&&e.targetOwnerId!==Bs&&e.targetOwnerId!==s||e.excludeOwnerId!==void 0&&e.excludeOwnerId===s)return!1;if(e.onlyOpponents||e.targetOwnerId===Zn){if(s===r)return!1;const T=n.find(D=>D.id===r),f=n.find(D=>D.id===s);if(T&&f&&T.teamId!==void 0&&T.teamId===f.teamId)return!1}if(e.targetType&&!((c=a.types)!=null&&c.includes(e.targetType))||e.onlyFaceDown&&((o=a.statuses)!=null&&o.some(T=>T.type==="Revealed"&&T.addedByPlayerId===r)||d==="board"&&!a.isFaceDown)||e.tokenType==="Revealed"&&(i=a.statuses)!=null&&i.some(T=>T.type==="Revealed"&&T.addedByPlayerId===r)||e.requiredTargetStatus&&(!((E=a.statuses)!=null&&E.some(T=>T.type===e.requiredTargetStatus))||e.requireStatusFromSourceOwner&&r!==null&&!((P=a.statuses)==null?void 0:P.some(f=>f.type===e.requiredTargetStatus&&f.addedByPlayerId===r))))return!1;if(e.mustBeAdjacentToSource&&e.sourceCoords&&t.boardCoords){const{row:T,col:f}=e.sourceCoords,{row:D,col:u}=t.boardCoords;if(Math.abs(T-D)+Math.abs(f-u)!==Rt)return!1}if(e.mustBeInLineWithSource&&e.sourceCoords&&t.boardCoords){const{row:T,col:f}=e.sourceCoords,{row:D,col:u}=t.boardCoords;if(T!==D&&f!==u)return!1}if(e.maxDistanceFromSource!==void 0&&e.sourceCoords&&t.boardCoords){const{row:T,col:f}=e.sourceCoords,{row:D,col:u}=t.boardCoords;if(Math.max(Math.abs(T-D),Math.abs(f-u))>e.maxDistanceFromSource)return!1}if(e.maxOrthogonalDistance!==void 0&&e.sourceCoords&&t.boardCoords){const{row:T,col:f}=e.sourceCoords,{row:D,col:u}=t.boardCoords;if(Math.abs(T-D)+Math.abs(f-u)>e.maxOrthogonalDistance)return!1}return!0},Wt=(t,e,r,n)=>{if(!t||t.type!=="ENTER_MODE"&&t.type!=="CREATE_STACK")return[];const a=[],s=e.board,d=s.length,c=e.activeGridSize,o=Math.floor((d-c)/2),i=o,E=o+c-1;if(t.type==="CREATE_STACK"){const u={targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,requiredTargetStatus:t.requiredTargetStatus,requireStatusFromSourceOwner:t.requireStatusFromSourceOwner,mustBeAdjacentToSource:t.mustBeAdjacentToSource,mustBeInLineWithSource:t.mustBeInLineWithSource,maxDistanceFromSource:t.maxDistanceFromSource,maxOrthogonalDistance:t.maxOrthogonalDistance,sourceCoords:t.sourceCoords,tokenType:t.tokenType};for(let y=i;y<=E;y++)for(let p=i;p<=E;p++){const A=s[y][p];A.card&&A.card.ownerId!==void 0&&lt({card:A.card,ownerId:A.card.ownerId,location:"board",boardCoords:{row:y,col:p}},u,r,e.players)&&a.push({row:y,col:p})}return a}const{mode:P,payload:T,sourceCoords:f,contextCheck:D}=t;if(P==="REVEREND_DOUBLE_EXPLOIT"){for(let u=i;u<=E;u++)for(let y=i;y<=E;y++)s[u][y].card&&a.push({row:u,col:y});return a}if((P==="SELECT_TARGET"||P==="CENSOR_SWAP"||P==="ZEALOUS_WEAKEN"||P==="CENTURION_BUFF"||P==="SELECT_UNIT_FOR_MOVE")&&T.filter&&typeof T.filter=="function"){if(T.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||T.actionType==="LUCIUS_SETUP"||T.actionType==="SELECT_HAND_FOR_DEPLOY"||T.handOnly)return[];for(let u=i;u<=E;u++)for(let y=i;y<=E;y++){const p=s[u][y];let A=p.card&&T.filter(p.card,u,y);if(A&&D==="ADJACENT_TO_LAST_MOVE"&&(n!=null&&n.lastMovedCardCoords)){const{row:S,col:h}=n.lastMovedCardCoords;Math.abs(u-S)+Math.abs(y-h)===1||(A=!1)}A&&a.push({row:u,col:y})}}else if(P==="SELECT_TARGET"&&(T.actionType==="ENHANCED_INT_REVEAL"||T.actionType==="ENHANCED_INT_MOVE"))for(let u=i;u<=E;u++)for(let y=i;y<=E;y++)s[u][y].card&&a.push({row:u,col:y});else if(P==="PATROL_MOVE"&&f)for(let u=i;u<=E;u++)for(let y=i;y<=E;y++){const p=u===f.row||y===f.col,A=u===f.row&&y===f.col,S=!s[u][y].card;p&&(S||A)&&a.push({row:u,col:y})}else if(P==="RIOT_PUSH"&&f){const u=[{r:f.row-1,c:f.col},{r:f.row+1,c:f.col},{r:f.row,c:f.col-1},{r:f.row,c:f.col+1}],y=(p,A)=>p>=i&&p<=E&&A>=i&&A<=E;u.forEach(p=>{if(y(p.r,p.c)){const A=s[p.r][p.c].card;if(A&&A.ownerId!==r){const S=e.players.find(_=>_.id===r),h=e.players.find(_=>_.id===A.ownerId);if(!((S==null?void 0:S.teamId)!==void 0&&(h==null?void 0:h.teamId)!==void 0&&S.teamId===h.teamId)){const _=p.r-f.row,m=p.c-f.col,g=p.r+_,k=p.c+m;y(g,k)&&(s[g][k].card||a.push({row:p.r,col:p.c}))}}}})}else if(P==="SHIELD_SELF_THEN_RIOT_PUSH"&&f){f&&a.push(f);const u=[{r:f.row-1,c:f.col},{r:f.row+1,c:f.col},{r:f.row,c:f.col-1},{r:f.row,c:f.col+1}],y=(p,A)=>p>=i&&p<=E&&A>=i&&A<=E;u.forEach(p=>{if(y(p.r,p.c)){const A=s[p.r][p.c].card;if(A&&A.ownerId!==r){const S=e.players.find(_=>_.id===r),h=e.players.find(_=>_.id===A.ownerId);if(!((S==null?void 0:S.teamId)!==void 0&&(h==null?void 0:h.teamId)!==void 0&&S.teamId===h.teamId)){const _=p.r-f.row,m=p.c-f.col,g=p.r+_,k=p.c+m;y(g,k)&&(s[g][k].card||a.push({row:p.r,col:p.c}))}}}})}else if(P==="RIOT_MOVE"&&T.vacatedCoords)a.push(T.vacatedCoords),f&&a.push(f);else if(P==="SWAP_POSITIONS"&&T.filter)for(let u=i;u<=E;u++)for(let y=i;y<=E;y++){const p=s[u][y];p.card&&T.filter(p.card,u,y)&&a.push({row:u,col:y})}else if((P==="TRANSFER_STATUS_SELECT"||P==="TRANSFER_ALL_STATUSES")&&T.filter)for(let u=i;u<=E;u++)for(let y=i;y<=E;y++){const p=s[u][y];p.card&&T.filter(p.card,u,y)&&a.push({row:u,col:y})}else if(P==="SPAWN_TOKEN"||P==="SELECT_CELL"||P==="IMMUNIS_RETRIEVE")for(let u=i;u<=E;u++)for(let y=i;y<=E;y++){const p=!s[u][y].card;if(P==="IMMUNIS_RETRIEVE"&&T.filter){p&&T.filter(u,y)&&a.push({row:u,col:y});continue}if(P==="SELECT_CELL"){if(T.moveFromHand){p&&a.push({row:u,col:y});continue}if(!f)continue;const A=u===f.row&&y===f.col,S=T.range==="global";let h=!1;if(S)h=!0;else if(T.range==="line")h=u===f.row||y===f.col;else if(T.range===Ut){const w=Math.abs(u-f.row),_=Math.abs(y-f.col),m=w+_;if(m===Rt)h=!0;else if(m===Ut){const g=[];w===Ut&&_===0?g.push({r:(u+f.row)/2,c:y}):w===0&&_===Ut?g.push({r:u,c:(y+f.col)/2}):w===Rt&&_===Rt&&(g.push({r:u,c:f.col}),g.push({r:f.row,c:y})),h=g.some(k=>k.r<0||k.r>=d||k.c<0||k.c>=d?!1:!s[k.r][k.c].card)}}else h=Math.abs(u-f.row)+Math.abs(y-f.col)===Rt;(p&&h||T.allowSelf&&A)&&a.push({row:u,col:y})}else if(P==="SPAWN_TOKEN"&&f){const A=Math.abs(u-f.row)+Math.abs(y-f.col)===1;p&&A&&a.push({row:u,col:y})}}else if(P==="REVEAL_ENEMY"&&T.filter)for(let u=i;u<=E;u++)for(let y=i;y<=E;y++){const p=s[u][y];p.card&&T.filter(p.card,u,y)&&a.push({row:u,col:y})}else if(P==="SELECT_LINE_START")for(let u=i;u<=E;u++)for(let y=i;y<=E;y++)a.push({row:u,col:y});else if(P==="SELECT_LINE_END"&&T.firstCoords){const{row:u,col:y}=T.firstCoords;for(let p=i;p<=E;p++)a.push({row:u,col:p});for(let p=i;p<=E;p++)a.push({row:p,col:y})}else if(P==="INTEGRATOR_LINE_SELECT"&&f){const{row:u,col:y}=f;for(let p=i;p<=E;p++)a.push({row:u,col:p});for(let p=i;p<=E;p++)a.push({row:p,col:y})}else if(P==="ZIUS_LINE_SELECT"&&f){const{row:u,col:y}=f;for(let p=i;p<=E;p++)a.push({row:u,col:p});for(let p=i;p<=E;p++)a.push({row:p,col:y})}else if(P==="IP_AGENT_THREAT_SCORING"&&f){const{row:u,col:y}=f;for(let p=i;p<=E;p++)a.push({row:u,col:p});for(let p=i;p<=E;p++)a.push({row:p,col:y})}else if(P==="SELECT_DIAGONAL")if(T.firstCoords){const{row:u,col:y}=T.firstCoords;for(let p=i;p<=E;p++)for(let A=i;A<=E;A++)Math.abs(p-u)===Math.abs(A-y)&&a.push({row:p,col:A})}else for(let u=i;u<=E;u++)for(let y=i;y<=E;y++)a.push({row:u,col:y});return a},Bt=(t,e,r,n)=>{var s,d,c,o,i;if(t.type==="OPEN_MODAL"||t.mode==="SELECT_DECK")return!0;if(t.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let E=0;E<e.board.length;E++)for(let P=0;P<e.board[E].length;P++)if(e.board[E][P].card)return!0;return!1}if(t.mode==="PRINCEPS_SHIELD_THEN_AIM"||t.mode==="SHIELD_SELF_THEN_SPAWN"||t.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||t.mode==="ABR_DEPLOY_SHIELD_AIM"||t.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(t.mode==="SELECT_TARGET"&&((s=t.payload)!=null&&s.actionType)){const E=t.payload.actionType;if(E==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||E==="LUCIUS_SETUP"||E==="SELECT_HAND_FOR_DEPLOY"){const P=((d=t.sourceCard)==null?void 0:d.ownerId)||r;if(P!==null){const T=e.players.find(f=>f.id===P);if(T&&T.hand.length>0)return!0}return!1}}if(t.type==="CREATE_STACK"){if(Wt(t,e,r,n).length>0)return!0;const P=["Aim","Exploit","Stun","Shield"];if(!(t.tokenType&&P.includes(t.tokenType))&&(t.tokenType==="Revealed"||(c=t.tokenType)!=null&&c.startsWith("Power")))for(const f of e.players)for(let D=0;D<f.hand.length;D++){const u={targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,tokenType:t.tokenType};if(lt({card:f.hand[D],ownerId:f.id,location:"hand"},u,r,e.players))return!0}return!1}if(t.mode==="SELECT_TARGET"&&((o=t.payload)!=null&&o.filter)){if(t.payload.handOnly||t.payload.allowHandTargets||t.payload.actionType==="DESTROY"){for(const E of e.players)if(E.hand.some(P=>t.payload.filter(P))&&t.payload.handOnly)return!0}if(t.payload.handOnly)return!1}return Wt(t,e,r,n).length>0?!0:((t.mode==="CENSOR_SWAP"||t.mode==="ZEALOUS_WEAKEN"||t.mode==="CENTURION_BUFF"||t.mode==="SELECT_UNIT_FOR_MOVE")&&((i=t.payload)!=null&&i.filter),!1)};function Ys(t){const{ws:e,webrtcManager:r,gameStateRef:n,localPlayerIdRef:a,webrtcIsHostRef:s,setLatestHighlight:d,setLatestFloatingTexts:c,setLatestNoTarget:o,setLatestDeckSelections:i,setLatestHandCardSelections:E,setClickWaves:P,setGameState:T}=t,f=H.useRef({}),D=500,u=H.useCallback(g=>{var R;const k={...g,timestamp:Date.now()};if(d(k),((R=e.current)==null?void 0:R.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:n.current.gameId,highlightData:k}));else if(r.current){const b={type:"HIGHLIGHT_TRIGGERED",senderId:r.current.getPeerId(),data:k,timestamp:Date.now()};s.current?r.current.broadcastToGuests(b):r.current.sendMessageToHost(b)}},[e,r,n,s,d]),y=H.useCallback(g=>{var O;const k=Array.isArray(g)?g:[g],R=Date.now(),b=k.map((x,U)=>({...x,timestamp:R+U}));if(c(b),((O=e.current)==null?void 0:O.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:n.current.gameId,batch:b}));else if(r.current){const x={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:r.current.getPeerId(),data:{batch:b},timestamp:Date.now()};s.current?r.current.broadcastToGuests(x):r.current.sendMessageToHost(x)}},[e,r,n,s,c]),p=H.useCallback(g=>{var R;const k=Date.now();if(o({coords:g,timestamp:k}),((R=e.current)==null?void 0:R.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:n.current.gameId,coords:g,timestamp:k}));else if(r.current){const b={type:"NO_TARGET_TRIGGERED",senderId:r.current.getPeerId(),data:{coords:g,timestamp:k},timestamp:Date.now()};s.current?r.current.broadcastToGuests(b):r.current.sendMessageToHost(b)}},[e,r,n,s,o]),A=H.useCallback((g,k)=>{var b;const R={playerId:g,selectedByPlayerId:k,timestamp:Date.now()};if(i(O=>[...O,R]),((b=e.current)==null?void 0:b.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:n.current.gameId,deckSelectionData:R}));else if(r.current){const O={type:"DECK_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:R,timestamp:Date.now()};s.current?r.current.broadcastToGuests(O):r.current.sendMessageToHost(O)}setTimeout(()=>{i(O=>O.filter(x=>x.timestamp!==R.timestamp))},1e3)},[e,r,n,s,i]),S=H.useCallback((g,k,R)=>{var O;const b={playerId:g,cardIndex:k,selectedByPlayerId:R,timestamp:Date.now()};if(E(x=>[...x,b]),((O=e.current)==null?void 0:O.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:n.current.gameId,handCardSelectionData:b}));else if(r.current){const x={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:b,timestamp:Date.now()};s.current?r.current.broadcastToGuests(x):r.current.sendMessageToHost(x)}setTimeout(()=>{E(x=>x.filter(U=>U.timestamp!==b.timestamp))},1e3)},[e,r,n,s,E]),h=H.useCallback(g=>{},[]),w=H.useCallback((g,k,R)=>{var G;if(a.current===null)return;const b=a.current,O=Date.now(),x=f.current[b]||0;if(O-x<D)return;f.current[b]=O;const U=n.current.players.find($=>$.id===b);if(!U)return;const N={timestamp:Date.now(),location:g,boardCoords:k,handTarget:R,clickedByPlayerId:b,playerColor:U.color};if(P($=>[...$,N]),((G=e.current)==null?void 0:G.readyState)===WebSocket.OPEN&&n.current.gameId)e.current.send(JSON.stringify({type:"TRIGGER_CLICK_WAVE",gameId:n.current.gameId,wave:N}));else if(r.current){const $={type:"CLICK_WAVE_TRIGGERED",senderId:r.current.getPeerId(),data:N,timestamp:Date.now()};s.current?r.current.broadcastToGuests($):r.current.sendMessageToHost($)}setTimeout(()=>{P($=>$.filter(q=>q.timestamp!==N.timestamp))},600)},[e,r,n,s,P]),_=H.useCallback((g,k,R,b,O,x)=>{var $;const U=n.current;if(!U||!U.board){console.warn("[setTargetingMode] No game state or board available");return}let N;b?N=b:R&&(N=Wt(g,U,k,O));const G={playerId:k,action:g,sourceCoords:R,timestamp:Date.now(),boardTargets:N,handTargets:x};if(T(q=>({...q,targetingMode:G})),(($=e.current)==null?void 0:$.readyState)===WebSocket.OPEN&&U.gameId)e.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:U.gameId,targetingMode:G}));else if(r.current){const q={type:"SET_TARGETING_MODE",senderId:r.current.getPeerId(),data:G,timestamp:Date.now()};s.current?r.current.broadcastToGuests(q):r.current.sendMessageToHost(q)}},[e,r,n,s,T]),m=H.useCallback(()=>{var k;const g=n.current;if(T(R=>({...R,targetingMode:null})),((k=e.current)==null?void 0:k.readyState)===WebSocket.OPEN&&(g!=null&&g.gameId))e.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:g.gameId}));else if(r.current){const R={type:"CLEAR_TARGETING_MODE",senderId:r.current.getPeerId(),data:{},timestamp:Date.now()};s.current?r.current.broadcastToGuests(R):r.current.sendMessageToHost(R)}},[e,r,n,s,T]);return{triggerHighlight:u,triggerFloatingText:y,triggerNoTarget:p,triggerDeckSelection:A,triggerHandCardSelection:S,syncValidTargets:h,triggerClickWave:w,setTargetingMode:_,clearTargetingMode:m}}function zs(t){const{ws:e,webrtcManager:r,gameStateRef:n,webrtcIsHostRef:a,setGameState:s,updateState:d}=t,c=H.useCallback(T=>{var D;if(We()&&r.current&&a.current){s(u=>{const y=u.players.map(p=>{let A=1;for(const[S,h]of Object.entries(T))if(h.includes(p.id)){A=parseInt(S);break}return{...p,teamId:A}});return{...u,players:y}}),r.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:r.current.getPeerId(),data:{assignments:T},timestamp:Date.now()});return}((D=e.current)==null?void 0:D.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:n.current.gameId,assignments:T}))},[e,r,n,a,s]),o=H.useCallback(T=>{var D;if(We()&&r.current&&a.current){s(u=>({...u,gameMode:T})),r.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:r.current.getPeerId(),data:{mode:T},timestamp:Date.now()});return}((D=e.current)==null?void 0:D.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:n.current.gameId,mode:T}))},[e,r,n,a,s]),i=H.useCallback(T=>{var D;if(We()&&r.current&&a.current){s(u=>({...u,isPrivate:T})),r.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:r.current.getPeerId(),data:{isPrivate:T},timestamp:Date.now()});return}((D=e.current)==null?void 0:D.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:n.current.gameId,isPrivate:T}))},[e,r,n,a,s]),E=H.useCallback(T=>{d(f=>{if(f.isGameStarted)return f;const D={...f,activeGridSize:T};if(f.board.length!==T){D.board=[];for(let y=0;y<T;y++){const p=[];for(let A=0;A<T;A++)p.push({card:null});D.board.push(p)}}return D})},[d]),P=H.useCallback(T=>{d(f=>{if(f.isGameStarted)return f;const D=f.players.filter(p=>!p.isDummy);if(D.length+T>Qo)return f;const u=[...D],y=Math.max(...D.map(p=>p.id),0);for(let p=0;p<T;p++){const A=y+p+1,S=wa(A,!0);S.name=`Dummy ${p+1}`,u.push(S)}return{...f,players:u,dummyPlayerCount:T}})},[d]);return{assignTeams:c,setGameMode:o,setGamePrivacy:i,setActiveGridSize:E,setDummyPlayerCount:P}}function Ks(t){const{ws:e,webrtcManager:r,gameStateRef:n,localPlayerIdRef:a,webrtcIsHostRef:s,setGameState:d}=t,c=H.useCallback(()=>{var P;if(We()&&r.current&&s.current){d(T=>({...T,isReadyCheckActive:!0,isPrivate:!0})),r.current.broadcastToGuests({type:"START_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId&&e.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:n.current.gameId}))},[e,r,n,s,d]),o=H.useCallback(()=>{var P;if(We()&&r.current&&s.current){d(T=>({...T,isReadyCheckActive:!1})),r.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId?e.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:n.current.gameId})):d(T=>({...T,isReadyCheckActive:!1}))},[e,r,n,s,d]),i=H.useCallback(()=>{var P;const E=We();if(E&&r.current&&s.current&&a.current!==null){d(T=>{const f=T.players.map(p=>p.id===a.current?{...p,isReady:!0}:p),D={...T,players:f},u=D.players.filter(p=>!p.isDummy&&!p.isDisconnected);if(u.length>0&&u.every(p=>p.isReady)&&!D.isGameStarted){const p=D.players.filter(_=>!_.isDisconnected),A=Math.floor(Math.random()*p.length),S=p[A].id,h={...D};h.isReadyCheckActive=!1,h.isGameStarted=!0,h.startingPlayerId=S,h.activePlayerId=S,h.currentPhase=0,h.players=h.players.map(_=>{if(_.hand.length===0&&_.deck.length>0){const g=[..._.hand],k=[..._.deck];for(let R=0;R<6&&R<k.length;R++){const b=k[0];k.splice(0,1),g.push(b)}return l.info(`[playerReady] Drew initial ${g.length} cards for player ${_.id}`),{..._,hand:g,deck:k}}return _});const w=h.players.find(_=>_.id===S);if(w&&w.deck.length>0){const _=w.deck[0],m=[...w.deck.slice(1)],g=[...w.hand,_];h.players=h.players.map(k=>k.id===S?{...k,deck:m,hand:g,readySetup:!1,readyCommit:!1}:k),h.currentPhase=1}return r.current.broadcastGameState(h),r.current.broadcastToGuests({type:"GAME_START",senderId:r.current.getPeerId(),data:{startingPlayerId:S,activePlayerId:S,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),h}return r.current.broadcastToGuests({type:"HOST_READY",senderId:r.current.getPeerId(),playerId:a.current??void 0,timestamp:Date.now()}),D});return}if(E&&r.current&&!s.current&&a.current!==null){r.current.sendMessageToHost({type:"PLAYER_READY",senderId:r.current.getPeerId(),playerId:a.current,timestamp:Date.now()}),d(T=>({...T,players:T.players.map(f=>f.id===a.current?{...f,isReady:!0}:f)}));return}((P=e.current)==null?void 0:P.readyState)===WebSocket.OPEN&&n.current.gameId&&a.current!==null&&e.current.send(JSON.stringify({type:"PLAYER_READY",gameId:n.current.gameId,playerId:a.current}))},[e,r,n,a,s,d]);return{startReadyCheck:c,cancelReadyCheck:o,playerReady:i}}function qs(t){const{updateState:e,sendWebrtcAction:r,webrtcIsHostRef:n,webrtcManagerRef:a}=t,s=H.useCallback((c,o)=>{e(i=>i.isGameStarted?i:{...i,players:i.players.map(E=>E.id===c?{...E,name:o}:E)})},[e]),d=H.useCallback((c,o)=>{e(E=>({...E,players:E.players.map(P=>P.id===c?{...P,color:o}:P)})),r!==null&&(n!=null&&n.current&&(a!=null&&a.current)?a.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:a.current.getPeerId(),data:{playerId:c,color:o},timestamp:Date.now()}):!(n!=null&&n.current)&&r&&r("CHANGE_PLAYER_COLOR",{playerId:c,color:o}))},[e,r,n,a]);return{updatePlayerName:s,changePlayerColor:d}}function Vs(t){const{updateState:e}=t,r=H.useCallback(c=>{e(o=>{if(!o.isGameStarted)return o;const i=o.players.find(f=>f.id===c);if(!i||i.deck.length===0)return o;const E=fe(o),P=E.players.find(f=>f.id===c),T=P.deck.shift();return T&&P.hand.push(T),E})},[e]),n=H.useCallback((c,o)=>{o<=0||e(i=>{if(!i.isGameStarted)return i;const E=i.players.find(D=>D.id===c);if(!E||E.deck.length===0)return i;const P=fe(i),T=P.players.find(D=>D.id===c),f=Math.min(o,T.deck.length);for(let D=0;D<f;D++){const u=T.deck.shift();u&&T.hand.push(u)}return P})},[e]),a=H.useCallback(c=>{e(o=>{if(!o.isGameStarted||!o.players.find(u=>u.id===c))return o;const E=fe(o),P=E.players.find(u=>u.id===c);P.deck=_r([...P.deck]);const T=t.webrtcManager.current,f=t.webrtcIsHostRef.current,D=t.localPlayerIdRef.current;return T&&o.gameId&&!f&&c===D&&setTimeout(()=>{T.sendFullDeckToHost(c,P.deck,P.deck.length)},0),E})},[e,t]),s=H.useCallback(c=>{e(o=>{if(!o.isGameStarted)return o;const i={...o},E=i.board[c.row][c.col].card;return E&&(E.isFaceDown=!1),{...i,board:Le(i)}})},[e]),d=H.useCallback(c=>{e(o=>{if(!o.isGameStarted)return o;const i={...o},E=i.board[c.row][c.col].card;return E&&(E.isFaceDown=!0),{...i,board:Le(i)}})},[e]);return{drawCard:r,drawCardsBatch:n,shufflePlayerDeck:a,flipBoardCard:s,flipBoardCardFaceDown:d}}function js(t){const{localPlayerIdRef:e,updateState:r}=t,n=H.useCallback((p,A,S)=>{r(h=>{var m,g;if(!h.isGameStarted)return h;const w=fe(h),_=w.board[p.row][p.col].card;if(_){if(A==="Stun"&&(_.baseId==="luciusTheImmortal"||_.name.includes("Lucius")&&((m=_.types)!=null&&m.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(A)&&((g=_.statuses)==null?void 0:g.some(R=>R.type===A&&R.addedByPlayerId===S)))return h;_.statuses||(_.statuses=[]),_.statuses.push({type:A,addedByPlayerId:S}),(A==="Stun"||A==="Support")&&Zt(_,w)}return w})},[r]),a=H.useCallback((p,A)=>{r(S=>{if(!S.isGameStarted)return S;const h=fe(S),w=h.board[p.row][p.col].card;if(w!=null&&w.statuses){const _=w.statuses.map(m=>m.type).lastIndexOf(A);_>-1&&(w.statuses.splice(_,1),(A==="Stun"||A==="Support")&&Zt(w,h))}return h.board=Le(h),h})},[r]),s=H.useCallback((p,A,S)=>{r(h=>{if(!h.isGameStarted)return h;const w=fe(h),_=w.board[p.row][p.col].card;if(_!=null&&_.statuses){const m=_.statuses.findIndex(g=>g.type===A&&g.addedByPlayerId===S);m>-1&&(_.statuses.splice(m,1),(A==="Stun"||A==="Support")&&Zt(_,w))}return w.board=Le(w),w})},[r]),d=H.useCallback((p,A)=>{r(S=>{if(!S.isGameStarted)return S;const h=fe(S),w=h.board[p.row][p.col].card;return w&&(w.powerModifier===void 0&&(w.powerModifier=0),w.powerModifier+=A),h})},[r]),c=H.useCallback((p,A,S)=>{r(h=>{var m;if(!h.isGameStarted)return h;const w=fe(h),_=w.players.find(g=>g.id===p);if(_!=null&&_.announcedCard){if(["Support","Threat","Revealed"].includes(A)&&((m=_.announcedCard.statuses)==null?void 0:m.some(k=>k.type===A&&k.addedByPlayerId===S)))return h;_.announcedCard.statuses||(_.announcedCard.statuses=[]),_.announcedCard.statuses.push({type:A,addedByPlayerId:S})}return w})},[r]),o=H.useCallback((p,A)=>{r(S=>{var _;if(!S.isGameStarted)return S;const h=fe(S),w=h.players.find(m=>m.id===p);if((_=w==null?void 0:w.announcedCard)!=null&&_.statuses){const m=w.announcedCard.statuses.map(g=>g.type).lastIndexOf(A);m>-1&&w.announcedCard.statuses.splice(m,1)}return h})},[r]),i=H.useCallback((p,A)=>{r(S=>{if(!S.isGameStarted)return S;const h=fe(S),w=h.players.find(_=>_.id===p);return w!=null&&w.announcedCard&&(w.announcedCard.powerModifier===void 0&&(w.announcedCard.powerModifier=0),w.announcedCard.powerModifier+=A),h})},[r]),E=H.useCallback((p,A,S,h)=>{r(w=>{var g;if(!w.isGameStarted)return w;const _=fe(w),m=_.players.find(k=>k.id===p);if(m!=null&&m.hand[A]){const k=m.hand[A];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(S)&&((g=k.statuses)==null?void 0:g.some(b=>b.type===S&&b.addedByPlayerId===h)))return w;k.statuses||(k.statuses=[]),k.statuses.push({type:S,addedByPlayerId:h})}return _})},[r]),P=H.useCallback((p,A,S)=>{r(h=>{if(!h.isGameStarted)return h;const w=fe(h),_=w.players.find(g=>g.id===p),m=_==null?void 0:_.hand[A];if(m!=null&&m.statuses){const g=m.statuses.map(k=>k.type).lastIndexOf(S);g>-1&&m.statuses.splice(g,1),S==="Revealed"&&(m.statuses.some(R=>R.type==="Revealed")||delete m.revealedTo)}return w})},[r]),T=H.useCallback((p,A,S)=>{r(h=>{const w=h.players.find(g=>g.id===p);if(!(w!=null&&w.hand[A]))return h;const _=fe(h),m=_.players.find(g=>g.id===p).hand[A];if(S==="all")m.revealedTo="all",m.statuses||(m.statuses=[]),m.statuses.some(g=>g.type==="Revealed"&&g.addedByPlayerId===p)||m.statuses.push({type:"Revealed",addedByPlayerId:p});else{(!m.revealedTo||m.revealedTo==="all"||!Array.isArray(m.revealedTo))&&(m.revealedTo=[]);const g=S.filter(k=>!m.revealedTo.includes(k));m.revealedTo.push(...g)}return _})},[r]),f=H.useCallback((p,A)=>{r(S=>{if(!S.board[p.row][p.col].card)return S;const w=fe(S),_=w.board[p.row][p.col].card,m=_.ownerId;if(A==="all")_.revealedTo="all",m!==void 0&&(_.statuses||(_.statuses=[]),_.statuses.some(g=>g.type==="Revealed"&&g.addedByPlayerId===m)||_.statuses.push({type:"Revealed",addedByPlayerId:m}));else{(!_.revealedTo||_.revealedTo==="all"||!Array.isArray(_.revealedTo))&&(_.revealedTo=[]);const g=A.filter(k=>!_.revealedTo.includes(k));_.revealedTo.push(...g)}return w})},[r]),D=H.useCallback((p,A)=>{r(S=>{var m;const h=p.boardCoords?(m=S.board[p.boardCoords.row][p.boardCoords.col].card)==null?void 0:m.ownerId:p.ownerId;if(!h)return S;const w=fe(S),_=w.revealRequests.find(g=>g.fromPlayerId===A&&g.toPlayerId===h);return _?_.cardIdentifiers.some(k=>JSON.stringify(k)===JSON.stringify(p))||_.cardIdentifiers.push(p):w.revealRequests.push({fromPlayerId:A,toPlayerId:h,cardIdentifiers:[p]}),w})},[r]),u=H.useCallback((p,A)=>{r(S=>{const h=S.revealRequests.findIndex(m=>m.toPlayerId===e.current&&m.fromPlayerId===p);if(h===-1)return S;const w=fe(S),_=w.revealRequests[h];if(A){const{cardIdentifiers:m}=_;for(const g of m){let k=null;if(g.source==="board"&&g.boardCoords)k=w.board[g.boardCoords.row][g.boardCoords.col].card;else if(g.source==="hand"&&g.ownerId&&g.cardIndex!==void 0){const R=w.players.find(b=>b.id===g.ownerId);R&&(k=R.hand[g.cardIndex])}k&&(k.statuses||(k.statuses=[]),k.statuses.some(R=>R.type==="Revealed"&&R.addedByPlayerId===p)||k.statuses.push({type:"Revealed",addedByPlayerId:p}))}}return w.revealRequests.splice(h,1),w})},[r,e]),y=H.useCallback(p=>{r(A=>{const S=fe(A);let h=null;if(p.source==="board"&&p.boardCoords)h=S.board[p.boardCoords.row][p.boardCoords.col].card;else if(p.source==="hand"&&p.playerId&&p.cardIndex!==void 0){const w=S.players.find(_=>_.id===p.playerId);w&&(h=w.hand[p.cardIndex])}return h&&(h.statuses&&(h.statuses=h.statuses.filter(w=>w.type!=="Revealed")),delete h.revealedTo),S})},[r]);return{addBoardCardStatus:n,removeBoardCardStatus:a,removeBoardCardStatusByOwner:s,modifyBoardCardPower:d,addAnnouncedCardStatus:c,removeAnnouncedCardStatus:o,modifyAnnouncedCardPower:i,addHandCardStatus:E,removeHandCardStatus:P,revealHandCard:T,revealBoardCard:f,requestCardReveal:D,respondToRevealRequest:u,removeRevealedStatus:y}}function Js(t){const{webrtcIsHostRef:e,sendWebrtcAction:r,webrtcManagerRef:n,localPlayerIdRef:a,getCardDefinition:s,commandCardIds:d,createDeck:c,updateState:o}=t,i=H.useCallback((u,y)=>{const p=We();let A=!1;if(o(h=>{const w=h.players.find(R=>R.id===u);if(!w)return h;A=w.isDummy||!1;const _=A,m=e.current,g=!_||m;if(p&&!m)try{localStorage.setItem("webrtc_preferred_deck",y),l.info(`[changePlayerDeck] Guest saved deck preference: ${y}`)}catch(R){l.warn("[changePlayerDeck] Failed to save deck preference:",R)}const k=g?c(y,u,w.name):[];return p?m?{...h,players:h.players.map(R=>R.id===u?{...R,deck:k,selectedDeck:y,hand:[],discard:[],announcedCard:null,boardHistory:[]}:R)}:{...h,players:h.players.map(R=>R.id===u?{...R,selectedDeck:y}:R)}:{...h,players:h.players.map(R=>R.id===u?{...R,deck:k,selectedDeck:y,hand:[],discard:[],announcedCard:null,boardHistory:[]}:R)}}),l.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${p}, isHost=${e.current}, hasSendAction=${!!r}, hasManager=${!!(n!=null&&n.current)}`),!p)return;if(e.current){const w=c(y,u,"Player "+u).map(_=>({id:_.id,baseId:_.baseId,power:_.power,powerModifier:_.powerModifier||0,isFaceDown:_.isFaceDown||!1,statuses:_.statuses||[]}));if(y==="Optimates"){const _={};w.forEach(m=>{const g=m.baseId||m.id;_[g]=(_[g]||0)+1}),l.info("[changePlayerDeck] Host sending Optimates deck data:",{totalCards:w.length,baseIdCounts:_})}n!=null&&n.current?(n.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:n.current.getPeerId(),timestamp:Date.now(),data:{playerId:u,deckType:y,deck:w,deckSize:w.length}}),l.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${u}, deck ${y}, ${w.length} cards, isDummy=${A}`)):l.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available")}else r?r("CHANGE_PLAYER_DECK",{playerId:u,deckType:y,deck:void 0,deckSize:0}):l.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[o,c,r,e,n,a]),E=H.useCallback((u,y)=>{const p=We();let A=[];const S=new Map;for(const{cardId:w,quantity:_}of y.cards){const m=s(w);if(!m)continue;const g=d.has(w),k=g?Ce.Command:Ce.Custom,R=g?"CMD":"CUS";for(let b=0;b<_;b++){const O=(S.get(w)||0)+1;S.set(w,O),A.push({...m,id:`${R}_${w.toUpperCase()}_${O}`,baseId:w,deck:k,ownerId:u,ownerName:"Player "+u})}}if(A=_r(A),o(w=>w.isGameStarted||!w.players.find(m=>m.id===u)?w:{...w,players:w.players.map(m=>m.id===u?{...m,deck:A,selectedDeck:Ce.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:m)}),!p)return;const h=A.map(w=>({id:w.id,baseId:w.baseId,power:w.power,powerModifier:w.powerModifier||0,isFaceDown:w.isFaceDown||!1,statuses:w.statuses||[]}));e.current?n!=null&&n.current&&(n.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:n.current.getPeerId(),timestamp:Date.now(),data:{playerId:u,deckType:Ce.Custom,deck:h,deckSize:h.length}}),l.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${u}, ${h.length} cards`)):r&&(r("CHANGE_PLAYER_DECK",{playerId:u,deckType:Ce.Custom,deck:h,deckSize:h.length}),l.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${u}, ${h.length} cards`))},[o,s,d,r,e,n,a]),P=H.useCallback((u,y,p,A)=>{o(S=>{if(!S.isGameStarted||S.board[p.row][p.col].card!==null)return S;const h=fe(S),w=h.players.find(_=>_.id===u);if(w&&w.discard.length>y){const[_]=w.discard.splice(y,1);_.enteredThisTurn=!0,Ir(_,u),(_.baseId==="luciusTheImmortal"||_.name.includes("Lucius"))&&(_.powerModifier===void 0&&(_.powerModifier=0),_.powerModifier+=2),_.statuses||(_.statuses=[]),_.statuses.push({type:"Resurrected",addedByPlayerId:u}),A&&A.forEach(m=>{var g;m.type!=="Resurrected"&&((g=_.statuses)==null||g.push({type:m.type,addedByPlayerId:u}))}),w.boardHistory||(w.boardHistory=[]),w.boardHistory.push(_.id),h.board[p.row][p.col].card=_,Ta(h.board,w),h.board=Le(h)}return h})},[o]),T=H.useCallback((u,y)=>{o(p=>{const A=fe(p),S=A.players.find(h=>h.id===u);if(S&&y.length>0){const h=new Set(y.map(_=>_.id)),w=S.deck.filter(_=>!h.has(_.id));S.deck=[...y,...w]}return A})},[o]),f=H.useCallback((u,y,p)=>{o(A=>{const S=fe(A),h=S.players.find(w=>w.id===u);return h&&(p==="deck"?h.deck=y:p==="discard"&&(h.discard=y)),S})},[o]),D=H.useCallback((u,y)=>{o(p=>{if(!p.isGameStarted)return p;const A=fe(p),S=A.players.find(h=>h.id===u);if(S&&S.discard.length>y){const[h]=S.discard.splice(y,1);S.hand.push(h)}return A})},[o]);return{changePlayerDeck:i,loadCustomDeck:E,resurrectDiscardedCard:P,reorderTopDeck:T,reorderCards:f,recoverDiscardedCard:D}}function Xs(t){const{ws:e,webrtcManagerRef:r,webrtcIsHostRef:n,gameStateRef:a,scoreDeltaAccumulator:s,setGameState:d,updateState:c,abilityMode:o,setAbilityMode:i,createDeck:E,webrtcEnabled:P}=t,T=H.useCallback(h=>{P&&r.current?n.current?d(_=>{const m=Ea(_,h);return r.current&&r.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:r.current.getPeerId(),data:{activePlayerId:m.activePlayerId,currentPhase:m.currentPhase,turnNumber:m.turnNumber},timestamp:Date.now()}),m}):r.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:h},timestamp:Date.now()}):e.current&&e.current.readyState===WebSocket.OPEN&&(s.forEach((_,m)=>{clearTimeout(_.timerId),l.info(`[ScoreFlush] Flushing on toggle: player=${m}, delta=${_.delta}`),e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:a.current.gameId,playerId:m,delta:_.delta}))}),s.clear(),e.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:a.current.gameId,playerId:h})))},[e,r,n,a,s,d]),f=H.useCallback((h,w)=>{e.current&&e.current.readyState===WebSocket.OPEN&&e.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:a.current.gameId,playerId:h,enabled:w}))},[]),D=H.useCallback(h=>{const w=o&&i&&o.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(o.mode);if(w&&i(null),P&&r.current){c(m=>{if(!m.isGameStarted)return m;const g=m.currentPhase,k=Math.max(1,Math.min(h,4));if(g===k)return m;const R=fe(m);return R.currentPhase=k,R.board.forEach(O=>{O.forEach(x=>{const U=x.card;if(U&&U.statuses){const N=U.statuses.filter(G=>G.type!=="readyDeploy");N.length!==U.statuses.length&&(U.statuses=N)}})}),k===4&&(R.isScoringStep=!0),n.current||r.current.sendMessageToHost({type:"SET_PHASE",senderId:void 0,data:{phaseIndex:k,activePlayerId:R.activePlayerId},timestamp:Date.now()}),R});return}c(m=>{if(!m.isGameStarted)return m;const g=m.currentPhase,k=Math.max(1,Math.min(h,4));if(g===k)return m;const R=fe(m);return R.board.forEach(O=>{O.forEach(x=>{const U=x.card;if(U&&U.statuses){const N=U.statuses.filter(G=>G.type!=="readyDeploy");N.length!==U.statuses.length&&(U.statuses=N)}})}),{...R,currentPhase:k,...k===4&&!w?{isScoringStep:!0}:{},...w?{isScoringStep:!1}:{}}})},[c,o,i,r,n,a,d]),u=H.useCallback(()=>{var _;o&&i&&o.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(o.mode)&&i(null);const h=a.current,w=P;if(h.isGameStarted&&h.currentPhase===4&&h.isScoringStep&&!w){((_=e.current)==null?void 0:_.readyState)===WebSocket.OPEN&&(s.forEach((m,g)=>{clearTimeout(m.timerId),l.info(`[ScoreFlush] Flushing pending score: player=${g}, delta=${m.delta}`),e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:h.gameId,playerId:g,delta:m.delta}))}),s.clear(),e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:h.gameId})));return}if(w&&h.isGameStarted&&h.currentPhase===4&&h.isScoringStep){c(m=>gt(m));return}c(m=>{if(!m.isGameStarted)return m;const g=fe(m),k=m.currentPhase+1;return g.board.forEach(R=>{R.forEach(b=>{const O=b.card;if(O&&O.statuses){const x=O.statuses.filter(U=>U.type!=="readyDeploy");x.length!==O.statuses.length&&(O.statuses=x)}})}),w&&k===4&&m.currentPhase===3?xs(m,m.activePlayerId)?(g.isScoringStep=!0,g.currentPhase=4,g):(l.info(`[nextPhase] Player ${m.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),gt(m)):k===4&&m.currentPhase===3?(g.isScoringStep=!0,g.currentPhase=4,g):(g.board.forEach(R=>{R.forEach(b=>{var O;if((O=b.card)!=null&&O.statuses){const x=b.card.statuses.findIndex(U=>U.type==="Resurrected");if(x!==-1){const U=b.card.statuses[x].addedByPlayerId;b.card.statuses.splice(x,1),b.card.baseId!=="luciusTheImmortal"&&(b.card.statuses.push({type:"Stun",addedByPlayerId:U}),b.card.statuses.push({type:"Stun",addedByPlayerId:U}))}}})}),g.board=Le(g),g.currentPhase=k,g)})},[c,o,i,a,e,s]),y=H.useCallback(()=>{c(h=>{if(!h.isGameStarted)return h;o&&i&&o.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(o.mode)&&i(null);const w=(h.isScoringStep,h.currentPhase),_=Math.max(1,h.currentPhase-1);if(w!==_){const m=fe(h);return m.board.forEach(g=>{g.forEach(k=>{const R=k.card;if(R&&R.statuses){const b=R.statuses.filter(O=>O.type!=="readyDeploy");b.length!==R.statuses.length&&(R.statuses=b)}})}),h.isScoringStep?{...m,isScoringStep:!1,currentPhase:_}:{...m,currentPhase:_}}return h.isScoringStep?{...h,isScoringStep:!1,currentPhase:_}:{...h,currentPhase:_}})},[c,o,i]),p=H.useCallback(()=>{var w;P?c(_=>({..._,isRoundEndModalOpen:!1,currentRound:(_.currentRound||1)+1,players:_.players.map(m=>({...m,score:0}))})):((w=e.current)==null?void 0:w.readyState)===WebSocket.OPEN&&a.current.gameId&&(d(_=>({..._,isRoundEndModalOpen:!1,currentRound:(_.currentRound||1)+1,players:_.players.map(m=>({...m,score:0}))})),e.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:a.current.gameId})))},[d,c,e,a]),A=H.useCallback(()=>{d(h=>({...h,isRoundEndModalOpen:!1}))},[d]),S=H.useCallback(()=>{var w;if(P){const _=a.current,m=_.players.map(b=>{const O=b.selectedDeck||"SynchroTech";return{...b,hand:[],deck:E(O,b.id,b.name),discard:[],score:0,isReady:b.isDummy||!1,announcedCard:null,boardHistory:[]}}),g=_.activeGridSize||8,k=[];for(let b=0;b<g;b++){const O=[];for(let x=0;x<g;x++)O.push({card:null});k.push(O)}const R={..._,players:m,board:k,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};d(R),a.current=R,r.current&&r.current.broadcastToGuests({type:"GAME_RESET",senderId:r.current.getPeerId(),data:{players:m.map(b=>({id:b.id,name:b.name,color:b.color,selectedDeck:b.selectedDeck,isDummy:b.isDummy,isDisconnected:b.isDisconnected,autoDrawEnabled:b.autoDrawEnabled,handSize:b.hand.length,deckSize:b.deck.length,discardSize:b.discard.length,...b.isDummy&&{hand:b.hand.map(O=>({id:O.id,baseId:O.baseId,name:O.name,imageUrl:O.imageUrl,power:O.power,powerModifier:O.powerModifier,ability:O.ability,ownerId:O.ownerId,color:O.color,deck:O.deck,isFaceDown:O.isFaceDown,types:O.types,faction:O.faction,statuses:O.statuses})),deck:b.deck.map(O=>({id:O.id,baseId:O.baseId,name:O.name,imageUrl:O.imageUrl,power:O.power,powerModifier:O.powerModifier,ability:O.ability,ownerId:O.ownerId,color:O.color,deck:O.deck,isFaceDown:O.isFaceDown,types:O.types,faction:O.faction,statuses:O.statuses})),discard:b.discard.map(O=>({id:O.id,baseId:O.baseId,name:O.name,imageUrl:O.imageUrl,power:O.power,powerModifier:O.powerModifier,ability:O.ability,ownerId:O.ownerId,color:O.color,deck:O.deck,isFaceDown:O.isFaceDown,types:O.types,faction:O.faction,statuses:O.statuses}))},score:b.score,isReady:b.isReady,announcedCard:b.announcedCard})),gameMode:R.gameMode,isPrivate:R.isPrivate,activeGridSize:R.activeGridSize,dummyPlayerCount:R.dummyPlayerCount,autoAbilitiesEnabled:R.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((w=e.current)==null?void 0:w.readyState)===WebSocket.OPEN&&e.current.send(JSON.stringify({type:"RESET_GAME",gameId:a.current.gameId}))},[e,r,a,d,E]);return{toggleActivePlayer:T,toggleAutoDraw:f,setPhase:D,nextPhase:u,prevPhase:y,closeRoundEndModal:p,closeRoundEndModalOnly:A,resetGame:S}}function Zs(t){const{ws:e,gameStateRef:r,updateState:n,updatePlayerScore:a,triggerFloatingText:s,clearTargetingMode:d}=t,c=H.useCallback((i,E,P,T,f)=>{var g,k;const D=r.current;if(!D.isGameStarted||D.isRoundEndModalOpen)return;const u=D.board.some(R=>R.some(b=>{var O,x;return((O=b.card)==null?void 0:O.ownerId)===f&&b.card.name.toLowerCase().includes("data liberator")&&((x=b.card.statuses)==null?void 0:x.some(U=>U.type==="Support"))})),y=D.board.length;let p=i,A=i,S=E,h=E;if(i===P)p=i,A=i,S=0,h=y-1;else if(E===T)S=E,h=E,p=0,A=y-1;else return;let w=0;const _=[];for(let R=p;R<=A;R++)for(let b=S;b<=h;b++){const x=D.board[R][b].card;if(x&&!((g=x.statuses)!=null&&g.some(U=>U.type==="Stun"))){const U=x.ownerId===f,N=(k=x.statuses)==null?void 0:k.some(G=>G.type==="Exploit"&&G.addedByPlayerId===f);if(U||u&&N){const G=Math.max(0,x.power+(x.powerModifier||0)+(x.bonusPower||0));G>0&&(w+=G,_.push({row:R,col:b,text:`+${G}`,playerId:f}))}}}_.length>0&&s(_);const m=We();if(m?n(R=>({...R,players:R.players.map(b=>b.id===f?{...b,score:Math.max(0,(b.score||0)+w)}:b)})):a(f,w),m||a(f,w),w>0&&D.currentPhase===4&&D.activePlayerId===f){const R=D.gameId;setTimeout(()=>{var b;d==null||d(),m?n(O=>gt(O)):((b=e.current)==null?void 0:b.readyState)===WebSocket.OPEN&&R&&e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:R}))},100)}},[s,a,n,e,r,d,gt]),o=H.useCallback((i,E,P,T,f,D)=>{var m,g,k;const u=r.current;if(!u.isGameStarted||u.isRoundEndModalOpen)return;const y=P>i?1:-1,p=T>E?1:-1,A=Math.abs(i-P);let S=0,h=0;const w=[];for(let R=0;R<=A;R++){const b=i+R*y,O=E+R*p;if(b<0||b>=u.board.length||O<0||O>=u.board.length)continue;const U=u.board[b][O].card;if(U&&!((m=U.statuses)!=null&&m.some(N=>N.type==="Stun"))){const N=U.ownerId===f,G=(g=U.statuses)==null?void 0:g.some($=>$.type==="Exploit"&&$.addedByPlayerId===f);if(N||G){const $=Math.max(0,U.power+(U.powerModifier||0)+(U.bonusPower||0));$>0&&(S+=$,w.push({row:b,col:O,text:`+${$}`,playerId:f})),D&&((k=U.statuses)!=null&&k.some(q=>q.type==="Support"&&q.addedByPlayerId===f))&&(h+=1)}}}D==="point_per_support"&&h>0&&(S+=h),w.length>0&&s(w);const _=We();if(_?n(R=>({...R,players:R.players.map(b=>b.id===f?{...b,score:Math.max(0,(b.score||0)+S)}:b)})):a(f,S),_||a(f,S),D==="draw_per_support"&&h>0&&n(R=>{const b=fe(R),O=b.players.find(x=>x.id===f);if(O&&O.deck.length>0)for(let x=0;x<h;x++)O.deck.length>0&&O.hand.push(O.deck.shift());return b}),S>0&&u.currentPhase===4&&u.activePlayerId===f){const R=u.gameId;setTimeout(()=>{var b;d==null||d(),_?n(O=>gt(O)):((b=e.current)==null?void 0:b.readyState)===WebSocket.OPEN&&R&&e.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:R}))},500)}},[s,a,n,e,r,d,gt]);return{scoreLine:c,scoreDiagonal:o}}const Qs=t=>{const{updateState:e,rawJsonData:r}=t,n=H.useCallback((T,f,D,u)=>{e(y=>{var S,h;if(!y.isGameStarted||T.row<0||T.col<0)return y;const p=fe(y),A=(h=(S=p.board[T.row])==null?void 0:S[T.col])==null?void 0:h.card;if(A){const w=A.statuses?A.statuses.map(_=>_.type):[];if(u&&A.statuses){A.statuses=A.statuses.filter(m=>m.type!==u);const _=A.statuses.map(m=>m.type);l.debug(`[markAbilityUsed] Removed status '${u}' from ${A.name} at [${T.row},${T.col}]: [${w.join(", ")}] -> [${_.join(", ")}]`)}else l.debug(`[markAbilityUsed] Called for ${A.name} at [${T.row},${T.col}] but no readyStatusToRemove specified. Current statuses: [${w.join(", ")}]`)}return p})},[e]),a=H.useCallback(T=>{e(f=>{var y,p;if(!f.isGameStarted||T.row<0||T.col<0)return f;const D=fe(f),u=(p=(y=D.board[T.row])==null?void 0:y[T.col])==null?void 0:p.card;if(u&&(u.statuses||(u.statuses=[]),(u.ability||"").toLowerCase().includes("deploy:")&&!u.statuses.some(S=>S.type==="readyDeploy"))){const S=u.ownerId;if(S==null||S===0)return f;u.statuses.push({type:"readyDeploy",addedByPlayerId:S})}return D})},[e]),s=H.useCallback((T,f)=>{e(D=>{if(!D.isGameStarted)return D;const u=fe(D),y=u.board[T.row][T.col].card;return y!=null&&y.statuses&&(y.statuses=y.statuses.filter(p=>p.type!==f)),u.board=Le(u),u})},[e]),d=H.useCallback((T,f,D,u,y)=>{e(p=>{if(!p.isGameStarted)return p;const A=fe(p);return f.forEach(({row:S,col:h})=>{var _;const w=A.board[S][h].card;if(w){if(D==="Stun"&&(w.baseId==="luciusTheImmortal"||w.name.includes("Lucius")&&((_=w.types)!=null&&_.includes("Hero"))))return;w.statuses||(w.statuses=[]),["Support","Threat","Revealed"].includes(D)?w.statuses.some(g=>g.type===D&&g.addedByPlayerId===u)||w.statuses.push({type:D,addedByPlayerId:u}):w.statuses.push({type:D,addedByPlayerId:u})}}),A})},[e]),c=H.useCallback((T,f)=>{e(D=>{if(!D.isGameStarted)return D;const u=fe(D),y=u.board[T.row][T.col].card,p=u.board[f.row][f.col].card;return u.board[T.row][T.col].card=p,u.board[f.row][f.col].card=y,u.board=Le(u),u})},[e]),o=H.useCallback((T,f,D)=>{e(u=>{if(!u.isGameStarted)return u;const y=fe(u),p=y.board[T.row][T.col].card,A=y.board[f.row][f.col].card;if(p&&A&&p.statuses){const S=p.statuses.findIndex(h=>h.type===D);if(S>-1){const[h]=p.statuses.splice(S,1);A.statuses||(A.statuses=[]),A.statuses.push(h)}}return y.board=Le(y),y})},[e]),i=H.useCallback((T,f)=>{e(D=>{if(!D.isGameStarted)return D;const u=fe(D),y=u.board[T.row][T.col].card,p=u.board[f.row][f.col].card,A=["Support","Threat","LastPlayed"];if(y&&p&&y.statuses){const S=y.statuses.filter(w=>!A.includes(w.type)),h=y.statuses.filter(w=>A.includes(w.type));S.length>0&&(p.statuses||(p.statuses=[]),p.statuses.push(...S),y.statuses=h)}return u.board=Le(u),u})},[e]),E=H.useCallback((T,f)=>{e(D=>{if(!D.isGameStarted)return D;const u=fe(D),y=u.board[T.row][T.col].card,p=u.board[f.row][f.col].card;return y&&p&&y.statuses&&y.statuses.length>0&&(p.statuses||(p.statuses=[]),p.statuses.push(...y.statuses),y.statuses=[]),u.board=Le(u),u})},[e]),P=H.useCallback((T,f,D)=>{e(u=>{if(!u.isGameStarted)return u;const y=fe(u);if(!r)return u;const p=r.tokenDatabase,A=Object.keys(p).find(w=>p[w].name===f);if(!A)return u;const S=p[A],h=y.players.find(w=>w.id===D);if(S&&y.board[T.row][T.col].card===null){const w={id:`TKN_${f.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:Ce.Tokens,name:f,baseId:S.baseId||A,imageUrl:S.imageUrl,fallbackImage:S.fallbackImage,power:S.power,ability:S.ability,flavorText:S.flavorText,color:S.color,types:S.types||["Unit"],faction:"Tokens",ownerId:D,ownerName:h==null?void 0:h.name,enteredThisTurn:!0,statuses:[]};Ir(w,D),y.board[T.row][T.col].card=w}return y.board=Le(y),y})},[e,r]);return{markAbilityUsed:n,applyGlobalEffect:d,swapCards:c,transferStatus:o,transferAllCounters:i,transferAllStatusesWithoutException:E,spawnToken:P,resetDeployStatus:a,removeStatusByType:s}};function ei(t){const{updateState:e,localPlayerIdRef:r,updatePlayerScore:n}=t,a=H.useCallback((o,i)=>{e(E=>{var p,A,S,h,w,_;if(!E.isGameStarted||i.target==="board"&&i.boardCoords&&E.board[i.boardCoords.row][i.boardCoords.col].card!==null&&o.source!=="counter_panel")return E;let P=!1;try{const m=localStorage.getItem("auto_abilities_enabled");P=m===null?!0:m==="true"}catch{P=!0}const T=P&&E.currentPhase===1&&o.source==="hand"&&i.target==="board"&&(((p=o.card.types)==null?void 0:p.includes("Unit"))||((A=o.card.types)==null?void 0:A.includes("Command"))),f=fe(E);if(o.source==="board"&&["hand","deck","discard"].includes(i.target)&&!o.bypassOwnershipCheck){const m=o.card.ownerId,g=f.players.find(b=>b.id===m),k=m===r.current,R=!!(g!=null&&g.isDummy);if(!k&&!R)return E}let D=null;if(o.source==="board"&&o.boardCoords){const m=f.board[o.boardCoords.row][o.boardCoords.col];if(m.card&&(D=m.card),i.target==="board"){const k=E.board[o.boardCoords.row][o.boardCoords.col].card||D;if(k&&((S=k.statuses)==null?void 0:S.some(b=>b.type==="Stun"))){const b=r.current,O=k.ownerId,x=E.players.find($=>$.id===b),U=E.players.find($=>$.id===O),N=b===O,G=(x==null?void 0:x.teamId)!==void 0&&(U==null?void 0:U.teamId)!==void 0&&x.teamId===U.teamId;if((N||G)&&!o.isManual)return E}}}if(o.source==="counter_panel"&&o.statusType){const m=ut[o.statusType],g=(m==null?void 0:m.allowedTargets)??["board","hand"];if(!g.includes(i.target)&&!g.includes("board-facedown"))return E;let k=null;if(i.target==="board"&&i.boardCoords){if(k=f.board[i.boardCoords.row][i.boardCoords.col].card,g.includes("board-facedown")&&k&&!k.isFaceDown)return E}else if(i.playerId!==void 0){const R=f.players.find(b=>b.id===i.playerId);R&&(i.target==="hand"&&i.cardIndex!==void 0&&(k=R.hand[i.cardIndex]),i.target==="announced"&&(k=R.announcedCard||null),i.target==="deck"&&R.deck.length>0?i.deckPosition==="top"||!i.deckPosition?k=R.deck[0]:k=R.deck[R.deck.length-1]:i.target==="discard"&&R.discard.length>0&&(k=R.discard[R.discard.length-1]))}if(k){if(o.statusType==="Stun"&&(k.baseId==="luciusTheImmortal"||k.name.includes("Lucius")&&((h=k.types)!=null&&h.includes("Hero"))))return f;const R=o.count||1;let b;if(o.ownerId!==void 0)b=o.ownerId;else if(o.card.ownerId!==void 0)b=o.card.ownerId;else{const O=f.players.find(x=>x.id===f.activePlayerId);b=O!=null&&O.isDummy?O.id:r.current!==null?r.current:0}if(o.statusType==="Revealed"&&(i.target==="board"&&k.ownerId===b||i.target==="hand"&&i.playerId===b))return E;if(o.statusType==="Power+")k.powerModifier===void 0&&(k.powerModifier=0),k.powerModifier+=1*R;else if(o.statusType==="Power-")k.powerModifier===void 0&&(k.powerModifier=0),k.powerModifier-=1*R;else if(o.statusType==="Revealed"&&i.target==="hand"){if(k.revealedTo||(k.revealedTo=[]),k.revealedTo!=="all"){const x=Array.isArray(k.revealedTo)?k.revealedTo:[];x.includes(b)||x.push(b),k.revealedTo=x}k.statuses||(k.statuses=[]),k.statuses.some(x=>x.type==="Revealed"&&x.addedByPlayerId===b)||k.statuses.push({type:"Revealed",addedByPlayerId:b})}else if(k.statuses||(k.statuses=[]),o.replaceStatusType&&o.statusType)for(let O=0;O<R;O++){const x=k.statuses.findIndex(U=>U.type===o.replaceStatusType&&U.addedByPlayerId===b);x!==-1?k.statuses[x]={type:o.statusType,addedByPlayerId:b}:k.statuses.push({type:o.statusType,addedByPlayerId:b})}else for(let O=0;O<R;O++)["Support","Threat","Revealed"].includes(o.statusType)?k.statuses.some(U=>U.type===o.statusType&&U.addedByPlayerId===b)||k.statuses.push({type:o.statusType,addedByPlayerId:b}):k.statuses.push({type:o.statusType,addedByPlayerId:b});return i.target==="board"&&(f.board=Le(f)),f}return E}const u=D?{...D}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const m=f.players.find(g=>g.id===o.playerId);if(m){const g=m.hand[o.cardIndex];if(g&&g.id===o.card.id&&g.ownerId===o.card.ownerId)m.hand.splice(o.cardIndex,1);else{const k=m.hand.findIndex(R=>R.id===o.card.id&&R.ownerId===o.card.ownerId);if(k!==-1)m.hand.splice(k,1);else return E}}}else if(o.source==="board"&&o.boardCoords){const m=f.board[o.boardCoords.row][o.boardCoords.col];if(m.card&&m.card.id===o.card.id&&m.card.ownerId===o.card.ownerId)f.board[o.boardCoords.row][o.boardCoords.col].card=null;else return E}else if(o.source==="discard"&&o.playerId!==void 0){const m=f.players.find(g=>g.id===o.playerId);if(m){let g=!1;if(o.cardIndex!==void 0){const k=m.discard[o.cardIndex];k&&k.id===o.card.id&&k.ownerId===o.card.ownerId&&(m.discard.splice(o.cardIndex,1),g=!0)}if(!g){const k=m.discard.findIndex(R=>R.id===o.card.id&&R.ownerId===o.card.ownerId);if(k!==-1)m.discard.splice(k,1);else return E}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const m=f.players.find(g=>g.id===o.playerId);if(m){const g=m.deck[o.cardIndex];if(g&&g.id===o.card.id&&g.ownerId===o.card.ownerId)m.deck.splice(o.cardIndex,1);else{const k=m.deck.findIndex(R=>R.id===o.card.id&&R.ownerId===o.card.ownerId);if(k!==-1)m.deck.splice(k,1);else return E}}}else if(o.source==="announced"&&o.playerId!==void 0){const m=f.players.find(g=>g.id===o.playerId);if(m)if(m.announcedCard&&m.announcedCard.id===o.card.id)m.announcedCard=null;else return E}if(["hand","deck","discard"].includes(i.target))u.statuses&&(u.statuses=u.statuses.filter(m=>m.type==="Revealed")),u.isFaceDown=!1,delete u.powerModifier,delete u.bonusPower,delete u.enteredThisTurn;else if(i.target==="board"&&(u.statuses||(u.statuses=[]),o.source!=="board"&&u.isFaceDown===void 0&&(u.isFaceDown=!1),o.source!=="board")){u.enteredThisTurn=!0;let m=u.ownerId;m===void 0&&(o.source==="token_panel"?o.ownerId!==void 0?m=o.ownerId:m=f.activePlayerId??r.current??0:o.playerId!==void 0?m=o.playerId:m=r.current??0,u.ownerId=m),Ir(u,m),o.source==="discard"&&(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius"))&&(u.powerModifier===void 0&&(u.powerModifier=0),u.powerModifier+=2)}if(i.target==="hand"&&i.playerId!==void 0){if(u.deck===Ce.Tokens)return f.board[o.boardCoords.row][o.boardCoords.col].card=null,f;Xt(u);const g=f.players.find(R=>R.id===i.playerId);if(!g)return E;let k=i.cardIndex!==void 0?i.cardIndex:g.hand.length;if(o.source==="hand"&&o.playerId===i.playerId&&o.cardIndex!==void 0&&(o.cardIndex<k&&(k-=1),o.cardIndex===k))return E;g.hand.splice(k,0,u)}else if(i.target==="board"&&i.boardCoords){if(f.board[i.boardCoords.row][i.boardCoords.col].card===null){if(u.ownerId===void 0&&r.current!==null){const m=f.players.find(g=>g.id===r.current);m&&(u.ownerId=m.id,u.ownerName=m.name)}if(o.source!=="board"&&u.ownerId!==void 0){const m=f.players.find(g=>g.id===u.ownerId);m&&(m.boardHistory||(m.boardHistory=[]),m.boardHistory.push(u.id))}f.board[i.boardCoords.row][i.boardCoords.col].card=u}}else if(i.target==="discard"&&i.playerId!==void 0){if(u.deck===Ce.Tokens)return f.board[o.boardCoords.row][o.boardCoords.col].card=null,f;Xt(u);const g=f.players.find(k=>k.id===i.playerId);g&&(u.ownerId===void 0&&(u.ownerId=i.playerId,u.ownerName=g.name),g.discard.some(R=>R.id===u.id)||g.discard.push(u))}else if(i.target==="deck"&&i.playerId!==void 0){if(u.deck===Ce.Tokens)return f.board[o.boardCoords.row][o.boardCoords.col].card=null,f;Xt(u);const g=f.players.find(k=>k.id===i.playerId);if(!g)return E;u.ownerId===void 0&&(u.ownerId=i.playerId,u.ownerName=g.name),i.deckPosition==="top"||!i.deckPosition?g.deck.unshift(u):g.deck.push(u)}else if(i.target==="announced"&&i.playerId!==void 0){const m=f.players.find(g=>g.id===i.playerId);m&&(m.announcedCard&&(m.announcedCard.statuses&&(m.announcedCard.statuses=m.announcedCard.statuses.filter(g=>g.type==="Revealed")),delete m.announcedCard.enteredThisTurn,delete m.announcedCard.powerModifier,delete m.announcedCard.bonusPower,m.hand.push(m.announcedCard)),m.announcedCard=u)}if(o.source==="board"&&i.target!=="board"&&u.ownerId!==void 0){const m=f.players.find(g=>g.id===u.ownerId);m&&(m.boardHistory||(m.boardHistory=[]),m.boardHistory=m.boardHistory.filter(g=>g!==u.id))}if((o.source==="board"||i.target==="board")&&u.ownerId!==void 0){const m=f.players.find(g=>g.id===u.ownerId);m&&Ta(f.board,m)}if(o.source==="hand"&&i.target==="board"){const m=u;if(m.revealedTo==="all"||((w=m.statuses)==null?void 0:w.some(k=>k.type==="Revealed"))){const k=f.board.length;for(let R=0;R<k;R++)for(let b=0;b<k;b++){const O=f.board[R][b].card;if(O&&O.name.toLowerCase().includes("vigilant spotter")&&O.ownerId!==m.ownerId&&(f.board=Le(f),(_=f.board[R][b].card.statuses)!=null&&_.some(U=>U.type==="Support"))){const U=f.players.find(N=>N.id===O.ownerId);U&&setTimeout(()=>{n(U.id,2)},0)}}}}return(o.source==="board"||i.target==="board")&&(f.board=Le(f)),T&&(f.currentPhase=2),f})},[e,r,n]),s=H.useCallback((o,i)=>{e(E=>{if(!E.isGameStarted)return E;const P=fe(E),T=P.board.length;if(o.row<0||o.row>=T||o.col<0||o.col>=T||i.row<0||i.row>=T||i.col<0||i.col>=T)return E;const f=P.board[o.row][o.col],D=P.board[i.row][i.col],u=f.card,y=D.card;return!u||!y?E:(P.board[o.row][o.col].card=y,P.board[i.row][i.col].card=u,P.board=Le(P),P)})},[e]),d=H.useCallback((o,i)=>{e(E=>{if(!E.isGameStarted)return E;const P=fe(E),T=P.board[i.row][i.col];if(!T.card||T.card.id!==o.id||T.card.ownerId!==o.ownerId)return E;const f=T.card,D=f.ownerId,u=P.players.find(y=>y.id===D);return u?(P.board[i.row][i.col].card=null,f.statuses&&(f.statuses=f.statuses.filter(y=>y.type==="Revealed")),f.isFaceDown=!1,delete f.powerModifier,delete f.bonusPower,u.discard.push(f),P.board=Le(P),P):E})},[e]),c=H.useCallback((o,i)=>{e(E=>{if(!E.isGameStarted)return E;const P=fe(E),T=P.board[i.row][i.col];if(!T.card||T.card.id!==o.id||T.card.ownerId!==o.ownerId)return E;const f=T.card,D=f.ownerId,u=P.players.find(y=>y.id===D);return u?(P.board[i.row][i.col].card=null,f.statuses&&(f.statuses=f.statuses.filter(y=>y.type==="Revealed")),f.isFaceDown=!1,delete f.powerModifier,delete f.bonusPower,u.hand.push(f),P.board=Le(P),P):E})},[e]);return{moveItem:a,swapBoardCards:s,destroyCard:d,returnCardToHand:c}}function ti(t){const{ws:e,webrtcManager:r,gameStateRef:n,webrtcIsHostRef:a,setGameState:s}=t,d=H.useCallback((o,i,E,P,T,f)=>{var S,h,w,_,m,g,k;const D=n.current;if(typeof i!="number"){l.error(`[TargetingMode] Invalid playerId type: ${typeof i}, value:`,i);return}let u=[];P?u=P:u=Wt(o,D,i,T);let y=[];if(f)y=f;else if(y=[],(S=o.payload)!=null&&S.filter&&o.mode==="SELECT_TARGET"){l.info("[TargetingMode] Calculating hand targets for action",{actionMode:o.mode,filterType:typeof o.payload.filter,hasActionType:!!o.payload.actionType});for(const R of D.players)R.hand&&R.hand.forEach((b,O)=>{try{o.payload.filter(b)&&(y.push({playerId:R.id,cardIndex:O}),l.debug(`[TargetingMode] Found hand target: player ${R.id}, card ${O}, card ${b.name}`))}catch(x){l.warn(`[TargetingMode] Filter failed for card ${b.name}:`,x)}});l.info(`[TargetingMode] Hand targets calculated: ${y.length} targets`)}else l.info("[TargetingMode] No hand targets calculated - no filter or wrong mode",{hasFilter:!!((h=o.payload)!=null&&h.filter),mode:o.mode});const p=o.mode==="SELECT_DECK",A={playerId:i,action:o,sourceCoords:E,timestamp:Date.now(),boardTargets:u,handTargets:y.length>0?y:void 0,isDeckSelectable:p||void 0,originalOwnerId:o.originalOwnerId};if(s(R=>({...R,targetingMode:A})),n.current.targetingMode=A,((w=e.current)==null?void 0:w.readyState)===WebSocket.OPEN&&D.gameId&&e.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:D.gameId,targetingMode:A})),r.current)if(a.current)r.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((m=(_=r.current).getPeerId)==null?void 0:m.call(_))??void 0,data:{targetingMode:A},timestamp:Date.now()});else{const R=r.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((k=(g=r.current).getPeerId)==null?void 0:k.call(g))??void 0,data:{targetingMode:A},timestamp:Date.now()});l.info("[TargetingMode] Guest sent SET_TARGETING_MODE to host",{success:R,playerId:i,boardTargetsCount:u.length,handTargetsCount:y.length})}l.info(`[TargetingMode] Player ${i} (type: ${typeof i}) activated targeting mode`,{mode:o.mode,boardTargetsCount:u.length,handTargetsCount:y.length,isDeckSelectable:p||!1})},[e,r,n,a,s]),c=H.useCallback(()=>{var i,E,P,T,f;const o=n.current;s(D=>({...D,targetingMode:null})),n.current.targetingMode=null,((i=e.current)==null?void 0:i.readyState)===WebSocket.OPEN&&o.gameId&&e.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:o.gameId})),r.current&&(a.current?r.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((P=(E=r.current).getPeerId)==null?void 0:P.call(E))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):r.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((f=(T=r.current).getPeerId)==null?void 0:f.call(T))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[e,r,n,a,s]);return{setTargetingMode:d,clearTargetingMode:c}}function ri(t){const{webrtcManagerRef:e,webrtcIsHostRef:r,setWebrtcIsHost:n,setConnectionStatus:a,setWebrtcHostId:s,gameStateRef:d,localPlayerIdRef:c}=t,o=H.useCallback(async()=>{var D;try{n(!0),a("Connecting");const u=fr();e.current=u;const y=await u.initializeAsHost();s(y),a("Connected");const p=d.current.gameId;p&&ur(y,p);const A=(D=d.current.players)==null?void 0:D.find(S=>S.id===c.current);return ls({peerId:y,isHost:!0,playerName:(A==null?void 0:A.name)||null}),l.info("[initializeWebrtcHost] Saved host data for auto-restore"),y}catch(u){return l.error("Failed to initialize WebRTC host:",u),a("Disconnected"),null}},[n,a,s,d,c,e]),i=H.useCallback(async D=>{try{n(!1),s(D),a("Connecting");const u=fr();return e.current=u,await u.initializeAsGuest(D),!0}catch(u){return l.error("Failed to connect as guest:",u),a("Disconnected"),!1}},[n,a,s,e]),E=H.useCallback((D,u)=>e.current?r.current?(l.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):e.current.sendAction(D,u):(l.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[e,r]),P=H.useCallback(D=>!e.current||r.current?(l.warn("[requestDeckView] Only guests can request deck view from host"),!1):e.current.sendAction("REQUEST_DECK_VIEW",{targetPlayerId:D}),[e,r]),T=H.useCallback((D,u,y)=>!e.current||r.current?(l.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):e.current.sendFullDeckToHost(D,u,y),[e,r]),f=H.useCallback((D,u)=>!e.current||!r.current?(l.warn("[shareHostDeckWithGuests] Only host can share deck data"),!1):e.current.broadcastToGuests({type:"HOST_DECK_DATA",senderId:e.current.getPeerId(),data:{deck:D,deckSize:u},timestamp:Date.now()}),[e,r]);return{initializeWebrtcHost:o,connectAsGuest:i,sendWebrtcAction:E,requestDeckView:P,sendFullDeckToHost:T,shareHostDeckWithGuests:f}}function ni(){const t=localStorage.getItem("custom_ws_url");if(!t||t.trim()==="")return l.warn("No custom WebSocket URL configured in settings."),null;let e=t.trim();return e.endsWith("/")&&(e=e.slice(0,-1)),e.startsWith("https://")?e=e.replace("https://","wss://"):e.startsWith("http://")&&(e=e.replace("http://","ws://")),!e.startsWith("ws://")&&!e.startsWith("wss://")?(l.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",e),e)}function ai(t){const{gameStateRef:e,localPlayerIdRef:r,setGameState:n,setLocalPlayerId:a,setConnectionStatus:s,setGamesList:d,setLatestHighlight:c,setLatestNoTarget:o,setLatestDeckSelections:i,setLatestHandCardSelections:E,setClickWaves:P,setLatestFloatingTexts:T,setRemoteValidTargets:f,isManualExitRef:D,joiningGameIdRef:u,playerTokenRef:y,receivedServerStateRef:p,isJoinAttemptRef:A}=t,S=H.useRef(null),h=H.useRef(null),w=H.useCallback(()=>{if(We()){s("Connected");return}if(D.current||S.current&&(S.current.readyState===WebSocket.OPEN||S.current.readyState===WebSocket.CONNECTING))return;const O=ni();if(!O){l.warn("No WebSocket URL configured in settings. Waiting for user input."),s("Disconnected"),h.current&&clearTimeout(h.current);return}try{S.current=new WebSocket(O)}catch(x){l.error("Failed to create WebSocket:",x),s("Disconnected"),h.current&&clearTimeout(h.current),h.current=window.setTimeout(w,ae.RECONNECT_DELAY);return}s("Connecting"),S.current.onopen=()=>{var N;p.current=!1,s("Connected");const x=localStorage.getItem("custom_ws_url");x&&x.trim()!==""&&localStorage.setItem("websocket_url",x.trim());const U=e.current;if(l.info("Current gameState on open:",U?`gameId=${U.gameId}`:"null"),l.info("playerTokenRef.current on open:",y.current?"YES":"NO"),U&&U.gameId&&((N=S.current)==null?void 0:N.readyState)===WebSocket.OPEN){let G=y.current;if(!G){try{const $=localStorage.getItem(dt);if($){const q=JSON.parse($);l.info("RECONNECTION_DATA_KEY:",q==null?void 0:q.gameId,U.gameId),q!=null&&q.playerToken&&(G=q.playerToken,y.current=G,l.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch($){console.warn("Failed to parse reconnection data:",$ instanceof Error?$.message:String($))}if(!G&&U.players&&r.current){const $=U.players.find(q=>q.id===r.current);$!=null&&$.playerToken&&(G=$.playerToken,y.current=G)}}l.info("JoinGame: Sending reconnection with token:",G?"YES":"NO","gameId:",U.gameId),S.current.send(JSON.stringify({type:"JOIN_GAME",gameId:U.gameId,playerToken:G}))}},S.current.onmessage=x=>{var U;try{const N=JSON.parse(x.data);if(N.type==="GAMES_LIST")d(N.games);else if(N.type==="JOIN_SUCCESS"){if(N.isSpectator){a(null),l.info("Joined as spectator:",N.message||"Spectator mode"),u.current=null;return}a(N.playerId);const G=u.current||e.current.gameId;G&&N.playerId!==null&&N.playerToken?(y.current=N.playerToken,localStorage.setItem(dt,JSON.stringify({gameId:G,playerId:N.playerId,playerToken:N.playerToken,timestamp:Date.now()})),e.current.gameId===G&&Xn(e.current,N.playerId,N.playerToken)):N.playerId===null&&(Tt(),y.current=void 0),u.current=null,N.playerId===1&&setTimeout(()=>{var $;(($=S.current)==null?void 0:$.readyState)===WebSocket.OPEN&&S.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:qe}))},ae.DECK_SYNC_DELAY)}else if(N.type==="CONNECTION_ESTABLISHED"){l.info("Connection acknowledged by server");const G=sessionStorage.getItem("pending_invite_game"),$=sessionStorage.getItem("pending_invite_name");G&&S.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),l.info("Auto-joining invite game:",G),S.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:G,playerName:$||"Player"})))}else if(N.type==="DECK_DATA_UPDATED")l.info("Deck data synced with server");else if(N.type==="ERROR")if(N.message.includes("not found")||N.message.includes("Dummy")){l.info("Game not found error - clearing state");const G=it();n(G),e.current=G,a(null),Tt(),u.current=null}else if(N.message.includes("already started")&&A.current){l.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const G=it();n(G),e.current=G,a(null),Tt(),u.current=null,A.current=!1}else console.warn("Server Error:",N.message);else if(N.type==="HIGHLIGHT_TRIGGERED")c(N.highlightData);else if(N.type==="NO_TARGET_TRIGGERED")o({coords:N.coords,timestamp:N.timestamp});else if(N.type==="DECK_SELECTION_TRIGGERED")i(G=>[...G,N.deckSelectionData]),setTimeout(()=>{i(G=>G.filter($=>$.timestamp!==N.deckSelectionData.timestamp))},1e3);else if(N.type==="HAND_CARD_SELECTION_TRIGGERED")E(G=>[...G,N.handCardSelectionData]),setTimeout(()=>{E(G=>G.filter($=>$.timestamp!==N.handCardSelectionData.timestamp))},1e3);else if(N.type==="FLOATING_TEXT_TRIGGERED")n(G=>({...G,floatingTexts:[...G.floatingTexts,N.floatingTextData].filter($=>Date.now()-$.timestamp<ae.FLOATING_TEXT_DURATION)}));else if(N.type==="FLOATING_TEXT_BATCH_TRIGGERED")n(G=>({...G,floatingTexts:[...G.floatingTexts,...N.batch].filter($=>Date.now()-$.timestamp<ae.FLOATING_TEXT_DURATION)}));else if(N.type==="CLICK_WAVE_TRIGGERED")N.wave&&N.wave.clickedByPlayerId!==r.current&&(P(G=>[...G,N.wave]),setTimeout(()=>{P(G=>G.filter($=>$.timestamp!==N.wave.timestamp))},600));else if(N.type==="TARGETING_MODE_SET"){const G=N.targetingMode;if(G){n(q=>({...q,targetingMode:G})),e.current.targetingMode=G;const $=G.mode||((U=G.action)==null?void 0:U.mode);l.info("[TargetingMode] Received targeting mode from server",{playerId:G.playerId,mode:$})}}else if(N.type==="TARGETING_MODE_CLEARED")n(G=>({...G,targetingMode:null})),e.current.targetingMode=null,l.debug("[TargetingMode] Cleared targeting mode from server");else if(N.type==="ABILITY_MODE_SET")N.abilityMode&&(n(G=>({...G,abilityMode:N.abilityMode})),l.info("[AbilityMode] Received ability mode from host",{playerId:N.abilityMode.playerId,mode:N.abilityMode.mode,sourceCard:N.abilityMode.sourceCardName}));else if(N.type==="ABILITY_TARGET_SELECTED")l.info("[Ability] Target selected",N.data);else if(N.type==="ABILITY_COMPLETED")n(G=>({...G,abilityMode:void 0})),l.info("[Ability] Ability completed",N.data);else if(N.type==="ABILITY_CANCELLED")n(G=>({...G,abilityMode:void 0})),l.info("[Ability] Ability cancelled");else if(N.type==="GAME_RESET")l.info("[GameReset] Received GAME_RESET message from server"),n(G=>{const $=N.activeGridSize||8,q=[];for(let J=0;J<$;J++){const oe=[];for(let pe=0;pe<$;pe++)oe.push({card:null});q.push(oe)}const Q={...G,players:N.players||[],gameMode:N.gameMode,isPrivate:N.isPrivate,activeGridSize:N.activeGridSize,dummyPlayerCount:N.dummyPlayerCount,autoAbilitiesEnabled:N.autoAbilitiesEnabled,isGameStarted:N.isGameStarted,currentPhase:N.currentPhase,currentRound:N.currentRound,turnNumber:N.turnNumber,activePlayerId:N.activePlayerId,startingPlayerId:N.startingPlayerId,roundWinners:N.roundWinners||{},gameWinner:N.gameWinner,isRoundEndModalOpen:N.isRoundEndModalOpen,isReadyCheckActive:N.isReadyCheckActive,board:q,targetingMode:null,floatingTexts:[]};return e.current=Q,Q});else if(!N.type&&N.players&&N.board){const G=Lt(N),$=e.current;if(!$.isScoringStep&&G.isScoringStep&&G.currentPhase!==2){l.debug("Ignoring delayed scoring state update");return}if($.isScoringStep&&(G.currentPhase!==$.currentPhase||G.activePlayerId!==$.activePlayerId||G.currentPhase!==4)&&(G.isScoringStep=!1),n(G),e.current=G,r.current!==null&&G.gameId){let Q;try{const J=localStorage.getItem(dt);J&&(Q=JSON.parse(J).playerToken)}catch{}if(!Q&&G.players){const J=G.players.find(oe=>oe.id===r.current);J!=null&&J.playerToken&&(Q=J.playerToken,y.current=Q)}Xn(G,r.current,Q)}}else console.warn("Unknown message type:",N.type,"keys:",Object.keys(N),"data:",N)}catch(N){l.error("Failed to parse message from server:",x.data,N)}},S.current.onclose=()=>{s("Disconnected"),D.current||(h.current&&clearTimeout(h.current),h.current=window.setTimeout(w,ae.RECONNECT_DELAY))},S.current.onerror=x=>l.error("WebSocket error event:",x)},[n,s,d,c,o,i,E,P,T,f,a,it,D,e,r,y,p,u]),_=H.useCallback(()=>{S.current&&(S.current.readyState===WebSocket.OPEN||S.current.readyState===WebSocket.CONNECTING)?S.current.close():w()},[S,w]),m=H.useCallback(O=>{var x;if(D.current=!1,((x=S.current)==null?void 0:x.readyState)===WebSocket.OPEN){u.current=O;let U=null;try{const G=localStorage.getItem(dt);G&&(U=JSON.parse(G))}catch{Tt()}const N={type:"JOIN_GAME",gameId:O};(U==null?void 0:U.gameId)===O&&U.playerToken?(N.playerToken=U.playerToken,l.info(`JoinGame: Sending reconnection with token ${U.playerToken.substring(0,8)}... for player ${U.playerId}`)):l.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${U==null?void 0:U.gameId}, requestedGameId=${O}`),S.current.send(JSON.stringify(N))}else w(),u.current=O},[S,D,u,w]),g=H.useCallback((O,x="Player")=>{var U;D.current=!1,((U=S.current)==null?void 0:U.readyState)===WebSocket.OPEN?S.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:O,playerName:x})):(sessionStorage.setItem("pending_invite_game",O),sessionStorage.setItem("pending_invite_name",x),w())},[w]),k=H.useCallback(()=>{D.current=!1,Tt();const O=ga(),x={...it(),gameId:O,players:[wa(1)]};return p.current=!0,setTimeout(()=>{var U;((U=S.current)==null?void 0:U.readyState)===WebSocket.OPEN&&(S.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:O})),S.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:qe})))},ae.DECK_SYNC_DELAY),{gameId:O,initialState:x}},[D,p]),R=H.useCallback(()=>{var O;((O=S.current)==null?void 0:O.readyState)===WebSocket.OPEN&&S.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[S]),b=H.useCallback((O,x,U,N)=>{var q;if(O.current)return;D.current=!0;const G=e.current.gameId,$=r.current;G&&x.current&&U(G);try{N(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),l.info("[exitGame] Cleared WebRTC persistence data")}catch(Q){l.warn("[exitGame] Failed to clear WebRTC data:",Q)}n(it()),a(null),Tt(),S.current&&(S.current.onclose=null),((q=S.current)==null?void 0:q.readyState)===WebSocket.OPEN&&G&&$!==null&&S.current.send(JSON.stringify({type:"EXIT_GAME",gameId:G,playerId:$})),S.current&&S.current.close(),setTimeout(()=>{D.current=!1,w()},ae.RECONNECT_DELAY)},[e,r,D,n,a,S,w]);return{ws:S,reconnectTimeoutRef:h,connectWebSocket:w,forceReconnect:_,createGame:k,joinGame:m,joinAsInvite:g,exitGame:b,requestGamesList:R}}const rt=new Map,dd=(t={})=>{const{abilityMode:e,setAbilityMode:r}=t,[n,a]=H.useState(it()),s=H.useRef(it()),d=H.useCallback(I=>{a(ne=>{const ee=typeof I=="function"?I(ne):I;return s.current=ne,We()&&V.current&&setTimeout(()=>{Y.current&&(Y.current.broadcastGameState(ee),l.debug(`[setGameStateWithDelta] Broadcast state: phase=${ee.currentPhase}, round=${ee.currentRound}`))},0),ee})},[]),[c,o]=H.useState(null),i=H.useRef(n),E=H.useRef(c),[P,T]=H.useState(null),[f,D]=H.useState("Connecting"),[u,y]=H.useState([]),[p,A]=H.useState(null),[S,h]=H.useState(null),[w,_]=H.useState(null),[m,g]=H.useState([]),[k,R]=H.useState([]),[b,O]=H.useState([]),[x,U]=H.useState(null),[N,G]=H.useState(!!qe),[$,q]=H.useState(!1),[Q,J]=H.useState(null),[oe,pe]=H.useState(!1),V=H.useRef(!1),[Se,ke]=H.useState(!1),[De,xe]=H.useState(null),ve=H.useRef(!1),we=H.useRef(null),je=H.useRef(!1),Kt=H.useRef(!1),pt=H.useRef(),Ze=H.useRef(!1),Y=H.useRef(null),Oe=H.useRef(new Map),Fe=H.useRef(()=>{}),et=ri({webrtcManagerRef:Y,webrtcIsHostRef:V,setWebrtcIsHost:pe,setConnectionStatus:D,setWebrtcHostId:J,gameStateRef:i,localPlayerIdRef:E}),{initializeWebrtcHost:yt,connectAsGuest:bt,sendWebrtcAction:at,requestDeckView:Ar,sendFullDeckToHost:qt,shareHostDeckWithGuests:ot}=et,ht=ai({gameStateRef:i,localPlayerIdRef:E,setGameState:a,setLocalPlayerId:o,setConnectionStatus:D,setGamesList:y,setLatestHighlight:A,setLatestNoTarget:_,setLatestDeckSelections:g,setLatestHandCardSelections:R,setClickWaves:O,setLatestFloatingTexts:h,setRemoteValidTargets:U,isManualExitRef:je,joiningGameIdRef:we,playerTokenRef:pt,receivedServerStateRef:Ze,isJoinAttemptRef:Kt}),{ws:Te,reconnectTimeoutRef:mt,connectWebSocket:Sr,forceReconnect:_a,joinGame:Cr,joinAsInvite:ba,requestGamesList:Aa}=ht;H.useEffect(()=>{Fe.current=d},[d]),H.useEffect(()=>{V.current=oe},[oe]),H.useEffect(()=>{const I=We();if(q(I),I){Y.current=fr();const ne=Y.current.on(ee=>{va(ee)});return()=>{ne()}}},[]),H.useEffect(()=>{if(!We())return;const ne=window.location.hash.slice(1);if(ne&&new URLSearchParams(ne).get("hostId"))return;const ee="webrtc_auto_restore_attempted";if(sessionStorage.getItem(ee))return;sessionStorage.setItem(ee,"true");const te=us();if(te==="none"){sessionStorage.removeItem(ee);return}setTimeout(async()=>{var de,re;if(!Y.current){l.warn("[Auto-restore] WebRTC manager not ready");return}try{if(te==="host"){Je.current=!0,l.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ie=da(),X=Wn();if(!ie||!X){l.warn("[Auto-restore] Missing host data or state data"),st(),Je.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}l.info(`[Auto-restore] Restoring host session: old peerId=${ie.peerId}`);const Ee=await Y.current.initializeAsHost();V.current=!0,pe(!0),J(Ee),D("Connected"),(de=X.gameState)!=null&&de.gameId&&(ur(Ee,X.gameState.gameId),l.info(`[Auto-restore] Broadcasted NEW host peerId ${Ee} for game ${X.gameState.gameId}`)),(X.gameState||X.localPlayerId!==null)&&(X.gameState&&(i.current=X.gameState),X.localPlayerId!==null&&(E.current=X.localPlayerId),ve.current=!0,setTimeout(()=>{ve.current=!1},1e4),setTimeout(()=>{var _e;X.gameState&&(a(X.gameState),l.info(`[Auto-restore] Restored game state with ${((_e=X.gameState.players)==null?void 0:_e.length)||0} players, gameId=${X.gameState.gameId}`)),X.localPlayerId!==null&&(o(X.localPlayerId),l.info(`[Auto-restore] Restored local player ID: ${X.localPlayerId}`))},0)),setTimeout(()=>{if(Je.current=!1,l.info("[Auto-restore] Cleared restoration flag"),Y.current&&X.gameState){const _e=X.gameState.players.filter(He=>!He.isDummy&&He.id!==X.localPlayerId);_e.length>0&&(l.info(`[Auto-restore] Requesting deck data from ${_e.length} guest players`),Y.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:Y.current.getPeerId(),timestamp:Date.now()}))}},500),l.info("[Auto-restore] Host session restoration initiated")}else if(te==="guest"){Je.current=!0,l.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ie=ca(),X=Wn();if(!ie||!X){l.warn("[Auto-restore] Missing guest data or state data"),st(),Je.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}l.info(`[Auto-restore] Restoring guest session: old hostPeerId=${ie.hostPeerId}, playerId=${ie.playerId}`),V.current=!1,pe(!1),D("Connecting");let Ee=ie.hostPeerId;if((re=X.gameState)!=null&&re.gameId){const _e=er(X.gameState.gameId);_e&&_e.peerId&&(Ee=_e.peerId,l.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Ee}`))}if(J(Ee),ie.playerId!==null){l.info(`[Auto-restore] Reconnecting as existing player ${ie.playerId} to host ${Ee}`);try{await Y.current.initializeAsReconnectingGuest(Ee,ie.playerId),D("Connected"),l.info("[Auto-restore] Successfully reconnected to host")}catch(_e){l.error("[Auto-restore] Failed to reconnect to host:",_e),D("Disconnected"),st(),l.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),Je.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else l.info("[Auto-restore] Connecting as new player"),await Y.current.initializeAsGuest(Ee),D("Connected");(X.gameState||X.localPlayerId!==null)&&(X.gameState&&(i.current=X.gameState),X.localPlayerId!==null&&(E.current=X.localPlayerId),ve.current=!0,setTimeout(()=>{ve.current=!1},1e4),setTimeout(()=>{var _e,He;if(X.gameState&&(a(X.gameState),l.info(`[Auto-restore] Restored game state with ${((_e=X.gameState.players)==null?void 0:_e.length)||0} players, gameId=${X.gameState.gameId}, isGameStarted=${X.gameState.isGameStarted}`),X.localPlayerId!==null)){const ue=(He=X.gameState.players)==null?void 0:He.some(ye=>ye.id===X.localPlayerId);l.info(`[Auto-restore] Player ${X.localPlayerId} exists in restored state: ${ue}`)}X.localPlayerId!==null&&(o(X.localPlayerId),l.info(`[Auto-restore] Restored local player ID: ${X.localPlayerId}`))},0)),setTimeout(()=>{Je.current=!1,l.info("[Auto-restore] Cleared restoration flag")},100),l.info("[Auto-restore] Guest session restoration initiated")}}catch(ie){l.error("[Auto-restore] Failed to restore session:",ie),st(),Je.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),H.useEffect(()=>{if(!$||!Y.current)return;const I=window.location.hash.slice(1);if(!I)return;const ee=new URLSearchParams(I).get("hostId");ee&&bt(ee)},[$]),H.useEffect(()=>{i.current=n},[n]),H.useEffect(()=>{E.current=c},[c]),H.useEffect(()=>{if(!n||!n.players||!c)return;const I=is(n.players,c);ss.preloadMany(I,"low")},[n==null?void 0:n.players,c]);const Sa=Ys({ws:Te,webrtcManager:Y,gameStateRef:i,localPlayerIdRef:E,webrtcIsHostRef:V,setLatestHighlight:A,setLatestFloatingTexts:h,setLatestNoTarget:_,setLatestDeckSelections:g,setLatestHandCardSelections:R,setClickWaves:O,setGameState:a}),{triggerHighlight:Ca,triggerFloatingText:Dr,triggerNoTarget:Da,triggerDeckSelection:Ra,triggerHandCardSelection:Pa,syncValidTargets:ka,triggerClickWave:Oa}=Sa,Je=H.useRef(!1);H.useEffect(()=>{if(!$||!V.current||!(n!=null&&n.gameId))return;const I=n.gameId,ne=()=>{var de;const te=(de=Y.current)==null?void 0:de.getPeerId();te&&I&&ur(te,I)};ne();const ee=setInterval(ne,2e3);return()=>clearInterval(ee)},[$,n==null?void 0:n.gameId]),H.useEffect(()=>{if(!$||V.current||!(n!=null&&n.gameId))return;const I=n.gameId,ne=de=>{var re;J(de),D("Connecting"),(re=Y.current)==null||re.initializeAsReconnectingGuest(de,E.current||0).then(()=>{D("Connected")}).catch(ie=>{l.error("[Guest Auto-Reconnect] Failed to reconnect:",ie),D("Disconnected")})},ee=de=>{const re=`webrtc_host_${I}`;if(!(de.key!==re||!de.newValue))try{const X=JSON.parse(de.newValue).peerId;X&&X!==Q&&ne(X)}catch(ie){l.error("[Guest Auto-Reconnect] Failed to parse storage event:",ie)}},te=setInterval(()=>{const de=er(I);de&&de.peerId!==Q&&(l.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${de.peerId}`),ne(de.peerId))},2e3);return window.addEventListener("storage",ee),()=>{window.removeEventListener("storage",ee),clearInterval(te)}},[$,n==null?void 0:n.gameId,Q]),H.useEffect(()=>{const I=setInterval(()=>{a(ne=>{const ee=Date.now(),te=ne.floatingTexts||[],de=te.filter(re=>ee-re.timestamp<ae.FLOATING_TEXT_DURATION);return de.length!==te.length?{...ne,floatingTexts:de}:ne})},ae.DECK_SYNC_DELAY);return()=>clearInterval(I)},[]);const va=H.useCallback(I=>{var ne,ee,te;switch(I.type){case"peer_open":(ne=I.data)!=null&&ne.peerId&&(J(I.data.peerId),l.info(`WebRTC peer opened with ID: ${I.data.peerId}`));break;case"guest_connected":l.info("Guest connected via WebRTC:",(ee=I.data)==null?void 0:ee.peerId);break;case"connected_to_host":(te=I.data)!=null&&te.hostPeerId&&Q!==I.data.hostPeerId&&(J(I.data.hostPeerId),l.info(`Updated webrtcHostId to: ${I.data.hostPeerId}`)),D("Connected"),ke(!1),xe(null),ve.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(l.warn("WebRTC peer disconnected"),D("Disconnected"),ke(!0),!V.current&&Q&&n)try{const re={hostPeerId:Q,playerId:c,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(re)),l.info("[Reconnection] Stored reconnection data before disconnect"),La(Q)}catch(re){l.error("[Reconnection] Failed to store data:",re)}break;case"message_received":const de=I.data.message||I.data;Ma(de);break;case"error":l.error("WebRTC error:",I.data);break}},[n,c,Q,oe]),Na=H.useCallback((I,ne)=>{if(l.info(`[handleWebrtcGuestJoin] Called for guest ${I}, isHost: ${V.current}`),!V.current||!Y.current){l.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const ee=(ne==null?void 0:ne.preferredDeck)||"Random";a(te=>{if(!te)return l.error("[handleWebrtcGuestJoin] No previous state"),te;l.info(`[handleWebrtcGuestJoin] Current state has ${te.players.length} players`);const de=te.players.map(ue=>ue.id);let re=1;for(;de.includes(re);)re++;const ie={id:re,name:`Player ${re}`,color:_t[(re-1)%_t.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:ee,boardHistory:[],autoDrawEnabled:!0},X={...te,players:[...te.players,ie]},Ee=te.board.map(ue=>ue.map(ye=>({...ye,card:ye.card?{id:ye.card.id,baseId:ye.card.baseId,ownerId:ye.card.ownerId,name:ye.card.name,imageUrl:ye.card.imageUrl,power:ye.card.power,ability:ye.card.ability,isFaceDown:ye.card.isFaceDown,statuses:ye.card.statuses||[]}:null}))),_e=ue=>ue.map(ye=>({id:ye.id,baseId:ye.baseId,name:ye.name,imageUrl:ye.imageUrl,power:ye.power,powerModifier:ye.powerModifier,ability:ye.ability,ownerId:ye.ownerId,color:ye.color,deck:ye.deck,isFaceDown:ye.isFaceDown,types:ye.types,faction:ye.faction,statuses:ye.statuses}));Y.current.acceptGuestMinimal(I,{playerId:re,gameId:te.gameId,isGameStarted:te.isGameStarted,players:X.players.map(ue=>ue.isDummy?{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,hand:_e(ue.hand||[]),deck:_e(ue.deck||[]),discard:_e(ue.discard||[]),handSize:ue.hand.length,deckSize:ue.deck.length,discardSize:ue.discard.length}:{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,deckSize:ue.deck.length,handSize:ue.hand.length,discardSize:ue.discard.length}),deckSelections:X.players.map(ue=>({id:ue.id,selectedDeck:ue.selectedDeck})),gameMode:te.gameMode,currentRound:te.currentRound,currentPhase:te.currentPhase,activePlayerId:te.activePlayerId,startingPlayerId:te.startingPlayerId,activeGridSize:te.activeGridSize,board:Ee},re),Y.current.broadcastGameState(X,I),Y.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:Y.current.getPeerId(),data:{playerId:re,selectedDeck:ee},timestamp:Date.now()});const He=X.players.find(ue=>ue.id===E.current);if(He&&He.deck.length>0){const ue=He.deck.map(ye=>({id:ye.id,baseId:ye.baseId,power:ye.power,powerModifier:ye.powerModifier||0,isFaceDown:ye.isFaceDown||!1,statuses:ye.statuses||[]}));Y.current.sendToGuest(I,{type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:He.id,data:{playerId:He.id,deckType:He.selectedDeck,deck:ue,deckSize:ue.length},timestamp:Date.now()}),l.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${He.selectedDeck}, ${ue.length} cards`)}return X})},[]),Rr=H.useCallback(I=>{const ne=V.current;if(l.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!Y.current}, webrtcIsHostRef.current=${ne}`),!Y.current||!ne){l.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}Y.current.broadcastGameState(I)},[]),Ma=H.useCallback(I=>{var ne,ee,te,de,re,ie,X,Ee,_e,He,ue,ye,Or,vr,Nr,Mr,Lr,Gr,xr,Ur,$r,Hr,Fr,Wr,Br,Yr,zr,Kr,qr,Vr,jr,Jr,Xr,Zr,Qr,en,tn,rn,nn,an,on,sn,dn,cn,ln,un,fn,pn,yn,hn,mn,In,En,Tn,gn,wn,_n,bn,An,Sn,Cn,Dn,Rn,Pn,kn,On,vn,Nn,Mn,Ln,Gn,xn,Un,$n;if(!(!I||!I.type))switch(l.info(`[handleWebrtcMessage] Received: ${I.type}`),I.type){case"JOIN_ACCEPT_MINIMAL":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${I.playerId}`),I.data){const C=I.data;l.info(`[handleWebrtcMessage] Creating minimal state with ${((ne=C.players)==null?void 0:ne.length)||0} players`);const v={gameId:C.gameId||ga(),isGameStarted:C.isGameStarted||!1,isPrivate:!1,activeGridSize:C.activeGridSize||4,gameMode:C.gameMode||yr.FreeForAll,dummyPlayerCount:0,players:((ee=C.players)==null?void 0:ee.map(M=>{if((M.isDummy||!1)&&M.hand&&M.deck&&M.discard)return{id:M.id,name:M.name,color:M.color,isDummy:!0,isReady:M.isReady||!1,score:M.score||0,hand:M.hand||[],deck:M.deck||[],discard:M.discard||[],announcedCard:null,selectedDeck:M.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const B=[],F=[],z=[];for(let L=0;L<(M.handSize||0);L++)B.push({id:`placeholder_${M.id}_hand_${L}`,name:"?",isPlaceholder:!0,ownerId:M.id,deck:M.selectedDeck||"Random",color:M.color});for(let L=0;L<(M.deckSize||0);L++)F.push({id:`placeholder_${M.id}_deck_${L}`,name:"?",isPlaceholder:!0,ownerId:M.id,deck:M.selectedDeck||"Random",color:M.color});for(let L=0;L<(M.discardSize||0);L++)z.push({id:`placeholder_${M.id}_discard_${L}`,name:"?",isPlaceholder:!0,ownerId:M.id,deck:M.selectedDeck||"Random",color:M.color});return{id:M.id,name:M.name,color:M.color,isDummy:!1,isReady:M.isReady||!1,score:M.score||0,hand:B,deck:F,discard:z,announcedCard:null,selectedDeck:M.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:C.board||la(),hostId:1,currentPhase:C.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:C.currentRound||1,turnNumber:C.turnNumber||1,activePlayerId:C.activePlayerId??null,startingPlayerId:C.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};a(v),I.playerId!==void 0&&(o(I.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${I.playerId}`)),a(M=>{const W=M.players.map(B=>{var z;const F=(z=C.players)==null?void 0:z.find(L=>L.id===B.id);if(B.id===I.playerId){const K=B.deck.length===0||B.deck.some(j=>j.isPlaceholder)||B.deck.length!==30;if(F!=null&&F.selectedDeck&&K){const j=nt(F.selectedDeck,B.id,B.name);l.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${j.length} cards from ${F.selectedDeck}`),Y.current&&j.length>0&&setTimeout(()=>{const le=j.map(Z=>({id:Z.id,baseId:Z.baseId,power:Z.power,powerModifier:Z.powerModifier||0,isFaceDown:Z.isFaceDown||!1,statuses:Z.statuses||[]}));Y.current.sendAction("DECK_DATA_UPDATE",{playerId:I.playerId,deck:le,deckSize:le.length}),l.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${F.selectedDeck}, ${le.length} cards`)},0);const se=[...B.hand],ce=[...j];if(C.isGameStarted&&se.length===0&&ce.length>0){for(let Z=0;Z<6&&Z<ce.length;Z++){const Ie=ce[0];ce.splice(0,1),se.push(Ie)}l.info(`[JOIN_ACCEPT_MINIMAL] Drew ${se.length} cards, deck now has ${ce.length} cards`)}return{...B,deck:ce,hand:se,selectedDeck:F.selectedDeck}}}return B});return{...M,players:W}});try{const M=(te=Y.current)==null?void 0:te.getHostPeerId();M&&Qt({hostPeerId:M,playerId:I.playerId,playerName:((de=v.players.find(W=>W.id===I.playerId))==null?void 0:de.name)||null,isHost:!1})}catch(M){l.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",M)}}break;case"JOIN_ACCEPT":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${I.playerId}, hasState: ${!!((re=I.data)!=null&&re.gameState)}`),(ie=I.data)!=null&&ie.gameState){const C=I.data.gameState;if(l.info(`[handleWebrtcMessage] Setting game state with ${((X=C.players)==null?void 0:X.length)||0} players`),a(C),I.playerId!==void 0){o(I.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${I.playerId}`);try{const v=(Ee=Y.current)==null?void 0:Ee.getHostPeerId(),M=C.players.find(W=>W.id===I.playerId);v&&Qt({hostPeerId:v,playerId:I.playerId,playerName:(M==null?void 0:M.name)||null,isHost:!1})}catch(v){l.warn("[JOIN_ACCEPT] Failed to save guest data:",v)}}}break;case"JOIN_ACCEPT_BINARY":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${I.playerId}`),I.data instanceof Uint8Array)try{const C=ws(I.data),v=C;if(l.info(`[handleWebrtcMessage] Expanded binary state with ${((_e=v.players)==null?void 0:_e.length)||0} players`),a(v),I.playerId!==void 0){o(I.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${I.playerId}`);try{const M=(He=Y.current)==null?void 0:He.getHostPeerId(),W=v.players.find(B=>B.id===I.playerId);M&&Qt({hostPeerId:M,playerId:I.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(M){l.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",M)}}l.info(`[handleWebrtcMessage] Received optimized binary game state: ${I.data.byteLength} bytes`)}catch(C){l.error("[handleWebrtcMessage] Failed to deserialize binary game state:",C)}break;case"STATE_UPDATE_COMPACT":let Ue=(ue=I.data)==null?void 0:ue.gameState;if(((ye=I.data)==null?void 0:ye._format)==="msgpack"&&typeof Ue=="string")try{Ue=Kn(Ue),l.info("[STATE_UPDATE_COMPACT] Decoded MessagePack format")}catch(C){l.error("[STATE_UPDATE_COMPACT] Failed to decode MessagePack:",C);break}if(V.current){if(I.senderId&&I.senderId!==((Or=Y.current)==null?void 0:Or.getPeerId())&&(l.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${I.senderId}`),Ue)){const C=Ue;a(v=>{const M=I.playerId;if(M===void 0)return l.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),v;const W=v.players.map(z=>{if(z.id===M){const L=C.players.find(K=>K.id===M);if(L){const K=le=>{const Z=Ke(le.baseId);return Z?{...Z,id:le.id,baseId:le.baseId,ownerId:M,power:le.power,powerModifier:le.powerModifier,isFaceDown:le.isFaceDown,statuses:le.statuses||[]}:{id:le.id,baseId:le.baseId,name:"Unknown",power:0}},j=(L.handCards||[]).map(K),se=(L.deckCards||[]).map(K),ce=(L.discardCards||[]).map(K);return l.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${M}: hand=${j.length}, deck=${se.length}, discard=${ce.length}, score=${L.score||0}`),{...z,hand:j,deck:se,discard:ce,handSize:j.length,deckSize:se.length,discardSize:ce.length,score:L.score||z.score}}}else{const L=C.players.find(j=>j.id===z.id);if(!L)return z;if(z.isDummy===!0&&(L.handCards&&L.handCards.length>0||L.deckCards&&L.deckCards.length>0||L.discardCards&&L.discardCards.length>0)){const j=Z=>{const Ie=Ke(Z.baseId);return Ie?{...Ie,id:Z.id,baseId:Z.baseId,ownerId:z.id,power:Z.power,powerModifier:Z.powerModifier||0,isFaceDown:Z.isFaceDown||!1,statuses:Z.statuses||[]}:{id:Z.id,baseId:Z.baseId,name:"Unknown",power:0}},se=(L.handCards||[]).map(j),ce=(L.deckCards||[]).map(j),le=(L.discardCards||[]).map(j);return l.info(`[STATE_UPDATE_COMPACT] Host: Guest ${M} modified dummy player ${z.id}: hand=${se.length}, deck=${ce.length}, discard=${le.length}`),{...z,hand:se,deck:ce,discard:le,handSize:se.length,deckSize:ce.length,discardSize:le.length}}else if(L.handCards&&L.handCards.length>0&&z.hand){const j=L.handCards||[],se=z.hand.map(ce=>{const le=j.find(Z=>Z.id===ce.id);return le&&le.statuses?{...ce,statuses:le.statuses,isFaceDown:le.isFaceDown}:ce});return{...z,hand:se,handSize:se.length}}}return z}),B=C.board?C.board.map(z=>z.map(L=>{if(!L||!L.card)return L;const K=Ke(L.card.baseId||L.card.id);if(K){const j=L.card.ownerId;return{...L,card:{...K,id:L.card.id,baseId:L.card.baseId||L.card.id,ownerId:j,ownerName:L.card.ownerName,power:L.card.power,powerModifier:L.card.powerModifier,isFaceDown:L.card.isFaceDown||!1,statuses:L.card.statuses||[],enteredThisTurn:L.card.enteredThisTurn,deck:L.card.deck}}}return L})):v.board,F={...v,...C,players:W,board:B};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(F,I.senderId)},0),F})}}else if(!V.current&&((vr=I.data)!=null&&vr.gameState)){const C=I.data.recipientPlayerId??null;if(l.info(`[STATE_UPDATE_COMPACT] Received compact state for player ${C}, currentPhase=${Ue.currentPhase}, activePlayerId=${Ue.activePlayerId}`),ve.current){a(v=>(l.info(`[STATE_UPDATE_COMPACT] Skipping - recently restored from localStorage, updating phase from ${v.currentPhase} to ${Ue.currentPhase}`),{...v,currentPhase:Ue.currentPhase,activePlayerId:Ue.activePlayerId,startingPlayerId:Ue.startingPlayerId,isReadyCheckActive:Ue.isReadyCheckActive,isGameStarted:Ue.isGameStarted}));return}a(v=>{const M=C===null||C===E.current;l.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${C}, local=${E.current}, isForLocal=${M}`);const W=Ue.players.map(L=>{var j,se;const K=v.players.find(ce=>ce.id===L.id);if(L.id===E.current&&K){const ce=Z=>{if(Z.baseId){const be=Ke(Z.baseId);if(be)return{...be,id:Z.id,ownerId:E.current,power:Z.power,powerModifier:Z.powerModifier,isFaceDown:Z.isFaceDown,statuses:Z.statuses||[]}}return K.hand.find(be=>be.id===Z.id)||K.deck.find(be=>be.id===Z.id)||K.discard.find(be=>be.id===Z.id)||{id:Z.id,name:"Unknown",power:0}};if(L.handCards&&L.handCards.length>0||L.deckCards&&L.deckCards.length>0||L.discardCards&&L.discardCards.length>0){const Z=(L.handCards||[]).map(ce),Ie=(L.deckCards||[]).map(ce),be=(L.discardCards||[]).map(ce);return Z.forEach((he,$e)=>{var ge,me;(me=(ge=L.handCards)==null?void 0:ge[$e])!=null&&me.baseId&&!he.baseId&&(he.baseId=L.handCards[$e].baseId)}),Ie.forEach((he,$e)=>{var ge,me;(me=(ge=L.deckCards)==null?void 0:ge[$e])!=null&&me.baseId&&!he.baseId&&(he.baseId=L.deckCards[$e].baseId)}),be.forEach((he,$e)=>{var ge,me;(me=(ge=L.discardCards)==null?void 0:ge[$e])!=null&&me.baseId&&!he.baseId&&(he.baseId=L.discardCards[$e].baseId)}),l.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${Z.length} hand, ${Ie.length} deck, ${be.length} discard`),{...L,hand:Z,deck:Ie,discard:be}}else{const Z=(L.handIds||[]).map(he=>K.hand.find(ge=>ge.id===he)||K.deck.find(ge=>ge.id===he)||K.discard.find(ge=>ge.id===he)||{id:he,name:"?",isPlaceholder:!1}),Ie=(L.deckIds||[]).map(he=>K.deck.find(ge=>ge.id===he)||K.hand.find(ge=>ge.id===he)||K.discard.find(ge=>ge.id===he)||{id:he,name:"?",isPlaceholder:!1}),be=(L.discardIds||[]).map(he=>K.discard.find(ge=>ge.id===he)||K.hand.find(ge=>ge.id===he)||K.deck.find(ge=>ge.id===he)||{id:he,name:"?",isPlaceholder:!1});return l.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${Z.length} hand, ${Ie.length} deck, ${be.length} discard`),{...L,hand:Z,deck:Ie,discard:be}}}else{const ce=L.deckSize??((j=L.deck)==null?void 0:j.length)??0,le=L.handSize??((se=L.hand)==null?void 0:se.length)??0,Z=L.deckCards&&L.deckCards.length>0;let Ie;if(Z){const me=L.deckCards[0];if((me==null?void 0:me.name)&&(me==null?void 0:me.imageUrl))Ie=L.deckCards.map(Ae=>({id:Ae.id,baseId:Ae.baseId||Ae.id,name:Ae.name,imageUrl:Ae.imageUrl,fallbackImage:Ae.fallbackImage||"",power:Ae.power,powerModifier:Ae.powerModifier||0,isFaceDown:Ae.isFaceDown??!1,statuses:Ae.statuses||[],deck:Ae.deck||"SynchroTech",color:Ae.color||"Red",ability:Ae.ability||"",bonusPower:Ae.bonusPower||0,isPlaceholder:Ae.isPlaceholder||!1,types:Ae.types||[],faction:Ae.faction||"",ownerId:L.id})),l.debug(`[STATE_UPDATE_COMPACT] Using full deck data for player ${L.id}: ${Ie.length} cards`);else{const Ae=Ye=>{if(Ye.baseId){const At=Ke(Ye.baseId);if(At)return{...At,id:Ye.id,baseId:Ye.baseId,ownerId:L.id,power:Ye.power,powerModifier:Ye.powerModifier,isFaceDown:Ye.isFaceDown,statuses:Ye.statuses||[]}}return{id:Ye.id,name:"Unknown",power:0}};if(Ie=L.deckCards.map(Ae),L.id===3){const Ye={};Ie.forEach(At=>{const Hn=At.baseId||At.id;Ye[Hn]=(Ye[Hn]||0)+1}),l.info(`[STATE_UPDATE_COMPACT] Reconstructed deck for Player 3 (dummy): ${Ie.length} cards`,Ye)}l.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${L.id}: ${Ie.length} cards`)}}else if(K&&K.deck.length>0&&K.deck.some(Re=>!Re.isPlaceholder)){const Re=K.deck.length;Ie=K.deck.slice(0,ce),L.id===3&&l.info(`[STATE_UPDATE_COMPACT] Player 3 deck slice: before=${Re}, remoteDeckSize=${ce}, after=${Ie.length}`),l.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${L.id}: ${Ie.length} cards`)}else{Ie=[];for(let Re=0;Re<ce;Re++)Ie.push({id:`placeholder_${L.id}_deck_${Re}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color})}const be=(me,Re)=>{if(me.baseId&&!me.isPlaceholder&&!me.isCardBack){const Ae=Ke(me.baseId);if(Ae)return{...Ae,id:me.id,baseId:me.baseId,ownerId:L.id,power:me.power,powerModifier:me.powerModifier||0,isFaceDown:me.isFaceDown||!1,statuses:me.statuses||[]}}return{id:me.id||`placeholder_${L.id}_hand_${Re}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color}};let he;const $e=L.handCards&&L.handCards.length>0,ge=L.hand&&L.hand.length>0;if($e)he=L.handCards.map(Re=>{const Ae=Ke(Re.baseId);return Ae?{...Ae,id:Re.id,baseId:Re.baseId,ownerId:L.id,power:Re.power,powerModifier:Re.powerModifier||0,isFaceDown:Re.isFaceDown||!1,statuses:Re.statuses||[]}:{id:Re.id,baseId:Re.baseId,name:"Unknown",power:Re.power||0,ownerId:L.id,isPlaceholder:!1}}),l.info(`[STATE_UPDATE_COMPACT] Reconstructed ${he.length} hand cards from handCards for player ${L.id}`);else if(ge){he=L.hand.map((Re,Ae)=>be(Re,Ae));const me=he.filter(Re=>!Re.isPlaceholder).length;me>0&&l.info(`[STATE_UPDATE_COMPACT] Reconstructed ${me}/${he.length} revealed hand cards for player ${L.id}`)}else{he=[];for(let me=0;me<le;me++)he.push({id:`placeholder_${L.id}_hand_${me}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color})}return{...L,hand:he,deck:Ie,discard:(K==null?void 0:K.discard)||[]}}}),B=Ue.board?Ue.board.map(L=>L.map(K=>{if(!K||!K.card)return K;const j=Ke(K.card.baseId||K.card.id);return j?{...K,card:{...j,id:K.card.id,baseId:K.card.baseId||K.card.id,ownerId:K.card.ownerId,ownerName:K.card.ownerName,power:K.card.power,powerModifier:K.card.powerModifier,isFaceDown:K.card.isFaceDown||!1,statuses:K.card.statuses||[],enteredThisTurn:K.card.enteredThisTurn,deck:K.card.deck}}:K})):v.board,F=Le({...Ue,players:W,board:B}),z={...Ue,players:W,board:F};return l.info(`[STATE_UPDATE_COMPACT] Merged state: currentPhase=${z.currentPhase}, activePlayerId=${z.activePlayerId}, startingPlayerId=${z.startingPlayerId}`),z})}break;case"STATE_UPDATE":if(V.current&&I.senderId&&I.senderId!==((Nr=Y.current)==null?void 0:Nr.getPeerId())){if(l.info(`[STATE_UPDATE] Host received state from guest ${I.senderId}`),(Mr=I.data)!=null&&Mr.gameState){const C=I.data.gameState;a(v=>{const M=I.playerId;if(M===void 0)return l.warn("[STATE_UPDATE] Guest state missing playerId"),v;const W=v.players.map(z=>{if(z.id===M){const L=C.players.find(K=>K.id===M);if(L){const K=Z=>({...Z,ownerId:M}),j=(L.hand||[]).map(K),se=(L.deck||[]).map(K),ce=(L.discard||[]).map(K);l.info(`[STATE_UPDATE] Merging guest ${M} state: hand=${j.length}, deck=${se.length}, discard=${ce.length}`);const le={...z,hand:j,deck:se,discard:ce,handSize:j.length,deckSize:se.length,discardSize:ce.length};return l.info(`[STATE_UPDATE] After merge - player ${M}: deckSize=${le.deckSize}, handSize=${le.handSize}`),le}}return z}),B=C.board?C.board.map(z=>z.map(L=>!L||!L.card?L:{...L,card:{...L.card,ownerId:L.card.ownerId}})):v.board,F={...v,players:W,board:B};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(F,I.senderId)},0),F})}break}if(Ze.current=!0,(Lr=I.data)!=null&&Lr.gameState){const C=I.data.gameState;if(ve.current){a(v=>({...v,currentPhase:C.currentPhase,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,isReadyCheckActive:C.isReadyCheckActive,isGameStarted:C.isGameStarted}));return}a(v=>{var B;const M=C.players.map(F=>{var L,K,j;const z=v.players.find(se=>se.id===F.id);if(F.id===E.current&&z){const se=z.hand.every(le=>le.isPlaceholder)||z.hand.length===0,ce=F.handSize??((L=F.hand)==null?void 0:L.length)??0;if(se&&F.hand&&F.hand.length>0)return{...F,hand:F.hand,deck:F.deck||z.deck,discard:F.discard||z.discard};{let le=z.hand,Z=z.deck;if(ce>z.hand.length&&Z.length>0){const Ie=ce-z.hand.length,be=[...z.hand],he=[...z.deck];for(let $e=0;$e<Ie&&$e<he.length;$e++){const ge=he[0];he.splice(0,1),be.push(ge)}le=be,Z=he}return{...F,hand:le,deck:Z,discard:F.discard||z.discard}}}else{if(F.isDummy||!1)return l.info(`[STATE_UPDATE] Using real cards for dummy player ${F.id}`),{...F,hand:F.hand||[],deck:F.deck||[],discard:F.discard||[]};const ce=F.deckSize??((K=F.deck)==null?void 0:K.length)??0,le=F.handSize??((j=F.hand)==null?void 0:j.length)??0;l.info(`[STATE_UPDATE] Player ${F.id}: deckSize=${ce}, handSize=${le}`);const Z=[];for(let be=0;be<ce;be++)Z.push({id:`placeholder_${F.id}_deck_${be}`,name:"?",isPlaceholder:!0,ownerId:F.id,deck:F.selectedDeck||"Random",color:F.color});const Ie=[];for(let be=0;be<le;be++)Ie.push({id:`placeholder_${F.id}_hand_${be}`,name:"?",isPlaceholder:!0,ownerId:F.id,deck:F.selectedDeck||"Random",color:F.color});return l.info(`[STATE_UPDATE] Created ${Z.length} deck placeholders and ${Ie.length} hand placeholders for player ${F.id}`),{...F,hand:Ie,deck:Z,discard:F.discard||[]}}}),W={...C,players:M};if(!V.current)try{((B=Y.current)==null?void 0:B.getHostPeerId())&&E.current!==null&&(St({gameState:W,localPlayerId:E.current,isHost:!1}),l.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(F){l.warn("[STATE_UPDATE] Failed to persist guest state:",F)}return W})}break;case"RECONNECT_SNAPSHOT":Ze.current=!0;let Ne=I.data;if(((Gr=I.data)==null?void 0:Gr._format)==="msgpack"&&typeof I.data=="object")try{Ne=Kn(I.data.data||I.data),l.info("[RECONNECT_SNAPSHOT] Decoded MessagePack format")}catch(C){l.error("[RECONNECT_SNAPSHOT] Failed to decode MessagePack:",C),Ne=I.data}Ne&&a(C=>{const v=E.current,M=Ne.players.map(B=>{const F=C.players.find(j=>j.id===B.id);if(B.id===v&&F&&F.hand.some(se=>!se.isPlaceholder)){let se=[...F.hand];const ce=[...F.deck];if(B.handSize>se.length){const le=B.handSize-se.length;for(let Z=0;Z<le&&ce.length>0;Z++)se.push(ce.shift())}else B.handSize<se.length&&(se=se.slice(0,B.handSize));return{...B,hand:se,deck:ce,discard:F.discard}}const z=[];for(let j=0;j<B.handSize;j++)z.push({id:`placeholder_${B.id}_hand_${j}`,name:"?",isPlaceholder:!0,ownerId:B.id,deck:B.selectedDeck||"Random",color:B.color});const L=[];for(let j=0;j<B.deckSize;j++)L.push({id:`placeholder_${B.id}_deck_${j}`,name:"?",isPlaceholder:!0,ownerId:B.id,deck:B.selectedDeck||"Random",color:B.color});const K=[];for(let j=0;j<B.discardSize;j++)K.push({id:`placeholder_${B.id}_discard_${j}`,name:"?",isPlaceholder:!0,ownerId:B.id,deck:B.selectedDeck||"Random",color:B.color});return{...B,hand:z,deck:L,discard:K}}),W={gameId:Ne.gameId,gameMode:Ne.gameMode,isPrivate:Ne.isPrivate,isGameStarted:Ne.isGameStarted,isReadyCheckActive:Ne.isReadyCheckActive,activeGridSize:Ne.activeGridSize,currentPhase:Ne.currentPhase,isScoringStep:Ne.isScoringStep,activePlayerId:Ne.activePlayerId,startingPlayerId:Ne.startingPlayerId,currentRound:Ne.currentRound,turnNumber:Ne.turnNumber,roundWinners:Ne.roundWinners||{},gameWinner:Ne.gameWinner,isRoundEndModalOpen:Ne.isRoundEndModalOpen,dummyPlayerCount:Ne.dummyPlayerCount,players:M,board:Ne.board,spectators:C.spectators,hostId:C.hostId,revealRequests:C.revealRequests,preserveDeployAbilities:C.preserveDeployAbilities,highlights:C.highlights,floatingTexts:C.floatingTexts,targetingMode:C.targetingMode,abilityMode:C.abilityMode};if(!V.current&&v!==null)try{St({gameState:W,localPlayerId:v,isHost:!1}),l.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(B){l.warn("[RECONNECT_SNAPSHOT] Failed to save state:",B)}return l.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${W.currentPhase}, players=${W.players.length}`),W});break;case"STATE_DELTA":if(V.current||(Ze.current=!0),l.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${V.current}, senderId: ${I.senderId}`),(xr=I.data)!=null&&xr.delta){const C=I.data.delta;l.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Ur=C.boardCells)==null?void 0:Ur.length)||0}, phaseDelta=${!!C.phaseDelta}`),C.boardCells&&C.boardCells.length>0&&C.boardCells.forEach(v=>{var M,W;l.info(`[STATE_DELTA] Board cell [${v.row},${v.col}]: card=${((M=v.card)==null?void 0:M.name)||"(empty)"}, owner=${(W=v.card)==null?void 0:W.ownerId}`)}),V.current&&I.senderId&&Y.current&&(l.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${I.senderId} to other guests`),Y.current.broadcastStateDelta(C,I.senderId)),C.phaseDelta&&l.info("[STATE_DELTA] phaseDelta:",JSON.stringify(C.phaseDelta)),C.playerDeltas&&Object.entries(C.playerDeltas).forEach(([v,M])=>{l.info(`[STATE_DELTA] Player ${v} delta: handSizeDelta=${M.handSizeDelta}, deckSizeDelta=${M.deckSizeDelta}`)}),a(v=>{const M=E.current||v.localPlayerId;l.info(`[STATE_DELTA] Applying delta with localPlayerId=${M}, currentPhase before=${v.currentPhase}`);const W=sr(v);l.info(`[STATE_DELTA] Applying delta with localPlayerId=${M}, currentPhase after=${W.currentPhase}`);try{W.gameId&&M!==null&&(St({gameState:W,localPlayerId:M,isHost:V.current}),l.debug(`[STATE_DELTA] Saved state for ${V.current?"host":"guest"} auto-restore`))}catch(B){l.warn("[STATE_DELTA] Failed to persist state:",B)}return W})}break;case"STATE_DELTA_BINARY":{V.current||(Ze.current=!0),l.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${V.current}, senderId: ${I.senderId}, dataType=${(Hr=($r=I.data)==null?void 0:$r.constructor)==null?void 0:Hr.name}, typeof=${typeof I.data}`);let C=null;if(I.data instanceof Uint8Array)try{C=ma(I.data),C&&l.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Fr=C.boardCells)==null?void 0:Fr.length)||0}`)}catch(v){l.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",v)}else if(typeof I.data=="string")try{C=bs(I.data),C&&l.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${I.data.length} chars): playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Wr=C.boardCells)==null?void 0:Wr.length)||0}, phaseDelta=${!!C.phaseDelta}`)}catch(v){l.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",v)}else l.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof I.data}, constructor: ${(Yr=(Br=I.data)==null?void 0:Br.constructor)==null?void 0:Yr.name}`);C&&(V.current&&I.senderId&&Y.current&&(l.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${I.senderId} to other guests`),Y.current.broadcastStateDelta(C,I.senderId)),a(v=>{const M=E.current||v.localPlayerId;l.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${M}, currentPhase before=${v.currentPhase}`);const W=sr(v);l.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${W.currentPhase}, board has ${W.board.flat().filter(B=>B==null?void 0:B.card).length} cards`);try{W.gameId&&M!==null&&(St({gameState:W,localPlayerId:M,isHost:V.current}),l.debug(`[STATE_DELTA_BINARY] Saved state for ${V.current?"host":"guest"} auto-restore`))}catch(B){l.warn("[STATE_DELTA_BINARY] Failed to persist state:",B)}return W}));break}case"CARD_STATE":if(typeof I.data=="string")try{const C=atob(I.data),v=new Uint8Array(C.length);for(let M=0;M<C.length;M++)v[M]=C.charCodeAt(M);a(M=>Et(2,v,M,E.current||M.localPlayerId).gameState)}catch(C){l.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",C)}else I.data instanceof Uint8Array&&a(C=>Et(2,I.data,C,E.current||C.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof I.data=="string")try{const C=atob(I.data),v=new Uint8Array(C.length);for(let M=0;M<C.length;M++)v[M]=C.charCodeAt(M);a(M=>{const{gameState:W}=Et(3,v,M,E.current||M.localPlayerId);return W})}catch(C){l.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",C)}else I.data instanceof Uint8Array&&a(C=>{const{gameState:v}=Et(3,I.data,C,E.current||C.localPlayerId);return v});break;case"SESSION_EVENT":if(typeof I.data=="string")try{const C=atob(I.data),v=new Uint8Array(C.length);for(let M=0;M<C.length;M++)v[M]=C.charCodeAt(M);a(M=>Et(4,v,M,E.current||M.localPlayerId).gameState)}catch(C){l.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",C)}else I.data instanceof Uint8Array&&a(C=>Et(4,I.data,C,E.current||C.localPlayerId).gameState);break;case"JOIN_REQUEST":l.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${I.senderId}, isHost: ${V.current}`),V.current&&I.senderId?(l.info(`Host received JOIN_REQUEST from ${I.senderId}, data:`,I.data),Na(I.senderId,I.data)):l.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${V.current}, senderId: ${I.senderId}`);break;case"ACTION":if(V.current&&I.data){const{actionType:C,actionData:v}=I.data;if(C==="STATE_UPDATE"&&(v!=null&&v.gameState)){if(ve.current){Y.current&&I.senderId&&Y.current.sendToGuest(I.senderId,{type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:i.current},timestamp:Date.now()});break}a(M=>{const W=v.gameState,B=W.players.map(z=>{const L=M.players.find(K=>K.id===z.id);return L&&z.id!==E.current?{...z,deck:L.deck||z.deck,discard:L.discard||z.discard,score:L.score}:z}),F={...W,players:B};return Y.current&&Y.current.broadcastToGuests({type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:F},timestamp:Date.now()}),F})}else if(C==="STATE_DELTA"&&(v!=null&&v.delta))a(M=>{const W=v.delta;let B=W;ve.current&&W.playerDeltas&&(B={...W,playerDeltas:Object.fromEntries(Object.entries(W.playerDeltas).map(([z,L])=>{const K={...L};return delete K.scoreDelta,[z,K]}))}),E.current||M.localPlayerId;const F=sr(M);return Y.current&&Y.current.broadcastStateDelta(B),F});else if(C==="NEXT_PHASE")a(M=>{const W=M,B=W.currentPhase,F=B===2&&!W.isScoringStep,z=B+1;return{...W,currentPhase:z,...F&&{isScoringStep:!0}}});else if(C==="PREV_PHASE")a(M=>{const W=M;return W.isScoringStep?{...W,isScoringStep:!1,currentPhase:Math.max(1,W.currentPhase-1)}:{...W,currentPhase:Math.max(1,W.currentPhase-1)}});else if(C==="SET_PHASE"&&(v==null?void 0:v.phaseIndex)!==void 0)a(M=>({...M,currentPhase:v.phaseIndex}));else if(C==="UPDATE_PLAYER_NAME"&&(v==null?void 0:v.playerId)!==void 0&&(v==null?void 0:v.name)!==void 0)a(M=>({...M,players:M.players.map(W=>W.id===v.playerId?{...W,name:v.name}:W)}));else if(C==="CHANGE_PLAYER_COLOR"&&(v==null?void 0:v.playerId)!==void 0&&(v==null?void 0:v.color)!==void 0){const M=v.playerId,W=v.color;a(B=>{const F={...B,players:B.players.map(z=>z.id===M?{...z,color:W}:z)};return Y.current&&Y.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:Y.current.getPeerId(),data:{playerId:M,color:W},timestamp:Date.now()}),F})}else if(C==="UPDATE_PLAYER_SCORE"&&(v==null?void 0:v.playerId)!==void 0&&(v==null?void 0:v.delta)!==void 0){const M=v.playerId,W=v.delta;a(B=>{const F={...B,players:B.players.map(z=>z.id===M?{...z,score:Math.max(0,z.score+W)}:z)};return Y.current&&Y.current.broadcastToGuests({type:"UPDATE_PLAYER_SCORE",senderId:Y.current.getPeerId(),data:{playerId:M,delta:W},timestamp:Date.now()}),F})}else if(C==="CHANGE_PLAYER_DECK"&&(v==null?void 0:v.playerId)!==void 0){const M=v.playerId,W=v.deckType,B=v.deck;a(F=>{const z=F.players.find(j=>j.id===M);if(!z)return F;let L;B&&B.length>0?(l.info(`[CHANGE_PLAYER_DECK] Host received ${B.length} cards for player ${M}`),L=B.map(j=>{if(j.baseId){const se=Ke(j.baseId);if(se)return{...se,id:j.id,baseId:j.baseId,deck:W,ownerId:M,ownerName:z.name,power:j.power,powerModifier:j.powerModifier||0,isFaceDown:j.isFaceDown||!1,statuses:j.statuses||[]}}return{id:j.id,baseId:j.id,name:"Unknown",deck:W,ownerId:M,ownerName:z.name,power:j.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(L=nt(W,M,z.name),l.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${M} with ${L.length} cards from ${W}`));const K={...F,players:F.players.map(j=>j.id===M?{...j,selectedDeck:W,deck:L,hand:[],discard:[],announcedCard:null,boardHistory:[]}:j)};if(Y.current){const j=L.map(se=>({id:se.id,baseId:se.baseId,power:se.power,powerModifier:se.powerModifier||0,isFaceDown:se.isFaceDown||!1,statuses:se.statuses||[]}));Y.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:M,data:{playerId:M,deckType:W,deck:j,deckSize:j.length},timestamp:Date.now()})}return K})}else if(C==="TOGGLE_ACTIVE_PLAYER"&&(v==null?void 0:v.playerId)!==void 0)a(M=>{if(!M.players.find(F=>F.id===v.playerId))return M;const B=Ea(M,v.playerId);return Y.current&&Y.current.broadcastGameState(B),B});else if(C==="TOGGLE_AUTO_DRAW"&&(v==null?void 0:v.playerId)!==void 0)a(M=>({...M,players:M.players.map(W=>W.id===v.playerId?{...W,autoDrawEnabled:!W.autoDrawEnabled}:W)}));else if(C==="START_NEXT_ROUND")a(M=>({...M,isRoundEndModalOpen:!1,currentRound:(M.currentRound||1)+1,players:M.players.map(W=>({...W,score:0}))}));else if(C==="RESET_DEPLOY_STATUS")a(M=>{const W=M.board.map(B=>B.map(F=>{var z;return(z=F.card)!=null&&z.statuses?{...F,card:{...F.card,statuses:F.card.statuses.filter(L=>L.type!=="DeployAbilityUsed")}}:F}));return{...M,board:W,preserveDeployAbilities:!1}});else if(C==="DECK_DATA_UPDATE"&&(v==null?void 0:v.playerId)!==void 0&&(v!=null&&v.deck)){const M=v.playerId,W=v.deck,B=v.deckSize;l.info(`[ACTION] DECK_DATA_UPDATE: Received ${W.length} cards for guest ${M}`),a(F=>({...F,players:F.players.map(z=>z.id===M?{...z,deck:[...W],deckSize:B||W.length}:z)}))}else l.warn(`[ACTION] Unknown action type: ${C}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(l.info(`[PLAYER_RECONNECT] Guest ${I.playerId} reconnecting from ${I.senderId}`),V.current&&I.playerId!==void 0&&I.senderId){const C=i.current;if(l.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(C!=null&&C.gameId)}, gameId=${C==null?void 0:C.gameId}, hasPlayers=${((zr=C==null?void 0:C.players)==null?void 0:zr.length)||0}`),C&&C.gameId){l.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${I.playerId}`);const v=Us(C,I.playerId);(Kr=Y.current)==null||Kr.sendToGuest(I.senderId,{type:"RECONNECT_SNAPSHOT",senderId:Y.current.getPeerId(),data:v.data,timestamp:Date.now()}),l.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${I.playerId}`)}else l.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((qr=I.data)==null?void 0:qr.isReadyCheckActive)!==void 0||((Vr=I.data)==null?void 0:Vr.isPrivate)!==void 0)&&a(C=>({...C,isReadyCheckActive:I.data.isReadyCheckActive??!0,isPrivate:I.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((jr=I.data)==null?void 0:jr.isReadyCheckActive)!==void 0&&a(C=>({...C,isReadyCheckActive:I.data.isReadyCheckActive}));break;case"PLAYER_READY":V.current&&I.playerId!==void 0?a(C=>{const v=C.players.map(F=>F.id===I.playerId?{...F,isReady:!0}:F),M={...C,players:v};l.info(`Player ${I.playerId} is ready via WebRTC`),Y.current&&(Y.current.broadcastGameState(M),l.info(`[PLAYER_READY] Broadcasted ready status for player ${I.playerId}`));const W=M.players.filter(F=>!F.isDummy&&!F.isDisconnected);if(W.length>0&&W.every(F=>F.isReady)&&!M.isGameStarted){const F=M.players.filter(j=>!j.isDisconnected),z=Math.floor(Math.random()*F.length),L=F[z].id;let K={...M};return K.isReadyCheckActive=!1,K.isGameStarted=!0,K.startingPlayerId=L,K.activePlayerId=L,K.currentPhase=0,K.players=K.players.map(j=>{if(j.hand.length===0&&j.deck.length>0){const ce=[...j.hand],le=[...j.deck];for(let Z=0;Z<6&&Z<le.length;Z++){const Ie=le[0];le.splice(0,1),ce.push(Ie)}return l.info(`[PLAYER_READY] Drew ${ce.length} cards for player ${j.id}`),{...j,hand:ce,deck:le}}return j}),K=wr(K,L),l.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${K.currentPhase}`),Y.current&&(Y.current.broadcastToGuests({type:"GAME_START",senderId:Y.current.getPeerId(),data:{startingPlayerId:L,activePlayerId:L,currentPhase:K.currentPhase,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{l.info(`[PLAYER_READY] Sending ACTIVE_PLAYER_CHANGED after game start: activePlayerId=${L}, currentPhase=${K.currentPhase}`),Y.current&&Y.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:Y.current.getPeerId(),data:{activePlayerId:K.activePlayerId,currentPhase:K.currentPhase,turnNumber:K.turnNumber},timestamp:Date.now()})},100)),K}return M}):V.current;break;case"ASSIGN_TEAMS":(Jr=I.data)!=null&&Jr.assignments&&a(C=>{const v=C.players.map(M=>{let W=M.teamId||1;for(const[B,F]of Object.entries(I.data.assignments))if(F.includes(M.id)){W=parseInt(B);break}return{...M,teamId:W}});return{...C,players:v}});break;case"SET_GAME_MODE":((Xr=I.data)==null?void 0:Xr.mode)!==void 0&&a(C=>({...C,gameMode:I.data.mode}));break;case"SET_GAME_PRIVACY":((Zr=I.data)==null?void 0:Zr.isPrivate)!==void 0&&a(C=>({...C,isPrivate:I.data.isPrivate}));break;case"SET_GRID_SIZE":((Qr=I.data)==null?void 0:Qr.size)!==void 0&&a(C=>{const v=I.data.size,M=[];for(let W=0;W<v;W++){const B=[];for(let F=0;F<v;F++)B.push({card:null});M.push(B)}return{...C,activeGridSize:v,board:M}});break;case"SET_DUMMY_PLAYER_COUNT":((en=I.data)==null?void 0:en.count)!==void 0&&a(C=>({...C,dummyPlayerCount:I.data.count}));break;case"HOST_READY":I.playerId!==void 0&&(l.info(`[handleWebrtcMessage] Host (player ${I.playerId}) is ready`),a(C=>{const v=C.players.map(M=>M.id===I.playerId?{...M,isReady:!0}:M);return{...C,players:v}}));break;case"GAME_START":Ze.current=!0,l.info("[handleWebrtcMessage] Game starting!",I.data),l.info(`[GAME_START] Received data: startingPlayerId=${(tn=I.data)==null?void 0:tn.startingPlayerId}, activePlayerId=${(rn=I.data)==null?void 0:rn.activePlayerId}, currentPhase=${(nn=I.data)==null?void 0:nn.currentPhase}, isGameStarted=${(an=I.data)==null?void 0:an.isGameStarted}`),i.current&&(l.info(`[GAME_START] Current phase before: ${i.current.currentPhase}`),i.current.players.forEach(C=>{l.info(`[GAME_START] Before: Player ${C.id} - deck: ${C.deck.length}, hand: ${C.hand.length}`)})),I.data&&a(C=>{l.info(`[GAME_START] Processing for localPlayerId=${E.current}`),C.players.forEach(B=>{l.info(`[GAME_START] Player ${B.id} before: deck=${B.deck.length}, hand=${B.hand.length}`)});const v=I.data.startingPlayerId??I.data.activePlayerId,M={...C,isGameStarted:I.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:v,activePlayerId:I.data.activePlayerId,currentPhase:I.data.currentPhase??C.currentPhase},W=M.players.find(B=>B.id===E.current);if(W&&W.hand.length===0&&W.deck.length>0){const F=[...W.hand],z=[...W.deck];for(let L=0;L<6&&L<z.length;L++){const K=z[0];z.splice(0,1),F.push(K)}M.players=M.players.map(L=>L.id===E.current?{...L,hand:F,deck:z}:L),l.info(`[GAME_START] Drew ${F.length} cards for local player ${E.current}, deck now has ${z.length} cards`)}return M.players.forEach(B=>{l.info(`[GAME_START] Player ${B.id} after: deck=${B.deck.length}, hand=${B.hand.length}`)}),l.info(`[GAME_START] Final state: currentPhase=${M.currentPhase}, activePlayerId=${M.activePlayerId}, startingPlayerId=${M.startingPlayerId}`),M});break;case"ACTIVE_PLAYER_CHANGED":l.info("[handleWebrtcMessage] Active player changed!",I.data),I.data&&a(C=>{const v={...C,activePlayerId:I.data.activePlayerId};if(I.data.currentPhase!==void 0&&(v.currentPhase=I.data.currentPhase),I.data.turnNumber!==void 0&&(v.turnNumber=I.data.turnNumber),v.currentPhase===0&&v.activePlayerId===E.current){const M=v.players.find(W=>W.id===E.current);if(M&&M.deck.length>0){const W=M.deck[0],B=[...M.deck.slice(1)],F=[...M.hand,W];v.players=v.players.map(z=>z.id===E.current?{...z,deck:B,hand:F}:z)}v.currentPhase=1,lr(v,v.activePlayerId)}return v.activePlayerId&&v.activePlayerId!==C.activePlayerId&&lr(v,v.activePlayerId),v});break;case"SET_PHASE":l.info("[handleWebrtcMessage] Phase change received",I.data),I.data&&I.data.phaseIndex!==void 0&&a(C=>{const v=Math.max(1,Math.min(I.data.phaseIndex,4));if(C.currentPhase===v)return C;const W=C.board.map(z=>z.map(L=>{if(!L.card)return L;const K=L.card;if(K.statuses){const j=K.statuses.filter(se=>se.type!=="readyDeploy");if(j.length!==K.statuses.length)return{...L,card:{...K,statuses:j}}}return L})),B={...C,currentPhase:v,board:W};return v===4&&(B.isScoringStep=!0),B});break;case"SYNC_DECK_SELECTIONS":l.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",I.data),I.data&&a(C=>I.data.playerId!==void 0&&I.data.selectedDeck!==void 0?I.data.playerId===E.current?(l.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${I.data.playerId}`),C):{...C,players:C.players.map(v=>v.id===I.data.playerId?{...v,selectedDeck:I.data.selectedDeck}:v)}:I.data.deckSelections&&Array.isArray(I.data.deckSelections)?{...C,players:C.players.map(v=>{if(v.id===E.current)return v;const M=I.data.deckSelections.find(W=>W.id===v.id);return M?{...v,selectedDeck:M.selectedDeck}:v})}:C);break;case"CHANGE_PLAYER_DECK":if(l.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",I.data),!I.data||I.data.playerId===void 0)break;{const C=I.data.playerId,v=I.data.deckType,M=I.data.deck;a(W=>{const B=W.players.find(L=>L.id===C);if(!B)return W;const F=V.current;let z;if(M&&M.length>0)if(z=M.map(L=>{if(L.baseId){const K=Ke(L.baseId);return K?{...K,id:L.id,baseId:L.baseId,deck:v,ownerId:C,ownerName:B.name,power:L.power,powerModifier:L.powerModifier||0,isFaceDown:L.isFaceDown||!1,statuses:L.statuses||[]}:(l.warn(`[CHANGE_PLAYER_DECK] Card definition not found for baseId: ${L.baseId}, id: ${L.id}`),{id:L.id,baseId:L.baseId,name:"Unknown",deck:v,ownerId:C,ownerName:B.name,power:L.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""})}return l.warn(`[CHANGE_PLAYER_DECK] Card without baseId: ${L.id}`),{id:L.id,baseId:L.id,name:"Unknown",deck:v,ownerId:C,ownerName:B.name,power:L.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}),v==="Optimates"||v==="Command"){const L={};z.forEach(K=>{const j=K.baseId||K.id;L[j]=(L[j]||0)+1}),l.info(`[CHANGE_PLAYER_DECK] Reconstructed ${v} deck for player ${C}:`,{totalCards:z.length,cardCounts:L})}else l.info(`[CHANGE_PLAYER_DECK] Reconstructed deck for player ${C} from host data: ${z.length} cards`);else if(!F)z=nt(v,C,B.name),l.warn(`[CHANGE_PLAYER_DECK] No deck data from host, creating locally for player ${C} from ${v}`);else return W;return{...W,players:W.players.map(L=>L.id===C?{...L,selectedDeck:v,deck:z,hand:[],discard:[],announcedCard:null,boardHistory:[]}:L)}})}break;case"GAME_RESET":a(C=>{const v=I.data.activeGridSize||8,M=[];for(let F=0;F<v;F++){const z=[];for(let L=0;L<v;L++)z.push({card:null});M.push(z)}const W=(I.data.players||[]).map(F=>{if(F.isDummy&&F.hand&&F.deck&&F.discard)return{...F,boardHistory:[]};{const z=F.selectedDeck||"SynchroTech";return{...F,hand:[],deck:nt(z,F.id,F.name),discard:[],boardHistory:[]}}}),B={...C,players:W,gameMode:I.data.gameMode,isPrivate:I.data.isPrivate,activeGridSize:I.data.activeGridSize,dummyPlayerCount:I.data.dummyPlayerCount,autoAbilitiesEnabled:I.data.autoAbilitiesEnabled,isGameStarted:I.data.isGameStarted,currentPhase:I.data.currentPhase,currentRound:I.data.currentRound,turnNumber:I.data.turnNumber,activePlayerId:I.data.activePlayerId,startingPlayerId:I.data.startingPlayerId,roundWinners:I.data.roundWinners||{},gameWinner:I.data.gameWinner,isRoundEndModalOpen:I.data.isRoundEndModalOpen,isReadyCheckActive:I.data.isReadyCheckActive,board:M,targetingMode:null,floatingTexts:[]};return i.current=B,B});break;case"ABILITY_MODE_SET":(on=I.data)!=null&&on.abilityMode&&(a(C=>({...C,abilityMode:I.data.abilityMode})),l.info("[AbilityMode] Received ability mode from host",{playerId:I.data.abilityMode.playerId,mode:I.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":l.info("[Ability] Target selected",I.data);break;case"ABILITY_COMPLETED":a(C=>({...C,abilityMode:void 0})),l.info("[Ability] Ability completed",I.data);break;case"ABILITY_CANCELLED":a(C=>({...C,abilityMode:void 0}));break;case"CHANGE_PLAYER_COLOR":if(l.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",I.data),!I.data||I.data.playerId===void 0)break;{const C=I.data.playerId,v=I.data.color;if(C===E.current)break;a(M=>({...M,players:M.players.map(W=>W.id===C?{...W,color:v}:W)}))}break;case"UPDATE_PLAYER_SCORE":if(l.info("[UPDATE_PLAYER_SCORE] Received score update broadcast",I.data),!I.data||I.data.playerId===void 0)break;{const C=I.data.playerId,v=I.data.delta;if(C===E.current)break;a(M=>({...M,players:M.players.map(W=>W.id===C?{...W,score:Math.max(0,W.score+v)}:W)}))}break;case"TRIGGER_HIGHLIGHT":if((sn=I.data)!=null&&sn.highlightData){const C=I.data.highlightData;A(C),V.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(I.data){const C=(dn=Y.current)==null?void 0:dn.getPeerId();I.senderId!==C&&A(I.data)}break;case"TRIGGER_FLOATING_TEXT":if((cn=I.data)!=null&&cn.textData){const C=I.data.textData;a(v=>({...v,floatingTexts:[...v.floatingTexts,C].filter(M=>Date.now()-M.timestamp<ae.FLOATING_TEXT_DURATION)})),V.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((ln=I.data)!=null&&ln.batch){const C=I.data.batch;a(v=>({...v,floatingTexts:[...v.floatingTexts,...C].filter(M=>Date.now()-M.timestamp<ae.FLOATING_TEXT_DURATION)})),V.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:I.senderId,data:{batch:C},timestamp:Date.now()},I.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const C=(un=Y.current)==null?void 0:un.getPeerId();(fn=I.data)!=null&&fn.batch&&I.senderId!==C?a(v=>({...v,floatingTexts:[...v.floatingTexts,...I.data.batch].filter(M=>Date.now()-M.timestamp<ae.FLOATING_TEXT_DURATION)})):(pn=I.data)!=null&&pn.textData&&I.senderId!==C&&a(v=>({...v,floatingTexts:[...v.floatingTexts,I.data.textData].filter(M=>Date.now()-M.timestamp<ae.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((yn=I.data)!=null&&yn.coords){const C=I.data.coords,v=I.data.timestamp;_({coords:C,timestamp:v}),V.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:I.senderId,data:{coords:C,timestamp:v},timestamp:Date.now()},I.senderId)}break;case"NO_TARGET_TRIGGERED":if((hn=I.data)!=null&&hn.coords){const C=(mn=Y.current)==null?void 0:mn.getPeerId();I.senderId!==C&&_({coords:I.data.coords,timestamp:I.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(I.data){const C=I.data;g(v=>[...v,C]),setTimeout(()=>{g(v=>v.filter(M=>M.timestamp!==C.timestamp))},1e3),V.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(I.data){const C=I.data;R(v=>[...v,C]),setTimeout(()=>{R(v=>v.filter(M=>M.timestamp!==C.timestamp))},1e3),V.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"TRIGGER_CLICK_WAVE":if(I.data){const C=I.data;O(v=>[...v,C]),setTimeout(()=>{O(v=>v.filter(M=>M.timestamp!==C.timestamp))},600),V.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"CLICK_WAVE_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"CLICK_WAVE_TRIGGERED":I.data&&I.senderId!==((In=Y.current)==null?void 0:In.getPeerId())&&(O(C=>[...C,I.data]),setTimeout(()=>{O(C=>C.filter(v=>v.timestamp!==I.data.timestamp))},600));break;case"DECK_SELECTION_TRIGGERED":I.data&&I.senderId!==((En=Y.current)==null?void 0:En.getPeerId())&&(g(C=>[...C,I.data]),setTimeout(()=>{g(C=>C.filter(v=>v.timestamp!==I.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":I.data&&I.senderId!==((Tn=Y.current)==null?void 0:Tn.getPeerId())&&(R(C=>[...C,I.data]),setTimeout(()=>{R(C=>C.filter(v=>v.timestamp!==I.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((gn=I.data)!=null&&gn.targetingMode){const C=I.data.targetingMode,v=C.mode||((wn=C.action)==null?void 0:wn.mode);l.info("[TargetingMode] Received SET_TARGETING_MODE via WebRTC",{playerId:C.playerId,mode:v,boardTargetsCount:((_n=C.boardTargets)==null?void 0:_n.length)||0,handTargetsCount:((bn=C.handTargets)==null?void 0:bn.length)||0,isDeckSelectable:C.isDeckSelectable||!1,timestamp:C.timestamp,isHost:V.current}),a(M=>({...M,targetingMode:C})),i.current.targetingMode=C,V.current&&Y.current&&Y.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((Sn=(An=Y.current).getPeerId)==null?void 0:Sn.call(An))??void 0,data:{targetingMode:C},timestamp:Date.now()})}break;case"CLEAR_TARGETING_MODE":l.info("[TargetingMode] Received CLEAR_TARGETING_MODE via WebRTC",{isHost:V.current}),a(C=>({...C,targetingMode:null})),i.current.targetingMode=null,V.current&&Y.current&&Y.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((Dn=(Cn=Y.current).getPeerId)==null?void 0:Dn.call(Cn))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()});break;case"RECONNECT_ACCEPT":if((Rn=I.data)!=null&&Rn.gameState){const C=I.data.gameState;a(C),D("Connected"),l.info(`[Reconnection] State restored with ${((Pn=C.players)==null?void 0:Pn.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(v){l.warn("[Reconnection] Failed to clear stored data:",v)}}break;case"RECONNECT_REJECT":{const C=((kn=I.data)==null?void 0:kn.reason)||"unknown";l.warn(`[Reconnection] Reconnection rejected: ${C}`),D("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((On=I.data)==null?void 0:On.playerId)!==void 0&&(l.info(`[Reconnection] Player ${I.data.playerId} disconnected, reconnection window open`),a(C=>({...C,players:C.players.map(v=>v.id===I.data.playerId?{...v,isDisconnected:!0}:v)})));break;case"PLAYER_RECONNECTED":((vn=I.data)==null?void 0:vn.playerId)!==void 0&&(l.info(`[Reconnection] Player ${I.data.playerId} reconnected`),a(C=>({...C,players:C.players.map(v=>v.id===I.data.playerId?{...v,isDisconnected:!1}:v)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((Nn=I.data)==null?void 0:Nn.playerId)!==void 0&&(l.info(`[Reconnection] Player ${I.data.playerId} converted to dummy`),a(C=>({...C,players:C.players.map(v=>v.id===I.data.playerId?{...v,isDummy:!0,isDisconnected:!0}:v)})));break;case"REQUEST_DECK_VIEW":if(V.current&&((Mn=I.data)==null?void 0:Mn.targetPlayerId)!==void 0){const C=I.data.targetPlayerId;I.playerId;const v=n.players.find(M=>M.id===C);if(v&&Y.current){let M=[];if(C===E.current||v.isDummy)l.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${v.deck.length} cards`),M=v.deck;else{const z=Oe.current.get(C);z&&z.length>0?(l.info(`[REQUEST_DECK_VIEW] Using stored full deck data for guest ${C}, ${z.length} cards`),M=z):(l.info(`[REQUEST_DECK_VIEW] No stored full deck for guest ${C}, using gameState deck, ${v.deck.length} cards`),M=v.deck)}const W=qn(M),B={targetPlayerId:C,deckCards:W,deckSize:M.length,_format:"baseIdArray"},F={type:"DECK_VIEW_DATA",senderId:Y.current.getPeerId(),data:B,timestamp:Date.now()};Y.current.sendToGuest(I.senderId||"",F),l.info(`[REQUEST_DECK_VIEW] Sent ${B.deckSize} cards (optimized) for player ${C}`)}}break;case"DECK_VIEW_DATA":if(((Ln=I.data)==null?void 0:Ln.targetPlayerId)!==void 0&&((Gn=I.data)!=null&&Gn.deckCards)){const C=I.data.targetPlayerId,v=I.data.deckCards,M=I.data._format==="baseIdArray";let W;if(M&&typeof v=="string")try{W=Vn(v,C)}catch(B){l.error("[DECK_VIEW_DATA] Failed to deserialize optimized deck:",B);break}else{const B=v;l.info(`[DECK_VIEW_DATA] Received legacy format (${B.length} cards) for player ${C}`);const F=B[0];if((F==null?void 0:F.name)&&(F==null?void 0:F.imageUrl))l.info(`[DECK_VIEW_DATA] Received full card data, using directly. First card: ${F.name}`),W=B.map(L=>({id:L.id,baseId:L.baseId||L.id,name:L.name,imageUrl:L.imageUrl,fallbackImage:L.fallbackImage||"",power:L.power,powerModifier:L.powerModifier||0,isFaceDown:L.isFaceDown??!1,statuses:L.statuses||[],deck:L.deck||Ce.SynchroTech,color:L.color||"Red",ability:L.ability||"",bonusPower:L.bonusPower||0,isPlaceholder:L.isPlaceholder||!1,types:L.types||[],faction:L.faction||"",ownerId:L.ownerId||C}));else{const L=K=>{if(K.baseId){const se=Ke(K.baseId);if(se)return{...se,id:K.id,baseId:K.baseId,deck:K.deck||Ce.SynchroTech,ownerId:C,power:K.power,powerModifier:K.powerModifier,isFaceDown:K.isFaceDown,statuses:K.statuses||[]};l.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${K.baseId}`)}else l.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${K.id}`);return{id:K.id,baseId:K.baseId||K.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:K.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:Ce.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}};W=B.map(L)}}a(B=>({...B,players:B.players.map(F=>F.id===C?{...F,deck:W}:F)}))}break;case"DECK_DATA_UPDATE":if(V.current&&I.playerId!==void 0&&((xn=I.data)!=null&&xn.deck)){const C=I.playerId,v=I.data.deck,M=I.data.deckSize,W=I.data._format==="baseIdArray";let B;if(W&&typeof v=="string")try{B=Vn(v,C)}catch(F){l.error("[DECK_DATA_UPDATE] Failed to deserialize optimized deck:",F);break}else{const F=v;l.info(`[DECK_DATA_UPDATE] Received legacy format (${F.length} cards) for guest ${C}, first card: ${(Un=F[0])==null?void 0:Un.name}`),B=F.map(z=>({...z,ownerId:z.ownerId??C}))}Oe.current.set(C,B),a(F=>{const z={...F,players:F.players.map(L=>L.id===C?{...L,deck:B,deckSize:M}:L)};return Y.current&&I.senderId&&setTimeout(()=>{Y.current.broadcastGameState(z,I.senderId)},0),z})}break;case"REQUEST_DECK_DATA":if(!V.current&&Y.current){const C=n.players.find(v=>v.id===E.current);if(C&&C.deck.length>0){l.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${C.deck.length} cards (optimized format)`);const v=qn(C.deck);Y.current.sendAction("DECK_DATA_UPDATE",{playerId:E.current,deck:v,deckSize:C.deck.length,_format:"baseIdArray"})}}break;case"HOST_DECK_DATA":if(!V.current&&(($n=I.data)!=null&&$n.deck)){const C=I.data.deck,v=I.data.deckSize,M=1;l.info(`[HOST_DECK_DATA] Received host deck data: ${C.length} cards`),a(W=>({...W,players:W.players.map(B=>B.id===M?{...B,deck:C,deckSize:v}:B)}))}break;default:l.warn(`[handleWebrtcMessage] Unknown message type: ${I.type}`,I);break}},[oe,nt,Rr,n,c]),La=H.useCallback(I=>{if(!Y.current||Se)return;ke(!0),D("Connecting");const ne=3e4,ee=1e3;let te=0;const de=ne/ee;try{const ie={hostPeerId:I,playerId:c,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ie))}catch(ie){l.error("[Reconnection] Failed to store data:",ie)}const re=async()=>{te++;const ie=Math.max(0,ne-te*ee);if(xe({attempt:te,maxAttempts:de,timeRemaining:ie}),ie<=0){l.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),ke(!1),xe(null),st();return}let X=I;if(n!=null&&n.gameId){const Ee=er(n.gameId);if(Ee&&Ee.peerId!==I){X=Ee.peerId;try{const _e={hostPeerId:X,playerId:c,gameState:n,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(_e))}catch(_e){l.error("[Reconnection] Failed to update reconnection data:",_e)}}}try{const Ee=c||E.current;Ee!==null?(l.info(`[Reconnection] Reconnecting as existing player ${Ee} to host ${X}`),await Y.current.initializeAsReconnectingGuest(X,Ee)):(l.info("[Reconnection] No playerId, connecting as new player"),await Y.current.initializeAsGuest(X)),l.info("[Reconnection] Successfully reconnected!"),ke(!1),xe(null)}catch(Ee){l.warn("[Reconnection] Reconnection attempt failed:",Ee),setTimeout(re,ee)}};re()},[Se,n,c]),Be=H.useCallback(I=>{a(ne=>{if(!ne)return l.error("[updateState] prevState is undefined, skipping update"),ne;const ee=typeof I=="function"?I(ne):I;if(!ee)return l.error("[updateState] newState is undefined, skipping update"),ne;const te=!ne.gameId&&ee.gameId;if(!Ze.current&&!te)return ee;if($&&Y.current){if(V.current){if(Y.current.broadcastGameState(ee),l.info(`[updateState] Host broadcast state: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`),ee.gameId&&E.current!==null)try{St({gameState:ee,localPlayerId:E.current,isHost:!0}),l.debug("[updateState] Saved game state for host auto-restore")}catch(de){l.warn("[updateState] Failed to save game state:",de)}}else Y.current&&(Y.current.sendStateToHost(ee,E.current),l.info(`[updateState] Guest sent state to host: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`));return ee}if(Te.current&&Te.current.readyState===WebSocket.OPEN){const de={type:"UPDATE_STATE",gameState:ee};pt.current&&(de.playerToken=pt.current),Te.current.send(JSON.stringify(de))}return ee})},[$,oe,Rr]),Ga=H.useCallback(()=>{const{initialState:I}=ht.createGame();Be(I)},[ht,Be]),xa=H.useCallback(()=>{ht.exitGame(Je,V,Bn,st)},[ht,Je,V,Bn,st]),Ua=zs({ws:Te,webrtcManager:Y,gameStateRef:i,webrtcIsHostRef:V,setGameState:a,updateState:Be}),$a=Ks({ws:Te,webrtcManager:Y,gameStateRef:i,localPlayerIdRef:E,webrtcIsHostRef:V,setGameState:a}),Ha=qs({updateState:Be,sendWebrtcAction:at,webrtcIsHostRef:V,webrtcManagerRef:Y}),Fa=Vs({ws:Te,webrtcManager:Y,gameStateRef:i,localPlayerIdRef:E,webrtcIsHostRef:V,updateState:Be}),Wa=js({localPlayerIdRef:E,updateState:Be}),{addBoardCardStatus:Ba,removeBoardCardStatus:Ya,removeBoardCardStatusByOwner:za,modifyBoardCardPower:Ka,addAnnouncedCardStatus:qa,removeAnnouncedCardStatus:Va,modifyAnnouncedCardPower:ja,addHandCardStatus:Ja,removeHandCardStatus:Xa,revealHandCard:Za,revealBoardCard:Qa,requestCardReveal:eo,respondToRevealRequest:to,removeRevealedStatus:ro}=Wa,no=Js({webrtcIsHostRef:V,sendWebrtcAction:at,webrtcManagerRef:Y,localPlayerIdRef:E,getCardDefinition:Ke,commandCardIds:Zo,createDeck:nt,updateState:Be}),{changePlayerDeck:ao,loadCustomDeck:oo,resurrectDiscardedCard:so,reorderTopDeck:io,reorderCards:co,recoverDiscardedCard:lo}=no,uo=Xs({ws:Te,webrtcManagerRef:Y,webrtcIsHostRef:V,gameStateRef:i,scoreDeltaAccumulator:rt,setGameState:a,updateState:Be,abilityMode:e,setAbilityMode:r,createDeck:nt,webrtcEnabled:$}),{toggleActivePlayer:fo,toggleAutoDraw:po,setPhase:yo,nextPhase:ho,prevPhase:mo,closeRoundEndModal:Io,closeRoundEndModalOnly:Eo,resetGame:To}=uo;H.useEffect(()=>{je.current=!1;const I=sessionStorage.getItem("invite_game_id"),ne=sessionStorage.getItem("invite_host_id");if(I&&!ne)return Sr(),()=>{je.current=!0,mt.current&&clearTimeout(mt.current),Te.current&&(Te.current.onclose=null,Te.current.close())};if(I&&ne)return()=>{je.current=!0,mt.current&&clearTimeout(mt.current),Te.current&&(Te.current.onclose=null,Te.current.close())};const ee=performance.getEntriesByType("navigation"),te=ee.length>0?ee[0]:null,de=(te==null?void 0:te.type)??0,re=Ws();return re&&(l.info(`Restoring saved game state (nav type: ${de}):`,re.gameState.gameId),a(re.gameState),o(re.localPlayerId),i.current=re.gameState,E.current=re.localPlayerId,pt.current=re.playerToken),Sr(),()=>{je.current=!0,mt.current&&clearTimeout(mt.current),Te.current&&(Te.current.onclose=null,Te.current.close())}},[]),H.useEffect(()=>{if(qe&&i.current&&i.current.gameId){const I=Lt(i.current);I!==i.current&&(a(I),i.current=I)}},[]),H.useEffect(()=>{if(N)return;const I=setInterval(()=>{if(qe&&i.current&&i.current.gameId){const ne=Lt(i.current);a({...ne}),i.current=ne,G(!0),clearInterval(I)}},100);return()=>clearInterval(I)},[N]);const{startReadyCheck:go,cancelReadyCheck:wo,playerReady:_o}=$a,{updatePlayerName:bo,changePlayerColor:Ao}=Ha,{drawCard:So,drawCardsBatch:Co,shufflePlayerDeck:Do,flipBoardCard:Ro,flipBoardCardFaceDown:Po}=Fa,{assignTeams:ko,setGameMode:Oo,setGamePrivacy:vo,setActiveGridSize:No,setDummyPlayerCount:Mo}=Ua,Lo=H.useCallback(()=>{var I;if(((I=Te.current)==null?void 0:I.readyState)===WebSocket.OPEN&&i.current.gameId&&E.current===1){Te.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:qe}));const ne=i.current,ee=fe(ne);ee.players.forEach(te=>{if(["hand","deck","discard"].forEach(re=>{te[re]&&(te[re]=te[re].map(ie=>{const X=Jt(ie.name);return X?{...ie,...X}:ie}))}),te.announcedCard){const re=Jt(te.announcedCard.name);re&&(te.announcedCard={...te.announcedCard,...re})}}),ee.board.forEach(te=>{te.forEach(de=>{if(de.card){const re=Jt(de.card.name);re&&(de.card={...de.card,...re})}})}),Te.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:ee})),a(ee)}},[]),Vt=H.useCallback((I,ne)=>{var de;const ee=i.current;if(!ee.isGameStarted){l.warn("[ScoreUpdate] Blocked: game not started");return}if(ee.isRoundEndModalOpen){l.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(ne===0)return;const te=We();if(te?Be(re=>({...re,players:re.players.map(ie=>ie.id===I?{...ie,score:Math.max(0,(ie.score||0)+ne)}:ie)})):a(re=>({...re,players:re.players.map(ie=>ie.id===I?{...ie,score:Math.max(0,(ie.score||0)+ne)}:ie)})),!te){if(((de=Te.current)==null?void 0:de.readyState)!==WebSocket.OPEN){l.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const re=rt.get(I);if(re){clearTimeout(re.timerId);const ie=re.delta+ne,X=setTimeout(()=>{var _e;const Ee=rt.get(I);Ee&&((_e=Te.current)==null?void 0:_e.readyState)===WebSocket.OPEN&&(l.info(`[ScoreUpdate] Sending accumulated delta: player=${I}, delta=${Ee.delta}`),Te.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:i.current.gameId,playerId:I,delta:Ee.delta}))),rt.delete(I)},500);rt.set(I,{delta:ie,timerId:X})}else{const ie=setTimeout(()=>{var Ee;const X=rt.get(I);X&&((Ee=Te.current)==null?void 0:Ee.readyState)===WebSocket.OPEN&&(l.info(`[ScoreUpdate] Sending delta: player=${I}, delta=${X.delta}`),Te.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:i.current.gameId,playerId:I,delta:X.delta}))),rt.delete(I)},500);rt.set(I,{delta:ne,timerId:ie})}}},[a,Be]),Go=ti({ws:Te,webrtcManager:Y,gameStateRef:i,webrtcIsHostRef:V,setGameState:a}),{setTargetingMode:xo,clearTargetingMode:Pr}=Go,Uo=Zs({ws:Te,gameStateRef:i,updateState:Be,updatePlayerScore:Vt,triggerFloatingText:Dr,clearTargetingMode:Pr}),{scoreLine:$o,scoreDiagonal:Ho}=Uo,tt=Qs({updateState:Be,rawJsonData:qe}),Fo=ei({updateState:Be,localPlayerIdRef:E,updatePlayerScore:Vt}),{moveItem:kr,destroyCard:Wo}=Fo;return{gameState:n,localPlayerId:c,setLocalPlayerId:o,draggedItem:P,setDraggedItem:T,connectionStatus:f,gamesList:u,latestHighlight:p,latestFloatingTexts:S,latestNoTarget:w,latestDeckSelections:m,latestHandCardSelections:k,joinAsInvite:ba,startReadyCheck:go,cancelReadyCheck:wo,playerReady:_o,assignTeams:ko,setGameMode:Oo,setGamePrivacy:vo,setActiveGridSize:No,setDummyPlayerCount:Mo,updatePlayerName:bo,changePlayerColor:Ao,updatePlayerScore:Vt,changePlayerDeck:ao,loadCustomDeck:oo,drawCard:So,drawCardsBatch:Co,shufflePlayerDeck:Do,moveItem:kr,handleDrop:kr,destroyCard:Wo,addBoardCardStatus:Ba,removeBoardCardStatus:Ya,removeBoardCardStatusByOwner:za,modifyBoardCardPower:Ka,addAnnouncedCardStatus:qa,removeAnnouncedCardStatus:Va,modifyAnnouncedCardPower:ja,addHandCardStatus:Ja,removeHandCardStatus:Xa,flipBoardCard:Ro,flipBoardCardFaceDown:Po,revealHandCard:Za,revealBoardCard:Qa,requestCardReveal:eo,respondToRevealRequest:to,syncGame:Lo,removeRevealedStatus:ro,toggleActivePlayer:fo,toggleAutoDraw:po,triggerHighlight:Ca,triggerFloatingText:Dr,triggerNoTarget:Da,triggerDeckSelection:Ra,triggerHandCardSelection:Pa,triggerClickWave:Oa,clickWaves:b,syncValidTargets:ka,setTargetingMode:xo,clearTargetingMode:Pr,nextPhase:ho,prevPhase:mo,setPhase:yo,markAbilityUsed:tt.markAbilityUsed,applyGlobalEffect:tt.applyGlobalEffect,swapCards:tt.swapCards,transferStatus:tt.transferStatus,transferAllCounters:tt.transferAllCounters,spawnToken:tt.spawnToken,resetDeployStatus:tt.resetDeployStatus,removeStatusByType:tt.removeStatusByType,recoverDiscardedCard:lo,resurrectDiscardedCard:so,scoreLine:$o,closeRoundEndModal:Io,closeRoundEndModalOnly:Eo,resetGame:To,scoreDiagonal:Ho,reorderTopDeck:io,reorderCards:co,updateState:Be,requestDeckView:Ar,sendFullDeckToHost:qt,shareHostDeckWithGuests:ot,createGame:Ga,joinGame:Cr,joinGameViaModal:Cr,exitGame:xa,requestGamesList:Aa,forceReconnect:_a,webrtcHostId:Q,webrtcIsHost:oe,initializeWebrtcHost:yt,connectAsGuest:bt,sendWebrtcAction:at,isReconnecting:Se,reconnectProgress:De}};function Qn(t,e,r){const{gameState:n,localPlayerId:a,abilityMode:s,cursorStack:d,handleActionExecution:c,markAbilityUsed:o,addBoardCardStatus:i}=r;if(s||d||!n.isGameStarted||a===null)return null;const E=n.players.find(f=>f.id===t.ownerId),P=a===t.ownerId||(E==null?void 0:E.isDummy);if(n.activePlayerId!==t.ownerId||!P||!sa(t,n)||!mr(t,n.currentPhase,n.activePlayerId,n))return null;const T=as(t,n,t.ownerId,e);if(T){if(T.type==="ENTER_MODE"&&T.mode==="SHIELD_SELF_THEN_RIOT_PUSH"){i(e,"Shield",t.ownerId),T.readyStatusToRemove&&o(e,!!T.isDeployAbility,!1,T.readyStatusToRemove);const u={...{type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:t,sourceCoords:e,isDeployAbility:T.isDeployAbility,readyStatusToRemove:T.readyStatusToRemove,payload:{}},chainedAction:{type:"ABILITY_COMPLETE"}};return c(u,e),u}T.readyStatusToRemove&&o(e,!!T.isDeployAbility,!1,T.readyStatusToRemove);const f={...T,chainedAction:T.chainedAction?{...T.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};return c(f,e),f}return null}function cd(t){const e=ut[t],r=(e==null?void 0:e.allowedTargets)||[];return{allowedTargets:r,allowHand:r.includes("hand"),allowBoard:r.includes("board"),allowBoardFaceDown:r.includes("board-facedown"),allowDeck:r.includes("deck"),allowDiscard:r.includes("discard")}}function br(t,e,r,n){const a={type:t,count:r?r.count+1:1,isDragging:!0,originalOwnerId:e,sourceCoords:r==null?void 0:r.sourceCoords},s={};return t==="Revealed"&&(s.excludeOwnerId=e,s.onlyFaceDown=!0),{...a,...s,...n,...r&&{chainedAction:r.chainedAction,isDeployAbility:r.isDeployAbility,readyStatusToRemove:r.readyStatusToRemove}}}function Qe(t,e){var n;const r=(n=t.sourceCard)==null?void 0:n.ownerId;return typeof r=="number"?r:typeof e=="number"?e:0}function oi(t,e,r){var E;const{gameState:n,localPlayerId:a,commandContext:s,triggerNoTarget:d,onAbilityComplete:c,handleActionExecution:o}=r;if(t.type==="ABILITY_COMPLETE"){c==null||c();return}if(t.type==="REVEREND_SETUP_SCORE"){si(t,e,r);return}if(t.type==="GLOBAL_AUTO_APPLY"){ii(t,e,r);return}if(!Bt(t,n,((E=t.sourceCard)==null?void 0:E.ownerId)||a,s)){d(e),t.chainedAction&&!t.skipChainedActionOnNoTargets&&setTimeout(()=>{o(t.chainedAction,e)},500);return}if(t.type==="CREATE_STACK"){di(t,e,r);return}if(t.type==="OPEN_MODAL"){ci(t,e,r);return}if(t.type==="ENTER_MODE"){li(t,e,r);return}l.warn("[handleActionExecution] Unknown action type:",t.type)}function si(t,e,r){var i,E;const{gameState:n,updatePlayerScore:a,triggerFloatingText:s,markAbilityUsed:d}=r,c=((i=t.sourceCard)==null?void 0:i.ownerId)??0;let o=0;for(let P=0;P<n.board.length;P++)for(let T=0;T<n.board[P].length;T++){const f=(E=n.board[P][T])==null?void 0:E.card;if(f!=null&&f.statuses){const D=f.statuses.filter(u=>u.type==="Exploit"&&u.addedByPlayerId===c);o+=D.length}}o>0&&a(c,o),s([{row:e.row,col:e.col,text:`+${o}`,playerId:c}]),d(e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function ii(t,e,r){var D,u,y,p,A,S;const{gameState:n,localPlayerId:a,commandContext:s,markAbilityUsed:d,triggerNoTarget:c,triggerFloatingText:o,updatePlayerScore:i,applyGlobalEffect:E,addBoardCardStatus:P,removeStatusByType:T,handleActionExecution:f}=r;if(((D=t.payload)==null?void 0:D.customAction)==="FINN_SCORING"){const h=(u=t.sourceCard)==null?void 0:u.ownerId;if(h===void 0){l.warn("[FINN_SCORING] Source card missing ownerId"),d(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}let w=0;if(n.players.forEach(_=>{_.id!==h&&_.hand.forEach(m=>{var g;(g=m.statuses)!=null&&g.some(k=>k.type==="Revealed"&&k.addedByPlayerId===h)&&w++})}),n.board.forEach(_=>{_.forEach(m=>{var k;const g=m.card;if(g&&g.ownerId!==h){const R=((k=g.statuses)==null?void 0:k.filter(b=>b.type==="Revealed"&&b.addedByPlayerId===h).length)||0;w+=R}})}),w>0){const _=t.sourceCoords||e;o({row:_.row,col:_.col,text:`+${w}`,playerId:h}),i(h,w)}d(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}if(((y=t.payload)==null?void 0:y.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){t.sourceCoords&&t.sourceCoords.row>=0?T(t.sourceCoords,"Aim"):s.lastMovedCardCoords&&T(s.lastMovedCardCoords,"Aim");return}if((p=t.payload)!=null&&p.tokenType&&t.payload.filter){const{tokenType:h,filter:w}=t.payload,_=[],m=n.board.length;for(let g=0;g<m;g++)for(let k=0;k<m;k++){const R=n.board[g][k].card;R&&w(R,g,k)&&_.push({row:g,col:k})}if(_.length===0){c(t.sourceCoords||e),t.chainedAction&&setTimeout(()=>f(t.chainedAction,e),500),d(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}_.forEach(g=>{var k;P(g,h,((k=t.sourceCard)==null?void 0:k.ownerId)||0)}),d(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove),t.chainedAction&&setTimeout(()=>f(t.chainedAction,e),ae.MODE_CLEAR_DELAY);return}if((A=t.payload)!=null&&A.contextReward){ea(t,e,r);return}if(t.payload&&!t.payload.cleanupCommand){const{tokenType:h,filter:w}=t.payload,_=[],m=n.board.length;if(t.payload.contextReward&&t.sourceCard){ea(t,e,r);return}if(w)for(let g=0;g<m;g++)for(let k=0;k<m;k++){const R=n.board[g][k].card;R&&w(R)&&_.push({row:g,col:k})}else t.sourceCoords&&t.sourceCoords.row>=0?_.push(t.sourceCoords):e&&e.row>=0?_.push(e):s.lastMovedCardCoords&&_.push(s.lastMovedCardCoords);if(_.length>0){if(h){const g=t.payload.count||1,k=t.payload.ownerId!==void 0?t.payload.ownerId:((S=t.sourceCard)==null?void 0:S.ownerId)??a??0;for(let R=0;R<g;R++)E(e,_,h,k,!!t.isDeployAbility)}}else c(e),d(e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}}function di(t,e,r){var i,E;const{gameState:n,setAbilityMode:a,setCursorStack:s,triggerNoTarget:d,localPlayerId:c}=r;let o=t.count||0;if(t.dynamicCount){const{factor:P,ownerId:T}=t.dynamicCount;let f=0;n.board.forEach(D=>{D.forEach(u=>{var y;if((y=u.card)!=null&&y.statuses){const p=u.card.statuses.filter(A=>A.type===P&&A.addedByPlayerId===T);f+=p.length}})}),o=f}if(o>0){a(null);let P=((i=t.sourceCard)==null?void 0:i.ownerId)??c??0;!((E=t.sourceCard)!=null&&E.ownerId)&&c!==null&&(P=c);const T={count:o,sourceCoords:t.sourceCoords||e,sourceCard:t.sourceCard,isDeployAbility:t.isDeployAbility,readyStatusToRemove:t.readyStatusToRemove,targetOwnerId:t.targetOwnerId,excludeOwnerId:t.excludeOwnerId,onlyOpponents:t.onlyOpponents,onlyFaceDown:t.onlyFaceDown,targetType:t.targetType,requiredTargetStatus:t.requiredTargetStatus,requireStatusFromSourceOwner:t.requireStatusFromSourceOwner,mustBeAdjacentToSource:t.mustBeAdjacentToSource,mustBeInLineWithSource:t.mustBeInLineWithSource,maxDistanceFromSource:t.maxDistanceFromSource,maxOrthogonalDistance:t.maxOrthogonalDistance,placeAllAtOnce:t.placeAllAtOnce,replaceStatus:t.replaceStatus,chainedAction:t.chainedAction,recordContext:t.recordContext};s(br(t.tokenType||"Aim",P,null,T))}else d(e)}function ci(t,e,r){var i,E;const{gameState:n,localPlayerId:a,commandContext:s,setViewingDiscard:d,markAbilityUsed:c}=r;if(!Bt(t,n,((i=t.sourceCard)==null?void 0:i.ownerId)||a,s)){c(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}if(t.mode==="RETRIEVE_DEVICE"){const P=n.players.find(T=>{var f;return T.id===((f=t.sourceCard)==null?void 0:f.ownerId)});P&&(d({player:P,pickConfig:{filterType:"Device",action:"recover"}}),e.row>=0&&c(e,!!t.isDeployAbility,!1,t.readyStatusToRemove))}else if(t.mode==="IMMUNIS_RETRIEVE"){const P=n.players.find(T=>{var f;return T.id===((f=t.sourceCard)==null?void 0:f.ownerId)});P&&d({player:P,pickConfig:{filterType:"Optimates",action:"resurrect"}})}else if(t.mode==="SEARCH_DECK"){const P=n.players.find(T=>{var f;return T.id===((f=t.sourceCard)==null?void 0:f.ownerId)});P&&(d({player:P,pickConfig:{filterType:((E=t.payload)==null?void 0:E.filterType)||"Unit",action:"recover",isDeck:!0}}),e.row>=0&&c(e,!!t.isDeployAbility,!1,t.readyStatusToRemove))}c(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function li(t,e,r){var f,D;const{gameState:n,localPlayerId:a,commandContext:s,triggerNoTarget:d,setAbilityMode:c,markAbilityUsed:o,addBoardCardStatus:i,setTargetingMode:E,handleActionExecution:P}=r,T=t.mode;if(T==="SHIELD_SELF_THEN_RIOT_PUSH"){c(t),E(t,Qe(t,a),e,void 0,s);return}if(T==="SHIELD_SELF_THEN_SPAWN"){const u=Qe(t,a);i(e,"Shield",u),c({...t,payload:{...t.payload,shieldApplied:!0}}),E(t,u,e);return}if(T==="PRINCEPS_SHIELD_THEN_AIM"){const u=Qe(t,a);i(e,"Shield",u);const y={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};P(y,e);return}if(T==="GAWAIN_DEPLOY_SHIELD_AIM"){const u=t.sourceCard.ownerId;i(e,"Shield",u);const y={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};P(y,e);return}if(T==="ABR_DEPLOY_SHIELD_AIM"){const u=t.sourceCard.ownerId;i(e,"Shield",u);const y={type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:t.sourceCard,sourceCoords:e,isDeployAbility:t.isDeployAbility};P(y,e);return}if(T==="RIOT_PUSH"){if(t.isDeployAbility){c(t),E(t,Qe(t,a),e);return}if(!Bt(t,n,((f=t.sourceCard)==null?void 0:f.ownerId)||a,s)){d(t.sourceCoords||e),o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}c(t),E(t,Qe(t,a),e);return}if(T==="PATROL_MOVE"){c(t),E(t,Qe(t,a),e);return}if(T==="SELECT_TARGET"){if(t.isDeployAbility){c(t),E(t,Qe(t,a),e,void 0,s);return}if(!Bt(t,n,((D=t.sourceCard)==null?void 0:D.ownerId)||a,s)){d(t.sourceCoords||e),o(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove);return}c(t),E(t,Qe(t,a),e,void 0,s);return}c(t),E(t,Qe(t,a),e)}function ea(t,e,r){var p,A,S,h,w,_,m;const{gameState:n,commandContext:a,updatePlayerScore:s,triggerFloatingText:d,drawCardsBatch:c,removeBoardCardStatus:o,addBoardCardStatus:i,modifyBoardCardPower:E,markAbilityUsed:P}=r,T=(p=t.payload)==null?void 0:p.contextReward,f=a.lastMovedCardCoords||e;if(!f||f.row<0)return;let D=n.board[f.row][f.col].card;const u=((A=t.payload)==null?void 0:A._tempContextId)||a.lastMovedCardId;if((!D||u&&D.id!==u)&&u)for(let g=0;g<n.board.length;g++){for(let k=0;k<n.board[g].length;k++)if(((S=n.board[g][k].card)==null?void 0:S.id)===u){D=n.board[g][k].card;break}if(D)break}if(!D){l.warn("[ContextReward] No card at coords");return}const y=Math.max(0,D.power+(D.powerModifier||0)+(D.bonusPower||0));T==="DRAW_MOVED_POWER"||T==="DRAW_EQUAL_POWER"?c(((h=t.sourceCard)==null?void 0:h.ownerId)||0,y):T==="SCORE_MOVED_POWER"?(d({row:f.row,col:f.col,text:`+${y}`,playerId:((w=t.sourceCard)==null?void 0:w.ownerId)||0}),s(((_=t.sourceCard)==null?void 0:_.ownerId)||0,y)):T==="STUN_MOVED_UNIT"?i(f,"Stun",((m=t.sourceCard)==null?void 0:m.ownerId)||0):T==="REMOVE_AIM"?o(f,"Aim"):T==="WEAKEN"&&E(f,-1),P(t.sourceCoords||e,!!t.isDeployAbility,!1,t.readyStatusToRemove)}function ui(t,e){var _;const{gameState:r,localPlayerId:n,abilityMode:a,setAbilityMode:s,cursorStack:d,commandContext:c,setCommandContext:o,playMode:i,draggedItem:E,interactionLock:P,handleActionExecution:T,handleDrop:f,moveItem:D,markAbilityUsed:u,spawnToken:y,resurrectDiscardedCard:p,updatePlayerScore:A,triggerFloatingText:S,handleLineSelection:h}=e;if(P.current)return!1;const w=r.board.length;if(E)return t.row>=0&&t.row<w&&t.col>=0&&t.col<r.board[t.row].length?(f(E,{location:"board",row:t.row,col:t.col}),!0):!1;if(d&&d.isDragging){if(lt({location:"board",row:t.row,col:t.col},{...d.targetOwnerId!==void 0&&{targetOwnerId:d.targetOwnerId},...d.excludeOwnerId!==void 0&&{excludeOwnerId:d.excludeOwnerId},onlyOpponents:d.onlyOpponents,onlyFaceDown:d.onlyFaceDown,...d.targetType&&{targetType:d.targetType},...d.requiredTargetStatus&&{requiredTargetStatus:d.requiredTargetStatus},...d.requireStatusFromSourceOwner!==void 0&&{requireStatusFromSourceOwner:d.requireStatusFromSourceOwner},...d.mustBeAdjacentToSource&&d.sourceCoords&&{mustBeAdjacentTo:d.sourceCoords},...d.mustBeInLineWithSource&&d.sourceCoords&&{mustBeInLineWith:d.sourceCoords},...d.maxDistanceFromSource!==void 0&&{maxDistance:d.maxDistanceFromSource},...d.range&&{range:d.range}},n??0,r.players)){let g=null;if(d.sourceCoords){const{row:k,col:R}=d.sourceCoords;k>=0&&k<w&&R>=0&&R<r.board[k].length&&(g=r.board[k][R].card)}if(g)return T({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:d.type,count:d.count,targetOwnerId:d.targetOwnerId,onlyOpponents:d.onlyOpponents,onlyFaceDown:d.onlyFaceDown,...d.range&&{range:d.range},...d.requiredTargetStatus&&{requiredTargetStatus:d.requiredTargetStatus},cleanupCommand:!0},sourceCard:g,sourceCoords:d.sourceCoords},t),!0}return!1}if(a&&a.mode==="SPAWN_TOKEN"){const{sourceCoords:m,payload:g,sourceCard:k,isDeployAbility:R,readyStatusToRemove:b}=a;if(!m||!(g!=null&&g.tokenName)||!(Math.abs(t.row-m.row)+Math.abs(t.col-m.col)===1))return!1;const x=(k==null?void 0:k.ownerId)??((_=a.sourceCard)==null?void 0:_.ownerId);return y(t,g.tokenName,x),u(m,R,!1,b),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="SELECT_CELL"){const{sourceCoords:m,sourceCard:g,isDeployAbility:k,readyStatusToRemove:R,payload:b}=a,O=(()=>{var N;if(m&&m.row>=0)return m;if(!g)return null;for(let G=0;G<r.board.length;G++)for(let $=0;$<r.board.length;$++)if(((N=r.board[G][$].card)==null?void 0:N.id)===g.id)return{row:G,col:$};return null})();if(!O||!g)return!1;let x=!1;if((b==null?void 0:b.range)==="line")x=t.row===O.row||t.col===O.col;else if((b==null?void 0:b.range)==="global")x=!0;else if((b==null?void 0:b.range)===2){const N=Math.abs(t.row-O.row)+Math.abs(t.col-O.col);if(N===1)x=!0;else if(N===2){const G=O.row,$=O.col,q=t.row,Q=t.col;x=[{r:q,c:$},{r:G,c:Q},{r:(G+q)/2,c:($+Q)/2}].some(oe=>{if(!Number.isInteger(oe.r)||!Number.isInteger(oe.c))return!1;const pe=Math.floor((r.board.length-r.activeGridSize)/2),V=pe,Se=pe+r.activeGridSize-1;return oe.r<V||oe.r>Se||oe.c<V||oe.c>Se||Math.abs(oe.r-G)+Math.abs(oe.c-$)!==1?!1:!r.board[oe.r][oe.c].card})}}else b!=null&&b.filter?x=b.filter(null,t.row,t.col):x=Math.abs(t.row-O.row)+Math.abs(t.col-O.col)===1;if(!x)return!1;if(b!=null&&b.moveFromHand&&c.selectedHandCard){const{playerId:N,cardIndex:G}=c.selectedHandCard,$=r.players.find(Q=>Q.id===N),q=$==null?void 0:$.hand[G];if(q)return D({card:q,source:"hand",playerId:N,cardIndex:G,isManual:!0},{target:"board",boardCoords:t}),u(m||t,k,!1,R),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(!((b==null?void 0:b.allowSelf)&&t.row===O.row&&t.col===O.col)){const N=r.board[O.row][O.col].card;N&&D({card:N,source:"board",boardCoords:O,bypassOwnershipCheck:!0},{target:"board",boardCoords:t})}if(b!=null&&b.recordContext&&o({lastMovedCardCoords:t,lastMovedCardId:g.id}),u(m||t,k,!1,R),b!=null&&b.chainedAction){const N={...b.chainedAction};N.targetOwnerId===-2&&(N.targetOwnerId=g.ownerId),b.recordContext&&(N.payload||(N.payload={}),N.payload._tempContextId=g.id),s(null),setTimeout(()=>{T(N,t)},ae.MODE_CLEAR_DELAY)}else setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY);return!0}if(a&&a.mode==="PATROL_MOVE"){const{sourceCoords:m,sourceCard:g,isDeployAbility:k,readyStatusToRemove:R}=a;if(!m||!g)return!1;if(t.row===m.row&&t.col===m.col)return u(m,k,!1,R),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0;const b=t.row===m.row,O=t.col===m.col;return!b&&!O||r.board[t.row][t.col].card!==null?!1:(D({card:g,source:"board",boardCoords:m},{target:"board",boardCoords:t}),u(t,k,!1,R),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0)}if(a&&a.mode==="RIOT_MOVE"){const{sourceCoords:m,sourceCard:g,isDeployAbility:k,readyStatusToRemove:R,payload:b}=a;return!m||!g||!(b!=null&&b.vacatedCoords)?!1:t.row===b.vacatedCoords.row&&t.col===b.vacatedCoords.col?(D({card:g,source:"board",boardCoords:m},{target:"board",boardCoords:t}),u(t,k,!1,R),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0):(u(m,k,!1,R),s(null),!0)}if(a&&a.mode==="IMMUNIS_RETRIEVE"){const{sourceCoords:m,payload:g,isDeployAbility:k,readyStatusToRemove:R,sourceCard:b}=a;if(!m||!(Math.abs(t.row-m.row)+Math.abs(t.col-m.col)===1))return!1;if((g==null?void 0:g.selectedCardIndex)!==void 0){const x=(b==null?void 0:b.ownerId)||0;return p(x,g.selectedCardIndex,t),u(m,k,!1,R),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}return!1}if(a&&a.mode==="INTEGRATOR_LINE_SELECT"){const{sourceCoords:m,sourceCard:g,isDeployAbility:k,readyStatusToRemove:R}=a;if(!m||m.row<0)return!1;const b=t.row===m.row,O=t.col===m.col;if(!b&&!O)return!1;const x=(g==null?void 0:g.ownerId)||0;let U=0;if(b)for(let N=0;N<w;N++){const G=r.board[t.row][N].card;G!=null&&G.statuses&&(U+=G.statuses.filter($=>$.type==="Exploit"&&$.addedByPlayerId===x).length)}else for(let N=0;N<w;N++){const G=r.board[N][t.col].card;N!==m.row&&G!=null&&G.statuses&&(U+=G.statuses.filter($=>$.type==="Exploit"&&$.addedByPlayerId===x).length)}return U>0&&(A(x,U),S({row:m.row,col:m.col,text:`+${U}`,playerId:x})),u(m,k,!1,R),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="IP_AGENT_THREAT_SCORING"){const{sourceCoords:m,sourceCard:g,isDeployAbility:k,readyStatusToRemove:R}=a;if(!m)return!1;const b=t.row===m.row,O=t.col===m.col;if(!b&&!O)return!1;const x=(g==null?void 0:g.ownerId)||0;let U=0;if(b)for(let G=0;G<w;G++){const $=r.board[t.row][G].card;$!=null&&$.statuses&&(U+=$.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===x).length)}else for(let G=0;G<w;G++){const $=r.board[G][t.col].card;G!==m.row&&$!=null&&$.statuses&&(U+=$.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===x).length)}const N=U*2;return N>0&&(A(x,N),S({row:m.row,col:m.col,text:`+${N}`,playerId:x})),u(m,k,!1,R),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(a&&a.mode==="ZIUS_LINE_SELECT"){const{sourceCoords:m,sourceCard:g,isDeployAbility:k,readyStatusToRemove:R}=a,b=c.lastMovedCardCoords||m;if(!b)return!1;const O=t.row===b.row,x=t.col===b.col;if(!O&&!x)return!1;const U=(g==null?void 0:g.ownerId)||0;let N=0;const G=[];if(O)for(let $=0;$<w;$++){const q=r.board[t.row][$].card;if(q!=null&&q.statuses){const Q=q.statuses.filter(J=>J.type==="Exploit"&&J.addedByPlayerId===U);N+=Q.length,Q.length>0&&G.push({row:t.row,col:$})}}else for(let $=0;$<w;$++){const q=r.board[$][t.col].card;if($!==b.row&&q!=null&&q.statuses){const Q=q.statuses.filter(J=>J.type==="Exploit"&&J.addedByPlayerId===U);N+=Q.length,Q.length>0&&G.push({row:$,col:t.col})}}return N>0&&(A(U,N),G.forEach($=>{S({row:$.row,col:$.col,text:"+1",playerId:U})})),u(m||b,k,!1,R),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}return a!=null&&a.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","SELECT_LINE_START","SELECT_DIAGONAL"].includes(a.mode)?(h(t),!0):i!=null&&i.card&&i.sourceCoords?(f({card:i.card,source:"hand",playerId:i.playerId,cardIndex:i.cardIndex},{location:"board",row:t.row,col:t.col}),!0):!1}function fi(t,e,r,n){var A;const{gameState:a,localPlayerId:s,abilityMode:d,cursorStack:c,interactionLock:o,setCommandContext:i,setAbilityMode:E,moveItem:P,markAbilityUsed:T,handleActionExecution:f,triggerHandCardSelection:D,setCursorStack:u,clearTargetingMode:y,clearValidTargets:p}=n;if(!o.current){if(c){if(["Aim","Exploit","Stun","Shield"].includes(c.type))return;const h={targetOwnerId:c.targetOwnerId,excludeOwnerId:c.excludeOwnerId,onlyOpponents:c.onlyOpponents||c.targetOwnerId===-1,onlyFaceDown:c.onlyFaceDown,targetType:c.targetType,requiredTargetStatus:c.requiredTargetStatus,tokenType:c.type};if(lt({card:e,ownerId:t.id,location:"hand"},h,a.activePlayerId,a.players)&&c.type==="Revealed"){const _=((A=c.sourceCard)==null?void 0:A.ownerId)??a.activePlayerId??s??1;e.statuses||(e.statuses=[]),e.statuses.some(g=>g.type==="Revealed"&&g.addedByPlayerId===_)||(e.statuses.push({type:"Revealed",addedByPlayerId:_}),P({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:t.id,cardIndex:r}),c.sourceCoords&&c.sourceCoords.row>=0&&T(c.sourceCoords,c.isDeployAbility,!1,c.readyStatusToRemove),c.count>1?u(g=>g?{...g,count:g.count-1}:null):(y(),p==null||p(),c.chainedAction&&f(c.chainedAction,c.sourceCoords||{row:-1,col:-1}),u(null)))}return}if((d==null?void 0:d.type)==="ENTER_MODE"&&d.mode==="SELECT_TARGET"){const{payload:S,sourceCoords:h,isDeployAbility:w,sourceCard:_,readyStatusToRemove:m}=d;if(D(t.id,r,a.activePlayerId??s??1),S.actionType==="SELECT_HAND_FOR_DEPLOY"){if(S.filter&&!S.filter(e))return;i(g=>({...g,selectedHandCard:{playerId:t.id,cardIndex:r}})),E({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,payload:{range:"global",moveFromHand:!0}});return}if(S.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(S.filter&&!S.filter(e)||t.id!==(_==null?void 0:_.ownerId))return;P({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),y(),p==null||p();const g={type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:_,sourceCoords:h,isDeployAbility:w,payload:{tokenName:S.tokenName}};E(g),h&&h.row>=0&&setTimeout(()=>{f(g,h)},0);return}if(S.actionType==="LUCIUS_SETUP"){if(t.id!==(_==null?void 0:_.ownerId))return;P({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),f({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:_,sourceCoords:h,isDeployAbility:w,payload:{filterType:"Command"}},h||{row:-1,col:-1}),E(null);return}if(S.actionType==="DESTROY"){if(S.filter&&!S.filter(e))return;P({card:e,source:"hand",playerId:t.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:t.id}),h&&h.row>=0&&T(h,w,!1,m),setTimeout(()=>E(null),ae.MODE_CLEAR_DELAY)}}}}function pi(t,e,r){const{abilityMode:n,cursorStack:a,interactionLock:s,gameState:d,activateAbility:c}=r;n||a||s.current||d.isGameStarted&&d.activePlayerId===t.id&&rs(e,"setup",d.currentPhase)&&c(e,{row:-1,col:-1})}function yi(t,e){var w,_,m,g,k;const{gameState:r,localPlayerId:n,abilityMode:a,interactionLock:s,setAbilityMode:d,markAbilityUsed:c,updatePlayerScore:o,triggerFloatingText:i,nextPhase:E,modifyBoardCardPower:P,scoreLine:T,scoreDiagonal:f,commandContext:D}=e;if(!a)return!1;const{mode:u,sourceCard:y,sourceCoords:p,payload:A,isDeployAbility:S,readyStatusToRemove:h}=a;if(u==="SCORE_LAST_PLAYED_LINE"&&a.sourceCoords){if(s.current)return!0;const{row:R,col:b}=a.sourceCoords,{row:O,col:x}=t;if(R!==O&&b!==x)return!0;s.current=!0;const U=r.activePlayerId,N=r.board.length;let G=R,$=R,q=b,Q=b;if(R===O)G=R,$=R,q=0,Q=N-1;else if(b===x)q=x,Q=x,G=0,$=N-1;else return s.current=!1,!0;const J=r.board.some(V=>V.some(Se=>{var ke,De;return((ke=Se.card)==null?void 0:ke.ownerId)===U&&Se.card.name.toLowerCase().includes("data liberator")&&((De=Se.card.statuses)==null?void 0:De.some(xe=>xe.type==="Support"))}));let oe=0;const pe=[];for(let V=G;V<=$;V++)for(let Se=q;Se<=Q;Se++){const De=r.board[V][Se].card;if(De&&!((w=De.statuses)!=null&&w.some(xe=>xe.type==="Stun"))){const xe=De.ownerId===U,ve=(_=De.statuses)==null?void 0:_.some(we=>we.type==="Exploit"&&we.addedByPlayerId===U);if(xe||J&&ve&&De.ownerId!==U){const we=Math.max(0,De.power+(De.powerModifier||0)+(De.bonusPower||0));we>0&&(oe+=we,pe.push({row:V,col:Se,text:`+${we}`,playerId:U}))}}}return d(null),pe.length>0&&i(pe),oe>0&&o(U,oe),E(),setTimeout(()=>{s.current=!1},200),!0}if(u==="SELECT_LINE_START")return d({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:y,sourceCoords:p,isDeployAbility:S,payload:{...A,firstCoords:t}}),!0;if(u==="SELECT_LINE_END"&&(A!=null&&A.firstCoords)){const{row:R,col:b}=A.firstCoords,{row:O,col:x}=t;if(R!==O&&b!==x)return!0;const U=A.actionType,N=(y==null?void 0:y.ownerId)??((m=r.players.find(G=>G.id===r.activePlayerId))!=null&&m.isDummy?r.activePlayerId:n||r.activePlayerId);if(U==="ZIUS_SCORING"){const G=D.lastMovedCardCoords;if(G){const V=R===O&&G.row===R,Se=b===x&&G.col===b;if(!V&&!Se)return!0}const $=r.board.length;let q=0,Q=$-1,J=0,oe=$-1;if(R===O)q=Q=R;else if(b===x)J=oe=b;else return!0;let pe=0;for(let V=q;V<=Q;V++)for(let Se=J;Se<=oe;Se++){const ke=r.board[V][Se];ke.card&&(pe+=((g=ke.card.statuses)==null?void 0:g.filter(De=>De.type==="Exploit"&&De.addedByPlayerId===N).length)||0)}pe>0&&N&&(p&&i({row:p.row,col:p.col,text:`+${pe}`,playerId:N}),o(N,pe)),p&&p.row>=0&&c(p,S,!1,h)}else if(U==="CENTURION_BUFF"&&y&&p&&N){const G=r.board.length;let $=0,q=G-1,Q=0,J=G-1;R===O?$=q=R:Q=J=b;for(let oe=$;oe<=q;oe++)for(let pe=Q;pe<=J;pe++){const V=r.board[oe][pe].card;if(V){const Se=V.id===y.id,ke=V.ownerId===N,De=r.players.find(we=>we.id===N),xe=r.players.find(we=>we.id===V.ownerId),ve=(De==null?void 0:De.teamId)!==void 0&&(xe==null?void 0:xe.teamId)!==void 0&&De.teamId===xe.teamId;!Se&&(ke||ve)&&P({row:oe,col:pe},1)}}c(p,S,!1,h)}else(U==="SCORE_LINE"||!U)&&(T(R,b,O,x,N),A.skipNextPhase||E());return setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0}if(u==="SELECT_DIAGONAL"&&A.actionType==="SCORE_DIAGONAL"){const R=(y==null?void 0:y.ownerId)??((k=r.players.find(b=>b.id===r.activePlayerId))!=null&&k.isDummy?r.activePlayerId:n||r.activePlayerId);if(A.firstCoords){const{row:b,col:O}=A.firstCoords,{row:x,col:U}=t;return Math.abs(b-x)!==Math.abs(O-U)?(d(null),!0):(f(b,O,x,U,R,A.bonusType),A.skipNextPhase||E(),d(null),!0)}else return d({...a,payload:{...A,firstCoords:t}}),!0}return!1}function hi(t,e,r){const{gameState:n,localPlayerId:a,abilityMode:s,interactionLock:d,handleLineSelection:c}=r;if(!s||s.type!=="ENTER_MODE"||d.current||s.sourceCard&&s.sourceCard.id===t.id&&s.mode!=="SELECT_LINE_START"&&s.mode!=="INTEGRATOR_LINE_SELECT"&&s.mode!=="ZIUS_LINE_SELECT"&&s.mode!=="IP_AGENT_THREAT_SCORING"&&s.mode!=="SELECT_UNIT_FOR_MOVE"&&s.mode!=="SELECT_TARGET"&&s.mode!=="RIOT_PUSH"&&s.mode!=="RIOT_MOVE"&&s.mode!=="REVEREND_DOUBLE_EXPLOIT"&&s.mode!=="SHIELD_SELF_THEN_RIOT_PUSH")return!1;const{mode:o,payload:i,sourceCard:E}=s;return o==="SELECT_LINE_START"||o==="SELECT_LINE_END"?(c(e),!0):o==="SELECT_TARGET"&&i.tokenType?mi(t,e,r):o==="SELECT_TARGET"?Ii(t,e,r):o==="RIOT_PUSH"?Ei(t,e,r):o==="SHIELD_SELF_THEN_RIOT_PUSH"?gi(t,e,r):o==="RIOT_MOVE"?Ti(t,e,r):o==="SWAP_POSITIONS"?wi(t,e,r):o==="TRANSFER_STATUS_SELECT"||o==="TRANSFER_ALL_STATUSES"?_i(t,e,r):o==="ZEALOUS_WEAKEN"?bi(t,e,r):o==="REVEREND_DOUBLE_EXPLOIT"?Ai(t,e,r):o==="SELECT_UNIT_FOR_MOVE"?Si(t,e,r):o==="PATROL_MOVE"?Ci(t,e,r):o==="SPAWN_TOKEN"?Di(t,e,r):o==="REVEAL_ENEMY"?Ri(t,e,r):o==="SELECT_CELL"?Pi(t,e,r):o==="IMMUNIS_RETRIEVE"?ki(t,e,r):o==="INTEGRATOR_LINE_SELECT"?Oi(t,e,r):o==="IP_AGENT_THREAT_SCORING"?vi(t,e,r):o==="ZIUS_LINE_SELECT"?Ni(t,e,r):o==="SELECT_DIAGONAL"?Mi(t,e,r):o==="SCORE_LAST_PLAYED_LINE"?Li(t,e,r):o==="SEARCH_DECK"?Gi(t,e,r):o==="RETRIEVE_DEVICE"?xi(t,e,r):o==="SELECT_DECK"?Ui(t,e,r):!1}function mi(t,e,r){const{abilityMode:n,triggerClickWave:a,moveItem:s,markAbilityUsed:d,setAbilityMode:c,setCommandContext:o,handleActionExecution:i,clearValidTargets:E}=r,{payload:P,sourceCoords:T,isDeployAbility:f,readyStatusToRemove:D}=n;if(P.filter&&!P.filter(t,e.row,e.col))return!1;if(s({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:P.tokenType,count:P.count||1},{target:"board",boardCoords:e}),a("board",e),P.recordContext&&o({lastMovedCardCoords:e,lastMovedCardId:t.id}),P.chainedAction){const u={...P.chainedAction,sourceCard:P.chainedAction.sourceCard??t,sourceCoords:P.chainedAction.sourceCoords??e,isDeployAbility:f,recordContext:!0};i(u,e),setTimeout(()=>a("board",e),100),u.type!=="ENTER_MODE"&&(c(null),E())}else T&&T.row>=0&&d(T,f,!1,D),setTimeout(()=>{c(null),E()},ae.MODE_CLEAR_DELAY);return!0}function Ii(t,e,r){var _,m,g,k,R;const{abilityMode:n,markAbilityUsed:a,setAbilityMode:s,moveItem:d,modifyBoardCardPower:c,addBoardCardStatus:o,removeBoardCardStatus:i,removeBoardCardStatusByOwner:E,removeStatusByType:P,resetDeployStatus:T,setCounterSelectionData:f,handleActionExecution:D,gameState:u,destroyCard:y}=r,{payload:p,sourceCoords:A,isDeployAbility:S,readyStatusToRemove:h}=n,w=((_=n.sourceCard)==null?void 0:_.ownerId)??((m=u.players.find(b=>b.id===u.activePlayerId))!=null&&m.isDummy?u.activePlayerId:r.localPlayerId||u.activePlayerId);if(p.actionType==="OPEN_COUNTER_MODAL")return p.filter&&!p.filter(t)?!1:(f({card:t,callbackAction:p.rewardType}),s(null),!0);if(p.actionType==="SACRIFICE_AND_BUFF_LINES"){if(p.filter&&!p.filter(t,e.row,e.col))return!1;const b=((g=n.sourceCard)==null?void 0:g.ownerId)??w;d({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"discard",playerId:t.ownerId});const O=u.board.length,{row:x,col:U}=e;for(let N=0;N<O;N++){if(N===U)continue;const $=u.board[x][N].card;$&&$.ownerId===b&&c({row:x,col:N},1)}for(let N=0;N<O;N++){if(N===x)continue;const $=u.board[N][U].card;$&&$.ownerId===b&&c({row:N,col:U},1)}return a(A||e,S,!1,h),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(p.actionType==="SHIELD_AND_REMOVE_AIM")return p.filter&&!p.filter(t)?!1:(o(e,"Shield",w),P(e,"Aim"),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0);if(p.actionType==="RESET_DEPLOY")return p.filter&&!p.filter(t)?!1:(T(e),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0);if(p.actionType==="MODIFY_POWER")return p.filter&&!p.filter(t)?!1:(p.amount&&c(e,p.amount),A&&A.row>=0&&a(A,S,!1,h),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0);if(p.actionType==="DESTROY")return p.filter&&!p.filter(t)?!1:((k=t.statuses)==null?void 0:k.some(O=>O.type==="Shield"))?(i(e,"Shield"),a(A||e,S,!1,h),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0):(y(t,e),a(A||e,S,!1,h),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0);if(p.actionType==="LUCIUS_SETUP")return p.filter&&!p.filter(t)?!1:(d({card:t,source:"board",boardCoords:e},{target:"discard",playerId:t.ownerId}),p.chainedAction&&D(p.chainedAction,e),!0);if(p.actionType==="CENSOR_SWAP"){if(p.filter&&!p.filter(t))return!1;const b=((R=t.statuses)==null?void 0:R.filter(O=>O.type==="Exploit"&&O.addedByPlayerId===w).length)||0;if(b>0){E(e,"Exploit",w);for(let O=0;O<b;O++)o(e,"Stun",w)}return a(A||e,S,!1,h),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}if(p.actionType==="REVEAL_ENEMY_CHAINED"){if(p.filter&&!p.filter(t,e.row,e.col))return!1;const b=t.ownerId;if(n.chainedAction){const O={...n.chainedAction,targetOwnerId:b,sourceCoords:A||e,sourceCard:n.sourceCard};D(O,e)}return a(A||e,S,!1,h),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0}return!1}function Ei(t,e,r){const{abilityMode:n,gameState:a,setAbilityMode:s,moveItem:d,markAbilityUsed:c,interactionLock:o}=r;if(o.current)return!1;const{sourceCoords:i,isDeployAbility:E,readyStatusToRemove:P,sourceCard:T}=n;if(!i||i.row<0)return!1;if(e.row===i.row&&e.col===i.col)return c(i,E,!1,P),setTimeout(()=>s(null),ae.MODE_CLEAR_DELAY),!0;const f=Math.abs(e.row-i.row)+Math.abs(e.col-i.col)===1,D=a.players.find(k=>k.id===t.ownerId),u=a.players.find(k=>k.id===(T==null?void 0:T.ownerId)),y=(D==null?void 0:D.teamId)!==void 0&&(u==null?void 0:u.teamId)!==void 0&&D.teamId===u.teamId;if(!f||t.ownerId===(T==null?void 0:T.ownerId)||y)return!1;const p=e.row-i.row,A=e.col-i.col,S=e.row+p,h=e.col+A,w=a.board.length,_=Math.floor((w-a.activeGridSize)/2),m=_,g=_+a.activeGridSize-1;return S<m||S>g||h<m||h>g||a.board[S][h].card!==null?!1:(d({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:S,col:h}}),s({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:T,sourceCoords:i,isDeployAbility:E,payload:{vacatedCoords:e}}),!0)}function Ti(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="RIOT_MOVE")return!1;const{sourceCoords:c,sourceCard:o,isDeployAbility:i,readyStatusToRemove:E,payload:P}=n;return!c||!o||!(P!=null&&P.vacatedCoords)?!1:e.row===P.vacatedCoords.row&&e.col===P.vacatedCoords.col?(a({card:o,source:"board",boardCoords:c},{target:"board",boardCoords:e}),s(e,i,!1,E),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0):(s(c,i,!1,E),d(null),!0)}function gi(t,e,r){const{abilityMode:n,gameState:a,setAbilityMode:s,addBoardCardStatus:d,markAbilityUsed:c,interactionLock:o,setTargetingMode:i,commandContext:E,moveItem:P}=r;if(o.current)return!1;const{sourceCoords:T,isDeployAbility:f,readyStatusToRemove:D,sourceCard:u}=n;if(!T||T.row<0||!u)return!1;const y=u.ownerId;if(e.row===T.row&&e.col===T.col){d(T,"Shield",y);const w={type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:u,sourceCoords:T,isDeployAbility:f,readyStatusToRemove:D,payload:{}};s(w);const _=T.row,m=T.col,g=[],k=[[-1,0],[1,0],[0,-1],[0,1]],R=a.board.length,b=Math.floor((R-a.activeGridSize)/2),O=b,x=b+a.activeGridSize-1;for(const[U,N]of k){const G=_+U,$=m+N;if(G>=O&&G<=x&&$>=O&&$<=x){const q=a.board[G][$];if(q.card){const Q=a.players.find(pe=>pe.id===q.card.ownerId),J=a.players.find(pe=>pe.id===y),oe=(Q==null?void 0:Q.teamId)!==void 0&&(J==null?void 0:J.teamId)!==void 0&&Q.teamId===J.teamId;q.card.ownerId!==y&&!oe&&g.push({row:G,col:$})}}}return i(w,y,T,g,E),!0}const p=Math.abs(e.row-T.row)+Math.abs(e.col-T.col)===1,A=a.players.find(w=>w.id===t.ownerId),S=a.players.find(w=>w.id===y),h=(A==null?void 0:A.teamId)!==void 0&&(S==null?void 0:S.teamId)!==void 0&&A.teamId===S.teamId;if(p&&t.ownerId!==y&&!h){const w=e.row-T.row,_=e.col-T.col,m=e.row+w,g=e.col+_,k=a.board.length,R=Math.floor((k-a.activeGridSize)/2),b=R,O=R+a.activeGridSize-1;return m<b||m>O||g<b||g>O||a.board[m][g].card!==null?!1:(P({card:t,source:"board",boardCoords:e,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:m,col:g}}),s({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:u,sourceCoords:T,isDeployAbility:f,payload:{vacatedCoords:e}}),!0)}return!1}function wi(t,e,r){const{abilityMode:n,gameState:a,swapCards:s,markAbilityUsed:d,setAbilityMode:c,validTargets:o}=r;if(!n||n.mode!=="SWAP_POSITIONS")return!1;const{sourceCoords:i,sourceCard:E,isDeployAbility:P,readyStatusToRemove:T,payload:f}=n;if(!i||i.row<0)return!1;const D=a.board[i.row][i.col].card;return!D||D.id!==(E==null?void 0:E.id)?(c(null),!1):E&&E.id===t.id||f.filter&&!f.filter(t,e.row,e.col)||!f.filter&&o&&!o.some(y=>y.row===e.row&&y.col===e.col)?!1:(s(i,e),d(e,P,!1,T),setTimeout(()=>c(null),ae.MODE_CLEAR_DELAY),!0)}function _i(t,e,r){const{abilityMode:n,transferAllStatusesWithoutException:a,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="TRANSFER_STATUS_SELECT"&&n.mode!=="TRANSFER_ALL_STATUSES")return!1;const{sourceCoords:c,sourceCard:o,isDeployAbility:i,readyStatusToRemove:E,payload:P}=n;return!c||c.row<0||o&&o.id===t.id||P!=null&&P.filter&&!P.filter(t)||n.mode==="TRANSFER_ALL_STATUSES"&&(!t.statuses||t.statuses.length===0)?!1:(n.mode==="TRANSFER_ALL_STATUSES"&&a(e,c),s(c,i,!1,E),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0)}function bi(t,e,r){const{abilityMode:n,modifyBoardCardPower:a,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="ZEALOUS_WEAKEN")return!1;const{payload:c,sourceCoords:o,isDeployAbility:i,readyStatusToRemove:E}=n;return c.filter&&!c.filter(t)?!1:(a(e,-1),s(o||e,i,!1,E),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0)}function Ai(t,e,r){const{abilityMode:n,addBoardCardStatus:a,markAbilityUsed:s,triggerFloatingText:d,setAbilityMode:c}=r;if(!n||n.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{sourceCoords:o,sourceCard:i,isDeployAbility:E,readyStatusToRemove:P}=n,T=(i==null?void 0:i.ownerId)||0,f=(t.statuses||[]).filter(D=>D.type==="Exploit"&&D.addedByPlayerId===T).length;if(f>0){for(let D=0;D<f;D++)a(e,"Exploit",T);d({row:e.row,col:e.col,text:`+${f}`,playerId:T,timestamp:Date.now()})}return s(o||e,E,!1,P),setTimeout(()=>c(null),ae.MODE_CLEAR_DELAY),!0}function Si(t,e,r){const{abilityMode:n,setAbilityMode:a}=r;if(!n||n.mode!=="SELECT_UNIT_FOR_MOVE")return!1;const{sourceCard:s,payload:d,isDeployAbility:c,readyStatusToRemove:o}=n;return s&&s.id===t.id||d.filter&&!d.filter(t,e.row,e.col)?!1:(a({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,sourceCoords:e,isDeployAbility:c,readyStatusToRemove:o,payload:{range:d.range||2,moveFromHand:d.moveFromHand||!1,selectedCard:t,allowSelf:!1}}),!0)}function Ci(t,e,r){const{abilityMode:n,gameState:a,moveItem:s,markAbilityUsed:d,setAbilityMode:c}=r;if(!n||n.mode!=="PATROL_MOVE")return!1;const{sourceCoords:o,sourceCard:i,isDeployAbility:E,readyStatusToRemove:P}=n;if(!o||!i)return!1;if(e.row===o.row&&e.col===o.col)return d(o,E,!1,P),setTimeout(()=>c(null),ae.MODE_CLEAR_DELAY),!0;const T=e.row===o.row,f=e.col===o.col;return!T&&!f||a.board[e.row][e.col].card!==null?!1:(s({card:i,source:"board",boardCoords:o},{target:"board",boardCoords:e}),d(e,E,!1,P),setTimeout(()=>c(null),ae.MODE_CLEAR_DELAY),!0)}function Di(t,e,r){var D;const{abilityMode:n,spawnToken:a,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="SPAWN_TOKEN")return!1;const{sourceCoords:c,payload:o,isDeployAbility:i,readyStatusToRemove:E,sourceCard:P}=n;if(!c||!(o!=null&&o.tokenName)||!(Math.abs(e.row-c.row)+Math.abs(e.col-c.col)===1))return!1;const f=(P==null?void 0:P.ownerId)??((D=n.sourceCard)==null?void 0:D.ownerId);return a(e,o.tokenName,f),s(c,i,!1,E),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0}function Ri(t,e,r){var S;const{abilityMode:n,setAbilityMode:a,setCursorStack:s,markAbilityUsed:d,gameState:c,localPlayerId:o}=r;if(!n||n.mode!=="REVEAL_ENEMY")return!1;const{sourceCoords:i,sourceCard:E,isDeployAbility:P,readyStatusToRemove:T}=n;if(!i||!E||!(Math.abs(e.row-i.row)+Math.abs(e.col-i.col)===1)||t.deck==="Tokens"||((S=t.types)==null?void 0:S.includes("Token")))return!1;const u=t.ownerId,y=c.players.find(h=>h.id===c.activePlayerId),p=y!=null&&y.isDummy&&c.activePlayerId!==null?c.activePlayerId:o??0;return s(br("Revealed",p,null,{targetOwnerId:u,onlyFaceDown:!0,sourceCoords:e,sourceCard:t,isDeployAbility:P,readyStatusToRemove:T})),d(i,P,!1,T),setTimeout(()=>a(null),ae.MODE_CLEAR_DELAY),!0}function Pi(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="SELECT_CELL")return!1;const{sourceCoords:c,sourceCard:o,isDeployAbility:i,readyStatusToRemove:E,payload:P}=n;return P!=null&&P.filter&&!P.filter(null,e.row,e.col)?!1:(P!=null&&P.moveFromHand&&(P!=null&&P.selectedCard)?a({card:P.selectedCard,source:"hand"},{target:"board",boardCoords:e}):c&&c.row>=0&&o&&a({card:o,source:"board",boardCoords:c},{target:"board",boardCoords:e}),s(c||e,i,!1,E),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0)}function ki(t,e,r){const{abilityMode:n,moveItem:a,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="IMMUNIS_RETRIEVE")return!1;const{sourceCoords:c,payload:o,isDeployAbility:i,readyStatusToRemove:E}=n;return!c||!(Math.abs(e.row-c.row)+Math.abs(e.col-c.col)===1)?!1:o!=null&&o.selectedCard?(a({card:o.selectedCard,source:"discard"},{target:"board",boardCoords:e}),s(c,i,!1,E),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0):!1}function Oi(t,e,r){const{abilityMode:n,gameState:a,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:c,setAbilityMode:o}=r;if(!n||n.mode!=="INTEGRATOR_LINE_SELECT")return!1;const{sourceCoords:i,sourceCard:E,isDeployAbility:P,readyStatusToRemove:T}=n,f=(E==null?void 0:E.ownerId)||0,D=i!==void 0&&e.row===i.row,u=i!==void 0&&e.col===i.col;if(!D&&!u)return!1;let y=0;if(D&&i)for(let p=0;p<a.board.length;p++){const A=a.board[e.row][p].card;A!=null&&A.statuses&&(y+=A.statuses.filter(S=>S.type==="Exploit"&&S.addedByPlayerId===f).length)}else if(i)for(let p=0;p<a.board.length;p++){const A=a.board[p][e.col].card;p!==i.row&&A!=null&&A.statuses&&(y+=A.statuses.filter(S=>S.type==="Exploit"&&S.addedByPlayerId===f).length)}return y>0&&(d(f,y),c({row:i.row,col:i.col,text:`+${y}`,playerId:f,timestamp:Date.now()})),s(i||e,P,!1,T),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0}function vi(t,e,r){const{abilityMode:n,gameState:a,updatePlayerScore:s,triggerFloatingText:d,markAbilityUsed:c,setAbilityMode:o}=r;if(!n||n.mode!=="IP_AGENT_THREAT_SCORING")return!1;const{sourceCoords:i,sourceCard:E,isDeployAbility:P,readyStatusToRemove:T}=n,f=(E==null?void 0:E.ownerId)||0;if(!i)return!1;const D=e.row===i.row,u=e.col===i.col;if(!D&&!u)return!1;let y=0;if(D)for(let A=0;A<a.board.length;A++){const S=a.board[e.row][A].card;S!=null&&S.statuses&&(y+=S.statuses.filter(h=>h.type==="Threat"&&h.addedByPlayerId===f).length)}else for(let A=0;A<a.board.length;A++){const S=a.board[A][e.col].card;A!==i.row&&S!=null&&S.statuses&&(y+=S.statuses.filter(h=>h.type==="Threat"&&h.addedByPlayerId===f).length)}const p=y*2;return p>0&&(s(f,p),d({row:i.row,col:i.col,text:`+${p}`,playerId:f,timestamp:Date.now()})),c(i||e,P,!1,T),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0}function Ni(t,e,r){const{abilityMode:n,gameState:a,commandContext:s,updatePlayerScore:d,triggerFloatingText:c,markAbilityUsed:o,setAbilityMode:i}=r;if(!n||n.mode!=="ZIUS_LINE_SELECT")return!1;const{sourceCoords:E,sourceCard:P,isDeployAbility:T,readyStatusToRemove:f}=n,D=(P==null?void 0:P.ownerId)||0,u=s.lastMovedCardCoords||E;if(!u)return!1;const y=e.row===u.row,p=e.col===u.col;if(!y&&!p)return!1;let A=0;const S=[];if(y)for(let h=0;h<a.board.length;h++){const w=a.board[e.row][h].card;if(w!=null&&w.statuses){const _=w.statuses.filter(m=>m.type==="Exploit"&&m.addedByPlayerId===D);A+=_.length,_.length>0&&S.push({row:e.row,col:h})}}else for(let h=0;h<a.board.length;h++){const w=a.board[h][e.col].card;if(h!==u.row&&w!=null&&w.statuses){const _=w.statuses.filter(m=>m.type==="Exploit"&&m.addedByPlayerId===D);A+=_.length,_.length>0&&S.push({row:h,col:e.col})}}return A>0&&(d(D,A),S.forEach(h=>{c({row:h.row,col:h.col,text:"+1",playerId:D,timestamp:Date.now()})})),o(E||e,T,!1,f),setTimeout(()=>i(null),ae.MODE_CLEAR_DELAY),!0}function Mi(t,e,r){var m;const{abilityMode:n,gameState:a,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:c,setAbilityMode:o}=r;if(!n||n.mode!=="SELECT_DIAGONAL")return!1;const{sourceCoords:i,sourceCard:E,isDeployAbility:P,readyStatusToRemove:T,payload:f}=n,D=(E==null?void 0:E.ownerId)||0,{row:u,col:y}=e,{row:p,col:A}=i||{row:0,col:0},S=u-y===p-A,h=u+y===p+A;if(!S&&!h)return!1;if(f!=null&&f.selectForMove&&t)return f.chainedAction&&r.handleActionExecution(f.chainedAction,e),!0;let w=0;const _=a.board.length;if(S){const g=p-A;for(let k=0;k<_;k++){const R=g+k,b=k;if(R>=0&&R<_&&b>=0&&b<_){const O=a.board[R][b].card;O!=null&&O.statuses&&(w+=O.statuses.filter(x=>x.type==="Exploit"&&x.addedByPlayerId===D).length)}}}if(h){const g=p+A;for(let k=0;k<_;k++){const R=k,b=g-R;if(R>=0&&R<_&&b>=0&&b<_){const O=a.board[R][b].card;O!=null&&O.statuses&&(w+=O.statuses.filter(x=>x.type==="Exploit"&&x.addedByPlayerId===D).length)}}}return f!=null&&f.bonusForSupport&&((m=E==null?void 0:E.statuses)!=null&&m.some(g=>g.type==="Support"))&&(w+=f.bonusForSupport),w>0&&(d(D,w),c({row:(i==null?void 0:i.row)||e.row,col:(i==null?void 0:i.col)||e.col,text:`+${w}`,playerId:D,timestamp:Date.now()})),s(i||e,P,!1,T),setTimeout(()=>o(null),ae.MODE_CLEAR_DELAY),!0}function Li(t,e,r){const{abilityMode:n,gameState:a,commandContext:s,markAbilityUsed:d,updatePlayerScore:c,triggerFloatingText:o,setAbilityMode:i}=r;if(!n||n.mode!=="SCORE_LAST_PLAYED_LINE")return!1;const{sourceCoords:E,sourceCard:P,isDeployAbility:T,readyStatusToRemove:f,payload:D}=n,u=(P==null?void 0:P.ownerId)||0,y=s.lastMovedCardCoords;if(!y)return!1;const p=a.board[y.row][y.col].card;if(!p)return!1;const A=e.row===y.row,S=e.col===y.col;if(!A&&!S)return!1;const h=Math.max(0,p.power+(p.powerModifier||0));return(D==null?void 0:D.rewardType)==="SCORE"?(c(u,h),o({row:y.row,col:y.col,text:`+${h}`,playerId:u,timestamp:Date.now()})):D==null||D.rewardType,d(E||e,T,!1,f),setTimeout(()=>i(null),ae.MODE_CLEAR_DELAY),!0}function Gi(t,e,r){const{abilityMode:n,setViewingDiscard:a,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="SEARCH_DECK")return!1;const{sourceCoords:c,isDeployAbility:o,readyStatusToRemove:i}=n;return a(!0),s(c||e,o,!1,i),d(null),!0}function xi(t,e,r){const{abilityMode:n,setViewingDiscard:a,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="RETRIEVE_DEVICE")return!1;const{sourceCoords:c,isDeployAbility:o,readyStatusToRemove:i}=n;return a(!0),s(c||e,o,!1,i),d(null),!0}function Ui(t,e,r){const{abilityMode:n,triggerDeckSelection:a,markAbilityUsed:s,setAbilityMode:d}=r;if(!n||n.mode!=="SELECT_DECK")return!1;const{sourceCoords:c,isDeployAbility:o,readyStatusToRemove:i}=n;return a(t.ownerId??0),s(c||e,o,!1,i),setTimeout(()=>d(null),ae.MODE_CLEAR_DELAY),!0}const ld=({gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,setCursorStack:s,commandContext:d,setCommandContext:c,setViewingDiscard:o,triggerNoTarget:i,triggerClickWave:E,playMode:P,setPlayMode:T,setCounterSelectionData:f,interactionLock:D,onAbilityComplete:u,moveItem:y,destroyCard:p,drawCardsBatch:A,updatePlayerScore:S,markAbilityUsed:h,applyGlobalEffect:w,swapCards:_,transferStatus:m,transferAllCounters:g,transferAllStatusesWithoutException:k,resurrectDiscardedCard:R,spawnToken:b,scoreLine:O,nextPhase:x,modifyBoardCardPower:U,addBoardCardStatus:N,removeBoardCardStatus:G,removeBoardCardStatusByOwner:$,resetDeployStatus:q,scoreDiagonal:Q,removeStatusByType:J,triggerFloatingText:oe,triggerHandCardSelection:pe,clearValidTargets:V,setTargetingMode:Se,clearTargetingMode:ke,validTargets:De})=>{const xe=H.useRef(()=>{}),ve=H.useCallback(Oe=>{yi(Oe,{gameState:t,localPlayerId:e,abilityMode:r,interactionLock:D,setAbilityMode:n,markAbilityUsed:h,updatePlayerScore:S,triggerFloatingText:oe,nextPhase:x,modifyBoardCardPower:U,scoreLine:O,scoreDiagonal:Q,commandContext:d})},[r,t,e,D,n,h,S,oe,x,U,O,Q,d]);xe.current=ve;const we=H.useCallback((Oe,Fe)=>{oi(Oe,Fe,{gameState:t,localPlayerId:e,setAbilityMode:n,setCursorStack:s,commandContext:d,markAbilityUsed:h,triggerNoTarget:i,handleActionExecution:we,modifyBoardCardPower:U,addBoardCardStatus:N,removeBoardCardStatus:G,removeStatusByType:J,updatePlayerScore:S,triggerFloatingText:oe,setViewingDiscard:o,handleLineSelection:xe.current,onAbilityComplete:u,applyGlobalEffect:w,drawCardsBatch:A,setTargetingMode:Se})},[t,e,r,n,a,s,d,c,T,h,i,D,y,p,_,m,g,k,b,U,N,G,$,J,q,S,oe,f,o,De,u,w,A,Se]);H.useEffect(()=>{(r==null?void 0:r.type)==="GLOBAL_AUTO_APPLY"&&(we(r,r.sourceCoords||{row:-1,col:-1}),n(null))},[r,we,n]),H.useEffect(()=>{r||ke()},[r,ke]);const je=H.useCallback((Oe,Fe)=>{Qn(Oe,Fe,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,handleActionExecution:we,markAbilityUsed:h,addBoardCardStatus:N})},[t,e,r,a,we,h,N]),Kt=H.useCallback((Oe,Fe)=>{var et,yt,bt;if(a&&T!==null&&T!==void 0){const at={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};if(lt({card:Oe,ownerId:Oe.ownerId??0,location:"board"},at,t.activePlayerId,t.players)){if(a.type==="Revealed"){const ot=((et=a.sourceCard)==null?void 0:et.ownerId)??t.activePlayerId??e??1;if((yt=Oe.statuses)==null?void 0:yt.some(Te=>Te.type==="Revealed"&&Te.addedByPlayerId===ot))return}const qt=a.originalOwnerId??((bt=a.sourceCard)==null?void 0:bt.ownerId)??t.activePlayerId??e??1;y({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:a.type,ownerId:qt,count:1},{target:"board",boardCoords:Fe}),a.sourceCoords&&a.sourceCoords.row>=0&&h(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?s(ot=>ot?{...ot,count:ot.count-1}:null):(ke(),V(),a.chainedAction&&we(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),s(null))}return}if(!D.current){if(!r&&!a&&t.isGameStarted&&sa(Oe,t)){je(Oe,Fe);return}if(r&&(r.mode==="SCORE_LAST_PLAYED_LINE"||r.mode==="SELECT_LINE_END")){ve(Fe);return}(r==null?void 0:r.type)==="ENTER_MODE"&&hi(Oe,Fe,{gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,setCursorStack:s,commandContext:d,setCommandContext:c,playMode:null,setPlayMode:T,draggedItem:null,setDraggedItem:()=>{},openContextMenu:()=>{},markAbilityUsed:h,triggerNoTarget:i,triggerClickWave:E,triggerDeckSelection:()=>{},handleActionExecution:we,interactionLock:D,moveItem:y,swapCards:_,transferStatus:m,transferAllCounters:g,transferAllStatusesWithoutException:k,destroyCard:p,spawnToken:b,modifyBoardCardPower:U,addBoardCardStatus:N,removeBoardCardStatus:G,removeBoardCardStatusByOwner:$,removeStatusByType:J,resetDeployStatus:q,updatePlayerScore:S,triggerFloatingText:oe,setCounterSelectionData:f,setViewingDiscard:o,clearValidTargets:V,validTargets:De,handleLineSelection:ve})||!r&&!a&&je(Oe,Fe)}},[a,T,t,e,D,r,ve,y,p,h,s,we,n,c,f,o,b,_,m,g,U,N,G,$,J,q,S,oe,i,E,De,ke,je]),pt=H.useCallback(Oe=>{ui(Oe,{gameState:t,localPlayerId:e,abilityMode:r,setAbilityMode:n,cursorStack:a,commandContext:d,setCommandContext:c,playMode:P,draggedItem:null,interactionLock:D,handleActionExecution:we,handleDrop:y,moveItem:y,markAbilityUsed:h,spawnToken:b,resurrectDiscardedCard:R,updatePlayerScore:S,triggerFloatingText:oe,handleLineSelection:ve})},[t,e,r,n,a,d,c,P,D,we,y,s,i,h,b,R,S,oe,ve]),Ze=H.useCallback((Oe,Fe,et)=>{fi(Oe,Fe,et,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,interactionLock:D,setCommandContext:c,setAbilityMode:n,moveItem:y,markAbilityUsed:h,handleActionExecution:we,triggerHandCardSelection:pe,setCursorStack:s,clearTargetingMode:ke,clearValidTargets:V})},[r,a,t,e,we,h,n,c,pe,y,s,ke,V,D]),Y=H.useCallback((Oe,Fe)=>{pi(Oe,Fe,{gameState:t,abilityMode:r,cursorStack:a,interactionLock:D,activateAbility:(et,yt)=>Qn(et,yt,{gameState:t,localPlayerId:e,abilityMode:r,cursorStack:a,handleActionExecution:we,markAbilityUsed:h,addBoardCardStatus:N})})},[r,a,t,e,we,h,n,c,pe,y,s,ke,V,D]);return{activateAbility:je,executeAction:we,handleLineSelection:ve,handleBoardCardClick:Kt,handleEmptyCellClick:pt,handleHandCardClick:Ze,handleAnnouncedCardDoubleClick:Y}},ir=(t,e,r,n,a)=>{const s=(r.baseId||t.split("_")[1]||t).toLowerCase(),d=e===-1,c=[];s==="overwatch"?d?c.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):e===0?c.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},targetOwnerId:-1,onlyOpponents:!0,sourceCard:r}):e===1&&c.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:a,baseCount:0}},sourceCard:r}):s==="tacticalmaneuver"?e===0?c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:i=>i.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:r}}}):e===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:i=>i.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:r}}}):s==="inspiration"?d&&c.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"OPEN_COUNTER_MODAL",filter:i=>i.ownerId===a}}):s==="datainterception"?d?c.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r}):e===0?c.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):e===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:i=>{var E;return((E=i.statuses)==null?void 0:E.some(P=>P.type==="Exploit"&&P.addedByPlayerId===a))||!1}}}):s==="falseorders"?d?c.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):e===0?c.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:a,sourceCard:r,originalOwnerId:r.ownerId}}}):e===1&&c.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:a}}}}):s==="experimentalstimulants"?e===0?c.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"RESET_DEPLOY",filter:i=>{var E;return i.ownerId===a&&((E=i.types)==null?void 0:E.includes("Unit"))}}}):e===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:"line",filter:i=>i.ownerId===a}}):s==="logisticschain"?e===0?c.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):e===1&&c.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):s==="quickresponseteam"?e===0?c.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:i=>{var E;return i.ownerId===a&&((E=i.types)==null?void 0:E.includes("Unit"))}}}):e===1&&c.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:r,payload:{filterType:"Unit"}}):s==="temporaryshelter"?e===0?c.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:r,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):e===1&&c.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:r,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):s==="enhancedinterrogation"?d?c.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):e===0?c.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):e===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:i=>{var E;return((E=i.statuses)==null?void 0:E.some(P=>P.type==="Aim"&&P.addedByPlayerId===a))||!1}}}):(s==="mobilization1"||s==="linebreach")&&d&&c.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:r,payload:{actionType:"SCORE_LINE"}});const o=r.ownerId||a;return c.forEach(i=>{i.originalOwnerId=o,i.sourceCard&&!i.sourceCard.ownerId&&(i.sourceCard.ownerId=o)}),c},ud=({gameState:t,localPlayerId:e,setActionQueue:r,setCommandContext:n,setCommandModalCard:a,setCounterSelectionData:s,moveItem:d,updatePlayerScore:c,updateState:o})=>{const i=H.useCallback((T,f)=>{if(e===null)return;const D=t.players.find(A=>A.id===f.playerId);if(!(f.playerId===e||(D==null?void 0:D.isDummy)))return;d(f,{target:"announced",playerId:f.playerId}),n({});const y=(T.baseId||T.id.split("_")[1]||T.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(A=>y.includes(A)))a(T);else{const A=ir(T.id,-1,T,t,f.playerId);A.length>0?r([...A,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:T,ownerId:f.playerId},sourceCard:T}]):r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:T,ownerId:f.playerId},sourceCard:T}])}},[t,e,d,r,n,a]),E=H.useCallback((T,f)=>{var S,h;if(!f||e===null)return;const D=f.ownerId||e,u=[],y=ir(f.id,-1,f,t,D);let p;(S=f.baseId)!=null&&S.toLowerCase().includes("inspiration")&&(p=T===0?"DRAW_REMOVED":"SCORE_REMOVED",y.length>0&&y[0].type==="ENTER_MODE"&&(y[0]={...y[0],payload:{...y[0].payload,rewardType:p}})),y.forEach(w=>{u.push(w)}),ir(f.id,T,f,t,D).forEach(w=>{u.push(w)}),(h=f.baseId)!=null&&h.toLowerCase().includes("inspiration")||u.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:f,ownerId:D},sourceCard:f}),r(u),a(null)},[t,e,r,a]),P=H.useCallback((T,f)=>{var p;if(e===null)return;const D=f.card.ownerId||e;let u=null;for(let A=0;A<t.board.length;A++){for(let S=0;S<t.board[A].length;S++)if(((p=t.board[A][S].card)==null?void 0:p.id)===f.card.id){u={row:A,col:S};break}if(u)break}if(!u){l.warn(`Card ${f.card.id} not found on board during counter removal`),s(null);return}if(o(A=>{if(!A.isGameStarted)return A;const S=fe(A),h=S.board[u.row][u.col].card;let w=0;const _=(h==null?void 0:h.statuses)??[];if(Object.entries(T).forEach(([m,g])=>{for(let k=0;k<g;k++){const R=_.map(b=>b.type).lastIndexOf(m);R>-1&&(h!=null&&h.statuses)&&(h.statuses.splice(R,1),w++)}}),!(h!=null&&h.statuses)&&h&&(h.statuses=[]),S.board=Le(S),w>0&&f.callbackAction==="DRAW_REMOVED"){const m=S.players.find(g=>g.id===D);if(m){const g=Math.min(w,m.deck.length);for(let k=0;k<g;k++){const R=m.deck.shift();R&&m.hand.push(R)}}}return S}),f.callbackAction==="SCORE_REMOVED"){const A=Object.values(T).reduce((S,h)=>S+h,0);A>0&&c(D,A)}const y=t.players.find(A=>A.id===D);y!=null&&y.announcedCard&&r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:y.announcedCard,ownerId:D},sourceCard:y.announcedCard}]),s(null)},[e,c,r,s,t,o]);return{playCommandCard:i,handleCommandConfirm:E,handleCounterSelectionConfirm:P}},fd=({gameState:t,localPlayerId:e,handleDrop:r,markAbilityUsed:n,requestCardReveal:a,interactionLock:s,setCommandContext:d,onAction:c,cursorStack:o,setCursorStack:i,setAbilityMode:E,triggerClickWave:P,clearTargetingMode:T})=>{const f=H.useRef(null),D=H.useRef({x:0,y:0});return H.useLayoutEffect(()=>{if(o&&f.current){const{x:y,y:p}=D.current;f.current.style.transform=`translate(${y-24}px, ${p-24}px)`}},[o]),H.useEffect(()=>{const y=p=>{D.current={x:p.clientX,y:p.clientY},f.current&&(f.current.style.transform=`translate(${p.clientX-24}px, ${p.clientY-24}px)`)};return window.addEventListener("mousemove",y),()=>window.removeEventListener("mousemove",y)},[]),H.useEffect(()=>{const y=p=>{var w,_,m,g,k,R;if(p.button!==0||!o)return;const A=document.elementFromPoint(p.clientX,p.clientY);let S=e;if(o.originalOwnerId!==void 0)S=o.originalOwnerId;else if((w=o.sourceCard)!=null&&w.ownerId)S=o.sourceCard.ownerId;else if(o.sourceCoords&&o.sourceCoords.row>=0){const{row:b,col:O}=o.sourceCoords;if(b>=0&&b<t.board.length&&O>=0&&O<((_=t.board[b])==null?void 0:_.length)){const x=t.board[b][O].card;x&&(S=x.ownerId||e)}}else if(t.activePlayerId){const b=t.players.find(O=>O.id===t.activePlayerId);b!=null&&b.isDummy&&(S=b.id)}let h=A==null?void 0:A.closest("[data-hand-card]");if(!h&&A)if(A.getAttribute("data-hand-card"))h=A;else{const b=A.querySelectorAll("[data-hand-card]");if(b.length>0){let O=1/0,x=null;const U=p.clientX,N=p.clientY;for(const G of Array.from(b)){const $=G.getBoundingClientRect();if(U>=$.left&&U<=$.right&&N>=$.top&&N<=$.bottom){const q=$.left+$.width/2,Q=$.top+$.height/2,J=Math.hypot(U-q,N-Q);J<O&&(O=J,x=G)}}h=x}}if(h){const b=h.getAttribute("data-hand-card");if(b){const[O,x]=b.split(","),U=parseInt(O,10),N=parseInt(x,10),G=t.players.find(q=>q.id===U),$=G==null?void 0:G.hand[N];if(G&&$){if(o.type==="Revealed"&&!G.isDummy){if((m=$.statuses)==null?void 0:m.some(pe=>pe.type==="Revealed"&&pe.addedByPlayerId===S))return;o.count===1&&(o.chainedAction&&c(o.chainedAction,o.sourceCoords||{row:-1,col:-1}),T()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:o.originalOwnerId??((g=o.sourceCard)==null?void 0:g.ownerId)??S??void 0,statusType:o.type,count:1},{target:"hand",playerId:U,cardIndex:N,boardCoords:void 0}),o.sourceCoords&&o.sourceCoords.row>=0&&n(o.sourceCoords,o.isDeployAbility),o.count>1?i(pe=>pe?{...pe,count:pe.count-1}:null):i(null),s.current=!0,setTimeout(()=>{s.current=!1},300);return}const Q={targetOwnerId:o.targetOwnerId,excludeOwnerId:o.excludeOwnerId,onlyOpponents:o.onlyOpponents||o.targetOwnerId===-1,onlyFaceDown:o.onlyFaceDown,targetType:o.targetType,requiredTargetStatus:o.requiredTargetStatus,tokenType:o.type};if(!lt({card:$,ownerId:U,location:"hand"},Q,S,t.players))return;o.count===1&&(o.chainedAction&&c(o.chainedAction,o.sourceCoords||{row:-1,col:-1}),T()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:o.originalOwnerId??((k=o.sourceCard)==null?void 0:k.ownerId),statusType:o.type,replaceStatusType:o.replaceStatus?o.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:U,cardIndex:N,boardCoords:void 0}),o.sourceCoords&&o.sourceCoords.row>=0&&n(o.sourceCoords,o.isDeployAbility),o.count>1?i(oe=>oe?{...oe,count:oe.count-1}:null):i(null),s.current=!0,setTimeout(()=>{s.current=!1},300);return}}}if(!h){const b=A==null?void 0:A.closest("[data-board-coords]");if(b){const O=b.getAttribute("data-board-coords");if(O){const[x,U]=O.split(","),N=parseInt(x,10),G=parseInt(U,10);if(!isNaN(N)&&!isNaN(G)&&N>=0&&N<t.board.length&&t.board[N]&&G>=0&&G<t.board[N].length&&t.board[N][G]){const $=t.board[N][G].card;if(($==null?void 0:$.ownerId)!==void 0){const q={targetOwnerId:o.targetOwnerId,excludeOwnerId:o.excludeOwnerId,onlyOpponents:o.onlyOpponents||o.targetOwnerId===-1,onlyFaceDown:o.onlyFaceDown,targetType:o.targetType,requiredTargetStatus:o.requiredTargetStatus,mustBeAdjacentToSource:o.mustBeAdjacentToSource,mustBeInLineWithSource:o.mustBeInLineWithSource,sourceCoords:o.sourceCoords,tokenType:o.type};if(!lt({card:$,ownerId:$.ownerId,location:"board",boardCoords:{row:N,col:G}},q,S,t.players))return}if($){const q=o.placeAllAtOnce?o.count:1;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:o.originalOwnerId??((R=o.sourceCard)==null?void 0:R.ownerId),statusType:o.type,replaceStatusType:o.replaceStatus?o.requiredTargetStatus:void 0,count:q},{target:"board",boardCoords:{row:N,col:G}}),P("board",{row:N,col:G}),o.recordContext&&d(J=>({...J,lastMovedCardCoords:{row:N,col:G},lastMovedCardId:$.id})),o.sourceCoords&&o.sourceCoords.row>=0&&n(o.sourceCoords,o.isDeployAbility);const Q=o.count-q;if(Q>0)i(J=>J?{...J,count:Q}:null);else{if(o.chainedAction){const J={...o.chainedAction};o.recordContext&&(J.mode==="SELECT_CELL"&&(J.sourceCard=$,J.sourceCoords={row:N,col:G},J.recordContext=!0),J.type==="GLOBAL_AUTO_APPLY"&&(J.sourceCoords={row:N,col:G}),J.type==="CREATE_STACK"&&(J.sourceCoords={row:N,col:G},J.originalOwnerId||(J.sourceCard=$)),J.mode==="ZIUS_LINE_SELECT"&&(J.sourceCoords={row:N,col:G})),J.type==="CREATE_STACK"&&E(null),c(J,{row:N,col:G})}T(),i(null)}s.current=!0,setTimeout(()=>{s.current=!1},300)}}}}else{const O=A==null?void 0:A.closest(".counter-modal-content"),x=(A==null?void 0:A.closest("[data-board-coords]"))!==null,U=(A==null?void 0:A.closest("[data-hand-card]"))!==null;o.isDragging?O?i(N=>N?{...N,isDragging:!1}:null):!x&&!U&&(T(),i(null)):!O&&!x&&!U&&(T(),i(null))}}};return window.addEventListener("mouseup",y),()=>{window.removeEventListener("mouseup",y)}},[o,r,t,e,a,n,s,d,c,i,E,P]),H.useEffect(()=>{const y=p=>{o&&(p.preventDefault(),T(),i(null))};return window.addEventListener("contextmenu",y),()=>{window.removeEventListener("contextmenu",y)}},[o,i,T]),{cursorFollowerRef:f,handleCounterMouseDown:(y,p)=>{D.current={x:p.clientX,y:p.clientY};const A=t.players.find(h=>h.id===t.activePlayerId),S=A!=null&&A.isDummy&&t.activePlayerId!==null?t.activePlayerId:e??0;i(h=>br(y,S,h))}}};export{st as A,zt as B,cd as C,qi as D,nd as E,ji as F,Ki as G,dd as H,ud as I,ld as J,fd as K,Wi as L,Qo as M,Wt as N,ir as O,es as P,lt as Q,Bt as R,Xi as S,ae as T,_r as U,Bi as V,Zo as W,ut as a,Vi as b,ra as c,ss as d,Qi as e,Ce as f,ed as g,sa as h,Ke as i,Yi as j,Jo as k,rd as l,l as m,yr as n,We as o,Ji as p,Xo as q,td as r,ts as s,jo as t,zi as u,Zi as v,sd as w,id as x,od as y,ad as z};
