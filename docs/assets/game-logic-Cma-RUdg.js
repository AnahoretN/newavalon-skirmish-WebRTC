import{r as $,j as Qa}from"./vendor-react-CfNVJRhB.js";import{$ as Jt}from"./vendor-webrtc-lnxn2S2z.js";import{d as Un,e as eo}from"./vendor-BPR6uEV2.js";var qe=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(qe||{}),Ar=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(Ar||{});const to={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253319/SYN_IP_DEPT_AGENT_mhwphu.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253342/SYN_TACTICAL_AGENT_xbb7i0.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253325/SYN_PATROL_AGENT_ioetlu.png",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253337/SYN_RIOT_AGENT_jurf4t.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253338/SYN_THREAT_ANALYST_sqnpgw.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678622/Mr._Pearl_Director_of_BioSynch_mo0cil.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253315/HOO_RECKLESS_PROVOCATEUR_hi7a9z.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253317/HOO_DATA_LIBERATOR_lbtqa2.png",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253309/HOO_CAUTIOUS_AVENGER_x4g4g3.png",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253311/HOO_VIGILANT_SPOTTER_eiephm.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253313/HOO_INVENTIVE_MAKER_uzrbg1.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764637482/Finn_nehk0r.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253324/OPT_FABER_d7uxew.png",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253321/OPT_CENSOR_wtxtc2.png",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253332/OPT_PRINCEPS_w3o5lq.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253327/OPT_IMMUNIS_bjlncl.png",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253330/OPT_CENTURION_aaushl.png",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678954/Lucius_The_Immortal_z0lemw.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253298/FUS_CODE_KEEPER_qotsym.png",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253305/FUS_DEVOUT_SYNTHETIC_bavg9k.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253303/FUS_UNWAVERING_INTEGRATOR_emret1.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253299/FUS_SIGNAL_PROPHET_nzd7w3.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253301/FUS_ZEALOUS_MISSIONARY_mfv9xl.png",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678937/Reverend_of_The_Choir_vts8im.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253291/CMD_OVERWATCH_hrba9x.png",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253296/CMD_REPOSITIONING_m7k4kf.png",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763260942/CMD_INSPIRATION_nxifhu.png",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253290/CMD_DATA_INTERCEPTION_ks4lcv.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763640484/CMD_FALSE_ORDERS_ghi01y.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Experimental_Stimulants_x8ns1g.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Logistics_Chain_d4irtq.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507609/Quick_Response_Team_rw2cut.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Temporary_Shelter_o0embx.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Enhanced_Interrogation_suzvxe.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764626980/Autonomous_Battle_Robot_Gawain_uoyjm5.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Reclaimed_Gawain_sg6257.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764767153/Secret_informant_eb0nkm.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Michael_Falk_wcxjnp.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Edith_Byron_v6691r.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Pinkunoneko_nhmjfv.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Maria_Eleftheria_Damanaki_bmx6xv.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Zius_cwd92f.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},ro={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253333/TKN_RECON_DRONE_esfknf.png",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253307/TKN_WALKING_TURRET_uq6owm.png",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},no={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Aim_dcct45.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Exploit_foomty.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Revealed_w1gbe7.png",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Stun_cwqroz.png",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Shield_z9sjr1.png",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Support_ui9qpl.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Threat_i1pbko.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1768321040/Resurrected_tscgk9.png",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},ao=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],cr={cardDatabase:to,tokenDatabase:ro,countersDatabase:no,deckFiles:ao};let vn=null,Ot=new Map,gr=new Map,Ft={},tr=[],_r={};const $n=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function ys(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const n=await fetch("/api/content/database");if(n.ok){const r=await n.json(),a=r.cards.map(([i,l])=>[i,l]),o=r.tokens.map(([i,l])=>[i,l]);e={cardDatabase:Object.fromEntries(a),tokenDatabase:Object.fromEntries(o),countersDatabase:Object.fromEntries(r.counters),deckFiles:r.deckFiles}}else e=cr}catch{e=cr}else e=cr;vn=e,Ot=new Map(Object.entries(e.cardDatabase)),gr=new Map(Object.entries(e.tokenDatabase)),Ft=e.countersDatabase,tr=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(Ft)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(n){console.warn("Could not save counters database to localStorage:",n)}ht=vn,Hn=Ot,so=gr,xt=Ft,io=tr,_r=oo(),co=_r}catch(e){throw console.error("Failed to load content database:",e),e}}function oo(){const e={};for(const t of tr){const n=[];for(const r of t.cards){const a=Ot.get(r.cardId);if(!a){console.warn(`Card definition not found for ID: ${r.cardId} in deck: ${t.name}`);continue}const o=$n.has(r.cardId);for(let i=0;i<r.quantity;i++){const c=r.cardId.replace(/-/g,"--DASH--").toUpperCase();o?n.push({...a,deck:qe.Command,id:`CMD_${c}_${i+1}`,baseId:r.cardId,faction:a.faction||"Command"}):n.push({...a,deck:t.id,id:`${t.id.substring(0,3).toUpperCase()}_${c}_${i+1}`,baseId:r.cardId,faction:a.faction||t.id})}}e[t.id]=n}return e[qe.Tokens]=Array.from(gr.entries()).map(([t,n])=>{const r=n.types?[...n.types]:[];return{id:`TKN_${n.name.toUpperCase().replace(/\s/g,"_")}`,baseId:t,deck:qe.Tokens,name:n.name,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage,power:n.power,ability:n.ability,color:n.color,types:r,flavorText:n.flavorText,faction:"Tokens"}}),e}let ht=null,Hn=new Map,so=new Map,xt={};try{const e=localStorage.getItem("counters_database");e&&(Ft=JSON.parse(e),xt=Ft)}catch{}let io=[],co={};const lo=$n,hs=()=>tr.filter(e=>e.isSelectable);function It(e){return Ot.get(e)}function lr(e){return Array.from(Ot.values()).find(t=>t.name===e)}function Is(){return Array.from(Ot.entries()).map(([e,t])=>({id:e,card:t}))}function Es(){return Ot}function Fn(){return _r}const uo=4,Ts={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764252181/medal_rgbw8d.png"},ms={[qe.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[qe.Hoods]:{prefix:"HOO",color:"border-purple-500"},[qe.Optimates]:{prefix:"OPT",color:"border-red-500"},[qe.Fusion]:{prefix:"FUS",color:"border-green-400"},[qe.Command]:{prefix:"CMD",color:"border-yellow-500"},[qe.Tokens]:{prefix:"TKN",color:"border-gray-400"},[qe.Custom]:{prefix:"CUS",color:"border-purple-400"},[qe.Neutral]:{prefix:"NEU",color:"border-gray-400"},[qe.Random]:{prefix:"RND",color:"border-gray-400"}},ws={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},fo={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},gs={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},rr=["blue","purple","red","green","yellow","orange","pink","brown"],_s=["Setup","Main","Commit","Scoring"],Xt=()=>Object.fromEntries(Object.entries(xt).map(([e,t])=>[e,t.imageUrl])),Cs=new Proxy({},{get(e,t){return Xt()[t]},ownKeys(){return Object.keys(Xt())},has(e,t){return t in Xt()},getOwnPropertyDescriptor(e,t){const n=Xt()[t];return n!==void 0?{enumerable:!0,configurable:!0,value:n}:void 0}}),Zt=()=>Object.fromEntries(Object.entries(xt).map(([e,t])=>[e,t.description])),bs=new Proxy({},{get(e,t){return Zt()[t]},ownKeys(){return Object.keys(Zt())},has(e,t){return t in Zt()},getOwnPropertyDescriptor(e,t){const n=Zt()[t];return n!==void 0?{enumerable:!0,configurable:!0,value:n}:void 0}}),po=()=>Object.entries(xt).filter(([,e])=>!e.allowedPanels||e.allowedPanels.includes("COUNTER_PANEL")).sort(([,e],[,t])=>e.sortOrder-t.sortOrder).map(([e,t])=>({type:e,label:t.name}));po();const Kt="readyDeploy",qt="readySetup",jt="readyCommit",vt=(e,t,n,r)=>Math.abs(e-n)+Math.abs(t-r)===1,Je=(e,t,n)=>e.statuses?e.statuses.some(r=>r.type===t&&(n===void 0||r.addedByPlayerId===n)):!1,Mt=(e,t)=>e.statuses?e.statuses.some(n=>n.type===t):!1,yo=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Je(a,"Aim",n)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"threatAnalyst",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>{let a=0;return t.board.forEach(o=>{o.forEach(i=>{var l;(l=i.card)!=null&&l.statuses&&(a+=i.card.statuses.filter(c=>c.type==="Exploit"&&c.addedByPlayerId===n).length)})}),a===0?null:{type:"CREATE_STACK",tokenType:"Revealed",count:a,onlyFaceDown:!0}}},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,t,n,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:n})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,t,n,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>{var o;return a.ownerId!==n&&((o=a.statuses)==null?void 0:o.some(i=>i.type==="Threat"))}},sourceCard:e,sourceCoords:r})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.ownerId!==n&&Je(a,"Exploit",n)}})},{baseId:"centurion",activationType:"commit",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(a,o,i)=>{var l;return a.ownerId===n&&((l=a.types)==null?void 0:l.includes("Unit"))&&o!==void 0&&i!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:r,payload:{filter:(a,o,i)=>vt(o,i,r.row,r.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.id===e.id?!1:a.ownerId===n}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:r,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Je(a,"Aim",n)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,originalOwnerId:n,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:a=>a.ownerId===n}})},{baseId:"censor",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:r,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Je(a,"Aim",n)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,t,n,r)=>Je(e,"Support",n)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:r,payload:{filter:(a,o)=>vt(a,o,r.row,r.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(a,o,i)=>vt(o,i,r.row,r.col)&&a.ownerId!==n&&(Je(a,"Threat",n)||Je(a,"Stun",n))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,t,n,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>a.ownerId===n&&Je(a,"Support",n)},sourceCard:e,sourceCoords:r})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.ownerId===n&&Je(a,"Exploit",n)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:r,payload:{filter:a=>Je(a,"Exploit",n)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"MODIFY_POWER",amount:-1,filter:a=>Je(a,"Aim",n)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:r,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"REVEAL_ENEMY",sourceCard:e,sourceCoords:r,payload:{filter:(a,o,i)=>vt(o,i,r.row,r.col)&&a.ownerId!==n}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Je(a,"Aim",n)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(a,o,i)=>vt(o,i,r.row,r.col)&&a.ownerId!==n&&(Je(a,"Threat",n)||Je(a,"Stun",n))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,t,n,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:n})},{baseId:"edithByron",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(a,o,i)=>vt(o,i,r.row,r.col)&&(Je(a,"Threat",n)||Je(a,"Stun",n)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>Je(a,"Aim",n)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:r,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,t,n,r)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:r,ownerId:n})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"LUCIUS_SETUP",filter:a=>a.ownerId===n}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.ownerId===n,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,t,n,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:r})}],Sr=e=>{const t=e.baseId||"";return yo.filter(n=>{var r;return n.baseId===t||((r=n.baseIdAlt)==null?void 0:r.includes(t))})},ho=e=>{const n=Sr(e).map(r=>r.activationType);return[...new Set(n)]},Cr=(e,t,n,r)=>{var i;if(n!==e.ownerId)return!1;if(r&&e.ownerId!==void 0){const l=r.players.find(c=>c.id===e.ownerId);if(l!=null&&l.isDummy&&r.activePlayerId!==e.ownerId)return!1}if((i=e.statuses)!=null&&i.some(l=>l.type==="Stun"))return!1;const a=Sr(e),o=t===1&&a.some(l=>l.activationType==="setup")||t===3&&a.some(l=>l.activationType==="commit");if(t===1){const l=a.find(c=>c.activationType==="setup");if(l&&Mt(e,qt))return!(l.supportRequired&&!Je(e,"Support",n))}if(t===3){const l=a.find(c=>c.activationType==="commit");if(l&&Mt(e,jt))return!(l.supportRequired&&!Je(e,"Support",n))}if(!o){const l=a.find(c=>c.activationType==="deploy");if(l&&Mt(e,Kt))return!(l.supportRequired&&!Je(e,"Support",n))}return!1},Io=(e,t,n,r)=>{if(n!==e.ownerId)if(e.ownerId!==void 0){const c=t.players.find(m=>m.id===e.ownerId);if(!(c!=null&&c.isDummy))return null}else return null;const a=Sr(e),o=e.ownerId??n??0,i=t.currentPhase,l=i===1&&a.some(c=>c.activationType==="setup")||i===3&&a.some(c=>c.activationType==="commit");if(i===1){const c=a.find(m=>m.activationType==="setup");if(c&&Mt(e,qt)){if(c.supportRequired&&!Je(e,"Support",o))return null;const m=c.getAction(e,t,o,r);if(m)return{...m,readyStatusToRemove:qt}}}if(i===3){const c=a.find(m=>m.activationType==="commit");if(c&&Mt(e,jt)){if(c.supportRequired&&!Je(e,"Support",o))return null;const m=c.getAction(e,t,o,r);if(m)return{...m,readyStatusToRemove:jt}}}if(!l){const c=a.find(m=>m.activationType==="deploy");if(c&&Mt(e,Kt)){if(c.supportRequired&&!Je(e,"Support",o))return null;const m=c.getAction(e,t,o,r);if(m)return{...m,isDeployAbility:!0,readyStatusToRemove:Kt}}}return null},d={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},Eo=(e,t,n)=>{let r,a;return typeof t=="object"?(r=t.currentPhase,n=t.activePlayerId??void 0,a=t):r=t,Cr(e,r,n??void 0,a)},Dr=(e,t)=>{e.statuses||(e.statuses=[]);const n=e.statuses.length,r=e.statuses.map(o=>o.type),a=ho(e);d.debug(`[initializeReadyStatuses] Card: ${e.name} (${e.id}), ownerId: ${t}, abilities: [${a.join(", ")}]`);for(const o of a){let i="";o==="deploy"?i=Kt:o==="setup"?i=qt:o==="commit"&&(i=jt),i&&!e.statuses.some(l=>l.type===i)&&(e.statuses.push({type:i,addedByPlayerId:t}),d.debug(`[initializeReadyStatuses] Added status: ${i} to ${e.name}`))}e.statuses.length!==n&&d.debug(`[initializeReadyStatuses] Card ${e.name}: statuses changed from [${r.join(", ")}] to [${e.statuses.map(o=>o.type).join(", ")}]`)},ur=e=>{e.statuses&&(e.statuses=e.statuses.filter(t=>t.type!==Kt&&t.type!==qt&&t.type!==jt))};function He(e){const t=e,n=t==null?void 0:t.targetingMode;n&&delete t.targetingMode;let r;return typeof structuredClone<"u"?r=structuredClone(e):r=JSON.parse(JSON.stringify(e)),n&&(r.targetingMode=n,t.targetingMode=n),r}const Ae={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function As(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function Ss(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}function Ds(e,t){return e?fo[e]:t}function Qe(){return localStorage.getItem("webrtc_enabled")==="true"}const Wn=$.createContext(null),Rs=({children:e})=>{const[t,n]=$.useState(null),[r,a]=$.useState({}),[o,i]=$.useState("lg"),l=$.useCallback((D,v={},C="lg")=>{n(D),a(v),i(C)},[]),c=$.useCallback(()=>{n(null),a({}),i("lg")},[]),m=$.useCallback(D=>t===D,[t]),E=$.useCallback(()=>r,[r]),k=$.useCallback(()=>o,[o]),p={openModal:t,modalData:r,modalSize:o,open:l,close:c,isOpen:m,getData:E,getSize:k};return Qa.jsx(Wn.Provider,{value:p,children:e})},sr=()=>{const e=$.useContext(Wn);if(!e)throw new Error("useModals must be used within ModalsProvider");return e},Os=()=>{const{open:e,close:t,isOpen:n}=sr();return{isOpen:n("rules"),open:r=>e("rules",r,"full"),close:t}},Ps=()=>{const{open:e,close:t,isOpen:n}=sr();return{isOpen:n("settings"),open:r=>e("settings",r,"md"),close:t}},ks=()=>{const{open:e,close:t,isOpen:n,getData:r}=sr();return{isOpen:n("joinGame"),open:a=>e("joinGame",a,"lg"),close:t,getData:()=>r()}},vs=()=>{const{open:e,close:t,isOpen:n}=sr();return{isOpen:n("deckBuilder"),open:r=>e("deckBuilder",r,"full"),close:t}},Wt="webrtc_game_state",Bt="webrtc_host_data",Yt="webrtc_guest_data",To="webrtc_current_host_peerId",mo=30*60*1e3;function Rr(){return Date.now()}function Vt(e){return Date.now()-e<mo}function wo(e){try{const t={...e,timestamp:Rr()};localStorage.setItem(Bt,JSON.stringify(t)),d.info("[WebRTC Persistence] Saved host data:",{peerId:t.peerId})}catch(t){d.error("[WebRTC Persistence] Failed to save host data:",t)}}function fr(e){try{const t={...e,timestamp:Rr()};localStorage.setItem(Yt,JSON.stringify(t)),d.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId})}catch(t){d.error("[WebRTC Persistence] Failed to save guest data:",t)}}function Ut(e){try{const t={...e,timestamp:Rr()};localStorage.setItem(Wt,JSON.stringify(t)),d.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(t.timestamp).toISOString())}catch(t){d.error("[WebRTC Persistence] Failed to save game state:",t)}}function Bn(){try{const e=localStorage.getItem(Bt);if(!e)return null;const t=JSON.parse(e);return Vt(t.timestamp)?(d.info("[WebRTC Persistence] Loaded valid host data:",{peerId:t.peerId}),t):(d.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(Bt),null)}catch(e){return d.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(Bt),null}}function Yn(){try{const e=localStorage.getItem(Yt);if(!e)return null;const t=JSON.parse(e);return Vt(t.timestamp)?(d.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId}),t):(d.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(Yt),null)}catch(e){return d.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(Yt),null}}function Nn(){try{const e=localStorage.getItem(Wt);if(!e)return null;const t=JSON.parse(e);return Vt(t.timestamp)?(d.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(t.timestamp).toISOString()),t):(d.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(Wt),null)}catch(e){return d.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(Wt),null}}function Lt(){localStorage.removeItem(Wt),localStorage.removeItem(Bt),localStorage.removeItem(Yt),localStorage.removeItem(To)}function br(e,t){try{const n=`webrtc_host_${t}`,r={peerId:e,gameId:t,timestamp:Date.now()};localStorage.setItem(n,JSON.stringify(r)),d.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${t}:`,e)}catch(n){d.error("[WebRTC Persistence] Failed to broadcast host peerId:",n)}}function pr(e){try{const t=`webrtc_host_${e}`,n=localStorage.getItem(t);if(!n)return null;const r=JSON.parse(n);return Date.now()-r.timestamp>15e3?null:{peerId:r.peerId,timestamp:r.timestamp}}catch(t){return d.error("[WebRTC Persistence] Failed to get host peerId:",t),null}}function go(e){try{const t=`webrtc_host_${e}`;localStorage.removeItem(t),d.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(t){d.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",t)}}function _o(){const e=sessionStorage.getItem("invite_host_id"),t=sessionStorage.getItem("invite_auto_join");if(e&&t)return"none";const n=Bn();if(n&&Vt(n.timestamp))return"host";const r=Yn();return r&&Vt(r.timestamp)?"guest":"none"}const Ln=7,yr="mrPearlDoF",Co="reverendOfTheChoir",bo="threatAnalyst";function Ao(e,t){return e!=null&&e.statuses?e.statuses.some(n=>n.type==="Exploit"&&n.addedByPlayerId!==void 0&&t.has(n.addedByPlayerId)):!1}function So(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const zn=()=>Array(Ln).fill(null).map(()=>Array(Ln).fill(null).map(()=>({card:null}))),at=e=>{var C,I,y,O,S;const{board:t,activeGridSize:n,players:r}=e,a=So(t),o=a.length,i=Math.floor((o-n)/2),l=new Map;r.forEach(u=>l.set(u.id,u.teamId));for(let u=0;u<o;u++)for(let b=0;b<o;b++){const T=a[u][b].card;T&&(T.statuses&&(T.statuses=T.statuses.filter(N=>N.type!=="Support"&&N.type!=="Threat")),delete T.bonusPower)}for(let u=0;u<o;u++)for(let b=0;b<o;b++){const T=a[u][b].card;if((T==null?void 0:T.ownerId)===void 0||T.isFaceDown)continue;const N=T.ownerId,w=l.get(N),R=[{r:u-1,c:b},{r:u+1,c:b},{r:u,c:b-1},{r:u,c:b+1}],A={};let P=!1;for(const J of R){const{r:ne,c:re}=J;if(ne>=0&&ne<o&&re>=0&&re<o){const ye=a[ne][re].card,he=(C=ye==null?void 0:ye.statuses)==null?void 0:C.some(we=>we.type==="Stun");if((ye==null?void 0:ye.ownerId)!==void 0&&!ye.isFaceDown&&!he){const we=ye.ownerId,Fe=l.get(we);N===we||w!==void 0&&w===Fe?P=!0:(A[we]||(A[we]=[]),A[we].push({r:ne,c:re}))}}}P&&(T.statuses||(T.statuses=[]),T.statuses.some(J=>J.type==="Support")||T.statuses.push({type:"Support",addedByPlayerId:N}));let z=null;for(const J in A){const ne=A[J];if(ne&&ne.length>=2){z=parseInt(J,10);break}}if(z===null&&u>=i&&u<i+n&&b>=i&&b<i+n){const ne=u===i||u===i+n-1||b===i||b===i+n-1,re=Object.keys(A).length>0;if(ne&&re){const ye=Object.keys(A)[0];ye&&(z=parseInt(ye,10))}}z!==null&&(T.statuses||(T.statuses=[]),T.statuses.some(J=>J.type==="Threat")||T.statuses.push({type:"Threat",addedByPlayerId:z}))}const c=new Set;for(let u=0;u<o;u++)for(let b=0;b<o;b++){const T=a[u][b].card,N=(I=T==null?void 0:T.statuses)==null?void 0:I.some(w=>w.type==="Stun");if((T==null?void 0:T.baseId)===bo&&!T.isFaceDown&&T.ownerId!==void 0&&!N){const w=[{r:u-1,c:b},{r:u+1,c:b},{r:u,c:b-1},{r:u,c:b+1}];let R=!1;const A=T.ownerId,P=l.get(A);for(const z of w){const{r:J,c:ne}=z;if(J>=0&&J<o&&ne>=0&&ne<o){const re=a[J][ne].card;if((re==null?void 0:re.ownerId)!==void 0&&!re.isFaceDown){const ye=re.ownerId,he=l.get(ye),we=A===ye||P!==void 0&&P===he,Fe=(y=re==null?void 0:re.statuses)==null?void 0:y.some(Le=>Le.type==="Stun");if(we&&!Fe){R=!0;break}}}}R&&c.add(A)}}for(let u=0;u<o;u++)for(let b=0;b<o;b++){const T=a[u][b].card;if(!T||T.isFaceDown||T.ownerId===void 0)continue;const N=T.ownerId,w=l.get(N),R=[{r:u-1,c:b},{r:u+1,c:b},{r:u,c:b-1},{r:u,c:b+1}],A={};for(const z of R){const{r:J,c:ne}=z;if(J>=0&&J<o&&ne>=0&&ne<o){const re=a[J][ne].card,ye=(O=re==null?void 0:re.statuses)==null?void 0:O.some(he=>he.type==="Stun");if((re==null?void 0:re.ownerId)!==void 0&&!re.isFaceDown&&!ye){const he=re.ownerId,we=l.get(he);if(!(N===he||w!==void 0&&w===we)){const Le=c.has(he),Oe=Ao(T,c);Le&&Oe&&(A[he]||(A[he]=0),A[he]++)}}}}if(Object.keys(A).length>0){T.statuses||(T.statuses=[]);const z=Object.keys(A).map(J=>parseInt(J,10));for(const J of z)T.statuses.some(ne=>ne.type==="Threat"&&ne.addedByPlayerId===J)||T.statuses.push({type:"Threat",addedByPlayerId:J})}}const m=[],E=[];for(let u=0;u<o;u++)for(let b=0;b<o;b++){const T=a[u][b].card,N=(S=T==null?void 0:T.statuses)==null?void 0:S.some(w=>w.type==="Stun");T!=null&&T.baseId&&!T.isFaceDown&&T.ownerId!==void 0&&!N&&(T.baseId===Co?m.push({r:u,c:b,ownerId:T.ownerId,baseId:T.baseId}):T.baseId===yr&&E.push({r:u,c:b,ownerId:T.ownerId,baseId:T.baseId}))}const k=new Set,p=new Set;for(const u of m){const{r:b,c:T,ownerId:N}=u,w=`${b}-${N}`;if(!k.has(w)){k.add(w);for(let A=0;A<o;A++){const P=a[b][A].card;P&&P.ownerId===N&&!P.isFaceDown&&(P.statuses||(P.statuses=[]),P.statuses.some(z=>z.type==="Support")||P.statuses.push({type:"Support",addedByPlayerId:N}))}}const R=`${T}-${N}`;if(!p.has(R)){p.add(R);for(let A=0;A<o;A++){const P=a[A][T].card;P&&P.ownerId===N&&!P.isFaceDown&&(P.statuses||(P.statuses=[]),P.statuses.some(z=>z.type==="Support")||P.statuses.push({type:"Support",addedByPlayerId:N}))}}}const D=new Set,v=new Set;for(const u of E){const{r:b,c:T,ownerId:N}=u,w=`${b}-${N}`;if(!D.has(w)){D.add(w);for(let A=0;A<o;A++){const P=a[b][A].card;P&&P.ownerId===N&&!P.isFaceDown&&P.baseId!==yr&&(P.bonusPower=(P.bonusPower||0)+1)}}const R=`${T}-${N}`;if(!v.has(R)){v.add(R);for(let A=0;A<o;A++){const P=a[A][T].card;P&&P.ownerId===N&&!P.isFaceDown&&P.baseId!==yr&&(P.bonusPower=(P.bonusPower||0)+1)}}}return a};var Pt=(e=>(e[e.CARD_REGISTRY=1]="CARD_REGISTRY",e[e.CARD_STATE=2]="CARD_STATE",e[e.ABILITY_EFFECT=3]="ABILITY_EFFECT",e[e.SESSION_EVENT=4]="SESSION_EVENT",e))(Pt||{});function Do(){const e={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},t=new Set,n=Array.from(Hn.values());for(const r of n)if(r.baseId&&!t.has(r.baseId)){t.add(r.baseId);const a=e.cardDefinitions.length;e.baseIdToIndex.set(r.baseId,a),e.indexToBaseId.set(a,r.baseId),e.cardDefinitions.push({baseId:r.baseId,name:r.name,imageUrl:r.imageUrl,power:r.power,ability:r.ability||"",types:r.types||[],faction:r.faction||""})}return e.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],d.info(`[CardRegistry] Built registry with ${e.cardDefinitions.length} cards, ${e.statusTypes.length} status types`),e}function Kn(e,t){let n=0;for(const r of e||[]){const a=t.statusTypes.indexOf(r.type);a>=0&&a<32&&(n|=1<<a)}return n>>>0}function qn(e,t,n){const r=[];for(let a=0;a<32;a++)if(e&1<<a){const o=n.statusTypes[a];o&&r.push({type:o,addedByPlayerId:t})}return r}function jn(e){let t=0;return e.isFaceDown&&(t|=1),e.enteredThisTurn&&(t|=2),e.revealedTo==="all"&&(t|=4),t}function hr(e,t){const n=new Uint8Array(13);let r=0;const a=Or(e.id);n[r++]=a>>24&255,n[r++]=a>>16&255,n[r++]=a>>8&255,n[r++]=a&255;const o=e.baseId?t.baseIdToIndex.get(e.baseId)??0:0;n[r++]=o>>8&255,n[r++]=o&255,n[r++]=(e.ownerId??0)&255;const i=Math.round(e.power||0);n[r++]=Math.clamp(i,-128,127)&255,n[r++]=jn(e);const l=Kn(e.statuses||[],t);return n[r++]=l>>24&255,n[r++]=l>>16&255,n[r++]=l>>8&255,n[r++]=l&255,n}function Ro(e,t){const n=new Uint8Array(9);let r=0;const a=Or(e.id);n[r++]=a>>24&255,n[r++]=a>>16&255,n[r++]=a>>8&255,n[r++]=a&255,n[r++]=jn(e);const o=Kn(e.statuses||[],t);return n[r++]=o>>24&255,n[r++]=o>>16&255,n[r++]=o>>8&255,n[r++]=o&255,n}function Or(e){let t=0;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);t=(t<<5)-t+r,t=t&t}return t>>>0}function Oo(e,t,n){var C;const r=[],a=Date.now(),o=new Uint8Array(7);o[0]=Pt.CARD_STATE,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,r.push(o);const i=[],l=Math.min(e.players.length,255);i.push(new Uint8Array([l]));for(const I of e.players){i.push(new Uint8Array([I.id&255]));const y=Math.min(I.deck.length,255),O=Math.min(I.hand.length,255),S=Math.min(I.discard.length,255);i.push(new Uint8Array([y,O,S,I.announcedCard?1:0])),i.push(new Uint8Array([Math.min(I.score,255)]));const u=Math.min(I.hand.length,255);i.push(new Uint8Array([u]));const b=I.id===n;for(const N of I.hand)b?i.push(hr(N,t)):i.push(Ro(N,t));const T=Math.min(I.discard.length,255);i.push(new Uint8Array([T]));for(const N of I.discard){const w=Or(N.id),R=new Uint8Array(4);R[0]=w>>24&255,R[1]=w>>16&255,R[2]=w>>8&255,R[3]=w&255,i.push(R)}I.announcedCard&&i.push(hr(I.announcedCard,t))}const c=e.board.length;i.push(new Uint8Array([c,c,c]));const m=[];for(let I=0;I<e.board.length;I++)for(let y=0;y<((C=e.board[I])==null?void 0:C.length);y++){const O=e.board[I][y];O!=null&&O.card&&m.push({row:I,col:y,card:O.card})}const E=m.length,k=new Uint8Array(2);k[0]=E>>8&255,k[1]=E&255,i.push(k);for(const{row:I,col:y,card:O}of m)i.push(new Uint8Array([I,y])),i.push(hr(O,t));i.push(new Uint8Array([e.currentPhase===void 0?255:Math.clamp(e.currentPhase,0,254),(e.activePlayerId??255)&255,e.currentRound===void 0?255:Math.clamp(e.currentRound,0,254)]));let p=0;for(const I of i)p+=I.length;o[5]=p>>8&255,o[6]=p&255,r.push(...i);const D=new Uint8Array(r.reduce((I,y)=>I+y.length,0));let v=0;for(const I of r)D.set(I,v),v+=I.length;return d.info(`[GameCodec] Encoded card state: ${D.length} bytes (${E} board cards, ${e.players.length} players)`),D}function Po(e,t,n){let r=0;if(e[r++]!==Pt.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],e[r++]<<8|e[r++];const a=e[r++],o=[];for(let C=0;C<a;C++){const I=e[r++],y=e[r++];e[r++],e[r++];const O=e[r++]===1,S=e[r++],u=e[r++],b=[],T=I===n;for(let P=0;P<u;P++)if(T)b.push(Ir(e,r,t)),r+=13;else{const z=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],J=e[r++],ne=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];b.push({id:`card_${z}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isFaceDown:(J&1)!==0,revealedTo:J&4?"all":void 0,statuses:qn(ne,I,t),isPlaceholder:!0})}const N=e[r++],w=[];for(let P=0;P<N;P++){const z=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];w.push({id:`discard_${z}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isPlaceholder:!0})}let R=null;O&&(R=Ir(e,r,t),r+=13);const A=[];for(let P=0;P<y;P++)A.push({id:`deck_${I}_${P}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isPlaceholder:!0});o.push({id:I,name:`Player ${I}`,score:S,hand:b,deck:A,discard:w,announcedCard:R,selectedDeck:"Random",color:"blue",boardHistory:[]})}const i=e[r++];r++,r++;const l=e[r++]<<8|e[r++],c=[];for(let C=0;C<i;C++){const I=[];for(let y=0;y<i;y++)I.push({card:null});c.push(I)}for(let C=0;C<l;C++){const I=e[r++],y=e[r++],O=Ir(e,r,t);r+=13,I<c.length&&y<c[I].length&&(c[I][y]={card:O})}const m=e[r++],E=e[r++],k=e[r++];return{players:o,board:c,currentPhase:m===255?void 0:m,activePlayerId:E===255?null:E,currentRound:k===255?void 0:k}}function Ir(e,t,n){const a=`card_${e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++]}_${Date.now()}`,o=e[t++]<<8|e[t++],i=e[t++];let l=e[t++];l>127&&(l=l-256);const c=e[t++],m=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++],E=n.cardDefinitions[o],k=(E==null?void 0:E.baseId)||"";return{id:a,baseId:k,deck:"Random",name:(E==null?void 0:E.name)||"?",imageUrl:(E==null?void 0:E.imageUrl)||"",power:l,ability:(E==null?void 0:E.ability)||"",types:(E==null?void 0:E.types)||[],faction:(E==null?void 0:E.faction)||"",ownerId:i,isFaceDown:(c&1)!==0,enteredThisTurn:(c&2)!==0,revealedTo:c&4?"all":void 0,statuses:qn(m,0,n)}}Math.clamp||(Math.clamp=function(e,t,n){return Math.min(Math.max(e,t),n)});let Er=null;function Vn(){return Er||(Er=Do()),Er}function Mn(e,t){const n=Vn();return Oo(e,n,t)}function ko(e,t){const n=Vn();return Po(e,n,t)}function vo(e){return Un(e)}function Jn(e){d.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return eo(e)}catch(t){return d.error("[webrtcSerialization] Failed to serialize delta:",t),new Uint8Array(0)}}function Xn(e){d.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Un(e)}catch(t){return d.error("[webrtcSerialization] Failed to deserialize delta:",t),{}}}function No(e){const t=Jn(e);let n="";const r=new Uint8Array(t),a=r.byteLength;for(let o=0;o<a;o++)n+=String.fromCharCode(r[o]);return btoa(n)}function Lo(e){const t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return Xn(n)}function Mo(e,t){var k;const n=new TextEncoder,r=[],a=Date.now(),o=new Uint8Array(7);o[0]=Pt.ABILITY_EFFECT,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,r.push(o);const i=[];if(i.push(new Uint8Array([e])),t.sourcePos){const p=(t.sourcePos.row&15)<<4|t.sourcePos.col&15;i.push(new Uint8Array([p]))}else i.push(new Uint8Array([255]));const l=((k=t.targetPositions)==null?void 0:k.length)||0;if(i.push(new Uint8Array([Math.min(l,255)])),t.targetPositions)for(const p of t.targetPositions.slice(0,255)){const D=(p.row&15)<<4|p.col&15;i.push(new Uint8Array([D]))}if(t.text){const p=n.encode(t.text),D=Math.min(p.length,255);i.push(new Uint8Array([D])),i.push(p.slice(0,D))}else i.push(new Uint8Array([0]));i.push(new Uint8Array([(t.value??0)&255])),i.push(new Uint8Array([(t.playerId??0)&255]));let c=0;for(const p of i)c+=p.length;o[5]=c>>8&255,o[6]=c&255,r.push(...i);const m=new Uint8Array(r.reduce((p,D)=>p+D.length,0));let E=0;for(const p of r)m.set(p,E),E+=p.length;return d.debug(`[AbilityMessages] Encoded effect type ${e}: ${m.length} bytes`),m}function Go(e){let t=0;if(e[t++]!==Pt.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const n=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={effectType:e[t++],timestamp:n,data:{}},a=e[t++];a!==255&&(r.data.sourcePos={row:a>>4&15,col:a&15});const o=e[t++];if(o>0){r.data.targetPositions=[];for(let l=0;l<o;l++){const c=e[t++];r.data.targetPositions.push({row:c>>4&15,col:c&15})}}const i=e[t++];if(i>0){const l=new TextDecoder;r.data.text=l.decode(e.subarray(t,t+i)),t+=i}return r.data.value=e[t++],r.data.playerId=e[t++],r}function xo(e,t={}){const n=new TextEncoder,r=[],a=Date.now(),o=new Uint8Array(7);o[0]=Pt.SESSION_EVENT,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,r.push(o);const i=[];if(i.push(new Uint8Array([e])),i.push(new Uint8Array([(t.playerId??0)&255])),t.playerName){const k=n.encode(t.playerName),p=Math.min(k.length,255);i.push(new Uint8Array([p])),i.push(k.slice(0,p))}else i.push(new Uint8Array([0]));i.push(new Uint8Array([(t.startingPlayerId??0)&255])),i.push(new Uint8Array([Math.min(t.roundNumber??0,255)])),i.push(new Uint8Array([Math.min(t.newPhase??0,255)])),i.push(new Uint8Array([(t.newActivePlayerId??0)&255])),i.push(new Uint8Array([(t.gameWinner??255)&255]));let l=0;if(t.winners)for(const k of t.winners)k<32&&(l|=1<<k);i.push(new Uint8Array([l>>24&255,l>>16&255,l>>8&255,l&255]));let c=0;for(const k of i)c+=k.length;o[5]=c>>8&255,o[6]=c&255,r.push(...i);const m=new Uint8Array(r.reduce((k,p)=>k+p.length,0));let E=0;for(const k of r)m.set(k,E),E+=k.length;return d.debug(`[SessionMessages] Encoded event type ${e}: ${m.length} bytes`),m}function Uo(e){let t=0;if(e[t++]!==Pt.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const n=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={eventType:e[t++],timestamp:n,data:{}};r.data.playerId=e[t++];const a=e[t++];if(a>0){const l=new TextDecoder;r.data.playerName=l.decode(e.subarray(t,t+a)),t+=a}r.data.startingPlayerId=e[t++],r.data.roundNumber=e[t++],r.data.newPhase=e[t++],r.data.newActivePlayerId=e[t++];const o=e[t++];r.data.gameWinner=o===255?null:o;const i=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];if(i!==0){r.data.winners=[];for(let l=0;l<32;l++)i&1<<l&&r.data.winners.push(l)}return r}const $o=!0;class Et{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,this.guestPlayerIds=new Map,localStorage.getItem("webrtc_enabled")}async initializeAsHost(t){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((n,r)=>{this.peer=t?new Jt(t):new Jt,this.peer.on("open",a=>{this.emitEvent({type:"peer_open",data:{peerId:a}}),n(a)}),this.peer.on("connection",a=>{d.info(`Guest connection request from: ${a.peer}`),this.handleGuestConnection(a)}),this.peer.on("error",a=>{d.error("WebRTC Peer error:",a),this.emitEvent({type:"error",data:a}),r(a)}),this.peer.on("close",()=>{d.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(t){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((n,r)=>{this.peer=new Jt,this.peer.on("open",a=>{const o=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(o),o.on("open",()=>{this.hostConnection=o,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}});let i=null;try{const l=localStorage.getItem("webrtc_preferred_deck");l&&(i=l,d.info(`[initializeAsGuest] Found deck preference in localStorage: ${i}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(l){d.warn("[initializeAsGuest] Failed to read deck preference:",l)}this.sendMessageToHost({type:"JOIN_REQUEST",senderId:a,data:{preferredDeck:i||void 0},timestamp:Date.now()}),n()}),o.on("error",i=>{d.error("Host connection error:",i),this.emitEvent({type:"error",data:i}),r(i)})}),this.peer.on("error",a=>{d.error("WebRTC Peer error:",a),this.emitEvent({type:"error",data:a}),r(a)})})}async initializeAsReconnectingGuest(t,n){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((r,a)=>{this.peer=new Jt,this.peer.on("open",o=>{const i=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(i),i.on("open",()=>{this.hostConnection=i,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:o,playerId:n,timestamp:Date.now()}),this.isReconnecting=!1,r()}),i.on("error",l=>{d.error("Host connection error:",l),this.emitEvent({type:"error",data:l}),this.isReconnecting=!1,a(l)})}),this.peer.on("error",o=>{d.error("WebRTC Peer error:",o),this.emitEvent({type:"error",data:o}),this.isReconnecting=!1,a(o)})})}handleGuestConnection(t){this.connections.set(t.peer,t),t.on("open",()=>{d.info(`Guest connected: ${t.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:t.peer}})}),t.on("data",n=>{this.handleMessage(n,t)}),t.on("close",()=>{d.info(`Guest disconnected: ${t.peer}`),this.connections.delete(t.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:t.peer}})}),t.on("error",n=>{d.error(`Guest connection error (${t.peer}):`,n)})}setupHostConnection(t){this.hostConnection=t,t.on("data",n=>{this.handleMessage(n,t)}),t.on("close",()=>{d.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),t.on("error",n=>{d.error("Host connection error:",n)})}handleMessage(t,n){d.debug("Received WebRTC message:",t.type),this.emitEvent({type:"message_received",data:t})}sendMessageToHost(t){if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(t),!0}catch(n){return d.error("Failed to send message to host:",n),!1}return!1}broadcastToGuests(t,n){if(!this.isHost)return d.warn("Only host can broadcast to guests"),0;let r=0;return this.connections.forEach((a,o)=>{if(a.open&&o!==n)try{a.send(t),r++}catch(i){d.error(`Failed to send to guest ${o}:`,i)}}),d.debug(`Broadcast to ${r}/${this.connections.size} guests`),r}sendToGuest(t,n){if(!this.isHost)return d.warn("Only host can send to specific guest"),!1;const r=this.connections.get(t);if(!r)return d.error(`[sendToGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!r.open)return d.error(`[sendToGuest] Connection for guest ${t} is not open`),!1;try{return r.send(n),d.debug(`Sent message to guest ${t}`),!0}catch(a){return d.error(`[sendToGuest] Failed to send message to ${t}:`,a),!1}}acceptGuest(t,n,r){var o;const a=this.connections.get(t);if(!a){d.error(`[acceptGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!a.open){d.error(`[acceptGuest] Connection for guest ${t} is not open`);return}try{if($o){const i=Mn(n,null),l={type:"JOIN_ACCEPT_BINARY",senderId:(o=this.peer)==null?void 0:o.id,playerId:r,data:i,timestamp:Date.now()};a.send(l),d.info(`Accepted guest ${t} as player ${r} (BINARY, ${i.byteLength} bytes)`)}}catch(i){d.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${t}:`,i)}}acceptGuestMinimal(t,n,r){var i;const a=this.connections.get(t);if(!a){d.error(`[acceptGuestMinimal] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!a.open){d.error(`[acceptGuestMinimal] Connection for guest ${t} is not open`);return}this.guestPlayerIds.set(t,r);const o={type:"JOIN_ACCEPT_MINIMAL",senderId:(i=this.peer)==null?void 0:i.id,playerId:r,data:n,timestamp:Date.now()};try{a.send(o),d.info(`Accepted guest ${t} as player ${r} (minimal)`)}catch(l){d.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${t}:`,l)}}broadcastGameState(t,n){this.broadcastGameStateLegacy(t,n)}broadcastGameStateLegacy(t,n){let r=0;this.connections.forEach((a,o)=>{var m;if(!a.open||o===n)return;const i=this.guestPlayerIds.get(o)??null,l=Et.createPersonalizedGameState(t,i),c={type:"STATE_UPDATE_COMPACT",senderId:(m=this.peer)==null?void 0:m.id,data:{gameState:l,recipientPlayerId:i},timestamp:Date.now()};try{a.send(c),r++}catch(E){d.error(`[broadcastGameStateLegacy] Failed to send to guest ${o} (player ${i}):`,E)}}),d.debug(`[broadcastGameStateLegacy] Sent to ${r}/${this.connections.size} guests`)}static createPersonalizedGameState(t,n){return{...t,players:t.players.map(r=>{if(n!==null&&r.id===n){const o=r.deck.length??0,i=r.discard.length??0,l=r.hand.length??0;return d.debug(`[createPersonalizedGameState] Player ${r.id} (own): ${l} hand, ${o} deck, ${i} discard`),{...r,handCards:r.hand.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier,isFaceDown:c.isFaceDown,statuses:c.statuses||[]})),deckCards:r.deck.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier,isFaceDown:c.isFaceDown,statuses:c.statuses||[]})),discardCards:r.discard.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier,isFaceDown:c.isFaceDown,statuses:c.statuses||[]})),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?Et.optimizeCard(r.announcedCard):null,deckSize:o,discardSize:i,handSize:l}}else{const o=r.deckSize??r.deck.length??0,i=r.hand.filter(l=>!l.isFaceDown).length;return i>0&&d.debug(`[createPersonalizedGameState] Player ${r.id} (other): ${i} revealed, ${r.hand.length-i} face-down`),{...r,hand:r.hand.map(l=>l.isFaceDown?Et.createCardBack(l):{id:l.id,baseId:l.baseId,power:l.power,powerModifier:l.powerModifier||0,isFaceDown:l.isFaceDown,statuses:l.statuses||[],ownerId:l.ownerId,ownerName:l.ownerName,deck:l.deck}),deck:[],discard:[],announcedCard:r.announcedCard?Et.createCardBack(r.announcedCard):null,deckSize:o,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}}}),board:t.board.map(r=>r.map(a=>({...a,card:a.card?Et.optimizeCard(a.card):null})))}}static createCompactStateForHost(t,n){return{...t,players:t.players.map(r=>r.id===n?(d.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(a=>({id:a.id,baseId:a.baseId,power:a.power,powerModifier:a.powerModifier,isFaceDown:a.isFaceDown,statuses:a.statuses||[]})),deckCards:r.deck.map(a=>({id:a.id,baseId:a.baseId,power:a.power,powerModifier:a.powerModifier,isFaceDown:a.isFaceDown,statuses:a.statuses||[]})),discardCards:r.discard.map(a=>({id:a.id,baseId:a.baseId,power:a.power,powerModifier:a.powerModifier,isFaceDown:a.isFaceDown,statuses:a.statuses||[]})),hand:[],deck:[],discard:[],handSize:r.hand.length,deckSize:r.deck.length,discardSize:r.discard.length}):{...r,hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}),board:t.board.map(r=>r.map(a=>({...a,card:a.card?Et.optimizeCard(a.card):null})))}}static optimizeCard(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier,ability:t.ability,ownerId:t.ownerId,color:t.color,deck:t.deck,isFaceDown:t.isFaceDown,types:t.types,faction:t.faction,statuses:t.statuses||[],hasRevealToken:t.hasRevealToken||!1,imageUrl:t.imageUrl}}static createCardBack(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,hasRevealToken:t.hasRevealToken||!1,statuses:t.statuses||[]}}broadcastStateDelta(t,n){var r,a;{const o=No(t),i={type:"STATE_DELTA_BINARY",senderId:(r=this.peer)==null?void 0:r.id,data:o,timestamp:Date.now()};d.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${o.length} chars, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, boardCells=${((a=t.boardCells)==null?void 0:a.length)||0}`),this.broadcastToGuests(i,n),d.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${t.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(t,n,r){var a;try{const o=Mn(t,n),i=btoa(String.fromCharCode(...o)),l={type:"CARD_STATE",senderId:(a=this.peer)==null?void 0:a.id,data:i,timestamp:Date.now()},c=this.broadcastToGuests(l,r);return d.info(`[broadcastCardState] Sent ${o.length} bytes to ${c} guests`),c}catch(o){return d.error("[broadcastCardState] Failed to encode/broadcast state:",o),0}}broadcastAbilityEffect(t,n,r){var a;try{const o=Mo(t,n),i=btoa(String.fromCharCode(...o)),l={type:"ABILITY_EFFECT",senderId:(a=this.peer)==null?void 0:a.id,data:i,timestamp:Date.now()},c=this.broadcastToGuests(l,r);return d.debug(`[broadcastAbilityEffect] Sent effect ${t} to ${c} guests`),c}catch(o){return d.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",o),0}}broadcastSessionEvent(t,n,r){var a;try{const o=xo(t,n),i=btoa(String.fromCharCode(...o)),l={type:"SESSION_EVENT",senderId:(a=this.peer)==null?void 0:a.id,data:i,timestamp:Date.now()},c=this.broadcastToGuests(l,r);return d.debug(`[broadcastSessionEvent] Sent event ${t} to ${c} guests`),c}catch(o){return d.error("[broadcastSessionEvent] Failed to encode/broadcast event:",o),0}}sendAction(t,n){var a;const r={type:"ACTION",senderId:(a=this.peer)==null?void 0:a.id,data:{actionType:t,actionData:n},timestamp:Date.now()};return this.sendMessageToHost(r)}sendStateDelta(t){var n;{const r=Jn(t),a={type:"STATE_DELTA_BINARY",senderId:(n=this.peer)==null?void 0:n.id,data:r,timestamp:Date.now()};return this.sendMessageToHost(a)}}sendStateToHost(t,n){var i,l,c;if(n===null)return d.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const r=Et.createCompactStateForHost(t,n),a=t.players.find(m=>m.id===n);a&&d.info(`[sendStateToHost] Player ${n} sending compact state: hand=${((i=a.hand)==null?void 0:i.length)??0}, deck=${((l=a.deck)==null?void 0:l.length)??0}`);const o={type:"STATE_UPDATE_COMPACT",senderId:(c=this.peer)==null?void 0:c.id,playerId:n,data:{gameState:r},timestamp:Date.now()};return this.sendMessageToHost(o)}sendFullDeckToHost(t,n,r){var o;const a={type:"DECK_DATA_UPDATE",senderId:(o=this.peer)==null?void 0:o.id,playerId:t,data:{playerId:t,deck:n.map(i=>Et.optimizeCard(i)),deckSize:r},timestamp:Date.now()};return this.sendMessageToHost(a)}sendCustomDeckData(t,n,r){var i;if(!r)return!0;d.info(`[sendCustomDeckData] Player ${t} sending ${n.length} custom deck cards to host`);const a=n.map(l=>({id:l.id,baseId:l.baseId,name:l.name,power:l.power,powerModifier:l.powerModifier,ability:l.ability,types:l.types,faction:l.faction,imageUrl:l.imageUrl,color:l.color,deck:l.deck})),o={type:"CUSTOM_DECK_DATA",senderId:(i=this.peer)==null?void 0:i.id,playerId:t,data:{playerId:t,deckCards:a},timestamp:Date.now()};return this.sendMessageToHost(o)}getConnectionInfo(){const t=[];return this.isHost?this.connections.forEach((n,r)=>{t.push({peerId:r,playerId:null,playerName:null,connected:n.open})}):this.hostConnection&&t.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),t}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getHostPeerId(){var t,n;return this.isHost?((t=this.peer)==null?void 0:t.id)||null:((n=this.hostConnection)==null?void 0:n.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var t;return this.isHost?this.connections.size:(t=this.hostConnection)!=null&&t.open?1:0}on(t){return this.eventHandlers.add(t),()=>this.eventHandlers.delete(t)}emitEvent(t){this.eventHandlers.forEach(n=>{try{n(t)}catch(r){d.error("Error in WebRTC event handler:",r)}})}cleanup(){this.connections.forEach(t=>t.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let Tr=null;const Ho=()=>(Tr||(Tr=new Et),Tr);function Fo(e){return 10+e*10}function Pr(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const t=e.currentPhase===1,n=e.activePlayerId===e.startingPlayerId;if(!t||!n)return{shouldEnd:!1,roundWinners:[]};const r=e.currentRound||1,a=Fo(r),o=[];for(const l of e.players)!l.isDummy&&!l.isDisconnected&&l.score>=a&&o.push(l.id);return{shouldEnd:o.length>0,roundWinners:o}}function Zn(e){const{shouldEnd:t,roundWinners:n}=Pr(e);if(!t)return e;const r=e.currentRound||1,a={...e.roundWinners,[r]:n},o=new Map;for(const[,l]of Object.entries(a))for(const c of l){const m=o.get(c)||0;o.set(c,m+1)}let i=null;for(const[l,c]of o.entries())if(c>=2){i=l;break}return d.info(`[endRound] Round ${r} ended. Winners: [${n.join(", ")}], Game winner: ${i||"none"}`),{...e,roundWinners:a,gameWinner:i,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function kr(e,t){if(e.currentPhase!==0)return d.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const n=e.players.find(o=>o.id===t);if(!n)return d.error(`[performPreparationPhase] Active player ${t} not found!`),e;d.info(`[performPreparationPhase] Player ${t} has deck size: ${n.deck.length}, hand size: ${n.hand.length}`);const r=e.players.map(o=>{if(o.id===t&&o.deck.length>0){const i=o.deck[0],l=[...o.deck.slice(1)],c=[...o.hand,i];return d.info(`[performPreparationPhase] Player ${t} drew card ${(i==null?void 0:i.id)||"unknown"}, deck now: ${l.length}, hand: ${c.length}`),{...o,deck:l,hand:c,readySetup:!1,readyCommit:!1}}return o}),a={...e,players:r,currentPhase:1};return Pr(a).shouldEnd?Zn(a):(d.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${a.activePlayerId}`),a)}function Qn(e,t){const n=e.activePlayerId;if(n===t){const l={...e,activePlayerId:null};return t===e.startingPlayerId&&e.currentPhase===1&&Pr(l).shouldEnd?Zn(l):l}if(!e.players.filter(l=>!l.isDisconnected).find(l=>l.id===t))return d.warn(`[toggleActivePlayer] Player ${t} not found or disconnected`),e;let o=e.turnNumber||1;t===e.startingPlayerId&&n!==null&&o++;const i={...e,activePlayerId:t,turnNumber:o,currentPhase:0};return kr(i,t)}function Wo(e,t){const n=e.players.filter(o=>!o.isDisconnected).sort((o,i)=>o.id-i.id);if(n.length===0)return null;if(t===null)return n[0].id;const r=n.findIndex(o=>o.id===t);if(r===-1)return n[0].id;const a=(r+1)%n.length;return n[a].id}function Bo(e,t){var n;for(const r of e.board)for(const a of r)if(((n=a.card)==null?void 0:n.ownerId)===t)return!0;return!1}function nr(e){const t=Wo(e,e.activePlayerId);if(t===null)return d.warn("[passTurnToNextPlayer] No next player found"),e;d.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${t}`);let n={...e,board:e.board.map(r=>r.map(a=>{var o;return((o=a.card)==null?void 0:o.ownerId)===e.activePlayerId&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(i=>i.type!=="Stun")}}:a}))};return n={...n,board:n.board.map(r=>r.map(a=>a.card&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(o=>o.type!=="enteredThisTurn")}}:a))},n={...n,activePlayerId:t,currentPhase:0,isScoringStep:!1},kr(n,t)}function mr(e,t,n){return d.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),e}function Yo(e,t){return{type:"RECONNECT_SNAPSHOT",data:e}}function zo(e,t,n){var r,a,o,i;try{const l=ko(e,n);d.info(`[WebRTCCodec] Received card state: ${(r=l.board)==null?void 0:r.length}x${((o=(a=l.board)==null?void 0:a[0])==null?void 0:o.length)||0}, ${((i=l.players)==null?void 0:i.length)||0} players`);const c={...t};return l.players&&(c.players=l.players.map(m=>{const E=t.players.find(k=>k.id===m.id);if(E){const k=m.id===n;return{...E,...m,hand:k?E.hand:m.hand}}return m})),l.board&&(c.board=l.board),l.currentPhase!==void 0&&(c.currentPhase=l.currentPhase),l.activePlayerId!==void 0&&(c.activePlayerId=l.activePlayerId),l.currentRound!==void 0&&(c.currentRound=l.currentRound),c}catch(l){return d.error("[WebRTCCodec] Failed to deserialize card state:",l),t}}function Ko(e,t){try{const{effectType:n,timestamp:r,data:a}=Go(e);d.debug(`[WebRTCCodec] Received ability effect: ${n}`);let o=t;switch(n){case 1:return{gameState:o,effectData:{type:"highlight",...a,timestamp:r}};case 2:return{gameState:o,effectData:{type:"floatingText",...a,timestamp:r}};case 3:return{gameState:o,effectData:{type:"noTarget",...a}};case 8:return{gameState:o,effectData:{type:"targetingMode",...a}};case 9:return{gameState:o,effectData:{type:"clearTargeting"}};default:return d.warn(`[WebRTCCodec] Unknown ability effect type: ${n}`),{gameState:o,effectData:null}}}catch(n){return d.error("[WebRTCCodec] Failed to handle ability effect:",n),{gameState:t,effectData:null}}}function qo(e,t){var n;try{const{eventType:r,data:a}=Uo(e);d.info(`[WebRTCCodec] Received session event: ${r}`);const o={...t};switch(r){case 1:d.info(`[WebRTCCodec] Player connected: ${a.playerName} (ID: ${a.playerId})`);break;case 2:d.info(`[WebRTCCodec] Player disconnected: ID: ${a.playerId}`),o.players=o.players.map(i=>i.id===a.playerId?{...i,isDisconnected:!0}:i);break;case 3:d.info(`[WebRTCCodec] Game starting, first player: ${a.startingPlayerId}`),o.isGameStarted=!0,a.startingPlayerId!==void 0&&(o.activePlayerId=a.startingPlayerId,o.startingPlayerId=a.startingPlayerId);break;case 4:d.info(`[WebRTCCodec] Round ${a.roundNumber} starting`),o.currentRound=a.roundNumber??1;break;case 5:if(d.info(`[WebRTCCodec] Round ${a.roundNumber} ended, winners: ${(n=a.winners)==null?void 0:n.join(", ")}`),o.isRoundEndModalOpen=!0,a.winners&&a.roundNumber!==void 0){const i=o.roundWinners||{};i[a.roundNumber]=a.winners,o.roundWinners=i}break;case 6:d.info(`[WebRTCCodec] Phase change: ${a.newPhase}`),a.newPhase!==void 0&&(o.currentPhase=a.newPhase),a.newActivePlayerId!==void 0&&(o.activePlayerId=a.newActivePlayerId);break;case 7:d.info(`[WebRTCCodec] Turn change: player ${a.newActivePlayerId}`),a.newActivePlayerId!==void 0&&(o.activePlayerId=a.newActivePlayerId);break;case 8:d.info(`[WebRTCCodec] Game ended, winner: ${a.gameWinner}`),a.gameWinner!==void 0&&(o.gameWinner=a.gameWinner===255?null:a.gameWinner);break;default:d.warn(`[WebRTCCodec] Unknown session event type: ${r}`)}return o}catch(r){return d.error("[WebRTCCodec] Failed to handle session event:",r),t}}function Nt(e,t,n,r){return e===2?{gameState:zo(t,n,r)}:e===3?Ko(t,n):e===4?{gameState:qo(t,n)}:(d.warn(`[WebRTCCodec] Unknown codec message type: ${e}`),{gameState:n})}const ar="avalon_game_state",Dt="reconnection_data";function ea(e,t){var r;e.forEach(a=>a.forEach(o=>{var i;(i=o.card)!=null&&i.statuses&&(o.card.statuses=o.card.statuses.filter(l=>!(l.type==="LastPlayed"&&l.addedByPlayerId===t.id)))})),t.boardHistory||(t.boardHistory=[]);let n=!1;for(;t.boardHistory.length>0&&!n;){const a=t.boardHistory[t.boardHistory.length-1];for(let o=0;o<e.length;o++){for(let i=0;i<e[o].length;i++)if(((r=e[o][i].card)==null?void 0:r.id)===a){const l=e[o][i].card;if(!l||l.ownerId!==t.id)continue;l.statuses||(l.statuses=[]),l.statuses.push({type:"LastPlayed",addedByPlayerId:t.id}),n=!0;break}if(n)break}n||t.boardHistory.pop()}}function $t(e){var r;if(!e||!ht)return e;const{cardDatabase:t,tokenDatabase:n}=ht;if(e.deck===qe.Tokens||(r=e.id)!=null&&r.startsWith("TKN_")){if(e.baseId&&n[e.baseId]){const o=n[e.baseId];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage}}const a=Object.keys(n).find(o=>n[o].name===e.name);if(a){const o=n[a];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage,baseId:a}}}else if(e.baseId&&t[e.baseId]){const a=t[e.baseId];return{...e,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage}}return e}function zt(e){var r,a;if(!ht)return e;const t=((r=e.board)==null?void 0:r.map(o=>o.map(i=>({...i,card:i.card?$t(i.card):null}))))||e.board,n=((a=e.players)==null?void 0:a.map(o=>{var i,l,c;return{...o,hand:((i=o.hand)==null?void 0:i.map($t))||[],deck:((l=o.deck)==null?void 0:l.map($t))||[],discard:((c=o.discard)==null?void 0:c.map($t))||[],announcedCard:o.announcedCard?$t(o.announcedCard):null}}))||e.players;return{...e,board:t,players:n,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}}function Gn(e,t,n){try{const r=zt(e),a={gameState:r,localPlayerId:t,playerToken:n,timestamp:Date.now()};localStorage.setItem(ar,JSON.stringify(a)),r.gameId&&t!==null&&localStorage.setItem(Dt,JSON.stringify({gameId:r.gameId,playerId:t,playerToken:n||null,timestamp:Date.now()}))}catch(r){console.warn("Failed to save game state:",r)}}function jo(){try{const e=localStorage.getItem(ar);if(!e)return null;const t=JSON.parse(e),n=24*60*60*1e3;if(Date.now()-t.timestamp>n)return localStorage.removeItem(ar),localStorage.removeItem(Dt),null;const r=t.gameState;return{gameState:zt(r),localPlayerId:t.localPlayerId,playerToken:t.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}}function Gt(){localStorage.removeItem(ar),localStorage.removeItem(Dt)}function vr(e){const t=[...e];for(let n=t.length-1;n>0;n--){const r=Math.floor(Math.random()*(n+1));[t[n],t[r]]=[t[r],t[n]]}return t}function ta(){return Math.random().toString(36).substring(2,18).toUpperCase()}function Ct(e,t,n){const r=Fn();let a=e;if(e==="Random"||!r[e]){const l=Object.keys(r);if(l.length===0)return d.error("[createDeck] No decks loaded yet!"),[];a=l[0],e==="Random"||d.warn(`[createDeck] Deck ${e} not found, using ${a} instead`)}const o=r[a];if(!o)return d.error(`Deck data for ${a} not loaded! Returning empty deck. Available decks:`,Object.keys(r)),[];const i=[...o].map(l=>({...l,ownerId:t,ownerName:n}));return vr(i)}function ra(e,t=!1){const n=Fn(),r=Object.keys(n);if(r.length===0)return d.error("[createNewPlayer] No decks loaded yet!"),{id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:rr[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};const a=r[0],o={id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:a,color:rr[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};return o.deck=Ct(a,e,o.name),o}function St(){return{players:[],spectators:[],board:zn(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:Ar.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}function Vo(){const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return d.warn("No custom WebSocket URL configured in settings."),null;let t=e.trim();return t.endsWith("/")&&(t=t.slice(0,-1)),t.startsWith("https://")?t=t.replace("https://","wss://"):t.startsWith("http://")&&(t=t.replace("http://","ws://")),!t.startsWith("ws://")&&!t.startsWith("wss://")?(d.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",t),t)}const xn=-1,Jo=-2,Ht=1,Qt=2,Rt=(e,t,n,r)=>{var l,c,m,E,k;const{card:a,ownerId:o,location:i}=e;if(t.targetOwnerId!==void 0&&t.targetOwnerId!==xn&&t.targetOwnerId!==Jo&&t.targetOwnerId!==o||t.excludeOwnerId!==void 0&&t.excludeOwnerId===o)return!1;if(t.onlyOpponents||t.targetOwnerId===xn){if(o===n)return!1;const p=r.find(v=>v.id===n),D=r.find(v=>v.id===o);if(p&&D&&p.teamId!==void 0&&p.teamId===D.teamId)return!1}if(t.targetType&&!((l=a.types)!=null&&l.includes(t.targetType))||t.onlyFaceDown&&((c=a.statuses)!=null&&c.some(p=>p.type==="Revealed"&&p.addedByPlayerId===n)||i==="board"&&!a.isFaceDown)||t.tokenType==="Revealed"&&(m=a.statuses)!=null&&m.some(p=>p.type==="Revealed"&&p.addedByPlayerId===n)||t.requiredTargetStatus&&(!((E=a.statuses)!=null&&E.some(p=>p.type===t.requiredTargetStatus))||t.requireStatusFromSourceOwner&&n!==null&&!((k=a.statuses)==null?void 0:k.some(D=>D.type===t.requiredTargetStatus&&D.addedByPlayerId===n))))return!1;if(t.mustBeAdjacentToSource&&t.sourceCoords&&e.boardCoords){const{row:p,col:D}=t.sourceCoords,{row:v,col:C}=e.boardCoords;if(Math.abs(p-v)+Math.abs(D-C)!==Ht)return!1}if(t.mustBeInLineWithSource&&t.sourceCoords&&e.boardCoords){const{row:p,col:D}=t.sourceCoords,{row:v,col:C}=e.boardCoords;if(p!==v&&D!==C)return!1}if(t.maxDistanceFromSource!==void 0&&t.sourceCoords&&e.boardCoords){const{row:p,col:D}=t.sourceCoords,{row:v,col:C}=e.boardCoords;if(Math.max(Math.abs(p-v),Math.abs(D-C))>t.maxDistanceFromSource)return!1}if(t.maxOrthogonalDistance!==void 0&&t.sourceCoords&&e.boardCoords){const{row:p,col:D}=t.sourceCoords,{row:v,col:C}=e.boardCoords;if(Math.abs(p-v)+Math.abs(D-C)>t.maxOrthogonalDistance)return!1}return!0},or=(e,t,n,r)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const a=[],o=t.board,i=o.length,l=t.activeGridSize,c=Math.floor((i-l)/2),m=c,E=c+l-1;if(e.type==="CREATE_STACK"){const C={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let I=m;I<=E;I++)for(let y=m;y<=E;y++){const O=o[I][y];O.card&&O.card.ownerId!==void 0&&Rt({card:O.card,ownerId:O.card.ownerId,location:"board",boardCoords:{row:I,col:y}},C,n,t.players)&&a.push({row:I,col:y})}return a}const{mode:k,payload:p,sourceCoords:D,contextCheck:v}=e;if(k==="REVEREND_DOUBLE_EXPLOIT"){for(let C=m;C<=E;C++)for(let I=m;I<=E;I++)o[C][I].card&&a.push({row:C,col:I});return a}if((k==="SELECT_TARGET"||k==="CENSOR_SWAP"||k==="ZEALOUS_WEAKEN"||k==="CENTURION_BUFF"||k==="SELECT_UNIT_FOR_MOVE")&&p.filter&&typeof p.filter=="function"){if(p.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||p.actionType==="LUCIUS_SETUP"||p.actionType==="SELECT_HAND_FOR_DEPLOY"||p.handOnly)return[];for(let C=m;C<=E;C++)for(let I=m;I<=E;I++){const y=o[C][I];let O=y.card&&p.filter(y.card,C,I);if(O&&v==="ADJACENT_TO_LAST_MOVE"&&(r!=null&&r.lastMovedCardCoords)){const{row:S,col:u}=r.lastMovedCardCoords;Math.abs(C-S)+Math.abs(I-u)===1||(O=!1)}O&&a.push({row:C,col:I})}}else if(k==="SELECT_TARGET"&&(p.actionType==="ENHANCED_INT_REVEAL"||p.actionType==="ENHANCED_INT_MOVE"))for(let C=m;C<=E;C++)for(let I=m;I<=E;I++)o[C][I].card&&a.push({row:C,col:I});else if(k==="PATROL_MOVE"&&D)for(let C=m;C<=E;C++)for(let I=m;I<=E;I++){const y=C===D.row||I===D.col,O=C===D.row&&I===D.col,S=!o[C][I].card;y&&(S||O)&&a.push({row:C,col:I})}else if(k==="RIOT_PUSH"&&D){const C=[{r:D.row-1,c:D.col},{r:D.row+1,c:D.col},{r:D.row,c:D.col-1},{r:D.row,c:D.col+1}],I=(y,O)=>y>=m&&y<=E&&O>=m&&O<=E;C.forEach(y=>{if(I(y.r,y.c)){const O=o[y.r][y.c].card;if(O&&O.ownerId!==n){const S=t.players.find(T=>T.id===n),u=t.players.find(T=>T.id===O.ownerId);if(!((S==null?void 0:S.teamId)!==void 0&&(u==null?void 0:u.teamId)!==void 0&&S.teamId===u.teamId)){const T=y.r-D.row,N=y.c-D.col,w=y.r+T,R=y.c+N;I(w,R)&&(o[w][R].card||a.push({row:y.r,col:y.c}))}}}})}else if(k==="RIOT_MOVE"&&p.vacatedCoords)a.push(p.vacatedCoords),D&&a.push(D);else if(k==="SWAP_POSITIONS"&&p.filter)for(let C=m;C<=E;C++)for(let I=m;I<=E;I++){const y=o[C][I];y.card&&p.filter(y.card,C,I)&&a.push({row:C,col:I})}else if((k==="TRANSFER_STATUS_SELECT"||k==="TRANSFER_ALL_STATUSES")&&p.filter)for(let C=m;C<=E;C++)for(let I=m;I<=E;I++){const y=o[C][I];y.card&&p.filter(y.card,C,I)&&a.push({row:C,col:I})}else if(k==="SPAWN_TOKEN"||k==="SELECT_CELL"||k==="IMMUNIS_RETRIEVE")for(let C=m;C<=E;C++)for(let I=m;I<=E;I++){const y=!o[C][I].card;if(k==="IMMUNIS_RETRIEVE"&&p.filter){y&&p.filter(C,I)&&a.push({row:C,col:I});continue}if(k==="SELECT_CELL"){if(p.moveFromHand){y&&a.push({row:C,col:I});continue}if(!D)continue;const O=C===D.row&&I===D.col,S=p.range==="global";let u=!1;if(S)u=!0;else if(p.range==="line")u=C===D.row||I===D.col;else if(p.range===Qt){const b=Math.abs(C-D.row),T=Math.abs(I-D.col),N=b+T;if(N===Ht)u=!0;else if(N===Qt){const w=[];b===Qt&&T===0?w.push({r:(C+D.row)/2,c:I}):b===0&&T===Qt?w.push({r:C,c:(I+D.col)/2}):b===Ht&&T===Ht&&(w.push({r:C,c:D.col}),w.push({r:D.row,c:I})),u=w.some(R=>R.r<0||R.r>=i||R.c<0||R.c>=i?!1:!o[R.r][R.c].card)}}else u=Math.abs(C-D.row)+Math.abs(I-D.col)===Ht;(y&&u||p.allowSelf&&O)&&a.push({row:C,col:I})}else if(k==="SPAWN_TOKEN"&&D){const O=Math.abs(C-D.row)+Math.abs(I-D.col)===1;y&&O&&a.push({row:C,col:I})}}else if(k==="REVEAL_ENEMY"&&p.filter)for(let C=m;C<=E;C++)for(let I=m;I<=E;I++){const y=o[C][I];y.card&&p.filter(y.card,C,I)&&a.push({row:C,col:I})}else if(k==="SELECT_LINE_START")for(let C=m;C<=E;C++)for(let I=m;I<=E;I++)a.push({row:C,col:I});else if(k==="SELECT_LINE_END"&&p.firstCoords){const{row:C,col:I}=p.firstCoords;for(let y=m;y<=E;y++)a.push({row:C,col:y});for(let y=m;y<=E;y++)a.push({row:y,col:I})}else if(k==="INTEGRATOR_LINE_SELECT"&&D){const{row:C,col:I}=D;for(let y=m;y<=E;y++)a.push({row:C,col:y});for(let y=m;y<=E;y++)a.push({row:y,col:I})}else if(k==="ZIUS_LINE_SELECT"&&D){const{row:C,col:I}=D;for(let y=m;y<=E;y++)a.push({row:C,col:y});for(let y=m;y<=E;y++)a.push({row:y,col:I})}else if(k==="IP_AGENT_THREAT_SCORING"&&D){const{row:C,col:I}=D;for(let y=m;y<=E;y++)a.push({row:C,col:y});for(let y=m;y<=E;y++)a.push({row:y,col:I})}else if(k==="SELECT_DIAGONAL")if(p.firstCoords){const{row:C,col:I}=p.firstCoords;for(let y=m;y<=E;y++)for(let O=m;O<=E;O++)Math.abs(y-C)===Math.abs(O-I)&&a.push({row:y,col:O})}else for(let C=m;C<=E;C++)for(let I=m;I<=E;I++)a.push({row:C,col:I});return a},er=(e,t,n,r)=>{var o,i,l,c,m;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let E=0;E<t.board.length;E++)for(let k=0;k<t.board[E].length;k++)if(t.board[E][k].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((o=e.payload)!=null&&o.actionType)){const E=e.payload.actionType;if(E==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||E==="LUCIUS_SETUP"||E==="SELECT_HAND_FOR_DEPLOY"){const k=((i=e.sourceCard)==null?void 0:i.ownerId)||n;if(k!==null){const p=t.players.find(D=>D.id===k);if(p&&p.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(or(e,t,n,r).length>0)return!0;if(e.tokenType==="Revealed"||(l=e.tokenType)!=null&&l.startsWith("Power"))for(const k of t.players)for(let p=0;p<k.hand.length;p++){const D={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(Rt({card:k.hand[p],ownerId:k.id,location:"hand"},D,n,t.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((c=e.payload)!=null&&c.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const E of t.players)if(E.hand.some(k=>e.payload.filter(k))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return or(e,t,n,r).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((m=e.payload)!=null&&m.filter),!1)};function Xo(e){const{ws:t,webrtcManager:n,gameStateRef:r,localPlayerIdRef:a,webrtcIsHostRef:o,setLatestHighlight:i,setLatestFloatingTexts:l,setLatestNoTarget:c,setLatestDeckSelections:m,setLatestHandCardSelections:E,setTargetSelectionEffects:k,setGameState:p}=e,D=$.useCallback(T=>{var w;const N={...T,timestamp:Date.now()};if(i(N),((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:r.current.gameId,highlightData:N}));else if(n.current){const R={type:"HIGHLIGHT_TRIGGERED",senderId:n.current.getPeerId(),data:N,timestamp:Date.now()};o.current?n.current.broadcastToGuests(R):n.current.sendMessageToHost(R)}},[t,n,r,o,i]),v=$.useCallback(T=>{var A;const N=Array.isArray(T)?T:[T],w=Date.now(),R=N.map((P,z)=>({...P,timestamp:w+z}));if(l(R),((A=t.current)==null?void 0:A.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:r.current.gameId,batch:R}));else if(n.current){const P={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:n.current.getPeerId(),data:{batch:R},timestamp:Date.now()};o.current?n.current.broadcastToGuests(P):n.current.sendMessageToHost(P)}},[t,n,r,o,l]),C=$.useCallback(T=>{var w;const N=Date.now();if(c({coords:T,timestamp:N}),((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:r.current.gameId,coords:T,timestamp:N}));else if(n.current){const R={type:"NO_TARGET_TRIGGERED",senderId:n.current.getPeerId(),data:{coords:T,timestamp:N},timestamp:Date.now()};o.current?n.current.broadcastToGuests(R):n.current.sendMessageToHost(R)}},[t,n,r,o,c]),I=$.useCallback((T,N)=>{var R;const w={playerId:T,selectedByPlayerId:N,timestamp:Date.now()};if(m(A=>[...A,w]),((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:r.current.gameId,deckSelectionData:w}));else if(n.current){const A={type:"DECK_SELECTION_TRIGGERED",senderId:n.current.getPeerId(),data:w,timestamp:Date.now()};o.current?n.current.broadcastToGuests(A):n.current.sendMessageToHost(A)}setTimeout(()=>{m(A=>A.filter(P=>P.timestamp!==w.timestamp))},1e3)},[t,n,r,o,m]),y=$.useCallback((T,N,w)=>{var A;const R={playerId:T,cardIndex:N,selectedByPlayerId:w,timestamp:Date.now()};if(E(P=>[...P,R]),((A=t.current)==null?void 0:A.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:r.current.gameId,handCardSelectionData:R}));else if(n.current){const P={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:n.current.getPeerId(),data:R,timestamp:Date.now()};o.current?n.current.broadcastToGuests(P):n.current.sendMessageToHost(P)}setTimeout(()=>{E(P=>P.filter(z=>z.timestamp!==R.timestamp))},1e3)},[t,n,r,o,E]),O=$.useCallback(T=>{var N;if(((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"SYNC_VALID_TARGETS",gameId:r.current.gameId,playerId:a.current,...T}));else if(n.current){const w={type:"SYNC_VALID_TARGETS",senderId:n.current.getPeerId(),data:{playerId:a.current,...T},timestamp:Date.now()};o.current?n.current.broadcastToGuests(w):n.current.sendMessageToHost(w)}},[t,n,r,o,a]),S=$.useCallback((T,N,w)=>{var A;if(a.current===null)return;const R={timestamp:Date.now(),location:T,boardCoords:N,handTarget:w,selectedByPlayerId:a.current};if(k(P=>[...P,R]),((A=t.current)==null?void 0:A.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_TARGET_SELECTION",gameId:r.current.gameId,effect:R}));else if(n.current)if(o.current){const P={type:"TARGET_SELECTION_TRIGGERED",senderId:n.current.getPeerId(),data:R,timestamp:Date.now()};n.current.broadcastToGuests(P)}else{const P={type:"SET_TARGETING_MODE",senderId:n.current.getPeerId(),data:R,timestamp:Date.now()};n.current.sendMessageToHost(P)}setTimeout(()=>{k(P=>P.filter(z=>z.timestamp!==R.timestamp))},1e3)},[t,n,r,o,a,k]),u=$.useCallback((T,N,w,R,A)=>{var ne;const P=r.current;if(!P||!P.board){console.warn("[setTargetingMode] No game state or board available");return}let z;R?z=R:w&&(z=or(T,P,N,A));const J={playerId:N,action:T,sourceCoords:w,timestamp:Date.now(),boardTargets:z};if(p(re=>({...re,targetingMode:J})),((ne=t.current)==null?void 0:ne.readyState)===WebSocket.OPEN&&P.gameId)t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:P.gameId,targetingMode:J}));else if(n.current){const re={type:"SET_TARGETING_MODE",senderId:n.current.getPeerId(),data:J,timestamp:Date.now()};o.current?n.current.broadcastToGuests(re):n.current.sendMessageToHost(re)}},[t,n,r,o,p]),b=$.useCallback(()=>{var N;const T=r.current;if(p(w=>({...w,targetingMode:null})),((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&(T!=null&&T.gameId))t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:T.gameId}));else if(n.current){const w={type:"CLEAR_TARGETING_MODE",senderId:n.current.getPeerId(),data:{},timestamp:Date.now()};o.current?n.current.broadcastToGuests(w):n.current.sendMessageToHost(w)}},[t,n,r,o,p]);return{triggerHighlight:D,triggerFloatingText:v,triggerNoTarget:C,triggerDeckSelection:I,triggerHandCardSelection:y,syncValidTargets:O,triggerTargetSelection:S,setTargetingMode:u,clearTargetingMode:b}}function Zo(e){const{ws:t,webrtcManager:n,gameStateRef:r,webrtcIsHostRef:a,setGameState:o,updateState:i}=e,l=$.useCallback(p=>{var v;if(Qe()&&n.current&&a.current){o(C=>{const I=C.players.map(y=>{let O=1;for(const[S,u]of Object.entries(p))if(u.includes(y.id)){O=parseInt(S);break}return{...y,teamId:O}});return{...C,players:I}}),n.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:n.current.getPeerId(),data:{assignments:p},timestamp:Date.now()});return}((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:r.current.gameId,assignments:p}))},[t,n,r,a,o]),c=$.useCallback(p=>{var v;if(Qe()&&n.current&&a.current){o(C=>({...C,gameMode:p})),n.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:n.current.getPeerId(),data:{mode:p},timestamp:Date.now()});return}((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:r.current.gameId,mode:p}))},[t,n,r,a,o]),m=$.useCallback(p=>{var v;if(Qe()&&n.current&&a.current){o(C=>({...C,isPrivate:p})),n.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:n.current.getPeerId(),data:{isPrivate:p},timestamp:Date.now()});return}((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:r.current.gameId,isPrivate:p}))},[t,n,r,a,o]),E=$.useCallback(p=>{i(D=>{if(D.isGameStarted)return D;const v={...D,activeGridSize:p};if(D.board.length!==p){v.board=[];for(let I=0;I<p;I++){const y=[];for(let O=0;O<p;O++)y.push({card:null});v.board.push(y)}}return v})},[i]),k=$.useCallback(p=>{i(D=>{if(D.isGameStarted)return D;const v=D.players.filter(y=>!y.isDummy);if(v.length+p>uo)return D;const C=[...v],I=Math.max(...v.map(y=>y.id),0);for(let y=0;y<p;y++){const O=I+y+1,S=ra(O,!0);S.name=`Dummy ${y+1}`,C.push(S)}return{...D,players:C,dummyPlayerCount:p}})},[i]);return{assignTeams:l,setGameMode:c,setGamePrivacy:m,setActiveGridSize:E,setDummyPlayerCount:k}}function Qo(e){const{ws:t,webrtcManager:n,gameStateRef:r,localPlayerIdRef:a,webrtcIsHostRef:o,setGameState:i}=e,l=$.useCallback(()=>{var k;if(Qe()&&n.current&&o.current){i(p=>({...p,isReadyCheckActive:!0,isPrivate:!0})),n.current.broadcastToGuests({type:"START_READY_CHECK",senderId:n.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((k=t.current)==null?void 0:k.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:r.current.gameId}))},[t,n,r,o,i]),c=$.useCallback(()=>{var k;if(Qe()&&n.current&&o.current){i(p=>({...p,isReadyCheckActive:!1})),n.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:n.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((k=t.current)==null?void 0:k.readyState)===WebSocket.OPEN&&r.current.gameId?t.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:r.current.gameId})):i(p=>({...p,isReadyCheckActive:!1}))},[t,n,r,o,i]),m=$.useCallback(()=>{var k;const E=Qe();if(E&&n.current&&o.current&&a.current!==null){i(p=>{const D=p.players.map(y=>y.id===a.current?{...y,isReady:!0}:y),v={...p,players:D},C=v.players.filter(y=>!y.isDummy&&!y.isDisconnected);if(C.length>0&&C.every(y=>y.isReady)&&!v.isGameStarted){const y=v.players.filter(T=>!T.isDisconnected),O=Math.floor(Math.random()*y.length),S=y[O].id,u={...v};u.isReadyCheckActive=!1,u.isGameStarted=!0,u.startingPlayerId=S,u.activePlayerId=S,u.currentPhase=0,u.players=u.players.map(T=>{if(T.hand.length===0&&T.deck.length>0){const w=[...T.hand],R=[...T.deck];for(let A=0;A<6&&A<R.length;A++){const P=R[0];R.splice(0,1),w.push(P)}return d.info(`[playerReady] Drew initial ${w.length} cards for player ${T.id}`),{...T,hand:w,deck:R}}return T});const b=u.players.find(T=>T.id===S);if(b&&b.deck.length>0){const T=b.deck[0],N=[...b.deck.slice(1)],w=[...b.hand,T];u.players=u.players.map(R=>R.id===S?{...R,deck:N,hand:w,readySetup:!1,readyCommit:!1}:R),u.currentPhase=1}return n.current.broadcastGameState(u),n.current.broadcastToGuests({type:"GAME_START",senderId:n.current.getPeerId(),data:{startingPlayerId:S,activePlayerId:S,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),u}return n.current.broadcastToGuests({type:"HOST_READY",senderId:n.current.getPeerId(),playerId:a.current??void 0,timestamp:Date.now()}),v});return}if(E&&n.current&&!o.current&&a.current!==null){n.current.sendMessageToHost({type:"PLAYER_READY",senderId:n.current.getPeerId(),playerId:a.current,timestamp:Date.now()}),i(p=>({...p,players:p.players.map(D=>D.id===a.current?{...D,isReady:!0}:D)}));return}((k=t.current)==null?void 0:k.readyState)===WebSocket.OPEN&&r.current.gameId&&a.current!==null&&t.current.send(JSON.stringify({type:"PLAYER_READY",gameId:r.current.gameId,playerId:a.current}))},[t,n,r,a,o,i]);return{startReadyCheck:l,cancelReadyCheck:c,playerReady:m}}function es(e){const{updateState:t,sendWebrtcAction:n,webrtcIsHostRef:r,webrtcManagerRef:a}=e,o=$.useCallback((l,c)=>{t(m=>m.isGameStarted?m:{...m,players:m.players.map(E=>E.id===l?{...E,name:c}:E)})},[t]),i=$.useCallback((l,c)=>{t(E=>({...E,players:E.players.map(k=>k.id===l?{...k,color:c}:k)})),n!==null&&(r!=null&&r.current&&(a!=null&&a.current)?a.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:a.current.getPeerId(),data:{playerId:l,color:c},timestamp:Date.now()}):!(r!=null&&r.current)&&n&&n("CHANGE_PLAYER_COLOR",{playerId:l,color:c}))},[t,n,r,a]);return{updatePlayerName:o,changePlayerColor:i}}function ts(e){const{updateState:t}=e,n=$.useCallback(l=>{t(c=>{if(!c.isGameStarted)return c;const m=c.players.find(D=>D.id===l);if(!m||m.deck.length===0)return c;const E=He(c),k=E.players.find(D=>D.id===l),p=k.deck.shift();return p&&k.hand.push(p),E})},[t]),r=$.useCallback((l,c)=>{c<=0||t(m=>{if(!m.isGameStarted)return m;const E=m.players.find(v=>v.id===l);if(!E||E.deck.length===0)return m;const k=He(m),p=k.players.find(v=>v.id===l),D=Math.min(c,p.deck.length);for(let v=0;v<D;v++){const C=p.deck.shift();C&&p.hand.push(C)}return k})},[t]),a=$.useCallback(l=>{t(c=>{if(!c.isGameStarted||!c.players.find(p=>p.id===l))return c;const E=He(c),k=E.players.find(p=>p.id===l);return k.deck=vr([...k.deck]),E})},[t]),o=$.useCallback(l=>{t(c=>{if(!c.isGameStarted)return c;const m={...c},E=m.board[l.row][l.col].card;return E&&(E.isFaceDown=!1),{...m,board:at(m)}})},[t]),i=$.useCallback(l=>{t(c=>{if(!c.isGameStarted)return c;const m={...c},E=m.board[l.row][l.col].card;return E&&(E.isFaceDown=!0),{...m,board:at(m)}})},[t]);return{drawCard:n,drawCardsBatch:r,shufflePlayerDeck:a,flipBoardCard:o,flipBoardCardFaceDown:i}}function rs(e){const{localPlayerIdRef:t,updateState:n}=e,r=$.useCallback((y,O,S)=>{n(u=>{var N,w;if(!u.isGameStarted)return u;const b=He(u),T=b.board[y.row][y.col].card;if(T){if(O==="Stun"&&(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius")&&((N=T.types)!=null&&N.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(O)&&((w=T.statuses)==null?void 0:w.some(A=>A.type===O&&A.addedByPlayerId===S)))return u;T.statuses||(T.statuses=[]),T.statuses.push({type:O,addedByPlayerId:S})}return b})},[n]),a=$.useCallback((y,O)=>{n(S=>{if(!S.isGameStarted)return S;const u=He(S),b=u.board[y.row][y.col].card;if(b!=null&&b.statuses){const T=b.statuses.map(N=>N.type).lastIndexOf(O);T>-1&&b.statuses.splice(T,1)}return u.board=at(u),u})},[n]),o=$.useCallback((y,O,S)=>{n(u=>{if(!u.isGameStarted)return u;const b=He(u),T=b.board[y.row][y.col].card;if(T!=null&&T.statuses){const N=T.statuses.findIndex(w=>w.type===O&&w.addedByPlayerId===S);N>-1&&T.statuses.splice(N,1)}return b.board=at(b),b})},[n]),i=$.useCallback((y,O)=>{n(S=>{if(!S.isGameStarted)return S;const u=He(S),b=u.board[y.row][y.col].card;return b&&(b.powerModifier===void 0&&(b.powerModifier=0),b.powerModifier+=O),u})},[n]),l=$.useCallback((y,O,S)=>{n(u=>{var N;if(!u.isGameStarted)return u;const b=He(u),T=b.players.find(w=>w.id===y);if(T!=null&&T.announcedCard){if(["Support","Threat","Revealed"].includes(O)&&((N=T.announcedCard.statuses)==null?void 0:N.some(R=>R.type===O&&R.addedByPlayerId===S)))return u;T.announcedCard.statuses||(T.announcedCard.statuses=[]),T.announcedCard.statuses.push({type:O,addedByPlayerId:S})}return b})},[n]),c=$.useCallback((y,O)=>{n(S=>{var T;if(!S.isGameStarted)return S;const u=He(S),b=u.players.find(N=>N.id===y);if((T=b==null?void 0:b.announcedCard)!=null&&T.statuses){const N=b.announcedCard.statuses.map(w=>w.type).lastIndexOf(O);N>-1&&b.announcedCard.statuses.splice(N,1)}return u})},[n]),m=$.useCallback((y,O)=>{n(S=>{if(!S.isGameStarted)return S;const u=He(S),b=u.players.find(T=>T.id===y);return b!=null&&b.announcedCard&&(b.announcedCard.powerModifier===void 0&&(b.announcedCard.powerModifier=0),b.announcedCard.powerModifier+=O),u})},[n]),E=$.useCallback((y,O,S,u)=>{n(b=>{var w;if(!b.isGameStarted)return b;const T=He(b),N=T.players.find(R=>R.id===y);if(N!=null&&N.hand[O]){const R=N.hand[O];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(S)&&((w=R.statuses)==null?void 0:w.some(P=>P.type===S&&P.addedByPlayerId===u)))return b;R.statuses||(R.statuses=[]),R.statuses.push({type:S,addedByPlayerId:u})}return T})},[n]),k=$.useCallback((y,O,S)=>{n(u=>{if(!u.isGameStarted)return u;const b=He(u),T=b.players.find(w=>w.id===y),N=T==null?void 0:T.hand[O];if(N!=null&&N.statuses){const w=N.statuses.map(R=>R.type).lastIndexOf(S);w>-1&&N.statuses.splice(w,1),S==="Revealed"&&(N.statuses.some(A=>A.type==="Revealed")||delete N.revealedTo)}return b})},[n]),p=$.useCallback((y,O,S)=>{n(u=>{const b=u.players.find(w=>w.id===y);if(!(b!=null&&b.hand[O]))return u;const T=He(u),N=T.players.find(w=>w.id===y).hand[O];if(S==="all")N.revealedTo="all",N.statuses||(N.statuses=[]),N.statuses.some(w=>w.type==="Revealed"&&w.addedByPlayerId===y)||N.statuses.push({type:"Revealed",addedByPlayerId:y});else{(!N.revealedTo||N.revealedTo==="all"||!Array.isArray(N.revealedTo))&&(N.revealedTo=[]);const w=S.filter(R=>!N.revealedTo.includes(R));N.revealedTo.push(...w)}return T})},[n]),D=$.useCallback((y,O)=>{n(S=>{if(!S.board[y.row][y.col].card)return S;const b=He(S),T=b.board[y.row][y.col].card,N=T.ownerId;if(O==="all")T.revealedTo="all",N!==void 0&&(T.statuses||(T.statuses=[]),T.statuses.some(w=>w.type==="Revealed"&&w.addedByPlayerId===N)||T.statuses.push({type:"Revealed",addedByPlayerId:N}));else{(!T.revealedTo||T.revealedTo==="all"||!Array.isArray(T.revealedTo))&&(T.revealedTo=[]);const w=O.filter(R=>!T.revealedTo.includes(R));T.revealedTo.push(...w)}return b})},[n]),v=$.useCallback((y,O)=>{n(S=>{var N;const u=y.boardCoords?(N=S.board[y.boardCoords.row][y.boardCoords.col].card)==null?void 0:N.ownerId:y.ownerId;if(!u)return S;const b=He(S),T=b.revealRequests.find(w=>w.fromPlayerId===O&&w.toPlayerId===u);return T?T.cardIdentifiers.some(R=>JSON.stringify(R)===JSON.stringify(y))||T.cardIdentifiers.push(y):b.revealRequests.push({fromPlayerId:O,toPlayerId:u,cardIdentifiers:[y]}),b})},[n]),C=$.useCallback((y,O)=>{n(S=>{const u=S.revealRequests.findIndex(N=>N.toPlayerId===t.current&&N.fromPlayerId===y);if(u===-1)return S;const b=He(S),T=b.revealRequests[u];if(O){const{cardIdentifiers:N}=T;for(const w of N){let R=null;if(w.source==="board"&&w.boardCoords)R=b.board[w.boardCoords.row][w.boardCoords.col].card;else if(w.source==="hand"&&w.ownerId&&w.cardIndex!==void 0){const A=b.players.find(P=>P.id===w.ownerId);A&&(R=A.hand[w.cardIndex])}R&&(R.statuses||(R.statuses=[]),R.statuses.some(A=>A.type==="Revealed"&&A.addedByPlayerId===y)||R.statuses.push({type:"Revealed",addedByPlayerId:y}))}}return b.revealRequests.splice(u,1),b})},[n,t]),I=$.useCallback(y=>{n(O=>{const S=He(O);let u=null;if(y.source==="board"&&y.boardCoords)u=S.board[y.boardCoords.row][y.boardCoords.col].card;else if(y.source==="hand"&&y.playerId&&y.cardIndex!==void 0){const b=S.players.find(T=>T.id===y.playerId);b&&(u=b.hand[y.cardIndex])}return u&&(u.statuses&&(u.statuses=u.statuses.filter(b=>b.type!=="Revealed")),delete u.revealedTo),S})},[n]);return{addBoardCardStatus:r,removeBoardCardStatus:a,removeBoardCardStatusByOwner:o,modifyBoardCardPower:i,addAnnouncedCardStatus:l,removeAnnouncedCardStatus:c,modifyAnnouncedCardPower:m,addHandCardStatus:E,removeHandCardStatus:k,revealHandCard:p,revealBoardCard:D,requestCardReveal:v,respondToRevealRequest:C,removeRevealedStatus:I}}function ns(e){const{webrtcIsHostRef:t,sendWebrtcAction:n,webrtcManagerRef:r,localPlayerIdRef:a,getCardDefinition:o,commandCardIds:i,createDeck:l,updateState:c}=e,m=$.useCallback((C,I)=>{const y=Qe();if(y&&!t.current)try{localStorage.setItem("webrtc_preferred_deck",I),d.info(`[changePlayerDeck] Saved deck preference: ${I}`)}catch(u){d.warn("[changePlayerDeck] Failed to save deck preference:",u)}const O=l(I,C,"Player "+C);if(c(u=>u.isGameStarted?u:{...u,players:u.players.map(b=>b.id===C?{...b,deck:O,selectedDeck:I,hand:[],discard:[],announcedCard:null,boardHistory:[]}:b)}),d.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${y}, isHost=${t.current}, hasSendAction=${!!n}, hasManager=${!!(r!=null&&r.current)}`),!y)return;const S=O.map(u=>({id:u.id,baseId:u.baseId,power:u.power,powerModifier:u.powerModifier||0,isFaceDown:u.isFaceDown||!1,statuses:u.statuses||[]}));t.current?r!=null&&r.current?(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:C,deckType:I,deck:S,deckSize:S.length}}),d.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${C}, deck ${I}, ${S.length} cards`)):d.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available"):n?(n("CHANGE_PLAYER_DECK",{playerId:C,deckType:I,deck:S,deckSize:S.length}),d.info(`[changePlayerDeck] Guest sending deck data to host: player ${C}, deck ${I}, ${S.length} cards`)):d.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[c,l,n,t,r,a]),E=$.useCallback((C,I)=>{const y=Qe();let O=[];const S=new Map;for(const{cardId:b,quantity:T}of I.cards){const N=o(b);if(!N)continue;const w=i.has(b),R=w?qe.Command:qe.Custom,A=w?"CMD":"CUS";for(let P=0;P<T;P++){const z=(S.get(b)||0)+1;S.set(b,z),O.push({...N,id:`${A}_${b.toUpperCase()}_${z}`,baseId:b,deck:R,ownerId:C,ownerName:"Player "+C})}}if(O=vr(O),c(b=>b.isGameStarted||!b.players.find(N=>N.id===C)?b:{...b,players:b.players.map(N=>N.id===C?{...N,deck:O,selectedDeck:qe.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:N)}),!y)return;const u=O.map(b=>({id:b.id,baseId:b.baseId,power:b.power,powerModifier:b.powerModifier||0,isFaceDown:b.isFaceDown||!1,statuses:b.statuses||[]}));t.current?r!=null&&r.current&&(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:C,deckType:qe.Custom,deck:u,deckSize:u.length}}),d.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${C}, ${u.length} cards`)):n&&(n("CHANGE_PLAYER_DECK",{playerId:C,deckType:qe.Custom,deck:u,deckSize:u.length}),d.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${C}, ${u.length} cards`))},[c,o,i,n,t,r,a]),k=$.useCallback((C,I,y,O)=>{c(S=>{if(!S.isGameStarted||S.board[y.row][y.col].card!==null)return S;const u=He(S),b=u.players.find(T=>T.id===C);if(b&&b.discard.length>I){const[T]=b.discard.splice(I,1);T.enteredThisTurn=!0,Dr(T,C),(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius"))&&(T.powerModifier===void 0&&(T.powerModifier=0),T.powerModifier+=2),T.statuses||(T.statuses=[]),T.statuses.push({type:"Resurrected",addedByPlayerId:C}),O&&O.forEach(N=>{var w;N.type!=="Resurrected"&&((w=T.statuses)==null||w.push({type:N.type,addedByPlayerId:C}))}),b.boardHistory||(b.boardHistory=[]),b.boardHistory.push(T.id),u.board[y.row][y.col].card=T,ea(u.board,b),u.board=at(u)}return u})},[c]),p=$.useCallback((C,I)=>{c(y=>{const O=He(y),S=O.players.find(u=>u.id===C);if(S&&I.length>0){const u=new Set(I.map(T=>T.id)),b=S.deck.filter(T=>!u.has(T.id));S.deck=[...I,...b]}return O})},[c]),D=$.useCallback((C,I,y)=>{c(O=>{const S=He(O),u=S.players.find(b=>b.id===C);return u&&(y==="deck"?u.deck=I:y==="discard"&&(u.discard=I)),S})},[c]),v=$.useCallback((C,I)=>{c(y=>{if(!y.isGameStarted)return y;const O=He(y),S=O.players.find(u=>u.id===C);if(S&&S.discard.length>I){const[u]=S.discard.splice(I,1);S.hand.push(u)}return O})},[c]);return{changePlayerDeck:m,loadCustomDeck:E,resurrectDiscardedCard:k,reorderTopDeck:p,reorderCards:D,recoverDiscardedCard:v}}function as(e){const{ws:t,webrtcManagerRef:n,webrtcIsHostRef:r,gameStateRef:a,scoreDeltaAccumulator:o,setGameState:i,updateState:l,abilityMode:c,setAbilityMode:m,createDeck:E}=e,k=$.useCallback(S=>{Qe()&&n.current?r.current?i(b=>{const T=Qn(b,S);return n.current&&n.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:n.current.getPeerId(),data:{activePlayerId:T.activePlayerId,currentPhase:T.currentPhase,turnNumber:T.turnNumber},timestamp:Date.now()}),T}):n.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:S},timestamp:Date.now()}):t.current&&t.current.readyState===WebSocket.OPEN&&(o.forEach((b,T)=>{clearTimeout(b.timerId),d.info(`[ScoreFlush] Flushing on toggle: player=${T}, delta=${b.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:a.current.gameId,playerId:T,delta:b.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:a.current.gameId,playerId:S})))},[t,n,r,a,o,i]),p=$.useCallback((S,u)=>{t.current&&t.current.readyState===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:a.current.gameId,playerId:S,enabled:u}))},[]),D=$.useCallback(S=>{const u=c&&m&&c.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(c.mode);u&&m(null),l(b=>{if(!b.isGameStarted)return b;const T=Math.max(1,Math.min(S,4));return{...b,currentPhase:T,...T===4&&!u?{isScoringStep:!0}:{},...u?{isScoringStep:!1}:{}}})},[l,c,m]),v=$.useCallback(()=>{var b;c&&m&&c.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(c.mode)&&m(null);const S=a.current,u=Qe();if(S.isGameStarted&&S.currentPhase===4&&S.isScoringStep&&!u){((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&(o.forEach((T,N)=>{clearTimeout(T.timerId),d.info(`[ScoreFlush] Flushing pending score: player=${N}, delta=${T.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:S.gameId,playerId:N,delta:T.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:S.gameId})));return}if(u&&S.isGameStarted&&S.currentPhase===4&&S.isScoringStep){l(T=>nr(T));return}l(T=>{if(!T.isGameStarted)return T;const N=He(T),w=T.currentPhase+1;return T.preserveDeployAbilities||N.board.forEach(R=>{R.forEach(A=>{var P;(P=A.card)!=null&&P.statuses&&(A.card.statuses=A.card.statuses.filter(z=>z.type!=="readyDeploy"))})}),u&&w===4&&T.currentPhase===3?Bo(T,T.activePlayerId)?(N.isScoringStep=!0,N.currentPhase=4,N):(d.info(`[nextPhase] Player ${T.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),nr(T)):w===4&&T.currentPhase===3?(N.isScoringStep=!0,N.currentPhase=4,N):(N.board.forEach(R=>{R.forEach(A=>{var P;if((P=A.card)!=null&&P.statuses){const z=A.card.statuses.findIndex(J=>J.type==="Resurrected");if(z!==-1){const J=A.card.statuses[z].addedByPlayerId;A.card.statuses.splice(z,1),A.card.baseId!=="luciusTheImmortal"&&(A.card.statuses.push({type:"Stun",addedByPlayerId:J}),A.card.statuses.push({type:"Stun",addedByPlayerId:J}))}}})}),N.board=at(N),N.currentPhase=w,N)})},[l,c,m,a,t,o]),C=$.useCallback(()=>{l(S=>S.isGameStarted?(c&&m&&c.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(c.mode)&&m(null),S.isScoringStep?{...S,isScoringStep:!1,currentPhase:Math.max(1,S.currentPhase-1)}:{...S,currentPhase:Math.max(1,S.currentPhase-1)}):S)},[l,c,m]),I=$.useCallback(()=>{var u;Qe()?l(b=>({...b,isRoundEndModalOpen:!1,currentRound:(b.currentRound||1)+1,players:b.players.map(T=>({...T,score:0}))})):((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&a.current.gameId&&(i(b=>({...b,isRoundEndModalOpen:!1,currentRound:(b.currentRound||1)+1,players:b.players.map(T=>({...T,score:0}))})),t.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:a.current.gameId})))},[i,l,t,a]),y=$.useCallback(()=>{i(S=>({...S,isRoundEndModalOpen:!1}))},[i]),O=$.useCallback(()=>{var u;if(Qe()){const b=a.current,T=b.players.map(A=>{const P=A.selectedDeck||"SynchroTech";return{...A,hand:[],deck:E(P,A.id,A.name),discard:[],score:0,isReady:!1,announcedCard:null,boardHistory:[]}}),N=b.activeGridSize||8,w=[];for(let A=0;A<N;A++){const P=[];for(let z=0;z<N;z++)P.push({card:null});w.push(P)}const R={...b,players:T,board:w,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};i(R),a.current=R,n.current&&n.current.broadcastToGuests({type:"GAME_RESET",senderId:n.current.getPeerId(),data:{players:T.map(A=>({id:A.id,name:A.name,color:A.color,selectedDeck:A.selectedDeck,isDummy:A.isDummy,isDisconnected:A.isDisconnected,autoDrawEnabled:A.autoDrawEnabled,handSize:A.hand.length,deckSize:A.deck.length,discardSize:A.discard.length,...A.isDummy&&{hand:A.hand.map(P=>({id:P.id,baseId:P.baseId,name:P.name,imageUrl:P.imageUrl,power:P.power,powerModifier:P.powerModifier,ability:P.ability,ownerId:P.ownerId,color:P.color,deck:P.deck,isFaceDown:P.isFaceDown,types:P.types,faction:P.faction,statuses:P.statuses})),deck:A.deck.map(P=>({id:P.id,baseId:P.baseId,name:P.name,imageUrl:P.imageUrl,power:P.power,powerModifier:P.powerModifier,ability:P.ability,ownerId:P.ownerId,color:P.color,deck:P.deck,isFaceDown:P.isFaceDown,types:P.types,faction:P.faction,statuses:P.statuses})),discard:A.discard.map(P=>({id:P.id,baseId:P.baseId,name:P.name,imageUrl:P.imageUrl,power:P.power,powerModifier:P.powerModifier,ability:P.ability,ownerId:P.ownerId,color:P.color,deck:P.deck,isFaceDown:P.isFaceDown,types:P.types,faction:P.faction,statuses:P.statuses}))},score:A.score,isReady:A.isReady,announcedCard:A.announcedCard})),gameMode:R.gameMode,isPrivate:R.isPrivate,activeGridSize:R.activeGridSize,dummyPlayerCount:R.dummyPlayerCount,autoAbilitiesEnabled:R.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"RESET_GAME",gameId:a.current.gameId}))},[t,n,a,i,E]);return{toggleActivePlayer:k,toggleAutoDraw:p,setPhase:D,nextPhase:v,prevPhase:C,closeRoundEndModal:I,closeRoundEndModalOnly:y,resetGame:O}}function os(e){const{ws:t,gameStateRef:n,updateState:r,updatePlayerScore:a,triggerFloatingText:o}=e,i=$.useCallback((c,m,E,k,p)=>{var N,w;const D=n.current;if(!D.isGameStarted||D.isRoundEndModalOpen)return;const v=D.board.some(R=>R.some(A=>{var P,z;return((P=A.card)==null?void 0:P.ownerId)===p&&A.card.name.toLowerCase().includes("data liberator")&&((z=A.card.statuses)==null?void 0:z.some(J=>J.type==="Support"))})),C=D.board.length;let I=c,y=c,O=m,S=m;if(c===E)I=c,y=c,O=0,S=C-1;else if(m===k)O=m,S=m,I=0,y=C-1;else return;let u=0;const b=[];for(let R=I;R<=y;R++)for(let A=O;A<=S;A++){const z=D.board[R][A].card;if(z&&!((N=z.statuses)!=null&&N.some(J=>J.type==="Stun"))){const J=z.ownerId===p,ne=(w=z.statuses)==null?void 0:w.some(re=>re.type==="Exploit"&&re.addedByPlayerId===p);if(J||v&&ne&&z.ownerId!==p){const re=Math.max(0,z.power+(z.powerModifier||0)+(z.bonusPower||0));re>0&&(u+=re,b.push({row:R,col:A,text:`+${re}`,playerId:p}))}}}b.length>0&&o(b);const T=Qe();T?r(R=>({...R,players:R.players.map(A=>A.id===p?{...A,score:Math.max(0,(A.score||0)+u)}:A)})):a(p,u),T||a(p,u),u>0&&D.currentPhase===4&&D.activePlayerId===p&&setTimeout(()=>{var R;T?r(A=>nr(A)):((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:D.gameId}))},100)},[o,a,r,t,n]),l=$.useCallback((c,m,E,k,p,D)=>{var T,N;const v=n.current;if(!v.isGameStarted||v.isRoundEndModalOpen)return;const C=E>c?1:-1,I=k>m?1:-1,y=Math.abs(c-E);let O=0,S=0;const u=[];for(let w=0;w<=y;w++){const R=c+w*C,A=m+w*I;if(R<0||R>=v.board.length||A<0||A>=v.board.length)continue;const z=v.board[R][A].card;if(z&&!((T=z.statuses)!=null&&T.some(J=>J.type==="Stun"))&&z.ownerId===p){const ne=Math.max(0,z.power+(z.powerModifier||0)+(z.bonusPower||0));ne>0&&(O+=ne,u.push({row:R,col:A,text:`+${ne}`,playerId:p})),D&&((N=z.statuses)!=null&&N.some(re=>re.type==="Support"&&re.addedByPlayerId===p))&&(S+=1)}}D==="point_per_support"&&S>0&&(O+=S),u.length>0&&o(u);const b=Qe();b?r(w=>({...w,players:w.players.map(R=>R.id===p?{...R,score:Math.max(0,(R.score||0)+O)}:R)})):a(p,O),b||a(p,O),D==="draw_per_support"&&S>0&&r(w=>{const R=He(w),A=R.players.find(P=>P.id===p);if(A&&A.deck.length>0)for(let P=0;P<S;P++)A.deck.length>0&&A.hand.push(A.deck.shift());return R}),O>0&&v.currentPhase===4&&v.activePlayerId===p&&setTimeout(()=>{var w;b?r(R=>nr(R)):((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:v.gameId}))},500)},[o,a,r,t,n]);return{scoreLine:i,scoreDiagonal:l}}const ss=e=>{const{updateState:t,rawJsonData:n}=e,r=$.useCallback((k,p,D,v)=>{t(C=>{if(!C.isGameStarted)return C;const I=He(C),y=I.board[k.row][k.col].card;if(y){const O=y.statuses?y.statuses.map(S=>S.type):[];if(v&&y.statuses){y.statuses=y.statuses.filter(u=>u.type!==v);const S=y.statuses.map(u=>u.type);d.debug(`[markAbilityUsed] Removed status '${v}' from ${y.name} at [${k.row},${k.col}]: [${O.join(", ")}] -> [${S.join(", ")}]`)}else d.debug(`[markAbilityUsed] Called for ${y.name} at [${k.row},${k.col}] but no readyStatusToRemove specified. Current statuses: [${O.join(", ")}]`)}return I})},[t]),a=$.useCallback(k=>{t(p=>{if(!p.isGameStarted)return p;const D=He(p),v=D.board[k.row][k.col].card;if(v&&(v.statuses||(v.statuses=[]),(v.ability||"").toLowerCase().includes("deploy:")&&!v.statuses.some(I=>I.type==="readyDeploy"))){const I=v.ownerId;if(I==null||I===0)return p;v.statuses.push({type:"readyDeploy",addedByPlayerId:I})}return D})},[t]),o=$.useCallback((k,p)=>{t(D=>{if(!D.isGameStarted)return D;const v=He(D),C=v.board[k.row][k.col].card;return C!=null&&C.statuses&&(C.statuses=C.statuses.filter(I=>I.type!==p)),v.board=at(v),v})},[t]),i=$.useCallback((k,p,D,v,C)=>{t(I=>{if(!I.isGameStarted)return I;const y=He(I);return p.forEach(({row:O,col:S})=>{var b;const u=y.board[O][S].card;if(u){if(D==="Stun"&&(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius")&&((b=u.types)!=null&&b.includes("Hero"))))return;u.statuses||(u.statuses=[]),["Support","Threat","Revealed"].includes(D)?u.statuses.some(N=>N.type===D&&N.addedByPlayerId===v)||u.statuses.push({type:D,addedByPlayerId:v}):u.statuses.push({type:D,addedByPlayerId:v})}}),y})},[t]),l=$.useCallback((k,p)=>{t(D=>{if(!D.isGameStarted)return D;const v=He(D),C=v.board[k.row][k.col].card,I=v.board[p.row][p.col].card;return v.board[k.row][k.col].card=I,v.board[p.row][p.col].card=C,v.board=at(v),v})},[t]),c=$.useCallback((k,p,D)=>{t(v=>{if(!v.isGameStarted)return v;const C=He(v),I=C.board[k.row][k.col].card,y=C.board[p.row][p.col].card;if(I&&y&&I.statuses){const O=I.statuses.findIndex(S=>S.type===D);if(O>-1){const[S]=I.statuses.splice(O,1);y.statuses||(y.statuses=[]),y.statuses.push(S)}}return C.board=at(C),C})},[t]),m=$.useCallback((k,p)=>{t(D=>{if(!D.isGameStarted)return D;const v=He(D),C=v.board[k.row][k.col].card,I=v.board[p.row][p.col].card,y=["Support","Threat","LastPlayed"];if(C&&I&&C.statuses){const O=C.statuses.filter(u=>!y.includes(u.type)),S=C.statuses.filter(u=>y.includes(u.type));O.length>0&&(I.statuses||(I.statuses=[]),I.statuses.push(...O),C.statuses=S)}return v.board=at(v),v})},[t]),E=$.useCallback((k,p,D)=>{t(v=>{if(!v.isGameStarted)return v;const C=He(v);if(!n)return v;const I=n.tokenDatabase,y=Object.keys(I).find(u=>I[u].name===p);if(!y)return v;const O=I[y],S=C.players.find(u=>u.id===D);if(O&&C.board[k.row][k.col].card===null){const u={id:`TKN_${p.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:qe.Tokens,name:p,baseId:O.baseId||y,imageUrl:O.imageUrl,fallbackImage:O.fallbackImage,power:O.power,ability:O.ability,flavorText:O.flavorText,color:O.color,types:O.types||["Unit"],faction:"Tokens",ownerId:D,ownerName:S==null?void 0:S.name,enteredThisTurn:!0,statuses:[]};Dr(u,D),C.board[k.row][k.col].card=u}return C.board=at(C),C})},[t,n]);return{markAbilityUsed:r,applyGlobalEffect:i,swapCards:l,transferStatus:c,transferAllCounters:m,spawnToken:E,resetDeployStatus:a,removeStatusByType:o}};function is(e){const{updateState:t,localPlayerIdRef:n,updatePlayerScore:r}=e;return{moveItem:$.useCallback((o,i)=>{t(l=>{var v,C,I,y,O,S,u,b,T,N;if(!l.isGameStarted||i.target==="board"&&i.boardCoords&&l.board[i.boardCoords.row][i.boardCoords.col].card!==null&&o.source!=="counter_panel")return l;let c=!1;try{const w=localStorage.getItem("auto_abilities_enabled");c=w===null?!0:w==="true"}catch{c=!0}const m=c&&l.currentPhase===1&&o.source==="hand"&&i.target==="board"&&(((v=o.card.types)==null?void 0:v.includes("Unit"))||((C=o.card.types)==null?void 0:C.includes("Command"))),E=He(l);if(o.source==="board"&&["hand","deck","discard"].includes(i.target)&&!o.bypassOwnershipCheck){const w=o.card.ownerId,R=E.players.find(z=>z.id===w),A=w===n.current,P=!!(R!=null&&R.isDummy);if(!A&&!P)return l}let k=null;if(o.source==="board"&&i.target==="board"&&o.boardCoords){const w=E.board[o.boardCoords.row][o.boardCoords.col];w.card&&(k=w.card);const A=l.board[o.boardCoords.row][o.boardCoords.col].card||k;if(A&&((I=A.statuses)==null?void 0:I.some(z=>z.type==="Stun"))){const z=n.current,J=A.ownerId,ne=l.players.find(we=>we.id===z),re=l.players.find(we=>we.id===J),ye=z===J,he=(ne==null?void 0:ne.teamId)!==void 0&&(re==null?void 0:re.teamId)!==void 0&&ne.teamId===re.teamId;if((ye||he)&&!o.isManual)return l}}if(o.source==="counter_panel"&&o.statusType){const w=xt[o.statusType];if(!((w==null?void 0:w.allowedTargets)??["board","hand"]).includes(i.target))return l;let A=null;if(i.target==="board"&&i.boardCoords)A=E.board[i.boardCoords.row][i.boardCoords.col].card;else if(i.playerId!==void 0){const P=E.players.find(z=>z.id===i.playerId);P&&(i.target==="hand"&&i.cardIndex!==void 0&&(A=P.hand[i.cardIndex]),i.target==="announced"&&(A=P.announcedCard||null),i.target==="deck"&&P.deck.length>0?i.deckPosition==="top"||!i.deckPosition?A=P.deck[0]:A=P.deck[P.deck.length-1]:i.target==="discard"&&P.discard.length>0&&(A=P.discard[P.discard.length-1]))}if(A){if(o.statusType==="Stun"&&(A.baseId==="luciusTheImmortal"||A.name.includes("Lucius")&&((y=A.types)!=null&&y.includes("Hero"))))return E;const P=o.count||1;let z;if(o.ownerId!==void 0)z=o.ownerId;else if(o.card.ownerId!==void 0)z=o.card.ownerId;else{const J=E.players.find(ne=>ne.id===E.activePlayerId);z=J!=null&&J.isDummy?J.id:n.current!==null?n.current:0}if(o.statusType==="Power+")A.powerModifier===void 0&&(A.powerModifier=0),A.powerModifier+=1*P;else if(o.statusType==="Power-")A.powerModifier===void 0&&(A.powerModifier=0),A.powerModifier-=1*P;else if(A.statuses||(A.statuses=[]),o.replaceStatusType&&o.statusType)for(let J=0;J<P;J++){const ne=A.statuses.findIndex(re=>re.type===o.replaceStatusType&&re.addedByPlayerId===z);ne!==-1?A.statuses[ne]={type:o.statusType,addedByPlayerId:z}:A.statuses.push({type:o.statusType,addedByPlayerId:z})}else for(let J=0;J<P;J++)["Support","Threat","Revealed"].includes(o.statusType)?A.statuses.some(re=>re.type===o.statusType&&re.addedByPlayerId===z)||A.statuses.push({type:o.statusType,addedByPlayerId:z}):A.statuses.push({type:o.statusType,addedByPlayerId:z});return i.target==="board"&&(E.board=at(E)),E}return l}const p=k?{...k}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const w=E.players.find(R=>R.id===o.playerId);if(w){const R=w.hand[o.cardIndex];if(R&&R.id===o.card.id&&R.ownerId===o.card.ownerId)w.hand.splice(o.cardIndex,1);else{const A=w.hand.findIndex(P=>P.id===o.card.id&&P.ownerId===o.card.ownerId);if(A!==-1)w.hand.splice(A,1);else return l}}}else if(o.source==="board"&&o.boardCoords){const w=E.board[o.boardCoords.row][o.boardCoords.col];if(w.card&&w.card.id===o.card.id&&w.card.ownerId===o.card.ownerId)E.board[o.boardCoords.row][o.boardCoords.col].card=null;else return l}else if(o.source==="discard"&&o.playerId!==void 0){const w=E.players.find(R=>R.id===o.playerId);if(w){let R=!1;if(o.cardIndex!==void 0){const A=w.discard[o.cardIndex];A&&A.id===o.card.id&&A.ownerId===o.card.ownerId&&(w.discard.splice(o.cardIndex,1),R=!0)}if(!R){const A=w.discard.findIndex(P=>P.id===o.card.id&&P.ownerId===o.card.ownerId);if(A!==-1)w.discard.splice(A,1);else return l}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const w=E.players.find(R=>R.id===o.playerId);if(w){const R=w.deck[o.cardIndex];if(R&&R.id===o.card.id&&R.ownerId===o.card.ownerId)w.deck.splice(o.cardIndex,1);else{const A=w.deck.findIndex(P=>P.id===o.card.id&&P.ownerId===o.card.ownerId);if(A!==-1)w.deck.splice(A,1);else return l}}}else if(o.source==="announced"&&o.playerId!==void 0){const w=E.players.find(R=>R.id===o.playerId);if(w)if(w.announcedCard&&w.announcedCard.id===o.card.id)w.announcedCard=null;else return l}if(["hand","deck","discard"].includes(i.target))p.statuses&&(p.statuses=p.statuses.filter(w=>w.type==="Revealed")),p.isFaceDown=!1,delete p.powerModifier,delete p.bonusPower,delete p.enteredThisTurn;else if(i.target==="board"&&(p.statuses||(p.statuses=[]),o.source!=="board"&&p.isFaceDown===void 0&&(p.isFaceDown=!1),o.source!=="board")){p.enteredThisTurn=!0;let w=p.ownerId;w===void 0&&(o.source==="token_panel"?w=E.activePlayerId??n.current??0:o.playerId!==void 0?w=o.playerId:w=n.current??0,p.ownerId=w),Dr(p,w),o.source==="discard"&&(p.baseId==="luciusTheImmortal"||p.name.includes("Lucius"))&&(p.powerModifier===void 0&&(p.powerModifier=0),p.powerModifier+=2)}if(i.target==="hand"&&i.playerId!==void 0){if((p.deck===qe.Tokens||p.deck==="counter")&&(((O=p.types)==null?void 0:O.includes("Token"))||((S=p.types)==null?void 0:S.includes("Token Unit"))))return l;ur(p);const R=E.players.find(P=>P.id===i.playerId);if(!R)return l;let A=i.cardIndex!==void 0?i.cardIndex:R.hand.length;if(o.source==="hand"&&o.playerId===i.playerId&&o.cardIndex!==void 0&&(o.cardIndex<A&&(A-=1),o.cardIndex===A))return l;R.hand.splice(A,0,p)}else if(i.target==="board"&&i.boardCoords){if(E.board[i.boardCoords.row][i.boardCoords.col].card===null){if(p.ownerId===void 0&&n.current!==null){const w=E.players.find(R=>R.id===n.current);w&&(p.ownerId=w.id,p.ownerName=w.name)}if(o.source!=="board"&&p.ownerId!==void 0){const w=E.players.find(R=>R.id===p.ownerId);w&&(w.boardHistory||(w.boardHistory=[]),w.boardHistory.push(p.id))}E.board[i.boardCoords.row][i.boardCoords.col].card=p}}else if(i.target==="discard"&&i.playerId!==void 0){if(!(p.deck===qe.Tokens||p.deck==="counter")){ur(p),p.statuses&&(p.statuses=p.statuses.filter(R=>R.type!=="Revealed"));const w=E.players.find(R=>R.id===i.playerId);w&&(p.ownerId===void 0&&(p.ownerId=i.playerId,p.ownerName=w.name),w.discard.some(A=>A.id===p.id)||w.discard.push(p))}}else if(i.target==="deck"&&i.playerId!==void 0){if((p.deck===qe.Tokens||p.deck==="counter")&&(((u=p.types)==null?void 0:u.includes("Token"))||((b=p.types)==null?void 0:b.includes("Token Unit"))))return l;ur(p),p.statuses&&(p.statuses=p.statuses.filter(A=>A.type!=="Revealed"));const R=E.players.find(A=>A.id===i.playerId);if(!R)return l;p.ownerId===void 0&&(p.ownerId=i.playerId,p.ownerName=R.name),i.deckPosition==="top"||!i.deckPosition?R.deck.unshift(p):R.deck.push(p)}else if(i.target==="announced"&&i.playerId!==void 0){const w=E.players.find(R=>R.id===i.playerId);w&&(w.announcedCard&&(w.announcedCard.statuses&&(w.announcedCard.statuses=w.announcedCard.statuses.filter(R=>R.type==="Revealed")),delete w.announcedCard.enteredThisTurn,delete w.announcedCard.powerModifier,delete w.announcedCard.bonusPower,w.hand.push(w.announcedCard)),w.announcedCard=p)}if(o.source==="board"&&i.target!=="board"&&p.ownerId!==void 0){const w=E.players.find(R=>R.id===p.ownerId);w&&(w.boardHistory||(w.boardHistory=[]),w.boardHistory=w.boardHistory.filter(R=>R!==p.id))}if((o.source==="board"||i.target==="board")&&p.ownerId!==void 0){const w=E.players.find(R=>R.id===p.ownerId);w&&ea(E.board,w)}if(o.source==="hand"&&i.target==="board"){const w=p;if(w.revealedTo==="all"||((T=w.statuses)==null?void 0:T.some(A=>A.type==="Revealed"))){const A=E.board.length;for(let P=0;P<A;P++)for(let z=0;z<A;z++){const J=E.board[P][z].card;if(J&&J.name.toLowerCase().includes("vigilant spotter")&&J.ownerId!==w.ownerId&&(E.board=at(E),(N=E.board[P][z].card.statuses)!=null&&N.some(re=>re.type==="Support"))){const re=E.players.find(ye=>ye.id===J.ownerId);re&&setTimeout(()=>{r(re.id,2)},0)}}}}return(o.source==="board"||i.target==="board")&&(E.board=at(E)),m&&(E.currentPhase=2),E})},[t,n,r])}}function ds(e){const{ws:t,webrtcManager:n,gameStateRef:r,webrtcIsHostRef:a,setGameState:o}=e,i=$.useCallback((c,m,E,k,p)=>{var O,S,u,b,T,N,w;const D=r.current;let v=[];k?v=k:v=or(c,D,m,p);const C=[],I=c.mode==="SELECT_DECK";if((O=c.payload)!=null&&O.filter&&c.mode==="SELECT_TARGET"){const R=((S=c.sourceCard)==null?void 0:S.ownerId)||c.originalOwnerId||m,A=D.players.find(P=>P.id===R);A&&A.hand&&A.hand.forEach((P,z)=>{try{c.payload.filter(P)&&C.push({playerId:A.id,cardIndex:z})}catch{}})}const y={playerId:m,action:c,sourceCoords:E,timestamp:Date.now(),boardTargets:v,handTargets:C.length>0?C:void 0,isDeckSelectable:I||void 0,originalOwnerId:c.originalOwnerId};o(R=>({...R,targetingMode:y})),r.current.targetingMode=y,((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&D.gameId&&t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:D.gameId,targetingMode:y})),n.current&&(a.current?n.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((T=(b=n.current).getPeerId)==null?void 0:T.call(b))??void 0,data:{targetingMode:y},timestamp:Date.now()}):n.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((w=(N=n.current).getPeerId)==null?void 0:w.call(N))??void 0,data:{targetingMode:y},timestamp:Date.now()})),d.info(`[TargetingMode] Player ${m} activated targeting mode`,{mode:c.mode,boardTargetsCount:v.length})},[t,n,r,a,o]),l=$.useCallback(()=>{var m,E,k,p,D;const c=r.current;o(v=>({...v,targetingMode:null})),r.current.targetingMode=null,((m=t.current)==null?void 0:m.readyState)===WebSocket.OPEN&&c.gameId&&t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:c.gameId})),n.current&&(a.current?n.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((k=(E=n.current).getPeerId)==null?void 0:k.call(E))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):n.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((D=(p=n.current).getPeerId)==null?void 0:D.call(p))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[t,n,r,a,o]);return{setTargetingMode:i,clearTargetingMode:l}}function cs(e){const{webrtcManagerRef:t,webrtcIsHostRef:n,setWebrtcIsHost:r,setConnectionStatus:a,setWebrtcHostId:o,gameStateRef:i,localPlayerIdRef:l}=e,c=$.useCallback(async()=>{var D;if(!t.current)return d.error("WebRTC manager not initialized"),null;try{r(!0),a("Connecting");const v=await t.current.initializeAsHost();o(v),a("Connected");const C=i.current.gameId;C&&br(v,C);const I=(D=i.current.players)==null?void 0:D.find(y=>y.id===l.current);return wo({peerId:v,isHost:!0,playerName:(I==null?void 0:I.name)||null}),d.info("[initializeWebrtcHost] Saved host data for auto-restore"),v}catch(v){return d.error("Failed to initialize WebRTC host:",v),a("Disconnected"),null}},[t,r,a,o,i,l]),m=$.useCallback(async D=>{if(!t.current)return d.error("WebRTC manager not initialized"),!1;try{return r(!1),o(D),a("Connecting"),await t.current.initializeAsGuest(D),!0}catch(v){return d.error("Failed to connect as guest:",v),a("Disconnected"),!1}},[t,r,a,o]),E=$.useCallback((D,v)=>t.current?n.current?(d.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):t.current.sendAction(D,v):(d.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[t,n]),k=$.useCallback(D=>{var C,I;if(!t.current||n.current)return d.warn("[requestDeckView] Only guests can request deck view from host"),!1;const v={type:"REQUEST_DECK_VIEW",senderId:t.current.getPeerId(),playerId:n.current||(I=(C=t.current).getLocalPlayerId)==null?void 0:I.call(C),data:{targetPlayerId:D},timestamp:Date.now()};return t.current.sendMessageToHost(v)},[t,n]),p=$.useCallback((D,v,C)=>!t.current||n.current?(d.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):t.current.sendFullDeckToHost(D,v,C),[t,n]);return{initializeWebrtcHost:c,connectAsGuest:m,sendWebrtcAction:E,requestDeckView:k,sendFullDeckToHost:p}}function ls(e){const{ws:t,gameStateRef:n,localPlayerIdRef:r,isRestoringSessionRef:a,isManualExitRef:o,webrtcIsHostRef:i,receivedServerStateRef:l,joiningGameIdRef:c,setGameState:m,setLocalPlayerId:E,connectWebSocket:k,updateState:p}=e,D=$.useCallback(()=>{t.current&&(t.current.readyState===WebSocket.OPEN||t.current.readyState===WebSocket.CONNECTING)?t.current.close():k()},[t,k]),v=$.useCallback(O=>{var S;if(o.current=!1,((S=t.current)==null?void 0:S.readyState)===WebSocket.OPEN){c.current=O;let u=null;try{const T=localStorage.getItem(Dt);T&&(u=JSON.parse(T))}catch{Gt()}const b={type:"JOIN_GAME",gameId:O};(u==null?void 0:u.gameId)===O&&u.playerToken?(b.playerToken=u.playerToken,d.info(`JoinGame: Sending reconnection with token ${u.playerToken.substring(0,8)}... for player ${u.playerId}`)):d.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${u==null?void 0:u.gameId}, requestedGameId=${O}`),t.current.send(JSON.stringify(b))}else k(),c.current=O},[t,o,c,k]),C=$.useCallback(()=>{o.current=!1,Gt();const O=ta(),S={...St(),gameId:O,players:[ra(1)]};l.current=!0,p(S),setTimeout(()=>{var u;((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&(t.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:O})),t.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ht})))},Ae.DECK_SYNC_DELAY)},[p,o,l,t]),I=$.useCallback(()=>{var O;((O=t.current)==null?void 0:O.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[t]),y=$.useCallback(()=>{var u;if(a.current)return;o.current=!0;const O=n.current.gameId,S=r.current;O&&i.current&&go(O);try{Lt(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),d.info("[exitGame] Cleared WebRTC persistence data")}catch(b){d.warn("[exitGame] Failed to clear WebRTC data:",b)}m(St()),E(null),Gt(),t.current&&(t.current.onclose=null),((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&O&&S!==null&&t.current.send(JSON.stringify({type:"EXIT_GAME",gameId:O,playerId:S})),t.current&&t.current.close(),setTimeout(()=>{o.current=!1,k()},Ae.RECONNECT_DELAY)},[a,o,n,r,i,m,E,t,k]);return{createGame:C,requestGamesList:I,exitGame:y,forceReconnect:D,joinGame:v}}const _t=new Map,Ns=(e={})=>{const{abilityMode:t,setAbilityMode:n}=e,[r,a]=$.useState(St()),o=$.useRef(St()),i=$.useCallback(s=>{a(ie=>{const U=typeof s=="function"?s(ie):s;return o.current=ie,Qe()&&ae.current&&setTimeout(()=>{L.current&&(L.current.broadcastGameState(U),d.debug(`[setGameStateWithDelta] Broadcast state: phase=${U.currentPhase}, round=${U.currentRound}`))},0),U})},[]),[l,c]=$.useState(null),m=$.useRef(r),E=$.useRef(l),[k,p]=$.useState(null),[D,v]=$.useState("Connecting"),[C,I]=$.useState([]),[y,O]=$.useState(null),[S,u]=$.useState(null),[b,T]=$.useState(null),[N,w]=$.useState([]),[R,A]=$.useState([]),[P,z]=$.useState([]),[J,ne]=$.useState(null),[re,ye]=$.useState(!!ht),[he,we]=$.useState(!1),[Fe,Le]=$.useState(null),[Oe,ot]=$.useState(!1),ae=$.useRef(!1),[kt,Ze]=$.useState(!1),[bt,dt]=$.useState(null),yt=$.useRef(!1),Ce=$.useRef(null),tt=$.useRef(null),mt=$.useRef(null),f=$.useRef(!1),G=$.useRef(!1),Q=$.useRef(void 0),_e=$.useRef(!1),L=$.useRef(null),Ue=$.useRef(()=>{}),Be=cs({webrtcManagerRef:L,webrtcIsHostRef:ae,setWebrtcIsHost:ot,setConnectionStatus:v,setWebrtcHostId:Le,gameStateRef:m,localPlayerIdRef:E}),{initializeWebrtcHost:je,connectAsGuest:Ge,sendWebrtcAction:et,requestDeckView:ct,sendFullDeckToHost:lt}=Be;$.useEffect(()=>{Ue.current=i},[i]),$.useEffect(()=>{ae.current=Oe},[Oe]),$.useEffect(()=>{const s=Qe();if(we(s),s){L.current=Ho();const ie=L.current.on(U=>{Xe(U)});return()=>{ie()}}},[]),$.useEffect(()=>{if(!Qe())return;const ie=window.location.hash.slice(1);if(ie&&new URLSearchParams(ie).get("hostId"))return;const U="webrtc_auto_restore_attempted";if(sessionStorage.getItem(U))return;sessionStorage.setItem(U,"true");const Y=_o();if(Y==="none"){sessionStorage.removeItem(U);return}setTimeout(async()=>{var Z,ce;if(!L.current){d.warn("[Auto-restore] WebRTC manager not ready");return}try{if(Y==="host"){xe.current=!0,d.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ue=Bn(),ee=Nn();if(!ue||!ee){d.warn("[Auto-restore] Missing host data or state data"),Lt(),xe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}d.info(`[Auto-restore] Restoring host session: old peerId=${ue.peerId}`);const ke=await L.current.initializeAsHost();ae.current=!0,ot(!0),Le(ke),v("Connected"),(Z=ee.gameState)!=null&&Z.gameId&&(br(ke,ee.gameState.gameId),d.info(`[Auto-restore] Broadcasted NEW host peerId ${ke} for game ${ee.gameState.gameId}`)),(ee.gameState||ee.localPlayerId!==null)&&(ee.gameState&&(m.current=ee.gameState),ee.localPlayerId!==null&&(E.current=ee.localPlayerId),yt.current=!0,setTimeout(()=>{yt.current=!1},1e4),setTimeout(()=>{var We;ee.gameState&&(a(ee.gameState),d.info(`[Auto-restore] Restored game state with ${((We=ee.gameState.players)==null?void 0:We.length)||0} players, gameId=${ee.gameState.gameId}`)),ee.localPlayerId!==null&&(c(ee.localPlayerId),d.info(`[Auto-restore] Restored local player ID: ${ee.localPlayerId}`))},0)),setTimeout(()=>{if(xe.current=!1,d.info("[Auto-restore] Cleared restoration flag"),L.current&&ee.gameState){const We=ee.gameState.players.filter(rt=>!rt.isDummy&&rt.id!==ee.localPlayerId);We.length>0&&(d.info(`[Auto-restore] Requesting deck data from ${We.length} guest players`),L.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:L.current.getPeerId(),timestamp:Date.now()}))}},500),d.info("[Auto-restore] Host session restoration initiated")}else if(Y==="guest"){xe.current=!0,d.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ue=Yn(),ee=Nn();if(!ue||!ee){d.warn("[Auto-restore] Missing guest data or state data"),Lt(),xe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}d.info(`[Auto-restore] Restoring guest session: old hostPeerId=${ue.hostPeerId}, playerId=${ue.playerId}`),ae.current=!1,ot(!1),v("Connecting");let ke=ue.hostPeerId;if((ce=ee.gameState)!=null&&ce.gameId){const We=pr(ee.gameState.gameId);We&&We.peerId&&(ke=We.peerId,d.info(`[Auto-restore] Found NEW host peerId in localStorage: ${ke}`))}if(Le(ke),ue.playerId!==null){d.info(`[Auto-restore] Reconnecting as existing player ${ue.playerId} to host ${ke}`);try{await L.current.initializeAsReconnectingGuest(ke,ue.playerId),v("Connected"),d.info("[Auto-restore] Successfully reconnected to host")}catch(We){d.error("[Auto-restore] Failed to reconnect to host:",We),v("Disconnected"),Lt(),d.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),xe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else d.info("[Auto-restore] Connecting as new player"),await L.current.initializeAsGuest(ke),v("Connected");(ee.gameState||ee.localPlayerId!==null)&&(ee.gameState&&(m.current=ee.gameState),ee.localPlayerId!==null&&(E.current=ee.localPlayerId),yt.current=!0,setTimeout(()=>{yt.current=!1},1e4),setTimeout(()=>{var We,rt;if(ee.gameState&&(a(ee.gameState),d.info(`[Auto-restore] Restored game state with ${((We=ee.gameState.players)==null?void 0:We.length)||0} players, gameId=${ee.gameState.gameId}, isGameStarted=${ee.gameState.isGameStarted}`),ee.localPlayerId!==null)){const Se=(rt=ee.gameState.players)==null?void 0:rt.some(ve=>ve.id===ee.localPlayerId);d.info(`[Auto-restore] Player ${ee.localPlayerId} exists in restored state: ${Se}`)}ee.localPlayerId!==null&&(c(ee.localPlayerId),d.info(`[Auto-restore] Restored local player ID: ${ee.localPlayerId}`))},0)),setTimeout(()=>{xe.current=!1,d.info("[Auto-restore] Cleared restoration flag")},100),d.info("[Auto-restore] Guest session restoration initiated")}}catch(ue){d.error("[Auto-restore] Failed to restore session:",ue),Lt(),xe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),$.useEffect(()=>{if(!he||!L.current)return;const s=window.location.hash.slice(1);if(!s)return;const U=new URLSearchParams(s).get("hostId");U&&Ge(U)},[he]),$.useEffect(()=>{m.current=r},[r]),$.useEffect(()=>{E.current=l},[l]);const Ye=Xo({ws:Ce,webrtcManager:L,gameStateRef:m,localPlayerIdRef:E,webrtcIsHostRef:ae,setLatestHighlight:O,setLatestFloatingTexts:u,setLatestNoTarget:T,setLatestDeckSelections:w,setLatestHandCardSelections:A,setTargetSelectionEffects:z,setGameState:a}),xe=$.useRef(!1);$.useEffect(()=>{if(!he||!ae.current||!(r!=null&&r.gameId))return;const s=r.gameId,ie=()=>{var Z;const Y=(Z=L.current)==null?void 0:Z.getPeerId();Y&&s&&br(Y,s)};ie();const U=setInterval(ie,2e3);return()=>clearInterval(U)},[he,r==null?void 0:r.gameId]),$.useEffect(()=>{if(!he||ae.current||!(r!=null&&r.gameId))return;const s=r.gameId,ie=Z=>{var ce;Le(Z),v("Connecting"),(ce=L.current)==null||ce.initializeAsReconnectingGuest(Z,E.current||0).then(()=>{v("Connected")}).catch(ue=>{d.error("[Guest Auto-Reconnect] Failed to reconnect:",ue),v("Disconnected")})},U=Z=>{const ce=`webrtc_host_${s}`;if(!(Z.key!==ce||!Z.newValue))try{const ee=JSON.parse(Z.newValue).peerId;ee&&ee!==Fe&&ie(ee)}catch(ue){d.error("[Guest Auto-Reconnect] Failed to parse storage event:",ue)}},Y=setInterval(()=>{const Z=pr(s);Z&&Z.peerId!==Fe&&(d.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${Z.peerId}`),ie(Z.peerId))},2e3);return window.addEventListener("storage",U),()=>{window.removeEventListener("storage",U),clearInterval(Y)}},[he,r==null?void 0:r.gameId,Fe]),$.useEffect(()=>{const s=setInterval(()=>{a(ie=>{const U=Date.now(),Y=ie.floatingTexts||[],Z=Y.filter(ce=>U-ce.timestamp<Ae.FLOATING_TEXT_DURATION);return Z.length!==Y.length?{...ie,floatingTexts:Z}:ie})},Ae.DECK_SYNC_DELAY);return()=>clearInterval(s)},[]);const Xe=$.useCallback(s=>{var ie,U,Y;switch(s.type){case"peer_open":(ie=s.data)!=null&&ie.peerId&&(Le(s.data.peerId),d.info(`WebRTC peer opened with ID: ${s.data.peerId}`));break;case"guest_connected":d.info("Guest connected via WebRTC:",(U=s.data)==null?void 0:U.peerId);break;case"connected_to_host":(Y=s.data)!=null&&Y.hostPeerId&&Fe!==s.data.hostPeerId&&(Le(s.data.hostPeerId),d.info(`Updated webrtcHostId to: ${s.data.hostPeerId}`)),v("Connected"),Ze(!1),dt(null),yt.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(d.warn("WebRTC peer disconnected"),v("Disconnected"),Ze(!0),!ae.current&&Fe&&r)try{const Z={hostPeerId:Fe,playerId:l,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(Z)),d.info("[Reconnection] Stored reconnection data before disconnect"),V(Fe)}catch(Z){d.error("[Reconnection] Failed to store data:",Z)}break;case"message_received":F(s.data);break;case"error":d.error("WebRTC error:",s.data);break}},[r,l,Fe,Oe]),Ve=$.useCallback((s,ie)=>{if(d.info(`[handleWebrtcGuestJoin] Called for guest ${s}, isHost: ${ae.current}`),!ae.current||!L.current){d.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const U=(ie==null?void 0:ie.preferredDeck)||"Random";a(Y=>{if(!Y)return d.error("[handleWebrtcGuestJoin] No previous state"),Y;d.info(`[handleWebrtcGuestJoin] Current state has ${Y.players.length} players`);const Z=Y.players.map(Se=>Se.id);let ce=1;for(;Z.includes(ce);)ce++;const ue={id:ce,name:`Player ${ce}`,color:rr[Z.length%rr.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:U,boardHistory:[],autoDrawEnabled:!0},ee={...Y,players:[...Y.players,ue]},ke=Y.board.map(Se=>Se.map(ve=>({...ve,card:ve.card?{id:ve.card.id,baseId:ve.card.baseId,ownerId:ve.card.ownerId,name:ve.card.name,imageUrl:ve.card.imageUrl,power:ve.card.power,ability:ve.card.ability,isFaceDown:ve.card.isFaceDown,statuses:ve.card.statuses||[]}:null}))),We=Se=>Se.map(ve=>({id:ve.id,baseId:ve.baseId,name:ve.name,imageUrl:ve.imageUrl,power:ve.power,powerModifier:ve.powerModifier,ability:ve.ability,ownerId:ve.ownerId,color:ve.color,deck:ve.deck,isFaceDown:ve.isFaceDown,types:ve.types,faction:ve.faction,statuses:ve.statuses}));L.current.acceptGuestMinimal(s,{playerId:ce,gameId:Y.gameId,isGameStarted:Y.isGameStarted,players:ee.players.map(Se=>Se.isDummy?{id:Se.id,name:Se.name,color:Se.color,isDummy:Se.isDummy,isReady:Se.isReady,score:Se.score,selectedDeck:Se.selectedDeck,hand:We(Se.hand||[]),deck:We(Se.deck||[]),discard:We(Se.discard||[]),handSize:Se.hand.length,deckSize:Se.deck.length,discardSize:Se.discard.length}:{id:Se.id,name:Se.name,color:Se.color,isDummy:Se.isDummy,isReady:Se.isReady,score:Se.score,selectedDeck:Se.selectedDeck,deckSize:Se.deck.length,handSize:Se.hand.length,discardSize:Se.discard.length}),deckSelections:ee.players.map(Se=>({id:Se.id,selectedDeck:Se.selectedDeck})),gameMode:Y.gameMode,currentRound:Y.currentRound,currentPhase:Y.currentPhase,activePlayerId:Y.activePlayerId,startingPlayerId:Y.startingPlayerId,activeGridSize:Y.activeGridSize,board:ke},ce),L.current.broadcastGameState(ee,s),L.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:L.current.getPeerId(),data:{playerId:ce,selectedDeck:U},timestamp:Date.now()});const rt=ee.players.find(Se=>Se.id===E.current);if(rt&&rt.deck.length>0){const Se=rt.deck.map(ve=>({id:ve.id,baseId:ve.baseId,power:ve.power,powerModifier:ve.powerModifier||0,isFaceDown:ve.isFaceDown||!1,statuses:ve.statuses||[]}));L.current.sendToGuest(s,{type:"CHANGE_PLAYER_DECK",senderId:L.current.getPeerId(),playerId:rt.id,data:{playerId:rt.id,deckType:rt.selectedDeck,deck:Se,deckSize:Se.length},timestamp:Date.now()}),d.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${rt.selectedDeck}, ${Se.length} cards`)}return ee})},[]),te=$.useCallback(s=>{const ie=ae.current;if(d.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!L.current}, webrtcIsHostRef.current=${ie}`),!L.current||!ie){d.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}L.current.broadcastGameState(s)},[]),F=$.useCallback(s=>{var ie,U,Y,Z,ce,ue,ee,ke,We,rt,Se,ve,Gr,xr,Ur,$r,Hr,Fr,Wr,Br,Yr,zr,Kr,qr,jr,Vr,Jr,Xr,Zr,Qr,en,tn,rn,nn,an,on,sn,dn,cn,ln,un,fn,pn,yn,hn,In,En,Tn,mn,wn,gn,_n,Cn,bn,An,Sn,Dn,Rn,On,Pn,kn;if(!(!s||!s.type))switch(d.info(`[handleWebrtcMessage] Received: ${s.type}`),s.type){case"JOIN_ACCEPT_MINIMAL":if(d.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${s.playerId}`),s.data){const h=s.data;d.info(`[handleWebrtcMessage] Creating minimal state with ${((ie=h.players)==null?void 0:ie.length)||0} players`);const g={gameId:h.gameId||ta(),isGameStarted:h.isGameStarted||!1,isPrivate:!1,activeGridSize:h.activeGridSize||4,gameMode:h.gameMode||Ar.FreeForAll,dummyPlayerCount:0,players:((U=h.players)==null?void 0:U.map(_=>{if((_.isDummy||!1)&&_.hand&&_.deck&&_.discard)return{id:_.id,name:_.name,color:_.color,isDummy:!0,isReady:_.isReady||!1,score:_.score||0,hand:_.hand||[],deck:_.deck||[],discard:_.discard||[],announcedCard:null,selectedDeck:_.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const K=[],x=[],q=[];for(let H=0;H<(_.handSize||0);H++)K.push({id:`placeholder_${_.id}_hand_${H}`,name:"?",isPlaceholder:!0,ownerId:_.id,deck:_.selectedDeck||"Random",color:_.color});for(let H=0;H<(_.deckSize||0);H++)x.push({id:`placeholder_${_.id}_deck_${H}`,name:"?",isPlaceholder:!0,ownerId:_.id,deck:_.selectedDeck||"Random",color:_.color});for(let H=0;H<(_.discardSize||0);H++)q.push({id:`placeholder_${_.id}_discard_${H}`,name:"?",isPlaceholder:!0,ownerId:_.id,deck:_.selectedDeck||"Random",color:_.color});return{id:_.id,name:_.name,color:_.color,isDummy:!1,isReady:_.isReady||!1,score:_.score||0,hand:K,deck:x,discard:q,announcedCard:null,selectedDeck:_.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:h.board||zn(),hostId:1,currentPhase:h.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:h.currentRound||1,turnNumber:h.turnNumber||1,activePlayerId:h.activePlayerId??null,startingPlayerId:h.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};a(g),s.playerId!==void 0&&(c(s.playerId),d.info(`[handleWebrtcMessage] Set local player ID to ${s.playerId}`)),a(_=>{const W=_.players.map(K=>{var q;const x=(q=h.players)==null?void 0:q.find(H=>H.id===K.id);if(K.id===s.playerId){const X=K.deck.length===0||K.deck.some(pe=>pe.isPlaceholder)||K.deck.length!==30;if(x!=null&&x.selectedDeck&&X){const pe=Ct(x.selectedDeck,K.id,K.name);d.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${pe.length} cards from ${x.selectedDeck}`),L.current&&pe.length>0&&setTimeout(()=>{const Ne=pe.map(Ee=>({id:Ee.id,baseId:Ee.baseId,power:Ee.power,powerModifier:Ee.powerModifier||0,isFaceDown:Ee.isFaceDown||!1,statuses:Ee.statuses||[]}));L.current.sendAction("DECK_DATA_UPDATE",{playerId:s.playerId,deck:Ne,deckSize:Ne.length}),d.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${x.selectedDeck}, ${Ne.length} cards`)},0);const me=[...K.hand],De=[...pe];if(h.isGameStarted&&me.length===0&&De.length>0){for(let Ee=0;Ee<6&&Ee<De.length;Ee++){const ze=De[0];De.splice(0,1),me.push(ze)}d.info(`[JOIN_ACCEPT_MINIMAL] Drew ${me.length} cards, deck now has ${De.length} cards`)}return{...K,deck:De,hand:me,selectedDeck:x.selectedDeck}}}return K});return{..._,players:W}});try{const _=(Y=L.current)==null?void 0:Y.getHostPeerId();_&&fr({hostPeerId:_,playerId:s.playerId,playerName:((Z=g.players.find(W=>W.id===s.playerId))==null?void 0:Z.name)||null,isHost:!1})}catch(_){d.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",_)}}break;case"JOIN_ACCEPT":if(d.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${s.playerId}, hasState: ${!!((ce=s.data)!=null&&ce.gameState)}`),(ue=s.data)!=null&&ue.gameState){const h=s.data.gameState;if(d.info(`[handleWebrtcMessage] Setting game state with ${((ee=h.players)==null?void 0:ee.length)||0} players`),a(h),s.playerId!==void 0){c(s.playerId),d.info(`[handleWebrtcMessage] Set local player ID to ${s.playerId}`);try{const g=(ke=L.current)==null?void 0:ke.getHostPeerId(),_=h.players.find(W=>W.id===s.playerId);g&&fr({hostPeerId:g,playerId:s.playerId,playerName:(_==null?void 0:_.name)||null,isHost:!1})}catch(g){d.warn("[JOIN_ACCEPT] Failed to save guest data:",g)}}}break;case"JOIN_ACCEPT_BINARY":if(d.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${s.playerId}`),s.data instanceof Uint8Array)try{const h=vo(s.data),g=h;if(d.info(`[handleWebrtcMessage] Expanded binary state with ${((We=g.players)==null?void 0:We.length)||0} players`),a(g),s.playerId!==void 0){c(s.playerId),d.info(`[handleWebrtcMessage] Set local player ID to ${s.playerId}`);try{const _=(rt=L.current)==null?void 0:rt.getHostPeerId(),W=g.players.find(K=>K.id===s.playerId);_&&fr({hostPeerId:_,playerId:s.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(_){d.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",_)}}d.info(`[handleWebrtcMessage] Received optimized binary game state: ${s.data.byteLength} bytes`)}catch(h){d.error("[handleWebrtcMessage] Failed to deserialize binary game state:",h)}break;case"STATE_UPDATE_COMPACT":if(ae.current){if(s.senderId&&s.senderId!==((Se=L.current)==null?void 0:Se.getPeerId())&&(d.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${s.senderId}`),(ve=s.data)!=null&&ve.gameState)){const h=s.data.gameState;a(g=>{const _=s.playerId;if(_===void 0)return d.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),g;const W=g.players.map(q=>{if(q.id===_){const H=h.players.find(X=>X.id===_);if(H){const X=Ne=>{const Ee=It(Ne.baseId);return Ee?{...Ee,id:Ne.id,baseId:Ne.baseId,ownerId:_,power:Ne.power,powerModifier:Ne.powerModifier,isFaceDown:Ne.isFaceDown,statuses:Ne.statuses||[]}:{id:Ne.id,baseId:Ne.baseId,name:"Unknown",power:0}},pe=(H.handCards||[]).map(X),me=(H.deckCards||[]).map(X),De=(H.discardCards||[]).map(X);return d.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${_}: hand=${pe.length}, deck=${me.length}, discard=${De.length}`),{...q,hand:pe,deck:me,discard:De,handSize:pe.length,deckSize:me.length,discardSize:De.length}}}return q}),K=h.board?h.board.map(q=>q.map(H=>{if(!H||!H.card)return H;const X=It(H.card.baseId||H.card.id);return X?{...H,card:{...X,id:H.card.id,baseId:H.card.baseId||H.card.id,ownerId:_,power:H.card.power,powerModifier:H.card.powerModifier,isFaceDown:H.card.isFaceDown||!1,statuses:H.card.statuses||[],enteredThisTurn:H.card.enteredThisTurn,deck:H.card.deck}}:H})):g.board,x={...g,players:W,board:K};return L.current&&setTimeout(()=>{L.current.broadcastGameState(x,s.senderId)},0),x})}}else if(!ae.current&&((Gr=s.data)!=null&&Gr.gameState)){const h=s.data.recipientPlayerId??null,g=s.data.gameState;if(yt.current){a(_=>({..._,currentPhase:g.currentPhase,activePlayerId:g.activePlayerId,startingPlayerId:g.startingPlayerId,isReadyCheckActive:g.isReadyCheckActive,isGameStarted:g.isGameStarted}));return}a(_=>{const W=h===null||h===E.current;d.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${h}, local=${E.current}, isForLocal=${W}`);const K=g.players.map(H=>{var pe,me;const X=_.players.find(De=>De.id===H.id);if(H.id===E.current&&X){const De=Ee=>{if(Ee.baseId){const Ke=It(Ee.baseId);if(Ke)return{...Ke,id:Ee.id,ownerId:E.current,power:Ee.power,powerModifier:Ee.powerModifier,isFaceDown:Ee.isFaceDown,statuses:Ee.statuses||[]}}return X.hand.find(Ke=>Ke.id===Ee.id)||X.deck.find(Ke=>Ke.id===Ee.id)||X.discard.find(Ke=>Ke.id===Ee.id)||{id:Ee.id,name:"Unknown",power:0}};if(H.handCards&&H.handCards.length>0||H.deckCards&&H.deckCards.length>0||H.discardCards&&H.discardCards.length>0){const Ee=(H.handCards||[]).map(De),ze=(H.deckCards||[]).map(De),Ke=(H.discardCards||[]).map(De);return Ee.forEach(($e,Me)=>{var Te,nt;(nt=(Te=H.handCards)==null?void 0:Te[Me])!=null&&nt.baseId&&!$e.baseId&&($e.baseId=H.handCards[Me].baseId)}),ze.forEach(($e,Me)=>{var Te,nt;(nt=(Te=H.deckCards)==null?void 0:Te[Me])!=null&&nt.baseId&&!$e.baseId&&($e.baseId=H.deckCards[Me].baseId)}),Ke.forEach(($e,Me)=>{var Te,nt;(nt=(Te=H.discardCards)==null?void 0:Te[Me])!=null&&nt.baseId&&!$e.baseId&&($e.baseId=H.discardCards[Me].baseId)}),d.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${Ee.length} hand, ${ze.length} deck, ${Ke.length} discard`),{...H,hand:Ee,deck:ze,discard:Ke}}else{const Ee=(H.handIds||[]).map($e=>X.hand.find(Te=>Te.id===$e)||X.deck.find(Te=>Te.id===$e)||X.discard.find(Te=>Te.id===$e)||{id:$e,name:"?",isPlaceholder:!1}),ze=(H.deckIds||[]).map($e=>X.deck.find(Te=>Te.id===$e)||X.hand.find(Te=>Te.id===$e)||X.discard.find(Te=>Te.id===$e)||{id:$e,name:"?",isPlaceholder:!1}),Ke=(H.discardIds||[]).map($e=>X.discard.find(Te=>Te.id===$e)||X.hand.find(Te=>Te.id===$e)||X.deck.find(Te=>Te.id===$e)||{id:$e,name:"?",isPlaceholder:!1});return d.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${Ee.length} hand, ${ze.length} deck, ${Ke.length} discard`),{...H,hand:Ee,deck:ze,discard:Ke}}}else{const De=H.deckSize??((pe=H.deck)==null?void 0:pe.length)??0,Ne=H.handSize??((me=H.hand)==null?void 0:me.length)??0,Ee=H.deckCards&&H.deckCards.length>0;let ze;if(Ee){const Me=Te=>{if(Te.baseId){const nt=It(Te.baseId);if(nt)return{...nt,id:Te.id,baseId:Te.baseId,ownerId:H.id,power:Te.power,powerModifier:Te.powerModifier,isFaceDown:Te.isFaceDown,statuses:Te.statuses||[]}}return{id:Te.id,name:"Unknown",power:0}};ze=H.deckCards.map(Me),d.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${H.id}: ${ze.length} cards`)}else if(X&&X.deck.length>0&&X.deck.some(Te=>!Te.isPlaceholder))ze=X.deck.slice(0,De),d.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${H.id}: ${ze.length} cards`);else{ze=[];for(let Te=0;Te<De;Te++)ze.push({id:`placeholder_${H.id}_deck_${Te}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color})}const Ke=(Me,Te)=>{if(Me.baseId&&!Me.isPlaceholder&&!Me.isCardBack){const nt=It(Me.baseId);if(nt)return{...nt,id:Me.id,baseId:Me.baseId,ownerId:H.id,power:Me.power,powerModifier:Me.powerModifier||0,isFaceDown:Me.isFaceDown||!1,statuses:Me.statuses||[]}}return{id:Me.id||`placeholder_${H.id}_hand_${Te}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color}};let $e;if(H.hand&&H.hand.length>0){$e=H.hand.map((Te,nt)=>Ke(Te,nt));const Me=$e.filter(Te=>!Te.isPlaceholder).length;Me>0&&d.info(`[STATE_UPDATE_COMPACT] Reconstructed ${Me}/${$e.length} revealed hand cards for player ${H.id}`)}else{$e=[];for(let Me=0;Me<Ne;Me++)$e.push({id:`placeholder_${H.id}_hand_${Me}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color})}return{...H,hand:$e,deck:ze,discard:(X==null?void 0:X.discard)||[]}}}),x=g.board?g.board.map(H=>H.map(X=>{if(!X||!X.card)return X;const pe=It(X.card.baseId||X.card.id);return pe?{...X,card:{...pe,id:X.card.id,baseId:X.card.baseId||X.card.id,ownerId:X.card.ownerId,ownerName:X.card.ownerName,power:X.card.power,powerModifier:X.card.powerModifier,isFaceDown:X.card.isFaceDown||!1,statuses:X.card.statuses||[],enteredThisTurn:X.card.enteredThisTurn,deck:X.card.deck}}:X})):_.board,q=at({...g,players:K,board:x});return{...g,players:K,board:q}})}break;case"STATE_UPDATE":if(ae.current&&s.senderId&&s.senderId!==((xr=L.current)==null?void 0:xr.getPeerId())){if(d.info(`[STATE_UPDATE] Host received state from guest ${s.senderId}`),(Ur=s.data)!=null&&Ur.gameState){const h=s.data.gameState;a(g=>{const _=s.playerId;if(_===void 0)return d.warn("[STATE_UPDATE] Guest state missing playerId"),g;const W=g.players.map(q=>{if(q.id===_){const H=h.players.find(X=>X.id===_);if(H){const X=Ee=>({...Ee,ownerId:_}),pe=(H.hand||[]).map(X),me=(H.deck||[]).map(X),De=(H.discard||[]).map(X);d.info(`[STATE_UPDATE] Merging guest ${_} state: hand=${pe.length}, deck=${me.length}, discard=${De.length}`);const Ne={...q,hand:pe,deck:me,discard:De,handSize:pe.length,deckSize:me.length,discardSize:De.length};return d.info(`[STATE_UPDATE] After merge - player ${_}: deckSize=${Ne.deckSize}, handSize=${Ne.handSize}`),Ne}}return q}),K=h.board?h.board.map(q=>q.map(H=>!H||!H.card?H:{...H,card:{...H.card,ownerId:_}})):g.board,x={...g,players:W,board:K};return L.current&&setTimeout(()=>{L.current.broadcastGameState(x,s.senderId)},0),x})}break}if(_e.current=!0,($r=s.data)!=null&&$r.gameState){const h=s.data.gameState;if(yt.current){a(g=>({...g,currentPhase:h.currentPhase,activePlayerId:h.activePlayerId,startingPlayerId:h.startingPlayerId,isReadyCheckActive:h.isReadyCheckActive,isGameStarted:h.isGameStarted}));return}a(g=>{var K;const _=h.players.map(x=>{var H,X,pe;const q=g.players.find(me=>me.id===x.id);if(x.id===E.current&&q){const me=q.hand.every(Ne=>Ne.isPlaceholder)||q.hand.length===0,De=x.handSize??((H=x.hand)==null?void 0:H.length)??0;if(me&&x.hand&&x.hand.length>0)return{...x,hand:x.hand,deck:x.deck||q.deck,discard:x.discard||q.discard};{let Ne=q.hand,Ee=q.deck;if(De>q.hand.length&&Ee.length>0){const ze=De-q.hand.length,Ke=[...q.hand],$e=[...q.deck];for(let Me=0;Me<ze&&Me<$e.length;Me++){const Te=$e[0];$e.splice(0,1),Ke.push(Te)}Ne=Ke,Ee=$e}return{...x,hand:Ne,deck:Ee,discard:x.discard||q.discard}}}else{if(x.isDummy||!1)return d.info(`[STATE_UPDATE] Using real cards for dummy player ${x.id}`),{...x,hand:x.hand||[],deck:x.deck||[],discard:x.discard||[]};const De=x.deckSize??((X=x.deck)==null?void 0:X.length)??0,Ne=x.handSize??((pe=x.hand)==null?void 0:pe.length)??0;d.info(`[STATE_UPDATE] Player ${x.id}: deckSize=${De}, handSize=${Ne}`);const Ee=[];for(let Ke=0;Ke<De;Ke++)Ee.push({id:`placeholder_${x.id}_deck_${Ke}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const ze=[];for(let Ke=0;Ke<Ne;Ke++)ze.push({id:`placeholder_${x.id}_hand_${Ke}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});return d.info(`[STATE_UPDATE] Created ${Ee.length} deck placeholders and ${ze.length} hand placeholders for player ${x.id}`),{...x,hand:ze,deck:Ee,discard:x.discard||[]}}}),W={...h,players:_};if(!ae.current)try{((K=L.current)==null?void 0:K.getHostPeerId())&&E.current!==null&&(Ut({gameState:W,localPlayerId:E.current,isHost:!1}),d.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(x){d.warn("[STATE_UPDATE] Failed to persist guest state:",x)}return W})}break;case"RECONNECT_SNAPSHOT":if(_e.current=!0,s.data){const h=s.data;a(g=>{const _=E.current,W=h.players.map(x=>{const q=g.players.find(me=>me.id===x.id);if(x.id===_&&q&&q.hand.some(De=>!De.isPlaceholder)){let De=[...q.hand];const Ne=[...q.deck];if(x.handSize>De.length){const Ee=x.handSize-De.length;for(let ze=0;ze<Ee&&Ne.length>0;ze++)De.push(Ne.shift())}else x.handSize<De.length&&(De=De.slice(0,x.handSize));return{...x,hand:De,deck:Ne,discard:q.discard}}const H=[];for(let me=0;me<x.handSize;me++)H.push({id:`placeholder_${x.id}_hand_${me}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const X=[];for(let me=0;me<x.deckSize;me++)X.push({id:`placeholder_${x.id}_deck_${me}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const pe=[];for(let me=0;me<x.discardSize;me++)pe.push({id:`placeholder_${x.id}_discard_${me}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});return{...x,hand:H,deck:X,discard:pe}}),K={gameId:h.gameId,gameMode:h.gameMode,isPrivate:h.isPrivate,isGameStarted:h.isGameStarted,isReadyCheckActive:h.isReadyCheckActive,activeGridSize:h.activeGridSize,currentPhase:h.currentPhase,isScoringStep:h.isScoringStep,activePlayerId:h.activePlayerId,startingPlayerId:h.startingPlayerId,currentRound:h.currentRound,turnNumber:h.turnNumber,roundWinners:h.roundWinners||{},gameWinner:h.gameWinner,isRoundEndModalOpen:h.isRoundEndModalOpen,dummyPlayerCount:h.dummyPlayerCount,players:W,board:h.board,spectators:g.spectators,hostId:g.hostId,revealRequests:g.revealRequests,preserveDeployAbilities:g.preserveDeployAbilities,highlights:g.highlights,floatingTexts:g.floatingTexts,targetingMode:g.targetingMode,abilityMode:g.abilityMode};if(!ae.current&&_!==null)try{Ut({gameState:K,localPlayerId:_,isHost:!1}),d.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(x){d.warn("[RECONNECT_SNAPSHOT] Failed to save state:",x)}return d.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${K.currentPhase}, players=${K.players.length}`),K})}break;case"STATE_DELTA":if(ae.current||(_e.current=!0),d.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${ae.current}, senderId: ${s.senderId}`),(Hr=s.data)!=null&&Hr.delta){const h=s.data.delta;d.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(h.playerDeltas||{}).length}, boardCells=${((Fr=h.boardCells)==null?void 0:Fr.length)||0}, phaseDelta=${!!h.phaseDelta}`),h.boardCells&&h.boardCells.length>0&&h.boardCells.forEach(g=>{var _,W;d.info(`[STATE_DELTA] Board cell [${g.row},${g.col}]: card=${((_=g.card)==null?void 0:_.name)||"(empty)"}, owner=${(W=g.card)==null?void 0:W.ownerId}`)}),ae.current&&s.senderId&&L.current&&(d.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${s.senderId} to other guests`),L.current.broadcastStateDelta(h,s.senderId)),h.phaseDelta&&d.info("[STATE_DELTA] phaseDelta:",JSON.stringify(h.phaseDelta)),h.playerDeltas&&Object.entries(h.playerDeltas).forEach(([g,_])=>{d.info(`[STATE_DELTA] Player ${g} delta: handSizeDelta=${_.handSizeDelta}, deckSizeDelta=${_.deckSizeDelta}`)}),a(g=>{const _=E.current||g.localPlayerId;d.info(`[STATE_DELTA] Applying delta with localPlayerId=${_}, currentPhase before=${g.currentPhase}`);const W=mr(g);d.info(`[STATE_DELTA] Applying delta with localPlayerId=${_}, currentPhase after=${W.currentPhase}`);try{W.gameId&&_!==null&&(Ut({gameState:W,localPlayerId:_,isHost:ae.current}),d.debug(`[STATE_DELTA] Saved state for ${ae.current?"host":"guest"} auto-restore`))}catch(K){d.warn("[STATE_DELTA] Failed to persist state:",K)}return W})}break;case"STATE_DELTA_BINARY":{ae.current||(_e.current=!0),d.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${ae.current}, senderId: ${s.senderId}, dataType=${(Br=(Wr=s.data)==null?void 0:Wr.constructor)==null?void 0:Br.name}, typeof=${typeof s.data}`);let h=null;if(s.data instanceof Uint8Array)try{h=Xn(s.data),h&&d.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(h.playerDeltas||{}).length}, boardCells=${((Yr=h.boardCells)==null?void 0:Yr.length)||0}`)}catch(g){d.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",g)}else if(typeof s.data=="string")try{h=Lo(s.data),h&&d.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${s.data.length} chars): playerDeltas=${Object.keys(h.playerDeltas||{}).length}, boardCells=${((zr=h.boardCells)==null?void 0:zr.length)||0}, phaseDelta=${!!h.phaseDelta}`)}catch(g){d.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",g)}else d.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof s.data}, constructor: ${(qr=(Kr=s.data)==null?void 0:Kr.constructor)==null?void 0:qr.name}`);h&&(ae.current&&s.senderId&&L.current&&(d.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${s.senderId} to other guests`),L.current.broadcastStateDelta(h,s.senderId)),a(g=>{const _=E.current||g.localPlayerId;d.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${_}, currentPhase before=${g.currentPhase}`);const W=mr(g);d.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${W.currentPhase}, board has ${W.board.flat().filter(K=>K==null?void 0:K.card).length} cards`);try{W.gameId&&_!==null&&(Ut({gameState:W,localPlayerId:_,isHost:ae.current}),d.debug(`[STATE_DELTA_BINARY] Saved state for ${ae.current?"host":"guest"} auto-restore`))}catch(K){d.warn("[STATE_DELTA_BINARY] Failed to persist state:",K)}return W}));break}case"CARD_STATE":if(typeof s.data=="string")try{const h=atob(s.data),g=new Uint8Array(h.length);for(let _=0;_<h.length;_++)g[_]=h.charCodeAt(_);a(_=>Nt(2,g,_,E.current||_.localPlayerId).gameState)}catch(h){d.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",h)}else s.data instanceof Uint8Array&&a(h=>Nt(2,s.data,h,E.current||h.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof s.data=="string")try{const h=atob(s.data),g=new Uint8Array(h.length);for(let _=0;_<h.length;_++)g[_]=h.charCodeAt(_);a(_=>{const{gameState:W}=Nt(3,g,_,E.current||_.localPlayerId);return W})}catch(h){d.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",h)}else s.data instanceof Uint8Array&&a(h=>{const{gameState:g}=Nt(3,s.data,h,E.current||h.localPlayerId);return g});break;case"SESSION_EVENT":if(typeof s.data=="string")try{const h=atob(s.data),g=new Uint8Array(h.length);for(let _=0;_<h.length;_++)g[_]=h.charCodeAt(_);a(_=>Nt(4,g,_,E.current||_.localPlayerId).gameState)}catch(h){d.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",h)}else s.data instanceof Uint8Array&&a(h=>Nt(4,s.data,h,E.current||h.localPlayerId).gameState);break;case"JOIN_REQUEST":d.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${s.senderId}, isHost: ${ae.current}`),ae.current&&s.senderId?(d.info(`Host received JOIN_REQUEST from ${s.senderId}, data:`,s.data),Ve(s.senderId,s.data)):d.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${ae.current}, senderId: ${s.senderId}`);break;case"ACTION":if(ae.current&&s.data){const{actionType:h,actionData:g}=s.data;if(h==="STATE_UPDATE"&&(g!=null&&g.gameState)){if(yt.current){L.current&&s.senderId&&L.current.sendToGuest(s.senderId,{type:"STATE_UPDATE",senderId:L.current.getPeerId(),data:{gameState:m.current},timestamp:Date.now()});break}a(_=>{const W=g.gameState,K=W.players.map(q=>{const H=_.players.find(X=>X.id===q.id);return H&&q.id!==E.current?{...q,deck:H.deck||q.deck,discard:H.discard||q.discard,score:H.score}:q}),x={...W,players:K};return L.current&&L.current.broadcastToGuests({type:"STATE_UPDATE",senderId:L.current.getPeerId(),data:{gameState:x},timestamp:Date.now()}),x})}else if(h==="STATE_DELTA"&&(g!=null&&g.delta))a(_=>{const W=g.delta;let K=W;yt.current&&W.playerDeltas&&(K={...W,playerDeltas:Object.fromEntries(Object.entries(W.playerDeltas).map(([q,H])=>{const X={...H};return delete X.scoreDelta,[q,X]}))}),E.current||_.localPlayerId;const x=mr(_);return L.current&&L.current.broadcastStateDelta(K),x});else if(h==="NEXT_PHASE")a(_=>{const W=_,K=W.currentPhase,x=K===2&&!W.isScoringStep,q=K+1;return{...W,currentPhase:q,...x&&{isScoringStep:!0}}});else if(h==="PREV_PHASE")a(_=>{const W=_;return W.isScoringStep?{...W,isScoringStep:!1,currentPhase:Math.max(1,W.currentPhase-1)}:{...W,currentPhase:Math.max(1,W.currentPhase-1)}});else if(h==="SET_PHASE"&&(g==null?void 0:g.phaseIndex)!==void 0)a(_=>({..._,currentPhase:g.phaseIndex}));else if(h==="UPDATE_PLAYER_NAME"&&(g==null?void 0:g.playerId)!==void 0&&(g==null?void 0:g.name)!==void 0)a(_=>({..._,players:_.players.map(W=>W.id===g.playerId?{...W,name:g.name}:W)}));else if(h==="CHANGE_PLAYER_COLOR"&&(g==null?void 0:g.playerId)!==void 0&&(g==null?void 0:g.color)!==void 0){const _=g.playerId,W=g.color;a(K=>{const x={...K,players:K.players.map(q=>q.id===_?{...q,color:W}:q)};return L.current&&L.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:L.current.getPeerId(),data:{playerId:_,color:W},timestamp:Date.now()}),x})}else if(h==="UPDATE_PLAYER_SCORE"&&(g==null?void 0:g.playerId)!==void 0&&(g==null?void 0:g.delta)!==void 0)a(_=>({..._,players:_.players.map(W=>W.id===g.playerId?{...W,score:Math.max(0,W.score+g.delta)}:W)}));else if(h==="CHANGE_PLAYER_DECK"&&(g==null?void 0:g.playerId)!==void 0){const _=g.playerId,W=g.deckType,K=g.deck;a(x=>{const q=x.players.find(pe=>pe.id===_);if(!q)return x;let H;K&&K.length>0?(d.info(`[CHANGE_PLAYER_DECK] Host received ${K.length} cards for player ${_}`),H=K.map(pe=>{if(pe.baseId){const me=It(pe.baseId);if(me)return{...me,id:pe.id,baseId:pe.baseId,deck:W,ownerId:_,ownerName:q.name,power:pe.power,powerModifier:pe.powerModifier||0,isFaceDown:pe.isFaceDown||!1,statuses:pe.statuses||[]}}return{id:pe.id,baseId:pe.id,name:"Unknown",deck:W,ownerId:_,ownerName:q.name,power:pe.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(H=Ct(W,_,q.name),d.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${_} with ${H.length} cards from ${W}`));const X={...x,players:x.players.map(pe=>pe.id===_?{...pe,selectedDeck:W,deck:H,hand:[],discard:[],announcedCard:null,boardHistory:[]}:pe)};if(L.current){const pe=H.map(me=>({id:me.id,baseId:me.baseId,power:me.power,powerModifier:me.powerModifier||0,isFaceDown:me.isFaceDown||!1,statuses:me.statuses||[]}));L.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:L.current.getPeerId(),playerId:_,data:{playerId:_,deckType:W,deck:pe,deckSize:pe.length},timestamp:Date.now()})}return X})}else if(h==="TOGGLE_ACTIVE_PLAYER"&&(g==null?void 0:g.playerId)!==void 0)a(_=>{if(!_.players.find(x=>x.id===g.playerId))return _;const K=Qn(_,g.playerId);return L.current&&L.current.broadcastGameState(K),K});else if(h==="TOGGLE_AUTO_DRAW"&&(g==null?void 0:g.playerId)!==void 0)a(_=>({..._,players:_.players.map(W=>W.id===g.playerId?{...W,autoDrawEnabled:!W.autoDrawEnabled}:W)}));else if(h==="START_NEXT_ROUND")a(_=>({..._,isRoundEndModalOpen:!1,currentRound:(_.currentRound||1)+1,players:_.players.map(W=>({...W,score:0}))}));else if(h==="RESET_DEPLOY_STATUS")a(_=>{const W=_.board.map(K=>K.map(x=>{var q;return(q=x.card)!=null&&q.statuses?{...x,card:{...x.card,statuses:x.card.statuses.filter(H=>H.type!=="DeployAbilityUsed")}}:x}));return{..._,board:W,preserveDeployAbilities:!1}});else if(h==="DECK_DATA_UPDATE"&&(g==null?void 0:g.playerId)!==void 0&&(g!=null&&g.deck)){const _=g.playerId,W=g.deck,K=g.deckSize;d.info(`[ACTION] DECK_DATA_UPDATE: Received ${W.length} cards for guest ${_}`),a(x=>({...x,players:x.players.map(q=>q.id===_?{...q,deck:[...W],deckSize:K||W.length}:q)}))}else d.warn(`[ACTION] Unknown action type: ${h}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(d.info(`[PLAYER_RECONNECT] Guest ${s.playerId} reconnecting from ${s.senderId}`),ae.current&&s.playerId!==void 0&&s.senderId){const h=m.current;if(d.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(h!=null&&h.gameId)}, gameId=${h==null?void 0:h.gameId}, hasPlayers=${((jr=h==null?void 0:h.players)==null?void 0:jr.length)||0}`),h&&h.gameId){d.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${s.playerId}`);const g=Yo(h,s.playerId);(Vr=L.current)==null||Vr.sendToGuest(s.senderId,{type:"RECONNECT_SNAPSHOT",senderId:L.current.getPeerId(),data:g.data,timestamp:Date.now()}),d.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${s.playerId}`)}else d.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((Jr=s.data)==null?void 0:Jr.isReadyCheckActive)!==void 0||((Xr=s.data)==null?void 0:Xr.isPrivate)!==void 0)&&a(h=>({...h,isReadyCheckActive:s.data.isReadyCheckActive??!0,isPrivate:s.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((Zr=s.data)==null?void 0:Zr.isReadyCheckActive)!==void 0&&a(h=>({...h,isReadyCheckActive:s.data.isReadyCheckActive}));break;case"PLAYER_READY":ae.current&&s.playerId!==void 0?a(h=>{const g=h.players.map(x=>x.id===s.playerId?{...x,isReady:!0}:x),_={...h,players:g};d.info(`Player ${s.playerId} is ready via WebRTC`),L.current&&(L.current.broadcastGameState(_),d.info(`[PLAYER_READY] Broadcasted ready status for player ${s.playerId}`));const W=_.players.filter(x=>!x.isDummy&&!x.isDisconnected);if(W.length>0&&W.every(x=>x.isReady)&&!_.isGameStarted){const x=_.players.filter(pe=>!pe.isDisconnected),q=Math.floor(Math.random()*x.length),H=x[q].id;let X={..._};return X.isReadyCheckActive=!1,X.isGameStarted=!0,X.startingPlayerId=H,X.activePlayerId=H,X.currentPhase=0,X.players=X.players.map(pe=>{if(pe.hand.length===0&&pe.deck.length>0){const De=[...pe.hand],Ne=[...pe.deck];for(let Ee=0;Ee<6&&Ee<Ne.length;Ee++){const ze=Ne[0];Ne.splice(0,1),De.push(ze)}return d.info(`[PLAYER_READY] Drew ${De.length} cards for player ${pe.id}`),{...pe,hand:De,deck:Ne}}return pe}),X=kr(X,H),d.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${X.currentPhase}`),L.current&&(L.current.broadcastToGuests({type:"GAME_START",senderId:L.current.getPeerId(),data:{startingPlayerId:H,activePlayerId:H,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var pe,me;d.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(pe=X.players[0])==null?void 0:pe.deck.length}, hand=${(me=X.players[0])==null?void 0:me.hand.length}`),d.info(`[PLAYER_READY] Broadcasting state with currentPhase=${X.currentPhase}`),te(X)},100)),X}return _}):ae.current;break;case"ASSIGN_TEAMS":(Qr=s.data)!=null&&Qr.assignments&&a(h=>{const g=h.players.map(_=>{let W=_.teamId||1;for(const[K,x]of Object.entries(s.data.assignments))if(x.includes(_.id)){W=parseInt(K);break}return{..._,teamId:W}});return{...h,players:g}});break;case"SET_GAME_MODE":((en=s.data)==null?void 0:en.mode)!==void 0&&a(h=>({...h,gameMode:s.data.mode}));break;case"SET_GAME_PRIVACY":((tn=s.data)==null?void 0:tn.isPrivate)!==void 0&&a(h=>({...h,isPrivate:s.data.isPrivate}));break;case"SET_GRID_SIZE":((rn=s.data)==null?void 0:rn.size)!==void 0&&a(h=>{const g=s.data.size,_=[];for(let W=0;W<g;W++){const K=[];for(let x=0;x<g;x++)K.push({card:null});_.push(K)}return{...h,activeGridSize:g,board:_}});break;case"SET_DUMMY_PLAYER_COUNT":((nn=s.data)==null?void 0:nn.count)!==void 0&&a(h=>({...h,dummyPlayerCount:s.data.count}));break;case"HOST_READY":s.playerId!==void 0&&(d.info(`[handleWebrtcMessage] Host (player ${s.playerId}) is ready`),a(h=>{const g=h.players.map(_=>_.id===s.playerId?{..._,isReady:!0}:_);return{...h,players:g}}));break;case"GAME_START":_e.current=!0,d.info("[handleWebrtcMessage] Game starting!",s.data),m.current&&(d.info(`[GAME_START] Current phase before: ${m.current.currentPhase}`),m.current.players.forEach(h=>{d.info(`[GAME_START] Before: Player ${h.id} - deck: ${h.deck.length}, hand: ${h.hand.length}`)})),s.data&&a(h=>{d.info(`[GAME_START] Processing for localPlayerId=${E.current}`),h.players.forEach(K=>{d.info(`[GAME_START] Player ${K.id} before: deck=${K.deck.length}, hand=${K.hand.length}`)});const g=s.data.startingPlayerId??s.data.activePlayerId,_={...h,isGameStarted:s.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:g,activePlayerId:s.data.activePlayerId,currentPhase:h.currentPhase},W=_.players.find(K=>K.id===E.current);if(W&&W.hand.length===0&&W.deck.length>0){const x=[...W.hand],q=[...W.deck];for(let H=0;H<6&&H<q.length;H++){const X=q[0];q.splice(0,1),x.push(X)}_.players=_.players.map(H=>H.id===E.current?{...H,hand:x,deck:q}:H),d.info(`[GAME_START] Drew ${x.length} cards for local player ${E.current}, deck now has ${q.length} cards`)}return _.players.forEach(K=>{d.info(`[GAME_START] Player ${K.id} after: deck=${K.deck.length}, hand=${K.hand.length}`)}),d.info(`[GAME_START] Final state: currentPhase=${_.currentPhase}, activePlayerId=${_.activePlayerId}, startingPlayerId=${_.startingPlayerId}`),_});break;case"ACTIVE_PLAYER_CHANGED":d.info("[handleWebrtcMessage] Active player changed!",s.data),s.data&&a(h=>{const g={...h,activePlayerId:s.data.activePlayerId};if(s.data.currentPhase!==void 0&&(g.currentPhase=s.data.currentPhase),s.data.turnNumber!==void 0&&(g.turnNumber=s.data.turnNumber),g.currentPhase===0&&g.activePlayerId===E.current){const _=g.players.find(W=>W.id===E.current);if(_&&_.deck.length>0){const W=_.deck[0],K=[..._.deck.slice(1)],x=[..._.hand,W];g.players=g.players.map(q=>q.id===E.current?{...q,deck:K,hand:x}:q)}g.currentPhase=1}return g});break;case"SYNC_DECK_SELECTIONS":d.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",s.data),s.data&&a(h=>s.data.playerId!==void 0&&s.data.selectedDeck!==void 0?s.data.playerId===E.current?(d.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${s.data.playerId}`),h):{...h,players:h.players.map(g=>g.id===s.data.playerId?{...g,selectedDeck:s.data.selectedDeck}:g)}:s.data.deckSelections&&Array.isArray(s.data.deckSelections)?{...h,players:h.players.map(g=>{if(g.id===E.current)return g;const _=s.data.deckSelections.find(W=>W.id===g.id);return _?{...g,selectedDeck:_.selectedDeck}:g})}:h);break;case"CHANGE_PLAYER_DECK":if(d.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",s.data),!s.data||s.data.playerId===void 0)break;{const h=s.data.playerId,g=s.data.deckType,_=s.data.deck;if(h===E.current)break;a(W=>{const K=W.players.find(q=>q.id===h);if(!K)return W;let x;return _&&_.length>0?x=_.map(q=>{if(q.baseId){const H=It(q.baseId);return H?{...H,id:q.id,baseId:q.baseId,deck:g,ownerId:h,ownerName:K.name,power:q.power,powerModifier:q.powerModifier||0,isFaceDown:q.isFaceDown||!1,statuses:q.statuses||[]}:{id:q.id,baseId:q.baseId,name:"Unknown",deck:g,ownerId:h,ownerName:K.name,power:q.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}return{id:q.id,baseId:q.id,name:"Unknown",deck:g,ownerId:h,ownerName:K.name,power:q.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}):x=Ct(g,h,K.name),{...W,players:W.players.map(q=>q.id===h?{...q,selectedDeck:g,deck:x,hand:[],discard:[],announcedCard:null,boardHistory:[]}:q)}})}break;case"GAME_RESET":a(h=>{const g=s.data.activeGridSize||8,_=[];for(let x=0;x<g;x++){const q=[];for(let H=0;H<g;H++)q.push({card:null});_.push(q)}const W=(s.data.players||[]).map(x=>{if(x.isDummy&&x.hand&&x.deck&&x.discard)return{...x,boardHistory:[]};{const q=x.selectedDeck||"SynchroTech";return{...x,hand:[],deck:Ct(q,x.id,x.name),discard:[],boardHistory:[]}}}),K={...h,players:W,gameMode:s.data.gameMode,isPrivate:s.data.isPrivate,activeGridSize:s.data.activeGridSize,dummyPlayerCount:s.data.dummyPlayerCount,autoAbilitiesEnabled:s.data.autoAbilitiesEnabled,isGameStarted:s.data.isGameStarted,currentPhase:s.data.currentPhase,currentRound:s.data.currentRound,turnNumber:s.data.turnNumber,activePlayerId:s.data.activePlayerId,startingPlayerId:s.data.startingPlayerId,roundWinners:s.data.roundWinners||{},gameWinner:s.data.gameWinner,isRoundEndModalOpen:s.data.isRoundEndModalOpen,isReadyCheckActive:s.data.isReadyCheckActive,board:_,targetingMode:null,floatingTexts:[]};return m.current=K,K});break;case"ABILITY_MODE_SET":(an=s.data)!=null&&an.abilityMode&&(a(h=>({...h,abilityMode:s.data.abilityMode})),d.info("[AbilityMode] Received ability mode from host",{playerId:s.data.abilityMode.playerId,mode:s.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":d.info("[Ability] Target selected",s.data);break;case"ABILITY_COMPLETED":a(h=>({...h,abilityMode:null})),d.info("[Ability] Ability completed",s.data);break;case"ABILITY_CANCELLED":a(h=>({...h,abilityMode:null}));break;case"CHANGE_PLAYER_COLOR":if(d.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",s.data),!s.data||s.data.playerId===void 0)break;{const h=s.data.playerId,g=s.data.color;if(h===E.current)break;a(_=>({..._,players:_.players.map(W=>W.id===h?{...W,color:g}:W)}))}break;case"TRIGGER_HIGHLIGHT":if((on=s.data)!=null&&on.highlightData){const h=s.data.highlightData;O(h),ae.current&&L.current&&s.senderId&&L.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:s.senderId,data:h,timestamp:Date.now()},s.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(s.data){const h=(sn=L.current)==null?void 0:sn.getPeerId();s.senderId!==h&&O(s.data)}break;case"TRIGGER_FLOATING_TEXT":if((dn=s.data)!=null&&dn.textData){const h=s.data.textData;a(g=>({...g,floatingTexts:[...g.floatingTexts,h].filter(_=>Date.now()-_.timestamp<Ae.FLOATING_TEXT_DURATION)})),ae.current&&L.current&&s.senderId&&L.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:s.senderId,data:h,timestamp:Date.now()},s.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((cn=s.data)!=null&&cn.batch){const h=s.data.batch;a(g=>({...g,floatingTexts:[...g.floatingTexts,...h].filter(_=>Date.now()-_.timestamp<Ae.FLOATING_TEXT_DURATION)})),ae.current&&L.current&&s.senderId&&L.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:s.senderId,data:{batch:h},timestamp:Date.now()},s.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const h=(ln=L.current)==null?void 0:ln.getPeerId();(un=s.data)!=null&&un.batch&&s.senderId!==h?a(g=>({...g,floatingTexts:[...g.floatingTexts,...s.data.batch].filter(_=>Date.now()-_.timestamp<Ae.FLOATING_TEXT_DURATION)})):(fn=s.data)!=null&&fn.textData&&s.senderId!==h&&a(g=>({...g,floatingTexts:[...g.floatingTexts,s.data.textData].filter(_=>Date.now()-_.timestamp<Ae.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((pn=s.data)!=null&&pn.coords){const h=s.data.coords,g=s.data.timestamp;T({coords:h,timestamp:g}),ae.current&&L.current&&s.senderId&&L.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:s.senderId,data:{coords:h,timestamp:g},timestamp:Date.now()},s.senderId)}break;case"NO_TARGET_TRIGGERED":if((yn=s.data)!=null&&yn.coords){const h=(hn=L.current)==null?void 0:hn.getPeerId();s.senderId!==h&&T({coords:s.data.coords,timestamp:s.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(s.data){const h=s.data;w(g=>[...g,h]),setTimeout(()=>{w(g=>g.filter(_=>_.timestamp!==h.timestamp))},1e3),ae.current&&L.current&&s.senderId&&L.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:s.senderId,data:h,timestamp:Date.now()},s.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(s.data){const h=s.data;A(g=>[...g,h]),setTimeout(()=>{A(g=>g.filter(_=>_.timestamp!==h.timestamp))},1e3),ae.current&&L.current&&s.senderId&&L.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:s.senderId,data:h,timestamp:Date.now()},s.senderId)}break;case"TRIGGER_TARGET_SELECTION":if(s.data){const h=s.data;z(g=>[...g,h]),setTimeout(()=>{z(g=>g.filter(_=>_.timestamp!==h.timestamp))},1e3),ae.current&&L.current&&s.senderId&&L.current.broadcastToGuests({type:"TARGET_SELECTION_TRIGGERED",senderId:s.senderId,data:h,timestamp:Date.now()},s.senderId)}break;case"TARGET_SELECTION_TRIGGERED":s.data&&s.senderId!==((In=L.current)==null?void 0:In.getPeerId())&&(z(h=>[...h,s.data]),setTimeout(()=>{z(h=>h.filter(g=>g.timestamp!==s.data.timestamp))},1e3));break;case"DECK_SELECTION_TRIGGERED":s.data&&s.senderId!==((En=L.current)==null?void 0:En.getPeerId())&&(w(h=>[...h,s.data]),setTimeout(()=>{w(h=>h.filter(g=>g.timestamp!==s.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":s.data&&s.senderId!==((Tn=L.current)==null?void 0:Tn.getPeerId())&&(A(h=>[...h,s.data]),setTimeout(()=>{A(h=>h.filter(g=>g.timestamp!==s.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((mn=s.data)!=null&&mn.targetingMode){const h=s.data.targetingMode;a(g=>({...g,targetingMode:h})),m.current.targetingMode=h,d.info("[TargetingMode] Received targeting mode via WebRTC",{playerId:h.playerId,mode:h.action.mode})}break;case"CLEAR_TARGETING_MODE":a(h=>({...h,targetingMode:null})),m.current.targetingMode=null;break;case"SYNC_VALID_TARGETS":((wn=s.data)==null?void 0:wn.playerId)!==E.current&&(ne({playerId:s.data.playerId,validHandTargets:s.data.validHandTargets||[],isDeckSelectable:s.data.isDeckSelectable||!1}),setTimeout(()=>{ne(h=>(h==null?void 0:h.playerId)===s.data.playerId?null:h)},1e4));break;case"RECONNECT_ACCEPT":if((gn=s.data)!=null&&gn.gameState){const h=s.data.gameState;a(h),v("Connected"),d.info(`[Reconnection] State restored with ${((_n=h.players)==null?void 0:_n.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(g){d.warn("[Reconnection] Failed to clear stored data:",g)}}break;case"RECONNECT_REJECT":{const h=((Cn=s.data)==null?void 0:Cn.reason)||"unknown";d.warn(`[Reconnection] Reconnection rejected: ${h}`),v("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((bn=s.data)==null?void 0:bn.playerId)!==void 0&&(d.info(`[Reconnection] Player ${s.data.playerId} disconnected, reconnection window open`),a(h=>({...h,players:h.players.map(g=>g.id===s.data.playerId?{...g,isDisconnected:!0}:g)})));break;case"PLAYER_RECONNECTED":((An=s.data)==null?void 0:An.playerId)!==void 0&&(d.info(`[Reconnection] Player ${s.data.playerId} reconnected`),a(h=>({...h,players:h.players.map(g=>g.id===s.data.playerId?{...g,isDisconnected:!1}:g)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((Sn=s.data)==null?void 0:Sn.playerId)!==void 0&&(d.info(`[Reconnection] Player ${s.data.playerId} converted to dummy`),a(h=>({...h,players:h.players.map(g=>g.id===s.data.playerId?{...g,isDummy:!0,isDisconnected:!0}:g)})));break;case"REQUEST_DECK_VIEW":if(ae.current&&((Dn=s.data)==null?void 0:Dn.targetPlayerId)!==void 0){const h=s.data.targetPlayerId;s.playerId;const g=r.players.find(_=>_.id===h);if(g&&L.current){let _=[];h===E.current||g.isDummy?(d.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${g.deck.length} cards, first card baseId: ${(Rn=g.deck[0])==null?void 0:Rn.baseId}`),_=g.deck.map(x=>({id:x.id,baseId:x.baseId,deck:x.deck,power:x.power,powerModifier:x.powerModifier,isFaceDown:x.isFaceDown,statuses:x.statuses||[]}))):g.deckCards&&g.deckCards.length>0?_=g.deckCards:_=g.deck.map(x=>({id:x.id,baseId:x.baseId,power:x.power,powerModifier:x.powerModifier,isFaceDown:x.isFaceDown,statuses:x.statuses||[]}));const W={targetPlayerId:h,deckCards:_,deckSize:_.length},K={type:"DECK_VIEW_DATA",senderId:L.current.getPeerId(),data:W,timestamp:Date.now()};L.current.sendToGuest(s.senderId||"",K),d.info(`[REQUEST_DECK_VIEW] Sent ${W.deckCards.length} cards for player ${h}`)}}break;case"DECK_VIEW_DATA":if(((On=s.data)==null?void 0:On.targetPlayerId)!==void 0&&((Pn=s.data)!=null&&Pn.deckCards)){const h=s.data.targetPlayerId,g=s.data.deckCards;d.info(`[DECK_VIEW_DATA] Received ${g.length} deck cards for player ${h}`);const _=K=>{if(K.baseId){const q=It(K.baseId);if(q)return{...q,id:K.id,baseId:K.baseId,deck:K.deck||qe.SynchroTech,ownerId:h,power:K.power,powerModifier:K.powerModifier,isFaceDown:K.isFaceDown,statuses:K.statuses||[]};d.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${K.baseId}`)}else d.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${K.id}`);return{id:K.id,baseId:K.baseId||K.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:K.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:qe.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}},W=g.map(_);a(K=>({...K,players:K.players.map(x=>x.id===h?{...x,deck:W}:x)}))}break;case"DECK_DATA_UPDATE":if(ae.current&&s.playerId!==void 0&&((kn=s.data)!=null&&kn.deck)){const h=s.playerId,g=s.data.deck,_=s.data.deckSize;d.info(`[DECK_DATA_UPDATE] Received ${g.length} cards for guest ${h}, deckSize=${_}`),a(W=>({...W,players:W.players.map(K=>K.id===h?{...K,deck:[...g],deckSize:_}:K)}))}break;case"REQUEST_DECK_DATA":if(!ae.current&&L.current){const h=r.players.find(g=>g.id===E.current);if(h&&h.deck.length>0){d.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${h.deck.length} cards`);const g=h.deck.map(_=>({id:_.id,baseId:_.baseId,power:_.power,powerModifier:_.powerModifier||0,isFaceDown:_.isFaceDown||!1,statuses:_.statuses||[]}));L.current.sendAction("DECK_DATA_UPDATE",{playerId:E.current,deck:g,deckSize:g.length})}}break;default:d.warn(`[handleWebrtcMessage] Unknown message type: ${s.type}`,s);break}},[Oe,Ct,te,r,l]),V=$.useCallback(s=>{if(!L.current||kt)return;Ze(!0),v("Connecting");const ie=3e4,U=1e3;let Y=0;const Z=ie/U;try{const ue={hostPeerId:s,playerId:l,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ue))}catch(ue){d.error("[Reconnection] Failed to store data:",ue)}const ce=async()=>{Y++;const ue=Math.max(0,ie-Y*U);if(dt({attempt:Y,maxAttempts:Z,timeRemaining:ue}),ue<=0){d.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Ze(!1),dt(null),Lt();return}let ee=s;if(r!=null&&r.gameId){const ke=pr(r.gameId);if(ke&&ke.peerId!==s){ee=ke.peerId;try{const We={hostPeerId:ee,playerId:l,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(We))}catch(We){d.error("[Reconnection] Failed to update reconnection data:",We)}}}try{const ke=l||E.current;ke!==null?(d.info(`[Reconnection] Reconnecting as existing player ${ke} to host ${ee}`),await L.current.initializeAsReconnectingGuest(ee,ke)):(d.info("[Reconnection] No playerId, connecting as new player"),await L.current.initializeAsGuest(ee)),d.info("[Reconnection] Successfully reconnected!"),Ze(!1),dt(null)}catch(ke){d.warn("[Reconnection] Reconnection attempt failed:",ke),setTimeout(ce,U)}};ce()},[kt,r,l]),M=$.useCallback(s=>{a(ie=>{if(!ie)return d.error("[updateState] prevState is undefined, skipping update"),ie;const U=typeof s=="function"?s(ie):s;if(!U)return d.error("[updateState] newState is undefined, skipping update"),ie;const Y=!ie.gameId&&U.gameId;if(!_e.current&&!Y)return U;if(he&&L.current){if(ae.current){if(L.current.broadcastGameState(U),d.info(`[updateState] Host broadcast state: phase=${U.currentPhase}, activePlayer=${U.activePlayerId}`),U.gameId&&E.current!==null)try{Ut({gameState:U,localPlayerId:E.current,isHost:!0}),d.debug("[updateState] Saved game state for host auto-restore")}catch(Z){d.warn("[updateState] Failed to save game state:",Z)}}else L.current&&(L.current.sendStateToHost(U,E.current),d.info(`[updateState] Guest sent state to host: phase=${U.currentPhase}, activePlayer=${U.activePlayerId}`));return U}if(Ce.current&&Ce.current.readyState===WebSocket.OPEN){const Z={type:"UPDATE_STATE",gameState:U};Q.current&&(Z.playerToken=Q.current),Ce.current.send(JSON.stringify(Z))}return U})},[he,Oe,te]),B=Zo({ws:Ce,webrtcManager:L,gameStateRef:m,webrtcIsHostRef:ae,setGameState:a,updateState:M}),j=Qo({ws:Ce,webrtcManager:L,gameStateRef:m,localPlayerIdRef:E,webrtcIsHostRef:ae,setGameState:a}),fe=es({updateState:M,sendWebrtcAction:et,webrtcIsHostRef:ae,webrtcManagerRef:L}),ge=ts({updateState:M}),de=rs({localPlayerIdRef:E,updateState:M}),{addBoardCardStatus:oe,removeBoardCardStatus:le,removeBoardCardStatusByOwner:Ie,modifyBoardCardPower:se,addAnnouncedCardStatus:Re,removeAnnouncedCardStatus:Pe,modifyAnnouncedCardPower:be,addHandCardStatus:st,removeHandCardStatus:ut,revealHandCard:it,revealBoardCard:wt,requestCardReveal:pt,respondToRevealRequest:ft,removeRevealedStatus:ir}=de,Tt=ns({webrtcIsHostRef:ae,sendWebrtcAction:et,webrtcManagerRef:L,localPlayerIdRef:E,getCardDefinition:It,commandCardIds:lo,createDeck:Ct,updateState:M}),{changePlayerDeck:na,loadCustomDeck:aa,resurrectDiscardedCard:oa,reorderTopDeck:sa,reorderCards:ia,recoverDiscardedCard:da}=Tt,ca=as({ws:Ce,webrtcManagerRef:L,webrtcIsHostRef:ae,gameStateRef:m,scoreDeltaAccumulator:_t,setGameState:a,updateState:M,abilityMode:t,setAbilityMode:n,createDeck:Ct}),{toggleActivePlayer:la,toggleAutoDraw:ua,setPhase:fa,nextPhase:pa,prevPhase:ya,closeRoundEndModal:ha,closeRoundEndModalOnly:Ia,resetGame:Ea}=ca,At=$.useCallback(()=>{if(Qe()){v("Connected");return}if(f.current||Ce.current&&(Ce.current.readyState===WebSocket.OPEN||Ce.current.readyState===WebSocket.CONNECTING))return;const s=Vo();if(!s){d.warn("No WebSocket URL configured in settings. Waiting for user input."),v("Disconnected"),tt.current&&clearTimeout(tt.current);return}try{Ce.current=new WebSocket(s)}catch(ie){d.error("Failed to create WebSocket:",ie),v("Disconnected"),tt.current&&clearTimeout(tt.current),tt.current=window.setTimeout(At,Ae.RECONNECT_DELAY);return}v("Connecting"),Ce.current.onopen=()=>{var Y;_e.current=!1,v("Connected");const ie=localStorage.getItem("custom_ws_url");ie&&ie.trim()!==""&&localStorage.setItem("websocket_url",ie.trim());const U=m.current;if(d.info("Current gameState on open:",U?`gameId=${U.gameId}`:"null"),d.info("playerTokenRef.current on open:",Q.current?"YES":"NO"),U&&U.gameId&&((Y=Ce.current)==null?void 0:Y.readyState)===WebSocket.OPEN){let Z=Q.current;if(!Z){try{const ce=localStorage.getItem(Dt);if(ce){const ue=JSON.parse(ce);d.info("RECONNECTION_DATA_KEY:",ue==null?void 0:ue.gameId,U.gameId),ue!=null&&ue.playerToken&&(Z=ue.playerToken,Q.current=Z,d.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(ce){console.warn("Failed to parse reconnection data:",ce instanceof Error?ce.message:String(ce))}if(!Z&&U.players&&E.current){const ce=U.players.find(ue=>ue.id===E.current);ce!=null&&ce.playerToken&&(Z=ce.playerToken,Q.current=Z)}}d.info("JoinGame: Sending reconnection with token:",Z?"YES":"NO","gameId:",U.gameId),Ce.current.send(JSON.stringify({type:"JOIN_GAME",gameId:U.gameId,playerToken:Z}))}},Ce.current.onmessage=ie=>{try{const U=JSON.parse(ie.data);if(U.type==="GAMES_LIST")I(U.games);else if(U.type==="JOIN_SUCCESS"){if(U.isSpectator){c(null),d.info("Joined as spectator:",U.message||"Spectator mode"),mt.current=null;return}c(U.playerId);const Y=mt.current||m.current.gameId;Y&&U.playerId!==null&&U.playerToken?(Q.current=U.playerToken,localStorage.setItem(Dt,JSON.stringify({gameId:Y,playerId:U.playerId,playerToken:U.playerToken,timestamp:Date.now()})),m.current.gameId===Y&&Gn(m.current,U.playerId,U.playerToken)):U.playerId===null&&(Gt(),Q.current=void 0),mt.current=null,U.playerId===1&&setTimeout(()=>{var Z;((Z=Ce.current)==null?void 0:Z.readyState)===WebSocket.OPEN&&Ce.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ht}))},Ae.DECK_SYNC_DELAY)}else if(U.type==="CONNECTION_ESTABLISHED"){d.info("Connection acknowledged by server");const Y=sessionStorage.getItem("pending_invite_game"),Z=sessionStorage.getItem("pending_invite_name");Y&&Ce.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),d.info("Auto-joining invite game:",Y),Ce.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:Y,playerName:Z||"Player"})))}else if(U.type==="DECK_DATA_UPDATED")d.info("Deck data synced with server");else if(U.type==="ERROR")if(U.message.includes("not found")||U.message.includes("Dummy")){d.info("Game not found error - clearing state");const Y=St();a(Y),m.current=Y,c(null),Gt(),mt.current=null}else if(U.message.includes("already started")&&G.current){d.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const Y=St();a(Y),m.current=Y,c(null),Gt(),mt.current=null,G.current=!1}else console.warn("Server Error:",U.message);else if(U.type==="HIGHLIGHT_TRIGGERED")O(U.highlightData);else if(U.type==="NO_TARGET_TRIGGERED")T({coords:U.coords,timestamp:U.timestamp});else if(U.type==="DECK_SELECTION_TRIGGERED")w(Y=>[...Y,U.deckSelectionData]),setTimeout(()=>{w(Y=>Y.filter(Z=>Z.timestamp!==U.deckSelectionData.timestamp))},1e3);else if(U.type==="HAND_CARD_SELECTION_TRIGGERED")A(Y=>[...Y,U.handCardSelectionData]),setTimeout(()=>{A(Y=>Y.filter(Z=>Z.timestamp!==U.handCardSelectionData.timestamp))},1e3);else if(U.type==="FLOATING_TEXT_TRIGGERED")a(Y=>({...Y,floatingTexts:[...Y.floatingTexts,U.floatingTextData].filter(Z=>Date.now()-Z.timestamp<Ae.FLOATING_TEXT_DURATION)}));else if(U.type==="FLOATING_TEXT_BATCH_TRIGGERED")a(Y=>({...Y,floatingTexts:[...Y.floatingTexts,...U.batch].filter(Z=>Date.now()-Z.timestamp<Ae.FLOATING_TEXT_DURATION)}));else if(U.type==="SYNC_VALID_TARGETS")U.playerId!==E.current&&(ne({playerId:U.playerId,validHandTargets:U.validHandTargets||[],isDeckSelectable:U.isDeckSelectable||!1}),setTimeout(()=>{ne(Y=>(Y==null?void 0:Y.playerId)===U.playerId?null:Y)},1e4));else if(U.type==="TARGET_SELECTION_TRIGGERED")U.effect&&U.playerId!==E.current&&(z(Y=>[...Y,U.effect]),setTimeout(()=>{z(Y=>Y.filter(Z=>Z.timestamp!==U.effect.timestamp))},1e3));else if(U.type==="TARGETING_MODE_SET"){const Y=U.targetingMode;Y&&(a(Z=>({...Z,targetingMode:Y})),m.current.targetingMode=Y,d.info("[TargetingMode] Received targeting mode from server",{playerId:Y.playerId,mode:Y.action.mode}))}else if(U.type==="TARGETING_MODE_CLEARED")a(Y=>({...Y,targetingMode:null})),m.current.targetingMode=null,d.debug("[TargetingMode] Cleared targeting mode from server");else if(U.type==="ABILITY_MODE_SET")U.abilityMode&&(a(Y=>({...Y,abilityMode:U.abilityMode})),d.info("[AbilityMode] Received ability mode from host",{playerId:U.abilityMode.playerId,mode:U.abilityMode.mode,sourceCard:U.abilityMode.sourceCardName}));else if(U.type==="ABILITY_TARGET_SELECTED")d.info("[Ability] Target selected",U.data);else if(U.type==="ABILITY_COMPLETED")a(Y=>({...Y,abilityMode:null})),d.info("[Ability] Ability completed",U.data);else if(U.type==="ABILITY_CANCELLED")a(Y=>({...Y,abilityMode:null})),d.info("[Ability] Ability cancelled");else if(U.type==="GAME_RESET")d.info("[GameReset] Received GAME_RESET message from server"),a(Y=>{const Z=U.activeGridSize||8,ce=[];for(let ee=0;ee<Z;ee++){const ke=[];for(let We=0;We<Z;We++)ke.push({card:null});ce.push(ke)}const ue={...Y,players:U.players||[],gameMode:U.gameMode,isPrivate:U.isPrivate,activeGridSize:U.activeGridSize,dummyPlayerCount:U.dummyPlayerCount,autoAbilitiesEnabled:U.autoAbilitiesEnabled,isGameStarted:U.isGameStarted,currentPhase:U.currentPhase,currentRound:U.currentRound,turnNumber:U.turnNumber,activePlayerId:U.activePlayerId,startingPlayerId:U.startingPlayerId,roundWinners:U.roundWinners||{},gameWinner:U.gameWinner,isRoundEndModalOpen:U.isRoundEndModalOpen,isReadyCheckActive:U.isReadyCheckActive,board:ce,targetingMode:null,floatingTexts:[]};return m.current=ue,ue});else if(!U.type&&U.players&&U.board){const Y=zt(U),Z=m.current;if(!Z.isScoringStep&&Y.isScoringStep&&Y.currentPhase!==2){d.debug("Ignoring delayed scoring state update");return}if(Z.isScoringStep&&(Y.currentPhase!==Z.currentPhase||Y.activePlayerId!==Z.activePlayerId||Y.currentPhase!==4)&&(Y.isScoringStep=!1),a(Y),m.current=Y,E.current!==null&&Y.gameId){let ue;try{const ee=localStorage.getItem(Dt);ee&&(ue=JSON.parse(ee).playerToken)}catch{}if(!ue&&Y.players){const ee=Y.players.find(ke=>ke.id===E.current);ee!=null&&ee.playerToken&&(ue=ee.playerToken,Q.current=ue)}Gn(Y,E.current,ue)}}else console.warn("Unknown message type:",U.type,"keys:",Object.keys(U),"data:",U)}catch(U){d.error("Failed to parse message from server:",ie.data,U)}},Ce.current.onclose=()=>{v("Disconnected"),f.current||(tt.current&&clearTimeout(tt.current),tt.current=window.setTimeout(At,Ae.RECONNECT_DELAY))},Ce.current.onerror=ie=>d.error("WebSocket error event:",ie)},[a,St]),Ta=$.useCallback((s,ie="Player")=>{var U;f.current=!1,((U=Ce.current)==null?void 0:U.readyState)===WebSocket.OPEN?Ce.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:s,playerName:ie})):(sessionStorage.setItem("pending_invite_game",s),sessionStorage.setItem("pending_invite_name",ie),At())},[At]);$.useEffect(()=>{f.current=!1;const s=sessionStorage.getItem("invite_game_id"),ie=sessionStorage.getItem("invite_host_id");if(s&&!ie)return At(),()=>{f.current=!0,tt.current&&clearTimeout(tt.current),Ce.current&&(Ce.current.onclose=null,Ce.current.close())};if(s&&ie)return()=>{f.current=!0,tt.current&&clearTimeout(tt.current),Ce.current&&(Ce.current.onclose=null,Ce.current.close())};const U=performance.getEntriesByType("navigation"),Y=U.length>0?U[0]:null,Z=(Y==null?void 0:Y.type)??0,ce=jo();return ce&&(d.info(`Restoring saved game state (nav type: ${Z}):`,ce.gameState.gameId),a(ce.gameState),c(ce.localPlayerId),m.current=ce.gameState,E.current=ce.localPlayerId,Q.current=ce.playerToken),At(),()=>{f.current=!0,tt.current&&clearTimeout(tt.current),Ce.current&&(Ce.current.onclose=null,Ce.current.close())}},[]),$.useEffect(()=>{if(ht&&m.current&&m.current.gameId){const s=zt(m.current);s!==m.current&&(a(s),m.current=s)}},[]),$.useEffect(()=>{if(re)return;const s=setInterval(()=>{if(ht&&m.current&&m.current.gameId){const ie=zt(m.current);a({...ie}),m.current=ie,ye(!0),clearInterval(s)}},100);return()=>clearInterval(s)},[re]);const{startReadyCheck:ma,cancelReadyCheck:wa,playerReady:ga}=j,{updatePlayerName:_a,changePlayerColor:Ca}=fe,{drawCard:ba,drawCardsBatch:Aa,shufflePlayerDeck:Sa,flipBoardCard:Da,flipBoardCardFaceDown:Ra}=ge,{assignTeams:Oa,setGameMode:Pa,setGamePrivacy:ka,setActiveGridSize:va,setDummyPlayerCount:Na}=B,La=$.useCallback(()=>{var s;if(((s=Ce.current)==null?void 0:s.readyState)===WebSocket.OPEN&&m.current.gameId&&E.current===1){Ce.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ht}));const ie=m.current,U=He(ie);U.players.forEach(Y=>{if(["hand","deck","discard"].forEach(ce=>{Y[ce]&&(Y[ce]=Y[ce].map(ue=>{const ee=lr(ue.name);return ee?{...ue,...ee}:ue}))}),Y.announcedCard){const ce=lr(Y.announcedCard.name);ce&&(Y.announcedCard={...Y.announcedCard,...ce})}}),U.board.forEach(Y=>{Y.forEach(Z=>{if(Z.card){const ce=lr(Z.card.name);ce&&(Z.card={...Z.card,...ce})}})}),Ce.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:U})),a(U)}},[]),dr=$.useCallback((s,ie)=>{var Z;const U=m.current;if(!U.isGameStarted){d.warn("[ScoreUpdate] Blocked: game not started");return}if(U.isRoundEndModalOpen){d.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(ie===0)return;const Y=Qe();if(Y?M(ce=>({...ce,players:ce.players.map(ue=>ue.id===s?{...ue,score:Math.max(0,(ue.score||0)+ie)}:ue)})):a(ce=>({...ce,players:ce.players.map(ue=>ue.id===s?{...ue,score:Math.max(0,(ue.score||0)+ie)}:ue)})),!Y){if(((Z=Ce.current)==null?void 0:Z.readyState)!==WebSocket.OPEN){d.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const ce=_t.get(s);if(ce){clearTimeout(ce.timerId);const ue=ce.delta+ie,ee=setTimeout(()=>{var We;const ke=_t.get(s);ke&&((We=Ce.current)==null?void 0:We.readyState)===WebSocket.OPEN&&(d.info(`[ScoreUpdate] Sending accumulated delta: player=${s}, delta=${ke.delta}`),Ce.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:m.current.gameId,playerId:s,delta:ke.delta}))),_t.delete(s)},500);_t.set(s,{delta:ue,timerId:ee})}else{const ue=setTimeout(()=>{var ke;const ee=_t.get(s);ee&&((ke=Ce.current)==null?void 0:ke.readyState)===WebSocket.OPEN&&(d.info(`[ScoreUpdate] Sending delta: player=${s}, delta=${ee.delta}`),Ce.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:m.current.gameId,playerId:s,delta:ee.delta}))),_t.delete(s)},500);_t.set(s,{delta:ie,timerId:ue})}}},[a,M]),{triggerHighlight:Ma,triggerFloatingText:Nr,triggerNoTarget:Ga,triggerDeckSelection:xa,triggerHandCardSelection:Ua,syncValidTargets:$a,triggerTargetSelection:Ha}=Ye,Fa=os({ws:Ce,gameStateRef:m,updateState:M,updatePlayerScore:dr,triggerFloatingText:Nr}),{scoreLine:Wa,scoreDiagonal:Ba}=Fa,gt=ss({updateState:M,rawJsonData:ht}),Ya=is({updateState:M,localPlayerIdRef:E,updatePlayerScore:dr}),{moveItem:Lr}=Ya,za=ds({ws:Ce,webrtcManager:L,gameStateRef:m,webrtcIsHostRef:ae,setGameState:a}),Ka=ls({ws:Ce,gameStateRef:m,localPlayerIdRef:E,isRestoringSessionRef:xe,isManualExitRef:f,webrtcIsHostRef:ae,receivedServerStateRef:_e,joiningGameIdRef:mt,setGameState:a,setLocalPlayerId:c,connectWebSocket:At,updateState:M}),{setTargetingMode:qa,clearTargetingMode:ja}=za,{createGame:Va,joinGame:Mr,exitGame:Ja,requestGamesList:Xa,forceReconnect:Za}=Ka;return{gameState:r,localPlayerId:l,setLocalPlayerId:c,draggedItem:k,setDraggedItem:p,connectionStatus:D,gamesList:C,latestHighlight:y,latestFloatingTexts:S,latestNoTarget:b,latestDeckSelections:N,latestHandCardSelections:R,joinAsInvite:Ta,startReadyCheck:ma,cancelReadyCheck:wa,playerReady:ga,assignTeams:Oa,setGameMode:Pa,setGamePrivacy:ka,setActiveGridSize:va,setDummyPlayerCount:Na,updatePlayerName:_a,changePlayerColor:Ca,updatePlayerScore:dr,changePlayerDeck:na,loadCustomDeck:aa,drawCard:ba,drawCardsBatch:Aa,shufflePlayerDeck:Sa,moveItem:Lr,handleDrop:Lr,addBoardCardStatus:oe,removeBoardCardStatus:le,removeBoardCardStatusByOwner:Ie,modifyBoardCardPower:se,addAnnouncedCardStatus:Re,removeAnnouncedCardStatus:Pe,modifyAnnouncedCardPower:be,addHandCardStatus:st,removeHandCardStatus:ut,flipBoardCard:Da,flipBoardCardFaceDown:Ra,revealHandCard:it,revealBoardCard:wt,requestCardReveal:pt,respondToRevealRequest:ft,syncGame:La,removeRevealedStatus:ir,toggleActivePlayer:la,toggleAutoDraw:ua,triggerHighlight:Ma,triggerFloatingText:Nr,triggerNoTarget:Ga,triggerDeckSelection:xa,triggerHandCardSelection:Ua,triggerTargetSelection:Ha,targetSelectionEffects:P,syncValidTargets:$a,remoteValidTargets:J,setTargetingMode:qa,clearTargetingMode:ja,nextPhase:pa,prevPhase:ya,setPhase:fa,markAbilityUsed:gt.markAbilityUsed,applyGlobalEffect:gt.applyGlobalEffect,swapCards:gt.swapCards,transferStatus:gt.transferStatus,transferAllCounters:gt.transferAllCounters,spawnToken:gt.spawnToken,resetDeployStatus:gt.resetDeployStatus,removeStatusByType:gt.removeStatusByType,recoverDiscardedCard:da,resurrectDiscardedCard:oa,scoreLine:Wa,closeRoundEndModal:ha,closeRoundEndModalOnly:Ia,resetGame:Ea,scoreDiagonal:Ba,reorderTopDeck:sa,reorderCards:ia,updateState:M,requestDeckView:ct,sendFullDeckToHost:lt,createGame:Va,joinGame:Mr,joinGameViaModal:Mr,exitGame:Ja,requestGamesList:Xa,forceReconnect:Za,webrtcHostId:Fe,webrtcIsHost:Oe,initializeWebrtcHost:je,connectAsGuest:Ge,sendWebrtcAction:et,isReconnecting:kt,reconnectProgress:bt}},Ls=({gameState:e,localPlayerId:t,abilityMode:n,setAbilityMode:r,cursorStack:a,setCursorStack:o,commandContext:i,setCommandContext:l,setViewingDiscard:c,triggerNoTarget:m,triggerTargetSelection:E,setPlayMode:k,setCounterSelectionData:p,interactionLock:D,onAbilityComplete:v,updateState:C,moveItem:I,drawCard:y,drawCardsBatch:O,updatePlayerScore:S,markAbilityUsed:u,applyGlobalEffect:b,swapCards:T,transferStatus:N,transferAllCounters:w,resurrectDiscardedCard:R,spawnToken:A,scoreLine:P,nextPhase:z,modifyBoardCardPower:J,addBoardCardStatus:ne,removeBoardCardStatus:re,removeBoardCardStatusByOwner:ye,resetDeployStatus:he,scoreDiagonal:we,removeStatusByType:Fe,triggerFloatingText:Le,triggerHandCardSelection:Oe,clearValidTargets:ot,setTargetingMode:ae,clearTargetingMode:kt})=>{const Ze=$.useCallback((f,G)=>{var _e,L,Ue,Be,je,Ge,et,ct,lt,Ye,xe,Xe,Ve;if(f.type==="ABILITY_COMPLETE"){v==null||v();return}if(f.type==="REVEREND_SETUP_SCORE"){const te=((_e=f.sourceCard)==null?void 0:_e.ownerId)??0;let F=0;for(let V=0;V<e.board.length;V++)for(let M=0;M<e.board[V].length;M++){const B=(L=e.board[V][M])==null?void 0:L.card;if(B!=null&&B.statuses){const j=B.statuses.filter(fe=>fe.type==="Exploit"&&fe.addedByPlayerId===te);F+=j.length}}F>0?(S(te,F),Le([{row:G.row,col:G.col,text:`+${F}`,playerId:te}])):Le([{row:G.row,col:G.col,text:"+0",playerId:te}]),u(G,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}if(f.type==="GLOBAL_AUTO_APPLY"){if(((Ue=f.payload)==null?void 0:Ue.customAction)==="FINN_SCORING"){let te=0;const F=(Be=f.sourceCard)==null?void 0:Be.ownerId;if(F===void 0){d.warn("[FINN_SCORING] Source card missing ownerId, skipping scoring"),u(f.sourceCoords||G,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}if(e.players.forEach(V=>{V.id!==F&&V.hand.forEach(M=>{var B;(B=M.statuses)!=null&&B.some(j=>j.type==="Revealed"&&j.addedByPlayerId===F)&&te++})}),e.board.forEach(V=>{V.forEach(M=>{var j;const B=M.card;if(B&&B.ownerId!==F){const fe=((j=B.statuses)==null?void 0:j.filter(ge=>ge.type==="Revealed"&&ge.addedByPlayerId===F).length)||0;te+=fe}})}),te>0){const V=f.sourceCoords||G;Le({row:V.row,col:V.col,text:`+${te}`,playerId:F}),S(F,te)}u(f.sourceCoords||G,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}if(((je=f.payload)==null?void 0:je.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){f.sourceCoords&&f.sourceCoords.row>=0?Fe(f.sourceCoords,"Aim"):i.lastMovedCardCoords?Fe(i.lastMovedCardCoords,"Aim"):G&&G.row>=0&&Fe(G,"Aim");return}if(f.payload&&!f.payload.cleanupCommand){const{tokenType:te,filter:F}=f.payload,V=[],M=e.board.length;if(f.payload.contextReward&&f.sourceCard){let B=0;const j=G&&G.row>=0?G:i.lastMovedCardCoords;if(j){const{row:fe,col:ge}=j;let de=e.board[fe][ge].card;const oe=f.payload._tempContextId||i.lastMovedCardId;if((!de||oe&&de.id!==oe)&&oe)for(let le=0;le<M;le++){for(let Ie=0;Ie<M;Ie++)if(((Ge=e.board[le][Ie].card)==null?void 0:Ge.id)===oe){de=e.board[le][Ie].card;break}if(de)break}de&&(B=Math.max(0,de.power+(de.powerModifier||0)+(de.bonusPower||0)))}if(B>0){const fe=f.sourceCard.ownerId;if(fe===void 0){d.error("Cannot apply reward: sourceCard has no ownerId");return}const ge=f.payload.contextReward;ge==="DRAW_MOVED_POWER"||ge==="DRAW_EQUAL_POWER"?O(fe,B):ge==="SCORE_MOVED_POWER"&&(Le({row:G.row,col:G.col,text:`+${B}`,playerId:fe}),S(fe,B))}if(f.payload.contextReward==="STUN_MOVED_UNIT"&&j){const fe=f.sourceCard.ownerId;fe!==void 0?ne(j,"Stun",fe):d.error("Cannot apply stun: sourceCard has no ownerId")}return}if(F)for(let B=0;B<M;B++)for(let j=0;j<M;j++){const fe=e.board[B][j].card;fe&&F(fe)&&V.push({row:B,col:j})}else f.sourceCoords&&f.sourceCoords.row>=0?V.push(f.sourceCoords):G&&G.row>=0?V.push(G):i.lastMovedCardCoords&&V.push(i.lastMovedCardCoords);if(V.length>0){if(te){const B=f.payload.count||1,j=f.payload.ownerId!==void 0?f.payload.ownerId:((et=f.sourceCard)==null?void 0:et.ownerId)??t;for(let fe=0;fe<B;fe++)b(G,V,te,j,!!f.isDeployAbility)}}else m(G),u(G,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}}if(!er(f,e,((ct=f.sourceCard)==null?void 0:ct.ownerId)||t,i)){m(G),f.chainedAction&&setTimeout(()=>{Ze(f.chainedAction,G)},500);return}if(f.type==="CREATE_STACK"&&f.tokenType){let te=f.count||0;if(f.dynamicCount){const{factor:F,ownerId:V}=f.dynamicCount;let M=0;e.board.forEach(B=>B.forEach(j=>{var fe;if((fe=j.card)!=null&&fe.statuses){const ge=j.card.statuses.filter(de=>de.type===F&&de.addedByPlayerId===V);M+=ge.length}})),te=M}te>0?(r(null),o({type:f.tokenType,count:te,isDragging:!1,sourceCoords:G,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,excludeOwnerId:f.excludeOwnerId,onlyOpponents:f.onlyOpponents,onlyFaceDown:f.onlyFaceDown,targetType:f.targetType,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove,requiredTargetStatus:f.requiredTargetStatus,requireStatusFromSourceOwner:f.requireStatusFromSourceOwner,mustBeAdjacentToSource:f.mustBeAdjacentToSource,mustBeInLineWithSource:f.mustBeInLineWithSource,maxDistanceFromSource:f.maxDistanceFromSource,maxOrthogonalDistance:f.maxOrthogonalDistance,placeAllAtOnce:f.placeAllAtOnce,chainedAction:f.chainedAction,...f.targetOwnerId!==void 0&&{targetOwnerId:f.targetOwnerId},recordContext:f.recordContext,replaceStatus:f.replaceStatus})):m(G)}else if(f.type==="ENTER_MODE"){if(f.mode==="SHIELD_SELF_THEN_SPAWN"){ne(G,"Shield",f.sourceCard.ownerId),r({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload});return}if(f.mode==="SHIELD_SELF_THEN_RIOT_PUSH"){const M=f.sourceCard.ownerId;ne(G,"Shield",M);const B=e.board.length,j=Math.floor((B-e.activeGridSize)/2),fe=j,ge=j+e.activeGridSize-1;let de=!1;const{row:oe,col:le}=G,Ie=[[-1,0],[1,0],[0,-1],[0,1]];for(const[se,Re]of Ie){const Pe=oe+se,be=le+Re;if(Pe<fe||Pe>ge||be<fe||be>ge)continue;const st=e.board[Pe][be];if(!st.card)continue;const ut=e.players.find(Tt=>Tt.id===st.card.ownerId),it=e.players.find(Tt=>Tt.id===M),wt=(ut==null?void 0:ut.teamId)!==void 0&&(it==null?void 0:it.teamId)!==void 0&&ut.teamId===it.teamId;if(st.card.ownerId===M||wt)continue;const pt=Pe+se,ft=be+Re;if(pt<fe||pt>ge||ft<fe||ft>ge)continue;if(e.board[pt][ft].card===null){de=!0;break}}de?r({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload}):m(G);return}if(f.mode==="PRINCEPS_SHIELD_THEN_AIM"){const M=f.sourceCard.ownerId;ne(G,"Shield",M);const B={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility};er(B,e,M,i)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:G,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove}):m(G);return}if(f.mode==="GAWAIN_DEPLOY_SHIELD_AIM"){const M=f.sourceCard.ownerId;ne(G,"Shield",M);const B={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility};er(B,e,M,i)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:G,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove}):m(G);return}if(f.mode==="ABR_DEPLOY_SHIELD_AIM"){const M=f.sourceCard.ownerId;ne(G,"Shield",M);const B={type:"CREATE_STACK",tokenType:"Aim",requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility};er(B,e,M,i)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:G,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,targetOwnerId:M,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove}):m(G);return}if(f.mode==="RIOT_PUSH"&&f.sourceCoords){const M=e.board.length,B=Math.floor((M-e.activeGridSize)/2),j=B,fe=B+e.activeGridSize-1;let ge=!1;const{row:de,col:oe}=f.sourceCoords,le=(lt=f.sourceCard)==null?void 0:lt.ownerId,Ie=[[-1,0],[1,0],[0,-1],[0,1]];for(const[se,Re]of Ie){const Pe=de+se,be=oe+Re;if(Pe<j||Pe>fe||be<j||be>fe)continue;const st=e.board[Pe][be];if(!st.card||le===void 0)continue;const ut=e.players.find(Tt=>Tt.id===st.card.ownerId),it=e.players.find(Tt=>Tt.id===le),wt=(ut==null?void 0:ut.teamId)!==void 0&&(it==null?void 0:it.teamId)!==void 0&&ut.teamId===it.teamId;if(st.card.ownerId===le||wt)continue;const pt=Pe+se,ft=be+Re;if(pt<j||pt>fe||ft<j||ft>fe)continue;if(e.board[pt][ft].card===null){ge=!0;break}}if(!ge){m(f.sourceCoords);return}}if(f.mode==="SELECT_TARGET"&&((Ye=f.payload)==null?void 0:Ye.actionType)==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"&&f.sourceCard){const M=f.sourceCard.ownerId,B=e.players.find(j=>j.id===M);if(B&&B.hand.length<1){m(f.sourceCoords||G);return}}if(f.mode==="SELECT_TARGET"&&((xe=f.payload)==null?void 0:xe.actionType)==="LUCIUS_SETUP"&&f.sourceCard){const M=f.sourceCard.ownerId,B=e.players.find(j=>j.id===M);if(B&&B.hand.length<1){m(f.sourceCoords||G);return}}let te=f.sourceCard,F=G;if(f.sourceCoords&&f.sourceCoords.row>=0&&(F=f.sourceCoords),f.mode==="SELECT_CELL"&&i.lastMovedCardCoords&&i.lastMovedCardId&&((Xe=f.payload)!=null&&Xe.useContextCard)){const{row:M,col:B}=i.lastMovedCardCoords,j=e.board[M][B].card;j&&(te=j,F=i.lastMovedCardCoords)}r({...f,sourceCard:te,sourceCoords:F});const V=((Ve=f.sourceCard)==null?void 0:Ve.ownerId)??e.activePlayerId??t??1;ae(f,V,F,void 0,i)}else if(f.type==="OPEN_MODAL")if(f.mode==="RETRIEVE_DEVICE"){const te=e.players.find(F=>{var V;return F.id===((V=f.sourceCard)==null?void 0:V.ownerId)});te&&(c({player:te,pickConfig:{filterType:"Device",action:"recover"}}),G.row>=0&&u(G,!!f.isDeployAbility,!1,f.readyStatusToRemove))}else if(f.mode==="IMMUNIS_RETRIEVE"){const te=e.players.find(F=>{var V;return F.id===((V=f.sourceCard)==null?void 0:V.ownerId)});te&&(c({player:te,pickConfig:{filterType:"Optimates",action:"resurrect"}}),r({type:"ENTER_MODE",mode:"IMMUNIS_RETRIEVE",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload}))}else if(f.mode==="SEARCH_DECK"){const te=e.players.find(F=>{var V;return F.id===((V=f.sourceCard)==null?void 0:V.ownerId)});te&&(c({player:te,pickConfig:{filterType:f.payload.filterType||"Unit",action:"recover",isDeck:!0}}),G.row>=0&&u(G,!!f.isDeployAbility,!1,f.readyStatusToRemove))}else f.mode==="ZIUS_LINE_SELECT"?i.lastMovedCardCoords?r({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:f.sourceCard,sourceCoords:i.lastMovedCardCoords,isDeployAbility:f.isDeployAbility,payload:f.payload,chainedAction:f.chainedAction}):r({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload,chainedAction:f.chainedAction}):f.mode==="SELECT_DECK"?r({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload}):f.mode==="ZIUS_EXPLOIT_AND_SCORE"?r({type:"ENTER_MODE",mode:"ZIUS_EXPLOIT_AND_SCORE",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload}):f.mode==="REVEREND_DOUBLE_EXPLOIT"&&r({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload})},[e,t,i,u,r,o,m,b,c,ne,S,y,Fe,v,Le,ae]);$.useEffect(()=>{(n==null?void 0:n.type)==="GLOBAL_AUTO_APPLY"&&(Ze(n,n.sourceCoords||{row:-1,col:-1}),r(null))},[n,Ze,r]),$.useEffect(()=>{n||kt()},[n,kt]);const bt=$.useCallback((f,G)=>{if(n||a||!e.isGameStarted||t===null)return;const Q=e.players.find(Ue=>Ue.id===f.ownerId),_e=t===f.ownerId||(Q==null?void 0:Q.isDummy)&&t===1;if(e.activePlayerId!==f.ownerId||!_e||!Eo(f,e)||!Cr(f,e.currentPhase,e.activePlayerId,e))return;const L=Io(f,e,f.ownerId,G);if(L){L.readyStatusToRemove&&u(G,!!L.isDeployAbility,!1,L.readyStatusToRemove);const Ue={...L,chainedAction:L.chainedAction?{...L.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};Ze(Ue,G)}},[n,a,e,t,Ze,u]),dt=$.useCallback(f=>{var je,Ge,et,ct,lt;if(!n)return;const{mode:G,sourceCard:Q,sourceCoords:_e,payload:L,isDeployAbility:Ue,readyStatusToRemove:Be}=n;if(G==="SCORE_LAST_PLAYED_LINE"&&n.sourceCoords){if(D.current)return;const{row:Ye,col:xe}=n.sourceCoords,{row:Xe,col:Ve}=f;if(Ye!==Xe&&xe!==Ve)return;D.current=!0;const te=e.activePlayerId,F=e.board.length;let V=Ye,M=Ye,B=xe,j=xe;if(Ye===Xe)V=Ye,M=Ye,B=0,j=F-1;else if(xe===Ve)B=Ve,j=Ve,V=0,M=F-1;else{D.current=!1;return}const fe=e.board.some(oe=>oe.some(le=>{var Ie,se;return((Ie=le.card)==null?void 0:Ie.ownerId)===te&&le.card.name.toLowerCase().includes("data liberator")&&((se=le.card.statuses)==null?void 0:se.some(Re=>Re.type==="Support"))}));let ge=0;const de=[];for(let oe=V;oe<=M;oe++)for(let le=B;le<=j;le++){const se=e.board[oe][le].card;if(se&&!((je=se.statuses)!=null&&je.some(Re=>Re.type==="Stun"))){const Re=se.ownerId===te,Pe=(Ge=se.statuses)==null?void 0:Ge.some(be=>be.type==="Exploit"&&be.addedByPlayerId===te);if(Re||fe&&Pe&&se.ownerId!==te){const be=Math.max(0,se.power+(se.powerModifier||0)+(se.bonusPower||0));be>0&&(ge+=be,de.push({row:oe,col:le,text:`+${be}`,playerId:te}))}}}r(null),de.length>0&&Le(de),ge>0&&S(te,ge),z(),setTimeout(()=>{D.current=!1},200);return}if(G==="SELECT_LINE_START"){r({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:Q,sourceCoords:_e,isDeployAbility:Ue,payload:{...L,firstCoords:f}});return}if(G==="SELECT_LINE_END"&&(L!=null&&L.firstCoords)){const{row:Ye,col:xe}=L.firstCoords,{row:Xe,col:Ve}=f;if(Ye!==Xe&&xe!==Ve)return;const te=L.actionType,F=(Q==null?void 0:Q.ownerId)??((et=e.players.find(V=>V.id===e.activePlayerId))!=null&&et.isDummy?e.activePlayerId:t||e.activePlayerId);if(te==="ZIUS_SCORING"){const V=i.lastMovedCardCoords;if(V){const oe=Ye===Xe&&V.row===Ye,le=xe===Ve&&V.col===xe;if(!oe&&!le)return}const M=e.board.length;let B=0,j=M-1,fe=0,ge=M-1;if(Ye===Xe)B=j=Ye;else if(xe===Ve)fe=ge=xe;else return;let de=0;for(let oe=B;oe<=j;oe++)for(let le=fe;le<=ge;le++){const Ie=e.board[oe][le];Ie.card&&(de+=((ct=Ie.card.statuses)==null?void 0:ct.filter(se=>se.type==="Exploit"&&se.addedByPlayerId===F).length)||0)}de>0&&F&&(_e&&Le({row:_e.row,col:_e.col,text:`+${de}`,playerId:F}),S(F,de)),_e&&_e.row>=0&&u(_e,Ue,!1,Be)}else if(te==="CENTURION_BUFF"&&Q&&_e&&F){const V=e.board.length;let M=0,B=V-1,j=0,fe=V-1;Ye===Xe?M=B=Ye:j=fe=xe;for(let ge=M;ge<=B;ge++)for(let de=j;de<=fe;de++){const oe=e.board[ge][de].card;if(oe){const le=oe.id===Q.id,Ie=oe.ownerId===F,se=e.players.find(be=>be.id===F),Re=e.players.find(be=>be.id===oe.ownerId),Pe=(se==null?void 0:se.teamId)!==void 0&&(Re==null?void 0:Re.teamId)!==void 0&&se.teamId===Re.teamId;!le&&(Ie||Pe)&&J({row:ge,col:de},1)}}u(_e,Ue,!1,Be)}else(te==="SCORE_LINE"||!te)&&(P(Ye,xe,Xe,Ve,F),L.skipNextPhase||z());setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY)}if(G==="SELECT_DIAGONAL"&&L.actionType==="SCORE_DIAGONAL"){const Ye=(Q==null?void 0:Q.ownerId)??((lt=e.players.find(xe=>xe.id===e.activePlayerId))!=null&&lt.isDummy?e.activePlayerId:t||e.activePlayerId);if(L.firstCoords){const{row:xe,col:Xe}=L.firstCoords,{row:Ve,col:te}=f;if(Math.abs(xe-Ve)!==Math.abs(Xe-te)){r(null);return}we(xe,Xe,Ve,te,Ye,L.bonusType),L.skipNextPhase||z(),r(null);return}else{r({...n,payload:{...L,firstCoords:f}});return}}},[n,e,t,P,z,r,J,u,we,S,Le,i,C]),yt=$.useCallback((f,G)=>{var Q,_e,L,Ue,Be,je,Ge,et,ct,lt,Ye,xe,Xe,Ve;if(a&&k!==null&&k!==void 0){const te={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};Rt({card:f,ownerId:f.ownerId??0,location:"board"},te,e.activePlayerId,e.players)&&a.type==="Aim"&&(I({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Aim",count:1},{target:"board",boardCoords:G}),a.sourceCoords&&a.sourceCoords.row>=0&&u(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?o(V=>V?{...V,count:V.count-1}:null):(a.chainedAction&&Ze(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),o(null)));return}if(!D.current){if(n&&(n.mode==="SCORE_LAST_PLAYED_LINE"||n.mode==="SELECT_LINE_END")){dt(G);return}if((n==null?void 0:n.type)==="ENTER_MODE"){if(n.sourceCard&&n.sourceCard.id===f.id&&n.mode!=="SELECT_LINE_START"&&n.mode!=="INTEGRATOR_LINE_SELECT"&&n.mode!=="ZIUS_LINE_SELECT"&&n.mode!=="IP_AGENT_THREAT_SCORING"&&n.mode!=="SELECT_UNIT_FOR_MOVE"&&n.mode!=="SELECT_TARGET"&&n.mode!=="RIOT_PUSH"&&n.mode!=="RIOT_MOVE"&&n.mode!=="REVEREND_DOUBLE_EXPLOIT")return;const{mode:te,payload:F,sourceCard:V,sourceCoords:M,isDeployAbility:B,readyStatusToRemove:j,originalOwnerId:fe,recordContext:ge}=n;if(te==="SELECT_LINE_START"||te==="SELECT_LINE_END"){dt(G);return}const de=(V==null?void 0:V.ownerId)??((Q=e.players.find(oe=>oe.id===e.activePlayerId))!=null&&Q.isDummy?e.activePlayerId:t||e.activePlayerId);if(te==="SELECT_TARGET"&&F.tokenType){if(F.filter&&!F.filter(f,G.row,G.col))return;if(I({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:F.tokenType,count:F.count||1},{target:"board",boardCoords:G}),E("board",G),ge&&l({lastMovedCardCoords:G,lastMovedCardId:f.id}),F.chainedAction){const oe={...F.chainedAction,sourceCard:F.chainedAction.sourceCard??f,sourceCoords:F.chainedAction.sourceCoords??G,isDeployAbility:B,recordContext:!0};Ze(oe,G),setTimeout(()=>E("board",G),100),oe.type!=="ENTER_MODE"&&r(null)}else M&&M.row>=0&&u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="OPEN_COUNTER_MODAL"){if(F.filter&&!F.filter(f))return;p({card:f,callbackAction:F.rewardType}),r(null);return}if(te==="SELECT_TARGET"&&F.actionType==="SACRIFICE_AND_BUFF_LINES"){if(F.filter&&!F.filter(f,G.row,G.col))return;I({card:f,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"discard",playerId:f.ownerId});const oe=e.board.length,{row:le,col:Ie}=G;for(let se=0;se<oe;se++){if(se===Ie)continue;const Pe=e.board[le][se].card;Pe&&(Pe.ownerId===de||((_e=e.players.find(be=>be.id===de))==null?void 0:_e.teamId)!==void 0&&((L=e.players.find(be=>be.id===Pe.ownerId))==null?void 0:L.teamId)===((Ue=e.players.find(be=>be.id===de))==null?void 0:Ue.teamId))&&J({row:le,col:se},1)}for(let se=0;se<oe;se++){if(se===le)continue;const Pe=e.board[se][Ie].card;Pe&&(Pe.ownerId===de||((Be=e.players.find(be=>be.id===de))==null?void 0:Be.teamId)!==void 0&&((je=e.players.find(be=>be.id===Pe.ownerId))==null?void 0:je.teamId)===((Ge=e.players.find(be=>be.id===de))==null?void 0:Ge.teamId))&&J({row:se,col:Ie},1)}M&&M.row>=0&&u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="REVEREND_DOUBLE_EXPLOIT"){if(!de)return;const oe=de,le=(f.statuses||[]).filter(Ie=>Ie.type==="Exploit"&&Ie.addedByPlayerId===oe).length;for(let Ie=0;Ie<le;Ie++)I({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Exploit",count:1},{target:"board",boardCoords:G});M&&M.row>=0&&u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="DESTROY"){if(F.handOnly||F.filter&&!F.filter(f,G.row,G.col))return;if(((et=f.statuses)==null?void 0:et.some(le=>le.type==="Shield"))?re(G,"Shield"):I({card:f,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"discard",playerId:f.ownerId}),F.chainedAction){const le={...F.chainedAction,sourceCard:V,sourceCoords:M,isDeployAbility:B};Ze(le,M),le.type!=="ENTER_MODE"&&r(null)}else M&&M.row>=0&&u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="DRAW_EQUAL_POWER"){if(F.filter&&!F.filter(f))return;const oe=Math.max(0,f.power+(f.powerModifier||0));for(let le=0;le<oe;le++)y(de);setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="SCORE_EQUAL_POWER"){if(F.filter&&!F.filter(f))return;const oe=Math.max(0,f.power+(f.powerModifier||0));M&&Le({row:M.row,col:M.col,text:`+${oe}`,playerId:de}),S(de,oe),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="RESET_DEPLOY"){if(F.filter&&!F.filter(f))return;he(G),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="SHIELD_AND_REMOVE_AIM"){if(F.filter&&!F.filter(f))return;ne(G,"Shield",de),Fe(G,"Aim"),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="SELECT_TARGET"&&F.actionType==="MODIFY_POWER"){if(F.filter&&!F.filter(f))return;F.amount&&J(G,F.amount),M&&M.row>=0&&u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="RIOT_PUSH"&&M&&M.row>=0){if(G.row===M.row&&G.col===M.col){u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}const oe=Math.abs(G.row-M.row)+Math.abs(G.col-M.col)===1,le=e.players.find(ft=>ft.id===f.ownerId),Ie=e.players.find(ft=>ft.id===de),se=(le==null?void 0:le.teamId)!==void 0&&(Ie==null?void 0:Ie.teamId)!==void 0&&le.teamId===Ie.teamId;if(!oe||f.ownerId===de||se)return;const Re=G.row-M.row,Pe=G.col-M.col,be=G.row+Re,st=G.col+Pe,ut=e.board.length,it=Math.floor((ut-e.activeGridSize)/2),wt=it,pt=it+e.activeGridSize-1;if(be<wt||be>pt||st<wt||st>pt||e.board[be][st].card!==null)return;I({card:f,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:be,col:st}}),r({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:V,sourceCoords:M,isDeployAbility:B,payload:{vacatedCoords:G}});return}if(te==="SWAP_POSITIONS"&&M&&M.row>=0){const oe=e.board[M.row][M.col].card;if(!oe||oe.id!==(V==null?void 0:V.id)){r(null);return}if(V&&V.id===f.id||F.filter&&!F.filter(f,G.row,G.col))return;T(M,G),u(G,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="TRANSFER_STATUS_SELECT"&&M&&M.row>=0){if(V&&V.id===f.id||F.filter&&!F.filter(f,G.row,G.col))return;f.statuses&&f.statuses.length>0&&(N(G,M,f.statuses[0].type),u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY));return}if(te==="TRANSFER_ALL_STATUSES"&&M&&M.row>=0){if(V&&V.id===f.id||F.filter&&!F.filter(f,G.row,G.col))return;w(G,M),u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="REVEAL_ENEMY"){if(V&&V.id===f.id||F.filter&&!F.filter(f,G.row,G.col))return;o({type:"Revealed",count:1,isDragging:!1,sourceCoords:M,sourceCard:V,originalOwnerId:fe,targetOwnerId:f.ownerId,onlyFaceDown:!0,onlyOpponents:!0,isDeployAbility:B,readyStatusToRemove:j}),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="CENSOR_SWAP"&&M&&M.row>=0){if(F.filter&&!F.filter(f))return;ye(G,"Exploit",de),ne(G,"Stun",de),u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="ZEALOUS_WEAKEN"&&M&&M.row>=0){if(F.filter&&!F.filter(f))return;J(G,-1),u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="CENTURION_BUFF"&&M&&M.row>=0){u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="SELECT_UNIT_FOR_MOVE"&&M&&M.row>=0){if(F.filter&&!F.filter(f))return;r({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:f,sourceCoords:G,isDeployAbility:B,recordContext:ge,originalOwnerId:de??void 0,payload:{allowSelf:!1,abilitySourceCoords:M,range:F.range,chainedAction:F.chainedAction,originalActorId:de??void 0}});return}if(te==="SELECT_UNIT_FOR_MOVE"&&!M){if(F.filter&&!F.filter(f))return;r({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:f,sourceCoords:G,recordContext:ge,originalOwnerId:de??void 0,payload:{allowSelf:!1,range:F.range,chainedAction:F.chainedAction,originalActorId:de??void 0}});return}if(te==="INTEGRATOR_LINE_SELECT"&&M&&M.row>=0){if(G.row!==M.row&&G.col!==M.col)return;const oe=e.board.length;let le=0;if(G.row===M.row)for(let Ie=0;Ie<oe;Ie++){const se=e.board[G.row][Ie];se.card&&(le+=((ct=se.card.statuses)==null?void 0:ct.filter(Re=>Re.type==="Exploit"&&Re.addedByPlayerId===de).length)||0)}else for(let Ie=0;Ie<oe;Ie++){const se=e.board[Ie][G.col];se.card&&(le+=((lt=se.card.statuses)==null?void 0:lt.filter(Re=>Re.type==="Exploit"&&Re.addedByPlayerId===de).length)||0)}le>0&&(Le({row:M.row,col:M.col,text:`+${le}`,playerId:de}),S(de,le)),u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="IP_AGENT_THREAT_SCORING"&&M&&M.row>=0){if(G.row!==M.row&&G.col!==M.col)return;const oe=e.board.length;let le=0;if(G.row===M.row)for(let se=0;se<oe;se++){const Re=e.board[G.row][se];Re.card&&(le+=((Ye=Re.card.statuses)==null?void 0:Ye.filter(Pe=>Pe.type==="Threat"&&Pe.addedByPlayerId===de).length)||0)}else for(let se=0;se<oe;se++){const Re=e.board[se][G.col];Re.card&&(le+=((xe=Re.card.statuses)==null?void 0:xe.filter(Pe=>Pe.type==="Threat"&&Pe.addedByPlayerId===de).length)||0)}const Ie=le*2;Ie>0&&(Le({row:M.row,col:M.col,text:`+${Ie}`,playerId:de}),S(de,Ie)),u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(te==="ZIUS_LINE_SELECT"&&M&&M.row>=0){if(G.row!==M.row&&G.col!==M.col)return;const oe=e.board.length;let le=0;const Ie=[];if(G.row===M.row)for(let se=0;se<oe;se++){const Re=e.board[G.row][se];if(Re.card){const Pe=((Xe=Re.card.statuses)==null?void 0:Xe.filter(be=>be.type==="Exploit"&&be.addedByPlayerId===de).length)||0;Pe>0&&(le+=Pe,Ie.push({row:G.row,col:se,text:`+${Pe}`,playerId:de,timestamp:Date.now()}))}}else for(let se=0;se<oe;se++){const Re=e.board[se][G.col];if(Re.card){const Pe=((Ve=Re.card.statuses)==null?void 0:Ve.filter(be=>be.type==="Exploit"&&be.addedByPlayerId===de).length)||0;Pe>0&&(le+=Pe,Ie.push({row:se,col:G.col,text:`+${Pe}`,playerId:de,timestamp:Date.now()}))}}le>0&&(Le(Ie),S(de,le)),u(M,B,!1,j),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}return}!n&&!a&&bt(f,G)}},[n,a,e,t,D,dt,I,u,r,o,k,re,ye,ne,J,T,N,w,S,y,bt,p,he,Fe,Ze,l,Le,E,Rt]),Ce=$.useCallback(f=>{var et,ct,lt,Ye,xe,Xe,Ve,te;if(D.current||(n==null?void 0:n.type)!=="ENTER_MODE")return;const{mode:G,sourceCoords:Q,sourceCard:_e,payload:L,isDeployAbility:Ue,readyStatusToRemove:Be,recordContext:je}=n;if(G==="SCORE_LAST_PLAYED_LINE"||G==="SELECT_LINE_END"){dt(f);return}if(G==="SELECT_LINE_START"){dt(f);return}if(G==="SELECT_DIAGONAL"){dt(f);return}const Ge=(_e==null?void 0:_e.ownerId)??((et=e.players.find(F=>F.id===e.activePlayerId))!=null&&et.isDummy?e.activePlayerId:t||e.activePlayerId);if(G==="PATROL_MOVE"&&Q&&_e&&Q.row>=0){const F=f.row===Q.row,V=f.col===Q.col;if(f.row===Q.row&&f.col===Q.col){u(Q,Ue,!1,Be),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}(F||V)&&(u(Q,Ue,!1,Be),I({card:_e,source:"board",boardCoords:Q},{target:"board",boardCoords:f}),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY));return}if(G==="RIOT_MOVE"&&Q&&_e&&L.vacatedCoords){if(f.row===L.vacatedCoords.row&&f.col===L.vacatedCoords.col){I({card:_e,source:"board",boardCoords:Q},{target:"board",boardCoords:f}),u(f,Ue,!1,Be),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}u(Q,Ue,!1,Be),r(null);return}if(G==="SPAWN_TOKEN"&&Q&&L.tokenName&&Q.row>=0){if(Math.abs(f.row-Q.row)+Math.abs(f.col-Q.col)===1){const V=(_e==null?void 0:_e.ownerId)??Ge;A(f,L.tokenName,V),u(Q,Ue,!1,Be),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY)}return}if(G==="SELECT_CELL"&&_e){const F=(()=>{var M;if(L.moveFromHand)return null;if(Q&&Q.row>=0)return Q;for(let B=0;B<e.board.length;B++)for(let j=0;j<e.board.length;j++)if(((M=e.board[B][j].card)==null?void 0:M.id)===_e.id)return{row:B,col:j};return null})();if(L.moveFromHand&&i.selectedHandCard){const{playerId:M,cardIndex:B}=i.selectedHandCard,j=e.players.find(ge=>ge.id===M),fe=j==null?void 0:j.hand[B];fe&&(I({card:fe,source:"hand",playerId:M,cardIndex:B,isManual:!0},{target:"board",boardCoords:f}),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY));return}let V=!1;if(F)if(L.range==="line")V=f.row===F.row||f.col===F.col;else if(L.range==="global")V=!0;else if(L.range===2){const M=Math.abs(f.row-F.row)+Math.abs(f.col-F.col);if(M===1)V=!0;else if(M===2){const B=F.row,j=F.col,fe=f.row,ge=f.col;V=[{r:fe,c:j},{r:B,c:ge},{r:(B+fe)/2,c:(j+ge)/2}].some(oe=>{if(!Number.isInteger(oe.r)||!Number.isInteger(oe.c))return!1;const le=Math.floor((e.board.length-e.activeGridSize)/2),Ie=le,se=le+e.activeGridSize-1;return oe.r<Ie||oe.r>se||oe.c<Ie||oe.c>se||Math.abs(oe.r-B)+Math.abs(oe.c-j)!==1?!1:!e.board[oe.r][oe.c].card})}}else V=Math.abs(f.row-F.row)+Math.abs(f.col-F.col)===1;if(V&&F){const M=L.allowSelf&&f.row===F.row&&f.col===F.col;if(!M){const B=e.board[F.row][F.col].card;B&&I({card:B,source:"board",boardCoords:F,bypassOwnershipCheck:!0},{target:"board",boardCoords:f})}if(je&&l({lastMovedCardCoords:f,lastMovedCardId:_e.id}),L.chainedAction){const B={...L.chainedAction};B.targetOwnerId===-2&&(B.targetOwnerId=_e.ownerId),je&&(B.payload||(B.payload={}),B.payload._tempContextId=_e.id),r(null),ot(),setTimeout(()=>{Ze(B,f)},1)}else{if(L.abilitySourceCoords)u(L.abilitySourceCoords,Ue,!1,Be);else{const B=M?Q:f;B&&B.row>=0&&(L.originalActorId===void 0||_e.ownerId===L.originalActorId)&&u(B,Ue,!1,Be)}setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY)}return}return}if(G==="IMMUNIS_RETRIEVE"&&Q&&Q.row>=0){if(L.selectedCardIndex!==void 0&&((ct=L.filter)!=null&&ct.call(L,f.row,f.col))){R(Ge,L.selectedCardIndex,f),u(Q,Ue,!1,Be),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(L.selectedCardIndex===void 0)return}if(G==="INTEGRATOR_LINE_SELECT"&&Q&&Q.row>=0){if(f.row!==Q.row&&f.col!==Q.col)return;const F=e.board.length;let V=0;if(f.row===Q.row)for(let M=0;M<F;M++){const B=e.board[f.row][M];B.card&&(V+=((lt=B.card.statuses)==null?void 0:lt.filter(j=>j.type==="Exploit"&&j.addedByPlayerId===Ge).length)||0)}else for(let M=0;M<F;M++){const B=e.board[M][f.col];B.card&&(V+=((Ye=B.card.statuses)==null?void 0:Ye.filter(j=>j.type==="Exploit"&&j.addedByPlayerId===Ge).length)||0)}V>0&&(Le({row:Q.row,col:Q.col,text:`+${V}`,playerId:Ge}),S(Ge,V)),u(Q,Ue,!1,Be),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(G==="ZIUS_LINE_SELECT"&&Q&&Q.row>=0){if(f.row!==Q.row&&f.col!==Q.col)return;const F=e.board.length;let V=0;const M=[];if(f.row===Q.row)for(let B=0;B<F;B++){const j=e.board[f.row][B];if(j.card){const fe=((xe=j.card.statuses)==null?void 0:xe.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===Ge).length)||0;fe>0&&(V+=fe,M.push({row:f.row,col:B,text:`+${fe}`,playerId:Ge,timestamp:Date.now()}))}}else for(let B=0;B<F;B++){const j=e.board[B][f.col];if(j.card){const fe=((Xe=j.card.statuses)==null?void 0:Xe.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===Ge).length)||0;fe>0&&(V+=fe,M.push({row:B,col:f.col,text:`+${fe}`,playerId:Ge,timestamp:Date.now()}))}}V>0&&(Le(M),S(Ge,V)),u(Q,Ue,!1,Be),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}if(G==="IP_AGENT_THREAT_SCORING"&&Q&&Q.row>=0){if(f.row!==Q.row&&f.col!==Q.col)return;const F=e.board.length;let V=0;if(f.row===Q.row)for(let B=0;B<F;B++){const j=e.board[f.row][B];j.card&&(V+=((Ve=j.card.statuses)==null?void 0:Ve.filter(fe=>fe.type==="Threat"&&fe.addedByPlayerId===Ge).length)||0)}else for(let B=0;B<F;B++){const j=e.board[B][f.col];j.card&&(V+=((te=j.card.statuses)==null?void 0:te.filter(fe=>fe.type==="Threat"&&fe.addedByPlayerId===Ge).length)||0)}const M=V*2;M>0&&(Le({row:Q.row,col:Q.col,text:`+${M}`,playerId:Ge}),S(Ge,M)),u(Q,Ue,!1,Be),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY);return}},[D,n,e,t,dt,I,u,r,A,l,R,S,i,Ze,Le,ot]),tt=$.useCallback((f,G,Q)=>{var _e;if(!D.current){if(a&&k!==null&&k!==void 0){const L={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};if(Rt({card:G,ownerId:f.id,location:"hand"},L,e.activePlayerId,e.players)&&a.type==="Revealed"){const Be=((_e=a.sourceCard)==null?void 0:_e.ownerId)??e.activePlayerId??t??1;G.statuses||(G.statuses=[]),G.statuses.some(Ge=>Ge.type==="Revealed"&&Ge.addedByPlayerId===Be)||(G.statuses.push({type:"Revealed",addedByPlayerId:Be}),I({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:f.id,cardIndex:Q}),a.sourceCoords&&a.sourceCoords.row>=0&&u(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?o(Ge=>Ge?{...Ge,count:Ge.count-1}:null):(a.chainedAction&&Ze(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),o(null)))}return}if((n==null?void 0:n.type)==="ENTER_MODE"&&n.mode==="SELECT_TARGET"){const{payload:L,sourceCoords:Ue,isDeployAbility:Be,sourceCard:je,readyStatusToRemove:Ge}=n;if(Oe(f.id,Q,e.activePlayerId??t??1),L.actionType==="SELECT_HAND_FOR_DEPLOY"){if(L.filter&&!L.filter(G))return;l(et=>({...et,selectedHandCard:{playerId:f.id,cardIndex:Q}})),r({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:G,payload:{range:"global",moveFromHand:!0}});return}if(L.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(L.filter&&!L.filter(G)||f.id!==(je==null?void 0:je.ownerId))return;I({card:G,source:"hand",playerId:f.id,cardIndex:Q,bypassOwnershipCheck:!0},{target:"discard",playerId:f.id}),r({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:je,sourceCoords:Ue,isDeployAbility:Be,payload:{tokenName:L.tokenName}});return}if(L.actionType==="LUCIUS_SETUP"){if(f.id!==(je==null?void 0:je.ownerId))return;I({card:G,source:"hand",playerId:f.id,cardIndex:Q,bypassOwnershipCheck:!0},{target:"discard",playerId:f.id}),Ze({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:je,sourceCoords:Ue,isDeployAbility:Be,payload:{filterType:"Command"}},Ue||{row:-1,col:-1}),r(null);return}if(L.actionType==="DESTROY"){if(L.filter&&!L.filter(G))return;I({card:G,source:"hand",playerId:f.id,cardIndex:Q,bypassOwnershipCheck:!0},{target:"discard",playerId:f.id}),Ue&&Ue.row>=0&&u(Ue,Be,!1,Ge),setTimeout(()=>r(null),Ae.MODE_CLEAR_DELAY)}}}},[D,n,I,u,r,l,Ze,e,t,Oe,a,o,k]),mt=$.useCallback((f,G)=>{n||a||D.current||e.isGameStarted&&e.activePlayerId===f.id&&Cr(G,e.currentPhase,e.activePlayerId,e)&&bt(G,{row:-1,col:-1})},[n,a,D,e,bt]);return{activateAbility:bt,executeAction:Ze,handleLineSelection:dt,handleBoardCardClick:yt,handleEmptyCellClick:Ce,handleHandCardClick:tt,handleAnnouncedCardDoubleClick:mt}},wr=(e,t,n,r,a)=>{const o=(n.baseId||e.split("_")[1]||e).toLowerCase(),i=t===-1,l=[];o==="overwatch"?i?l.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:n}):t===0?l.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},targetOwnerId:-1,onlyOpponents:!0,sourceCard:n}):t===1&&l.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:a,baseCount:0}},sourceCard:n}):o==="tacticalmaneuver"?t===0?l.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:n,payload:{range:"line",filter:m=>m.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:n}}}):t===1&&l.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:n,payload:{range:"line",filter:m=>m.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:n}}}):o==="inspiration"?i&&l.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"OPEN_COUNTER_MODAL",filter:m=>m.ownerId===a}}):o==="datainterception"?i?l.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:n}):t===0?l.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:n}):t===1&&l.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:2,filter:m=>{var E;return((E=m.statuses)==null?void 0:E.some(k=>k.type==="Exploit"&&k.addedByPlayerId===a))||!1}}}):o==="falseorders"?i?l.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:n,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):t===0?l.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:n,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:a,sourceCard:n,originalOwnerId:n.ownerId}}}):t===1&&l.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:n,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:a}}}}):o==="experimentalstimulants"?t===0?l.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"RESET_DEPLOY",filter:m=>{var E;return m.ownerId===a&&((E=m.types)==null?void 0:E.includes("Unit"))}}}):t===1&&l.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:"line",filter:m=>m.ownerId===a}}):o==="logisticschain"?t===0?l.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:n,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):t===1&&l.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:n,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):o==="quickresponseteam"?t===0?l.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:m=>{var E;return m.ownerId===a&&((E=m.types)==null?void 0:E.includes("Unit"))}}}):t===1&&l.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:n,payload:{filterType:"Unit"}}):o==="temporaryshelter"?t===0?l.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):t===1&&l.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:n,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):o==="enhancedinterrogation"?i?l.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:n}):t===0?l.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:n}):t===1&&l.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:2,filter:m=>{var E;return((E=m.statuses)==null?void 0:E.some(k=>k.type==="Aim"&&k.addedByPlayerId===a))||!1}}}):(o==="mobilization1"||o==="linebreach")&&i&&l.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:n,payload:{actionType:"SCORE_LINE"}});const c=n.ownerId||a;return l.forEach(m=>{m.originalOwnerId=c,m.sourceCard&&!m.sourceCard.ownerId&&(m.sourceCard.ownerId=c)}),l},Ms=({gameState:e,localPlayerId:t,setActionQueue:n,setCommandContext:r,setCommandModalCard:a,setCounterSelectionData:o,moveItem:i,updatePlayerScore:l,updateState:c})=>{const m=$.useCallback((p,D)=>{if(t===null)return;const v=e.players.find(O=>O.id===D.playerId);if(!(D.playerId===t||(v==null?void 0:v.isDummy)))return;i(D,{target:"announced",playerId:D.playerId}),r({});const I=(p.baseId||p.id.split("_")[1]||p.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(O=>I.includes(O)))a(p);else{const O=wr(p.id,-1,p,e,D.playerId);O.length>0?n([...O,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:p,ownerId:D.playerId},sourceCard:p}]):n([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:p,ownerId:D.playerId},sourceCard:p}])}},[e,t,i,n,r,a]),E=$.useCallback((p,D)=>{var S,u;if(!D||t===null)return;const v=D.ownerId||t,C=[],I=wr(D.id,-1,D,e,v);let y;(S=D.baseId)!=null&&S.toLowerCase().includes("inspiration")&&(y=p===0?"DRAW_REMOVED":"SCORE_REMOVED",I.length>0&&I[0].type==="ENTER_MODE"&&(I[0]={...I[0],payload:{...I[0].payload,rewardType:y}})),I.forEach(b=>{C.push(b)}),wr(D.id,p,D,e,v).forEach(b=>{C.push(b)}),(u=D.baseId)!=null&&u.toLowerCase().includes("inspiration")||C.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:D,ownerId:v},sourceCard:D}),n(C),a(null)},[e,t,n,a]),k=$.useCallback((p,D)=>{var y;if(t===null)return;const v=D.card.ownerId||t;let C=null;for(let O=0;O<e.board.length;O++){for(let S=0;S<e.board[O].length;S++)if(((y=e.board[O][S].card)==null?void 0:y.id)===D.card.id){C={row:O,col:S};break}if(C)break}if(!C){d.warn(`Card ${D.card.id} not found on board during counter removal`),o(null);return}if(c(O=>{if(!O.isGameStarted)return O;const S=He(O),u=S.board[C.row][C.col].card;let b=0;const T=(u==null?void 0:u.statuses)??[];if(Object.entries(p).forEach(([N,w])=>{for(let R=0;R<w;R++){const A=T.map(P=>P.type).lastIndexOf(N);A>-1&&(u!=null&&u.statuses)&&(u.statuses.splice(A,1),b++)}}),!(u!=null&&u.statuses)&&u&&(u.statuses=[]),S.board=at(S),b>0&&D.callbackAction==="DRAW_REMOVED"){const N=S.players.find(w=>w.id===v);if(N){const w=Math.min(b,N.deck.length);for(let R=0;R<w;R++){const A=N.deck.shift();A&&N.hand.push(A)}}}return S}),D.callbackAction==="SCORE_REMOVED"){const O=Object.values(p).reduce((S,u)=>S+u,0);O>0&&l(v,O)}const I=e.players.find(O=>O.id===v);I!=null&&I.announcedCard&&n([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:I.announcedCard,ownerId:v},sourceCard:I.announcedCard}]),o(null)},[t,l,n,o,e,c]);return{playCommandCard:m,handleCommandConfirm:E,handleCounterSelectionConfirm:k}},Gs=({gameState:e,localPlayerId:t,handleDrop:n,markAbilityUsed:r,requestCardReveal:a,interactionLock:o,setCommandContext:i,onAction:l,cursorStack:c,setCursorStack:m,setAbilityMode:E,triggerTargetSelection:k})=>{const p=$.useRef(null),D=$.useRef({x:0,y:0});return $.useLayoutEffect(()=>{if(c&&p.current){const{x:C,y:I}=D.current;p.current.style.transform=`translate(${C-24}px, ${I-24}px)`}},[c]),$.useEffect(()=>{const C=I=>{D.current={x:I.clientX,y:I.clientY},p.current&&(p.current.style.transform=`translate(${I.clientX-24}px, ${I.clientY-24}px)`)};return window.addEventListener("mousemove",C),()=>window.removeEventListener("mousemove",C)},[]),$.useEffect(()=>{const C=I=>{var u,b,T,N,w,R,A,P;if(I.button!==0||!c)return;const y=document.elementFromPoint(I.clientX,I.clientY);let O=t;if(c.originalOwnerId!==void 0)O=c.originalOwnerId;else if((u=c.sourceCard)!=null&&u.ownerId)O=c.sourceCard.ownerId;else if(c.sourceCoords&&c.sourceCoords.row>=0){const{row:z,col:J}=c.sourceCoords;if(z>=0&&z<e.board.length&&J>=0&&J<((b=e.board[z])==null?void 0:b.length)){const ne=e.board[z][J].card;ne&&(O=ne.ownerId||t)}}else if(e.activePlayerId){const z=e.players.find(J=>J.id===e.activePlayerId);z!=null&&z.isDummy&&(O=z.id)}let S=y==null?void 0:y.closest("[data-hand-card]");if(!S&&y)if(y.getAttribute("data-hand-card"))S=y;else{const z=y.querySelectorAll("[data-hand-card]");if(z.length>0){let J=1/0,ne=null;const re=I.clientX,ye=I.clientY;for(const he of Array.from(z)){const we=he.getBoundingClientRect();if(re>=we.left&&re<=we.right&&ye>=we.top&&ye<=we.bottom){const Fe=we.left+we.width/2,Le=we.top+we.height/2,Oe=Math.hypot(re-Fe,ye-Le);Oe<J&&(J=Oe,ne=he)}}S=ne}}if(S){const z=S.getAttribute("data-hand-card");if(z){const[J,ne]=z.split(","),re=parseInt(J,10),ye=parseInt(ne,10),he=e.players.find(Fe=>Fe.id===re),we=he==null?void 0:he.hand[ye];if(he&&we){if(c.type==="Revealed"&&!he.isDummy){if((T=we.statuses)==null?void 0:T.some(ae=>ae.type==="Revealed"&&ae.addedByPlayerId===O))return;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:c.originalOwnerId??((N=c.sourceCard)==null?void 0:N.ownerId)??O??void 0,statusType:c.type,count:1},{target:"hand",playerId:re,cardIndex:ye,boardCoords:void 0}),c.sourceCoords&&c.sourceCoords.row>=0&&r(c.sourceCoords,c.isDeployAbility),c.count>1?m(ae=>ae?{...ae,count:ae.count-1}:null):(c.chainedAction&&l(c.chainedAction,c.sourceCoords||{row:-1,col:-1}),m(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}const Le={targetOwnerId:c.targetOwnerId,excludeOwnerId:c.excludeOwnerId,onlyOpponents:c.onlyOpponents||c.targetOwnerId===-1,onlyFaceDown:c.onlyFaceDown,targetType:c.targetType,requiredTargetStatus:c.requiredTargetStatus,tokenType:c.type};if(!Rt({card:we,ownerId:re,location:"hand"},Le,O,e.players))return;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:c.originalOwnerId??((w=c.sourceCard)==null?void 0:w.ownerId),statusType:c.type,replaceStatusType:c.replaceStatus?c.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:re,cardIndex:ye,boardCoords:void 0}),c.sourceCoords&&c.sourceCoords.row>=0&&r(c.sourceCoords,c.isDeployAbility),c.count>1?m(ot=>ot?{...ot,count:ot.count-1}:null):(c.chainedAction&&l(c.chainedAction,c.sourceCoords||{row:-1,col:-1}),m(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}}if(!S){const z=y==null?void 0:y.closest("[data-board-coords]");if(z){const J=z.getAttribute("data-board-coords");if(J){const[ne,re]=J.split(","),ye=parseInt(ne,10),he=parseInt(re,10);if(!isNaN(ye)&&!isNaN(he)&&ye>=0&&ye<e.board.length&&e.board[ye]&&he>=0&&he<e.board[ye].length&&e.board[ye][he]){const we=e.board[ye][he].card;if((we==null?void 0:we.ownerId)!==void 0){const Fe={targetOwnerId:c.targetOwnerId,excludeOwnerId:c.excludeOwnerId,onlyOpponents:c.onlyOpponents||c.targetOwnerId===-1,onlyFaceDown:c.onlyFaceDown,targetType:c.targetType,requiredTargetStatus:c.requiredTargetStatus,mustBeAdjacentToSource:c.mustBeAdjacentToSource,mustBeInLineWithSource:c.mustBeInLineWithSource,sourceCoords:c.sourceCoords,tokenType:c.type};if(!Rt({card:we,ownerId:we.ownerId,location:"board",boardCoords:{row:ye,col:he}},Fe,O,e.players))return;const Oe=e.players.find(ot=>ot.id===we.ownerId);if(c.type==="Revealed"&&!(Oe!=null&&Oe.isDummy)){if((R=we.statuses)==null?void 0:R.some(ae=>ae.type==="Revealed"&&ae.addedByPlayerId===O))return;we.isFaceDown?t!==null&&a({source:"board",ownerId:we.ownerId,boardCoords:{row:ye,col:he}},t):(n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:c.originalOwnerId??((A=c.sourceCard)==null?void 0:A.ownerId)??O??void 0,statusType:c.type,count:1},{target:"board",boardCoords:{row:ye,col:he}}),k("board",{row:ye,col:he})),c.sourceCoords&&c.sourceCoords.row>=0&&r(c.sourceCoords,c.isDeployAbility),c.count>1?m(ae=>ae?{...ae,count:ae.count-1}:null):(c.chainedAction&&l(c.chainedAction,c.sourceCoords||{row:-1,col:-1}),m(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}if(we){const Fe=c.placeAllAtOnce?c.count:1;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:c.originalOwnerId??((P=c.sourceCard)==null?void 0:P.ownerId),statusType:c.type,replaceStatusType:c.replaceStatus?c.requiredTargetStatus:void 0,count:Fe},{target:"board",boardCoords:{row:ye,col:he}}),k("board",{row:ye,col:he}),c.recordContext&&i(Oe=>({...Oe,lastMovedCardCoords:{row:ye,col:he},lastMovedCardId:we.id})),c.sourceCoords&&c.sourceCoords.row>=0&&r(c.sourceCoords,c.isDeployAbility);const Le=c.count-Fe;if(Le>0)m(Oe=>Oe?{...Oe,count:Le}:null);else{if(c.chainedAction){const Oe={...c.chainedAction};c.recordContext&&(Oe.mode==="SELECT_CELL"&&(Oe.sourceCard=we,Oe.sourceCoords={row:ye,col:he},Oe.recordContext=!0),Oe.type==="GLOBAL_AUTO_APPLY"&&(Oe.sourceCoords={row:ye,col:he}),Oe.type==="CREATE_STACK"&&(Oe.sourceCoords={row:ye,col:he},Oe.originalOwnerId||(Oe.sourceCard=we)),Oe.mode==="ZIUS_LINE_SELECT"&&(Oe.sourceCoords={row:ye,col:he})),Oe.type==="CREATE_STACK"&&E(null),l(Oe,{row:ye,col:he})}m(null)}o.current=!0,setTimeout(()=>{o.current=!1},300)}}}}else{const J=y==null?void 0:y.closest(".counter-modal-content"),ne=(y==null?void 0:y.closest("[data-board-coords]"))!==null,re=(y==null?void 0:y.closest("[data-hand-card]"))!==null;c.isDragging?J?m(ye=>ye?{...ye,isDragging:!1}:null):!ne&&!re&&m(null):!J&&!ne&&!re&&m(null)}}};return window.addEventListener("mouseup",C),()=>{window.removeEventListener("mouseup",C)}},[c,n,e,t,a,r,o,i,l,m,E,k]),$.useEffect(()=>{const C=I=>{c&&(I.preventDefault(),m(null))};return window.addEventListener("contextmenu",C),()=>{window.removeEventListener("contextmenu",C)}},[c,m]),{cursorFollowerRef:p,handleCounterMouseDown:(C,I)=>{D.current={x:I.clientX,y:I.clientY},m(y=>(y==null?void 0:y.type)===C?{type:C,count:y.count+1,isDragging:!0,sourceCoords:y.sourceCoords}:{type:C,count:1,isDragging:!0})}}};export{Rs as A,Ns as B,Ms as C,ms as D,Ls as E,gs as F,Ts as G,Gs as H,ys as I,or as J,wr as K,Rt as L,uo as M,er as N,vr as O,ws as P,hs as Q,lo as R,Cs as S,Ae as T,xt as a,qe as b,Hn as c,fo as d,As as e,Is as f,It as g,Eo as h,io as i,Ds as j,Ar as k,d as l,Qe as m,_s as n,co as o,po as p,Es as q,Ss as r,bs as s,so as t,ks as u,vs as v,Ps as w,Os as x,Lt as y,sr as z};
