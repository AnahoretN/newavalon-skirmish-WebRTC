import{r as $,j as eo}from"./vendor-react-CfNVJRhB.js";import{$ as Vt}from"./vendor-webrtc-lnxn2S2z.js";import{d as Un,e as to}from"./vendor-BPR6uEV2.js";var ze=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(ze||{}),Sr=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(Sr||{});const ro={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253319/SYN_IP_DEPT_AGENT_mhwphu.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253342/SYN_TACTICAL_AGENT_xbb7i0.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253325/SYN_PATROL_AGENT_ioetlu.png",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253337/SYN_RIOT_AGENT_jurf4t.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253338/SYN_THREAT_ANALYST_sqnpgw.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678622/Mr._Pearl_Director_of_BioSynch_mo0cil.png",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253315/HOO_RECKLESS_PROVOCATEUR_hi7a9z.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253317/HOO_DATA_LIBERATOR_lbtqa2.png",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253309/HOO_CAUTIOUS_AVENGER_x4g4g3.png",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253311/HOO_VIGILANT_SPOTTER_eiephm.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253313/HOO_INVENTIVE_MAKER_uzrbg1.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764637482/Finn_nehk0r.png",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253324/OPT_FABER_d7uxew.png",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253321/OPT_CENSOR_wtxtc2.png",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253332/OPT_PRINCEPS_w3o5lq.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253327/OPT_IMMUNIS_bjlncl.png",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253330/OPT_CENTURION_aaushl.png",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678954/Lucius_The_Immortal_z0lemw.png",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253298/FUS_CODE_KEEPER_qotsym.png",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253305/FUS_DEVOUT_SYNTHETIC_bavg9k.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253303/FUS_UNWAVERING_INTEGRATOR_emret1.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253299/FUS_SIGNAL_PROPHET_nzd7w3.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253301/FUS_ZEALOUS_MISSIONARY_mfv9xl.png",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764678937/Reverend_of_The_Choir_vts8im.png",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253291/CMD_OVERWATCH_hrba9x.png",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253296/CMD_REPOSITIONING_m7k4kf.png",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763260942/CMD_INSPIRATION_nxifhu.png",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253290/CMD_DATA_INTERCEPTION_ks4lcv.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763640484/CMD_FALSE_ORDERS_ghi01y.png",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Experimental_Stimulants_x8ns1g.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Logistics_Chain_d4irtq.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507609/Quick_Response_Team_rw2cut.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Temporary_Shelter_o0embx.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764507610/Enhanced_Interrogation_suzvxe.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764626980/Autonomous_Battle_Robot_Gawain_uoyjm5.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Reclaimed_Gawain_sg6257.png",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764767153/Secret_informant_eb0nkm.png",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Michael_Falk_wcxjnp.png",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764623710/Edith_Byron_v6691r.png",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Pinkunoneko_nhmjfv.png",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622845/Maria_Eleftheria_Damanaki_bmx6xv.png",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764622844/Zius_cwd92f.png",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},no={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253333/TKN_RECON_DRONE_esfknf.png",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763253307/TKN_WALKING_TURRET_uq6owm.png",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},ao={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Aim_dcct45.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Exploit_foomty.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Revealed_w1gbe7.png",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478811/Stun_cwqroz.png",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/Shield_z9sjr1.png",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Support_ui9qpl.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478809/Threat_i1pbko.png",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1768321040/Resurrected_tscgk9.png",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},oo=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],cr={cardDatabase:ro,tokenDatabase:no,countersDatabase:ao,deckFiles:oo};let vn=null,Dt=new Map,wr=new Map,Ht={},er=[],_r={};const $n=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function hs(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const n=await fetch("/api/content/database");if(n.ok){const r=await n.json(),a=r.cards.map(([s,c])=>[s,c]),o=r.tokens.map(([s,c])=>[s,c]);e={cardDatabase:Object.fromEntries(a),tokenDatabase:Object.fromEntries(o),countersDatabase:Object.fromEntries(r.counters),deckFiles:r.deckFiles}}else e=cr}catch{e=cr}else e=cr;vn=e,Dt=new Map(Object.entries(e.cardDatabase)),wr=new Map(Object.entries(e.tokenDatabase)),Ht=e.countersDatabase,er=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(Ht)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(n){console.warn("Could not save counters database to localStorage:",n)}ft=vn,Hn=Dt,io=wr,Mt=Ht,co=er,_r=so(),lo=_r}catch(e){throw console.error("Failed to load content database:",e),e}}function so(){const e={};for(const t of er){const n=[];for(const r of t.cards){const a=Dt.get(r.cardId);if(!a){console.warn(`Card definition not found for ID: ${r.cardId} in deck: ${t.name}`);continue}const o=$n.has(r.cardId);for(let s=0;s<r.quantity;s++){const d=r.cardId.replace(/-/g,"--DASH--").toUpperCase();o?n.push({...a,deck:ze.Command,id:`CMD_${d}_${s+1}`,baseId:r.cardId,faction:a.faction||"Command"}):n.push({...a,deck:t.id,id:`${t.id.substring(0,3).toUpperCase()}_${d}_${s+1}`,baseId:r.cardId,faction:a.faction||t.id})}}e[t.id]=n}return e[ze.Tokens]=Array.from(wr.entries()).map(([t,n])=>{const r=n.types?[...n.types]:[];return{id:`TKN_${n.name.toUpperCase().replace(/\s/g,"_")}`,baseId:t,deck:ze.Tokens,name:n.name,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage,power:n.power,ability:n.ability,color:n.color,types:r,flavorText:n.flavorText,faction:"Tokens"}}),e}let ft=null,Hn=new Map,io=new Map,Mt={};try{const e=localStorage.getItem("counters_database");e&&(Ht=JSON.parse(e),Mt=Ht)}catch{}let co=[],lo={};const uo=$n,Is=()=>er.filter(e=>e.isSelectable);function Tt(e){return Dt.get(e)}function lr(e){return Array.from(Dt.values()).find(t=>t.name===e)}function Es(){return Array.from(Dt.entries()).map(([e,t])=>({id:e,card:t}))}function Ts(){return Dt}function Fn(){return _r}const fo=4,ms={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763478810/LastPlayed_bfkbwb.png",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1764252181/medal_rgbw8d.png"},gs={[ze.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[ze.Hoods]:{prefix:"HOO",color:"border-purple-500"},[ze.Optimates]:{prefix:"OPT",color:"border-red-500"},[ze.Fusion]:{prefix:"FUS",color:"border-green-400"},[ze.Command]:{prefix:"CMD",color:"border-yellow-500"},[ze.Tokens]:{prefix:"TKN",color:"border-gray-400"},[ze.Custom]:{prefix:"CUS",color:"border-purple-400"},[ze.Neutral]:{prefix:"NEU",color:"border-gray-400"},[ze.Random]:{prefix:"RND",color:"border-gray-400"}},ws={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},po={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},_s={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},tr=["blue","purple","red","green","yellow","orange","pink","brown"],Cs=["Setup","Main","Commit","Scoring"],Jt=()=>Object.fromEntries(Object.entries(Mt).map(([e,t])=>[e,t.imageUrl])),bs=new Proxy({},{get(e,t){return Jt()[t]},ownKeys(){return Object.keys(Jt())},has(e,t){return t in Jt()},getOwnPropertyDescriptor(e,t){const n=Jt()[t];return n!==void 0?{enumerable:!0,configurable:!0,value:n}:void 0}}),Xt=()=>Object.fromEntries(Object.entries(Mt).map(([e,t])=>[e,t.description])),Ss=new Proxy({},{get(e,t){return Xt()[t]},ownKeys(){return Object.keys(Xt())},has(e,t){return t in Xt()},getOwnPropertyDescriptor(e,t){const n=Xt()[t];return n!==void 0?{enumerable:!0,configurable:!0,value:n}:void 0}}),yo=()=>Object.entries(Mt).filter(([,e])=>!e.allowedPanels||e.allowedPanels.includes("COUNTER_PANEL")).sort(([,e],[,t])=>e.sortOrder-t.sortOrder).map(([e,t])=>({type:e,label:t.name}));yo();const zt="readyDeploy",Kt="readySetup",qt="readyCommit",Pt=(e,t,n,r)=>Math.abs(e-n)+Math.abs(t-r)===1,je=(e,t,n)=>e.statuses?e.statuses.some(r=>r.type===t&&(n===void 0||r.addedByPlayerId===n)):!1,Nt=(e,t)=>e.statuses?e.statuses.some(n=>n.type===t):!1,ho=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>je(a,"Aim",n)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"threatAnalyst",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>{let a=0;return t.board.forEach(o=>{o.forEach(s=>{var c;(c=s.card)!=null&&c.statuses&&(a+=s.card.statuses.filter(d=>d.type==="Exploit"&&d.addedByPlayerId===n).length)})}),a===0?null:{type:"CREATE_STACK",tokenType:"Revealed",count:a,onlyFaceDown:!0}}},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,t,n,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:n})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,t,n,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>{var o;return a.ownerId!==n&&((o=a.statuses)==null?void 0:o.some(s=>s.type==="Threat"))}},sourceCard:e,sourceCoords:r})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.ownerId!==n&&je(a,"Exploit",n)}})},{baseId:"centurion",activationType:"commit",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(a,o,s)=>{var c;return a.ownerId===n&&((c=a.types)==null?void 0:c.includes("Unit"))&&o!==void 0&&s!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:r,payload:{filter:(a,o,s)=>Pt(o,s,r.row,r.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.id===e.id?!1:a.ownerId===n}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:r,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>je(a,"Aim",n)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,originalOwnerId:n,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:a=>a.ownerId===n}})},{baseId:"censor",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:r,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>je(a,"Aim",n)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,t,n,r)=>je(e,"Support",n)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:r,payload:{filter:(a,o)=>Pt(a,o,r.row,r.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(a,o,s)=>Pt(o,s,r.row,r.col)&&a.ownerId!==n&&(je(a,"Threat",n)||je(a,"Stun",n))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,t,n,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:a=>a.ownerId===n&&je(a,"Support",n)},sourceCard:e,sourceCoords:r})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.ownerId===n&&je(a,"Exploit",n)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:r,payload:{filter:a=>je(a,"Exploit",n)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"MODIFY_POWER",amount:-1,filter:a=>je(a,"Aim",n)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:r,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"REVEAL_ENEMY",sourceCard:e,sourceCoords:r,payload:{filter:(a,o,s)=>Pt(o,s,r.row,r.col)&&a.ownerId!==n}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>je(a,"Aim",n)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(a,o,s)=>Pt(o,s,r.row,r.col)&&a.ownerId!==n&&(je(a,"Threat",n)||je(a,"Stun",n))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,t,n,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:n})},{baseId:"edithByron",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(a,o,s)=>Pt(o,s,r.row,r.col)&&(je(a,"Threat",n)||je(a,"Stun",n)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:a=>je(a,"Aim",n)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,t,n,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:r,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,t,n,r)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:r,ownerId:n})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"LUCIUS_SETUP",filter:a=>a.ownerId===n}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,t,n,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:a=>a.ownerId===n,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,t,n,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:r})}],Ar=e=>{const t=e.baseId||"";return ho.filter(n=>{var r;return n.baseId===t||((r=n.baseIdAlt)==null?void 0:r.includes(t))})},Io=e=>{const n=Ar(e).map(r=>r.activationType);return[...new Set(n)]},Cr=(e,t,n,r)=>{var s;if(n!==e.ownerId)return!1;if(r&&e.ownerId!==void 0){const c=r.players.find(d=>d.id===e.ownerId);if(c!=null&&c.isDummy&&r.activePlayerId!==e.ownerId)return!1}if((s=e.statuses)!=null&&s.some(c=>c.type==="Stun"))return!1;const a=Ar(e),o=t===1&&a.some(c=>c.activationType==="setup")||t===3&&a.some(c=>c.activationType==="commit");if(t===1){const c=a.find(d=>d.activationType==="setup");if(c&&Nt(e,Kt))return!(c.supportRequired&&!je(e,"Support",n))}if(t===3){const c=a.find(d=>d.activationType==="commit");if(c&&Nt(e,qt))return!(c.supportRequired&&!je(e,"Support",n))}if(!o){const c=a.find(d=>d.activationType==="deploy");if(c&&Nt(e,zt))return!(c.supportRequired&&!je(e,"Support",n))}return!1},Eo=(e,t,n,r)=>{if(n!==e.ownerId)if(e.ownerId!==void 0){const d=t.players.find(g=>g.id===e.ownerId);if(!(d!=null&&d.isDummy))return null}else return null;const a=Ar(e),o=e.ownerId??n??0,s=t.currentPhase,c=s===1&&a.some(d=>d.activationType==="setup")||s===3&&a.some(d=>d.activationType==="commit");if(s===1){const d=a.find(g=>g.activationType==="setup");if(d&&Nt(e,Kt)){if(d.supportRequired&&!je(e,"Support",o))return null;const g=d.getAction(e,t,o,r);if(g)return{...g,readyStatusToRemove:Kt}}}if(s===3){const d=a.find(g=>g.activationType==="commit");if(d&&Nt(e,qt)){if(d.supportRequired&&!je(e,"Support",o))return null;const g=d.getAction(e,t,o,r);if(g)return{...g,readyStatusToRemove:qt}}}if(!c){const d=a.find(g=>g.activationType==="deploy");if(d&&Nt(e,zt)){if(d.supportRequired&&!je(e,"Support",o))return null;const g=d.getAction(e,t,o,r);if(g)return{...g,isDeployAbility:!0,readyStatusToRemove:zt}}}return null},To=(e,t,n)=>{let r,a;return typeof t=="object"?(r=t.currentPhase,n=t.activePlayerId??void 0,a=t):r=t,Cr(e,r,n??void 0,a)},Dr=(e,t)=>{e.statuses||(e.statuses=[]);const n=e.statuses.length,r=e.statuses.map(o=>o.type),a=Io(e);console.log(`[initializeReadyStatuses] Card: ${e.name} (${e.id}), ownerId: ${t}, abilities: [${a.join(", ")}]`);for(const o of a){let s="";o==="deploy"?s=zt:o==="setup"?s=Kt:o==="commit"&&(s=qt),s&&!e.statuses.some(c=>c.type===s)&&(e.statuses.push({type:s,addedByPlayerId:t}),console.log(`[initializeReadyStatuses] Added status: ${s} to ${e.name}`))}e.statuses.length!==n&&console.log(`[initializeReadyStatuses] Card ${e.name}: statuses changed from [${r.join(", ")}] to [${e.statuses.map(o=>o.type).join(", ")}]`)},ur=e=>{e.statuses&&(e.statuses=e.statuses.filter(t=>t.type!==zt&&t.type!==Kt&&t.type!==qt))};function He(e){const t=e,n=t==null?void 0:t.targetingMode;n&&delete t.targetingMode;let r;return typeof structuredClone<"u"?r=structuredClone(e):r=JSON.parse(JSON.stringify(e)),n&&(r.targetingMode=n,t.targetingMode=n),r}const Se={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function As(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function Ds(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}function Rs(e,t){return e?po[e]:t}const Wn=$.createContext(null),Os=({children:e})=>{const[t,n]=$.useState(null),[r,a]=$.useState({}),[o,s]=$.useState("lg"),c=$.useCallback((D,v={},_="lg")=>{n(D),a(v),s(_)},[]),d=$.useCallback(()=>{n(null),a({}),s("lg")},[]),g=$.useCallback(D=>t===D,[t]),T=$.useCallback(()=>r,[r]),N=$.useCallback(()=>o,[o]),p={openModal:t,modalData:r,modalSize:o,open:c,close:d,isOpen:g,getData:T,getSize:N};return eo.jsx(Wn.Provider,{value:p,children:e})},or=()=>{const e=$.useContext(Wn);if(!e)throw new Error("useModals must be used within ModalsProvider");return e},Ps=()=>{const{open:e,close:t,isOpen:n}=or();return{isOpen:n("rules"),open:r=>e("rules",r,"full"),close:t}},ks=()=>{const{open:e,close:t,isOpen:n}=or();return{isOpen:n("settings"),open:r=>e("settings",r,"md"),close:t}},vs=()=>{const{open:e,close:t,isOpen:n,getData:r}=or();return{isOpen:n("joinGame"),open:a=>e("joinGame",a,"lg"),close:t,getData:()=>r()}},Ns=()=>{const{open:e,close:t,isOpen:n}=or();return{isOpen:n("deckBuilder"),open:r=>e("deckBuilder",r,"full"),close:t}},l={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},Ft="webrtc_game_state",Wt="webrtc_host_data",Bt="webrtc_guest_data",mo="webrtc_current_host_peerId",go=30*60*1e3;function Rr(){return Date.now()}function jt(e){return Date.now()-e<go}function wo(e){try{const t={...e,timestamp:Rr()};localStorage.setItem(Wt,JSON.stringify(t)),l.info("[WebRTC Persistence] Saved host data:",{peerId:t.peerId})}catch(t){l.error("[WebRTC Persistence] Failed to save host data:",t)}}function fr(e){try{const t={...e,timestamp:Rr()};localStorage.setItem(Bt,JSON.stringify(t)),l.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId})}catch(t){l.error("[WebRTC Persistence] Failed to save guest data:",t)}}function xt(e){try{const t={...e,timestamp:Rr()};localStorage.setItem(Ft,JSON.stringify(t)),l.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(t.timestamp).toISOString())}catch(t){l.error("[WebRTC Persistence] Failed to save game state:",t)}}function Bn(){try{const e=localStorage.getItem(Wt);if(!e)return null;const t=JSON.parse(e);return jt(t.timestamp)?(l.info("[WebRTC Persistence] Loaded valid host data:",{peerId:t.peerId}),t):(l.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(Wt),null)}catch(e){return l.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(Wt),null}}function Yn(){try{const e=localStorage.getItem(Bt);if(!e)return null;const t=JSON.parse(e);return jt(t.timestamp)?(l.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId}),t):(l.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(Bt),null)}catch(e){return l.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(Bt),null}}function Nn(){try{const e=localStorage.getItem(Ft);if(!e)return null;const t=JSON.parse(e);return jt(t.timestamp)?(l.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(t.timestamp).toISOString()),t):(l.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(Ft),null)}catch(e){return l.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(Ft),null}}function vt(){localStorage.removeItem(Ft),localStorage.removeItem(Wt),localStorage.removeItem(Bt),localStorage.removeItem(mo)}function br(e,t){try{const n=`webrtc_host_${t}`,r={peerId:e,gameId:t,timestamp:Date.now()};localStorage.setItem(n,JSON.stringify(r)),l.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${t}:`,e)}catch(n){l.error("[WebRTC Persistence] Failed to broadcast host peerId:",n)}}function pr(e){try{const t=`webrtc_host_${e}`,n=localStorage.getItem(t);if(!n)return null;const r=JSON.parse(n);return Date.now()-r.timestamp>15e3?null:{peerId:r.peerId,timestamp:r.timestamp}}catch(t){return l.error("[WebRTC Persistence] Failed to get host peerId:",t),null}}function _o(e){try{const t=`webrtc_host_${e}`;localStorage.removeItem(t),l.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(t){l.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",t)}}function Co(){const e=sessionStorage.getItem("invite_host_id"),t=sessionStorage.getItem("invite_auto_join");if(e&&t)return"none";const n=Bn();if(n&&jt(n.timestamp))return"host";const r=Yn();return r&&jt(r.timestamp)?"guest":"none"}const Ln=7,yr="mrPearlDoF",bo="reverendOfTheChoir",So="threatAnalyst";function Ao(e,t){return e!=null&&e.statuses?e.statuses.some(n=>n.type==="Exploit"&&n.addedByPlayerId!==void 0&&t.has(n.addedByPlayerId)):!1}function Do(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const zn=()=>Array(Ln).fill(null).map(()=>Array(Ln).fill(null).map(()=>({card:null}))),tt=e=>{var _,I,y,P,A;const{board:t,activeGridSize:n,players:r}=e,a=Do(t),o=a.length,s=Math.floor((o-n)/2),c=new Map;r.forEach(u=>c.set(u.id,u.teamId));for(let u=0;u<o;u++)for(let b=0;b<o;b++){const E=a[u][b].card;E&&(E.statuses&&(E.statuses=E.statuses.filter(L=>L.type!=="Support"&&L.type!=="Threat")),delete E.bonusPower)}for(let u=0;u<o;u++)for(let b=0;b<o;b++){const E=a[u][b].card;if((E==null?void 0:E.ownerId)===void 0||E.isFaceDown)continue;const L=E.ownerId,m=c.get(L),O=[{r:u-1,c:b},{r:u+1,c:b},{r:u,c:b-1},{r:u,c:b+1}],S={};let k=!1;for(const V of O){const{r:te,c:ee}=V;if(te>=0&&te<o&&ee>=0&&ee<o){const ye=a[te][ee].card,he=(_=ye==null?void 0:ye.statuses)==null?void 0:_.some(me=>me.type==="Stun");if((ye==null?void 0:ye.ownerId)!==void 0&&!ye.isFaceDown&&!he){const me=ye.ownerId,Fe=c.get(me);L===me||m!==void 0&&m===Fe?k=!0:(S[me]||(S[me]=[]),S[me].push({r:te,c:ee}))}}}k&&(E.statuses||(E.statuses=[]),E.statuses.some(V=>V.type==="Support")||E.statuses.push({type:"Support",addedByPlayerId:L}));let Y=null;for(const V in S){const te=S[V];if(te&&te.length>=2){Y=parseInt(V,10);break}}if(Y===null&&u>=s&&u<s+n&&b>=s&&b<s+n){const te=u===s||u===s+n-1||b===s||b===s+n-1,ee=Object.keys(S).length>0;if(te&&ee){const ye=Object.keys(S)[0];ye&&(Y=parseInt(ye,10))}}Y!==null&&(E.statuses||(E.statuses=[]),E.statuses.some(V=>V.type==="Threat")||E.statuses.push({type:"Threat",addedByPlayerId:Y}))}const d=new Set;for(let u=0;u<o;u++)for(let b=0;b<o;b++){const E=a[u][b].card,L=(I=E==null?void 0:E.statuses)==null?void 0:I.some(m=>m.type==="Stun");if((E==null?void 0:E.baseId)===So&&!E.isFaceDown&&E.ownerId!==void 0&&!L){const m=[{r:u-1,c:b},{r:u+1,c:b},{r:u,c:b-1},{r:u,c:b+1}];let O=!1;const S=E.ownerId,k=c.get(S);for(const Y of m){const{r:V,c:te}=Y;if(V>=0&&V<o&&te>=0&&te<o){const ee=a[V][te].card;if((ee==null?void 0:ee.ownerId)!==void 0&&!ee.isFaceDown){const ye=ee.ownerId,he=c.get(ye),me=S===ye||k!==void 0&&k===he,Fe=(y=ee==null?void 0:ee.statuses)==null?void 0:y.some(Ge=>Ge.type==="Stun");if(me&&!Fe){O=!0;break}}}}O&&d.add(S)}}for(let u=0;u<o;u++)for(let b=0;b<o;b++){const E=a[u][b].card;if(!E||E.isFaceDown||E.ownerId===void 0)continue;const L=E.ownerId,m=c.get(L),O=[{r:u-1,c:b},{r:u+1,c:b},{r:u,c:b-1},{r:u,c:b+1}],S={};for(const Y of O){const{r:V,c:te}=Y;if(V>=0&&V<o&&te>=0&&te<o){const ee=a[V][te].card,ye=(P=ee==null?void 0:ee.statuses)==null?void 0:P.some(he=>he.type==="Stun");if((ee==null?void 0:ee.ownerId)!==void 0&&!ee.isFaceDown&&!ye){const he=ee.ownerId,me=c.get(he);if(!(L===he||m!==void 0&&m===me)){const Ge=d.has(he),ve=Ao(E,d);Ge&&ve&&(S[he]||(S[he]=0),S[he]++)}}}}if(Object.keys(S).length>0){E.statuses||(E.statuses=[]);const Y=Object.keys(S).map(V=>parseInt(V,10));for(const V of Y)E.statuses.some(te=>te.type==="Threat"&&te.addedByPlayerId===V)||E.statuses.push({type:"Threat",addedByPlayerId:V})}}const g=[],T=[];for(let u=0;u<o;u++)for(let b=0;b<o;b++){const E=a[u][b].card,L=(A=E==null?void 0:E.statuses)==null?void 0:A.some(m=>m.type==="Stun");E!=null&&E.baseId&&!E.isFaceDown&&E.ownerId!==void 0&&!L&&(E.baseId===bo?g.push({r:u,c:b,ownerId:E.ownerId,baseId:E.baseId}):E.baseId===yr&&T.push({r:u,c:b,ownerId:E.ownerId,baseId:E.baseId}))}const N=new Set,p=new Set;for(const u of g){const{r:b,c:E,ownerId:L}=u,m=`${b}-${L}`;if(!N.has(m)){N.add(m);for(let S=0;S<o;S++){const k=a[b][S].card;k&&k.ownerId===L&&!k.isFaceDown&&(k.statuses||(k.statuses=[]),k.statuses.some(Y=>Y.type==="Support")||k.statuses.push({type:"Support",addedByPlayerId:L}))}}const O=`${E}-${L}`;if(!p.has(O)){p.add(O);for(let S=0;S<o;S++){const k=a[S][E].card;k&&k.ownerId===L&&!k.isFaceDown&&(k.statuses||(k.statuses=[]),k.statuses.some(Y=>Y.type==="Support")||k.statuses.push({type:"Support",addedByPlayerId:L}))}}}const D=new Set,v=new Set;for(const u of T){const{r:b,c:E,ownerId:L}=u,m=`${b}-${L}`;if(!D.has(m)){D.add(m);for(let S=0;S<o;S++){const k=a[b][S].card;k&&k.ownerId===L&&!k.isFaceDown&&k.baseId!==yr&&(k.bonusPower=(k.bonusPower||0)+1)}}const O=`${E}-${L}`;if(!v.has(O)){v.add(O);for(let S=0;S<o;S++){const k=a[S][E].card;k&&k.ownerId===L&&!k.isFaceDown&&k.baseId!==yr&&(k.bonusPower=(k.bonusPower||0)+1)}}}return a};var Rt=(e=>(e[e.CARD_REGISTRY=1]="CARD_REGISTRY",e[e.CARD_STATE=2]="CARD_STATE",e[e.ABILITY_EFFECT=3]="ABILITY_EFFECT",e[e.SESSION_EVENT=4]="SESSION_EVENT",e))(Rt||{});function Ro(){const e={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},t=new Set,n=Array.from(Hn.values());for(const r of n)if(r.baseId&&!t.has(r.baseId)){t.add(r.baseId);const a=e.cardDefinitions.length;e.baseIdToIndex.set(r.baseId,a),e.indexToBaseId.set(a,r.baseId),e.cardDefinitions.push({baseId:r.baseId,name:r.name,imageUrl:r.imageUrl,power:r.power,ability:r.ability||"",types:r.types||[],faction:r.faction||""})}return e.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],l.info(`[CardRegistry] Built registry with ${e.cardDefinitions.length} cards, ${e.statusTypes.length} status types`),e}function Kn(e,t){let n=0;for(const r of e||[]){const a=t.statusTypes.indexOf(r.type);a>=0&&a<32&&(n|=1<<a)}return n>>>0}function qn(e,t,n){const r=[];for(let a=0;a<32;a++)if(e&1<<a){const o=n.statusTypes[a];o&&r.push({type:o,addedByPlayerId:t})}return r}function jn(e){let t=0;return e.isFaceDown&&(t|=1),e.enteredThisTurn&&(t|=2),e.revealedTo==="all"&&(t|=4),t}function hr(e,t){const n=new Uint8Array(13);let r=0;const a=Or(e.id);n[r++]=a>>24&255,n[r++]=a>>16&255,n[r++]=a>>8&255,n[r++]=a&255;const o=e.baseId?t.baseIdToIndex.get(e.baseId)??0:0;n[r++]=o>>8&255,n[r++]=o&255,n[r++]=(e.ownerId??0)&255;const s=Math.round(e.power||0);n[r++]=Math.clamp(s,-128,127)&255,n[r++]=jn(e);const c=Kn(e.statuses||[],t);return n[r++]=c>>24&255,n[r++]=c>>16&255,n[r++]=c>>8&255,n[r++]=c&255,n}function Oo(e,t){const n=new Uint8Array(9);let r=0;const a=Or(e.id);n[r++]=a>>24&255,n[r++]=a>>16&255,n[r++]=a>>8&255,n[r++]=a&255,n[r++]=jn(e);const o=Kn(e.statuses||[],t);return n[r++]=o>>24&255,n[r++]=o>>16&255,n[r++]=o>>8&255,n[r++]=o&255,n}function Or(e){let t=0;for(let n=0;n<e.length;n++){const r=e.charCodeAt(n);t=(t<<5)-t+r,t=t&t}return t>>>0}function Po(e,t,n){var _;const r=[],a=Date.now(),o=new Uint8Array(7);o[0]=Rt.CARD_STATE,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,r.push(o);const s=[],c=Math.min(e.players.length,255);s.push(new Uint8Array([c]));for(const I of e.players){s.push(new Uint8Array([I.id&255]));const y=Math.min(I.deck.length,255),P=Math.min(I.hand.length,255),A=Math.min(I.discard.length,255);s.push(new Uint8Array([y,P,A,I.announcedCard?1:0])),s.push(new Uint8Array([Math.min(I.score,255)]));const u=Math.min(I.hand.length,255);s.push(new Uint8Array([u]));const b=I.id===n;for(const L of I.hand)b?s.push(hr(L,t)):s.push(Oo(L,t));const E=Math.min(I.discard.length,255);s.push(new Uint8Array([E]));for(const L of I.discard){const m=Or(L.id),O=new Uint8Array(4);O[0]=m>>24&255,O[1]=m>>16&255,O[2]=m>>8&255,O[3]=m&255,s.push(O)}I.announcedCard&&s.push(hr(I.announcedCard,t))}const d=e.board.length;s.push(new Uint8Array([d,d,d]));const g=[];for(let I=0;I<e.board.length;I++)for(let y=0;y<((_=e.board[I])==null?void 0:_.length);y++){const P=e.board[I][y];P!=null&&P.card&&g.push({row:I,col:y,card:P.card})}const T=g.length,N=new Uint8Array(2);N[0]=T>>8&255,N[1]=T&255,s.push(N);for(const{row:I,col:y,card:P}of g)s.push(new Uint8Array([I,y])),s.push(hr(P,t));s.push(new Uint8Array([e.currentPhase===void 0?255:Math.clamp(e.currentPhase,0,254),(e.activePlayerId??255)&255,e.currentRound===void 0?255:Math.clamp(e.currentRound,0,254)]));let p=0;for(const I of s)p+=I.length;o[5]=p>>8&255,o[6]=p&255,r.push(...s);const D=new Uint8Array(r.reduce((I,y)=>I+y.length,0));let v=0;for(const I of r)D.set(I,v),v+=I.length;return l.info(`[GameCodec] Encoded card state: ${D.length} bytes (${T} board cards, ${e.players.length} players)`),D}function ko(e,t,n){let r=0;if(e[r++]!==Rt.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],e[r++]<<8|e[r++];const a=e[r++],o=[];for(let _=0;_<a;_++){const I=e[r++],y=e[r++];e[r++],e[r++];const P=e[r++]===1,A=e[r++],u=e[r++],b=[],E=I===n;for(let k=0;k<u;k++)if(E)b.push(Ir(e,r,t)),r+=13;else{const Y=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],V=e[r++],te=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];b.push({id:`card_${Y}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isFaceDown:(V&1)!==0,revealedTo:V&4?"all":void 0,statuses:qn(te,I,t),isPlaceholder:!0})}const L=e[r++],m=[];for(let k=0;k<L;k++){const Y=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];m.push({id:`discard_${Y}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isPlaceholder:!0})}let O=null;P&&(O=Ir(e,r,t),r+=13);const S=[];for(let k=0;k<y;k++)S.push({id:`deck_${I}_${k}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isPlaceholder:!0});o.push({id:I,name:`Player ${I}`,score:A,hand:b,deck:S,discard:m,announcedCard:O,selectedDeck:"Random",color:"blue",boardHistory:[]})}const s=e[r++];e[r++],e[r++];const c=e[r++]<<8|e[r++],d=[];for(let _=0;_<s;_++){const I=[];for(let y=0;y<s;y++)I.push({card:null});d.push(I)}for(let _=0;_<c;_++){const I=e[r++],y=e[r++],P=Ir(e,r,t);r+=13,I<d.length&&y<d[I].length&&(d[I][y]={card:P})}const g=e[r++],T=e[r++],N=e[r++];return{players:o,board:d,currentPhase:g===255?void 0:g,activePlayerId:T===255?null:T,currentRound:N===255?void 0:N}}function Ir(e,t,n){const a=`card_${e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++]}_${Date.now()}`,o=e[t++]<<8|e[t++],s=e[t++];let c=e[t++];c>127&&(c=c-256);const d=e[t++],g=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++],T=n.cardDefinitions[o],N=(T==null?void 0:T.baseId)||"";return{id:a,baseId:N,deck:"Random",name:(T==null?void 0:T.name)||"?",imageUrl:(T==null?void 0:T.imageUrl)||"",power:c,ability:(T==null?void 0:T.ability)||"",types:(T==null?void 0:T.types)||[],faction:(T==null?void 0:T.faction)||"",ownerId:s,isFaceDown:(d&1)!==0,enteredThisTurn:(d&2)!==0,revealedTo:d&4?"all":void 0,statuses:qn(g,0,n)}}Math.clamp||(Math.clamp=function(e,t,n){return Math.min(Math.max(e,t),n)});let Er=null;function Vn(){return Er||(Er=Ro()),Er}function Mn(e,t){const n=Vn();return Po(e,n,t)}function vo(e,t){const n=Vn();return ko(e,n,t)}function No(e){return Un(e)}function Jn(e){l.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return to(e)}catch(t){return l.error("[webrtcSerialization] Failed to serialize delta:",t),new Uint8Array(0)}}function Xn(e){l.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Un(e)}catch(t){return l.error("[webrtcSerialization] Failed to deserialize delta:",t),{}}}function Lo(e){const t=Jn(e);let n="";const r=new Uint8Array(t),a=r.byteLength;for(let o=0;o<a;o++)n+=String.fromCharCode(r[o]);return btoa(n)}function Mo(e){const t=atob(e),n=new Uint8Array(t.length);for(let r=0;r<t.length;r++)n[r]=t.charCodeAt(r);return Xn(n)}function Go(e,t){var N;const n=new TextEncoder,r=[],a=Date.now(),o=new Uint8Array(7);o[0]=Rt.ABILITY_EFFECT,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,r.push(o);const s=[];if(s.push(new Uint8Array([e])),t.sourcePos){const p=(t.sourcePos.row&15)<<4|t.sourcePos.col&15;s.push(new Uint8Array([p]))}else s.push(new Uint8Array([255]));const c=((N=t.targetPositions)==null?void 0:N.length)||0;if(s.push(new Uint8Array([Math.min(c,255)])),t.targetPositions)for(const p of t.targetPositions.slice(0,255)){const D=(p.row&15)<<4|p.col&15;s.push(new Uint8Array([D]))}if(t.text){const p=n.encode(t.text),D=Math.min(p.length,255);s.push(new Uint8Array([D])),s.push(p.slice(0,D))}else s.push(new Uint8Array([0]));s.push(new Uint8Array([(t.value??0)&255])),s.push(new Uint8Array([(t.playerId??0)&255]));let d=0;for(const p of s)d+=p.length;o[5]=d>>8&255,o[6]=d&255,r.push(...s);const g=new Uint8Array(r.reduce((p,D)=>p+D.length,0));let T=0;for(const p of r)g.set(p,T),T+=p.length;return l.debug(`[AbilityMessages] Encoded effect type ${e}: ${g.length} bytes`),g}function xo(e){let t=0;if(e[t++]!==Rt.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const n=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={effectType:e[t++],timestamp:n,data:{}},a=e[t++];a!==255&&(r.data.sourcePos={row:a>>4&15,col:a&15});const o=e[t++];if(o>0){r.data.targetPositions=[];for(let c=0;c<o;c++){const d=e[t++];r.data.targetPositions.push({row:d>>4&15,col:d&15})}}const s=e[t++];if(s>0){const c=new TextDecoder;r.data.text=c.decode(e.subarray(t,t+s)),t+=s}return r.data.value=e[t++],r.data.playerId=e[t++],r}function Uo(e,t={}){const n=new TextEncoder,r=[],a=Date.now(),o=new Uint8Array(7);o[0]=Rt.SESSION_EVENT,o[1]=a>>24&255,o[2]=a>>16&255,o[3]=a>>8&255,o[4]=a&255,r.push(o);const s=[];if(s.push(new Uint8Array([e])),s.push(new Uint8Array([(t.playerId??0)&255])),t.playerName){const N=n.encode(t.playerName),p=Math.min(N.length,255);s.push(new Uint8Array([p])),s.push(N.slice(0,p))}else s.push(new Uint8Array([0]));s.push(new Uint8Array([(t.startingPlayerId??0)&255])),s.push(new Uint8Array([Math.min(t.roundNumber??0,255)])),s.push(new Uint8Array([Math.min(t.newPhase??0,255)])),s.push(new Uint8Array([(t.newActivePlayerId??0)&255])),s.push(new Uint8Array([(t.gameWinner??255)&255]));let c=0;if(t.winners)for(const N of t.winners)N<32&&(c|=1<<N);s.push(new Uint8Array([c>>24&255,c>>16&255,c>>8&255,c&255]));let d=0;for(const N of s)d+=N.length;o[5]=d>>8&255,o[6]=d&255,r.push(...s);const g=new Uint8Array(r.reduce((N,p)=>N+p.length,0));let T=0;for(const N of r)g.set(N,T),T+=N.length;return l.debug(`[SessionMessages] Encoded event type ${e}: ${g.length} bytes`),g}function $o(e){let t=0;if(e[t++]!==Rt.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const n=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={eventType:e[t++],timestamp:n,data:{}};r.data.playerId=e[t++];const a=e[t++];if(a>0){const c=new TextDecoder;r.data.playerName=c.decode(e.subarray(t,t+a)),t+=a}r.data.startingPlayerId=e[t++],r.data.roundNumber=e[t++],r.data.newPhase=e[t++],r.data.newActivePlayerId=e[t++];const o=e[t++];r.data.gameWinner=o===255?null:o;const s=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];if(s!==0){r.data.winners=[];for(let c=0;c<32;c++)s&1<<c&&r.data.winners.push(c)}return r}const Ho=!0;class pt{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,this.guestPlayerIds=new Map,localStorage.getItem("webrtc_enabled")}async initializeAsHost(t){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((n,r)=>{this.peer=t?new Vt(t):new Vt,this.peer.on("open",a=>{this.emitEvent({type:"peer_open",data:{peerId:a}}),n(a)}),this.peer.on("connection",a=>{l.info(`Guest connection request from: ${a.peer}`),this.handleGuestConnection(a)}),this.peer.on("error",a=>{l.error("WebRTC Peer error:",a),this.emitEvent({type:"error",data:a}),r(a)}),this.peer.on("close",()=>{l.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(t){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((n,r)=>{this.peer=new Vt,this.peer.on("open",a=>{const o=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(o),o.on("open",()=>{this.hostConnection=o,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}});let s=null;try{const c=localStorage.getItem("webrtc_preferred_deck");c&&(s=c,l.info(`[initializeAsGuest] Found deck preference in localStorage: ${s}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(c){l.warn("[initializeAsGuest] Failed to read deck preference:",c)}this.sendMessageToHost({type:"JOIN_REQUEST",senderId:a,data:{preferredDeck:s||void 0},timestamp:Date.now()}),n()}),o.on("error",s=>{l.error("Host connection error:",s),this.emitEvent({type:"error",data:s}),r(s)})}),this.peer.on("error",a=>{l.error("WebRTC Peer error:",a),this.emitEvent({type:"error",data:a}),r(a)})})}async initializeAsReconnectingGuest(t,n){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((r,a)=>{this.peer=new Vt,this.peer.on("open",o=>{const s=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(s),s.on("open",()=>{this.hostConnection=s,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:o,playerId:n,timestamp:Date.now()}),this.isReconnecting=!1,r()}),s.on("error",c=>{l.error("Host connection error:",c),this.emitEvent({type:"error",data:c}),this.isReconnecting=!1,a(c)})}),this.peer.on("error",o=>{l.error("WebRTC Peer error:",o),this.emitEvent({type:"error",data:o}),this.isReconnecting=!1,a(o)})})}handleGuestConnection(t){this.connections.set(t.peer,t),t.on("open",()=>{l.info(`Guest connected: ${t.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:t.peer}})}),t.on("data",n=>{this.handleMessage(n,t)}),t.on("close",()=>{l.info(`Guest disconnected: ${t.peer}`),this.connections.delete(t.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:t.peer}})}),t.on("error",n=>{l.error(`Guest connection error (${t.peer}):`,n)})}setupHostConnection(t){this.hostConnection=t,t.on("data",n=>{this.handleMessage(n,t)}),t.on("close",()=>{l.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),t.on("error",n=>{l.error("Host connection error:",n)})}handleMessage(t,n){l.debug("Received WebRTC message:",t.type),this.emitEvent({type:"message_received",data:t})}sendMessageToHost(t){if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(t),!0}catch(n){return l.error("Failed to send message to host:",n),!1}return!1}broadcastToGuests(t,n){if(!this.isHost)return l.warn("Only host can broadcast to guests"),0;let r=0;return this.connections.forEach((a,o)=>{if(a.open&&o!==n)try{a.send(t),r++}catch(s){l.error(`Failed to send to guest ${o}:`,s)}}),l.debug(`Broadcast to ${r}/${this.connections.size} guests`),r}sendToGuest(t,n){if(!this.isHost)return l.warn("Only host can send to specific guest"),!1;const r=this.connections.get(t);if(!r)return l.error(`[sendToGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!r.open)return l.error(`[sendToGuest] Connection for guest ${t} is not open`),!1;try{return r.send(n),l.debug(`Sent message to guest ${t}`),!0}catch(a){return l.error(`[sendToGuest] Failed to send message to ${t}:`,a),!1}}acceptGuest(t,n,r){var o;const a=this.connections.get(t);if(!a){l.error(`[acceptGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!a.open){l.error(`[acceptGuest] Connection for guest ${t} is not open`);return}try{if(Ho){const s=Mn(n,null),c={type:"JOIN_ACCEPT_BINARY",senderId:(o=this.peer)==null?void 0:o.id,playerId:r,data:s,timestamp:Date.now()};a.send(c),l.info(`Accepted guest ${t} as player ${r} (BINARY, ${s.byteLength} bytes)`)}}catch(s){l.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${t}:`,s)}}acceptGuestMinimal(t,n,r){var s;const a=this.connections.get(t);if(!a){l.error(`[acceptGuestMinimal] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!a.open){l.error(`[acceptGuestMinimal] Connection for guest ${t} is not open`);return}this.guestPlayerIds.set(t,r);const o={type:"JOIN_ACCEPT_MINIMAL",senderId:(s=this.peer)==null?void 0:s.id,playerId:r,data:n,timestamp:Date.now()};try{a.send(o),l.info(`Accepted guest ${t} as player ${r} (minimal)`)}catch(c){l.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${t}:`,c)}}broadcastGameState(t,n){this.broadcastGameStateLegacy(t,n)}broadcastGameStateLegacy(t,n){let r=0;this.connections.forEach((a,o)=>{var g;if(!a.open||o===n)return;const s=this.guestPlayerIds.get(o)??null,c=pt.createPersonalizedGameState(t,s),d={type:"STATE_UPDATE_COMPACT",senderId:(g=this.peer)==null?void 0:g.id,data:{gameState:c,recipientPlayerId:s},timestamp:Date.now()};try{a.send(d),r++}catch(T){l.error(`[broadcastGameStateLegacy] Failed to send to guest ${o} (player ${s}):`,T)}}),l.debug(`[broadcastGameStateLegacy] Sent to ${r}/${this.connections.size} guests`)}static createPersonalizedGameState(t,n){return{...t,players:t.players.map(r=>{if(n!==null&&r.id===n){const o=r.deck.length??0,s=r.discard.length??0,c=r.hand.length??0;return l.debug(`[createPersonalizedGameState] Player ${r.id} (own): ${c} hand, ${o} deck, ${s} discard`),{...r,handCards:r.hand.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),deckCards:r.deck.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),discardCards:r.discard.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?pt.optimizeCard(r.announcedCard):null,deckSize:o,discardSize:s,handSize:c}}else{const o=r.deckSize??r.deck.length??0,s=r.hand.filter(c=>!c.isFaceDown).length;return s>0&&l.debug(`[createPersonalizedGameState] Player ${r.id} (other): ${s} revealed, ${r.hand.length-s} face-down`),{...r,hand:r.hand.map(c=>c.isFaceDown?pt.createCardBack(c):{id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier||0,isFaceDown:c.isFaceDown,statuses:c.statuses||[],ownerId:c.ownerId,ownerName:c.ownerName,deck:c.deck}),deck:[],discard:[],announcedCard:r.announcedCard?pt.createCardBack(r.announcedCard):null,deckSize:o,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}}}),board:t.board.map(r=>r.map(a=>({...a,card:a.card?pt.optimizeCard(a.card):null})))}}static createCompactStateForHost(t,n){return{...t,players:t.players.map(r=>r.id===n?(l.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(a=>({id:a.id,baseId:a.baseId,power:a.power,powerModifier:a.powerModifier,isFaceDown:a.isFaceDown,statuses:a.statuses||[]})),deckCards:r.deck.map(a=>({id:a.id,baseId:a.baseId,power:a.power,powerModifier:a.powerModifier,isFaceDown:a.isFaceDown,statuses:a.statuses||[]})),discardCards:r.discard.map(a=>({id:a.id,baseId:a.baseId,power:a.power,powerModifier:a.powerModifier,isFaceDown:a.isFaceDown,statuses:a.statuses||[]})),hand:[],deck:[],discard:[],handSize:r.hand.length,deckSize:r.deck.length,discardSize:r.discard.length}):{...r,hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}),board:t.board.map(r=>r.map(a=>({...a,card:a.card?pt.optimizeCard(a.card):null})))}}static optimizeCard(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier,ability:t.ability,ownerId:t.ownerId,color:t.color,deck:t.deck,isFaceDown:t.isFaceDown,types:t.types,faction:t.faction,statuses:t.statuses||[],hasRevealToken:t.hasRevealToken||!1,imageUrl:t.imageUrl}}static createCardBack(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,hasRevealToken:t.hasRevealToken||!1,statuses:t.statuses||[]}}broadcastStateDelta(t,n){var r,a;{const o=Lo(t),s={type:"STATE_DELTA_BINARY",senderId:(r=this.peer)==null?void 0:r.id,data:o,timestamp:Date.now()};l.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${o.length} chars, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, boardCells=${((a=t.boardCells)==null?void 0:a.length)||0}`),this.broadcastToGuests(s,n),l.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${t.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(t,n,r){var a;try{const o=Mn(t,n),s=btoa(String.fromCharCode(...o)),c={type:"CARD_STATE",senderId:(a=this.peer)==null?void 0:a.id,data:s,timestamp:Date.now()},d=this.broadcastToGuests(c,r);return l.info(`[broadcastCardState] Sent ${o.length} bytes to ${d} guests`),d}catch(o){return l.error("[broadcastCardState] Failed to encode/broadcast state:",o),0}}broadcastAbilityEffect(t,n,r){var a;try{const o=Go(t,n),s=btoa(String.fromCharCode(...o)),c={type:"ABILITY_EFFECT",senderId:(a=this.peer)==null?void 0:a.id,data:s,timestamp:Date.now()},d=this.broadcastToGuests(c,r);return l.debug(`[broadcastAbilityEffect] Sent effect ${t} to ${d} guests`),d}catch(o){return l.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",o),0}}broadcastSessionEvent(t,n,r){var a;try{const o=Uo(t,n),s=btoa(String.fromCharCode(...o)),c={type:"SESSION_EVENT",senderId:(a=this.peer)==null?void 0:a.id,data:s,timestamp:Date.now()},d=this.broadcastToGuests(c,r);return l.debug(`[broadcastSessionEvent] Sent event ${t} to ${d} guests`),d}catch(o){return l.error("[broadcastSessionEvent] Failed to encode/broadcast event:",o),0}}sendAction(t,n){var a;const r={type:"ACTION",senderId:(a=this.peer)==null?void 0:a.id,data:{actionType:t,actionData:n},timestamp:Date.now()};return this.sendMessageToHost(r)}sendStateDelta(t){var n;{const r=Jn(t),a={type:"STATE_DELTA_BINARY",senderId:(n=this.peer)==null?void 0:n.id,data:r,timestamp:Date.now()};return this.sendMessageToHost(a)}}sendStateToHost(t,n){var s,c,d;if(n===null)return l.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const r=pt.createCompactStateForHost(t,n),a=t.players.find(g=>g.id===n);a&&l.info(`[sendStateToHost] Player ${n} sending compact state: hand=${((s=a.hand)==null?void 0:s.length)??0}, deck=${((c=a.deck)==null?void 0:c.length)??0}`);const o={type:"STATE_UPDATE_COMPACT",senderId:(d=this.peer)==null?void 0:d.id,playerId:n,data:{gameState:r},timestamp:Date.now()};return this.sendMessageToHost(o)}sendFullDeckToHost(t,n,r){var o;const a={type:"DECK_DATA_UPDATE",senderId:(o=this.peer)==null?void 0:o.id,playerId:t,data:{playerId:t,deck:n.map(s=>pt.optimizeCard(s)),deckSize:r},timestamp:Date.now()};return this.sendMessageToHost(a)}sendCustomDeckData(t,n,r){var s;if(!r)return!0;l.info(`[sendCustomDeckData] Player ${t} sending ${n.length} custom deck cards to host`);const a=n.map(c=>({id:c.id,baseId:c.baseId,name:c.name,power:c.power,powerModifier:c.powerModifier,ability:c.ability,types:c.types,faction:c.faction,imageUrl:c.imageUrl,color:c.color,deck:c.deck})),o={type:"CUSTOM_DECK_DATA",senderId:(s=this.peer)==null?void 0:s.id,playerId:t,data:{playerId:t,deckCards:a},timestamp:Date.now()};return this.sendMessageToHost(o)}getConnectionInfo(){const t=[];return this.isHost?this.connections.forEach((n,r)=>{t.push({peerId:r,playerId:null,playerName:null,connected:n.open})}):this.hostConnection&&t.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),t}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getHostPeerId(){var t,n;return this.isHost?((t=this.peer)==null?void 0:t.id)||null:((n=this.hostConnection)==null?void 0:n.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var t;return this.isHost?this.connections.size:(t=this.hostConnection)!=null&&t.open?1:0}on(t){return this.eventHandlers.add(t),()=>this.eventHandlers.delete(t)}emitEvent(t){this.eventHandlers.forEach(n=>{try{n(t)}catch(r){l.error("Error in WebRTC event handler:",r)}})}cleanup(){this.connections.forEach(t=>t.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let Tr=null;const Fo=()=>(Tr||(Tr=new pt),Tr);function Wo(e){return 10+e*10}function Pr(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const t=e.currentPhase===1,n=e.activePlayerId===e.startingPlayerId;if(!t||!n)return{shouldEnd:!1,roundWinners:[]};const r=e.currentRound||1,a=Wo(r),o=[];for(const c of e.players)!c.isDummy&&!c.isDisconnected&&c.score>=a&&o.push(c.id);return{shouldEnd:o.length>0,roundWinners:o}}function Zn(e){const{shouldEnd:t,roundWinners:n}=Pr(e);if(!t)return e;const r=e.currentRound||1,a={...e.roundWinners,[r]:n},o=new Map;for(const[,c]of Object.entries(a))for(const d of c){const g=o.get(d)||0;o.set(d,g+1)}let s=null;for(const[c,d]of o.entries())if(d>=2){s=c;break}return l.info(`[endRound] Round ${r} ended. Winners: [${n.join(", ")}], Game winner: ${s||"none"}`),{...e,roundWinners:a,gameWinner:s,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function kr(e,t){if(e.currentPhase!==0)return l.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const n=e.players.find(o=>o.id===t);if(!n)return l.error(`[performPreparationPhase] Active player ${t} not found!`),e;l.info(`[performPreparationPhase] Player ${t} has deck size: ${n.deck.length}, hand size: ${n.hand.length}`);const r=e.players.map(o=>{if(o.id===t&&o.deck.length>0){const s=o.deck[0],c=[...o.deck.slice(1)],d=[...o.hand,s];return l.info(`[performPreparationPhase] Player ${t} drew card ${(s==null?void 0:s.id)||"unknown"}, deck now: ${c.length}, hand: ${d.length}`),{...o,deck:c,hand:d,readySetup:!1,readyCommit:!1}}return o}),a={...e,players:r,currentPhase:1};return Pr(a).shouldEnd?Zn(a):(l.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${a.activePlayerId}`),a)}function Qn(e,t){const n=e.activePlayerId;if(n===t){const c={...e,activePlayerId:null};return t===e.startingPlayerId&&e.currentPhase===1&&Pr(c).shouldEnd?Zn(c):c}if(!e.players.filter(c=>!c.isDisconnected).find(c=>c.id===t))return l.warn(`[toggleActivePlayer] Player ${t} not found or disconnected`),e;let o=e.turnNumber||1;t===e.startingPlayerId&&n!==null&&o++;const s={...e,activePlayerId:t,turnNumber:o,currentPhase:0};return kr(s,t)}function Bo(e,t){const n=e.players.filter(o=>!o.isDisconnected).sort((o,s)=>o.id-s.id);if(n.length===0)return null;if(t===null)return n[0].id;const r=n.findIndex(o=>o.id===t);if(r===-1)return n[0].id;const a=(r+1)%n.length;return n[a].id}function Yo(e,t){var n;for(const r of e.board)for(const a of r)if(((n=a.card)==null?void 0:n.ownerId)===t)return!0;return!1}function rr(e){const t=Bo(e,e.activePlayerId);if(t===null)return l.warn("[passTurnToNextPlayer] No next player found"),e;l.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${t}`);let n={...e,board:e.board.map(r=>r.map(a=>{var o;return((o=a.card)==null?void 0:o.ownerId)===e.activePlayerId&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(s=>s.type!=="Stun")}}:a}))};return n={...n,board:n.board.map(r=>r.map(a=>a.card&&a.card.statuses?{...a,card:{...a.card,statuses:a.card.statuses.filter(o=>o.type!=="enteredThisTurn")}}:a))},n={...n,activePlayerId:t,currentPhase:0,isScoringStep:!1},kr(n,t)}function mr(e,t,n){return l.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),e}function zo(e,t){return{type:"RECONNECT_SNAPSHOT",data:e}}function Ko(e,t,n){var r,a,o,s;try{const c=vo(e,n);l.info(`[WebRTCCodec] Received card state: ${(r=c.board)==null?void 0:r.length}x${((o=(a=c.board)==null?void 0:a[0])==null?void 0:o.length)||0}, ${((s=c.players)==null?void 0:s.length)||0} players`);const d={...t};return c.players&&(d.players=c.players.map(g=>{const T=t.players.find(N=>N.id===g.id);if(T){const N=g.id===n;return{...T,...g,hand:N?T.hand:g.hand}}return g})),c.board&&(d.board=c.board),c.currentPhase!==void 0&&(d.currentPhase=c.currentPhase),c.activePlayerId!==void 0&&(d.activePlayerId=c.activePlayerId),c.currentRound!==void 0&&(d.currentRound=c.currentRound),d}catch(c){return l.error("[WebRTCCodec] Failed to deserialize card state:",c),t}}function qo(e,t){try{const{effectType:n,timestamp:r,data:a}=xo(e);l.debug(`[WebRTCCodec] Received ability effect: ${n}`);let o=t;switch(n){case 1:return{gameState:o,effectData:{type:"highlight",...a,timestamp:r}};case 2:return{gameState:o,effectData:{type:"floatingText",...a,timestamp:r}};case 3:return{gameState:o,effectData:{type:"noTarget",...a}};case 8:return{gameState:o,effectData:{type:"targetingMode",...a}};case 9:return{gameState:o,effectData:{type:"clearTargeting"}};default:return l.warn(`[WebRTCCodec] Unknown ability effect type: ${n}`),{gameState:o,effectData:null}}}catch(n){return l.error("[WebRTCCodec] Failed to handle ability effect:",n),{gameState:t,effectData:null}}}function jo(e,t){var n;try{const{eventType:r,data:a}=$o(e);l.info(`[WebRTCCodec] Received session event: ${r}`);const o={...t};switch(r){case 1:l.info(`[WebRTCCodec] Player connected: ${a.playerName} (ID: ${a.playerId})`);break;case 2:l.info(`[WebRTCCodec] Player disconnected: ID: ${a.playerId}`),o.players=o.players.map(s=>s.id===a.playerId?{...s,isDisconnected:!0}:s);break;case 3:l.info(`[WebRTCCodec] Game starting, first player: ${a.startingPlayerId}`),o.isGameStarted=!0,a.startingPlayerId!==void 0&&(o.activePlayerId=a.startingPlayerId,o.startingPlayerId=a.startingPlayerId);break;case 4:l.info(`[WebRTCCodec] Round ${a.roundNumber} starting`),o.currentRound=a.roundNumber??1;break;case 5:if(l.info(`[WebRTCCodec] Round ${a.roundNumber} ended, winners: ${(n=a.winners)==null?void 0:n.join(", ")}`),o.isRoundEndModalOpen=!0,a.winners&&a.roundNumber!==void 0){const s=o.roundWinners||{};s[a.roundNumber]=a.winners,o.roundWinners=s}break;case 6:l.info(`[WebRTCCodec] Phase change: ${a.newPhase}`),a.newPhase!==void 0&&(o.currentPhase=a.newPhase),a.newActivePlayerId!==void 0&&(o.activePlayerId=a.newActivePlayerId);break;case 7:l.info(`[WebRTCCodec] Turn change: player ${a.newActivePlayerId}`),a.newActivePlayerId!==void 0&&(o.activePlayerId=a.newActivePlayerId);break;case 8:l.info(`[WebRTCCodec] Game ended, winner: ${a.gameWinner}`),a.gameWinner!==void 0&&(o.gameWinner=a.gameWinner===255?null:a.gameWinner);break;default:l.warn(`[WebRTCCodec] Unknown session event type: ${r}`)}return o}catch(r){return l.error("[WebRTCCodec] Failed to handle session event:",r),t}}function kt(e,t,n,r){return e===2?{gameState:Ko(t,n,r)}:e===3?qo(t,n):e===4?{gameState:jo(t,n)}:(l.warn(`[WebRTCCodec] Unknown codec message type: ${e}`),{gameState:n})}const nr="avalon_game_state",St="reconnection_data";function ea(e,t){var r;e.forEach(a=>a.forEach(o=>{var s;(s=o.card)!=null&&s.statuses&&(o.card.statuses=o.card.statuses.filter(c=>!(c.type==="LastPlayed"&&c.addedByPlayerId===t.id)))})),t.boardHistory||(t.boardHistory=[]);let n=!1;for(;t.boardHistory.length>0&&!n;){const a=t.boardHistory[t.boardHistory.length-1];for(let o=0;o<e.length;o++){for(let s=0;s<e[o].length;s++)if(((r=e[o][s].card)==null?void 0:r.id)===a){const c=e[o][s].card;if(!c||c.ownerId!==t.id)continue;c.statuses||(c.statuses=[]),c.statuses.push({type:"LastPlayed",addedByPlayerId:t.id}),n=!0;break}if(n)break}n||t.boardHistory.pop()}}function Ut(e){var r;if(!e||!ft)return e;const{cardDatabase:t,tokenDatabase:n}=ft;if(e.deck===ze.Tokens||(r=e.id)!=null&&r.startsWith("TKN_")){if(e.baseId&&n[e.baseId]){const o=n[e.baseId];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage}}const a=Object.keys(n).find(o=>n[o].name===e.name);if(a){const o=n[a];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage,baseId:a}}}else if(e.baseId&&t[e.baseId]){const a=t[e.baseId];return{...e,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage}}return e}function Yt(e){var r,a;if(!ft)return e;const t=((r=e.board)==null?void 0:r.map(o=>o.map(s=>({...s,card:s.card?Ut(s.card):null}))))||e.board,n=((a=e.players)==null?void 0:a.map(o=>{var s,c,d;return{...o,hand:((s=o.hand)==null?void 0:s.map(Ut))||[],deck:((c=o.deck)==null?void 0:c.map(Ut))||[],discard:((d=o.discard)==null?void 0:d.map(Ut))||[],announcedCard:o.announcedCard?Ut(o.announcedCard):null}}))||e.players;return{...e,board:t,players:n,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}}function Gn(e,t,n){try{const r=Yt(e),a={gameState:r,localPlayerId:t,playerToken:n,timestamp:Date.now()};localStorage.setItem(nr,JSON.stringify(a)),r.gameId&&t!==null&&localStorage.setItem(St,JSON.stringify({gameId:r.gameId,playerId:t,playerToken:n||null,timestamp:Date.now()}))}catch(r){console.warn("Failed to save game state:",r)}}function Vo(){try{const e=localStorage.getItem(nr);if(!e)return null;const t=JSON.parse(e),n=24*60*60*1e3;if(Date.now()-t.timestamp>n)return localStorage.removeItem(nr),localStorage.removeItem(St),null;const r=t.gameState;return{gameState:Yt(r),localPlayerId:t.localPlayerId,playerToken:t.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}}function Lt(){localStorage.removeItem(nr),localStorage.removeItem(St)}function vr(e){const t=[...e];for(let n=t.length-1;n>0;n--){const r=Math.floor(Math.random()*(n+1));[t[n],t[r]]=[t[r],t[n]]}return t}function ta(){return Math.random().toString(36).substring(2,18).toUpperCase()}function gt(e,t,n){const r=Fn();let a=e;if(e==="Random"||!r[e]){const c=Object.keys(r);if(c.length===0)return console.error("[createDeck] No decks loaded yet!"),[];a=c[0],e==="Random"?console.log(`[createDeck] Random deck selected, using ${a} instead`):console.warn(`[createDeck] Deck ${e} not found, using ${a} instead`)}const o=r[a];if(!o)return console.error(`Deck data for ${a} not loaded! Returning empty deck. Available decks:`,Object.keys(r)),[];const s=[...o].map(c=>({...c,ownerId:t,ownerName:n}));return vr(s)}function ra(e,t=!1){const n=Fn(),r=Object.keys(n);if(r.length===0)return console.error("[createNewPlayer] No decks loaded yet!"),{id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:tr[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};const a=r[0],o={id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:a,color:tr[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};return o.deck=gt(a,e,o.name),o}function bt(){return{players:[],spectators:[],board:zn(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:Sr.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}function Jo(){const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return l.warn("No custom WebSocket URL configured in settings."),null;let t=e.trim();return t.endsWith("/")&&(t=t.slice(0,-1)),t.startsWith("https://")?t=t.replace("https://","wss://"):t.startsWith("http://")&&(t=t.replace("http://","ws://")),!t.startsWith("ws://")&&!t.startsWith("wss://")?(l.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",t),t)}const xn=-1,Xo=-2,$t=1,Zt=2,At=(e,t,n,r)=>{var c,d,g,T,N;const{card:a,ownerId:o,location:s}=e;if(t.targetOwnerId!==void 0&&t.targetOwnerId!==xn&&t.targetOwnerId!==Xo&&t.targetOwnerId!==o||t.excludeOwnerId!==void 0&&t.excludeOwnerId===o)return!1;if(t.onlyOpponents||t.targetOwnerId===xn){if(o===n)return!1;const p=r.find(v=>v.id===n),D=r.find(v=>v.id===o);if(p&&D&&p.teamId!==void 0&&p.teamId===D.teamId)return!1}if(t.targetType&&!((c=a.types)!=null&&c.includes(t.targetType))||t.onlyFaceDown&&((d=a.statuses)!=null&&d.some(p=>p.type==="Revealed"&&p.addedByPlayerId===n)||s==="board"&&!a.isFaceDown)||t.tokenType==="Revealed"&&(g=a.statuses)!=null&&g.some(p=>p.type==="Revealed"&&p.addedByPlayerId===n)||t.requiredTargetStatus&&(!((T=a.statuses)!=null&&T.some(p=>p.type===t.requiredTargetStatus))||t.requireStatusFromSourceOwner&&n!==null&&!((N=a.statuses)==null?void 0:N.some(D=>D.type===t.requiredTargetStatus&&D.addedByPlayerId===n))))return!1;if(t.mustBeAdjacentToSource&&t.sourceCoords&&e.boardCoords){const{row:p,col:D}=t.sourceCoords,{row:v,col:_}=e.boardCoords;if(Math.abs(p-v)+Math.abs(D-_)!==$t)return!1}if(t.mustBeInLineWithSource&&t.sourceCoords&&e.boardCoords){const{row:p,col:D}=t.sourceCoords,{row:v,col:_}=e.boardCoords;if(p!==v&&D!==_)return!1}if(t.maxDistanceFromSource!==void 0&&t.sourceCoords&&e.boardCoords){const{row:p,col:D}=t.sourceCoords,{row:v,col:_}=e.boardCoords;if(Math.max(Math.abs(p-v),Math.abs(D-_))>t.maxDistanceFromSource)return!1}if(t.maxOrthogonalDistance!==void 0&&t.sourceCoords&&e.boardCoords){const{row:p,col:D}=t.sourceCoords,{row:v,col:_}=e.boardCoords;if(Math.abs(p-v)+Math.abs(D-_)>t.maxOrthogonalDistance)return!1}return!0},ar=(e,t,n,r)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const a=[],o=t.board,s=o.length,c=t.activeGridSize,d=Math.floor((s-c)/2),g=d,T=d+c-1;if(e.type==="CREATE_STACK"){const _={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let I=g;I<=T;I++)for(let y=g;y<=T;y++){const P=o[I][y];P.card&&P.card.ownerId!==void 0&&At({card:P.card,ownerId:P.card.ownerId,location:"board",boardCoords:{row:I,col:y}},_,n,t.players)&&a.push({row:I,col:y})}return a}const{mode:N,payload:p,sourceCoords:D,contextCheck:v}=e;if(N==="REVEREND_DOUBLE_EXPLOIT"){for(let _=g;_<=T;_++)for(let I=g;I<=T;I++)o[_][I].card&&a.push({row:_,col:I});return a}if((N==="SELECT_TARGET"||N==="CENSOR_SWAP"||N==="ZEALOUS_WEAKEN"||N==="CENTURION_BUFF"||N==="SELECT_UNIT_FOR_MOVE")&&p.filter&&typeof p.filter=="function"){if(p.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||p.actionType==="LUCIUS_SETUP"||p.actionType==="SELECT_HAND_FOR_DEPLOY"||p.handOnly)return[];for(let _=g;_<=T;_++)for(let I=g;I<=T;I++){const y=o[_][I];let P=y.card&&p.filter(y.card,_,I);if(P&&v==="ADJACENT_TO_LAST_MOVE"&&(r!=null&&r.lastMovedCardCoords)){const{row:A,col:u}=r.lastMovedCardCoords;Math.abs(_-A)+Math.abs(I-u)===1||(P=!1)}P&&a.push({row:_,col:I})}}else if(N==="SELECT_TARGET"&&(p.actionType==="ENHANCED_INT_REVEAL"||p.actionType==="ENHANCED_INT_MOVE"))for(let _=g;_<=T;_++)for(let I=g;I<=T;I++)o[_][I].card&&a.push({row:_,col:I});else if(N==="PATROL_MOVE"&&D)for(let _=g;_<=T;_++)for(let I=g;I<=T;I++){const y=_===D.row||I===D.col,P=_===D.row&&I===D.col,A=!o[_][I].card;y&&(A||P)&&a.push({row:_,col:I})}else if(N==="RIOT_PUSH"&&D){const _=[{r:D.row-1,c:D.col},{r:D.row+1,c:D.col},{r:D.row,c:D.col-1},{r:D.row,c:D.col+1}],I=(y,P)=>y>=g&&y<=T&&P>=g&&P<=T;_.forEach(y=>{if(I(y.r,y.c)){const P=o[y.r][y.c].card;if(P&&P.ownerId!==n){const A=t.players.find(E=>E.id===n),u=t.players.find(E=>E.id===P.ownerId);if(!((A==null?void 0:A.teamId)!==void 0&&(u==null?void 0:u.teamId)!==void 0&&A.teamId===u.teamId)){const E=y.r-D.row,L=y.c-D.col,m=y.r+E,O=y.c+L;I(m,O)&&(o[m][O].card||a.push({row:y.r,col:y.c}))}}}})}else if(N==="RIOT_MOVE"&&p.vacatedCoords)a.push(p.vacatedCoords),D&&a.push(D);else if(N==="SWAP_POSITIONS"&&p.filter)for(let _=g;_<=T;_++)for(let I=g;I<=T;I++){const y=o[_][I];y.card&&p.filter(y.card,_,I)&&a.push({row:_,col:I})}else if((N==="TRANSFER_STATUS_SELECT"||N==="TRANSFER_ALL_STATUSES")&&p.filter)for(let _=g;_<=T;_++)for(let I=g;I<=T;I++){const y=o[_][I];y.card&&p.filter(y.card,_,I)&&a.push({row:_,col:I})}else if(N==="SPAWN_TOKEN"||N==="SELECT_CELL"||N==="IMMUNIS_RETRIEVE")for(let _=g;_<=T;_++)for(let I=g;I<=T;I++){const y=!o[_][I].card;if(N==="IMMUNIS_RETRIEVE"&&p.filter){y&&p.filter(_,I)&&a.push({row:_,col:I});continue}if(N==="SELECT_CELL"){if(p.moveFromHand){y&&a.push({row:_,col:I});continue}if(!D)continue;const P=_===D.row&&I===D.col,A=p.range==="global";let u=!1;if(A)u=!0;else if(p.range==="line")u=_===D.row||I===D.col;else if(p.range===Zt){const b=Math.abs(_-D.row),E=Math.abs(I-D.col),L=b+E;if(L===$t)u=!0;else if(L===Zt){const m=[];b===Zt&&E===0?m.push({r:(_+D.row)/2,c:I}):b===0&&E===Zt?m.push({r:_,c:(I+D.col)/2}):b===$t&&E===$t&&(m.push({r:_,c:D.col}),m.push({r:D.row,c:I})),u=m.some(O=>O.r<0||O.r>=s||O.c<0||O.c>=s?!1:!o[O.r][O.c].card)}}else u=Math.abs(_-D.row)+Math.abs(I-D.col)===$t;(y&&u||p.allowSelf&&P)&&a.push({row:_,col:I})}else if(N==="SPAWN_TOKEN"&&D){const P=Math.abs(_-D.row)+Math.abs(I-D.col)===1;y&&P&&a.push({row:_,col:I})}}else if(N==="REVEAL_ENEMY"&&p.filter)for(let _=g;_<=T;_++)for(let I=g;I<=T;I++){const y=o[_][I];y.card&&p.filter(y.card,_,I)&&a.push({row:_,col:I})}else if(N==="SELECT_LINE_START")for(let _=g;_<=T;_++)for(let I=g;I<=T;I++)a.push({row:_,col:I});else if(N==="SELECT_LINE_END"&&p.firstCoords){const{row:_,col:I}=p.firstCoords;for(let y=g;y<=T;y++)a.push({row:_,col:y});for(let y=g;y<=T;y++)a.push({row:y,col:I})}else if(N==="INTEGRATOR_LINE_SELECT"&&D){const{row:_,col:I}=D;for(let y=g;y<=T;y++)a.push({row:_,col:y});for(let y=g;y<=T;y++)a.push({row:y,col:I})}else if(N==="ZIUS_LINE_SELECT"&&D){const{row:_,col:I}=D;for(let y=g;y<=T;y++)a.push({row:_,col:y});for(let y=g;y<=T;y++)a.push({row:y,col:I})}else if(N==="IP_AGENT_THREAT_SCORING"&&D){const{row:_,col:I}=D;for(let y=g;y<=T;y++)a.push({row:_,col:y});for(let y=g;y<=T;y++)a.push({row:y,col:I})}else if(N==="SELECT_DIAGONAL")if(p.firstCoords){const{row:_,col:I}=p.firstCoords;for(let y=g;y<=T;y++)for(let P=g;P<=T;P++)Math.abs(y-_)===Math.abs(P-I)&&a.push({row:y,col:P})}else for(let _=g;_<=T;_++)for(let I=g;I<=T;I++)a.push({row:_,col:I});return a},Qt=(e,t,n,r)=>{var o,s,c,d,g;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let T=0;T<t.board.length;T++)for(let N=0;N<t.board[T].length;N++)if(t.board[T][N].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((o=e.payload)!=null&&o.actionType)){const T=e.payload.actionType;if(T==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||T==="LUCIUS_SETUP"||T==="SELECT_HAND_FOR_DEPLOY"){const N=((s=e.sourceCard)==null?void 0:s.ownerId)||n;if(N!==null){const p=t.players.find(D=>D.id===N);if(p&&p.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(ar(e,t,n,r).length>0)return!0;if(e.tokenType==="Revealed"||(c=e.tokenType)!=null&&c.startsWith("Power"))for(const N of t.players)for(let p=0;p<N.hand.length;p++){const D={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(At({card:N.hand[p],ownerId:N.id,location:"hand"},D,n,t.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((d=e.payload)!=null&&d.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const T of t.players)if(T.hand.some(N=>e.payload.filter(N))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return ar(e,t,n,r).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((g=e.payload)!=null&&g.filter),!1)};function Zo(e){const{ws:t,webrtcManager:n,gameStateRef:r,localPlayerIdRef:a,webrtcIsHostRef:o,setLatestHighlight:s,setLatestFloatingTexts:c,setLatestNoTarget:d,setLatestDeckSelections:g,setLatestHandCardSelections:T,setTargetSelectionEffects:N,setGameState:p}=e,D=$.useCallback(E=>{var m;const L={...E,timestamp:Date.now()};if(s(L),((m=t.current)==null?void 0:m.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:r.current.gameId,highlightData:L}));else if(n.current){const O={type:"HIGHLIGHT_TRIGGERED",senderId:n.current.getPeerId(),data:L,timestamp:Date.now()};o.current?n.current.broadcastToGuests(O):n.current.sendMessageToHost(O)}},[t,n,r,o,s]),v=$.useCallback(E=>{var S;const L=Array.isArray(E)?E:[E],m=Date.now(),O=L.map((k,Y)=>({...k,timestamp:m+Y}));if(c(O),((S=t.current)==null?void 0:S.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:r.current.gameId,batch:O}));else if(n.current){const k={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:n.current.getPeerId(),data:{batch:O},timestamp:Date.now()};o.current?n.current.broadcastToGuests(k):n.current.sendMessageToHost(k)}},[t,n,r,o,c]),_=$.useCallback(E=>{var m;const L=Date.now();if(d({coords:E,timestamp:L}),((m=t.current)==null?void 0:m.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:r.current.gameId,coords:E,timestamp:L}));else if(n.current){const O={type:"NO_TARGET_TRIGGERED",senderId:n.current.getPeerId(),data:{coords:E,timestamp:L},timestamp:Date.now()};o.current?n.current.broadcastToGuests(O):n.current.sendMessageToHost(O)}},[t,n,r,o,d]),I=$.useCallback((E,L)=>{var O;const m={playerId:E,selectedByPlayerId:L,timestamp:Date.now()};if(g(S=>[...S,m]),((O=t.current)==null?void 0:O.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:r.current.gameId,deckSelectionData:m}));else if(n.current){const S={type:"DECK_SELECTION_TRIGGERED",senderId:n.current.getPeerId(),data:m,timestamp:Date.now()};o.current?n.current.broadcastToGuests(S):n.current.sendMessageToHost(S)}setTimeout(()=>{g(S=>S.filter(k=>k.timestamp!==m.timestamp))},1e3)},[t,n,r,o,g]),y=$.useCallback((E,L,m)=>{var S;const O={playerId:E,cardIndex:L,selectedByPlayerId:m,timestamp:Date.now()};if(T(k=>[...k,O]),((S=t.current)==null?void 0:S.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:r.current.gameId,handCardSelectionData:O}));else if(n.current){const k={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:n.current.getPeerId(),data:O,timestamp:Date.now()};o.current?n.current.broadcastToGuests(k):n.current.sendMessageToHost(k)}setTimeout(()=>{T(k=>k.filter(Y=>Y.timestamp!==O.timestamp))},1e3)},[t,n,r,o,T]),P=$.useCallback(E=>{var L;if(((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"SYNC_VALID_TARGETS",gameId:r.current.gameId,playerId:a.current,...E}));else if(n.current){const m={type:"SYNC_VALID_TARGETS",senderId:n.current.getPeerId(),data:{playerId:a.current,...E},timestamp:Date.now()};o.current?n.current.broadcastToGuests(m):n.current.sendMessageToHost(m)}},[t,n,r,o,a]),A=$.useCallback((E,L,m)=>{var S;if(a.current===null)return;const O={timestamp:Date.now(),location:E,boardCoords:L,handTarget:m,selectedByPlayerId:a.current};if(N(k=>[...k,O]),((S=t.current)==null?void 0:S.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_TARGET_SELECTION",gameId:r.current.gameId,effect:O}));else if(n.current)if(o.current){const k={type:"TARGET_SELECTION_TRIGGERED",senderId:n.current.getPeerId(),data:O,timestamp:Date.now()};n.current.broadcastToGuests(k)}else{const k={type:"SET_TARGETING_MODE",senderId:n.current.getPeerId(),data:O,timestamp:Date.now()};n.current.sendMessageToHost(k)}setTimeout(()=>{N(k=>k.filter(Y=>Y.timestamp!==O.timestamp))},1e3)},[t,n,r,o,a,N]),u=$.useCallback((E,L,m,O,S)=>{var te;const k=r.current;if(!k||!k.board){console.warn("[setTargetingMode] No game state or board available");return}let Y;O?Y=O:m&&(Y=ar(E,k,L,S));const V={playerId:L,action:E,sourceCoords:m,timestamp:Date.now(),boardTargets:Y};if(p(ee=>({...ee,targetingMode:V})),((te=t.current)==null?void 0:te.readyState)===WebSocket.OPEN&&k.gameId)t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:k.gameId,targetingMode:V}));else if(n.current){const ee={type:"SET_TARGETING_MODE",senderId:n.current.getPeerId(),data:V,timestamp:Date.now()};o.current?n.current.broadcastToGuests(ee):n.current.sendMessageToHost(ee)}},[t,n,r,o,p]),b=$.useCallback(()=>{var L;const E=r.current;if(p(m=>({...m,targetingMode:null})),((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&(E!=null&&E.gameId))t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:E.gameId}));else if(n.current){const m={type:"CLEAR_TARGETING_MODE",senderId:n.current.getPeerId(),data:{},timestamp:Date.now()};o.current?n.current.broadcastToGuests(m):n.current.sendMessageToHost(m)}},[t,n,r,o,p]);return{triggerHighlight:D,triggerFloatingText:v,triggerNoTarget:_,triggerDeckSelection:I,triggerHandCardSelection:y,syncValidTargets:P,triggerTargetSelection:A,setTargetingMode:u,clearTargetingMode:b}}function Qo(e){const{ws:t,webrtcManager:n,gameStateRef:r,webrtcIsHostRef:a,setGameState:o,updateState:s}=e,c=$.useCallback(p=>{var v;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&a.current){o(_=>{const I=_.players.map(y=>{let P=1;for(const[A,u]of Object.entries(p))if(u.includes(y.id)){P=parseInt(A);break}return{...y,teamId:P}});return{..._,players:I}}),n.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:n.current.getPeerId(),data:{assignments:p},timestamp:Date.now()});return}((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:r.current.gameId,assignments:p}))},[t,n,r,a,o]),d=$.useCallback(p=>{var v;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&a.current){o(_=>({..._,gameMode:p})),n.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:n.current.getPeerId(),data:{mode:p},timestamp:Date.now()});return}((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:r.current.gameId,mode:p}))},[t,n,r,a,o]),g=$.useCallback(p=>{var v;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&a.current){o(_=>({..._,isPrivate:p})),n.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:n.current.getPeerId(),data:{isPrivate:p},timestamp:Date.now()});return}((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:r.current.gameId,isPrivate:p}))},[t,n,r,a,o]),T=$.useCallback(p=>{s(D=>{if(D.isGameStarted)return D;const v={...D,activeGridSize:p};if(D.board.length!==p){v.board=[];for(let I=0;I<p;I++){const y=[];for(let P=0;P<p;P++)y.push({card:null});v.board.push(y)}}return v})},[s]),N=$.useCallback(p=>{s(D=>{if(D.isGameStarted)return D;const v=D.players.filter(y=>!y.isDummy);if(v.length+p>fo)return D;const _=[...v],I=Math.max(...v.map(y=>y.id),0);for(let y=0;y<p;y++){const P=I+y+1,A=ra(P,!0);A.name=`Dummy ${y+1}`,_.push(A)}return{...D,players:_,dummyPlayerCount:p}})},[s]);return{assignTeams:c,setGameMode:d,setGamePrivacy:g,setActiveGridSize:T,setDummyPlayerCount:N}}function es(e){const{ws:t,webrtcManager:n,gameStateRef:r,localPlayerIdRef:a,webrtcIsHostRef:o,setGameState:s}=e,c=$.useCallback(()=>{var N;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&o.current){s(p=>({...p,isReadyCheckActive:!0,isPrivate:!0})),n.current.broadcastToGuests({type:"START_READY_CHECK",senderId:n.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:r.current.gameId}))},[t,n,r,o,s]),d=$.useCallback(()=>{var N;if(localStorage.getItem("webrtc_enabled")==="true"&&n.current&&o.current){s(p=>({...p,isReadyCheckActive:!1})),n.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:n.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&r.current.gameId?t.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:r.current.gameId})):s(p=>({...p,isReadyCheckActive:!1}))},[t,n,r,o,s]),g=$.useCallback(()=>{var N;const T=localStorage.getItem("webrtc_enabled")==="true";if(T&&n.current&&o.current&&a.current!==null){s(p=>{const D=p.players.map(y=>y.id===a.current?{...y,isReady:!0}:y),v={...p,players:D},_=v.players.filter(y=>!y.isDummy&&!y.isDisconnected);if(_.length>0&&_.every(y=>y.isReady)&&v.isReadyCheckActive&&!v.isGameStarted){const y=v.players.filter(E=>!E.isDisconnected),P=Math.floor(Math.random()*y.length),A=y[P].id,u={...v};u.isReadyCheckActive=!1,u.isGameStarted=!0,u.startingPlayerId=A,u.activePlayerId=A,u.currentPhase=0,u.players=u.players.map(E=>{if(E.hand.length===0&&E.deck.length>0){const m=[...E.hand],O=[...E.deck];for(let S=0;S<6&&S<O.length;S++){const k=O[0];O.splice(0,1),m.push(k)}return l.info(`[playerReady] Drew initial ${m.length} cards for player ${E.id}`),{...E,hand:m,deck:O}}return E});const b=u.players.find(E=>E.id===A);if(b&&b.deck.length>0){const E=b.deck[0],L=[...b.deck.slice(1)],m=[...b.hand,E];u.players=u.players.map(O=>O.id===A?{...O,deck:L,hand:m,readySetup:!1,readyCommit:!1}:O),u.currentPhase=1}return n.current.broadcastGameState(u),n.current.broadcastToGuests({type:"GAME_START",senderId:n.current.getPeerId(),data:{startingPlayerId:A,activePlayerId:A,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),u}return n.current.broadcastToGuests({type:"HOST_READY",senderId:n.current.getPeerId(),playerId:a.current??void 0,timestamp:Date.now()}),v});return}if(T&&n.current&&!o.current&&a.current!==null){n.current.sendMessageToHost({type:"PLAYER_READY",senderId:n.current.getPeerId(),playerId:a.current,timestamp:Date.now()}),s(p=>({...p,players:p.players.map(D=>D.id===a.current?{...D,isReady:!0}:D)}));return}((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&r.current.gameId&&a.current!==null&&t.current.send(JSON.stringify({type:"PLAYER_READY",gameId:r.current.gameId,playerId:a.current}))},[t,n,r,a,o,s]);return{startReadyCheck:c,cancelReadyCheck:d,playerReady:g}}function ts(e){const{updateState:t}=e,n=$.useCallback((a,o)=>{t(s=>s.isGameStarted?s:{...s,players:s.players.map(c=>c.id===a?{...c,name:o}:c)})},[t]),r=$.useCallback((a,o)=>{t(s=>({...s,players:s.players.map(c=>c.id===a?{...c,color:o}:c)}))},[t]);return{updatePlayerName:n,changePlayerColor:r}}function rs(e){const{updateState:t}=e,n=$.useCallback(c=>{t(d=>{if(!d.isGameStarted)return d;const g=d.players.find(D=>D.id===c);if(!g||g.deck.length===0)return d;const T=He(d),N=T.players.find(D=>D.id===c),p=N.deck.shift();return p&&N.hand.push(p),T})},[t]),r=$.useCallback((c,d)=>{d<=0||t(g=>{if(!g.isGameStarted)return g;const T=g.players.find(v=>v.id===c);if(!T||T.deck.length===0)return g;const N=He(g),p=N.players.find(v=>v.id===c),D=Math.min(d,p.deck.length);for(let v=0;v<D;v++){const _=p.deck.shift();_&&p.hand.push(_)}return N})},[t]),a=$.useCallback(c=>{t(d=>{if(!d.isGameStarted||!d.players.find(p=>p.id===c))return d;const T=He(d),N=T.players.find(p=>p.id===c);return N.deck=vr([...N.deck]),T})},[t]),o=$.useCallback(c=>{t(d=>{if(!d.isGameStarted)return d;const g={...d},T=g.board[c.row][c.col].card;return T&&(T.isFaceDown=!1),{...g,board:tt(g)}})},[t]),s=$.useCallback(c=>{t(d=>{if(!d.isGameStarted)return d;const g={...d},T=g.board[c.row][c.col].card;return T&&(T.isFaceDown=!0),{...g,board:tt(g)}})},[t]);return{drawCard:n,drawCardsBatch:r,shufflePlayerDeck:a,flipBoardCard:o,flipBoardCardFaceDown:s}}function ns(e){const{localPlayerIdRef:t,updateState:n}=e,r=$.useCallback((y,P,A)=>{n(u=>{var L,m;if(!u.isGameStarted)return u;const b=He(u),E=b.board[y.row][y.col].card;if(E){if(P==="Stun"&&(E.baseId==="luciusTheImmortal"||E.name.includes("Lucius")&&((L=E.types)!=null&&L.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(P)&&((m=E.statuses)==null?void 0:m.some(S=>S.type===P&&S.addedByPlayerId===A)))return u;E.statuses||(E.statuses=[]),E.statuses.push({type:P,addedByPlayerId:A})}return b})},[n]),a=$.useCallback((y,P)=>{n(A=>{if(!A.isGameStarted)return A;const u=He(A),b=u.board[y.row][y.col].card;if(b!=null&&b.statuses){const E=b.statuses.map(L=>L.type).lastIndexOf(P);E>-1&&b.statuses.splice(E,1)}return u.board=tt(u),u})},[n]),o=$.useCallback((y,P,A)=>{n(u=>{if(!u.isGameStarted)return u;const b=He(u),E=b.board[y.row][y.col].card;if(E!=null&&E.statuses){const L=E.statuses.findIndex(m=>m.type===P&&m.addedByPlayerId===A);L>-1&&E.statuses.splice(L,1)}return b.board=tt(b),b})},[n]),s=$.useCallback((y,P)=>{n(A=>{if(!A.isGameStarted)return A;const u=He(A),b=u.board[y.row][y.col].card;return b&&(b.powerModifier===void 0&&(b.powerModifier=0),b.powerModifier+=P),u})},[n]),c=$.useCallback((y,P,A)=>{n(u=>{var L;if(!u.isGameStarted)return u;const b=He(u),E=b.players.find(m=>m.id===y);if(E!=null&&E.announcedCard){if(["Support","Threat","Revealed"].includes(P)&&((L=E.announcedCard.statuses)==null?void 0:L.some(O=>O.type===P&&O.addedByPlayerId===A)))return u;E.announcedCard.statuses||(E.announcedCard.statuses=[]),E.announcedCard.statuses.push({type:P,addedByPlayerId:A})}return b})},[n]),d=$.useCallback((y,P)=>{n(A=>{var E;if(!A.isGameStarted)return A;const u=He(A),b=u.players.find(L=>L.id===y);if((E=b==null?void 0:b.announcedCard)!=null&&E.statuses){const L=b.announcedCard.statuses.map(m=>m.type).lastIndexOf(P);L>-1&&b.announcedCard.statuses.splice(L,1)}return u})},[n]),g=$.useCallback((y,P)=>{n(A=>{if(!A.isGameStarted)return A;const u=He(A),b=u.players.find(E=>E.id===y);return b!=null&&b.announcedCard&&(b.announcedCard.powerModifier===void 0&&(b.announcedCard.powerModifier=0),b.announcedCard.powerModifier+=P),u})},[n]),T=$.useCallback((y,P,A,u)=>{n(b=>{var m;if(!b.isGameStarted)return b;const E=He(b),L=E.players.find(O=>O.id===y);if(L!=null&&L.hand[P]){const O=L.hand[P];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(A)&&((m=O.statuses)==null?void 0:m.some(k=>k.type===A&&k.addedByPlayerId===u)))return b;O.statuses||(O.statuses=[]),O.statuses.push({type:A,addedByPlayerId:u})}return E})},[n]),N=$.useCallback((y,P,A)=>{n(u=>{if(!u.isGameStarted)return u;const b=He(u),E=b.players.find(m=>m.id===y),L=E==null?void 0:E.hand[P];if(L!=null&&L.statuses){const m=L.statuses.map(O=>O.type).lastIndexOf(A);m>-1&&L.statuses.splice(m,1),A==="Revealed"&&(L.statuses.some(S=>S.type==="Revealed")||delete L.revealedTo)}return b})},[n]),p=$.useCallback((y,P,A)=>{n(u=>{const b=u.players.find(m=>m.id===y);if(!(b!=null&&b.hand[P]))return u;const E=He(u),L=E.players.find(m=>m.id===y).hand[P];if(A==="all")L.revealedTo="all",L.statuses||(L.statuses=[]),L.statuses.some(m=>m.type==="Revealed"&&m.addedByPlayerId===y)||L.statuses.push({type:"Revealed",addedByPlayerId:y});else{(!L.revealedTo||L.revealedTo==="all"||!Array.isArray(L.revealedTo))&&(L.revealedTo=[]);const m=A.filter(O=>!L.revealedTo.includes(O));L.revealedTo.push(...m)}return E})},[n]),D=$.useCallback((y,P)=>{n(A=>{if(!A.board[y.row][y.col].card)return A;const b=He(A),E=b.board[y.row][y.col].card,L=E.ownerId;if(P==="all")E.revealedTo="all",L!==void 0&&(E.statuses||(E.statuses=[]),E.statuses.some(m=>m.type==="Revealed"&&m.addedByPlayerId===L)||E.statuses.push({type:"Revealed",addedByPlayerId:L}));else{(!E.revealedTo||E.revealedTo==="all"||!Array.isArray(E.revealedTo))&&(E.revealedTo=[]);const m=P.filter(O=>!E.revealedTo.includes(O));E.revealedTo.push(...m)}return b})},[n]),v=$.useCallback((y,P)=>{n(A=>{var L;const u=y.boardCoords?(L=A.board[y.boardCoords.row][y.boardCoords.col].card)==null?void 0:L.ownerId:y.ownerId;if(!u)return A;const b=He(A),E=b.revealRequests.find(m=>m.fromPlayerId===P&&m.toPlayerId===u);return E?E.cardIdentifiers.some(O=>JSON.stringify(O)===JSON.stringify(y))||E.cardIdentifiers.push(y):b.revealRequests.push({fromPlayerId:P,toPlayerId:u,cardIdentifiers:[y]}),b})},[n]),_=$.useCallback((y,P)=>{n(A=>{const u=A.revealRequests.findIndex(L=>L.toPlayerId===t.current&&L.fromPlayerId===y);if(u===-1)return A;const b=He(A),E=b.revealRequests[u];if(P){const{cardIdentifiers:L}=E;for(const m of L){let O=null;if(m.source==="board"&&m.boardCoords)O=b.board[m.boardCoords.row][m.boardCoords.col].card;else if(m.source==="hand"&&m.ownerId&&m.cardIndex!==void 0){const S=b.players.find(k=>k.id===m.ownerId);S&&(O=S.hand[m.cardIndex])}O&&(O.statuses||(O.statuses=[]),O.statuses.some(S=>S.type==="Revealed"&&S.addedByPlayerId===y)||O.statuses.push({type:"Revealed",addedByPlayerId:y}))}}return b.revealRequests.splice(u,1),b})},[n,t]),I=$.useCallback(y=>{n(P=>{const A=He(P);let u=null;if(y.source==="board"&&y.boardCoords)u=A.board[y.boardCoords.row][y.boardCoords.col].card;else if(y.source==="hand"&&y.playerId&&y.cardIndex!==void 0){const b=A.players.find(E=>E.id===y.playerId);b&&(u=b.hand[y.cardIndex])}return u&&(u.statuses&&(u.statuses=u.statuses.filter(b=>b.type!=="Revealed")),delete u.revealedTo),A})},[n]);return{addBoardCardStatus:r,removeBoardCardStatus:a,removeBoardCardStatusByOwner:o,modifyBoardCardPower:s,addAnnouncedCardStatus:c,removeAnnouncedCardStatus:d,modifyAnnouncedCardPower:g,addHandCardStatus:T,removeHandCardStatus:N,revealHandCard:p,revealBoardCard:D,requestCardReveal:v,respondToRevealRequest:_,removeRevealedStatus:I}}function as(e){const{webrtcIsHostRef:t,sendWebrtcAction:n,webrtcManagerRef:r,localPlayerIdRef:a,getCardDefinition:o,commandCardIds:s,createDeck:c,updateState:d}=e,g=$.useCallback((_,I)=>{const y=localStorage.getItem("webrtc_enabled")==="true";if(y&&!t.current)try{localStorage.setItem("webrtc_preferred_deck",I),l.info(`[changePlayerDeck] Saved deck preference: ${I}`)}catch(u){l.warn("[changePlayerDeck] Failed to save deck preference:",u)}const P=c(I,_,"Player "+_);if(d(u=>u.isGameStarted?u:{...u,players:u.players.map(b=>b.id===_?{...b,deck:P,selectedDeck:I,hand:[],discard:[],announcedCard:null,boardHistory:[]}:b)}),l.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${y}, isHost=${t.current}, hasSendAction=${!!n}, hasManager=${!!(r!=null&&r.current)}`),!y)return;const A=P.map(u=>({id:u.id,baseId:u.baseId,power:u.power,powerModifier:u.powerModifier||0,isFaceDown:u.isFaceDown||!1,statuses:u.statuses||[]}));t.current?r!=null&&r.current?(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:_,deckType:I,deck:A,deckSize:A.length}}),l.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${_}, deck ${I}, ${A.length} cards`)):l.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available"):n?(n("CHANGE_PLAYER_DECK",{playerId:_,deckType:I,deck:A,deckSize:A.length}),l.info(`[changePlayerDeck] Guest sending deck data to host: player ${_}, deck ${I}, ${A.length} cards`)):l.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[d,c,n,t,r,a]),T=$.useCallback((_,I)=>{const y=localStorage.getItem("webrtc_enabled")==="true";let P=[];const A=new Map;for(const{cardId:b,quantity:E}of I.cards){const L=o(b);if(!L)continue;const m=s.has(b),O=m?ze.Command:ze.Custom,S=m?"CMD":"CUS";for(let k=0;k<E;k++){const Y=(A.get(b)||0)+1;A.set(b,Y),P.push({...L,id:`${S}_${b.toUpperCase()}_${Y}`,baseId:b,deck:O,ownerId:_,ownerName:"Player "+_})}}if(P=vr(P),d(b=>b.isGameStarted||!b.players.find(L=>L.id===_)?b:{...b,players:b.players.map(L=>L.id===_?{...L,deck:P,selectedDeck:ze.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:L)}),!y)return;const u=P.map(b=>({id:b.id,baseId:b.baseId,power:b.power,powerModifier:b.powerModifier||0,isFaceDown:b.isFaceDown||!1,statuses:b.statuses||[]}));t.current?r!=null&&r.current&&(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:_,deckType:ze.Custom,deck:u,deckSize:u.length}}),l.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${_}, ${u.length} cards`)):n&&(n("CHANGE_PLAYER_DECK",{playerId:_,deckType:ze.Custom,deck:u,deckSize:u.length}),l.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${_}, ${u.length} cards`))},[d,o,s,n,t,r,a]),N=$.useCallback((_,I,y,P)=>{d(A=>{if(!A.isGameStarted||A.board[y.row][y.col].card!==null)return A;const u=He(A),b=u.players.find(E=>E.id===_);if(b&&b.discard.length>I){const[E]=b.discard.splice(I,1);E.enteredThisTurn=!0,Dr(E,_),(E.baseId==="luciusTheImmortal"||E.name.includes("Lucius"))&&(E.powerModifier===void 0&&(E.powerModifier=0),E.powerModifier+=2),E.statuses||(E.statuses=[]),E.statuses.push({type:"Resurrected",addedByPlayerId:_}),P&&P.forEach(L=>{var m;L.type!=="Resurrected"&&((m=E.statuses)==null||m.push({type:L.type,addedByPlayerId:_}))}),b.boardHistory||(b.boardHistory=[]),b.boardHistory.push(E.id),u.board[y.row][y.col].card=E,ea(u.board,b),u.board=tt(u)}return u})},[d]),p=$.useCallback((_,I)=>{d(y=>{const P=He(y),A=P.players.find(u=>u.id===_);if(A&&I.length>0){const u=new Set(I.map(E=>E.id)),b=A.deck.filter(E=>!u.has(E.id));A.deck=[...I,...b]}return P})},[d]),D=$.useCallback((_,I,y)=>{d(P=>{const A=He(P),u=A.players.find(b=>b.id===_);return u&&(y==="deck"?u.deck=I:y==="discard"&&(u.discard=I)),A})},[d]),v=$.useCallback((_,I)=>{d(y=>{if(!y.isGameStarted)return y;const P=He(y),A=P.players.find(u=>u.id===_);if(A&&A.discard.length>I){const[u]=A.discard.splice(I,1);A.hand.push(u)}return P})},[d]);return{changePlayerDeck:g,loadCustomDeck:T,resurrectDiscardedCard:N,reorderTopDeck:p,reorderCards:D,recoverDiscardedCard:v}}function os(e){const{ws:t,webrtcManagerRef:n,webrtcIsHostRef:r,gameStateRef:a,scoreDeltaAccumulator:o,setGameState:s,updateState:c,abilityMode:d,setAbilityMode:g,createDeck:T}=e,N=$.useCallback(A=>{localStorage.getItem("webrtc_enabled")==="true"&&n.current?r.current?s(b=>{const E=Qn(b,A);return n.current&&n.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:n.current.getPeerId(),data:{activePlayerId:E.activePlayerId,currentPhase:E.currentPhase,turnNumber:E.turnNumber},timestamp:Date.now()}),E}):n.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:A},timestamp:Date.now()}):t.current&&t.current.readyState===WebSocket.OPEN&&(o.forEach((b,E)=>{clearTimeout(b.timerId),l.info(`[ScoreFlush] Flushing on toggle: player=${E}, delta=${b.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:a.current.gameId,playerId:E,delta:b.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:a.current.gameId,playerId:A})))},[t,n,r,a,o,s]),p=$.useCallback((A,u)=>{t.current&&t.current.readyState===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:a.current.gameId,playerId:A,enabled:u}))},[]),D=$.useCallback(A=>{const u=d&&g&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode);u&&g(null),c(b=>{if(!b.isGameStarted)return b;const E=Math.max(1,Math.min(A,4));return{...b,currentPhase:E,...E===4&&!u?{isScoringStep:!0}:{},...u?{isScoringStep:!1}:{}}})},[c,d,g]),v=$.useCallback(()=>{var b;d&&g&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&g(null);const A=a.current,u=localStorage.getItem("webrtc_enabled")==="true";if(A.isGameStarted&&A.currentPhase===4&&A.isScoringStep&&!u){((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&(o.forEach((E,L)=>{clearTimeout(E.timerId),l.info(`[ScoreFlush] Flushing pending score: player=${L}, delta=${E.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:A.gameId,playerId:L,delta:E.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:A.gameId})));return}if(u&&A.isGameStarted&&A.currentPhase===4&&A.isScoringStep){c(E=>rr(E));return}c(E=>{if(!E.isGameStarted)return E;const L=He(E),m=E.currentPhase+1;return E.preserveDeployAbilities||L.board.forEach(O=>{O.forEach(S=>{var k;(k=S.card)!=null&&k.statuses&&(S.card.statuses=S.card.statuses.filter(Y=>Y.type!=="readyDeploy"))})}),u&&m===4&&E.currentPhase===3?Yo(E,E.activePlayerId)?(L.isScoringStep=!0,L.currentPhase=4,L):(l.info(`[nextPhase] Player ${E.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),rr(E)):m===4&&E.currentPhase===3?(L.isScoringStep=!0,L.currentPhase=4,L):(L.board.forEach(O=>{O.forEach(S=>{var k;if((k=S.card)!=null&&k.statuses){const Y=S.card.statuses.findIndex(V=>V.type==="Resurrected");if(Y!==-1){const V=S.card.statuses[Y].addedByPlayerId;S.card.statuses.splice(Y,1),S.card.baseId!=="luciusTheImmortal"&&(S.card.statuses.push({type:"Stun",addedByPlayerId:V}),S.card.statuses.push({type:"Stun",addedByPlayerId:V}))}}})}),L.board=tt(L),L.currentPhase=m,L)})},[c,d,g,a,t,o]),_=$.useCallback(()=>{c(A=>A.isGameStarted?(d&&g&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&g(null),A.isScoringStep?{...A,isScoringStep:!1,currentPhase:Math.max(1,A.currentPhase-1)}:{...A,currentPhase:Math.max(1,A.currentPhase-1)}):A)},[c,d,g]),I=$.useCallback(()=>{var u;localStorage.getItem("webrtc_enabled")==="true"?c(b=>({...b,isRoundEndModalOpen:!1,currentRound:(b.currentRound||1)+1,players:b.players.map(E=>({...E,score:0}))})):((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&a.current.gameId&&(s(b=>({...b,isRoundEndModalOpen:!1,currentRound:(b.currentRound||1)+1,players:b.players.map(E=>({...E,score:0}))})),t.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:a.current.gameId})))},[s,c,t,a]),y=$.useCallback(()=>{s(A=>({...A,isRoundEndModalOpen:!1}))},[s]),P=$.useCallback(()=>{var u;if(localStorage.getItem("webrtc_enabled")==="true"){const b=a.current,E=b.players.map(S=>{const k=S.selectedDeck||"SynchroTech";return{...S,hand:[],deck:T(k,S.id,S.name),discard:[],score:0,isReady:!1,announcedCard:null,boardHistory:[]}}),L=b.activeGridSize||8,m=[];for(let S=0;S<L;S++){const k=[];for(let Y=0;Y<L;Y++)k.push({card:null});m.push(k)}const O={...b,players:E,board:m,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};s(O),a.current=O,n.current&&n.current.broadcastToGuests({type:"GAME_RESET",senderId:n.current.getPeerId(),data:{players:E.map(S=>({id:S.id,name:S.name,color:S.color,selectedDeck:S.selectedDeck,isDummy:S.isDummy,isDisconnected:S.isDisconnected,autoDrawEnabled:S.autoDrawEnabled,handSize:S.hand.length,deckSize:S.deck.length,discardSize:S.discard.length,...S.isDummy&&{hand:S.hand.map(k=>({id:k.id,baseId:k.baseId,name:k.name,imageUrl:k.imageUrl,power:k.power,powerModifier:k.powerModifier,ability:k.ability,ownerId:k.ownerId,color:k.color,deck:k.deck,isFaceDown:k.isFaceDown,types:k.types,faction:k.faction,statuses:k.statuses})),deck:S.deck.map(k=>({id:k.id,baseId:k.baseId,name:k.name,imageUrl:k.imageUrl,power:k.power,powerModifier:k.powerModifier,ability:k.ability,ownerId:k.ownerId,color:k.color,deck:k.deck,isFaceDown:k.isFaceDown,types:k.types,faction:k.faction,statuses:k.statuses})),discard:S.discard.map(k=>({id:k.id,baseId:k.baseId,name:k.name,imageUrl:k.imageUrl,power:k.power,powerModifier:k.powerModifier,ability:k.ability,ownerId:k.ownerId,color:k.color,deck:k.deck,isFaceDown:k.isFaceDown,types:k.types,faction:k.faction,statuses:k.statuses}))},score:S.score,isReady:S.isReady,announcedCard:S.announcedCard})),gameMode:O.gameMode,isPrivate:O.isPrivate,activeGridSize:O.activeGridSize,dummyPlayerCount:O.dummyPlayerCount,autoAbilitiesEnabled:O.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"RESET_GAME",gameId:a.current.gameId}))},[t,n,a,s,T]);return{toggleActivePlayer:N,toggleAutoDraw:p,setPhase:D,nextPhase:v,prevPhase:_,closeRoundEndModal:I,closeRoundEndModalOnly:y,resetGame:P}}function ss(e){const{ws:t,gameStateRef:n,updateState:r,updatePlayerScore:a,triggerFloatingText:o}=e,s=$.useCallback((d,g,T,N,p)=>{var L,m;const D=n.current;if(!D.isGameStarted||D.isRoundEndModalOpen)return;const v=D.board.some(O=>O.some(S=>{var k,Y;return((k=S.card)==null?void 0:k.ownerId)===p&&S.card.name.toLowerCase().includes("data liberator")&&((Y=S.card.statuses)==null?void 0:Y.some(V=>V.type==="Support"))})),_=D.board.length;let I=d,y=d,P=g,A=g;if(d===T)I=d,y=d,P=0,A=_-1;else if(g===N)P=g,A=g,I=0,y=_-1;else return;let u=0;const b=[];for(let O=I;O<=y;O++)for(let S=P;S<=A;S++){const Y=D.board[O][S].card;if(Y&&!((L=Y.statuses)!=null&&L.some(V=>V.type==="Stun"))){const V=Y.ownerId===p,te=(m=Y.statuses)==null?void 0:m.some(ee=>ee.type==="Exploit"&&ee.addedByPlayerId===p);if(V||v&&te&&Y.ownerId!==p){const ee=Math.max(0,Y.power+(Y.powerModifier||0)+(Y.bonusPower||0));ee>0&&(u+=ee,b.push({row:O,col:S,text:`+${ee}`,playerId:p}))}}}b.length>0&&o(b);const E=localStorage.getItem("webrtc_enabled")==="true";E?r(O=>({...O,players:O.players.map(S=>S.id===p?{...S,score:Math.max(0,(S.score||0)+u)}:S)})):a(p,u),E||a(p,u),u>0&&D.currentPhase===4&&D.activePlayerId===p&&setTimeout(()=>{var O;E?r(S=>rr(S)):((O=t.current)==null?void 0:O.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:D.gameId}))},100)},[o,a,r,t,n]),c=$.useCallback((d,g,T,N,p,D)=>{var E,L;const v=n.current;if(!v.isGameStarted||v.isRoundEndModalOpen)return;const _=T>d?1:-1,I=N>g?1:-1,y=Math.abs(d-T);let P=0,A=0;const u=[];for(let m=0;m<=y;m++){const O=d+m*_,S=g+m*I;if(O<0||O>=v.board.length||S<0||S>=v.board.length)continue;const Y=v.board[O][S].card;if(Y&&!((E=Y.statuses)!=null&&E.some(V=>V.type==="Stun"))&&Y.ownerId===p){const te=Math.max(0,Y.power+(Y.powerModifier||0)+(Y.bonusPower||0));te>0&&(P+=te,u.push({row:O,col:S,text:`+${te}`,playerId:p})),D&&((L=Y.statuses)!=null&&L.some(ee=>ee.type==="Support"&&ee.addedByPlayerId===p))&&(A+=1)}}D==="point_per_support"&&A>0&&(P+=A),u.length>0&&o(u);const b=localStorage.getItem("webrtc_enabled")==="true";b?r(m=>({...m,players:m.players.map(O=>O.id===p?{...O,score:Math.max(0,(O.score||0)+P)}:O)})):a(p,P),b||a(p,P),D==="draw_per_support"&&A>0&&r(m=>{const O=He(m),S=O.players.find(k=>k.id===p);if(S&&S.deck.length>0)for(let k=0;k<A;k++)S.deck.length>0&&S.hand.push(S.deck.shift());return O}),P>0&&v.currentPhase===4&&v.activePlayerId===p&&setTimeout(()=>{var m;b?r(O=>rr(O)):((m=t.current)==null?void 0:m.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:v.gameId}))},500)},[o,a,r,t,n]);return{scoreLine:s,scoreDiagonal:c}}const is=e=>{const{updateState:t,rawJsonData:n}=e,r=$.useCallback((N,p,D,v)=>{t(_=>{if(!_.isGameStarted)return _;const I=He(_),y=I.board[N.row][N.col].card;if(y){const P=y.statuses?y.statuses.map(A=>A.type):[];if(v&&y.statuses){y.statuses=y.statuses.filter(u=>u.type!==v);const A=y.statuses.map(u=>u.type);console.log(`[markAbilityUsed] Removed status '${v}' from ${y.name} at [${N.row},${N.col}]: [${P.join(", ")}] -> [${A.join(", ")}]`)}else console.log(`[markAbilityUsed] Called for ${y.name} at [${N.row},${N.col}] but no readyStatusToRemove specified. Current statuses: [${P.join(", ")}]`)}return I})},[t]),a=$.useCallback(N=>{t(p=>{if(!p.isGameStarted)return p;const D=He(p),v=D.board[N.row][N.col].card;if(v&&(v.statuses||(v.statuses=[]),(v.ability||"").toLowerCase().includes("deploy:")&&!v.statuses.some(I=>I.type==="readyDeploy"))){const I=v.ownerId;if(I==null||I===0)return p;v.statuses.push({type:"readyDeploy",addedByPlayerId:I})}return D})},[t]),o=$.useCallback((N,p)=>{t(D=>{if(!D.isGameStarted)return D;const v=He(D),_=v.board[N.row][N.col].card;return _!=null&&_.statuses&&(_.statuses=_.statuses.filter(I=>I.type!==p)),v.board=tt(v),v})},[t]),s=$.useCallback((N,p,D,v,_)=>{t(I=>{if(!I.isGameStarted)return I;const y=He(I);return p.forEach(({row:P,col:A})=>{var b;const u=y.board[P][A].card;if(u){if(D==="Stun"&&(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius")&&((b=u.types)!=null&&b.includes("Hero"))))return;u.statuses||(u.statuses=[]),["Support","Threat","Revealed"].includes(D)?u.statuses.some(L=>L.type===D&&L.addedByPlayerId===v)||u.statuses.push({type:D,addedByPlayerId:v}):u.statuses.push({type:D,addedByPlayerId:v})}}),y})},[t]),c=$.useCallback((N,p)=>{t(D=>{if(!D.isGameStarted)return D;const v=He(D),_=v.board[N.row][N.col].card,I=v.board[p.row][p.col].card;return v.board[N.row][N.col].card=I,v.board[p.row][p.col].card=_,v.board=tt(v),v})},[t]),d=$.useCallback((N,p,D)=>{t(v=>{if(!v.isGameStarted)return v;const _=He(v),I=_.board[N.row][N.col].card,y=_.board[p.row][p.col].card;if(I&&y&&I.statuses){const P=I.statuses.findIndex(A=>A.type===D);if(P>-1){const[A]=I.statuses.splice(P,1);y.statuses||(y.statuses=[]),y.statuses.push(A)}}return _.board=tt(_),_})},[t]),g=$.useCallback((N,p)=>{t(D=>{if(!D.isGameStarted)return D;const v=He(D),_=v.board[N.row][N.col].card,I=v.board[p.row][p.col].card,y=["Support","Threat","LastPlayed"];if(_&&I&&_.statuses){const P=_.statuses.filter(u=>!y.includes(u.type)),A=_.statuses.filter(u=>y.includes(u.type));P.length>0&&(I.statuses||(I.statuses=[]),I.statuses.push(...P),_.statuses=A)}return v.board=tt(v),v})},[t]),T=$.useCallback((N,p,D)=>{t(v=>{if(!v.isGameStarted)return v;const _=He(v);if(!n)return v;const I=n.tokenDatabase,y=Object.keys(I).find(u=>I[u].name===p);if(!y)return v;const P=I[y],A=_.players.find(u=>u.id===D);if(P&&_.board[N.row][N.col].card===null){const u={id:`TKN_${p.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:ze.Tokens,name:p,baseId:P.baseId||y,imageUrl:P.imageUrl,fallbackImage:P.fallbackImage,power:P.power,ability:P.ability,flavorText:P.flavorText,color:P.color,types:P.types||["Unit"],faction:"Tokens",ownerId:D,ownerName:A==null?void 0:A.name,enteredThisTurn:!0,statuses:[]};Dr(u,D),_.board[N.row][N.col].card=u}return _.board=tt(_),_})},[t,n]);return{markAbilityUsed:r,applyGlobalEffect:s,swapCards:c,transferStatus:d,transferAllCounters:g,spawnToken:T,resetDeployStatus:a,removeStatusByType:o}};function ds(e){const{updateState:t,localPlayerIdRef:n,updatePlayerScore:r}=e;return{moveItem:$.useCallback((o,s)=>{t(c=>{var v,_,I,y,P,A,u,b,E,L;if(!c.isGameStarted||s.target==="board"&&s.boardCoords&&c.board[s.boardCoords.row][s.boardCoords.col].card!==null&&o.source!=="counter_panel")return c;let d=!1;try{const m=localStorage.getItem("auto_abilities_enabled");d=m===null?!0:m==="true"}catch{d=!0}const g=d&&c.currentPhase===1&&o.source==="hand"&&s.target==="board"&&(((v=o.card.types)==null?void 0:v.includes("Unit"))||((_=o.card.types)==null?void 0:_.includes("Command"))),T=He(c);if(o.source==="board"&&["hand","deck","discard"].includes(s.target)&&!o.bypassOwnershipCheck){const m=o.card.ownerId,O=T.players.find(Y=>Y.id===m),S=m===n.current,k=!!(O!=null&&O.isDummy);if(!S&&!k)return c}let N=null;if(o.source==="board"&&s.target==="board"&&o.boardCoords){const m=T.board[o.boardCoords.row][o.boardCoords.col];m.card&&(N=m.card);const S=c.board[o.boardCoords.row][o.boardCoords.col].card||N;if(S&&((I=S.statuses)==null?void 0:I.some(Y=>Y.type==="Stun"))){const Y=n.current,V=S.ownerId,te=c.players.find(me=>me.id===Y),ee=c.players.find(me=>me.id===V),ye=Y===V,he=(te==null?void 0:te.teamId)!==void 0&&(ee==null?void 0:ee.teamId)!==void 0&&te.teamId===ee.teamId;if((ye||he)&&!o.isManual)return c}}if(o.source==="counter_panel"&&o.statusType){const m=Mt[o.statusType];if(!((m==null?void 0:m.allowedTargets)??["board","hand"]).includes(s.target))return c;let S=null;if(s.target==="board"&&s.boardCoords)S=T.board[s.boardCoords.row][s.boardCoords.col].card;else if(s.playerId!==void 0){const k=T.players.find(Y=>Y.id===s.playerId);k&&(s.target==="hand"&&s.cardIndex!==void 0&&(S=k.hand[s.cardIndex]),s.target==="announced"&&(S=k.announcedCard||null),s.target==="deck"&&k.deck.length>0?s.deckPosition==="top"||!s.deckPosition?S=k.deck[0]:S=k.deck[k.deck.length-1]:s.target==="discard"&&k.discard.length>0&&(S=k.discard[k.discard.length-1]))}if(S){if(o.statusType==="Stun"&&(S.baseId==="luciusTheImmortal"||S.name.includes("Lucius")&&((y=S.types)!=null&&y.includes("Hero"))))return T;const k=o.count||1;let Y;if(o.ownerId!==void 0)Y=o.ownerId;else if(o.card.ownerId!==void 0)Y=o.card.ownerId;else{const V=T.players.find(te=>te.id===T.activePlayerId);Y=V!=null&&V.isDummy?V.id:n.current!==null?n.current:0}if(o.statusType==="Power+")S.powerModifier===void 0&&(S.powerModifier=0),S.powerModifier+=1*k;else if(o.statusType==="Power-")S.powerModifier===void 0&&(S.powerModifier=0),S.powerModifier-=1*k;else if(S.statuses||(S.statuses=[]),o.replaceStatusType&&o.statusType)for(let V=0;V<k;V++){const te=S.statuses.findIndex(ee=>ee.type===o.replaceStatusType&&ee.addedByPlayerId===Y);te!==-1?S.statuses[te]={type:o.statusType,addedByPlayerId:Y}:S.statuses.push({type:o.statusType,addedByPlayerId:Y})}else for(let V=0;V<k;V++)["Support","Threat","Revealed"].includes(o.statusType)?S.statuses.some(ee=>ee.type===o.statusType&&ee.addedByPlayerId===Y)||S.statuses.push({type:o.statusType,addedByPlayerId:Y}):S.statuses.push({type:o.statusType,addedByPlayerId:Y});return s.target==="board"&&(T.board=tt(T)),T}return c}const p=N?{...N}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const m=T.players.find(O=>O.id===o.playerId);if(m){const O=m.hand[o.cardIndex];if(O&&O.id===o.card.id&&O.ownerId===o.card.ownerId)m.hand.splice(o.cardIndex,1);else{const S=m.hand.findIndex(k=>k.id===o.card.id&&k.ownerId===o.card.ownerId);if(S!==-1)m.hand.splice(S,1);else return c}}}else if(o.source==="board"&&o.boardCoords){const m=T.board[o.boardCoords.row][o.boardCoords.col];if(m.card&&m.card.id===o.card.id&&m.card.ownerId===o.card.ownerId)T.board[o.boardCoords.row][o.boardCoords.col].card=null;else return c}else if(o.source==="discard"&&o.playerId!==void 0){const m=T.players.find(O=>O.id===o.playerId);if(m){let O=!1;if(o.cardIndex!==void 0){const S=m.discard[o.cardIndex];S&&S.id===o.card.id&&S.ownerId===o.card.ownerId&&(m.discard.splice(o.cardIndex,1),O=!0)}if(!O){const S=m.discard.findIndex(k=>k.id===o.card.id&&k.ownerId===o.card.ownerId);if(S!==-1)m.discard.splice(S,1);else return c}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const m=T.players.find(O=>O.id===o.playerId);if(m){const O=m.deck[o.cardIndex];if(O&&O.id===o.card.id&&O.ownerId===o.card.ownerId)m.deck.splice(o.cardIndex,1);else{const S=m.deck.findIndex(k=>k.id===o.card.id&&k.ownerId===o.card.ownerId);if(S!==-1)m.deck.splice(S,1);else return c}}}else if(o.source==="announced"&&o.playerId!==void 0){const m=T.players.find(O=>O.id===o.playerId);if(m)if(m.announcedCard&&m.announcedCard.id===o.card.id)m.announcedCard=null;else return c}if(["hand","deck","discard"].includes(s.target))p.statuses&&(p.statuses=p.statuses.filter(m=>m.type==="Revealed")),p.isFaceDown=!1,delete p.powerModifier,delete p.bonusPower,delete p.enteredThisTurn;else if(s.target==="board"&&(p.statuses||(p.statuses=[]),o.source!=="board"&&p.isFaceDown===void 0&&(p.isFaceDown=!1),o.source!=="board")){p.enteredThisTurn=!0;let m=p.ownerId;m===void 0&&(o.source==="token_panel"?m=T.activePlayerId??n.current??0:o.playerId!==void 0?m=o.playerId:m=n.current??0,p.ownerId=m),Dr(p,m),o.source==="discard"&&(p.baseId==="luciusTheImmortal"||p.name.includes("Lucius"))&&(p.powerModifier===void 0&&(p.powerModifier=0),p.powerModifier+=2)}if(s.target==="hand"&&s.playerId!==void 0){if((p.deck===ze.Tokens||p.deck==="counter")&&(((P=p.types)==null?void 0:P.includes("Token"))||((A=p.types)==null?void 0:A.includes("Token Unit"))))return c;ur(p);const O=T.players.find(k=>k.id===s.playerId);if(!O)return c;let S=s.cardIndex!==void 0?s.cardIndex:O.hand.length;if(o.source==="hand"&&o.playerId===s.playerId&&o.cardIndex!==void 0&&(o.cardIndex<S&&(S-=1),o.cardIndex===S))return c;O.hand.splice(S,0,p)}else if(s.target==="board"&&s.boardCoords){if(T.board[s.boardCoords.row][s.boardCoords.col].card===null){if(p.ownerId===void 0&&n.current!==null){const m=T.players.find(O=>O.id===n.current);m&&(p.ownerId=m.id,p.ownerName=m.name)}if(o.source!=="board"&&p.ownerId!==void 0){const m=T.players.find(O=>O.id===p.ownerId);m&&(m.boardHistory||(m.boardHistory=[]),m.boardHistory.push(p.id))}T.board[s.boardCoords.row][s.boardCoords.col].card=p}}else if(s.target==="discard"&&s.playerId!==void 0){if(!(p.deck===ze.Tokens||p.deck==="counter")){ur(p),p.statuses&&(p.statuses=p.statuses.filter(O=>O.type!=="Revealed"));const m=T.players.find(O=>O.id===s.playerId);m&&(p.ownerId===void 0&&(p.ownerId=s.playerId,p.ownerName=m.name),m.discard.some(S=>S.id===p.id)||m.discard.push(p))}}else if(s.target==="deck"&&s.playerId!==void 0){if((p.deck===ze.Tokens||p.deck==="counter")&&(((u=p.types)==null?void 0:u.includes("Token"))||((b=p.types)==null?void 0:b.includes("Token Unit"))))return c;ur(p),p.statuses&&(p.statuses=p.statuses.filter(S=>S.type!=="Revealed"));const O=T.players.find(S=>S.id===s.playerId);if(!O)return c;p.ownerId===void 0&&(p.ownerId=s.playerId,p.ownerName=O.name),s.deckPosition==="top"||!s.deckPosition?O.deck.unshift(p):O.deck.push(p)}else if(s.target==="announced"&&s.playerId!==void 0){const m=T.players.find(O=>O.id===s.playerId);m&&(m.announcedCard&&(m.announcedCard.statuses&&(m.announcedCard.statuses=m.announcedCard.statuses.filter(O=>O.type==="Revealed")),delete m.announcedCard.enteredThisTurn,delete m.announcedCard.powerModifier,delete m.announcedCard.bonusPower,m.hand.push(m.announcedCard)),m.announcedCard=p)}if(o.source==="board"&&s.target!=="board"&&p.ownerId!==void 0){const m=T.players.find(O=>O.id===p.ownerId);m&&(m.boardHistory||(m.boardHistory=[]),m.boardHistory=m.boardHistory.filter(O=>O!==p.id))}if((o.source==="board"||s.target==="board")&&p.ownerId!==void 0){const m=T.players.find(O=>O.id===p.ownerId);m&&ea(T.board,m)}if(o.source==="hand"&&s.target==="board"){const m=p;if(m.revealedTo==="all"||((E=m.statuses)==null?void 0:E.some(S=>S.type==="Revealed"))){const S=T.board.length;for(let k=0;k<S;k++)for(let Y=0;Y<S;Y++){const V=T.board[k][Y].card;if(V&&V.name.toLowerCase().includes("vigilant spotter")&&V.ownerId!==m.ownerId&&(T.board=tt(T),(L=T.board[k][Y].card.statuses)!=null&&L.some(ee=>ee.type==="Support"))){const ee=T.players.find(ye=>ye.id===V.ownerId);ee&&setTimeout(()=>{r(ee.id,2)},0)}}}}return(o.source==="board"||s.target==="board")&&(T.board=tt(T)),g&&(T.currentPhase=2),T})},[t,n,r])}}function cs(e){const{ws:t,webrtcManager:n,gameStateRef:r,webrtcIsHostRef:a,setGameState:o}=e,s=$.useCallback((d,g,T,N,p)=>{var P,A,u,b,E,L,m;const D=r.current;let v=[];N?v=N:v=ar(d,D,g,p);const _=[],I=d.mode==="SELECT_DECK";if((P=d.payload)!=null&&P.filter&&d.mode==="SELECT_TARGET"){const O=((A=d.sourceCard)==null?void 0:A.ownerId)||d.originalOwnerId||g,S=D.players.find(k=>k.id===O);S&&S.hand&&S.hand.forEach((k,Y)=>{try{d.payload.filter(k)&&_.push({playerId:S.id,cardIndex:Y})}catch{}})}const y={playerId:g,action:d,sourceCoords:T,timestamp:Date.now(),boardTargets:v,handTargets:_.length>0?_:void 0,isDeckSelectable:I||void 0,originalOwnerId:d.originalOwnerId};o(O=>({...O,targetingMode:y})),r.current.targetingMode=y,((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&D.gameId&&t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:D.gameId,targetingMode:y})),n.current&&(a.current?n.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((E=(b=n.current).getPeerId)==null?void 0:E.call(b))??void 0,data:{targetingMode:y},timestamp:Date.now()}):n.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((m=(L=n.current).getPeerId)==null?void 0:m.call(L))??void 0,data:{targetingMode:y},timestamp:Date.now()})),l.info(`[TargetingMode] Player ${g} activated targeting mode`,{mode:d.mode,boardTargetsCount:v.length})},[t,n,r,a,o]),c=$.useCallback(()=>{var g,T,N,p,D;const d=r.current;o(v=>({...v,targetingMode:null})),r.current.targetingMode=null,((g=t.current)==null?void 0:g.readyState)===WebSocket.OPEN&&d.gameId&&t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:d.gameId})),n.current&&(a.current?n.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((N=(T=n.current).getPeerId)==null?void 0:N.call(T))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):n.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((D=(p=n.current).getPeerId)==null?void 0:D.call(p))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[t,n,r,a,o]);return{setTargetingMode:s,clearTargetingMode:c}}function ls(e){const{webrtcManagerRef:t,webrtcIsHostRef:n,setWebrtcIsHost:r,setConnectionStatus:a,setWebrtcHostId:o,gameStateRef:s,localPlayerIdRef:c}=e,d=$.useCallback(async()=>{var D;if(!t.current)return l.error("WebRTC manager not initialized"),null;try{r(!0),a("Connecting");const v=await t.current.initializeAsHost();o(v),a("Connected");const _=s.current.gameId;_&&br(v,_);const I=(D=s.current.players)==null?void 0:D.find(y=>y.id===c.current);return wo({peerId:v,isHost:!0,playerName:(I==null?void 0:I.name)||null}),l.info("[initializeWebrtcHost] Saved host data for auto-restore"),v}catch(v){return l.error("Failed to initialize WebRTC host:",v),a("Disconnected"),null}},[t,r,a,o,s,c]),g=$.useCallback(async D=>{if(!t.current)return l.error("WebRTC manager not initialized"),!1;try{return r(!1),o(D),a("Connecting"),await t.current.initializeAsGuest(D),!0}catch(v){return l.error("Failed to connect as guest:",v),a("Disconnected"),!1}},[t,r,a,o]),T=$.useCallback((D,v)=>t.current?n.current?(l.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):t.current.sendAction(D,v):(l.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[t,n]),N=$.useCallback(D=>{var _,I;if(!t.current||n.current)return l.warn("[requestDeckView] Only guests can request deck view from host"),!1;const v={type:"REQUEST_DECK_VIEW",senderId:t.current.getPeerId(),playerId:n.current||(I=(_=t.current).getLocalPlayerId)==null?void 0:I.call(_),data:{targetPlayerId:D},timestamp:Date.now()};return t.current.sendMessageToHost(v)},[t,n]),p=$.useCallback((D,v,_)=>!t.current||n.current?(l.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):t.current.sendFullDeckToHost(D,v,_),[t,n]);return{initializeWebrtcHost:d,connectAsGuest:g,sendWebrtcAction:T,requestDeckView:N,sendFullDeckToHost:p}}function us(e){const{ws:t,gameStateRef:n,localPlayerIdRef:r,isRestoringSessionRef:a,isManualExitRef:o,webrtcIsHostRef:s,receivedServerStateRef:c,joiningGameIdRef:d,setGameState:g,setLocalPlayerId:T,connectWebSocket:N,updateState:p}=e,D=$.useCallback(()=>{t.current&&(t.current.readyState===WebSocket.OPEN||t.current.readyState===WebSocket.CONNECTING)?t.current.close():N()},[t,N]),v=$.useCallback(P=>{var A;if(o.current=!1,((A=t.current)==null?void 0:A.readyState)===WebSocket.OPEN){d.current=P;let u=null;try{const E=localStorage.getItem(St);E&&(u=JSON.parse(E))}catch{Lt()}const b={type:"JOIN_GAME",gameId:P};(u==null?void 0:u.gameId)===P&&u.playerToken?(b.playerToken=u.playerToken,l.info(`JoinGame: Sending reconnection with token ${u.playerToken.substring(0,8)}... for player ${u.playerId}`)):l.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${u==null?void 0:u.gameId}, requestedGameId=${P}`),t.current.send(JSON.stringify(b))}else N(),d.current=P},[t,o,d,N]),_=$.useCallback(()=>{o.current=!1,Lt();const P=ta(),A={...bt(),gameId:P,players:[ra(1)]};c.current=!0,p(A),setTimeout(()=>{var u;((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&(t.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:P})),t.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ft})))},Se.DECK_SYNC_DELAY)},[p,o,c,t]),I=$.useCallback(()=>{var P;((P=t.current)==null?void 0:P.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[t]),y=$.useCallback(()=>{var u;if(a.current)return;o.current=!0;const P=n.current.gameId,A=r.current;P&&s.current&&_o(P);try{vt(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),l.info("[exitGame] Cleared WebRTC persistence data")}catch(b){l.warn("[exitGame] Failed to clear WebRTC data:",b)}g(bt()),T(null),Lt(),t.current&&(t.current.onclose=null),((u=t.current)==null?void 0:u.readyState)===WebSocket.OPEN&&P&&A!==null&&t.current.send(JSON.stringify({type:"EXIT_GAME",gameId:P,playerId:A})),t.current&&t.current.close(),setTimeout(()=>{o.current=!1,N()},Se.RECONNECT_DELAY)},[a,o,n,r,s,g,T,t,N]);return{createGame:_,requestGamesList:I,exitGame:y,forceReconnect:D,joinGame:v}}const mt=new Map,Ls=(e={})=>{const{abilityMode:t,setAbilityMode:n}=e,[r,a]=$.useState(bt()),o=$.useRef(bt()),s=$.useCallback(i=>{a(oe=>{const U=typeof i=="function"?i(oe):i;return o.current=oe,localStorage.getItem("webrtc_enabled")==="true"&&ne.current&&setTimeout(()=>{x.current&&(x.current.broadcastGameState(U),l.debug(`[setGameStateWithDelta] Broadcast state: phase=${U.currentPhase}, round=${U.currentRound}`))},0),U})},[]),[c,d]=$.useState(null),g=$.useRef(r),T=$.useRef(c),[N,p]=$.useState(null),[D,v]=$.useState("Connecting"),[_,I]=$.useState([]),[y,P]=$.useState(null),[A,u]=$.useState(null),[b,E]=$.useState(null),[L,m]=$.useState([]),[O,S]=$.useState([]),[k,Y]=$.useState([]),[V,te]=$.useState(null),[ee,ye]=$.useState(!!ft),[he,me]=$.useState(!1),[Fe,Ge]=$.useState(null),[ve,rt]=$.useState(!1),ne=$.useRef(!1),[Ot,Je]=$.useState(!1),[wt,ot]=$.useState(null),ut=$.useRef(!1),_e=$.useRef(null),Qe=$.useRef(null),ht=$.useRef(null),f=$.useRef(!1),G=$.useRef(!1),X=$.useRef(void 0),we=$.useRef(!1),x=$.useRef(null),$e=$.useRef(()=>{}),Be=ls({webrtcManagerRef:x,webrtcIsHostRef:ne,setWebrtcIsHost:rt,setConnectionStatus:v,setWebrtcHostId:Ge,gameStateRef:g,localPlayerIdRef:T}),{initializeWebrtcHost:Ke,connectAsGuest:xe,sendWebrtcAction:Ze,requestDeckView:st,sendFullDeckToHost:it}=Be;$.useEffect(()=>{$e.current=s},[s]),$.useEffect(()=>{ne.current=ve},[ve]),$.useEffect(()=>{const i=localStorage.getItem("webrtc_enabled")==="true";if(me(i),i){x.current=Fo();const oe=x.current.on(U=>{Ve(U)});return()=>{oe()}}},[]),$.useEffect(()=>{if(!(localStorage.getItem("webrtc_enabled")==="true"))return;const oe=window.location.hash.slice(1);if(oe&&new URLSearchParams(oe).get("hostId"))return;const U="webrtc_auto_restore_attempted";if(sessionStorage.getItem(U))return;sessionStorage.setItem(U,"true");const B=Co();if(B==="none"){sessionStorage.removeItem(U);return}setTimeout(async()=>{var J,ie;if(!x.current){l.warn("[Auto-restore] WebRTC manager not ready");return}try{if(B==="host"){Ue.current=!0,l.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ce=Bn(),Z=Nn();if(!ce||!Z){l.warn("[Auto-restore] Missing host data or state data"),vt(),Ue.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}l.info(`[Auto-restore] Restoring host session: old peerId=${ce.peerId}`);const Le=await x.current.initializeAsHost();ne.current=!0,rt(!0),Ge(Le),v("Connected"),(J=Z.gameState)!=null&&J.gameId&&(br(Le,Z.gameState.gameId),l.info(`[Auto-restore] Broadcasted NEW host peerId ${Le} for game ${Z.gameState.gameId}`)),(Z.gameState||Z.localPlayerId!==null)&&(Z.gameState&&(g.current=Z.gameState),Z.localPlayerId!==null&&(T.current=Z.localPlayerId),ut.current=!0,setTimeout(()=>{ut.current=!1},1e4),setTimeout(()=>{var We;Z.gameState&&(a(Z.gameState),l.info(`[Auto-restore] Restored game state with ${((We=Z.gameState.players)==null?void 0:We.length)||0} players, gameId=${Z.gameState.gameId}`)),Z.localPlayerId!==null&&(d(Z.localPlayerId),l.info(`[Auto-restore] Restored local player ID: ${Z.localPlayerId}`))},0)),setTimeout(()=>{if(Ue.current=!1,l.info("[Auto-restore] Cleared restoration flag"),x.current&&Z.gameState){const We=Z.gameState.players.filter(et=>!et.isDummy&&et.id!==Z.localPlayerId);We.length>0&&(l.info(`[Auto-restore] Requesting deck data from ${We.length} guest players`),x.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:x.current.getPeerId(),timestamp:Date.now()}))}},500),l.info("[Auto-restore] Host session restoration initiated")}else if(B==="guest"){Ue.current=!0,l.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ce=Yn(),Z=Nn();if(!ce||!Z){l.warn("[Auto-restore] Missing guest data or state data"),vt(),Ue.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}l.info(`[Auto-restore] Restoring guest session: old hostPeerId=${ce.hostPeerId}, playerId=${ce.playerId}`),ne.current=!1,rt(!1),v("Connecting");let Le=ce.hostPeerId;if((ie=Z.gameState)!=null&&ie.gameId){const We=pr(Z.gameState.gameId);We&&We.peerId&&(Le=We.peerId,l.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Le}`))}if(Ge(Le),ce.playerId!==null){l.info(`[Auto-restore] Reconnecting as existing player ${ce.playerId} to host ${Le}`);try{await x.current.initializeAsReconnectingGuest(Le,ce.playerId),v("Connected"),l.info("[Auto-restore] Successfully reconnected to host")}catch(We){l.error("[Auto-restore] Failed to reconnect to host:",We),v("Disconnected"),vt(),l.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),Ue.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else l.info("[Auto-restore] Connecting as new player"),await x.current.initializeAsGuest(Le),v("Connected");(Z.gameState||Z.localPlayerId!==null)&&(Z.gameState&&(g.current=Z.gameState),Z.localPlayerId!==null&&(T.current=Z.localPlayerId),ut.current=!0,setTimeout(()=>{ut.current=!1},1e4),setTimeout(()=>{var We,et;if(Z.gameState&&(a(Z.gameState),l.info(`[Auto-restore] Restored game state with ${((We=Z.gameState.players)==null?void 0:We.length)||0} players, gameId=${Z.gameState.gameId}, isGameStarted=${Z.gameState.isGameStarted}`),Z.localPlayerId!==null)){const Ae=(et=Z.gameState.players)==null?void 0:et.some(Me=>Me.id===Z.localPlayerId);l.info(`[Auto-restore] Player ${Z.localPlayerId} exists in restored state: ${Ae}`)}Z.localPlayerId!==null&&(d(Z.localPlayerId),l.info(`[Auto-restore] Restored local player ID: ${Z.localPlayerId}`))},0)),setTimeout(()=>{Ue.current=!1,l.info("[Auto-restore] Cleared restoration flag")},100),l.info("[Auto-restore] Guest session restoration initiated")}}catch(ce){l.error("[Auto-restore] Failed to restore session:",ce),vt(),Ue.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),$.useEffect(()=>{if(!he||!x.current)return;const i=window.location.hash.slice(1);if(!i)return;const U=new URLSearchParams(i).get("hostId");U&&xe(U)},[he]),$.useEffect(()=>{g.current=r},[r]),$.useEffect(()=>{T.current=c},[c]);const Ye=Zo({ws:_e,webrtcManager:x,gameStateRef:g,localPlayerIdRef:T,webrtcIsHostRef:ne,setLatestHighlight:P,setLatestFloatingTexts:u,setLatestNoTarget:E,setLatestDeckSelections:m,setLatestHandCardSelections:S,setTargetSelectionEffects:Y,setGameState:a}),Ue=$.useRef(!1);$.useEffect(()=>{if(!he||!ne.current||!(r!=null&&r.gameId))return;const i=r.gameId,oe=()=>{var J;const B=(J=x.current)==null?void 0:J.getPeerId();B&&i&&br(B,i)};oe();const U=setInterval(oe,2e3);return()=>clearInterval(U)},[he,r==null?void 0:r.gameId]),$.useEffect(()=>{if(!he||ne.current||!(r!=null&&r.gameId))return;const i=r.gameId,oe=J=>{var ie;Ge(J),v("Connecting"),(ie=x.current)==null||ie.initializeAsReconnectingGuest(J,T.current||0).then(()=>{v("Connected")}).catch(ce=>{l.error("[Guest Auto-Reconnect] Failed to reconnect:",ce),v("Disconnected")})},U=J=>{const ie=`webrtc_host_${i}`;if(!(J.key!==ie||!J.newValue))try{const Z=JSON.parse(J.newValue).peerId;Z&&Z!==Fe&&oe(Z)}catch(ce){l.error("[Guest Auto-Reconnect] Failed to parse storage event:",ce)}},B=setInterval(()=>{const J=pr(i);J&&J.peerId!==Fe&&(l.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${J.peerId}`),oe(J.peerId))},2e3);return window.addEventListener("storage",U),()=>{window.removeEventListener("storage",U),clearInterval(B)}},[he,r==null?void 0:r.gameId,Fe]),$.useEffect(()=>{const i=setInterval(()=>{a(oe=>{const U=Date.now(),B=oe.floatingTexts||[],J=B.filter(ie=>U-ie.timestamp<Se.FLOATING_TEXT_DURATION);return J.length!==B.length?{...oe,floatingTexts:J}:oe})},Se.DECK_SYNC_DELAY);return()=>clearInterval(i)},[]);const Ve=$.useCallback(i=>{var oe,U,B;switch(i.type){case"peer_open":(oe=i.data)!=null&&oe.peerId&&(Ge(i.data.peerId),l.info(`WebRTC peer opened with ID: ${i.data.peerId}`));break;case"guest_connected":l.info("Guest connected via WebRTC:",(U=i.data)==null?void 0:U.peerId);break;case"connected_to_host":(B=i.data)!=null&&B.hostPeerId&&Fe!==i.data.hostPeerId&&(Ge(i.data.hostPeerId),l.info(`Updated webrtcHostId to: ${i.data.hostPeerId}`)),v("Connected"),Je(!1),ot(null),ut.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(l.warn("WebRTC peer disconnected"),v("Disconnected"),Je(!0),!ne.current&&Fe&&r)try{const J={hostPeerId:Fe,playerId:c,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(J)),l.info("[Reconnection] Stored reconnection data before disconnect"),j(Fe)}catch(J){l.error("[Reconnection] Failed to store data:",J)}break;case"message_received":F(i.data);break;case"error":l.error("WebRTC error:",i.data);break}},[r,c,Fe,ve]),qe=$.useCallback((i,oe)=>{if(l.info(`[handleWebrtcGuestJoin] Called for guest ${i}, isHost: ${ne.current}`),!ne.current||!x.current){l.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const U=(oe==null?void 0:oe.preferredDeck)||"Random";a(B=>{if(!B)return l.error("[handleWebrtcGuestJoin] No previous state"),B;l.info(`[handleWebrtcGuestJoin] Current state has ${B.players.length} players`);const J=B.players.map(Ae=>Ae.id);let ie=1;for(;J.includes(ie);)ie++;const ce={id:ie,name:`Player ${ie}`,color:tr[J.length%tr.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:U,boardHistory:[],autoDrawEnabled:!0},Z={...B,players:[...B.players,ce]},Le=B.board.map(Ae=>Ae.map(Me=>({...Me,card:Me.card?{id:Me.card.id,baseId:Me.card.baseId,ownerId:Me.card.ownerId,name:Me.card.name,imageUrl:Me.card.imageUrl,power:Me.card.power,ability:Me.card.ability,isFaceDown:Me.card.isFaceDown,statuses:Me.card.statuses||[]}:null}))),We=Ae=>Ae.map(Me=>({id:Me.id,baseId:Me.baseId,name:Me.name,imageUrl:Me.imageUrl,power:Me.power,powerModifier:Me.powerModifier,ability:Me.ability,ownerId:Me.ownerId,color:Me.color,deck:Me.deck,isFaceDown:Me.isFaceDown,types:Me.types,faction:Me.faction,statuses:Me.statuses}));x.current.acceptGuestMinimal(i,{playerId:ie,gameId:B.gameId,isGameStarted:B.isGameStarted,players:Z.players.map(Ae=>Ae.isDummy?{id:Ae.id,name:Ae.name,color:Ae.color,isDummy:Ae.isDummy,isReady:Ae.isReady,score:Ae.score,selectedDeck:Ae.selectedDeck,hand:We(Ae.hand||[]),deck:We(Ae.deck||[]),discard:We(Ae.discard||[]),handSize:Ae.hand.length,deckSize:Ae.deck.length,discardSize:Ae.discard.length}:{id:Ae.id,name:Ae.name,color:Ae.color,isDummy:Ae.isDummy,isReady:Ae.isReady,score:Ae.score,selectedDeck:Ae.selectedDeck,deckSize:Ae.deck.length,handSize:Ae.hand.length,discardSize:Ae.discard.length}),deckSelections:Z.players.map(Ae=>({id:Ae.id,selectedDeck:Ae.selectedDeck})),gameMode:B.gameMode,currentRound:B.currentRound,currentPhase:B.currentPhase,activePlayerId:B.activePlayerId,startingPlayerId:B.startingPlayerId,activeGridSize:B.activeGridSize,board:Le},ie),x.current.broadcastGameState(Z,i),x.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:x.current.getPeerId(),data:{playerId:ie,selectedDeck:U},timestamp:Date.now()});const et=Z.players.find(Ae=>Ae.id===T.current);if(et&&et.deck.length>0){const Ae=et.deck.map(Me=>({id:Me.id,baseId:Me.baseId,power:Me.power,powerModifier:Me.powerModifier||0,isFaceDown:Me.isFaceDown||!1,statuses:Me.statuses||[]}));x.current.sendToGuest(i,{type:"CHANGE_PLAYER_DECK",senderId:x.current.getPeerId(),playerId:et.id,data:{playerId:et.id,deckType:et.selectedDeck,deck:Ae,deckSize:Ae.length},timestamp:Date.now()}),l.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${et.selectedDeck}, ${Ae.length} cards`)}return Z})},[]),Q=$.useCallback(i=>{const oe=ne.current;if(l.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!x.current}, webrtcIsHostRef.current=${oe}`),!x.current||!oe){l.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}x.current.broadcastGameState(i)},[]),F=$.useCallback(i=>{var oe,U,B,J,ie,ce,Z,Le,We,et,Ae,Me,Gr,xr,Ur,$r,Hr,Fr,Wr,Br,Yr,zr,Kr,qr,jr,Vr,Jr,Xr,Zr,Qr,en,tn,rn,nn,an,on,sn,dn,cn,ln,un,fn,pn,yn,hn,In,En,Tn,mn,gn,wn,_n,Cn,bn,Sn,An,Dn,Rn,On,Pn,kn;if(!(!i||!i.type))switch(l.info(`[handleWebrtcMessage] Received: ${i.type}`),i.type){case"JOIN_ACCEPT_MINIMAL":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${i.playerId}`),i.data){const h=i.data;l.info(`[handleWebrtcMessage] Creating minimal state with ${((oe=h.players)==null?void 0:oe.length)||0} players`);const w={gameId:h.gameId||ta(),isGameStarted:h.isGameStarted||!1,isPrivate:!1,activeGridSize:h.activeGridSize||4,gameMode:h.gameMode||Sr.FreeForAll,dummyPlayerCount:0,players:((U=h.players)==null?void 0:U.map(C=>{if((C.isDummy||!1)&&C.hand&&C.deck&&C.discard)return{id:C.id,name:C.name,color:C.color,isDummy:!0,isReady:C.isReady||!1,score:C.score||0,hand:C.hand||[],deck:C.deck||[],discard:C.discard||[],announcedCard:null,selectedDeck:C.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const z=[],R=[],q=[];for(let le=0;le<(C.handSize||0);le++)z.push({id:`placeholder_${C.id}_hand_${le}`,name:"?",isPlaceholder:!0,ownerId:C.id,deck:C.selectedDeck||"Random",color:C.color});for(let le=0;le<(C.deckSize||0);le++)R.push({id:`placeholder_${C.id}_deck_${le}`,name:"?",isPlaceholder:!0,ownerId:C.id,deck:C.selectedDeck||"Random",color:C.color});for(let le=0;le<(C.discardSize||0);le++)q.push({id:`placeholder_${C.id}_discard_${le}`,name:"?",isPlaceholder:!0,ownerId:C.id,deck:C.selectedDeck||"Random",color:C.color});return{id:C.id,name:C.name,color:C.color,isDummy:!1,isReady:C.isReady||!1,score:C.score||0,hand:z,deck:R,discard:q,announcedCard:null,selectedDeck:C.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:h.board||zn(),hostId:1,currentPhase:h.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:h.currentRound||1,turnNumber:h.turnNumber||1,activePlayerId:h.activePlayerId??null,startingPlayerId:h.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};a(w),i.playerId!==void 0&&(d(i.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${i.playerId}`)),a(C=>{const H=C.players.map(z=>{var q;const R=(q=h.players)==null?void 0:q.find(le=>le.id===z.id);if(z.id===i.playerId){const be=z.deck.length===0||z.deck.some(fe=>fe.isPlaceholder)||z.deck.length!==30;if(R!=null&&R.selectedDeck&&be){const fe=gt(R.selectedDeck,z.id,z.name);l.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${fe.length} cards from ${R.selectedDeck}`),x.current&&fe.length>0&&setTimeout(()=>{const ke=fe.map(Oe=>({id:Oe.id,baseId:Oe.baseId,power:Oe.power,powerModifier:Oe.powerModifier||0,isFaceDown:Oe.isFaceDown||!1,statuses:Oe.statuses||[]}));x.current.sendAction("DECK_DATA_UPDATE",{playerId:i.playerId,deck:ke,deckSize:ke.length}),l.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${R.selectedDeck}, ${ke.length} cards`)},0);const Te=[...z.hand],pe=[...fe];if(h.isGameStarted&&Te.length===0&&pe.length>0){for(let Oe=0;Oe<6&&Oe<pe.length;Oe++){const Re=pe[0];pe.splice(0,1),Te.push(Re)}l.info(`[JOIN_ACCEPT_MINIMAL] Drew ${Te.length} cards, deck now has ${pe.length} cards`)}return{...z,deck:pe,hand:Te,selectedDeck:R.selectedDeck}}}return z});return{...C,players:H}});try{const C=(B=x.current)==null?void 0:B.getHostPeerId();C&&fr({hostPeerId:C,playerId:i.playerId,playerName:((J=w.players.find(H=>H.id===i.playerId))==null?void 0:J.name)||null,isHost:!1})}catch(C){l.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",C)}}break;case"JOIN_ACCEPT":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${i.playerId}, hasState: ${!!((ie=i.data)!=null&&ie.gameState)}`),(ce=i.data)!=null&&ce.gameState){const h=i.data.gameState;if(l.info(`[handleWebrtcMessage] Setting game state with ${((Z=h.players)==null?void 0:Z.length)||0} players`),a(h),i.playerId!==void 0){d(i.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${i.playerId}`);try{const w=(Le=x.current)==null?void 0:Le.getHostPeerId(),C=h.players.find(H=>H.id===i.playerId);w&&fr({hostPeerId:w,playerId:i.playerId,playerName:(C==null?void 0:C.name)||null,isHost:!1})}catch(w){l.warn("[JOIN_ACCEPT] Failed to save guest data:",w)}}}break;case"JOIN_ACCEPT_BINARY":if(l.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${i.playerId}`),i.data instanceof Uint8Array)try{const h=No(i.data),w=h;if(l.info(`[handleWebrtcMessage] Expanded binary state with ${((We=w.players)==null?void 0:We.length)||0} players`),a(w),i.playerId!==void 0){d(i.playerId),l.info(`[handleWebrtcMessage] Set local player ID to ${i.playerId}`);try{const C=(et=x.current)==null?void 0:et.getHostPeerId(),H=w.players.find(z=>z.id===i.playerId);C&&fr({hostPeerId:C,playerId:i.playerId,playerName:(H==null?void 0:H.name)||null,isHost:!1})}catch(C){l.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",C)}}l.info(`[handleWebrtcMessage] Received optimized binary game state: ${i.data.byteLength} bytes`)}catch(h){l.error("[handleWebrtcMessage] Failed to deserialize binary game state:",h)}break;case"STATE_UPDATE_COMPACT":if(ne.current){if(i.senderId&&i.senderId!==((Ae=x.current)==null?void 0:Ae.getPeerId())&&(l.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${i.senderId}`),(Me=i.data)!=null&&Me.gameState)){const h=i.data.gameState;a(w=>{const C=i.playerId;if(C===void 0)return l.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),w;const H=w.players.map(R=>{if(R.id===C){const q=h.players.find(le=>le.id===C);if(q){const le=pe=>{const ke=Tt(pe.baseId);return ke?{...ke,id:pe.id,baseId:pe.baseId,ownerId:C,power:pe.power,powerModifier:pe.powerModifier,isFaceDown:pe.isFaceDown,statuses:pe.statuses||[]}:{id:pe.id,baseId:pe.baseId,name:"Unknown",power:0}},be=(q.handCards||[]).map(le),fe=(q.deckCards||[]).map(le),Te=(q.discardCards||[]).map(le);return l.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${C}: hand=${be.length}, deck=${fe.length}, discard=${Te.length}`),{...R,hand:be,deck:fe,discard:Te,handSize:be.length,deckSize:fe.length,discardSize:Te.length}}}return R}),z={...w,players:H};return x.current&&setTimeout(()=>{x.current.broadcastGameState(z,i.senderId)},0),z})}}else if(!ne.current&&((Gr=i.data)!=null&&Gr.gameState)){const h=i.data.recipientPlayerId??null,w=i.data.gameState;if(ut.current){a(C=>({...C,currentPhase:w.currentPhase,activePlayerId:w.activePlayerId,startingPlayerId:w.startingPlayerId,isReadyCheckActive:w.isReadyCheckActive,isGameStarted:w.isGameStarted}));return}a(C=>{const H=h===null||h===T.current;l.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${h}, local=${T.current}, isForLocal=${H}`);const z=w.players.map(R=>{var le,be;const q=C.players.find(fe=>fe.id===R.id);if(R.id===T.current&&q){const fe=pe=>{if(pe.baseId){const Oe=Tt(pe.baseId);if(Oe)return{...Oe,id:pe.id,ownerId:T.current,power:pe.power,powerModifier:pe.powerModifier,isFaceDown:pe.isFaceDown,statuses:pe.statuses||[]}}return q.hand.find(Oe=>Oe.id===pe.id)||q.deck.find(Oe=>Oe.id===pe.id)||q.discard.find(Oe=>Oe.id===pe.id)||{id:pe.id,name:"Unknown",power:0}};if(R.handCards&&R.handCards.length>0||R.deckCards&&R.deckCards.length>0||R.discardCards&&R.discardCards.length>0){const pe=(R.handCards||[]).map(fe),ke=(R.deckCards||[]).map(fe),Oe=(R.discardCards||[]).map(fe);return pe.forEach((Re,De)=>{var Ee,Xe;(Xe=(Ee=R.handCards)==null?void 0:Ee[De])!=null&&Xe.baseId&&!Re.baseId&&(Re.baseId=R.handCards[De].baseId)}),ke.forEach((Re,De)=>{var Ee,Xe;(Xe=(Ee=R.deckCards)==null?void 0:Ee[De])!=null&&Xe.baseId&&!Re.baseId&&(Re.baseId=R.deckCards[De].baseId)}),Oe.forEach((Re,De)=>{var Ee,Xe;(Xe=(Ee=R.discardCards)==null?void 0:Ee[De])!=null&&Xe.baseId&&!Re.baseId&&(Re.baseId=R.discardCards[De].baseId)}),l.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${pe.length} hand, ${ke.length} deck, ${Oe.length} discard`),{...R,hand:pe,deck:ke,discard:Oe}}else{const pe=(R.handIds||[]).map(Re=>q.hand.find(Ee=>Ee.id===Re)||q.deck.find(Ee=>Ee.id===Re)||q.discard.find(Ee=>Ee.id===Re)||{id:Re,name:"?",isPlaceholder:!1}),ke=(R.deckIds||[]).map(Re=>q.deck.find(Ee=>Ee.id===Re)||q.hand.find(Ee=>Ee.id===Re)||q.discard.find(Ee=>Ee.id===Re)||{id:Re,name:"?",isPlaceholder:!1}),Oe=(R.discardIds||[]).map(Re=>q.discard.find(Ee=>Ee.id===Re)||q.hand.find(Ee=>Ee.id===Re)||q.deck.find(Ee=>Ee.id===Re)||{id:Re,name:"?",isPlaceholder:!1});return l.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${pe.length} hand, ${ke.length} deck, ${Oe.length} discard`),{...R,hand:pe,deck:ke,discard:Oe}}}else{const fe=R.deckSize??((le=R.deck)==null?void 0:le.length)??0,Te=R.handSize??((be=R.hand)==null?void 0:be.length)??0,pe=R.deckCards&&R.deckCards.length>0;let ke;if(pe){const De=Ee=>{if(Ee.baseId){const Xe=Tt(Ee.baseId);if(Xe)return{...Xe,id:Ee.id,baseId:Ee.baseId,ownerId:R.id,power:Ee.power,powerModifier:Ee.powerModifier,isFaceDown:Ee.isFaceDown,statuses:Ee.statuses||[]}}return{id:Ee.id,name:"Unknown",power:0}};ke=R.deckCards.map(De),l.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${R.id}: ${ke.length} cards`)}else if(q&&q.deck.length>0&&q.deck.some(Ee=>!Ee.isPlaceholder))ke=q.deck.slice(0,fe),l.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${R.id}: ${ke.length} cards`);else{ke=[];for(let Ee=0;Ee<fe;Ee++)ke.push({id:`placeholder_${R.id}_deck_${Ee}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color})}const Oe=(De,Ee)=>{if(De.baseId&&!De.isPlaceholder&&!De.isCardBack){const Xe=Tt(De.baseId);if(Xe)return{...Xe,id:De.id,baseId:De.baseId,ownerId:R.id,power:De.power,powerModifier:De.powerModifier||0,isFaceDown:De.isFaceDown||!1,statuses:De.statuses||[]}}return{id:De.id||`placeholder_${R.id}_hand_${Ee}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color}};let Re;if(R.hand&&R.hand.length>0){Re=R.hand.map((Ee,Xe)=>Oe(Ee,Xe));const De=Re.filter(Ee=>!Ee.isPlaceholder).length;De>0&&l.info(`[STATE_UPDATE_COMPACT] Reconstructed ${De}/${Re.length} revealed hand cards for player ${R.id}`)}else{Re=[];for(let De=0;De<Te;De++)Re.push({id:`placeholder_${R.id}_hand_${De}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color})}return{...R,hand:Re,deck:ke,discard:(q==null?void 0:q.discard)||[]}}});return{...w,players:z}})}break;case"STATE_UPDATE":if(ne.current&&i.senderId&&i.senderId!==((xr=x.current)==null?void 0:xr.getPeerId())){if(l.info(`[STATE_UPDATE] Host received state from guest ${i.senderId}`),(Ur=i.data)!=null&&Ur.gameState){const h=i.data.gameState;a(w=>{const C=i.playerId;if(C===void 0)return l.warn("[STATE_UPDATE] Guest state missing playerId"),w;const H=w.players.map(q=>{if(q.id===C){const le=h.players.find(be=>be.id===C);if(le){const be=le.hand||[],fe=le.deck||[],Te=le.discard||[];l.info(`[STATE_UPDATE] Merging guest ${C} state: hand=${be.length}, deck=${fe.length}, discard=${Te.length}`);const pe={...q,hand:be,deck:fe,discard:Te,handSize:be.length,deckSize:fe.length,discardSize:Te.length};return l.info(`[STATE_UPDATE] After merge - player ${C}: deckSize=${pe.deckSize}, handSize=${pe.handSize}`),pe}}return q}),z=h.board?h.board:w.board,R={...w,players:H,board:z};return x.current&&setTimeout(()=>{x.current.broadcastGameState(R,i.senderId)},0),R})}break}if(we.current=!0,($r=i.data)!=null&&$r.gameState){const h=i.data.gameState;if(ut.current){a(w=>({...w,currentPhase:h.currentPhase,activePlayerId:h.activePlayerId,startingPlayerId:h.startingPlayerId,isReadyCheckActive:h.isReadyCheckActive,isGameStarted:h.isGameStarted}));return}a(w=>{var z;const C=h.players.map(R=>{var le,be,fe;const q=w.players.find(Te=>Te.id===R.id);if(R.id===T.current&&q){const Te=q.hand.every(ke=>ke.isPlaceholder)||q.hand.length===0,pe=R.handSize??((le=R.hand)==null?void 0:le.length)??0;if(Te&&R.hand&&R.hand.length>0)return{...R,hand:R.hand,deck:R.deck||q.deck,discard:R.discard||q.discard};{let ke=q.hand,Oe=q.deck;if(pe>q.hand.length&&Oe.length>0){const Re=pe-q.hand.length,De=[...q.hand],Ee=[...q.deck];for(let Xe=0;Xe<Re&&Xe<Ee.length;Xe++){const Qa=Ee[0];Ee.splice(0,1),De.push(Qa)}ke=De,Oe=Ee}return{...R,hand:ke,deck:Oe,discard:R.discard||q.discard}}}else{if(R.isDummy||!1)return l.info(`[STATE_UPDATE] Using real cards for dummy player ${R.id}`),{...R,hand:R.hand||[],deck:R.deck||[],discard:R.discard||[]};const pe=R.deckSize??((be=R.deck)==null?void 0:be.length)??0,ke=R.handSize??((fe=R.hand)==null?void 0:fe.length)??0;l.info(`[STATE_UPDATE] Player ${R.id}: deckSize=${pe}, handSize=${ke}`);const Oe=[];for(let De=0;De<pe;De++)Oe.push({id:`placeholder_${R.id}_deck_${De}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});const Re=[];for(let De=0;De<ke;De++)Re.push({id:`placeholder_${R.id}_hand_${De}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});return l.info(`[STATE_UPDATE] Created ${Oe.length} deck placeholders and ${Re.length} hand placeholders for player ${R.id}`),{...R,hand:Re,deck:Oe,discard:R.discard||[]}}}),H={...h,players:C};if(!ne.current)try{((z=x.current)==null?void 0:z.getHostPeerId())&&T.current!==null&&(xt({gameState:H,localPlayerId:T.current,isHost:!1}),l.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(R){l.warn("[STATE_UPDATE] Failed to persist guest state:",R)}return H})}break;case"RECONNECT_SNAPSHOT":if(we.current=!0,i.data){const h=i.data;a(w=>{const C=T.current,H=h.players.map(R=>{const q=w.players.find(Te=>Te.id===R.id);if(R.id===C&&q&&q.hand.some(pe=>!pe.isPlaceholder)){let pe=[...q.hand];const ke=[...q.deck];if(R.handSize>pe.length){const Oe=R.handSize-pe.length;for(let Re=0;Re<Oe&&ke.length>0;Re++)pe.push(ke.shift())}else R.handSize<pe.length&&(pe=pe.slice(0,R.handSize));return{...R,hand:pe,deck:ke,discard:q.discard}}const le=[];for(let Te=0;Te<R.handSize;Te++)le.push({id:`placeholder_${R.id}_hand_${Te}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});const be=[];for(let Te=0;Te<R.deckSize;Te++)be.push({id:`placeholder_${R.id}_deck_${Te}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});const fe=[];for(let Te=0;Te<R.discardSize;Te++)fe.push({id:`placeholder_${R.id}_discard_${Te}`,name:"?",isPlaceholder:!0,ownerId:R.id,deck:R.selectedDeck||"Random",color:R.color});return{...R,hand:le,deck:be,discard:fe}}),z={gameId:h.gameId,gameMode:h.gameMode,isPrivate:h.isPrivate,isGameStarted:h.isGameStarted,isReadyCheckActive:h.isReadyCheckActive,activeGridSize:h.activeGridSize,currentPhase:h.currentPhase,isScoringStep:h.isScoringStep,activePlayerId:h.activePlayerId,startingPlayerId:h.startingPlayerId,currentRound:h.currentRound,turnNumber:h.turnNumber,roundWinners:h.roundWinners||{},gameWinner:h.gameWinner,isRoundEndModalOpen:h.isRoundEndModalOpen,dummyPlayerCount:h.dummyPlayerCount,players:H,board:h.board,spectators:w.spectators,hostId:w.hostId,revealRequests:w.revealRequests,preserveDeployAbilities:w.preserveDeployAbilities,highlights:w.highlights,floatingTexts:w.floatingTexts,targetingMode:w.targetingMode,abilityMode:w.abilityMode};if(!ne.current&&C!==null)try{xt({gameState:z,localPlayerId:C,isHost:!1}),l.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(R){l.warn("[RECONNECT_SNAPSHOT] Failed to save state:",R)}return l.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${z.currentPhase}, players=${z.players.length}`),z})}break;case"STATE_DELTA":if(ne.current||(we.current=!0),l.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${ne.current}, senderId: ${i.senderId}`),(Hr=i.data)!=null&&Hr.delta){const h=i.data.delta;l.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(h.playerDeltas||{}).length}, boardCells=${((Fr=h.boardCells)==null?void 0:Fr.length)||0}, phaseDelta=${!!h.phaseDelta}`),h.boardCells&&h.boardCells.length>0&&h.boardCells.forEach(w=>{var C,H;l.info(`[STATE_DELTA] Board cell [${w.row},${w.col}]: card=${((C=w.card)==null?void 0:C.name)||"(empty)"}, owner=${(H=w.card)==null?void 0:H.ownerId}`)}),ne.current&&i.senderId&&x.current&&(l.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${i.senderId} to other guests`),x.current.broadcastStateDelta(h,i.senderId)),h.phaseDelta&&l.info("[STATE_DELTA] phaseDelta:",JSON.stringify(h.phaseDelta)),h.playerDeltas&&Object.entries(h.playerDeltas).forEach(([w,C])=>{l.info(`[STATE_DELTA] Player ${w} delta: handSizeDelta=${C.handSizeDelta}, deckSizeDelta=${C.deckSizeDelta}`)}),a(w=>{const C=T.current||w.localPlayerId;l.info(`[STATE_DELTA] Applying delta with localPlayerId=${C}, currentPhase before=${w.currentPhase}`);const H=mr(w);l.info(`[STATE_DELTA] Applying delta with localPlayerId=${C}, currentPhase after=${H.currentPhase}`);try{H.gameId&&C!==null&&(xt({gameState:H,localPlayerId:C,isHost:ne.current}),l.debug(`[STATE_DELTA] Saved state for ${ne.current?"host":"guest"} auto-restore`))}catch(z){l.warn("[STATE_DELTA] Failed to persist state:",z)}return H})}break;case"STATE_DELTA_BINARY":{ne.current||(we.current=!0),l.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${ne.current}, senderId: ${i.senderId}, dataType=${(Br=(Wr=i.data)==null?void 0:Wr.constructor)==null?void 0:Br.name}, typeof=${typeof i.data}`);let h=null;if(i.data instanceof Uint8Array)try{h=Xn(i.data),h&&l.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(h.playerDeltas||{}).length}, boardCells=${((Yr=h.boardCells)==null?void 0:Yr.length)||0}`)}catch(w){l.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",w)}else if(typeof i.data=="string")try{h=Mo(i.data),h&&l.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${i.data.length} chars): playerDeltas=${Object.keys(h.playerDeltas||{}).length}, boardCells=${((zr=h.boardCells)==null?void 0:zr.length)||0}, phaseDelta=${!!h.phaseDelta}`)}catch(w){l.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",w)}else l.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof i.data}, constructor: ${(qr=(Kr=i.data)==null?void 0:Kr.constructor)==null?void 0:qr.name}`);h&&(ne.current&&i.senderId&&x.current&&(l.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${i.senderId} to other guests`),x.current.broadcastStateDelta(h,i.senderId)),a(w=>{const C=T.current||w.localPlayerId;l.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${C}, currentPhase before=${w.currentPhase}`);const H=mr(w);l.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${H.currentPhase}, board has ${H.board.flat().filter(z=>z==null?void 0:z.card).length} cards`);try{H.gameId&&C!==null&&(xt({gameState:H,localPlayerId:C,isHost:ne.current}),l.debug(`[STATE_DELTA_BINARY] Saved state for ${ne.current?"host":"guest"} auto-restore`))}catch(z){l.warn("[STATE_DELTA_BINARY] Failed to persist state:",z)}return H}));break}case"CARD_STATE":if(typeof i.data=="string")try{const h=atob(i.data),w=new Uint8Array(h.length);for(let C=0;C<h.length;C++)w[C]=h.charCodeAt(C);a(C=>kt(2,w,C,T.current||C.localPlayerId).gameState)}catch(h){l.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",h)}else i.data instanceof Uint8Array&&a(h=>kt(2,i.data,h,T.current||h.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof i.data=="string")try{const h=atob(i.data),w=new Uint8Array(h.length);for(let C=0;C<h.length;C++)w[C]=h.charCodeAt(C);a(C=>{const{gameState:H}=kt(3,w,C,T.current||C.localPlayerId);return H})}catch(h){l.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",h)}else i.data instanceof Uint8Array&&a(h=>{const{gameState:w}=kt(3,i.data,h,T.current||h.localPlayerId);return w});break;case"SESSION_EVENT":if(typeof i.data=="string")try{const h=atob(i.data),w=new Uint8Array(h.length);for(let C=0;C<h.length;C++)w[C]=h.charCodeAt(C);a(C=>kt(4,w,C,T.current||C.localPlayerId).gameState)}catch(h){l.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",h)}else i.data instanceof Uint8Array&&a(h=>kt(4,i.data,h,T.current||h.localPlayerId).gameState);break;case"JOIN_REQUEST":l.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${i.senderId}, isHost: ${ne.current}`),ne.current&&i.senderId?(l.info(`Host received JOIN_REQUEST from ${i.senderId}, data:`,i.data),qe(i.senderId,i.data)):l.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${ne.current}, senderId: ${i.senderId}`);break;case"ACTION":if(ne.current&&i.data){const{actionType:h,actionData:w}=i.data;if(h==="STATE_UPDATE"&&(w!=null&&w.gameState)){if(ut.current){x.current&&i.senderId&&x.current.sendToGuest(i.senderId,{type:"STATE_UPDATE",senderId:x.current.getPeerId(),data:{gameState:g.current},timestamp:Date.now()});break}a(C=>{const H=w.gameState,z=H.players.map(q=>{const le=C.players.find(be=>be.id===q.id);return le&&q.id!==T.current?{...q,deck:le.deck||q.deck,discard:le.discard||q.discard,score:le.score}:q}),R={...H,players:z};return x.current&&x.current.broadcastToGuests({type:"STATE_UPDATE",senderId:x.current.getPeerId(),data:{gameState:R},timestamp:Date.now()}),R})}else if(h==="STATE_DELTA"&&(w!=null&&w.delta))a(C=>{const H=w.delta;let z=H;ut.current&&H.playerDeltas&&(z={...H,playerDeltas:Object.fromEntries(Object.entries(H.playerDeltas).map(([q,le])=>{const be={...le};return delete be.scoreDelta,[q,be]}))}),T.current||C.localPlayerId;const R=mr(C);return x.current&&x.current.broadcastStateDelta(z),R});else if(h==="NEXT_PHASE")a(C=>{const H=C,z=H.currentPhase,R=z===2&&!H.isScoringStep,q=z+1;return{...H,currentPhase:q,...R&&{isScoringStep:!0}}});else if(h==="PREV_PHASE")a(C=>{const H=C;return H.isScoringStep?{...H,isScoringStep:!1,currentPhase:Math.max(1,H.currentPhase-1)}:{...H,currentPhase:Math.max(1,H.currentPhase-1)}});else if(h==="SET_PHASE"&&(w==null?void 0:w.phaseIndex)!==void 0)a(C=>({...C,currentPhase:w.phaseIndex}));else if(h==="UPDATE_PLAYER_NAME"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.name)!==void 0)a(C=>({...C,players:C.players.map(H=>H.id===w.playerId?{...H,name:w.name}:H)}));else if(h==="CHANGE_PLAYER_COLOR"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.color)!==void 0)a(C=>({...C,players:C.players.map(H=>H.id===w.playerId?{...H,color:w.color}:H)}));else if(h==="UPDATE_PLAYER_SCORE"&&(w==null?void 0:w.playerId)!==void 0&&(w==null?void 0:w.delta)!==void 0)a(C=>({...C,players:C.players.map(H=>H.id===w.playerId?{...H,score:Math.max(0,H.score+w.delta)}:H)}));else if(h==="CHANGE_PLAYER_DECK"&&(w==null?void 0:w.playerId)!==void 0){const C=w.playerId,H=w.deckType,z=w.deck;a(R=>{const q=R.players.find(fe=>fe.id===C);if(!q)return R;let le;z&&z.length>0?(l.info(`[CHANGE_PLAYER_DECK] Host received ${z.length} cards for player ${C}`),le=z.map(fe=>{if(fe.baseId){const Te=Tt(fe.baseId);if(Te)return{...Te,id:fe.id,baseId:fe.baseId,deck:H,ownerId:C,ownerName:q.name,power:fe.power,powerModifier:fe.powerModifier||0,isFaceDown:fe.isFaceDown||!1,statuses:fe.statuses||[]}}return{id:fe.id,baseId:fe.id,name:"Unknown",deck:H,ownerId:C,ownerName:q.name,power:fe.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(le=gt(H,C,q.name),l.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${C} with ${le.length} cards from ${H}`));const be={...R,players:R.players.map(fe=>fe.id===C?{...fe,selectedDeck:H,deck:le,hand:[],discard:[],announcedCard:null,boardHistory:[]}:fe)};if(x.current){const fe=le.map(Te=>({id:Te.id,baseId:Te.baseId,power:Te.power,powerModifier:Te.powerModifier||0,isFaceDown:Te.isFaceDown||!1,statuses:Te.statuses||[]}));x.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:x.current.getPeerId(),playerId:C,data:{playerId:C,deckType:H,deck:fe,deckSize:fe.length},timestamp:Date.now()})}return be})}else if(h==="TOGGLE_ACTIVE_PLAYER"&&(w==null?void 0:w.playerId)!==void 0)a(C=>{if(!C.players.find(R=>R.id===w.playerId))return C;const z=Qn(C,w.playerId);return x.current&&x.current.broadcastGameState(z),z});else if(h==="TOGGLE_AUTO_DRAW"&&(w==null?void 0:w.playerId)!==void 0)a(C=>({...C,players:C.players.map(H=>H.id===w.playerId?{...H,autoDrawEnabled:!H.autoDrawEnabled}:H)}));else if(h==="START_NEXT_ROUND")a(C=>({...C,isRoundEndModalOpen:!1,currentRound:(C.currentRound||1)+1,players:C.players.map(H=>({...H,score:0}))}));else if(h==="RESET_DEPLOY_STATUS")a(C=>{const H=C.board.map(z=>z.map(R=>{var q;return(q=R.card)!=null&&q.statuses?{...R,card:{...R.card,statuses:R.card.statuses.filter(le=>le.type!=="DeployAbilityUsed")}}:R}));return{...C,board:H,preserveDeployAbilities:!1}});else if(h==="DECK_DATA_UPDATE"&&(w==null?void 0:w.playerId)!==void 0&&(w!=null&&w.deck)){const C=w.playerId,H=w.deck,z=w.deckSize;l.info(`[ACTION] DECK_DATA_UPDATE: Received ${H.length} cards for guest ${C}`),a(R=>({...R,players:R.players.map(q=>q.id===C?{...q,deck:[...H],deckSize:z||H.length}:q)}))}else l.warn(`[ACTION] Unknown action type: ${h}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(l.info(`[PLAYER_RECONNECT] Guest ${i.playerId} reconnecting from ${i.senderId}`),ne.current&&i.playerId!==void 0&&i.senderId){const h=g.current;if(l.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(h!=null&&h.gameId)}, gameId=${h==null?void 0:h.gameId}, hasPlayers=${((jr=h==null?void 0:h.players)==null?void 0:jr.length)||0}`),h&&h.gameId){l.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${i.playerId}`);const w=zo(h,i.playerId);(Vr=x.current)==null||Vr.sendToGuest(i.senderId,{type:"RECONNECT_SNAPSHOT",senderId:x.current.getPeerId(),data:w.data,timestamp:Date.now()}),l.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${i.playerId}`)}else l.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((Jr=i.data)==null?void 0:Jr.isReadyCheckActive)!==void 0||((Xr=i.data)==null?void 0:Xr.isPrivate)!==void 0)&&a(h=>({...h,isReadyCheckActive:i.data.isReadyCheckActive??!0,isPrivate:i.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((Zr=i.data)==null?void 0:Zr.isReadyCheckActive)!==void 0&&a(h=>({...h,isReadyCheckActive:i.data.isReadyCheckActive}));break;case"PLAYER_READY":ne.current&&i.playerId!==void 0?a(h=>{const w=h.players.map(R=>R.id===i.playerId?{...R,isReady:!0}:R),C={...h,players:w};l.info(`Player ${i.playerId} is ready via WebRTC`),x.current&&(x.current.broadcastGameState(C),l.info(`[PLAYER_READY] Broadcasted ready status for player ${i.playerId}`));const H=C.players.filter(R=>!R.isDummy&&!R.isDisconnected);if(H.length>0&&H.every(R=>R.isReady)&&C.isReadyCheckActive&&!C.isGameStarted){const R=C.players.filter(fe=>!fe.isDisconnected),q=Math.floor(Math.random()*R.length),le=R[q].id;let be={...C};return be.isReadyCheckActive=!1,be.isGameStarted=!0,be.startingPlayerId=le,be.activePlayerId=le,be.currentPhase=0,be.players=be.players.map(fe=>{if(fe.hand.length===0&&fe.deck.length>0){const pe=[...fe.hand],ke=[...fe.deck];for(let Oe=0;Oe<6&&Oe<ke.length;Oe++){const Re=ke[0];ke.splice(0,1),pe.push(Re)}return l.info(`[PLAYER_READY] Drew ${pe.length} cards for player ${fe.id}`),{...fe,hand:pe,deck:ke}}return fe}),be=kr(be,le),l.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${be.currentPhase}`),x.current&&(x.current.broadcastToGuests({type:"GAME_START",senderId:x.current.getPeerId(),data:{startingPlayerId:le,activePlayerId:le,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var fe,Te;l.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(fe=be.players[0])==null?void 0:fe.deck.length}, hand=${(Te=be.players[0])==null?void 0:Te.hand.length}`),l.info(`[PLAYER_READY] Broadcasting state with currentPhase=${be.currentPhase}`),Q(be)},100)),be}return C}):ne.current;break;case"ASSIGN_TEAMS":(Qr=i.data)!=null&&Qr.assignments&&a(h=>{const w=h.players.map(C=>{let H=C.teamId||1;for(const[z,R]of Object.entries(i.data.assignments))if(R.includes(C.id)){H=parseInt(z);break}return{...C,teamId:H}});return{...h,players:w}});break;case"SET_GAME_MODE":((en=i.data)==null?void 0:en.mode)!==void 0&&a(h=>({...h,gameMode:i.data.mode}));break;case"SET_GAME_PRIVACY":((tn=i.data)==null?void 0:tn.isPrivate)!==void 0&&a(h=>({...h,isPrivate:i.data.isPrivate}));break;case"SET_GRID_SIZE":((rn=i.data)==null?void 0:rn.size)!==void 0&&a(h=>{const w=i.data.size,C=[];for(let H=0;H<w;H++){const z=[];for(let R=0;R<w;R++)z.push({card:null});C.push(z)}return{...h,activeGridSize:w,board:C}});break;case"SET_DUMMY_PLAYER_COUNT":((nn=i.data)==null?void 0:nn.count)!==void 0&&a(h=>({...h,dummyPlayerCount:i.data.count}));break;case"HOST_READY":i.playerId!==void 0&&(l.info(`[handleWebrtcMessage] Host (player ${i.playerId}) is ready`),a(h=>{const w=h.players.map(C=>C.id===i.playerId?{...C,isReady:!0}:C);return{...h,players:w}}));break;case"GAME_START":we.current=!0,l.info("[handleWebrtcMessage] Game starting!",i.data),g.current&&(l.info(`[GAME_START] Current phase before: ${g.current.currentPhase}`),g.current.players.forEach(h=>{l.info(`[GAME_START] Before: Player ${h.id} - deck: ${h.deck.length}, hand: ${h.hand.length}`)})),i.data&&a(h=>{l.info(`[GAME_START] Processing for localPlayerId=${T.current}`),h.players.forEach(z=>{l.info(`[GAME_START] Player ${z.id} before: deck=${z.deck.length}, hand=${z.hand.length}`)});const w=i.data.startingPlayerId??i.data.activePlayerId,C={...h,isGameStarted:i.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:w,activePlayerId:i.data.activePlayerId,currentPhase:h.currentPhase},H=C.players.find(z=>z.id===T.current);if(H&&H.hand.length===0&&H.deck.length>0){const R=[...H.hand],q=[...H.deck];for(let le=0;le<6&&le<q.length;le++){const be=q[0];q.splice(0,1),R.push(be)}C.players=C.players.map(le=>le.id===T.current?{...le,hand:R,deck:q}:le),l.info(`[GAME_START] Drew ${R.length} cards for local player ${T.current}, deck now has ${q.length} cards`)}return C.players.forEach(z=>{l.info(`[GAME_START] Player ${z.id} after: deck=${z.deck.length}, hand=${z.hand.length}`)}),l.info(`[GAME_START] Final state: currentPhase=${C.currentPhase}, activePlayerId=${C.activePlayerId}, startingPlayerId=${C.startingPlayerId}`),C});break;case"ACTIVE_PLAYER_CHANGED":l.info("[handleWebrtcMessage] Active player changed!",i.data),i.data&&a(h=>{const w={...h,activePlayerId:i.data.activePlayerId};if(i.data.currentPhase!==void 0&&(w.currentPhase=i.data.currentPhase),i.data.turnNumber!==void 0&&(w.turnNumber=i.data.turnNumber),w.currentPhase===0&&w.activePlayerId===T.current){const C=w.players.find(H=>H.id===T.current);if(C&&C.deck.length>0){const H=C.deck[0],z=[...C.deck.slice(1)],R=[...C.hand,H];w.players=w.players.map(q=>q.id===T.current?{...q,deck:z,hand:R}:q)}w.currentPhase=1}return w});break;case"SYNC_DECK_SELECTIONS":l.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",i.data),i.data&&a(h=>i.data.playerId!==void 0&&i.data.selectedDeck!==void 0?i.data.playerId===T.current?(l.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${i.data.playerId}`),h):{...h,players:h.players.map(w=>w.id===i.data.playerId?{...w,selectedDeck:i.data.selectedDeck}:w)}:i.data.deckSelections&&Array.isArray(i.data.deckSelections)?{...h,players:h.players.map(w=>{if(w.id===T.current)return w;const C=i.data.deckSelections.find(H=>H.id===w.id);return C?{...w,selectedDeck:C.selectedDeck}:w})}:h);break;case"CHANGE_PLAYER_DECK":if(l.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",i.data),!i.data||i.data.playerId===void 0)break;const Ct=i.data.playerId,Gt=i.data.deckType,dr=i.data.deck;if(Ct===T.current)break;a(h=>{const w=h.players.find(H=>H.id===Ct);if(!w)return h;let C;return dr&&dr.length>0?C=dr.map(H=>{if(H.baseId){const z=Tt(H.baseId);return z?{...z,id:H.id,baseId:H.baseId,deck:Gt,ownerId:Ct,ownerName:w.name,power:H.power,powerModifier:H.powerModifier||0,isFaceDown:H.isFaceDown||!1,statuses:H.statuses||[]}:{id:H.id,baseId:H.baseId,name:"Unknown",deck:Gt,ownerId:Ct,ownerName:w.name,power:H.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}return{id:H.id,baseId:H.id,name:"Unknown",deck:Gt,ownerId:Ct,ownerName:w.name,power:H.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}):C=gt(Gt,Ct,w.name),{...h,players:h.players.map(H=>H.id===Ct?{...H,selectedDeck:Gt,deck:C,hand:[],discard:[],announcedCard:null,boardHistory:[]}:H)}});break;case"GAME_RESET":a(h=>{const w=i.data.activeGridSize||8,C=[];for(let R=0;R<w;R++){const q=[];for(let le=0;le<w;le++)q.push({card:null});C.push(q)}const H=(i.data.players||[]).map(R=>{if(R.isDummy&&R.hand&&R.deck&&R.discard)return{...R,boardHistory:[]};{const q=R.selectedDeck||"SynchroTech";return{...R,hand:[],deck:gt(q,R.id,R.name),discard:[],boardHistory:[]}}}),z={...h,players:H,gameMode:i.data.gameMode,isPrivate:i.data.isPrivate,activeGridSize:i.data.activeGridSize,dummyPlayerCount:i.data.dummyPlayerCount,autoAbilitiesEnabled:i.data.autoAbilitiesEnabled,isGameStarted:i.data.isGameStarted,currentPhase:i.data.currentPhase,currentRound:i.data.currentRound,turnNumber:i.data.turnNumber,activePlayerId:i.data.activePlayerId,startingPlayerId:i.data.startingPlayerId,roundWinners:i.data.roundWinners||{},gameWinner:i.data.gameWinner,isRoundEndModalOpen:i.data.isRoundEndModalOpen,isReadyCheckActive:i.data.isReadyCheckActive,board:C,targetingMode:null,floatingTexts:[]};return g.current=z,z});break;case"ABILITY_MODE_SET":(an=i.data)!=null&&an.abilityMode&&(a(h=>({...h,abilityMode:i.data.abilityMode})),l.info("[AbilityMode] Received ability mode from host",{playerId:i.data.abilityMode.playerId,mode:i.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":l.info("[Ability] Target selected",i.data);break;case"ABILITY_COMPLETED":a(h=>({...h,abilityMode:null})),l.info("[Ability] Ability completed",i.data);break;case"ABILITY_CANCELLED":a(h=>({...h,abilityMode:null}));break;case"TRIGGER_HIGHLIGHT":if((on=i.data)!=null&&on.highlightData){const h=i.data.highlightData;P(h),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:i.senderId,data:h,timestamp:Date.now()},i.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(i.data){const h=(sn=x.current)==null?void 0:sn.getPeerId();i.senderId!==h&&P(i.data)}break;case"TRIGGER_FLOATING_TEXT":if((dn=i.data)!=null&&dn.textData){const h=i.data.textData;a(w=>({...w,floatingTexts:[...w.floatingTexts,h].filter(C=>Date.now()-C.timestamp<Se.FLOATING_TEXT_DURATION)})),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:i.senderId,data:h,timestamp:Date.now()},i.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((cn=i.data)!=null&&cn.batch){const h=i.data.batch;a(w=>({...w,floatingTexts:[...w.floatingTexts,...h].filter(C=>Date.now()-C.timestamp<Se.FLOATING_TEXT_DURATION)})),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:i.senderId,data:{batch:h},timestamp:Date.now()},i.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const h=(ln=x.current)==null?void 0:ln.getPeerId();(un=i.data)!=null&&un.batch&&i.senderId!==h?a(w=>({...w,floatingTexts:[...w.floatingTexts,...i.data.batch].filter(C=>Date.now()-C.timestamp<Se.FLOATING_TEXT_DURATION)})):(fn=i.data)!=null&&fn.textData&&i.senderId!==h&&a(w=>({...w,floatingTexts:[...w.floatingTexts,i.data.textData].filter(C=>Date.now()-C.timestamp<Se.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((pn=i.data)!=null&&pn.coords){const h=i.data.coords,w=i.data.timestamp;E({coords:h,timestamp:w}),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:i.senderId,data:{coords:h,timestamp:w},timestamp:Date.now()},i.senderId)}break;case"NO_TARGET_TRIGGERED":if((yn=i.data)!=null&&yn.coords){const h=(hn=x.current)==null?void 0:hn.getPeerId();i.senderId!==h&&E({coords:i.data.coords,timestamp:i.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(i.data){const h=i.data;m(w=>[...w,h]),setTimeout(()=>{m(w=>w.filter(C=>C.timestamp!==h.timestamp))},1e3),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:i.senderId,data:h,timestamp:Date.now()},i.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(i.data){const h=i.data;S(w=>[...w,h]),setTimeout(()=>{S(w=>w.filter(C=>C.timestamp!==h.timestamp))},1e3),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:i.senderId,data:h,timestamp:Date.now()},i.senderId)}break;case"TRIGGER_TARGET_SELECTION":if(i.data){const h=i.data;Y(w=>[...w,h]),setTimeout(()=>{Y(w=>w.filter(C=>C.timestamp!==h.timestamp))},1e3),ne.current&&x.current&&i.senderId&&x.current.broadcastToGuests({type:"TARGET_SELECTION_TRIGGERED",senderId:i.senderId,data:h,timestamp:Date.now()},i.senderId)}break;case"TARGET_SELECTION_TRIGGERED":i.data&&i.senderId!==((In=x.current)==null?void 0:In.getPeerId())&&(Y(h=>[...h,i.data]),setTimeout(()=>{Y(h=>h.filter(w=>w.timestamp!==i.data.timestamp))},1e3));break;case"DECK_SELECTION_TRIGGERED":i.data&&i.senderId!==((En=x.current)==null?void 0:En.getPeerId())&&(m(h=>[...h,i.data]),setTimeout(()=>{m(h=>h.filter(w=>w.timestamp!==i.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":i.data&&i.senderId!==((Tn=x.current)==null?void 0:Tn.getPeerId())&&(S(h=>[...h,i.data]),setTimeout(()=>{S(h=>h.filter(w=>w.timestamp!==i.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((mn=i.data)!=null&&mn.targetingMode){const h=i.data.targetingMode;a(w=>({...w,targetingMode:h})),g.current.targetingMode=h,l.info("[TargetingMode] Received targeting mode via WebRTC",{playerId:h.playerId,mode:h.action.mode})}break;case"CLEAR_TARGETING_MODE":a(h=>({...h,targetingMode:null})),g.current.targetingMode=null;break;case"SYNC_VALID_TARGETS":((gn=i.data)==null?void 0:gn.playerId)!==T.current&&(te({playerId:i.data.playerId,validHandTargets:i.data.validHandTargets||[],isDeckSelectable:i.data.isDeckSelectable||!1}),setTimeout(()=>{te(h=>(h==null?void 0:h.playerId)===i.data.playerId?null:h)},1e4));break;case"RECONNECT_ACCEPT":if((wn=i.data)!=null&&wn.gameState){const h=i.data.gameState;a(h),v("Connected"),l.info(`[Reconnection] State restored with ${((_n=h.players)==null?void 0:_n.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(w){l.warn("[Reconnection] Failed to clear stored data:",w)}}break;case"RECONNECT_REJECT":{const h=((Cn=i.data)==null?void 0:Cn.reason)||"unknown";l.warn(`[Reconnection] Reconnection rejected: ${h}`),v("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((bn=i.data)==null?void 0:bn.playerId)!==void 0&&(l.info(`[Reconnection] Player ${i.data.playerId} disconnected, reconnection window open`),a(h=>({...h,players:h.players.map(w=>w.id===i.data.playerId?{...w,isDisconnected:!0}:w)})));break;case"PLAYER_RECONNECTED":((Sn=i.data)==null?void 0:Sn.playerId)!==void 0&&(l.info(`[Reconnection] Player ${i.data.playerId} reconnected`),a(h=>({...h,players:h.players.map(w=>w.id===i.data.playerId?{...w,isDisconnected:!1}:w)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((An=i.data)==null?void 0:An.playerId)!==void 0&&(l.info(`[Reconnection] Player ${i.data.playerId} converted to dummy`),a(h=>({...h,players:h.players.map(w=>w.id===i.data.playerId?{...w,isDummy:!0,isDisconnected:!0}:w)})));break;case"REQUEST_DECK_VIEW":if(ne.current&&((Dn=i.data)==null?void 0:Dn.targetPlayerId)!==void 0){const h=i.data.targetPlayerId;i.playerId;const w=r.players.find(C=>C.id===h);if(w&&x.current){let C=[];h===T.current||w.isDummy?(l.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${w.deck.length} cards, first card baseId: ${(Rn=w.deck[0])==null?void 0:Rn.baseId}`),C=w.deck.map(R=>({id:R.id,baseId:R.baseId,deck:R.deck,power:R.power,powerModifier:R.powerModifier,isFaceDown:R.isFaceDown,statuses:R.statuses||[]}))):w.deckCards&&w.deckCards.length>0?C=w.deckCards:C=w.deck.map(R=>({id:R.id,baseId:R.baseId,power:R.power,powerModifier:R.powerModifier,isFaceDown:R.isFaceDown,statuses:R.statuses||[]}));const H={targetPlayerId:h,deckCards:C,deckSize:C.length},z={type:"DECK_VIEW_DATA",senderId:x.current.getPeerId(),data:H,timestamp:Date.now()};x.current.sendToGuest(i.senderId||"",z),l.info(`[REQUEST_DECK_VIEW] Sent ${H.deckCards.length} cards for player ${h}`)}}break;case"DECK_VIEW_DATA":if(((On=i.data)==null?void 0:On.targetPlayerId)!==void 0&&((Pn=i.data)!=null&&Pn.deckCards)){const h=i.data.targetPlayerId,w=i.data.deckCards;l.info(`[DECK_VIEW_DATA] Received ${w.length} deck cards for player ${h}`);const C=z=>{if(z.baseId){const q=Tt(z.baseId);if(q)return{...q,id:z.id,baseId:z.baseId,deck:z.deck||ze.SynchroTech,ownerId:h,power:z.power,powerModifier:z.powerModifier,isFaceDown:z.isFaceDown,statuses:z.statuses||[]};l.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${z.baseId}`)}else l.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${z.id}`);return{id:z.id,baseId:z.baseId||z.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:z.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:ze.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}},H=w.map(C);a(z=>({...z,players:z.players.map(R=>R.id===h?{...R,deck:H}:R)}))}break;case"DECK_DATA_UPDATE":if(ne.current&&i.playerId!==void 0&&((kn=i.data)!=null&&kn.deck)){const h=i.playerId,w=i.data.deck,C=i.data.deckSize;l.info(`[DECK_DATA_UPDATE] Received ${w.length} cards for guest ${h}, deckSize=${C}`),a(H=>({...H,players:H.players.map(z=>z.id===h?{...z,deck:[...w],deckSize:C}:z)}))}break;case"REQUEST_DECK_DATA":if(!ne.current&&x.current){const h=r.players.find(w=>w.id===T.current);if(h&&h.deck.length>0){l.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${h.deck.length} cards`);const w=h.deck.map(C=>({id:C.id,baseId:C.baseId,power:C.power,powerModifier:C.powerModifier||0,isFaceDown:C.isFaceDown||!1,statuses:C.statuses||[]}));x.current.sendAction("DECK_DATA_UPDATE",{playerId:T.current,deck:w,deckSize:w.length})}}break;default:l.warn(`[handleWebrtcMessage] Unknown message type: ${i.type}`,i);break}},[ve,gt,Q,r,c]),j=$.useCallback(i=>{if(!x.current||Ot)return;Je(!0),v("Connecting");const oe=3e4,U=1e3;let B=0;const J=oe/U;try{const ce={hostPeerId:i,playerId:c,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ce))}catch(ce){l.error("[Reconnection] Failed to store data:",ce)}const ie=async()=>{B++;const ce=Math.max(0,oe-B*U);if(ot({attempt:B,maxAttempts:J,timeRemaining:ce}),ce<=0){l.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Je(!1),ot(null),vt();return}let Z=i;if(r!=null&&r.gameId){const Le=pr(r.gameId);if(Le&&Le.peerId!==i){Z=Le.peerId;try{const We={hostPeerId:Z,playerId:c,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(We))}catch(We){l.error("[Reconnection] Failed to update reconnection data:",We)}}}try{const Le=c||T.current;Le!==null?(l.info(`[Reconnection] Reconnecting as existing player ${Le} to host ${Z}`),await x.current.initializeAsReconnectingGuest(Z,Le)):(l.info("[Reconnection] No playerId, connecting as new player"),await x.current.initializeAsGuest(Z)),l.info("[Reconnection] Successfully reconnected!"),Je(!1),ot(null)}catch(Le){l.warn("[Reconnection] Reconnection attempt failed:",Le),setTimeout(ie,U)}};ie()},[Ot,r,c]),M=$.useCallback(i=>{a(oe=>{if(!oe)return l.error("[updateState] prevState is undefined, skipping update"),oe;const U=typeof i=="function"?i(oe):i;if(!U)return l.error("[updateState] newState is undefined, skipping update"),oe;const B=!oe.gameId&&U.gameId;if(!we.current&&!B)return U;if(he&&x.current){if(ne.current){if(x.current.broadcastGameState(U),l.info(`[updateState] Host broadcast state: phase=${U.currentPhase}, activePlayer=${U.activePlayerId}`),U.gameId&&T.current!==null)try{xt({gameState:U,localPlayerId:T.current,isHost:!0}),l.debug("[updateState] Saved game state for host auto-restore")}catch(J){l.warn("[updateState] Failed to save game state:",J)}}else x.current&&(x.current.sendStateToHost(U,T.current),l.info(`[updateState] Guest sent state to host: phase=${U.currentPhase}, activePlayer=${U.activePlayerId}`));return U}if(_e.current&&_e.current.readyState===WebSocket.OPEN){const J={type:"UPDATE_STATE",gameState:U};X.current&&(J.playerToken=X.current),_e.current.send(JSON.stringify(J))}return U})},[he,ve,Q]),W=Qo({ws:_e,webrtcManager:x,gameStateRef:g,webrtcIsHostRef:ne,setGameState:a,updateState:M}),K=es({ws:_e,webrtcManager:x,gameStateRef:g,localPlayerIdRef:T,webrtcIsHostRef:ne,setGameState:a}),ue=ts({updateState:M}),ge=rs({updateState:M}),se=ns({localPlayerIdRef:T,updateState:M}),{addBoardCardStatus:re,removeBoardCardStatus:de,removeBoardCardStatusByOwner:Ie,modifyBoardCardPower:ae,addAnnouncedCardStatus:Pe,removeAnnouncedCardStatus:Ne,modifyAnnouncedCardPower:Ce,addHandCardStatus:nt,removeHandCardStatus:dt,revealHandCard:at,revealBoardCard:It,requestCardReveal:lt,respondToRevealRequest:ct,removeRevealedStatus:sr}=se,yt=as({webrtcIsHostRef:ne,sendWebrtcAction:Ze,webrtcManagerRef:x,localPlayerIdRef:T,getCardDefinition:Tt,commandCardIds:uo,createDeck:gt,updateState:M}),{changePlayerDeck:na,loadCustomDeck:aa,resurrectDiscardedCard:oa,reorderTopDeck:sa,reorderCards:ia,recoverDiscardedCard:da}=yt,ca=os({ws:_e,webrtcManagerRef:x,webrtcIsHostRef:ne,gameStateRef:g,scoreDeltaAccumulator:mt,setGameState:a,updateState:M,abilityMode:t,setAbilityMode:n,createDeck:gt}),{toggleActivePlayer:la,toggleAutoDraw:ua,setPhase:fa,nextPhase:pa,prevPhase:ya,closeRoundEndModal:ha,closeRoundEndModalOnly:Ia,resetGame:Ea}=ca,_t=$.useCallback(()=>{if(localStorage.getItem("webrtc_enabled")==="true"){v("Connected");return}if(f.current||_e.current&&(_e.current.readyState===WebSocket.OPEN||_e.current.readyState===WebSocket.CONNECTING))return;const i=Jo();if(!i){l.warn("No WebSocket URL configured in settings. Waiting for user input."),v("Disconnected"),Qe.current&&clearTimeout(Qe.current);return}try{_e.current=new WebSocket(i)}catch(oe){console.error("Failed to create WebSocket:",oe),v("Disconnected"),Qe.current&&clearTimeout(Qe.current),Qe.current=window.setTimeout(_t,Se.RECONNECT_DELAY);return}v("Connecting"),_e.current.onopen=()=>{var B;we.current=!1,v("Connected");const oe=localStorage.getItem("custom_ws_url");oe&&oe.trim()!==""&&localStorage.setItem("websocket_url",oe.trim());const U=g.current;if(l.info("Current gameState on open:",U?`gameId=${U.gameId}`:"null"),l.info("playerTokenRef.current on open:",X.current?"YES":"NO"),U&&U.gameId&&((B=_e.current)==null?void 0:B.readyState)===WebSocket.OPEN){let J=X.current;if(!J){try{const ie=localStorage.getItem(St);if(ie){const ce=JSON.parse(ie);l.info("RECONNECTION_DATA_KEY:",ce==null?void 0:ce.gameId,U.gameId),ce!=null&&ce.playerToken&&(J=ce.playerToken,X.current=J,l.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(ie){console.warn("Failed to parse reconnection data:",ie instanceof Error?ie.message:String(ie))}if(!J&&U.players&&T.current){const ie=U.players.find(ce=>ce.id===T.current);ie!=null&&ie.playerToken&&(J=ie.playerToken,X.current=J)}}l.info("JoinGame: Sending reconnection with token:",J?"YES":"NO","gameId:",U.gameId),_e.current.send(JSON.stringify({type:"JOIN_GAME",gameId:U.gameId,playerToken:J}))}},_e.current.onmessage=oe=>{try{const U=JSON.parse(oe.data);if(U.type==="GAMES_LIST")I(U.games);else if(U.type==="JOIN_SUCCESS"){if(U.isSpectator){d(null),l.info("Joined as spectator:",U.message||"Spectator mode"),ht.current=null;return}d(U.playerId);const B=ht.current||g.current.gameId;B&&U.playerId!==null&&U.playerToken?(X.current=U.playerToken,localStorage.setItem(St,JSON.stringify({gameId:B,playerId:U.playerId,playerToken:U.playerToken,timestamp:Date.now()})),g.current.gameId===B&&Gn(g.current,U.playerId,U.playerToken)):U.playerId===null&&(Lt(),X.current=void 0),ht.current=null,U.playerId===1&&setTimeout(()=>{var J;((J=_e.current)==null?void 0:J.readyState)===WebSocket.OPEN&&_e.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ft}))},Se.DECK_SYNC_DELAY)}else if(U.type==="CONNECTION_ESTABLISHED"){l.info("Connection acknowledged by server");const B=sessionStorage.getItem("pending_invite_game"),J=sessionStorage.getItem("pending_invite_name");B&&_e.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),l.info("Auto-joining invite game:",B),_e.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:B,playerName:J||"Player"})))}else if(U.type==="DECK_DATA_UPDATED")l.info("Deck data synced with server");else if(U.type==="ERROR")if(U.message.includes("not found")||U.message.includes("Dummy")){l.info("Game not found error - clearing state");const B=bt();a(B),g.current=B,d(null),Lt(),ht.current=null}else if(U.message.includes("already started")&&G.current){l.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const B=bt();a(B),g.current=B,d(null),Lt(),ht.current=null,G.current=!1}else console.warn("Server Error:",U.message);else if(U.type==="HIGHLIGHT_TRIGGERED")P(U.highlightData);else if(U.type==="NO_TARGET_TRIGGERED")E({coords:U.coords,timestamp:U.timestamp});else if(U.type==="DECK_SELECTION_TRIGGERED")m(B=>[...B,U.deckSelectionData]),setTimeout(()=>{m(B=>B.filter(J=>J.timestamp!==U.deckSelectionData.timestamp))},1e3);else if(U.type==="HAND_CARD_SELECTION_TRIGGERED")S(B=>[...B,U.handCardSelectionData]),setTimeout(()=>{S(B=>B.filter(J=>J.timestamp!==U.handCardSelectionData.timestamp))},1e3);else if(U.type==="FLOATING_TEXT_TRIGGERED")a(B=>({...B,floatingTexts:[...B.floatingTexts,U.floatingTextData].filter(J=>Date.now()-J.timestamp<Se.FLOATING_TEXT_DURATION)}));else if(U.type==="FLOATING_TEXT_BATCH_TRIGGERED")a(B=>({...B,floatingTexts:[...B.floatingTexts,...U.batch].filter(J=>Date.now()-J.timestamp<Se.FLOATING_TEXT_DURATION)}));else if(U.type==="SYNC_VALID_TARGETS")U.playerId!==T.current&&(te({playerId:U.playerId,validHandTargets:U.validHandTargets||[],isDeckSelectable:U.isDeckSelectable||!1}),setTimeout(()=>{te(B=>(B==null?void 0:B.playerId)===U.playerId?null:B)},1e4));else if(U.type==="TARGET_SELECTION_TRIGGERED")U.effect&&U.playerId!==T.current&&(Y(B=>[...B,U.effect]),setTimeout(()=>{Y(B=>B.filter(J=>J.timestamp!==U.effect.timestamp))},1e3));else if(U.type==="TARGETING_MODE_SET"){const B=U.targetingMode;B&&(a(J=>({...J,targetingMode:B})),g.current.targetingMode=B,l.info("[TargetingMode] Received targeting mode from server",{playerId:B.playerId,mode:B.action.mode}))}else if(U.type==="TARGETING_MODE_CLEARED")a(B=>({...B,targetingMode:null})),g.current.targetingMode=null,l.debug("[TargetingMode] Cleared targeting mode from server");else if(U.type==="ABILITY_MODE_SET")U.abilityMode&&(a(B=>({...B,abilityMode:U.abilityMode})),l.info("[AbilityMode] Received ability mode from host",{playerId:U.abilityMode.playerId,mode:U.abilityMode.mode,sourceCard:U.abilityMode.sourceCardName}));else if(U.type==="ABILITY_TARGET_SELECTED")l.info("[Ability] Target selected",U.data);else if(U.type==="ABILITY_COMPLETED")a(B=>({...B,abilityMode:null})),l.info("[Ability] Ability completed",U.data);else if(U.type==="ABILITY_CANCELLED")a(B=>({...B,abilityMode:null})),l.info("[Ability] Ability cancelled");else if(U.type==="GAME_RESET")l.info("[GameReset] Received GAME_RESET message from server"),a(B=>{const J=U.activeGridSize||8,ie=[];for(let Z=0;Z<J;Z++){const Le=[];for(let We=0;We<J;We++)Le.push({card:null});ie.push(Le)}const ce={...B,players:U.players||[],gameMode:U.gameMode,isPrivate:U.isPrivate,activeGridSize:U.activeGridSize,dummyPlayerCount:U.dummyPlayerCount,autoAbilitiesEnabled:U.autoAbilitiesEnabled,isGameStarted:U.isGameStarted,currentPhase:U.currentPhase,currentRound:U.currentRound,turnNumber:U.turnNumber,activePlayerId:U.activePlayerId,startingPlayerId:U.startingPlayerId,roundWinners:U.roundWinners||{},gameWinner:U.gameWinner,isRoundEndModalOpen:U.isRoundEndModalOpen,isReadyCheckActive:U.isReadyCheckActive,board:ie,targetingMode:null,floatingTexts:[]};return g.current=ce,ce});else if(!U.type&&U.players&&U.board){const B=Yt(U),J=g.current;if(!J.isScoringStep&&B.isScoringStep&&B.currentPhase!==2){l.debug("Ignoring delayed scoring state update");return}if(J.isScoringStep&&(B.currentPhase!==J.currentPhase||B.activePlayerId!==J.activePlayerId||B.currentPhase!==4)&&(B.isScoringStep=!1),a(B),g.current=B,T.current!==null&&B.gameId){let ce;try{const Z=localStorage.getItem(St);Z&&(ce=JSON.parse(Z).playerToken)}catch{}if(!ce&&B.players){const Z=B.players.find(Le=>Le.id===T.current);Z!=null&&Z.playerToken&&(ce=Z.playerToken,X.current=ce)}Gn(B,T.current,ce)}}else console.warn("Unknown message type:",U.type,"keys:",Object.keys(U),"data:",U)}catch(U){console.error("Failed to parse message from server:",oe.data,U)}},_e.current.onclose=()=>{v("Disconnected"),f.current||(Qe.current&&clearTimeout(Qe.current),Qe.current=window.setTimeout(_t,Se.RECONNECT_DELAY))},_e.current.onerror=oe=>console.error("WebSocket error event:",oe)},[a,bt]),Ta=$.useCallback((i,oe="Player")=>{var U;f.current=!1,((U=_e.current)==null?void 0:U.readyState)===WebSocket.OPEN?_e.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:i,playerName:oe})):(sessionStorage.setItem("pending_invite_game",i),sessionStorage.setItem("pending_invite_name",oe),_t())},[_t]);$.useEffect(()=>{f.current=!1;const i=sessionStorage.getItem("invite_game_id"),oe=sessionStorage.getItem("invite_host_id");if(i&&!oe)return _t(),()=>{f.current=!0,Qe.current&&clearTimeout(Qe.current),_e.current&&(_e.current.onclose=null,_e.current.close())};if(i&&oe)return()=>{f.current=!0,Qe.current&&clearTimeout(Qe.current),_e.current&&(_e.current.onclose=null,_e.current.close())};const U=performance.getEntriesByType("navigation"),B=U.length>0?U[0]:null,J=(B==null?void 0:B.type)??0,ie=Vo();return ie&&(l.info(`Restoring saved game state (nav type: ${J}):`,ie.gameState.gameId),a(ie.gameState),d(ie.localPlayerId),g.current=ie.gameState,T.current=ie.localPlayerId,X.current=ie.playerToken),_t(),()=>{f.current=!0,Qe.current&&clearTimeout(Qe.current),_e.current&&(_e.current.onclose=null,_e.current.close())}},[]),$.useEffect(()=>{if(ft&&g.current&&g.current.gameId){const i=Yt(g.current);i!==g.current&&(a(i),g.current=i)}},[]),$.useEffect(()=>{if(ee)return;const i=setInterval(()=>{if(ft&&g.current&&g.current.gameId){const oe=Yt(g.current);a({...oe}),g.current=oe,ye(!0),clearInterval(i)}},100);return()=>clearInterval(i)},[ee]);const{startReadyCheck:ma,cancelReadyCheck:ga,playerReady:wa}=K,{updatePlayerName:_a,changePlayerColor:Ca}=ue,{drawCard:ba,drawCardsBatch:Sa,shufflePlayerDeck:Aa,flipBoardCard:Da,flipBoardCardFaceDown:Ra}=ge,{assignTeams:Oa,setGameMode:Pa,setGamePrivacy:ka,setActiveGridSize:va,setDummyPlayerCount:Na}=W,La=$.useCallback(()=>{var i;if(((i=_e.current)==null?void 0:i.readyState)===WebSocket.OPEN&&g.current.gameId&&T.current===1){_e.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ft}));const oe=g.current,U=He(oe);U.players.forEach(B=>{if(["hand","deck","discard"].forEach(ie=>{B[ie]&&(B[ie]=B[ie].map(ce=>{const Z=lr(ce.name);return Z?{...ce,...Z}:ce}))}),B.announcedCard){const ie=lr(B.announcedCard.name);ie&&(B.announcedCard={...B.announcedCard,...ie})}}),U.board.forEach(B=>{B.forEach(J=>{if(J.card){const ie=lr(J.card.name);ie&&(J.card={...J.card,...ie})}})}),_e.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:U})),a(U)}},[]),ir=$.useCallback((i,oe)=>{var J;const U=g.current;if(!U.isGameStarted){l.warn("[ScoreUpdate] Blocked: game not started");return}if(U.isRoundEndModalOpen){l.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(oe===0)return;const B=localStorage.getItem("webrtc_enabled")==="true";if(B?M(ie=>({...ie,players:ie.players.map(ce=>ce.id===i?{...ce,score:Math.max(0,(ce.score||0)+oe)}:ce)})):a(ie=>({...ie,players:ie.players.map(ce=>ce.id===i?{...ce,score:Math.max(0,(ce.score||0)+oe)}:ce)})),!B){if(((J=_e.current)==null?void 0:J.readyState)!==WebSocket.OPEN){l.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const ie=mt.get(i);if(ie){clearTimeout(ie.timerId);const ce=ie.delta+oe,Z=setTimeout(()=>{var We;const Le=mt.get(i);Le&&((We=_e.current)==null?void 0:We.readyState)===WebSocket.OPEN&&(l.info(`[ScoreUpdate] Sending accumulated delta: player=${i}, delta=${Le.delta}`),_e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:g.current.gameId,playerId:i,delta:Le.delta}))),mt.delete(i)},500);mt.set(i,{delta:ce,timerId:Z})}else{const ce=setTimeout(()=>{var Le;const Z=mt.get(i);Z&&((Le=_e.current)==null?void 0:Le.readyState)===WebSocket.OPEN&&(l.info(`[ScoreUpdate] Sending delta: player=${i}, delta=${Z.delta}`),_e.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:g.current.gameId,playerId:i,delta:Z.delta}))),mt.delete(i)},500);mt.set(i,{delta:oe,timerId:ce})}}},[a,M]),{triggerHighlight:Ma,triggerFloatingText:Nr,triggerNoTarget:Ga,triggerDeckSelection:xa,triggerHandCardSelection:Ua,syncValidTargets:$a,triggerTargetSelection:Ha}=Ye,Fa=ss({ws:_e,gameStateRef:g,updateState:M,updatePlayerScore:ir,triggerFloatingText:Nr}),{scoreLine:Wa,scoreDiagonal:Ba}=Fa,Et=is({updateState:M,rawJsonData:ft}),Ya=ds({updateState:M,localPlayerIdRef:T,updatePlayerScore:ir}),{moveItem:Lr}=Ya,za=cs({ws:_e,webrtcManager:x,gameStateRef:g,webrtcIsHostRef:ne,setGameState:a}),Ka=us({ws:_e,gameStateRef:g,localPlayerIdRef:T,isRestoringSessionRef:Ue,isManualExitRef:f,webrtcIsHostRef:ne,receivedServerStateRef:we,joiningGameIdRef:ht,setGameState:a,setLocalPlayerId:d,connectWebSocket:_t,updateState:M}),{setTargetingMode:qa,clearTargetingMode:ja}=za,{createGame:Va,joinGame:Mr,exitGame:Ja,requestGamesList:Xa,forceReconnect:Za}=Ka;return{gameState:r,localPlayerId:c,setLocalPlayerId:d,draggedItem:N,setDraggedItem:p,connectionStatus:D,gamesList:_,latestHighlight:y,latestFloatingTexts:A,latestNoTarget:b,latestDeckSelections:L,latestHandCardSelections:O,joinAsInvite:Ta,startReadyCheck:ma,cancelReadyCheck:ga,playerReady:wa,assignTeams:Oa,setGameMode:Pa,setGamePrivacy:ka,setActiveGridSize:va,setDummyPlayerCount:Na,updatePlayerName:_a,changePlayerColor:Ca,updatePlayerScore:ir,changePlayerDeck:na,loadCustomDeck:aa,drawCard:ba,drawCardsBatch:Sa,shufflePlayerDeck:Aa,moveItem:Lr,handleDrop:Lr,addBoardCardStatus:re,removeBoardCardStatus:de,removeBoardCardStatusByOwner:Ie,modifyBoardCardPower:ae,addAnnouncedCardStatus:Pe,removeAnnouncedCardStatus:Ne,modifyAnnouncedCardPower:Ce,addHandCardStatus:nt,removeHandCardStatus:dt,flipBoardCard:Da,flipBoardCardFaceDown:Ra,revealHandCard:at,revealBoardCard:It,requestCardReveal:lt,respondToRevealRequest:ct,syncGame:La,removeRevealedStatus:sr,toggleActivePlayer:la,toggleAutoDraw:ua,triggerHighlight:Ma,triggerFloatingText:Nr,triggerNoTarget:Ga,triggerDeckSelection:xa,triggerHandCardSelection:Ua,triggerTargetSelection:Ha,targetSelectionEffects:k,syncValidTargets:$a,remoteValidTargets:V,setTargetingMode:qa,clearTargetingMode:ja,nextPhase:pa,prevPhase:ya,setPhase:fa,markAbilityUsed:Et.markAbilityUsed,applyGlobalEffect:Et.applyGlobalEffect,swapCards:Et.swapCards,transferStatus:Et.transferStatus,transferAllCounters:Et.transferAllCounters,spawnToken:Et.spawnToken,resetDeployStatus:Et.resetDeployStatus,removeStatusByType:Et.removeStatusByType,recoverDiscardedCard:da,resurrectDiscardedCard:oa,scoreLine:Wa,closeRoundEndModal:ha,closeRoundEndModalOnly:Ia,resetGame:Ea,scoreDiagonal:Ba,reorderTopDeck:sa,reorderCards:ia,updateState:M,requestDeckView:st,sendFullDeckToHost:it,createGame:Va,joinGame:Mr,joinGameViaModal:Mr,exitGame:Ja,requestGamesList:Xa,forceReconnect:Za,webrtcHostId:Fe,webrtcIsHost:ve,initializeWebrtcHost:Ke,connectAsGuest:xe,sendWebrtcAction:Ze,isReconnecting:Ot,reconnectProgress:wt}},Ms=({gameState:e,localPlayerId:t,abilityMode:n,setAbilityMode:r,cursorStack:a,setCursorStack:o,commandContext:s,setCommandContext:c,setViewingDiscard:d,triggerNoTarget:g,triggerTargetSelection:T,setPlayMode:N,setCounterSelectionData:p,interactionLock:D,onAbilityComplete:v,updateState:_,moveItem:I,drawCard:y,drawCardsBatch:P,updatePlayerScore:A,markAbilityUsed:u,applyGlobalEffect:b,swapCards:E,transferStatus:L,transferAllCounters:m,resurrectDiscardedCard:O,spawnToken:S,scoreLine:k,nextPhase:Y,modifyBoardCardPower:V,addBoardCardStatus:te,removeBoardCardStatus:ee,removeBoardCardStatusByOwner:ye,resetDeployStatus:he,scoreDiagonal:me,removeStatusByType:Fe,triggerFloatingText:Ge,triggerHandCardSelection:ve,clearValidTargets:rt,setTargetingMode:ne,clearTargetingMode:Ot})=>{const Je=$.useCallback((f,G)=>{var we,x,$e,Be,Ke,xe,Ze,st,it,Ye,Ue,Ve,qe;if(f.type==="ABILITY_COMPLETE"){v==null||v();return}if(f.type==="REVEREND_SETUP_SCORE"){const Q=((we=f.sourceCard)==null?void 0:we.ownerId)??0;let F=0;for(let j=0;j<e.board.length;j++)for(let M=0;M<e.board[j].length;M++){const W=(x=e.board[j][M])==null?void 0:x.card;if(W!=null&&W.statuses){const K=W.statuses.filter(ue=>ue.type==="Exploit"&&ue.addedByPlayerId===Q);F+=K.length}}F>0?(A(Q,F),Ge([{row:G.row,col:G.col,text:`+${F}`,playerId:Q}])):Ge([{row:G.row,col:G.col,text:"+0",playerId:Q}]),u(G,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}if(f.type==="GLOBAL_AUTO_APPLY"){if((($e=f.payload)==null?void 0:$e.customAction)==="FINN_SCORING"){let Q=0;const F=(Be=f.sourceCard)==null?void 0:Be.ownerId;if(F===void 0){console.warn("[FINN_SCORING] Source card missing ownerId, skipping scoring"),u(f.sourceCoords||G,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}if(e.players.forEach(j=>{j.id!==F&&j.hand.forEach(M=>{var W;(W=M.statuses)!=null&&W.some(K=>K.type==="Revealed"&&K.addedByPlayerId===F)&&Q++})}),e.board.forEach(j=>{j.forEach(M=>{var K;const W=M.card;if(W&&W.ownerId!==F){const ue=((K=W.statuses)==null?void 0:K.filter(ge=>ge.type==="Revealed"&&ge.addedByPlayerId===F).length)||0;Q+=ue}})}),Q>0){const j=f.sourceCoords||G;Ge({row:j.row,col:j.col,text:`+${Q}`,playerId:F}),A(F,Q)}u(f.sourceCoords||G,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}if(((Ke=f.payload)==null?void 0:Ke.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){f.sourceCoords&&f.sourceCoords.row>=0?Fe(f.sourceCoords,"Aim"):s.lastMovedCardCoords?Fe(s.lastMovedCardCoords,"Aim"):G&&G.row>=0&&Fe(G,"Aim");return}if(f.payload&&!f.payload.cleanupCommand){const{tokenType:Q,filter:F}=f.payload,j=[],M=e.board.length;if(f.payload.contextReward&&f.sourceCard){let W=0;const K=G&&G.row>=0?G:s.lastMovedCardCoords;if(K){const{row:ue,col:ge}=K;let se=e.board[ue][ge].card;const re=f.payload._tempContextId||s.lastMovedCardId;if((!se||re&&se.id!==re)&&re)for(let de=0;de<M;de++){for(let Ie=0;Ie<M;Ie++)if(((xe=e.board[de][Ie].card)==null?void 0:xe.id)===re){se=e.board[de][Ie].card;break}if(se)break}se&&(W=Math.max(0,se.power+(se.powerModifier||0)+(se.bonusPower||0)))}if(W>0){const ue=f.sourceCard.ownerId;if(ue===void 0){console.error("Cannot apply reward: sourceCard has no ownerId");return}const ge=f.payload.contextReward;ge==="DRAW_MOVED_POWER"||ge==="DRAW_EQUAL_POWER"?P(ue,W):ge==="SCORE_MOVED_POWER"&&(Ge({row:G.row,col:G.col,text:`+${W}`,playerId:ue}),A(ue,W))}if(f.payload.contextReward==="STUN_MOVED_UNIT"&&K){const ue=f.sourceCard.ownerId;ue!==void 0?te(K,"Stun",ue):console.error("Cannot apply stun: sourceCard has no ownerId")}return}if(F)for(let W=0;W<M;W++)for(let K=0;K<M;K++){const ue=e.board[W][K].card;ue&&F(ue)&&j.push({row:W,col:K})}else f.sourceCoords&&f.sourceCoords.row>=0?j.push(f.sourceCoords):G&&G.row>=0?j.push(G):s.lastMovedCardCoords&&j.push(s.lastMovedCardCoords);if(j.length>0){if(Q){const W=f.payload.count||1,K=f.payload.ownerId!==void 0?f.payload.ownerId:((Ze=f.sourceCard)==null?void 0:Ze.ownerId)??t;for(let ue=0;ue<W;ue++)b(G,j,Q,K,!!f.isDeployAbility)}}else g(G),u(G,!!f.isDeployAbility,!1,f.readyStatusToRemove);return}}if(!Qt(f,e,((st=f.sourceCard)==null?void 0:st.ownerId)||t,s)){g(G),f.chainedAction&&setTimeout(()=>{Je(f.chainedAction,G)},500);return}if(f.type==="CREATE_STACK"&&f.tokenType){let Q=f.count||0;if(f.dynamicCount){const{factor:F,ownerId:j}=f.dynamicCount;let M=0;e.board.forEach(W=>W.forEach(K=>{var ue;if((ue=K.card)!=null&&ue.statuses){const ge=K.card.statuses.filter(se=>se.type===F&&se.addedByPlayerId===j);M+=ge.length}})),Q=M}Q>0?(r(null),o({type:f.tokenType,count:Q,isDragging:!1,sourceCoords:G,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,excludeOwnerId:f.excludeOwnerId,onlyOpponents:f.onlyOpponents,onlyFaceDown:f.onlyFaceDown,targetType:f.targetType,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove,requiredTargetStatus:f.requiredTargetStatus,requireStatusFromSourceOwner:f.requireStatusFromSourceOwner,mustBeAdjacentToSource:f.mustBeAdjacentToSource,mustBeInLineWithSource:f.mustBeInLineWithSource,maxDistanceFromSource:f.maxDistanceFromSource,maxOrthogonalDistance:f.maxOrthogonalDistance,placeAllAtOnce:f.placeAllAtOnce,chainedAction:f.chainedAction,...f.targetOwnerId!==void 0&&{targetOwnerId:f.targetOwnerId},recordContext:f.recordContext,replaceStatus:f.replaceStatus})):g(G)}else if(f.type==="ENTER_MODE"){if(f.mode==="SHIELD_SELF_THEN_SPAWN"){te(G,"Shield",f.sourceCard.ownerId),r({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload});return}if(f.mode==="SHIELD_SELF_THEN_RIOT_PUSH"){const M=f.sourceCard.ownerId;te(G,"Shield",M);const W=e.board.length,K=Math.floor((W-e.activeGridSize)/2),ue=K,ge=K+e.activeGridSize-1;let se=!1;const{row:re,col:de}=G,Ie=[[-1,0],[1,0],[0,-1],[0,1]];for(const[ae,Pe]of Ie){const Ne=re+ae,Ce=de+Pe;if(Ne<ue||Ne>ge||Ce<ue||Ce>ge)continue;const nt=e.board[Ne][Ce];if(!nt.card)continue;const dt=e.players.find(yt=>yt.id===nt.card.ownerId),at=e.players.find(yt=>yt.id===M),It=(dt==null?void 0:dt.teamId)!==void 0&&(at==null?void 0:at.teamId)!==void 0&&dt.teamId===at.teamId;if(nt.card.ownerId===M||It)continue;const lt=Ne+ae,ct=Ce+Pe;if(lt<ue||lt>ge||ct<ue||ct>ge)continue;if(e.board[lt][ct].card===null){se=!0;break}}se?r({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload}):g(G);return}if(f.mode==="PRINCEPS_SHIELD_THEN_AIM"){const M=f.sourceCard.ownerId;te(G,"Shield",M);const W={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility};Qt(W,e,M,s)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:G,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove}):g(G);return}if(f.mode==="GAWAIN_DEPLOY_SHIELD_AIM"){const M=f.sourceCard.ownerId;te(G,"Shield",M);const W={type:"CREATE_STACK",tokenType:"Aim",mustBeInLineWithSource:!0,sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility};Qt(W,e,M,s)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:G,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,mustBeInLineWithSource:!0,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove}):g(G);return}if(f.mode==="ABR_DEPLOY_SHIELD_AIM"){const M=f.sourceCard.ownerId;te(G,"Shield",M);const W={type:"CREATE_STACK",tokenType:"Aim",requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility};Qt(W,e,M,s)?o({type:"Aim",count:1,isDragging:!1,sourceCoords:G,sourceCard:f.sourceCard,originalOwnerId:f.originalOwnerId,targetOwnerId:M,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,isDeployAbility:f.isDeployAbility,readyStatusToRemove:f.readyStatusToRemove}):g(G);return}if(f.mode==="RIOT_PUSH"&&f.sourceCoords){const M=e.board.length,W=Math.floor((M-e.activeGridSize)/2),K=W,ue=W+e.activeGridSize-1;let ge=!1;const{row:se,col:re}=f.sourceCoords,de=(it=f.sourceCard)==null?void 0:it.ownerId,Ie=[[-1,0],[1,0],[0,-1],[0,1]];for(const[ae,Pe]of Ie){const Ne=se+ae,Ce=re+Pe;if(Ne<K||Ne>ue||Ce<K||Ce>ue)continue;const nt=e.board[Ne][Ce];if(!nt.card||de===void 0)continue;const dt=e.players.find(yt=>yt.id===nt.card.ownerId),at=e.players.find(yt=>yt.id===de),It=(dt==null?void 0:dt.teamId)!==void 0&&(at==null?void 0:at.teamId)!==void 0&&dt.teamId===at.teamId;if(nt.card.ownerId===de||It)continue;const lt=Ne+ae,ct=Ce+Pe;if(lt<K||lt>ue||ct<K||ct>ue)continue;if(e.board[lt][ct].card===null){ge=!0;break}}if(!ge){g(f.sourceCoords);return}}if(f.mode==="SELECT_TARGET"&&((Ye=f.payload)==null?void 0:Ye.actionType)==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"&&f.sourceCard){const M=f.sourceCard.ownerId,W=e.players.find(K=>K.id===M);if(W&&W.hand.length<1){g(f.sourceCoords||G);return}}if(f.mode==="SELECT_TARGET"&&((Ue=f.payload)==null?void 0:Ue.actionType)==="LUCIUS_SETUP"&&f.sourceCard){const M=f.sourceCard.ownerId,W=e.players.find(K=>K.id===M);if(W&&W.hand.length<1){g(f.sourceCoords||G);return}}let Q=f.sourceCard,F=G;if(f.sourceCoords&&f.sourceCoords.row>=0&&(F=f.sourceCoords),f.mode==="SELECT_CELL"&&s.lastMovedCardCoords&&s.lastMovedCardId&&((Ve=f.payload)!=null&&Ve.useContextCard)){const{row:M,col:W}=s.lastMovedCardCoords,K=e.board[M][W].card;K&&(Q=K,F=s.lastMovedCardCoords)}r({...f,sourceCard:Q,sourceCoords:F});const j=((qe=f.sourceCard)==null?void 0:qe.ownerId)??e.activePlayerId??t??1;ne(f,j,F,void 0,s)}else if(f.type==="OPEN_MODAL")if(f.mode==="RETRIEVE_DEVICE"){const Q=e.players.find(F=>{var j;return F.id===((j=f.sourceCard)==null?void 0:j.ownerId)});Q&&(d({player:Q,pickConfig:{filterType:"Device",action:"recover"}}),G.row>=0&&u(G,!!f.isDeployAbility,!1,f.readyStatusToRemove))}else if(f.mode==="IMMUNIS_RETRIEVE"){const Q=e.players.find(F=>{var j;return F.id===((j=f.sourceCard)==null?void 0:j.ownerId)});Q&&(d({player:Q,pickConfig:{filterType:"Optimates",action:"resurrect"}}),r({type:"ENTER_MODE",mode:"IMMUNIS_RETRIEVE",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload}))}else if(f.mode==="SEARCH_DECK"){const Q=e.players.find(F=>{var j;return F.id===((j=f.sourceCard)==null?void 0:j.ownerId)});Q&&(d({player:Q,pickConfig:{filterType:f.payload.filterType||"Unit",action:"recover",isDeck:!0}}),G.row>=0&&u(G,!!f.isDeployAbility,!1,f.readyStatusToRemove))}else f.mode==="ZIUS_LINE_SELECT"?s.lastMovedCardCoords?r({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:f.sourceCard,sourceCoords:s.lastMovedCardCoords,isDeployAbility:f.isDeployAbility,payload:f.payload,chainedAction:f.chainedAction}):r({type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload,chainedAction:f.chainedAction}):f.mode==="SELECT_DECK"?r({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload}):f.mode==="ZIUS_EXPLOIT_AND_SCORE"?r({type:"ENTER_MODE",mode:"ZIUS_EXPLOIT_AND_SCORE",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload}):f.mode==="REVEREND_DOUBLE_EXPLOIT"&&r({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:f.sourceCard,sourceCoords:G,isDeployAbility:f.isDeployAbility,payload:f.payload})},[e,t,s,u,r,o,g,b,d,te,A,y,Fe,v,Ge,ne]);$.useEffect(()=>{(n==null?void 0:n.type)==="GLOBAL_AUTO_APPLY"&&(Je(n,n.sourceCoords||{row:-1,col:-1}),r(null))},[n,Je,r]),$.useEffect(()=>{n||Ot()},[n,Ot]);const wt=$.useCallback((f,G)=>{if(n||a||!e.isGameStarted||t===null)return;const X=e.players.find($e=>$e.id===f.ownerId),we=t===f.ownerId||(X==null?void 0:X.isDummy)&&t===1;if(e.activePlayerId!==f.ownerId||!we||!To(f,e)||!Cr(f,e.currentPhase,e.activePlayerId,e))return;const x=Eo(f,e,f.ownerId,G);if(x){x.readyStatusToRemove&&u(G,!!x.isDeployAbility,!1,x.readyStatusToRemove);const $e={...x,chainedAction:x.chainedAction?{...x.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};Je($e,G)}},[n,a,e,t,Je,u]),ot=$.useCallback(f=>{var Ke,xe,Ze,st,it;if(!n)return;const{mode:G,sourceCard:X,sourceCoords:we,payload:x,isDeployAbility:$e,readyStatusToRemove:Be}=n;if(G==="SCORE_LAST_PLAYED_LINE"&&n.sourceCoords){if(D.current)return;const{row:Ye,col:Ue}=n.sourceCoords,{row:Ve,col:qe}=f;if(Ye!==Ve&&Ue!==qe)return;D.current=!0;const Q=e.activePlayerId,F=e.board.length;let j=Ye,M=Ye,W=Ue,K=Ue;if(Ye===Ve)j=Ye,M=Ye,W=0,K=F-1;else if(Ue===qe)W=qe,K=qe,j=0,M=F-1;else{D.current=!1;return}const ue=e.board.some(re=>re.some(de=>{var Ie,ae;return((Ie=de.card)==null?void 0:Ie.ownerId)===Q&&de.card.name.toLowerCase().includes("data liberator")&&((ae=de.card.statuses)==null?void 0:ae.some(Pe=>Pe.type==="Support"))}));let ge=0;const se=[];for(let re=j;re<=M;re++)for(let de=W;de<=K;de++){const ae=e.board[re][de].card;if(ae&&!((Ke=ae.statuses)!=null&&Ke.some(Pe=>Pe.type==="Stun"))){const Pe=ae.ownerId===Q,Ne=(xe=ae.statuses)==null?void 0:xe.some(Ce=>Ce.type==="Exploit"&&Ce.addedByPlayerId===Q);if(Pe||ue&&Ne&&ae.ownerId!==Q){const Ce=Math.max(0,ae.power+(ae.powerModifier||0)+(ae.bonusPower||0));Ce>0&&(ge+=Ce,se.push({row:re,col:de,text:`+${Ce}`,playerId:Q}))}}}r(null),se.length>0&&Ge(se),ge>0&&A(Q,ge),Y(),setTimeout(()=>{D.current=!1},200);return}if(G==="SELECT_LINE_START"){r({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:X,sourceCoords:we,isDeployAbility:$e,payload:{...x,firstCoords:f}});return}if(G==="SELECT_LINE_END"&&(x!=null&&x.firstCoords)){const{row:Ye,col:Ue}=x.firstCoords,{row:Ve,col:qe}=f;if(Ye!==Ve&&Ue!==qe)return;const Q=x.actionType,F=(X==null?void 0:X.ownerId)??((Ze=e.players.find(j=>j.id===e.activePlayerId))!=null&&Ze.isDummy?e.activePlayerId:t||e.activePlayerId);if(Q==="ZIUS_SCORING"){const j=s.lastMovedCardCoords;if(j){const re=Ye===Ve&&j.row===Ye,de=Ue===qe&&j.col===Ue;if(!re&&!de)return}const M=e.board.length;let W=0,K=M-1,ue=0,ge=M-1;if(Ye===Ve)W=K=Ye;else if(Ue===qe)ue=ge=Ue;else return;let se=0;for(let re=W;re<=K;re++)for(let de=ue;de<=ge;de++){const Ie=e.board[re][de];Ie.card&&(se+=((st=Ie.card.statuses)==null?void 0:st.filter(ae=>ae.type==="Exploit"&&ae.addedByPlayerId===F).length)||0)}se>0&&F&&(we&&Ge({row:we.row,col:we.col,text:`+${se}`,playerId:F}),A(F,se)),we&&we.row>=0&&u(we,$e,!1,Be)}else if(Q==="CENTURION_BUFF"&&X&&we&&F){const j=e.board.length;let M=0,W=j-1,K=0,ue=j-1;Ye===Ve?M=W=Ye:K=ue=Ue;for(let ge=M;ge<=W;ge++)for(let se=K;se<=ue;se++){const re=e.board[ge][se].card;if(re){const de=re.id===X.id,Ie=re.ownerId===F,ae=e.players.find(Ce=>Ce.id===F),Pe=e.players.find(Ce=>Ce.id===re.ownerId),Ne=(ae==null?void 0:ae.teamId)!==void 0&&(Pe==null?void 0:Pe.teamId)!==void 0&&ae.teamId===Pe.teamId;!de&&(Ie||Ne)&&V({row:ge,col:se},1)}}u(we,$e,!1,Be)}else(Q==="SCORE_LINE"||!Q)&&(k(Ye,Ue,Ve,qe,F),x.skipNextPhase||Y());setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY)}if(G==="SELECT_DIAGONAL"&&x.actionType==="SCORE_DIAGONAL"){const Ye=(X==null?void 0:X.ownerId)??((it=e.players.find(Ue=>Ue.id===e.activePlayerId))!=null&&it.isDummy?e.activePlayerId:t||e.activePlayerId);if(x.firstCoords){const{row:Ue,col:Ve}=x.firstCoords,{row:qe,col:Q}=f;if(Math.abs(Ue-qe)!==Math.abs(Ve-Q)){r(null);return}me(Ue,Ve,qe,Q,Ye,x.bonusType),x.skipNextPhase||Y(),r(null);return}else{r({...n,payload:{...x,firstCoords:f}});return}}},[n,e,t,k,Y,r,V,u,me,A,Ge,s,_]),ut=$.useCallback((f,G)=>{var X,we,x,$e,Be,Ke,xe,Ze,st,it,Ye,Ue,Ve,qe;if(a&&N!==null&&N!==void 0){const Q={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};At({card:f,ownerId:f.ownerId??0,location:"board"},Q,e.activePlayerId,e.players)&&a.type==="Aim"&&(I({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Aim",count:1},{target:"board",boardCoords:G}),a.sourceCoords&&a.sourceCoords.row>=0&&u(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?o(j=>j?{...j,count:j.count-1}:null):(a.chainedAction&&Je(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),o(null)));return}if(!D.current){if(n&&(n.mode==="SCORE_LAST_PLAYED_LINE"||n.mode==="SELECT_LINE_END")){ot(G);return}if((n==null?void 0:n.type)==="ENTER_MODE"){if(n.sourceCard&&n.sourceCard.id===f.id&&n.mode!=="SELECT_LINE_START"&&n.mode!=="INTEGRATOR_LINE_SELECT"&&n.mode!=="ZIUS_LINE_SELECT"&&n.mode!=="IP_AGENT_THREAT_SCORING"&&n.mode!=="SELECT_UNIT_FOR_MOVE"&&n.mode!=="SELECT_TARGET"&&n.mode!=="RIOT_PUSH"&&n.mode!=="RIOT_MOVE"&&n.mode!=="REVEREND_DOUBLE_EXPLOIT")return;const{mode:Q,payload:F,sourceCard:j,sourceCoords:M,isDeployAbility:W,readyStatusToRemove:K,originalOwnerId:ue,recordContext:ge}=n;if(Q==="SELECT_LINE_START"||Q==="SELECT_LINE_END"){ot(G);return}const se=(j==null?void 0:j.ownerId)??((X=e.players.find(re=>re.id===e.activePlayerId))!=null&&X.isDummy?e.activePlayerId:t||e.activePlayerId);if(Q==="SELECT_TARGET"&&F.tokenType){if(F.filter&&!F.filter(f,G.row,G.col))return;if(I({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:F.tokenType,count:F.count||1},{target:"board",boardCoords:G}),T("board",G),ge&&c({lastMovedCardCoords:G,lastMovedCardId:f.id}),F.chainedAction){const re={...F.chainedAction,sourceCard:F.chainedAction.sourceCard??f,sourceCoords:F.chainedAction.sourceCoords??G,isDeployAbility:W,recordContext:!0};Je(re,G),setTimeout(()=>T("board",G),100),re.type!=="ENTER_MODE"&&r(null)}else M&&M.row>=0&&u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="OPEN_COUNTER_MODAL"){if(F.filter&&!F.filter(f))return;p({card:f,callbackAction:F.rewardType}),r(null);return}if(Q==="SELECT_TARGET"&&F.actionType==="SACRIFICE_AND_BUFF_LINES"){if(F.filter&&!F.filter(f,G.row,G.col))return;I({card:f,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"discard",playerId:f.ownerId});const re=e.board.length,{row:de,col:Ie}=G;for(let ae=0;ae<re;ae++){if(ae===Ie)continue;const Ne=e.board[de][ae].card;Ne&&(Ne.ownerId===se||((we=e.players.find(Ce=>Ce.id===se))==null?void 0:we.teamId)!==void 0&&((x=e.players.find(Ce=>Ce.id===Ne.ownerId))==null?void 0:x.teamId)===(($e=e.players.find(Ce=>Ce.id===se))==null?void 0:$e.teamId))&&V({row:de,col:ae},1)}for(let ae=0;ae<re;ae++){if(ae===de)continue;const Ne=e.board[ae][Ie].card;Ne&&(Ne.ownerId===se||((Be=e.players.find(Ce=>Ce.id===se))==null?void 0:Be.teamId)!==void 0&&((Ke=e.players.find(Ce=>Ce.id===Ne.ownerId))==null?void 0:Ke.teamId)===((xe=e.players.find(Ce=>Ce.id===se))==null?void 0:xe.teamId))&&V({row:ae,col:Ie},1)}M&&M.row>=0&&u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="REVEREND_DOUBLE_EXPLOIT"){if(!se)return;const re=se,de=(f.statuses||[]).filter(Ie=>Ie.type==="Exploit"&&Ie.addedByPlayerId===re).length;for(let Ie=0;Ie<de;Ie++)I({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Exploit",count:1},{target:"board",boardCoords:G});M&&M.row>=0&&u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="DESTROY"){if(F.handOnly||F.filter&&!F.filter(f,G.row,G.col))return;if(((Ze=f.statuses)==null?void 0:Ze.some(de=>de.type==="Shield"))?ee(G,"Shield"):I({card:f,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"discard",playerId:f.ownerId}),F.chainedAction){const de={...F.chainedAction,sourceCard:j,sourceCoords:M,isDeployAbility:W};Je(de,M),de.type!=="ENTER_MODE"&&r(null)}else M&&M.row>=0&&u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="DRAW_EQUAL_POWER"){if(F.filter&&!F.filter(f))return;const re=Math.max(0,f.power+(f.powerModifier||0));for(let de=0;de<re;de++)y(se);setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="SCORE_EQUAL_POWER"){if(F.filter&&!F.filter(f))return;const re=Math.max(0,f.power+(f.powerModifier||0));M&&Ge({row:M.row,col:M.col,text:`+${re}`,playerId:se}),A(se,re),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="RESET_DEPLOY"){if(F.filter&&!F.filter(f))return;he(G),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="SHIELD_AND_REMOVE_AIM"){if(F.filter&&!F.filter(f))return;te(G,"Shield",se),Fe(G,"Aim"),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="SELECT_TARGET"&&F.actionType==="MODIFY_POWER"){if(F.filter&&!F.filter(f))return;F.amount&&V(G,F.amount),M&&M.row>=0&&u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="RIOT_PUSH"&&M&&M.row>=0){if(G.row===M.row&&G.col===M.col){u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}const re=Math.abs(G.row-M.row)+Math.abs(G.col-M.col)===1,de=e.players.find(ct=>ct.id===f.ownerId),Ie=e.players.find(ct=>ct.id===se),ae=(de==null?void 0:de.teamId)!==void 0&&(Ie==null?void 0:Ie.teamId)!==void 0&&de.teamId===Ie.teamId;if(!re||f.ownerId===se||ae)return;const Pe=G.row-M.row,Ne=G.col-M.col,Ce=G.row+Pe,nt=G.col+Ne,dt=e.board.length,at=Math.floor((dt-e.activeGridSize)/2),It=at,lt=at+e.activeGridSize-1;if(Ce<It||Ce>lt||nt<It||nt>lt||e.board[Ce][nt].card!==null)return;I({card:f,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:Ce,col:nt}}),r({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:j,sourceCoords:M,isDeployAbility:W,payload:{vacatedCoords:G}});return}if(Q==="SWAP_POSITIONS"&&M&&M.row>=0){const re=e.board[M.row][M.col].card;if(!re||re.id!==(j==null?void 0:j.id)){r(null);return}if(j&&j.id===f.id||F.filter&&!F.filter(f,G.row,G.col))return;E(M,G),u(G,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="TRANSFER_STATUS_SELECT"&&M&&M.row>=0){if(j&&j.id===f.id||F.filter&&!F.filter(f,G.row,G.col))return;f.statuses&&f.statuses.length>0&&(L(G,M,f.statuses[0].type),u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY));return}if(Q==="TRANSFER_ALL_STATUSES"&&M&&M.row>=0){if(j&&j.id===f.id||F.filter&&!F.filter(f,G.row,G.col))return;m(G,M),u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="REVEAL_ENEMY"){if(j&&j.id===f.id||F.filter&&!F.filter(f,G.row,G.col))return;o({type:"Revealed",count:1,isDragging:!1,sourceCoords:M,sourceCard:j,originalOwnerId:ue,targetOwnerId:f.ownerId,onlyFaceDown:!0,onlyOpponents:!0,isDeployAbility:W,readyStatusToRemove:K}),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="CENSOR_SWAP"&&M&&M.row>=0){if(F.filter&&!F.filter(f))return;ye(G,"Exploit",se),te(G,"Stun",se),u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="ZEALOUS_WEAKEN"&&M&&M.row>=0){if(F.filter&&!F.filter(f))return;V(G,-1),u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="CENTURION_BUFF"&&M&&M.row>=0){u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="SELECT_UNIT_FOR_MOVE"&&M&&M.row>=0){if(F.filter&&!F.filter(f))return;r({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:f,sourceCoords:G,isDeployAbility:W,recordContext:ge,originalOwnerId:se??void 0,payload:{allowSelf:!1,abilitySourceCoords:M,range:F.range,chainedAction:F.chainedAction,originalActorId:se??void 0}});return}if(Q==="SELECT_UNIT_FOR_MOVE"&&!M){if(F.filter&&!F.filter(f))return;r({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:f,sourceCoords:G,recordContext:ge,originalOwnerId:se??void 0,payload:{allowSelf:!1,range:F.range,chainedAction:F.chainedAction,originalActorId:se??void 0}});return}if(Q==="INTEGRATOR_LINE_SELECT"&&M&&M.row>=0){if(G.row!==M.row&&G.col!==M.col)return;const re=e.board.length;let de=0;if(G.row===M.row)for(let Ie=0;Ie<re;Ie++){const ae=e.board[G.row][Ie];ae.card&&(de+=((st=ae.card.statuses)==null?void 0:st.filter(Pe=>Pe.type==="Exploit"&&Pe.addedByPlayerId===se).length)||0)}else for(let Ie=0;Ie<re;Ie++){const ae=e.board[Ie][G.col];ae.card&&(de+=((it=ae.card.statuses)==null?void 0:it.filter(Pe=>Pe.type==="Exploit"&&Pe.addedByPlayerId===se).length)||0)}de>0&&(Ge({row:M.row,col:M.col,text:`+${de}`,playerId:se}),A(se,de)),u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="IP_AGENT_THREAT_SCORING"&&M&&M.row>=0){if(G.row!==M.row&&G.col!==M.col)return;const re=e.board.length;let de=0;if(G.row===M.row)for(let ae=0;ae<re;ae++){const Pe=e.board[G.row][ae];Pe.card&&(de+=((Ye=Pe.card.statuses)==null?void 0:Ye.filter(Ne=>Ne.type==="Threat"&&Ne.addedByPlayerId===se).length)||0)}else for(let ae=0;ae<re;ae++){const Pe=e.board[ae][G.col];Pe.card&&(de+=((Ue=Pe.card.statuses)==null?void 0:Ue.filter(Ne=>Ne.type==="Threat"&&Ne.addedByPlayerId===se).length)||0)}const Ie=de*2;Ie>0&&(Ge({row:M.row,col:M.col,text:`+${Ie}`,playerId:se}),A(se,Ie)),u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(Q==="ZIUS_LINE_SELECT"&&M&&M.row>=0){if(G.row!==M.row&&G.col!==M.col)return;const re=e.board.length;let de=0;const Ie=[];if(G.row===M.row)for(let ae=0;ae<re;ae++){const Pe=e.board[G.row][ae];if(Pe.card){const Ne=((Ve=Pe.card.statuses)==null?void 0:Ve.filter(Ce=>Ce.type==="Exploit"&&Ce.addedByPlayerId===se).length)||0;Ne>0&&(de+=Ne,Ie.push({row:G.row,col:ae,text:`+${Ne}`,playerId:se,timestamp:Date.now()}))}}else for(let ae=0;ae<re;ae++){const Pe=e.board[ae][G.col];if(Pe.card){const Ne=((qe=Pe.card.statuses)==null?void 0:qe.filter(Ce=>Ce.type==="Exploit"&&Ce.addedByPlayerId===se).length)||0;Ne>0&&(de+=Ne,Ie.push({row:ae,col:G.col,text:`+${Ne}`,playerId:se,timestamp:Date.now()}))}}de>0&&(Ge(Ie),A(se,de)),u(M,W,!1,K),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}return}!n&&!a&&wt(f,G)}},[n,a,e,t,D,ot,I,u,r,o,N,ee,ye,te,V,E,L,m,A,y,wt,p,he,Fe,Je,c,Ge,T,At]),_e=$.useCallback(f=>{var Ze,st,it,Ye,Ue,Ve,qe,Q;if(D.current||(n==null?void 0:n.type)!=="ENTER_MODE")return;const{mode:G,sourceCoords:X,sourceCard:we,payload:x,isDeployAbility:$e,readyStatusToRemove:Be,recordContext:Ke}=n;if(G==="SCORE_LAST_PLAYED_LINE"||G==="SELECT_LINE_END"){ot(f);return}if(G==="SELECT_LINE_START"){ot(f);return}if(G==="SELECT_DIAGONAL"){ot(f);return}const xe=(we==null?void 0:we.ownerId)??((Ze=e.players.find(F=>F.id===e.activePlayerId))!=null&&Ze.isDummy?e.activePlayerId:t||e.activePlayerId);if(G==="PATROL_MOVE"&&X&&we&&X.row>=0){const F=f.row===X.row,j=f.col===X.col;if(f.row===X.row&&f.col===X.col){u(X,$e,!1,Be),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}(F||j)&&(u(X,$e,!1,Be),I({card:we,source:"board",boardCoords:X},{target:"board",boardCoords:f}),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY));return}if(G==="RIOT_MOVE"&&X&&we&&x.vacatedCoords){if(f.row===x.vacatedCoords.row&&f.col===x.vacatedCoords.col){I({card:we,source:"board",boardCoords:X},{target:"board",boardCoords:f}),u(f,$e,!1,Be),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}u(X,$e,!1,Be),r(null);return}if(G==="SPAWN_TOKEN"&&X&&x.tokenName&&X.row>=0){if(Math.abs(f.row-X.row)+Math.abs(f.col-X.col)===1){const j=(we==null?void 0:we.ownerId)??xe;S(f,x.tokenName,j),u(X,$e,!1,Be),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY)}return}if(G==="SELECT_CELL"&&we){const F=(()=>{var M;if(x.moveFromHand)return null;if(X&&X.row>=0)return X;for(let W=0;W<e.board.length;W++)for(let K=0;K<e.board.length;K++)if(((M=e.board[W][K].card)==null?void 0:M.id)===we.id)return{row:W,col:K};return null})();if(x.moveFromHand&&s.selectedHandCard){const{playerId:M,cardIndex:W}=s.selectedHandCard,K=e.players.find(ge=>ge.id===M),ue=K==null?void 0:K.hand[W];ue&&(I({card:ue,source:"hand",playerId:M,cardIndex:W,isManual:!0},{target:"board",boardCoords:f}),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY));return}let j=!1;if(F)if(x.range==="line")j=f.row===F.row||f.col===F.col;else if(x.range==="global")j=!0;else if(x.range===2){const M=Math.abs(f.row-F.row)+Math.abs(f.col-F.col);if(M===1)j=!0;else if(M===2){const W=F.row,K=F.col,ue=f.row,ge=f.col;j=[{r:ue,c:K},{r:W,c:ge},{r:(W+ue)/2,c:(K+ge)/2}].some(re=>{if(!Number.isInteger(re.r)||!Number.isInteger(re.c))return!1;const de=Math.floor((e.board.length-e.activeGridSize)/2),Ie=de,ae=de+e.activeGridSize-1;return re.r<Ie||re.r>ae||re.c<Ie||re.c>ae||Math.abs(re.r-W)+Math.abs(re.c-K)!==1?!1:!e.board[re.r][re.c].card})}}else j=Math.abs(f.row-F.row)+Math.abs(f.col-F.col)===1;if(j&&F){const M=x.allowSelf&&f.row===F.row&&f.col===F.col;if(!M){const W=e.board[F.row][F.col].card;W&&I({card:W,source:"board",boardCoords:F,bypassOwnershipCheck:!0},{target:"board",boardCoords:f})}if(Ke&&c({lastMovedCardCoords:f,lastMovedCardId:we.id}),x.chainedAction){const W={...x.chainedAction};W.targetOwnerId===-2&&(W.targetOwnerId=we.ownerId),Ke&&(W.payload||(W.payload={}),W.payload._tempContextId=we.id),r(null),rt(),setTimeout(()=>{Je(W,f)},1)}else{if(x.abilitySourceCoords)u(x.abilitySourceCoords,$e,!1,Be);else{const W=M?X:f;W&&W.row>=0&&(x.originalActorId===void 0||we.ownerId===x.originalActorId)&&u(W,$e,!1,Be)}setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY)}return}return}if(G==="IMMUNIS_RETRIEVE"&&X&&X.row>=0){if(x.selectedCardIndex!==void 0&&((st=x.filter)!=null&&st.call(x,f.row,f.col))){O(xe,x.selectedCardIndex,f),u(X,$e,!1,Be),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(x.selectedCardIndex===void 0)return}if(G==="INTEGRATOR_LINE_SELECT"&&X&&X.row>=0){if(f.row!==X.row&&f.col!==X.col)return;const F=e.board.length;let j=0;if(f.row===X.row)for(let M=0;M<F;M++){const W=e.board[f.row][M];W.card&&(j+=((it=W.card.statuses)==null?void 0:it.filter(K=>K.type==="Exploit"&&K.addedByPlayerId===xe).length)||0)}else for(let M=0;M<F;M++){const W=e.board[M][f.col];W.card&&(j+=((Ye=W.card.statuses)==null?void 0:Ye.filter(K=>K.type==="Exploit"&&K.addedByPlayerId===xe).length)||0)}j>0&&(Ge({row:X.row,col:X.col,text:`+${j}`,playerId:xe}),A(xe,j)),u(X,$e,!1,Be),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(G==="ZIUS_LINE_SELECT"&&X&&X.row>=0){if(f.row!==X.row&&f.col!==X.col)return;const F=e.board.length;let j=0;const M=[];if(f.row===X.row)for(let W=0;W<F;W++){const K=e.board[f.row][W];if(K.card){const ue=((Ue=K.card.statuses)==null?void 0:Ue.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===xe).length)||0;ue>0&&(j+=ue,M.push({row:f.row,col:W,text:`+${ue}`,playerId:xe,timestamp:Date.now()}))}}else for(let W=0;W<F;W++){const K=e.board[W][f.col];if(K.card){const ue=((Ve=K.card.statuses)==null?void 0:Ve.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===xe).length)||0;ue>0&&(j+=ue,M.push({row:W,col:f.col,text:`+${ue}`,playerId:xe,timestamp:Date.now()}))}}j>0&&(Ge(M),A(xe,j)),u(X,$e,!1,Be),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}if(G==="IP_AGENT_THREAT_SCORING"&&X&&X.row>=0){if(f.row!==X.row&&f.col!==X.col)return;const F=e.board.length;let j=0;if(f.row===X.row)for(let W=0;W<F;W++){const K=e.board[f.row][W];K.card&&(j+=((qe=K.card.statuses)==null?void 0:qe.filter(ue=>ue.type==="Threat"&&ue.addedByPlayerId===xe).length)||0)}else for(let W=0;W<F;W++){const K=e.board[W][f.col];K.card&&(j+=((Q=K.card.statuses)==null?void 0:Q.filter(ue=>ue.type==="Threat"&&ue.addedByPlayerId===xe).length)||0)}const M=j*2;M>0&&(Ge({row:X.row,col:X.col,text:`+${M}`,playerId:xe}),A(xe,M)),u(X,$e,!1,Be),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY);return}},[D,n,e,t,ot,I,u,r,S,c,O,A,s,Je,Ge,rt]),Qe=$.useCallback((f,G,X)=>{var we;if(!D.current){if(a&&N!==null&&N!==void 0){const x={targetOwnerId:a.targetOwnerId,excludeOwnerId:a.excludeOwnerId,onlyOpponents:a.onlyOpponents||a.targetOwnerId===-1,onlyFaceDown:a.onlyFaceDown,targetType:a.targetType,requiredTargetStatus:a.requiredTargetStatus,tokenType:a.type};if(At({card:G,ownerId:f.id,location:"hand"},x,e.activePlayerId,e.players)&&a.type==="Revealed"){const Be=((we=a.sourceCard)==null?void 0:we.ownerId)??e.activePlayerId??t??1;G.statuses||(G.statuses=[]),G.statuses.some(xe=>xe.type==="Revealed"&&xe.addedByPlayerId===Be)||(G.statuses.push({type:"Revealed",addedByPlayerId:Be}),I({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:f.id,cardIndex:X}),a.sourceCoords&&a.sourceCoords.row>=0&&u(a.sourceCoords,a.isDeployAbility,!1,a.readyStatusToRemove),a.count>1?o(xe=>xe?{...xe,count:xe.count-1}:null):(a.chainedAction&&Je(a.chainedAction,a.sourceCoords||{row:-1,col:-1}),o(null)))}return}if((n==null?void 0:n.type)==="ENTER_MODE"&&n.mode==="SELECT_TARGET"){const{payload:x,sourceCoords:$e,isDeployAbility:Be,sourceCard:Ke,readyStatusToRemove:xe}=n;if(ve(f.id,X,e.activePlayerId??t??1),x.actionType==="SELECT_HAND_FOR_DEPLOY"){if(x.filter&&!x.filter(G))return;c(Ze=>({...Ze,selectedHandCard:{playerId:f.id,cardIndex:X}})),r({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:G,payload:{range:"global",moveFromHand:!0}});return}if(x.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(x.filter&&!x.filter(G)||f.id!==(Ke==null?void 0:Ke.ownerId))return;I({card:G,source:"hand",playerId:f.id,cardIndex:X,bypassOwnershipCheck:!0},{target:"discard",playerId:f.id}),r({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:Ke,sourceCoords:$e,isDeployAbility:Be,payload:{tokenName:x.tokenName}});return}if(x.actionType==="LUCIUS_SETUP"){if(f.id!==(Ke==null?void 0:Ke.ownerId))return;I({card:G,source:"hand",playerId:f.id,cardIndex:X,bypassOwnershipCheck:!0},{target:"discard",playerId:f.id}),Je({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:Ke,sourceCoords:$e,isDeployAbility:Be,payload:{filterType:"Command"}},$e||{row:-1,col:-1}),r(null);return}if(x.actionType==="DESTROY"){if(x.filter&&!x.filter(G))return;I({card:G,source:"hand",playerId:f.id,cardIndex:X,bypassOwnershipCheck:!0},{target:"discard",playerId:f.id}),$e&&$e.row>=0&&u($e,Be,!1,xe),setTimeout(()=>r(null),Se.MODE_CLEAR_DELAY)}}}},[D,n,I,u,r,c,Je,e,t,ve,a,o,N]),ht=$.useCallback((f,G)=>{n||a||D.current||e.isGameStarted&&e.activePlayerId===f.id&&Cr(G,e.currentPhase,e.activePlayerId,e)&&wt(G,{row:-1,col:-1})},[n,a,D,e,wt]);return{activateAbility:wt,executeAction:Je,handleLineSelection:ot,handleBoardCardClick:ut,handleEmptyCellClick:_e,handleHandCardClick:Qe,handleAnnouncedCardDoubleClick:ht}},gr=(e,t,n,r,a)=>{const o=(n.baseId||e.split("_")[1]||e).toLowerCase(),s=t===-1,c=[];o==="overwatch"?s?c.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:n}):t===0?c.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},targetOwnerId:-1,onlyOpponents:!0,sourceCard:n}):t===1&&c.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:a,baseCount:0}},sourceCard:n}):o==="tacticalmaneuver"?t===0?c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:n,payload:{range:"line",filter:g=>g.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:n}}}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:n,payload:{range:"line",filter:g=>g.ownerId===a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:n}}}):o==="inspiration"?s&&c.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"OPEN_COUNTER_MODAL",filter:g=>g.ownerId===a}}):o==="datainterception"?s?c.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:n}):t===0?c.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:n}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:2,filter:g=>{var T;return((T=g.statuses)==null?void 0:T.some(N=>N.type==="Exploit"&&N.addedByPlayerId===a))||!1}}}):o==="falseorders"?s?c.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:n,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):t===0?c.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:n,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:a,sourceCard:n,originalOwnerId:n.ownerId}}}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:n,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:a}}}}):o==="experimentalstimulants"?t===0?c.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"RESET_DEPLOY",filter:g=>{var T;return g.ownerId===a&&((T=g.types)==null?void 0:T.includes("Unit"))}}}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:"line",filter:g=>g.ownerId===a}}):o==="logisticschain"?t===0?c.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:n,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:n,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):o==="quickresponseteam"?t===0?c.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:n,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:g=>{var T;return g.ownerId===a&&((T=g.types)==null?void 0:T.includes("Unit"))}}}):t===1&&c.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:n,payload:{filterType:"Unit"}}):o==="temporaryshelter"?t===0?c.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):t===1&&c.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:a,recordContext:!0,sourceCard:n,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):o==="enhancedinterrogation"?s?c.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:n}):t===0?c.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:a},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:n}):t===1&&c.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:n,payload:{range:2,filter:g=>{var T;return((T=g.statuses)==null?void 0:T.some(N=>N.type==="Aim"&&N.addedByPlayerId===a))||!1}}}):(o==="mobilization1"||o==="linebreach")&&s&&c.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:n,payload:{actionType:"SCORE_LINE"}});const d=n.ownerId||a;return c.forEach(g=>{g.originalOwnerId=d,g.sourceCard&&!g.sourceCard.ownerId&&(g.sourceCard.ownerId=d)}),c},Gs=({gameState:e,localPlayerId:t,setActionQueue:n,setCommandContext:r,setCommandModalCard:a,setCounterSelectionData:o,moveItem:s,updatePlayerScore:c,updateState:d})=>{const g=$.useCallback((p,D)=>{if(t===null)return;const v=e.players.find(P=>P.id===D.playerId);if(!(D.playerId===t||(v==null?void 0:v.isDummy)))return;s(D,{target:"announced",playerId:D.playerId}),r({});const I=(p.baseId||p.id.split("_")[1]||p.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(P=>I.includes(P)))a(p);else{const P=gr(p.id,-1,p,e,D.playerId);P.length>0?n([...P,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:p,ownerId:D.playerId},sourceCard:p}]):n([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:p,ownerId:D.playerId},sourceCard:p}])}},[e,t,s,n,r,a]),T=$.useCallback((p,D)=>{var A,u;if(!D||t===null)return;const v=D.ownerId||t,_=[],I=gr(D.id,-1,D,e,v);let y;(A=D.baseId)!=null&&A.toLowerCase().includes("inspiration")&&(y=p===0?"DRAW_REMOVED":"SCORE_REMOVED",I.length>0&&I[0].type==="ENTER_MODE"&&(I[0]={...I[0],payload:{...I[0].payload,rewardType:y}})),I.forEach(b=>{_.push(b)}),gr(D.id,p,D,e,v).forEach(b=>{_.push(b)}),(u=D.baseId)!=null&&u.toLowerCase().includes("inspiration")||_.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:D,ownerId:v},sourceCard:D}),n(_),a(null)},[e,t,n,a]),N=$.useCallback((p,D)=>{var y;if(t===null)return;const v=D.card.ownerId||t;let _=null;for(let P=0;P<e.board.length;P++){for(let A=0;A<e.board[P].length;A++)if(((y=e.board[P][A].card)==null?void 0:y.id)===D.card.id){_={row:P,col:A};break}if(_)break}if(!_){console.warn(`Card ${D.card.id} not found on board during counter removal`),o(null);return}if(d(P=>{if(!P.isGameStarted)return P;const A=He(P),u=A.board[_.row][_.col].card;let b=0;const E=(u==null?void 0:u.statuses)??[];if(Object.entries(p).forEach(([L,m])=>{for(let O=0;O<m;O++){const S=E.map(k=>k.type).lastIndexOf(L);S>-1&&(u!=null&&u.statuses)&&(u.statuses.splice(S,1),b++)}}),!(u!=null&&u.statuses)&&u&&(u.statuses=[]),A.board=tt(A),b>0&&D.callbackAction==="DRAW_REMOVED"){const L=A.players.find(m=>m.id===v);if(L){const m=Math.min(b,L.deck.length);for(let O=0;O<m;O++){const S=L.deck.shift();S&&L.hand.push(S)}}}return A}),D.callbackAction==="SCORE_REMOVED"){const P=Object.values(p).reduce((A,u)=>A+u,0);P>0&&c(v,P)}const I=e.players.find(P=>P.id===v);I!=null&&I.announcedCard&&n([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:I.announcedCard,ownerId:v},sourceCard:I.announcedCard}]),o(null)},[t,c,n,o,e,d]);return{playCommandCard:g,handleCommandConfirm:T,handleCounterSelectionConfirm:N}},xs=({gameState:e,localPlayerId:t,handleDrop:n,markAbilityUsed:r,requestCardReveal:a,interactionLock:o,setCommandContext:s,onAction:c,cursorStack:d,setCursorStack:g,setAbilityMode:T,triggerTargetSelection:N})=>{const p=$.useRef(null),D=$.useRef({x:0,y:0});return $.useLayoutEffect(()=>{if(d&&p.current){const{x:_,y:I}=D.current;p.current.style.transform=`translate(${_-24}px, ${I-24}px)`}},[d]),$.useEffect(()=>{const _=I=>{D.current={x:I.clientX,y:I.clientY},p.current&&(p.current.style.transform=`translate(${I.clientX-24}px, ${I.clientY-24}px)`)};return window.addEventListener("mousemove",_),()=>window.removeEventListener("mousemove",_)},[]),$.useEffect(()=>{const _=I=>{var u,b,E,L,m,O,S,k;if(I.button!==0||!d)return;const y=document.elementFromPoint(I.clientX,I.clientY);let P=t;if(d.originalOwnerId!==void 0)P=d.originalOwnerId;else if((u=d.sourceCard)!=null&&u.ownerId)P=d.sourceCard.ownerId;else if(d.sourceCoords&&d.sourceCoords.row>=0){const{row:Y,col:V}=d.sourceCoords;if(Y>=0&&Y<e.board.length&&V>=0&&V<((b=e.board[Y])==null?void 0:b.length)){const te=e.board[Y][V].card;te&&(P=te.ownerId||t)}}else if(e.activePlayerId){const Y=e.players.find(V=>V.id===e.activePlayerId);Y!=null&&Y.isDummy&&(P=Y.id)}let A=y==null?void 0:y.closest("[data-hand-card]");if(!A&&y)if(y.getAttribute("data-hand-card"))A=y;else{const Y=y.querySelectorAll("[data-hand-card]");if(Y.length>0){let V=1/0,te=null;const ee=I.clientX,ye=I.clientY;for(const he of Array.from(Y)){const me=he.getBoundingClientRect();if(ee>=me.left&&ee<=me.right&&ye>=me.top&&ye<=me.bottom){const Fe=me.left+me.width/2,Ge=me.top+me.height/2,ve=Math.hypot(ee-Fe,ye-Ge);ve<V&&(V=ve,te=he)}}A=te}}if(A){const Y=A.getAttribute("data-hand-card");if(Y){const[V,te]=Y.split(","),ee=parseInt(V,10),ye=parseInt(te,10),he=e.players.find(Fe=>Fe.id===ee),me=he==null?void 0:he.hand[ye];if(he&&me){if(d.type==="Revealed"&&!he.isDummy){if((E=me.statuses)==null?void 0:E.some(ne=>ne.type==="Revealed"&&ne.addedByPlayerId===P))return;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((L=d.sourceCard)==null?void 0:L.ownerId)??P??void 0,statusType:d.type,count:1},{target:"hand",playerId:ee,cardIndex:ye,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?g(ne=>ne?{...ne,count:ne.count-1}:null):(d.chainedAction&&c(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),g(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}const Ge={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,tokenType:d.type};if(!At({card:me,ownerId:ee,location:"hand"},Ge,P,e.players))return;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((m=d.sourceCard)==null?void 0:m.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:ee,cardIndex:ye,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?g(rt=>rt?{...rt,count:rt.count-1}:null):(d.chainedAction&&c(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),g(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}}if(!A){const Y=y==null?void 0:y.closest("[data-board-coords]");if(Y){const V=Y.getAttribute("data-board-coords");if(V){const[te,ee]=V.split(","),ye=parseInt(te,10),he=parseInt(ee,10);if(!isNaN(ye)&&!isNaN(he)&&ye>=0&&ye<e.board.length&&e.board[ye]&&he>=0&&he<e.board[ye].length&&e.board[ye][he]){const me=e.board[ye][he].card;if((me==null?void 0:me.ownerId)!==void 0){const Fe={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,mustBeAdjacentToSource:d.mustBeAdjacentToSource,mustBeInLineWithSource:d.mustBeInLineWithSource,sourceCoords:d.sourceCoords,tokenType:d.type};if(!At({card:me,ownerId:me.ownerId,location:"board",boardCoords:{row:ye,col:he}},Fe,P,e.players))return;const ve=e.players.find(rt=>rt.id===me.ownerId);if(d.type==="Revealed"&&!(ve!=null&&ve.isDummy)){if((O=me.statuses)==null?void 0:O.some(ne=>ne.type==="Revealed"&&ne.addedByPlayerId===P))return;me.isFaceDown?t!==null&&a({source:"board",ownerId:me.ownerId,boardCoords:{row:ye,col:he}},t):(n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((S=d.sourceCard)==null?void 0:S.ownerId)??P??void 0,statusType:d.type,count:1},{target:"board",boardCoords:{row:ye,col:he}}),N("board",{row:ye,col:he})),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?g(ne=>ne?{...ne,count:ne.count-1}:null):(d.chainedAction&&c(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),g(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}if(me){const Fe=d.placeAllAtOnce?d.count:1;n({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((k=d.sourceCard)==null?void 0:k.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:Fe},{target:"board",boardCoords:{row:ye,col:he}}),N("board",{row:ye,col:he}),d.recordContext&&s(ve=>({...ve,lastMovedCardCoords:{row:ye,col:he},lastMovedCardId:me.id})),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility);const Ge=d.count-Fe;if(Ge>0)g(ve=>ve?{...ve,count:Ge}:null);else{if(d.chainedAction){const ve={...d.chainedAction};d.recordContext&&(ve.mode==="SELECT_CELL"&&(ve.sourceCard=me,ve.sourceCoords={row:ye,col:he},ve.recordContext=!0),ve.type==="GLOBAL_AUTO_APPLY"&&(ve.sourceCoords={row:ye,col:he}),ve.type==="CREATE_STACK"&&(ve.sourceCoords={row:ye,col:he},ve.originalOwnerId||(ve.sourceCard=me)),ve.mode==="ZIUS_LINE_SELECT"&&(ve.sourceCoords={row:ye,col:he})),ve.type==="CREATE_STACK"&&T(null),c(ve,{row:ye,col:he})}g(null)}o.current=!0,setTimeout(()=>{o.current=!1},300)}}}}else{const V=y==null?void 0:y.closest(".counter-modal-content"),te=(y==null?void 0:y.closest("[data-board-coords]"))!==null,ee=(y==null?void 0:y.closest("[data-hand-card]"))!==null;d.isDragging?V?g(ye=>ye?{...ye,isDragging:!1}:null):!te&&!ee&&g(null):!V&&!te&&!ee&&g(null)}}};return window.addEventListener("mouseup",_),()=>{window.removeEventListener("mouseup",_)}},[d,n,e,t,a,r,o,s,c,g,T,N]),$.useEffect(()=>{const _=I=>{d&&(I.preventDefault(),g(null))};return window.addEventListener("contextmenu",_),()=>{window.removeEventListener("contextmenu",_)}},[d,g]),{cursorFollowerRef:p,handleCounterMouseDown:(_,I)=>{D.current={x:I.clientX,y:I.clientY},g(y=>(y==null?void 0:y.type)===_?{type:_,count:y.count+1,isDragging:!0,sourceCoords:y.sourceCoords}:{type:_,count:1,isDragging:!0})}}};export{Gs as A,Ms as B,xs as C,gs as D,hs as E,_s as F,ms as G,ar as H,gr as I,At as J,Qt as K,l as L,fo as M,vr as N,Is as O,ws as P,uo as Q,bs as S,Se as T,Mt as a,ze as b,Hn as c,po as d,As as e,Es as f,Tt as g,To as h,co as i,Rs as j,Sr as k,Cs as l,lo as m,yo as n,Ts as o,Ss as p,Ns as q,Ds as r,ks as s,io as t,vs as u,Ps as v,vt as w,or as x,Os as y,Ls as z};
