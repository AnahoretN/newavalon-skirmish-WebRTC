import{r as H,j as yo}from"./vendor-react-JYPVbgc1-0.2.11.js";import{$ as Dt}from"./vendor-webrtc-BBsnVRmn-0.2.11.js";import{d as Sa,e as ho}from"./vendor-BPR6uEV2-0.2.11.js";var Ce=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(Ce||{}),er=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(er||{});const mo={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365235/SYN_IP_DEPT_AGENT_pbvh9e.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_TACTICAL_AGENT_vquxfm.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_PATROL_AGENT_nlyneg.webp",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_RIOT_AGENT_i4lk5m.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_THREAT_ANALYST_uqxbsp.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367440/HERO_Mr._Pearl_Director_of_BioSynch_lsesol.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_RECKLESS_PROVOCATEUR_wvfdcr.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_DATA_LIBERATOR_qeru3j.webp",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_CAUTIOUS_AVENGER_xzk6pd.webp",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_VIGILANT_SPOTTER_xo8ig7.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_INVENTIVE_MAKER_sicb73.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367436/HERO_Finn_c8637x.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_FABER_cr804w.webp",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365250/OPT_CENSOR_w4qijk.webp",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_PRINCEPS_aaqakx.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_IMMUNIS_hvlxhi.webp",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_CENTURION_grztbi.webp",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367435/HERO_Lucius_The_Immortal_irhhaj.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_CODE_KEEPER_yhowqj.webp",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_DEVOUT_SYNTHETIC_nkr1tx.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_UNWAVERING_INTEGRATOR_g1cbag.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_SIGNAL_PROPHET_rmk9me.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_ZEALOUS_MISSIONARY_v7qjhw.webp",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367438/HERO_Reverend_of_The_Choir_njrrih.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365196/CMD_OVERWATCH_djwlqo.webp",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_REPOSITIONING_uhwvrk.webp",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_INSPIRATION_v0bi3l.webp",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_DATA_INTERCEPTION_gen1qw.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_FALSE_ORDERS_aatcmc.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367418/CMD_Experimental_Stimulants_plsnet.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367415/CMD_Logistics_Chain_odmwxq.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367414/CMD_Quick_Response_Team_xff2yt.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367411/CMD_Temporary_Shelter_podjbj.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367413/CMD_Enhanced_Interrogation_legiod.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367446/N_Autonomous_Battle_Robot_Gawain_oni745.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Reclaimed_Gawain_sjmlsp.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Secret_informant_w0w6g5.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367432/HERO_Michael_Falk_sv5i5c.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367434/HERO_Edith_Byron_ny23vb.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367429/HERO_Pinkunoneko_cqhpuy.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367431/HERO_Maria_Eleftheria_Damanaki_cpw12i.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367428/HERO_Zius_xhuyxa.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},Io={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_RECON_DRONE_w3elir.webp",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_WALKING_TURRET_c0mttm.webp",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},Eo={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365400/Aim_qzeaqn.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365398/Exploit_pf2zwf.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Revealed_lsan64.webp",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand and face-down cards on board.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board-facedown","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365403/Stun_pbe7ex.webp",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Shield_yilhdt.webp",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365402/Support_hxzufw.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771368527/Threat_dqnnsq.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365394/Resurrected_awaucv.webp",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},To=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],Ut={cardDatabase:mo,tokenDatabase:Io,countersDatabase:Eo,deckFiles:To};let ha=null,ot=new Map,Jt=new Map,gt={},Ot=[],Xt={};const Ca=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function ui(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const r=await fetch("/api/content/database");if(r.ok){const a=await r.json(),n=a.cards.map(([o,s])=>[o,s]),i=a.tokens.map(([o,s])=>[o,s]);e={cardDatabase:Object.fromEntries(n),tokenDatabase:Object.fromEntries(i),countersDatabase:Object.fromEntries(a.counters),deckFiles:a.deckFiles}}else e=Ut}catch{e=Ut}else e=Ut;ha=e,ot=new Map(Object.entries(e.cardDatabase)),Jt=new Map(Object.entries(e.tokenDatabase)),gt=e.countersDatabase,Ot=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(gt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(r){console.warn("Could not save counters database to localStorage:",r)}Fe=ha,Da=ot,wo=Jt,it=gt,_o=Ot,Xt=go(),bo=Xt}catch(e){throw console.error("Failed to load content database:",e),e}}function go(){const e={};for(const t of Ot){const r=[];for(const a of t.cards){const n=ot.get(a.cardId);if(!n){console.warn(`Card definition not found for ID: ${a.cardId} in deck: ${t.name}`);continue}const i=Ca.has(a.cardId);for(let o=0;o<a.quantity;o++){const d=a.cardId.replace(/-/g,"--DASH--").toUpperCase();i?r.push({...n,deck:Ce.Command,id:`CMD_${d}_${o+1}`,baseId:a.cardId,faction:n.faction||"Command"}):r.push({...n,deck:t.id,id:`${t.id.substring(0,3).toUpperCase()}_${d}_${o+1}`,baseId:a.cardId,faction:n.faction||t.id})}}if(e[t.id]=r,t.id==="Optimates"){const a={},n=new Set;let i=!1;r.forEach(o=>{n.has(o.id)&&(console.error(`[buildDecksData] DUPLICATE ID in Optimates: ${o.id}`),i=!0),n.add(o.id);const s=o.baseId||o.id;a[s]=(a[s]||0)+1}),console.log("[buildDecksData] Optimates deck:",{totalCards:r.length,cardCounts:a,hasDuplicateIds:i})}}return e[Ce.Tokens]=Array.from(Jt.entries()).map(([t,r])=>{const a=r.types?[...r.types]:[];return{id:`TKN_${r.name.toUpperCase().replace(/\s/g,"_")}`,baseId:t,deck:Ce.Tokens,name:r.name,imageUrl:r.imageUrl,fallbackImage:r.fallbackImage,power:r.power,ability:r.ability,color:r.color,types:a,flavorText:r.flavorText,faction:"Tokens"}}),e}let Fe=null,Da=new Map,wo=new Map,it={};try{const e=localStorage.getItem("counters_database");e&&(gt=JSON.parse(e),it=gt)}catch{}let _o=[],bo={};const Ao=Ca,fi=()=>Ot.filter(e=>e.isSelectable);function Ye(e){return ot.get(e)}function Ht(e){return Array.from(ot.values()).find(t=>t.name===e)}function pi(){return Array.from(ot.entries()).map(([e,t])=>({id:e,card:t}))}function yi(){return ot}function Ra(){return Xt}const So=4,hi={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/medal_tavarc.webp"},mi={[Ce.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[Ce.Hoods]:{prefix:"HOO",color:"border-purple-500"},[Ce.Optimates]:{prefix:"OPT",color:"border-red-500"},[Ce.Fusion]:{prefix:"FUS",color:"border-green-400"},[Ce.Command]:{prefix:"CMD",color:"border-yellow-500"},[Ce.Tokens]:{prefix:"TKN",color:"border-gray-400"},[Ce.Custom]:{prefix:"CUS",color:"border-purple-400"},[Ce.Neutral]:{prefix:"NEU",color:"border-gray-400"},[Ce.Random]:{prefix:"RND",color:"border-gray-400"}},Ii={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},Co={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},Ei={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},mt=["blue","purple","red","green","yellow","orange","pink","brown"],Ti=["Setup","Main","Commit","Scoring"],Rt=()=>Object.fromEntries(Object.entries(it).map(([e,t])=>[e,t.imageUrl])),gi=new Proxy({},{get(e,t){return Rt()[t]},ownKeys(){return Object.keys(Rt())},has(e,t){return t in Rt()},getOwnPropertyDescriptor(e,t){const r=Rt()[t];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),Pt=()=>Object.fromEntries(Object.entries(it).map(([e,t])=>[e,t.description])),wi=new Proxy({},{get(e,t){return Pt()[t]},ownKeys(){return Object.keys(Pt())},has(e,t){return t in Pt()},getOwnPropertyDescriptor(e,t){const r=Pt()[t];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),Do=()=>Object.entries(it).filter(([e,t])=>e!=="Resurrected"&&(!t.allowedPanels||t.allowedPanels.includes("COUNTER_PANEL"))).sort(([,e],[,t])=>e.sortOrder-t.sortOrder).map(([e,t])=>({type:e,label:t.name}));Do();const je="readyDeploy",He="readySetup",$e="readyCommit",De=(e,t,r)=>e.statuses?e.statuses.some(a=>a.type===t&&(r===void 0||a.addedByPlayerId===r)):!1,Ge=(e,t)=>e.statuses?e.statuses.some(r=>r.type===t):!1,Ro=(e,t,r)=>r===1&&Ge(e,He),Po=(e,t,r,a,n)=>!!(r&&Ge(e,je)||t===1&&a&&Ge(e,He)||t===3&&n&&Ge(e,$e)),$t=e=>{e.statuses&&(e.statuses=e.statuses.filter(t=>t.type!==je&&t.type!==He&&t.type!==$e))},ft=(e,t,r,a)=>Math.abs(e-r)+Math.abs(t-a)===1,Pa=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>De(n,"Aim",r)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,t,r,a)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,t,r,a)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>{var i;return n.ownerId!==r&&((i=n.statuses)==null?void 0:i.some(o=>o.type==="Threat"))}},sourceCard:e,sourceCoords:a})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.ownerId!==r&&De(n,"Exploit",r)}})},{baseId:"centurion",activationType:"commit",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(n,i,o)=>{var s;return n.ownerId===r&&((s=n.types)==null?void 0:s.includes("Unit"))&&i!==void 0&&o!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:a,payload:{filter:(n,i,o)=>ft(i,o,a.row,a.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.id===e.id?!1:n.ownerId===r}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:a,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>De(n,"Aim",r)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:a,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,originalOwnerId:r,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:n=>n.ownerId===r}})},{baseId:"censor",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:a,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>De(n,"Aim",r)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,t,r,a)=>De(e,"Support",r)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:a,payload:{filter:(n,i)=>ft(n,i,a.row,a.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:(n,i,o)=>ft(i,o,a.row,a.col)&&n.ownerId!==r&&(De(n,"Threat",r)||De(n,"Stun",r))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,t,r,a)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>n.ownerId===r&&De(n,"Support",r)},sourceCard:e,sourceCoords:a})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.ownerId===r&&De(n,"Exploit",r)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:a,payload:{filter:n=>De(n,"Exploit",r)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"MODIFY_POWER",amount:-1,filter:n=>De(n,"Aim",r)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:a,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"REVEAL_ENEMY_CHAINED",filter:(n,i,o)=>{const s=ft(i,o,a.row,a.col),d=n.ownerId!==r;return s&&d},targetOwnerId:void 0},skipChainedActionOnNoTargets:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:1}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>De(n,"Aim",r)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:(n,i,o)=>ft(i,o,a.row,a.col)&&n.ownerId!==r&&(De(n,"Threat",r)||De(n,"Stun",r))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,t,r,a)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"edithByron",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:a,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:(n,i,o)=>ft(i,o,a.row,a.col)&&(De(n,"Threat",r)||De(n,"Stun",r)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>De(n,"Aim",r)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:a,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:a,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,t,r,a)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:a,ownerId:r})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"LUCIUS_SETUP",filter:n=>n.ownerId===r}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.ownerId===r,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,t,r,a)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:a})}],tr=e=>{const t=e.baseId||"";return Pa.filter(r=>{var a;return r.baseId===t||((a=r.baseIdAlt)==null?void 0:a.includes(t))})},ko=e=>{const r=tr(e).map(a=>a.activationType);return[...new Set(r)]},ka=(e,t,r,a)=>{var o;if(r!==e.ownerId)return!1;if(a&&e.ownerId!==void 0){const s=a.players.find(d=>d.id===e.ownerId);if(s!=null&&s.isDummy&&a.activePlayerId!==e.ownerId)return!1}if((o=e.statuses)!=null&&o.some(s=>s.type==="Stun"))return!1;const n=tr(e),i=t===1&&n.some(s=>s.activationType==="setup")||t===3&&n.some(s=>s.activationType==="commit");if(t===1){const s=n.find(d=>d.activationType==="setup");if(s&&Ge(e,He))return!(s.supportRequired&&!De(e,"Support",r))}if(t===3){const s=n.find(d=>d.activationType==="commit");if(s&&Ge(e,$e))return!(s.supportRequired&&!De(e,"Support",r))}if(!i){const s=n.find(d=>d.activationType==="deploy");if(s&&Ge(e,je))return!(s.supportRequired&&!De(e,"Support",r))}return!1},Oo=(e,t,r,a)=>{if(r!==e.ownerId)if(e.ownerId!==void 0){const d=t.players.find(l=>l.id===e.ownerId);if(!(d!=null&&d.isDummy))return null}else return null;const n=tr(e),i=e.ownerId??r??0,o=t.currentPhase,s=o===1&&n.some(d=>d.activationType==="setup")||o===3&&n.some(d=>d.activationType==="commit");if(o===1){const d=n.find(l=>l.activationType==="setup");if(d&&Ge(e,He)){if(d.supportRequired&&!De(e,"Support",i))return null;const l=d.getAction(e,t,i,a);if(l)return{...l,readyStatusToRemove:He}}}if(o===3){const d=n.find(l=>l.activationType==="commit");if(d&&Ge(e,$e)){if(d.supportRequired&&!De(e,"Support",i))return null;const l=d.getAction(e,t,i,a);if(l)return{...l,readyStatusToRemove:$e}}}if(!s){const d=n.find(l=>l.activationType==="deploy");if(d&&Ge(e,je)){if(d.supportRequired&&!De(e,"Support",i))return null;const l=d.getAction(e,t,i,a);if(l)return{...l,isDeployAbility:!0,readyStatusToRemove:je}}}return null},m={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},vo=(e,t)=>t===1&&Ge(e,He)?He:t===3&&Ge(e,$e)?$e:Ge(e,je)?je:null,_i=(e,t)=>{var o;let r,a;typeof t=="object"?(r=t.currentPhase,a=t):r=t;const n=a==null?void 0:a.activePlayerId;return n===void 0||e.ownerId!==n||(o=e.statuses)!=null&&o.some(s=>s.type==="Stun")||!vo(e,r)?!1:ka(e,r,e.ownerId,a)},Oa=(e,t,r)=>{var s;let a;if(typeof t=="object"?(a=t.currentPhase,r=t.activePlayerId??void 0):a=t,r===void 0||e.ownerId!==r||(s=e.statuses)!=null&&s.some(d=>d.type==="Stun"))return!1;const n=Ge(e,je),i=Ge(e,He),o=Ge(e,$e);return Po(e,a,n,i,o)},rr=(e,t)=>{e.statuses||(e.statuses=[]);const r=ko(e);for(const a of r){let n="";a==="deploy"?n=je:a==="setup"?n=He:a==="commit"&&(n=$e),n&&(e.statuses.some(o=>o.type===n)||e.statuses.push({type:n,addedByPlayerId:t}))}},Zt=(e,t)=>{const r=ma("setup"),a=ma("commit");for(let n=0;n<e.board.length;n++)for(let i=0;i<e.board[n].length;i++){const s=e.board[n][i].card;if(!s||s.ownerId!==t)continue;const d=s.baseId||s.id;if(d){if(m.debug(`[resetReadyStatusesForTurn] Processing card: ${s.name} (baseId: ${d}, ownerId: ${s.ownerId})`),s.statuses||(s.statuses=[]),r.includes(d)){const l=s.statuses.some(E=>E.type===He);s.statuses=s.statuses.filter(E=>E.type!==He),s.statuses.push({type:He,addedByPlayerId:t}),l||m.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_SETUP to ${s.name}`)}else s.statuses=s.statuses.filter(l=>l.type!==He);if(a.includes(d)){const l=s.statuses.some(E=>E.type===$e);s.statuses=s.statuses.filter(E=>E.type!==$e),s.statuses.push({type:$e,addedByPlayerId:t}),l||m.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_COMMIT to ${s.name}`)}else s.statuses=s.statuses.filter(l=>l.type!==$e)}}};function ma(e){const t=[];return Pa.forEach(r=>{r.activationType===e&&(t.push(r.baseId),r.baseIdAlt&&t.push(...r.baseIdAlt))}),[...new Set(t)]}class No{constructor(){this.queue=[],this.loading=new Set,this.loaded=new Set,this.minDelayBetweenLoads=1e3,this.lastLoadTime=0,this.isProcessing=!1}preload(t,r="low"){!t||this.loaded.has(t)||this.loading.has(t)||this.queue.some(n=>n.url===t)||(this.queue.push({url:t,priority:r,timestamp:Date.now()}),this.queue.sort((n,i)=>{const o={high:0,normal:1,low:2},s=o[n.priority]-o[i.priority];return s!==0?s:n.timestamp-i.timestamp}),this.processQueue())}preloadMany(t,r="low"){t.forEach(a=>this.preload(a,r))}isLoaded(t){return this.loaded.has(t)}clearQueue(){this.queue=[]}clear(){this.queue=[],this.loading.clear(),this.loaded.clear()}processQueue(){if(this.isProcessing||this.queue.length===0)return;this.isProcessing=!0;const t=()=>{if(this.queue.length===0){this.isProcessing=!1;return}const a=Date.now()-this.lastLoadTime,n=Math.max(0,this.minDelayBetweenLoads-a);setTimeout(()=>{const i=this.queue.shift();if(!i){this.isProcessing=!1;return}this.loadImage(i.url).then(()=>{this.lastLoadTime=Date.now(),t()}).catch(()=>{this.lastLoadTime=Date.now(),t()})},n)};t()}loadImage(t){return new Promise((r,a)=>{this.loading.add(t);const n=new Image;n.onload=()=>{this.loading.delete(t),this.loaded.add(t),r()},n.onerror=()=>{this.loading.delete(t),a(new Error(`Failed to load: ${t}`))},n.src=t})}}const Mo=new No;function Lo(e,t){const r=[];for(const a of e)if(a.id!==t){if(a.hand)for(const n of a.hand)n.imageUrl&&!r.includes(n.imageUrl)&&r.push(n.imageUrl);if(a.deck)for(const n of a.deck)n.imageUrl&&!r.includes(n.imageUrl)&&r.push(n.imageUrl);if(a.discard)for(const n of a.discard)n.imageUrl&&!r.includes(n.imageUrl)&&r.push(n.imageUrl)}return r}function me(e){const t=e,r=t==null?void 0:t.targetingMode;r&&delete t.targetingMode;let a;return typeof structuredClone<"u"?a=structuredClone(e):a=JSON.parse(JSON.stringify(e)),r&&(a.targetingMode=r,t.targetingMode=r),a}const re={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function bi(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function Ai(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}function Si(e,t){return e?Co[e]:t}function Oe(){return localStorage.getItem("webrtc_enabled")==="true"}const va=H.createContext(null),Ci=({children:e})=>{const[t,r]=H.useState(null),[a,n]=H.useState({}),[i,o]=H.useState("lg"),s=H.useCallback((y,P={},T="lg")=>{r(y),n(P),o(T)},[]),d=H.useCallback(()=>{r(null),n({}),o("lg")},[]),l=H.useCallback(y=>t===y,[t]),E=H.useCallback(()=>a,[a]),g=H.useCallback(()=>i,[i]),A={openModal:t,modalData:a,modalSize:i,open:s,close:d,isOpen:l,getData:E,getSize:g};return yo.jsx(va.Provider,{value:A,children:e})},Mt=()=>{const e=H.useContext(va);if(!e)throw new Error("useModals must be used within ModalsProvider");return e},Di=()=>{const{open:e,close:t,isOpen:r}=Mt();return{isOpen:r("rules"),open:a=>e("rules",a,"full"),close:t}},Ri=()=>{const{open:e,close:t,isOpen:r}=Mt();return{isOpen:r("settings"),open:a=>e("settings",a,"md"),close:t}},Pi=()=>{const{open:e,close:t,isOpen:r,getData:a}=Mt();return{isOpen:r("joinGame"),open:n=>e("joinGame",n,"lg"),close:t,getData:()=>a()}},ki=()=>{const{open:e,close:t,isOpen:r}=Mt();return{isOpen:r("deckBuilder"),open:a=>e("deckBuilder",a,"full"),close:t}},wt="webrtc_game_state",_t="webrtc_host_data",bt="webrtc_guest_data",Go="webrtc_current_host_peerId",xo=30*60*1e3;function ar(){return Date.now()}function St(e){return Date.now()-e<xo}function Uo(e){try{const t={...e,timestamp:ar()};localStorage.setItem(_t,JSON.stringify(t)),m.info("[WebRTC Persistence] Saved host data:",{peerId:t.peerId})}catch(t){m.error("[WebRTC Persistence] Failed to save host data:",t)}}function Ft(e){try{const t={...e,timestamp:ar()};localStorage.setItem(bt,JSON.stringify(t)),m.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId})}catch(t){m.error("[WebRTC Persistence] Failed to save guest data:",t)}}function It(e){try{const t={...e,timestamp:ar()};localStorage.setItem(wt,JSON.stringify(t)),m.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(t.timestamp).toISOString())}catch(t){m.error("[WebRTC Persistence] Failed to save game state:",t)}}function Na(){try{const e=localStorage.getItem(_t);if(!e)return null;const t=JSON.parse(e);return St(t.timestamp)?(m.info("[WebRTC Persistence] Loaded valid host data:",{peerId:t.peerId}),t):(m.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(_t),null)}catch(e){return m.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(_t),null}}function Ma(){try{const e=localStorage.getItem(bt);if(!e)return null;const t=JSON.parse(e);return St(t.timestamp)?(m.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId}),t):(m.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(bt),null)}catch(e){return m.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(bt),null}}function Ia(){try{const e=localStorage.getItem(wt);if(!e)return null;const t=JSON.parse(e);return St(t.timestamp)?(m.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(t.timestamp).toISOString()),t):(m.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(wt),null)}catch(e){return m.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(wt),null}}function rt(){localStorage.removeItem(wt),localStorage.removeItem(_t),localStorage.removeItem(bt),localStorage.removeItem(Go)}function Qt(e,t){try{const r=`webrtc_host_${t}`,a={peerId:e,gameId:t,timestamp:Date.now()};localStorage.setItem(r,JSON.stringify(a)),m.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${t}:`,e)}catch(r){m.error("[WebRTC Persistence] Failed to broadcast host peerId:",r)}}function Wt(e){try{const t=`webrtc_host_${e}`,r=localStorage.getItem(t);if(!r)return null;const a=JSON.parse(r);return Date.now()-a.timestamp>15e3?null:{peerId:a.peerId,timestamp:a.timestamp}}catch(t){return m.error("[WebRTC Persistence] Failed to get host peerId:",t),null}}function Ea(e){try{const t=`webrtc_host_${e}`;localStorage.removeItem(t),m.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(t){m.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",t)}}function Ho(){const e=sessionStorage.getItem("invite_host_id"),t=sessionStorage.getItem("invite_auto_join");if(e&&t)return"none";const r=Na();if(r&&St(r.timestamp))return"host";const a=Ma();return a&&St(a.timestamp)?"guest":"none"}const Ta=7,Bt="mrPearlDoF",$o="reverendOfTheChoir",Fo="threatAnalyst";function Wo(e,t){return e!=null&&e.statuses?e.statuses.some(r=>r.type==="Exploit"&&r.addedByPlayerId!==void 0&&t.has(r.addedByPlayerId)):!1}function Bo(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const La=()=>Array(Ta).fill(null).map(()=>Array(Ta).fill(null).map(()=>({card:null}))),Ne=e=>{var T,h,f,S,_;const{board:t,activeGridSize:r,players:a}=e,n=Bo(t),i=n.length,o=Math.floor((i-r)/2),s=new Map;a.forEach(p=>s.set(p.id,p.teamId));for(let p=0;p<i;p++)for(let c=0;c<i;c++){const u=n[p][c].card;u&&(u.statuses&&(u.statuses=u.statuses.filter(w=>w.type!=="Support"&&w.type!=="Threat")),delete u.bonusPower)}for(let p=0;p<i;p++)for(let c=0;c<i;c++){const u=n[p][c].card;if((u==null?void 0:u.ownerId)===void 0||u.isFaceDown)continue;const w=u.ownerId,R=s.get(w),v=[{r:p-1,c},{r:p+1,c},{r:p,c:c-1},{r:p,c:c+1}],D={};let b=!1;for(const G of v){const{r:N,c:M}=G;if(N>=0&&N<i&&M>=0&&M<i){const $=n[N][M].card,F=(T=$==null?void 0:$.statuses)==null?void 0:T.some(q=>q.type==="Stun");if(($==null?void 0:$.ownerId)!==void 0&&!$.isFaceDown&&!F){const q=$.ownerId,Z=s.get(q);w===q||R!==void 0&&R===Z?b=!0:(D[q]||(D[q]=[]),D[q].push({r:N,c:M}))}}}b&&(u.statuses||(u.statuses=[]),u.statuses.some(G=>G.type==="Support")||u.statuses.push({type:"Support",addedByPlayerId:w}));let L=null;for(const G in D){const N=D[G];if(N&&N.length>=2){L=parseInt(G,10);break}}if(L===null&&p>=o&&p<o+r&&c>=o&&c<o+r){const N=p===o||p===o+r-1||c===o||c===o+r-1,M=Object.keys(D).length>0;if(N&&M){const $=Object.keys(D)[0];$&&(L=parseInt($,10))}}L!==null&&(u.statuses||(u.statuses=[]),u.statuses.some(G=>G.type==="Threat")||u.statuses.push({type:"Threat",addedByPlayerId:L}))}const d=new Set;for(let p=0;p<i;p++)for(let c=0;c<i;c++){const u=n[p][c].card,w=(h=u==null?void 0:u.statuses)==null?void 0:h.some(R=>R.type==="Stun");if((u==null?void 0:u.baseId)===Fo&&!u.isFaceDown&&u.ownerId!==void 0&&!w){const R=[{r:p-1,c},{r:p+1,c},{r:p,c:c-1},{r:p,c:c+1}];let v=!1;const D=u.ownerId,b=s.get(D);for(const L of R){const{r:G,c:N}=L;if(G>=0&&G<i&&N>=0&&N<i){const M=n[G][N].card;if((M==null?void 0:M.ownerId)!==void 0&&!M.isFaceDown){const $=M.ownerId,F=s.get($),q=D===$||b!==void 0&&b===F,Z=(f=M==null?void 0:M.statuses)==null?void 0:f.some(X=>X.type==="Stun");if(q&&!Z){v=!0;break}}}}v&&d.add(D)}}for(let p=0;p<i;p++)for(let c=0;c<i;c++){const u=n[p][c].card;if(!u||u.isFaceDown||u.ownerId===void 0)continue;const w=u.ownerId,R=s.get(w),v=[{r:p-1,c},{r:p+1,c},{r:p,c:c-1},{r:p,c:c+1}],D={};for(const L of v){const{r:G,c:N}=L;if(G>=0&&G<i&&N>=0&&N<i){const M=n[G][N].card,$=(S=M==null?void 0:M.statuses)==null?void 0:S.some(F=>F.type==="Stun");if((M==null?void 0:M.ownerId)!==void 0&&!M.isFaceDown&&!$){const F=M.ownerId,q=s.get(F);if(!(w===F||R!==void 0&&R===q)){const X=d.has(F),de=Wo(u,d);X&&de&&(D[F]||(D[F]=0),D[F]++)}}}}if(Object.keys(D).length>0){u.statuses||(u.statuses=[]);const L=Object.keys(D).map(G=>parseInt(G,10));for(const G of L)u.statuses.some(N=>N.type==="Threat"&&N.addedByPlayerId===G)||u.statuses.push({type:"Threat",addedByPlayerId:G})}}const l=[],E=[];for(let p=0;p<i;p++)for(let c=0;c<i;c++){const u=n[p][c].card,w=(_=u==null?void 0:u.statuses)==null?void 0:_.some(R=>R.type==="Stun");u!=null&&u.baseId&&!u.isFaceDown&&u.ownerId!==void 0&&!w&&(u.baseId===$o?l.push({r:p,c,ownerId:u.ownerId,baseId:u.baseId}):u.baseId===Bt&&E.push({r:p,c,ownerId:u.ownerId,baseId:u.baseId}))}const g=new Set,A=new Set;for(const p of l){const{r:c,c:u,ownerId:w}=p,R=`${c}-${w}`;if(!g.has(R)){g.add(R);for(let D=0;D<i;D++){const b=n[c][D].card;b&&b.ownerId===w&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(L=>L.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:w}))}}const v=`${u}-${w}`;if(!A.has(v)){A.add(v);for(let D=0;D<i;D++){const b=n[D][u].card;b&&b.ownerId===w&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(L=>L.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:w}))}}}const y=new Set,P=new Set;for(const p of E){const{r:c,c:u,ownerId:w}=p,R=`${c}-${w}`;if(!y.has(R)){y.add(R);for(let D=0;D<i;D++){const b=n[c][D].card;b&&b.ownerId===w&&!b.isFaceDown&&b.baseId!==Bt&&(b.bonusPower=(b.bonusPower||0)+1)}}const v=`${u}-${w}`;if(!P.has(v)){P.add(v);for(let D=0;D<i;D++){const b=n[D][u].card;b&&b.ownerId===w&&!b.isFaceDown&&b.baseId!==Bt&&(b.bonusPower=(b.bonusPower||0)+1)}}}return n};var dt=(e=>(e[e.CARD_REGISTRY=1]="CARD_REGISTRY",e[e.CARD_STATE=2]="CARD_STATE",e[e.ABILITY_EFFECT=3]="ABILITY_EFFECT",e[e.SESSION_EVENT=4]="SESSION_EVENT",e))(dt||{});function Yo(){const e={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},t=new Set,r=Array.from(Da.values());for(const a of r)if(a.baseId&&!t.has(a.baseId)){t.add(a.baseId);const n=e.cardDefinitions.length;e.baseIdToIndex.set(a.baseId,n),e.indexToBaseId.set(n,a.baseId),e.cardDefinitions.push({baseId:a.baseId,name:a.name,imageUrl:a.imageUrl,power:a.power,ability:a.ability||"",types:a.types||[],faction:a.faction||""})}return e.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],m.info(`[CardRegistry] Built registry with ${e.cardDefinitions.length} cards, ${e.statusTypes.length} status types`),e}function Ga(e,t){let r=0;for(const a of e||[]){const n=t.statusTypes.indexOf(a.type);n>=0&&n<32&&(r|=1<<n)}return r>>>0}function xa(e,t,r){const a=[];for(let n=0;n<32;n++)if(e&1<<n){const i=r.statusTypes[n];i&&a.push({type:i,addedByPlayerId:t})}return a}function Ua(e){let t=0;return e.isFaceDown&&(t|=1),e.enteredThisTurn&&(t|=2),e.revealedTo==="all"&&(t|=4),t}function Yt(e,t){const r=new Uint8Array(13);let a=0;const n=nr(e.id);r[a++]=n>>24&255,r[a++]=n>>16&255,r[a++]=n>>8&255,r[a++]=n&255;const i=e.baseId?t.baseIdToIndex.get(e.baseId)??0:0;r[a++]=i>>8&255,r[a++]=i&255,r[a++]=(e.ownerId??0)&255;const o=Math.round(e.power||0);r[a++]=Math.clamp(o,-128,127)&255,r[a++]=Ua(e);const s=Ga(e.statuses||[],t);return r[a++]=s>>24&255,r[a++]=s>>16&255,r[a++]=s>>8&255,r[a++]=s&255,r}function Ko(e,t,r){const a=new Uint8Array(10);let n=0;const i=nr(e.id);a[n++]=i>>24&255,a[n++]=i>>16&255,a[n++]=i>>8&255,a[n++]=i&255,a[n++]=(e.ownerId??r)&255,a[n++]=Ua(e);const o=Ga(e.statuses||[],t);return a[n++]=o>>24&255,a[n++]=o>>16&255,a[n++]=o>>8&255,a[n++]=o&255,a}function nr(e){let t=0;for(let r=0;r<e.length;r++){const a=e.charCodeAt(r);t=(t<<5)-t+a,t=t&t}return t>>>0}function zo(e,t,r){var T;const a=[],n=Date.now(),i=new Uint8Array(7);i[0]=dt.CARD_STATE,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,a.push(i);const o=[],s=Math.min(e.players.length,255);o.push(new Uint8Array([s]));for(const h of e.players){o.push(new Uint8Array([h.id&255]));const f=mt.indexOf(h.color);o.push(new Uint8Array([f>=0?f:0]));const S=Math.min(h.deck.length,255),_=Math.min(h.hand.length,255),p=Math.min(h.discard.length,255);o.push(new Uint8Array([S,_,p,h.announcedCard?1:0])),o.push(new Uint8Array([Math.min(h.score,255)]));const c=Math.min(h.hand.length,255);o.push(new Uint8Array([c]));const u=h.id===r;for(const R of h.hand)u?o.push(Yt(R,t)):o.push(Ko(R,t,h.id));const w=Math.min(h.discard.length,255);o.push(new Uint8Array([w]));for(const R of h.discard){const v=nr(R.id),D=new Uint8Array(4);D[0]=v>>24&255,D[1]=v>>16&255,D[2]=v>>8&255,D[3]=v&255,o.push(D)}h.announcedCard&&o.push(Yt(h.announcedCard,t))}const d=e.board.length;o.push(new Uint8Array([d,d,d]));const l=[];for(let h=0;h<e.board.length;h++)for(let f=0;f<((T=e.board[h])==null?void 0:T.length);f++){const S=e.board[h][f];S!=null&&S.card&&l.push({row:h,col:f,card:S.card})}const E=l.length,g=new Uint8Array(2);g[0]=E>>8&255,g[1]=E&255,o.push(g);for(const{row:h,col:f,card:S}of l)o.push(new Uint8Array([h,f])),o.push(Yt(S,t));o.push(new Uint8Array([e.currentPhase===void 0?255:Math.clamp(e.currentPhase,0,254),(e.activePlayerId??255)&255,e.currentRound===void 0?255:Math.clamp(e.currentRound,0,254)]));let A=0;for(const h of o)A+=h.length;i[5]=A>>8&255,i[6]=A&255,a.push(...o);const y=new Uint8Array(a.reduce((h,f)=>h+f.length,0));let P=0;for(const h of a)y.set(h,P),P+=h.length;return m.info(`[GameCodec] Encoded card state: ${y.length} bytes (${E} board cards, ${e.players.length} players)`),y}function qo(e,t,r){let a=0;if(e[a++]!==dt.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");e[a++]<<24|e[a++]<<16|e[a++]<<8|e[a++],e[a++]<<8|e[a++];const n=e[a++],i=[];for(let T=0;T<n;T++){const h=e[a++],f=e[a++],S=mt[f]||"blue",_=e[a++];e[a++],e[a++];const p=e[a++]===1,c=e[a++],u=e[a++],w=[],R=h===r;for(let G=0;G<u;G++)if(R)w.push(Kt(e,a,t)),a+=13;else{const N=e[a++]<<24|e[a++]<<16|e[a++]<<8|e[a++],M=e[a++],$=e[a++],F=e[a++]<<24|e[a++]<<16|e[a++]<<8|e[a++];w.push({id:`card_${N}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:M,isFaceDown:($&1)!==0,revealedTo:$&4?"all":void 0,statuses:xa(F,h,t),isPlaceholder:!0})}const v=e[a++],D=[];for(let G=0;G<v;G++){const N=e[a++]<<24|e[a++]<<16|e[a++]<<8|e[a++];D.push({id:`discard_${N}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:h,isPlaceholder:!0})}let b=null;p&&(b=Kt(e,a,t),a+=13);const L=[];for(let G=0;G<_;G++)L.push({id:`deck_${h}_${G}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:h,isPlaceholder:!0});i.push({id:h,name:`Player ${h}`,score:c,hand:w,deck:L,discard:D,announcedCard:b,selectedDeck:"Random",color:S,boardHistory:[]})}const o=e[a++];a++,a++;const s=e[a++]<<8|e[a++],d=[];for(let T=0;T<o;T++){const h=[];for(let f=0;f<o;f++)h.push({card:null});d.push(h)}for(let T=0;T<s;T++){const h=e[a++],f=e[a++],S=Kt(e,a,t);a+=13,h<d.length&&f<d[h].length&&(d[h][f]={card:S})}const l=e[a++],E=e[a++],g=e[a++];return{players:i,board:d,currentPhase:l===255?void 0:l,activePlayerId:E===255?null:E,currentRound:g===255?void 0:g}}function Kt(e,t,r){const n=`card_${e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++]}_${Date.now()}`,i=e[t++]<<8|e[t++],o=e[t++];let s=e[t++];s>127&&(s=s-256);const d=e[t++],l=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++],E=r.cardDefinitions[i],g=(E==null?void 0:E.baseId)||"";return{id:n,baseId:g,deck:"Random",name:(E==null?void 0:E.name)||"?",imageUrl:(E==null?void 0:E.imageUrl)||"",power:s,ability:(E==null?void 0:E.ability)||"",types:(E==null?void 0:E.types)||[],faction:(E==null?void 0:E.faction)||"",ownerId:o,isFaceDown:(d&1)!==0,enteredThisTurn:(d&2)!==0,revealedTo:d&4?"all":void 0,statuses:xa(l,0,r)}}Math.clamp||(Math.clamp=function(e,t,r){return Math.min(Math.max(e,t),r)});let zt=null;function Ha(){return zt||(zt=Yo()),zt}function ga(e,t){const r=Ha();return zo(e,r,t)}function jo(e,t){const r=Ha();return qo(e,r,t)}function Vo(e){return Sa(e)}function $a(e){m.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return ho(e)}catch(t){return m.error("[webrtcSerialization] Failed to serialize delta:",t),new Uint8Array(0)}}function Fa(e){m.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Sa(e)}catch(t){return m.error("[webrtcSerialization] Failed to deserialize delta:",t),{}}}function Jo(e){const t=$a(e);let r="";const a=new Uint8Array(t),n=a.byteLength;for(let i=0;i<n;i++)r+=String.fromCharCode(a[i]);return btoa(r)}function Xo(e){const t=atob(e),r=new Uint8Array(t.length);for(let a=0;a<t.length;a++)r[a]=t.charCodeAt(a);return Fa(r)}function Zo(e,t){var g;const r=new TextEncoder,a=[],n=Date.now(),i=new Uint8Array(7);i[0]=dt.ABILITY_EFFECT,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,a.push(i);const o=[];if(o.push(new Uint8Array([e])),t.sourcePos){const A=(t.sourcePos.row&15)<<4|t.sourcePos.col&15;o.push(new Uint8Array([A]))}else o.push(new Uint8Array([255]));const s=((g=t.targetPositions)==null?void 0:g.length)||0;if(o.push(new Uint8Array([Math.min(s,255)])),t.targetPositions)for(const A of t.targetPositions.slice(0,255)){const y=(A.row&15)<<4|A.col&15;o.push(new Uint8Array([y]))}if(t.text){const A=r.encode(t.text),y=Math.min(A.length,255);o.push(new Uint8Array([y])),o.push(A.slice(0,y))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(t.value??0)&255])),o.push(new Uint8Array([(t.playerId??0)&255]));let d=0;for(const A of o)d+=A.length;i[5]=d>>8&255,i[6]=d&255,a.push(...o);const l=new Uint8Array(a.reduce((A,y)=>A+y.length,0));let E=0;for(const A of a)l.set(A,E),E+=A.length;return m.debug(`[AbilityMessages] Encoded effect type ${e}: ${l.length} bytes`),l}function Qo(e){let t=0;if(e[t++]!==dt.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const r=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const a={effectType:e[t++],timestamp:r,data:{}},n=e[t++];n!==255&&(a.data.sourcePos={row:n>>4&15,col:n&15});const i=e[t++];if(i>0){a.data.targetPositions=[];for(let s=0;s<i;s++){const d=e[t++];a.data.targetPositions.push({row:d>>4&15,col:d&15})}}const o=e[t++];if(o>0){const s=new TextDecoder;a.data.text=s.decode(e.subarray(t,t+o)),t+=o}return a.data.value=e[t++],a.data.playerId=e[t++],a}function es(e,t={}){const r=new TextEncoder,a=[],n=Date.now(),i=new Uint8Array(7);i[0]=dt.SESSION_EVENT,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,a.push(i);const o=[];if(o.push(new Uint8Array([e])),o.push(new Uint8Array([(t.playerId??0)&255])),t.playerName){const g=r.encode(t.playerName),A=Math.min(g.length,255);o.push(new Uint8Array([A])),o.push(g.slice(0,A))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(t.startingPlayerId??0)&255])),o.push(new Uint8Array([Math.min(t.roundNumber??0,255)])),o.push(new Uint8Array([Math.min(t.newPhase??0,255)])),o.push(new Uint8Array([(t.newActivePlayerId??0)&255])),o.push(new Uint8Array([(t.gameWinner??255)&255]));let s=0;if(t.winners)for(const g of t.winners)g<32&&(s|=1<<g);o.push(new Uint8Array([s>>24&255,s>>16&255,s>>8&255,s&255]));let d=0;for(const g of o)d+=g.length;i[5]=d>>8&255,i[6]=d&255,a.push(...o);const l=new Uint8Array(a.reduce((g,A)=>g+A.length,0));let E=0;for(const g of a)l.set(g,E),E+=g.length;return m.debug(`[SessionMessages] Encoded event type ${e}: ${l.length} bytes`),l}function ts(e){let t=0;if(e[t++]!==dt.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const r=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const a={eventType:e[t++],timestamp:r,data:{}};a.data.playerId=e[t++];const n=e[t++];if(n>0){const s=new TextDecoder;a.data.playerName=s.decode(e.subarray(t,t+n)),t+=n}a.data.startingPlayerId=e[t++],a.data.roundNumber=e[t++],a.data.newPhase=e[t++],a.data.newActivePlayerId=e[t++];const i=e[t++];a.data.gameWinner=i===255?null:i;const o=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];if(o!==0){a.data.winners=[];for(let s=0;s<32;s++)o&1<<s&&a.data.winners.push(s)}return a}const rs=!0;class Ke{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,this.guestPlayerIds=new Map,localStorage.getItem("webrtc_enabled")}async initializeAsHost(t){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((r,a)=>{this.peer=t?new Dt(t):new Dt,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),r(n)}),this.peer.on("connection",n=>{m.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{m.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),a(n)}),this.peer.on("close",()=>{m.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(t){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((r,a)=>{this.peer=new Dt,this.peer.on("open",n=>{const i=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(i),i.on("open",()=>{this.hostConnection=i,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}});let o=null;try{const s=localStorage.getItem("webrtc_preferred_deck");s&&(o=s,m.info(`[initializeAsGuest] Found deck preference in localStorage: ${o}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(s){m.warn("[initializeAsGuest] Failed to read deck preference:",s)}this.sendMessageToHost({type:"JOIN_REQUEST",senderId:n,data:{preferredDeck:o||void 0},timestamp:Date.now()}),r()}),i.on("error",o=>{m.error("Host connection error:",o),this.emitEvent({type:"error",data:o}),a(o)})}),this.peer.on("error",n=>{m.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),a(n)})})}async initializeAsReconnectingGuest(t,r){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((a,n)=>{this.peer=new Dt,this.peer.on("open",i=>{const o=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(o),o.on("open",()=>{this.hostConnection=o,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:i,playerId:r,timestamp:Date.now()}),this.isReconnecting=!1,a()}),o.on("error",s=>{m.error("Host connection error:",s),this.emitEvent({type:"error",data:s}),this.isReconnecting=!1,n(s)})}),this.peer.on("error",i=>{m.error("WebRTC Peer error:",i),this.emitEvent({type:"error",data:i}),this.isReconnecting=!1,n(i)})})}handleGuestConnection(t){this.connections.set(t.peer,t),t.on("open",()=>{m.info(`Guest connected: ${t.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:t.peer}})}),t.on("data",r=>{this.handleMessage(r,t)}),t.on("close",()=>{m.info(`Guest disconnected: ${t.peer}`),this.connections.delete(t.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:t.peer}})}),t.on("error",r=>{m.error(`Guest connection error (${t.peer}):`,r)})}setupHostConnection(t){this.hostConnection=t,t.on("data",r=>{this.handleMessage(r,t)}),t.on("close",()=>{m.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),t.on("error",r=>{m.error("Host connection error:",r)})}handleMessage(t,r){m.debug("Received WebRTC message:",t.type),this.emitEvent({type:"message_received",data:t})}sendMessageToHost(t){var r,a,n,i;if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(t),(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&m.info(`[WebrtcManager] Sent ${t.type} to host`,{hasData:!!t.data,hasTargetingMode:!!((r=t.data)!=null&&r.targetingMode),targetingModePlayerId:(n=(a=t.data)==null?void 0:a.targetingMode)==null?void 0:n.playerId}),!0}catch(o){return m.error("Failed to send message to host:",o),!1}return(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&m.warn(`[WebrtcManager] Could not send ${t.type} to host`,{isHost:this.isHost,hasHostConnection:!!this.hostConnection,isConnectionOpen:((i=this.hostConnection)==null?void 0:i.open)??!1}),!1}broadcastToGuests(t,r){if(!this.isHost)return m.warn("Only host can broadcast to guests"),0;let a=0;return this.connections.forEach((n,i)=>{if(n.open&&i!==r)try{n.send(t),a++}catch(o){m.error(`Failed to send to guest ${i}:`,o)}}),m.debug(`Broadcast to ${a}/${this.connections.size} guests`),a}sendToGuest(t,r){if(!this.isHost)return m.warn("Only host can send to specific guest"),!1;const a=this.connections.get(t);if(!a)return m.error(`[sendToGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!a.open)return m.error(`[sendToGuest] Connection for guest ${t} is not open`),!1;try{return a.send(r),m.debug(`Sent message to guest ${t}`),!0}catch(n){return m.error(`[sendToGuest] Failed to send message to ${t}:`,n),!1}}acceptGuest(t,r,a){var i;const n=this.connections.get(t);if(!n){m.error(`[acceptGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){m.error(`[acceptGuest] Connection for guest ${t} is not open`);return}try{if(rs){const o=ga(r,null),s={type:"JOIN_ACCEPT_BINARY",senderId:(i=this.peer)==null?void 0:i.id,playerId:a,data:o,timestamp:Date.now()};n.send(s),m.info(`Accepted guest ${t} as player ${a} (BINARY, ${o.byteLength} bytes)`)}}catch(o){m.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${t}:`,o)}}acceptGuestMinimal(t,r,a){var o;const n=this.connections.get(t);if(!n){m.error(`[acceptGuestMinimal] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){m.error(`[acceptGuestMinimal] Connection for guest ${t} is not open`);return}this.guestPlayerIds.set(t,a);const i={type:"JOIN_ACCEPT_MINIMAL",senderId:(o=this.peer)==null?void 0:o.id,playerId:a,data:r,timestamp:Date.now()};try{n.send(i),m.info(`Accepted guest ${t} as player ${a} (minimal)`)}catch(s){m.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${t}:`,s)}}broadcastGameState(t,r){this.broadcastGameStateLegacy(t,r)}broadcastGameStateLegacy(t,r){let a=0;this.connections.forEach((n,i)=>{var l;if(!n.open||i===r)return;const o=this.guestPlayerIds.get(i)??null,s=Ke.createPersonalizedGameState(t,o),d={type:"STATE_UPDATE_COMPACT",senderId:(l=this.peer)==null?void 0:l.id,data:{gameState:s,recipientPlayerId:o},timestamp:Date.now()};try{n.send(d),a++}catch(E){m.error(`[broadcastGameStateLegacy] Failed to send to guest ${i} (player ${o}):`,E)}}),m.debug(`[broadcastGameStateLegacy] Sent to ${a}/${this.connections.size} guests`)}static createPersonalizedGameState(t,r){return{...t,players:t.players.map(a=>{if(r!==null&&a.id===r){const i=a.deck.length??0,o=a.discard.length??0,s=a.hand.length??0;return m.debug(`[createPersonalizedGameState] Player ${a.id} (own): ${s} hand, ${i} deck, ${o} discard`),{...a,handCards:a.hand.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),deckCards:a.deck.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),discardCards:a.discard.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),hand:[],deck:[],discard:[],announcedCard:a.announcedCard?Ke.optimizeCard(a.announcedCard):null,deckSize:i,discardSize:o,handSize:s}}else{const i=a.deckSize??a.deck.length??0,o=a.hand.filter(s=>!s.isFaceDown).length;return o>0&&m.debug(`[createPersonalizedGameState] Player ${a.id} (other): ${o} revealed, ${a.hand.length-o} face-down`),{...a,hand:a.hand.map(s=>s.isFaceDown?Ke.createCardBack(s):{id:s.id,baseId:s.baseId,power:s.power,powerModifier:s.powerModifier||0,isFaceDown:s.isFaceDown,statuses:s.statuses||[],ownerId:s.ownerId,ownerName:s.ownerName,deck:s.deck}),deck:[],discard:[],announcedCard:a.announcedCard?Ke.createCardBack(a.announcedCard):null,deckSize:i,handSize:a.handSize??a.hand.length??0,discardSize:a.discardSize??a.discard.length??0}}}),board:t.board.map(a=>a.map(n=>({...n,card:n.card?Ke.optimizeCard(n.card):null})))}}static createCompactStateForHost(t,r){return{...t,players:t.players.map(a=>{if(a.id===r)return m.debug(`[createCompactStateForHost] Player ${a.id} (local): sending ${a.hand.length} hand cards, ${a.deck.length} deck cards`),{...a,handCards:a.hand.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),deckCards:a.deck.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),discardCards:a.discard.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),hand:[],deck:[],discard:[],handSize:a.hand.length,deckSize:a.deck.length,discardSize:a.discard.length};{const i=a.hand.filter(s=>s.statuses&&s.statuses.length>0).length>0,o={...a,...i&&{handCards:a.hand.map(s=>({id:s.id,baseId:s.baseId,power:s.power,powerModifier:s.powerModifier||0,isFaceDown:s.isFaceDown,statuses:s.statuses||[]}))},hand:[],deck:[],discard:[],announcedCard:null,deckSize:a.deckSize??a.deck.length??0,handSize:a.handSize??a.hand.length??0,discardSize:a.discardSize??a.discard.length??0};return a.id===r?m.info(`[createCompactStateForHost] Local player ${a.id} score: ${a.score}`):m.info(`[createCompactStateForHost] Other player ${a.id} score: ${o.score} (from original)`),o}}),board:t.board.map(a=>a.map(n=>({...n,card:n.card?Ke.optimizeCard(n.card):null})))}}static optimizeCard(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier,ability:t.ability,ownerId:t.ownerId,color:t.color,deck:t.deck,isFaceDown:t.isFaceDown,types:t.types,faction:t.faction,statuses:t.statuses||[],hasRevealToken:t.hasRevealToken||!1,imageUrl:t.imageUrl}}static createCardBack(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,hasRevealToken:t.hasRevealToken||!1,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck}}broadcastStateDelta(t,r){var a,n;{const i=Jo(t),o={type:"STATE_DELTA_BINARY",senderId:(a=this.peer)==null?void 0:a.id,data:i,timestamp:Date.now()};m.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${i.length} chars, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, boardCells=${((n=t.boardCells)==null?void 0:n.length)||0}`),this.broadcastToGuests(o,r),m.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${t.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(t,r,a){var n;try{const i=ga(t,r),o=btoa(String.fromCharCode(...i)),s={type:"CARD_STATE",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,a);return m.info(`[broadcastCardState] Sent ${i.length} bytes to ${d} guests`),d}catch(i){return m.error("[broadcastCardState] Failed to encode/broadcast state:",i),0}}broadcastAbilityEffect(t,r,a){var n;try{const i=Zo(t,r),o=btoa(String.fromCharCode(...i)),s={type:"ABILITY_EFFECT",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,a);return m.debug(`[broadcastAbilityEffect] Sent effect ${t} to ${d} guests`),d}catch(i){return m.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",i),0}}broadcastSessionEvent(t,r,a){var n;try{const i=es(t,r),o=btoa(String.fromCharCode(...i)),s={type:"SESSION_EVENT",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,a);return m.debug(`[broadcastSessionEvent] Sent event ${t} to ${d} guests`),d}catch(i){return m.error("[broadcastSessionEvent] Failed to encode/broadcast event:",i),0}}sendAction(t,r){var n;const a={type:"ACTION",senderId:(n=this.peer)==null?void 0:n.id,data:{actionType:t,actionData:r},timestamp:Date.now()};return this.sendMessageToHost(a)}sendStateDelta(t){var r;{const a=$a(t),n={type:"STATE_DELTA_BINARY",senderId:(r=this.peer)==null?void 0:r.id,data:a,timestamp:Date.now()};return this.sendMessageToHost(n)}}sendStateToHost(t,r){var o,s,d;if(r===null)return m.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const a=Ke.createCompactStateForHost(t,r),n=t.players.find(l=>l.id===r);n&&m.info(`[sendStateToHost] Player ${r} sending compact state: hand=${((o=n.hand)==null?void 0:o.length)??0}, deck=${((s=n.deck)==null?void 0:s.length)??0}, score=${n.score}`);const i={type:"STATE_UPDATE_COMPACT",senderId:(d=this.peer)==null?void 0:d.id,playerId:r,data:{gameState:a},timestamp:Date.now()};return this.sendMessageToHost(i)}sendFullDeckToHost(t,r,a){var i;const n={type:"DECK_DATA_UPDATE",senderId:(i=this.peer)==null?void 0:i.id,playerId:t,data:{playerId:t,deck:r.map(o=>Ke.optimizeCard(o)),deckSize:a},timestamp:Date.now()};return this.sendMessageToHost(n)}sendCustomDeckData(t,r,a){var o;if(!a)return!0;m.info(`[sendCustomDeckData] Player ${t} sending ${r.length} custom deck cards to host`);const n=r.map(s=>({id:s.id,baseId:s.baseId,name:s.name,power:s.power,powerModifier:s.powerModifier,ability:s.ability,types:s.types,faction:s.faction,imageUrl:s.imageUrl,color:s.color,deck:s.deck})),i={type:"CUSTOM_DECK_DATA",senderId:(o=this.peer)==null?void 0:o.id,playerId:t,data:{playerId:t,deckCards:n},timestamp:Date.now()};return this.sendMessageToHost(i)}getConnectionInfo(){const t=[];return this.isHost?this.connections.forEach((r,a)=>{t.push({peerId:a,playerId:null,playerName:null,connected:r.open})}):this.hostConnection&&t.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),t}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getHostPeerId(){var t,r;return this.isHost?((t=this.peer)==null?void 0:t.id)||null:((r=this.hostConnection)==null?void 0:r.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var t;return this.isHost?this.connections.size:(t=this.hostConnection)!=null&&t.open?1:0}on(t){return this.eventHandlers.add(t),()=>this.eventHandlers.delete(t)}emitEvent(t){this.eventHandlers.forEach(r=>{try{r(t)}catch(a){m.error("Error in WebRTC event handler:",a)}})}cleanup(){this.connections.forEach(t=>t.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let qt=null;const as=()=>(qt||(qt=new Ke),qt);function ns(e){return 10+e*10}function or(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const t=e.currentPhase===1,r=e.activePlayerId===e.startingPlayerId;if(!t||!r)return{shouldEnd:!1,roundWinners:[]};const a=e.currentRound||1,n=ns(a),i=[];for(const s of e.players)!s.isDummy&&!s.isDisconnected&&s.score>=n&&i.push(s.id);return{shouldEnd:i.length>0,roundWinners:i}}function Wa(e){const{shouldEnd:t,roundWinners:r}=or(e);if(!t)return e;const a=e.currentRound||1,n={...e.roundWinners,[a]:r},i=new Map;for(const[,s]of Object.entries(n))for(const d of s){const l=i.get(d)||0;i.set(d,l+1)}let o=null;for(const[s,d]of i.entries())if(d>=2){o=s;break}return m.info(`[endRound] Round ${a} ended. Winners: [${r.join(", ")}], Game winner: ${o||"none"}`),{...e,roundWinners:n,gameWinner:o,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function sr(e,t){if(e.currentPhase!==0)return m.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const r=e.players.find(i=>i.id===t);if(!r)return m.error(`[performPreparationPhase] Active player ${t} not found!`),e;m.info(`[performPreparationPhase] Player ${t} has deck size: ${r.deck.length}, hand size: ${r.hand.length}`);const a=e.players.map(i=>{if(i.id===t&&i.deck.length>0){const o=i.deck[0],s=[...i.deck.slice(1)],d=[...i.hand,o];return m.info(`[performPreparationPhase] Player ${t} drew card ${(o==null?void 0:o.id)||"unknown"}, deck now: ${s.length}, hand: ${d.length}`),{...i,deck:s,hand:d,readySetup:!1,readyCommit:!1}}return i});let n={...e,players:a,currentPhase:1};return Zt(n,t),or(n).shouldEnd?Wa(n):(m.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${n.activePlayerId}`),n)}function Ba(e,t){const r=e.activePlayerId;if(r===t){const s={...e,activePlayerId:null};return t===e.startingPlayerId&&e.currentPhase===1&&or(s).shouldEnd?Wa(s):s}if(!e.players.filter(s=>!s.isDisconnected).find(s=>s.id===t))return m.warn(`[toggleActivePlayer] Player ${t} not found or disconnected`),e;let i=e.turnNumber||1;t===e.startingPlayerId&&r!==null&&i++;const o={...e,activePlayerId:t,turnNumber:i,currentPhase:0};return sr(o,t)}function os(e,t){const r=e.players.filter(i=>!i.isDisconnected).sort((i,o)=>i.id-o.id);if(r.length===0)return null;if(t===null)return r[0].id;const a=r.findIndex(i=>i.id===t);if(a===-1)return r[0].id;const n=(a+1)%r.length;return r[n].id}function ss(e,t){var r;for(const a of e.board)for(const n of a)if(((r=n.card)==null?void 0:r.ownerId)===t)return!0;return!1}function ht(e){const t=os(e,e.activePlayerId);if(t===null)return m.warn("[passTurnToNextPlayer] No next player found"),e;m.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${t}`);let r={...e,board:e.board.map(a=>a.map(n=>{var i;return((i=n.card)==null?void 0:i.ownerId)===e.activePlayerId&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(o=>o.type!=="Stun")}}:n}))};return r={...r,board:r.board.map(a=>a.map(n=>n.card&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(i=>i.type!=="enteredThisTurn")}}:n))},r={...r,activePlayerId:t,currentPhase:0,isScoringStep:!1,targetingMode:null},sr(r,t)}function jt(e,t,r){return m.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),e}function is(e,t){return{type:"RECONNECT_SNAPSHOT",data:e}}function ds(e,t,r){var a,n,i,o;try{const s=jo(e,r);m.info(`[WebRTCCodec] Received card state: ${(a=s.board)==null?void 0:a.length}x${((i=(n=s.board)==null?void 0:n[0])==null?void 0:i.length)||0}, ${((o=s.players)==null?void 0:o.length)||0} players`);const d={...t};return s.players&&(d.players=s.players.map(l=>{const E=t.players.find(g=>g.id===l.id);if(E){const g=l.id===r;return{...E,...l,hand:g?E.hand:l.hand,color:E.color}}return l})),s.board&&(d.board=s.board),s.currentPhase!==void 0&&(d.currentPhase=s.currentPhase),s.activePlayerId!==void 0&&(d.activePlayerId=s.activePlayerId),s.currentRound!==void 0&&(d.currentRound=s.currentRound),d}catch(s){return m.error("[WebRTCCodec] Failed to deserialize card state:",s),t}}function cs(e,t){try{const{effectType:r,timestamp:a,data:n}=Qo(e);m.debug(`[WebRTCCodec] Received ability effect: ${r}`);let i=t;switch(r){case 1:return{gameState:i,effectData:{type:"highlight",...n,timestamp:a}};case 2:return{gameState:i,effectData:{type:"floatingText",...n,timestamp:a}};case 3:return{gameState:i,effectData:{type:"noTarget",...n}};case 8:return{gameState:i,effectData:{type:"targetingMode",...n}};case 9:return{gameState:i,effectData:{type:"clearTargeting"}};default:return m.warn(`[WebRTCCodec] Unknown ability effect type: ${r}`),{gameState:i,effectData:null}}}catch(r){return m.error("[WebRTCCodec] Failed to handle ability effect:",r),{gameState:t,effectData:null}}}function ls(e,t){var r;try{const{eventType:a,data:n}=ts(e);m.info(`[WebRTCCodec] Received session event: ${a}`);const i={...t};switch(a){case 1:m.info(`[WebRTCCodec] Player connected: ${n.playerName} (ID: ${n.playerId})`);break;case 2:m.info(`[WebRTCCodec] Player disconnected: ID: ${n.playerId}`),i.players=i.players.map(o=>o.id===n.playerId?{...o,isDisconnected:!0}:o);break;case 3:m.info(`[WebRTCCodec] Game starting, first player: ${n.startingPlayerId}`),i.isGameStarted=!0,n.startingPlayerId!==void 0&&(i.activePlayerId=n.startingPlayerId,i.startingPlayerId=n.startingPlayerId);break;case 4:m.info(`[WebRTCCodec] Round ${n.roundNumber} starting`),i.currentRound=n.roundNumber??1;break;case 5:if(m.info(`[WebRTCCodec] Round ${n.roundNumber} ended, winners: ${(r=n.winners)==null?void 0:r.join(", ")}`),i.isRoundEndModalOpen=!0,n.winners&&n.roundNumber!==void 0){const o=i.roundWinners||{};o[n.roundNumber]=n.winners,i.roundWinners=o}break;case 6:m.info(`[WebRTCCodec] Phase change: ${n.newPhase}`),n.newPhase!==void 0&&(i.currentPhase=n.newPhase),n.newActivePlayerId!==void 0&&(i.activePlayerId=n.newActivePlayerId);break;case 7:m.info(`[WebRTCCodec] Turn change: player ${n.newActivePlayerId}`),n.newActivePlayerId!==void 0&&(i.activePlayerId=n.newActivePlayerId);break;case 8:m.info(`[WebRTCCodec] Game ended, winner: ${n.gameWinner}`),n.gameWinner!==void 0&&(i.gameWinner=n.gameWinner===255?null:n.gameWinner);break;default:m.warn(`[WebRTCCodec] Unknown session event type: ${a}`)}return i}catch(a){return m.error("[WebRTCCodec] Failed to handle session event:",a),t}}function pt(e,t,r,a){return e===2?{gameState:ds(t,r,a)}:e===3?cs(t,r):e===4?{gameState:ls(t,r)}:(m.warn(`[WebRTCCodec] Unknown codec message type: ${e}`),{gameState:r})}const vt="avalon_game_state",nt="reconnection_data";function Ya(e,t){var a;e.forEach(n=>n.forEach(i=>{var o;(o=i.card)!=null&&o.statuses&&(i.card.statuses=i.card.statuses.filter(s=>!(s.type==="LastPlayed"&&s.addedByPlayerId===t.id)))})),t.boardHistory||(t.boardHistory=[]);let r=!1;for(;t.boardHistory.length>0&&!r;){const n=t.boardHistory[t.boardHistory.length-1];for(let i=0;i<e.length;i++){for(let o=0;o<e[i].length;o++)if(((a=e[i][o].card)==null?void 0:a.id)===n){const s=e[i][o].card;if(!s||s.ownerId!==t.id)continue;s.statuses||(s.statuses=[]),s.statuses.push({type:"LastPlayed",addedByPlayerId:t.id}),r=!0;break}if(r)break}r||t.boardHistory.pop()}}function Et(e){var a;if(!e||!Fe)return e;const{cardDatabase:t,tokenDatabase:r}=Fe;if(e.deck===Ce.Tokens||(a=e.id)!=null&&a.startsWith("TKN_")){if(e.baseId&&r[e.baseId]){const i=r[e.baseId];return{...e,imageUrl:i.imageUrl,fallbackImage:i.fallbackImage}}const n=Object.keys(r).find(i=>r[i].name===e.name);if(n){const i=r[n];return{...e,imageUrl:i.imageUrl,fallbackImage:i.fallbackImage,baseId:n}}}else if(e.baseId&&t[e.baseId]){const n=t[e.baseId];return{...e,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage}}return e}function Ct(e){var a,n;if(!Fe)return e;const t=((a=e.board)==null?void 0:a.map(i=>i.map(o=>({...o,card:o.card?Et(o.card):null}))))||e.board,r=((n=e.players)==null?void 0:n.map(i=>{var o,s,d;return{...i,hand:((o=i.hand)==null?void 0:o.map(Et))||[],deck:((s=i.deck)==null?void 0:s.map(Et))||[],discard:((d=i.discard)==null?void 0:d.map(Et))||[],announcedCard:i.announcedCard?Et(i.announcedCard):null}}))||e.players;return{...e,board:t,players:r,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}}function wa(e,t,r){try{const a=Ct(e),n={gameState:a,localPlayerId:t,playerToken:r,timestamp:Date.now()};localStorage.setItem(vt,JSON.stringify(n)),a.gameId&&t!==null&&localStorage.setItem(nt,JSON.stringify({gameId:a.gameId,playerId:t,playerToken:r||null,timestamp:Date.now()}))}catch(a){console.warn("Failed to save game state:",a)}}function us(){try{const e=localStorage.getItem(vt);if(!e)return null;const t=JSON.parse(e),r=24*60*60*1e3;if(Date.now()-t.timestamp>r)return localStorage.removeItem(vt),localStorage.removeItem(nt),null;const a=t.gameState;return{gameState:Ct(a),localPlayerId:t.localPlayerId,playerToken:t.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}}function yt(){localStorage.removeItem(vt),localStorage.removeItem(nt)}function ir(e){const t=[...e];for(let r=t.length-1;r>0;r--){const a=Math.floor(Math.random()*(r+1));[t[r],t[a]]=[t[a],t[r]]}return t}function Ka(){return Math.random().toString(36).substring(2,18).toUpperCase()}function Ze(e,t,r){const a=Ra();let n=e;if(e==="Random"||!a[e]){const s=Object.keys(a);if(s.length===0)return m.error("[createDeck] No decks loaded yet!"),[];n=s[0],e==="Random"||m.warn(`[createDeck] Deck ${e} not found, using ${n} instead`)}const i=a[n];if(!i)return m.error(`Deck data for ${n} not loaded! Returning empty deck. Available decks:`,Object.keys(a)),[];if(n==="Optimates"){const s={};i.forEach(d=>{const l=d.baseId||d.id;s[l]=(s[l]||0)+1})}const o=[...i].map(s=>({...s,ownerId:t,ownerName:r}));return ir(o)}function za(e,t=!1){const r=Ra(),a=Object.keys(r);if(a.length===0)return m.error("[createNewPlayer] No decks loaded yet!"),{id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:mt[e-1]||"blue",isDummy:t,isReady:t,boardHistory:[],autoDrawEnabled:!0};const n=a[0],i={id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:n,color:mt[e-1]||"blue",isDummy:t,isReady:t,boardHistory:[],autoDrawEnabled:!0};return i.deck=Ze(n,e,i.name),i}function at(){return{players:[],spectators:[],board:La(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:er.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}const _a=-1,fs=-2,Tt=1,kt=2,st=(e,t,r,a)=>{var s,d,l,E,g;const{card:n,ownerId:i,location:o}=e;if(t.targetOwnerId!==void 0&&t.targetOwnerId!==_a&&t.targetOwnerId!==fs&&t.targetOwnerId!==i||t.excludeOwnerId!==void 0&&t.excludeOwnerId===i)return!1;if(t.onlyOpponents||t.targetOwnerId===_a){if(i===r)return!1;const A=a.find(P=>P.id===r),y=a.find(P=>P.id===i);if(A&&y&&A.teamId!==void 0&&A.teamId===y.teamId)return!1}if(t.targetType&&!((s=n.types)!=null&&s.includes(t.targetType))||t.onlyFaceDown&&((d=n.statuses)!=null&&d.some(A=>A.type==="Revealed"&&A.addedByPlayerId===r)||o==="board"&&!n.isFaceDown)||t.tokenType==="Revealed"&&(l=n.statuses)!=null&&l.some(A=>A.type==="Revealed"&&A.addedByPlayerId===r)||t.requiredTargetStatus&&(!((E=n.statuses)!=null&&E.some(A=>A.type===t.requiredTargetStatus))||t.requireStatusFromSourceOwner&&r!==null&&!((g=n.statuses)==null?void 0:g.some(y=>y.type===t.requiredTargetStatus&&y.addedByPlayerId===r))))return!1;if(t.mustBeAdjacentToSource&&t.sourceCoords&&e.boardCoords){const{row:A,col:y}=t.sourceCoords,{row:P,col:T}=e.boardCoords;if(Math.abs(A-P)+Math.abs(y-T)!==Tt)return!1}if(t.mustBeInLineWithSource&&t.sourceCoords&&e.boardCoords){const{row:A,col:y}=t.sourceCoords,{row:P,col:T}=e.boardCoords;if(A!==P&&y!==T)return!1}if(t.maxDistanceFromSource!==void 0&&t.sourceCoords&&e.boardCoords){const{row:A,col:y}=t.sourceCoords,{row:P,col:T}=e.boardCoords;if(Math.max(Math.abs(A-P),Math.abs(y-T))>t.maxDistanceFromSource)return!1}if(t.maxOrthogonalDistance!==void 0&&t.sourceCoords&&e.boardCoords){const{row:A,col:y}=t.sourceCoords,{row:P,col:T}=e.boardCoords;if(Math.abs(A-P)+Math.abs(y-T)>t.maxOrthogonalDistance)return!1}return!0},Nt=(e,t,r,a)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const n=[],i=t.board,o=i.length,s=t.activeGridSize,d=Math.floor((o-s)/2),l=d,E=d+s-1;if(e.type==="CREATE_STACK"){const T={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let h=l;h<=E;h++)for(let f=l;f<=E;f++){const S=i[h][f];S.card&&S.card.ownerId!==void 0&&st({card:S.card,ownerId:S.card.ownerId,location:"board",boardCoords:{row:h,col:f}},T,r,t.players)&&n.push({row:h,col:f})}return n}const{mode:g,payload:A,sourceCoords:y,contextCheck:P}=e;if(g==="REVEREND_DOUBLE_EXPLOIT"){for(let T=l;T<=E;T++)for(let h=l;h<=E;h++)i[T][h].card&&n.push({row:T,col:h});return n}if((g==="SELECT_TARGET"||g==="CENSOR_SWAP"||g==="ZEALOUS_WEAKEN"||g==="CENTURION_BUFF"||g==="SELECT_UNIT_FOR_MOVE")&&A.filter&&typeof A.filter=="function"){if(A.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||A.actionType==="LUCIUS_SETUP"||A.actionType==="SELECT_HAND_FOR_DEPLOY"||A.handOnly)return[];for(let T=l;T<=E;T++)for(let h=l;h<=E;h++){const f=i[T][h];let S=f.card&&A.filter(f.card,T,h);if(S&&P==="ADJACENT_TO_LAST_MOVE"&&(a!=null&&a.lastMovedCardCoords)){const{row:_,col:p}=a.lastMovedCardCoords;Math.abs(T-_)+Math.abs(h-p)===1||(S=!1)}S&&n.push({row:T,col:h})}}else if(g==="SELECT_TARGET"&&(A.actionType==="ENHANCED_INT_REVEAL"||A.actionType==="ENHANCED_INT_MOVE"))for(let T=l;T<=E;T++)for(let h=l;h<=E;h++)i[T][h].card&&n.push({row:T,col:h});else if(g==="PATROL_MOVE"&&y)for(let T=l;T<=E;T++)for(let h=l;h<=E;h++){const f=T===y.row||h===y.col,S=T===y.row&&h===y.col,_=!i[T][h].card;f&&(_||S)&&n.push({row:T,col:h})}else if(g==="RIOT_PUSH"&&y){const T=[{r:y.row-1,c:y.col},{r:y.row+1,c:y.col},{r:y.row,c:y.col-1},{r:y.row,c:y.col+1}],h=(f,S)=>f>=l&&f<=E&&S>=l&&S<=E;T.forEach(f=>{if(h(f.r,f.c)){const S=i[f.r][f.c].card;if(S&&S.ownerId!==r){const _=t.players.find(u=>u.id===r),p=t.players.find(u=>u.id===S.ownerId);if(!((_==null?void 0:_.teamId)!==void 0&&(p==null?void 0:p.teamId)!==void 0&&_.teamId===p.teamId)){const u=f.r-y.row,w=f.c-y.col,R=f.r+u,v=f.c+w;h(R,v)&&(i[R][v].card||n.push({row:f.r,col:f.c}))}}}})}else if(g==="SHIELD_SELF_THEN_RIOT_PUSH"&&y){y&&n.push(y);const T=[{r:y.row-1,c:y.col},{r:y.row+1,c:y.col},{r:y.row,c:y.col-1},{r:y.row,c:y.col+1}],h=(f,S)=>f>=l&&f<=E&&S>=l&&S<=E;T.forEach(f=>{if(h(f.r,f.c)){const S=i[f.r][f.c].card;if(S&&S.ownerId!==r){const _=t.players.find(u=>u.id===r),p=t.players.find(u=>u.id===S.ownerId);if(!((_==null?void 0:_.teamId)!==void 0&&(p==null?void 0:p.teamId)!==void 0&&_.teamId===p.teamId)){const u=f.r-y.row,w=f.c-y.col,R=f.r+u,v=f.c+w;h(R,v)&&(i[R][v].card||n.push({row:f.r,col:f.c}))}}}})}else if(g==="RIOT_MOVE"&&A.vacatedCoords)n.push(A.vacatedCoords),y&&n.push(y);else if(g==="SWAP_POSITIONS"&&A.filter)for(let T=l;T<=E;T++)for(let h=l;h<=E;h++){const f=i[T][h];f.card&&A.filter(f.card,T,h)&&n.push({row:T,col:h})}else if((g==="TRANSFER_STATUS_SELECT"||g==="TRANSFER_ALL_STATUSES")&&A.filter)for(let T=l;T<=E;T++)for(let h=l;h<=E;h++){const f=i[T][h];f.card&&A.filter(f.card,T,h)&&n.push({row:T,col:h})}else if(g==="SPAWN_TOKEN"||g==="SELECT_CELL"||g==="IMMUNIS_RETRIEVE")for(let T=l;T<=E;T++)for(let h=l;h<=E;h++){const f=!i[T][h].card;if(g==="IMMUNIS_RETRIEVE"&&A.filter){f&&A.filter(T,h)&&n.push({row:T,col:h});continue}if(g==="SELECT_CELL"){if(A.moveFromHand){f&&n.push({row:T,col:h});continue}if(!y)continue;const S=T===y.row&&h===y.col,_=A.range==="global";let p=!1;if(_)p=!0;else if(A.range==="line")p=T===y.row||h===y.col;else if(A.range===kt){const c=Math.abs(T-y.row),u=Math.abs(h-y.col),w=c+u;if(w===Tt)p=!0;else if(w===kt){const R=[];c===kt&&u===0?R.push({r:(T+y.row)/2,c:h}):c===0&&u===kt?R.push({r:T,c:(h+y.col)/2}):c===Tt&&u===Tt&&(R.push({r:T,c:y.col}),R.push({r:y.row,c:h})),p=R.some(v=>v.r<0||v.r>=o||v.c<0||v.c>=o?!1:!i[v.r][v.c].card)}}else p=Math.abs(T-y.row)+Math.abs(h-y.col)===Tt;(f&&p||A.allowSelf&&S)&&n.push({row:T,col:h})}else if(g==="SPAWN_TOKEN"&&y){const S=Math.abs(T-y.row)+Math.abs(h-y.col)===1;f&&S&&n.push({row:T,col:h})}}else if(g==="REVEAL_ENEMY"&&A.filter)for(let T=l;T<=E;T++)for(let h=l;h<=E;h++){const f=i[T][h];f.card&&A.filter(f.card,T,h)&&n.push({row:T,col:h})}else if(g==="SELECT_LINE_START")for(let T=l;T<=E;T++)for(let h=l;h<=E;h++)n.push({row:T,col:h});else if(g==="SELECT_LINE_END"&&A.firstCoords){const{row:T,col:h}=A.firstCoords;for(let f=l;f<=E;f++)n.push({row:T,col:f});for(let f=l;f<=E;f++)n.push({row:f,col:h})}else if(g==="INTEGRATOR_LINE_SELECT"&&y){const{row:T,col:h}=y;for(let f=l;f<=E;f++)n.push({row:T,col:f});for(let f=l;f<=E;f++)n.push({row:f,col:h})}else if(g==="ZIUS_LINE_SELECT"&&y){const{row:T,col:h}=y;for(let f=l;f<=E;f++)n.push({row:T,col:f});for(let f=l;f<=E;f++)n.push({row:f,col:h})}else if(g==="IP_AGENT_THREAT_SCORING"&&y){const{row:T,col:h}=y;for(let f=l;f<=E;f++)n.push({row:T,col:f});for(let f=l;f<=E;f++)n.push({row:f,col:h})}else if(g==="SELECT_DIAGONAL")if(A.firstCoords){const{row:T,col:h}=A.firstCoords;for(let f=l;f<=E;f++)for(let S=l;S<=E;S++)Math.abs(f-T)===Math.abs(S-h)&&n.push({row:f,col:S})}else for(let T=l;T<=E;T++)for(let h=l;h<=E;h++)n.push({row:T,col:h});return n},At=(e,t,r,a)=>{var i,o,s,d,l;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let E=0;E<t.board.length;E++)for(let g=0;g<t.board[E].length;g++)if(t.board[E][g].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((i=e.payload)!=null&&i.actionType)){const E=e.payload.actionType;if(E==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||E==="LUCIUS_SETUP"||E==="SELECT_HAND_FOR_DEPLOY"){const g=((o=e.sourceCard)==null?void 0:o.ownerId)||r;if(g!==null){const A=t.players.find(y=>y.id===g);if(A&&A.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(Nt(e,t,r,a).length>0)return!0;const g=["Aim","Exploit","Stun","Shield"];if(!(e.tokenType&&g.includes(e.tokenType))&&(e.tokenType==="Revealed"||(s=e.tokenType)!=null&&s.startsWith("Power")))for(const y of t.players)for(let P=0;P<y.hand.length;P++){const T={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(st({card:y.hand[P],ownerId:y.id,location:"hand"},T,r,t.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((d=e.payload)!=null&&d.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const E of t.players)if(E.hand.some(g=>e.payload.filter(g))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return Nt(e,t,r,a).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((l=e.payload)!=null&&l.filter),!1)};function ps(e){const{ws:t,webrtcManager:r,gameStateRef:a,localPlayerIdRef:n,webrtcIsHostRef:i,setLatestHighlight:o,setLatestFloatingTexts:s,setLatestNoTarget:d,setLatestDeckSelections:l,setLatestHandCardSelections:E,setClickWaves:g,setGameState:A}=e,y=H.useRef({}),P=500,T=H.useCallback(R=>{var D;const v={...R,timestamp:Date.now()};if(o(v),((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:a.current.gameId,highlightData:v}));else if(r.current){const b={type:"HIGHLIGHT_TRIGGERED",senderId:r.current.getPeerId(),data:v,timestamp:Date.now()};i.current?r.current.broadcastToGuests(b):r.current.sendMessageToHost(b)}},[t,r,a,i,o]),h=H.useCallback(R=>{var L;const v=Array.isArray(R)?R:[R],D=Date.now(),b=v.map((G,N)=>({...G,timestamp:D+N}));if(s(b),((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:a.current.gameId,batch:b}));else if(r.current){const G={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:r.current.getPeerId(),data:{batch:b},timestamp:Date.now()};i.current?r.current.broadcastToGuests(G):r.current.sendMessageToHost(G)}},[t,r,a,i,s]),f=H.useCallback(R=>{var D;const v=Date.now();if(d({coords:R,timestamp:v}),((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:a.current.gameId,coords:R,timestamp:v}));else if(r.current){const b={type:"NO_TARGET_TRIGGERED",senderId:r.current.getPeerId(),data:{coords:R,timestamp:v},timestamp:Date.now()};i.current?r.current.broadcastToGuests(b):r.current.sendMessageToHost(b)}},[t,r,a,i,d]),S=H.useCallback((R,v)=>{var b;const D={playerId:R,selectedByPlayerId:v,timestamp:Date.now()};if(l(L=>[...L,D]),((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:a.current.gameId,deckSelectionData:D}));else if(r.current){const L={type:"DECK_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:D,timestamp:Date.now()};i.current?r.current.broadcastToGuests(L):r.current.sendMessageToHost(L)}setTimeout(()=>{l(L=>L.filter(G=>G.timestamp!==D.timestamp))},1e3)},[t,r,a,i,l]),_=H.useCallback((R,v,D)=>{var L;const b={playerId:R,cardIndex:v,selectedByPlayerId:D,timestamp:Date.now()};if(E(G=>[...G,b]),((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:a.current.gameId,handCardSelectionData:b}));else if(r.current){const G={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:b,timestamp:Date.now()};i.current?r.current.broadcastToGuests(G):r.current.sendMessageToHost(G)}setTimeout(()=>{E(G=>G.filter(N=>N.timestamp!==b.timestamp))},1e3)},[t,r,a,i,E]),p=H.useCallback(R=>{},[]),c=H.useCallback((R,v,D)=>{var $;if(n.current===null)return;const b=n.current,L=Date.now(),G=y.current[b]||0;if(L-G<P)return;y.current[b]=L;const N=a.current.players.find(F=>F.id===b);if(!N)return;const M={timestamp:Date.now(),location:R,boardCoords:v,handTarget:D,clickedByPlayerId:b,playerColor:N.color};if(console.log("[triggerClickWave] Creating wave:",M),g(F=>[...F,M]),(($=t.current)==null?void 0:$.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_CLICK_WAVE",gameId:a.current.gameId,wave:M}));else if(r.current){const F={type:"CLICK_WAVE_TRIGGERED",senderId:r.current.getPeerId(),data:M,timestamp:Date.now()};i.current?r.current.broadcastToGuests(F):r.current.sendMessageToHost(F)}setTimeout(()=>{g(F=>F.filter(q=>q.timestamp!==M.timestamp))},600)},[t,r,a,i,g]),u=H.useCallback((R,v,D,b,L,G)=>{var F;const N=a.current;if(!N||!N.board){console.warn("[setTargetingMode] No game state or board available");return}let M;b?M=b:D&&(M=Nt(R,N,v,L));const $={playerId:v,action:R,sourceCoords:D,timestamp:Date.now(),boardTargets:M,handTargets:G};if(A(q=>({...q,targetingMode:$})),((F=t.current)==null?void 0:F.readyState)===WebSocket.OPEN&&N.gameId)t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:N.gameId,targetingMode:$}));else if(r.current){const q={type:"SET_TARGETING_MODE",senderId:r.current.getPeerId(),data:$,timestamp:Date.now()};i.current?r.current.broadcastToGuests(q):r.current.sendMessageToHost(q)}},[t,r,a,i,A]),w=H.useCallback(()=>{var v;const R=a.current;if(A(D=>({...D,targetingMode:null})),((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&(R!=null&&R.gameId))t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:R.gameId}));else if(r.current){const D={type:"CLEAR_TARGETING_MODE",senderId:r.current.getPeerId(),data:{},timestamp:Date.now()};i.current?r.current.broadcastToGuests(D):r.current.sendMessageToHost(D)}},[t,r,a,i,A]);return{triggerHighlight:T,triggerFloatingText:h,triggerNoTarget:f,triggerDeckSelection:S,triggerHandCardSelection:_,syncValidTargets:p,triggerClickWave:c,setTargetingMode:u,clearTargetingMode:w}}function ys(e){const{ws:t,webrtcManager:r,gameStateRef:a,webrtcIsHostRef:n,setGameState:i,updateState:o}=e,s=H.useCallback(A=>{var P;if(Oe()&&r.current&&n.current){i(T=>{const h=T.players.map(f=>{let S=1;for(const[_,p]of Object.entries(A))if(p.includes(f.id)){S=parseInt(_);break}return{...f,teamId:S}});return{...T,players:h}}),r.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:r.current.getPeerId(),data:{assignments:A},timestamp:Date.now()});return}((P=t.current)==null?void 0:P.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:a.current.gameId,assignments:A}))},[t,r,a,n,i]),d=H.useCallback(A=>{var P;if(Oe()&&r.current&&n.current){i(T=>({...T,gameMode:A})),r.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:r.current.getPeerId(),data:{mode:A},timestamp:Date.now()});return}((P=t.current)==null?void 0:P.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:a.current.gameId,mode:A}))},[t,r,a,n,i]),l=H.useCallback(A=>{var P;if(Oe()&&r.current&&n.current){i(T=>({...T,isPrivate:A})),r.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:r.current.getPeerId(),data:{isPrivate:A},timestamp:Date.now()});return}((P=t.current)==null?void 0:P.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:a.current.gameId,isPrivate:A}))},[t,r,a,n,i]),E=H.useCallback(A=>{o(y=>{if(y.isGameStarted)return y;const P={...y,activeGridSize:A};if(y.board.length!==A){P.board=[];for(let h=0;h<A;h++){const f=[];for(let S=0;S<A;S++)f.push({card:null});P.board.push(f)}}return P})},[o]),g=H.useCallback(A=>{o(y=>{if(y.isGameStarted)return y;const P=y.players.filter(f=>!f.isDummy);if(P.length+A>So)return y;const T=[...P],h=Math.max(...P.map(f=>f.id),0);for(let f=0;f<A;f++){const S=h+f+1,_=za(S,!0);_.name=`Dummy ${f+1}`,T.push(_)}return{...y,players:T,dummyPlayerCount:A}})},[o]);return{assignTeams:s,setGameMode:d,setGamePrivacy:l,setActiveGridSize:E,setDummyPlayerCount:g}}function hs(e){const{ws:t,webrtcManager:r,gameStateRef:a,localPlayerIdRef:n,webrtcIsHostRef:i,setGameState:o}=e,s=H.useCallback(()=>{var g;if(Oe()&&r.current&&i.current){o(A=>({...A,isReadyCheckActive:!0,isPrivate:!0})),r.current.broadcastToGuests({type:"START_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((g=t.current)==null?void 0:g.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:a.current.gameId}))},[t,r,a,i,o]),d=H.useCallback(()=>{var g;if(Oe()&&r.current&&i.current){o(A=>({...A,isReadyCheckActive:!1})),r.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((g=t.current)==null?void 0:g.readyState)===WebSocket.OPEN&&a.current.gameId?t.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:a.current.gameId})):o(A=>({...A,isReadyCheckActive:!1}))},[t,r,a,i,o]),l=H.useCallback(()=>{var g;const E=Oe();if(E&&r.current&&i.current&&n.current!==null){o(A=>{const y=A.players.map(f=>f.id===n.current?{...f,isReady:!0}:f),P={...A,players:y},T=P.players.filter(f=>!f.isDummy&&!f.isDisconnected);if(T.length>0&&T.every(f=>f.isReady)&&!P.isGameStarted){const f=P.players.filter(u=>!u.isDisconnected),S=Math.floor(Math.random()*f.length),_=f[S].id,p={...P};p.isReadyCheckActive=!1,p.isGameStarted=!0,p.startingPlayerId=_,p.activePlayerId=_,p.currentPhase=0,p.players=p.players.map(u=>{if(u.hand.length===0&&u.deck.length>0){const R=[...u.hand],v=[...u.deck];for(let D=0;D<6&&D<v.length;D++){const b=v[0];v.splice(0,1),R.push(b)}return m.info(`[playerReady] Drew initial ${R.length} cards for player ${u.id}`),{...u,hand:R,deck:v}}return u});const c=p.players.find(u=>u.id===_);if(c&&c.deck.length>0){const u=c.deck[0],w=[...c.deck.slice(1)],R=[...c.hand,u];p.players=p.players.map(v=>v.id===_?{...v,deck:w,hand:R,readySetup:!1,readyCommit:!1}:v),p.currentPhase=1}return r.current.broadcastGameState(p),r.current.broadcastToGuests({type:"GAME_START",senderId:r.current.getPeerId(),data:{startingPlayerId:_,activePlayerId:_,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),p}return r.current.broadcastToGuests({type:"HOST_READY",senderId:r.current.getPeerId(),playerId:n.current??void 0,timestamp:Date.now()}),P});return}if(E&&r.current&&!i.current&&n.current!==null){r.current.sendMessageToHost({type:"PLAYER_READY",senderId:r.current.getPeerId(),playerId:n.current,timestamp:Date.now()}),o(A=>({...A,players:A.players.map(y=>y.id===n.current?{...y,isReady:!0}:y)}));return}((g=t.current)==null?void 0:g.readyState)===WebSocket.OPEN&&a.current.gameId&&n.current!==null&&t.current.send(JSON.stringify({type:"PLAYER_READY",gameId:a.current.gameId,playerId:n.current}))},[t,r,a,n,i,o]);return{startReadyCheck:s,cancelReadyCheck:d,playerReady:l}}function ms(e){const{updateState:t,sendWebrtcAction:r,webrtcIsHostRef:a,webrtcManagerRef:n}=e,i=H.useCallback((s,d)=>{t(l=>l.isGameStarted?l:{...l,players:l.players.map(E=>E.id===s?{...E,name:d}:E)})},[t]),o=H.useCallback((s,d)=>{t(E=>({...E,players:E.players.map(g=>g.id===s?{...g,color:d}:g)})),r!==null&&(a!=null&&a.current&&(n!=null&&n.current)?n.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:n.current.getPeerId(),data:{playerId:s,color:d},timestamp:Date.now()}):!(a!=null&&a.current)&&r&&r("CHANGE_PLAYER_COLOR",{playerId:s,color:d}))},[t,r,a,n]);return{updatePlayerName:i,changePlayerColor:o}}function Is(e){const{updateState:t}=e,r=H.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const l=d.players.find(y=>y.id===s);if(!l||l.deck.length===0)return d;const E=me(d),g=E.players.find(y=>y.id===s),A=g.deck.shift();return A&&g.hand.push(A),E})},[t]),a=H.useCallback((s,d)=>{d<=0||t(l=>{if(!l.isGameStarted)return l;const E=l.players.find(P=>P.id===s);if(!E||E.deck.length===0)return l;const g=me(l),A=g.players.find(P=>P.id===s),y=Math.min(d,A.deck.length);for(let P=0;P<y;P++){const T=A.deck.shift();T&&A.hand.push(T)}return g})},[t]),n=H.useCallback(s=>{t(d=>{if(!d.isGameStarted||!d.players.find(A=>A.id===s))return d;const E=me(d),g=E.players.find(A=>A.id===s);return g.deck=ir([...g.deck]),E})},[t]),i=H.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const l={...d},E=l.board[s.row][s.col].card;return E&&(E.isFaceDown=!1),{...l,board:Ne(l)}})},[t]),o=H.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const l={...d},E=l.board[s.row][s.col].card;return E&&(E.isFaceDown=!0),{...l,board:Ne(l)}})},[t]);return{drawCard:r,drawCardsBatch:a,shufflePlayerDeck:n,flipBoardCard:i,flipBoardCardFaceDown:o}}function Es(e){const{localPlayerIdRef:t,updateState:r}=e,a=H.useCallback((f,S,_)=>{r(p=>{var w,R;if(!p.isGameStarted)return p;const c=me(p),u=c.board[f.row][f.col].card;if(u){if(S==="Stun"&&(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius")&&((w=u.types)!=null&&w.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(S)&&((R=u.statuses)==null?void 0:R.some(D=>D.type===S&&D.addedByPlayerId===_)))return p;u.statuses||(u.statuses=[]),u.statuses.push({type:S,addedByPlayerId:_})}return c})},[r]),n=H.useCallback((f,S)=>{r(_=>{if(!_.isGameStarted)return _;const p=me(_),c=p.board[f.row][f.col].card;if(c!=null&&c.statuses){const u=c.statuses.map(w=>w.type).lastIndexOf(S);u>-1&&c.statuses.splice(u,1)}return p.board=Ne(p),p})},[r]),i=H.useCallback((f,S,_)=>{r(p=>{if(!p.isGameStarted)return p;const c=me(p),u=c.board[f.row][f.col].card;if(u!=null&&u.statuses){const w=u.statuses.findIndex(R=>R.type===S&&R.addedByPlayerId===_);w>-1&&u.statuses.splice(w,1)}return c.board=Ne(c),c})},[r]),o=H.useCallback((f,S)=>{r(_=>{if(!_.isGameStarted)return _;const p=me(_),c=p.board[f.row][f.col].card;return c&&(c.powerModifier===void 0&&(c.powerModifier=0),c.powerModifier+=S),p})},[r]),s=H.useCallback((f,S,_)=>{r(p=>{var w;if(!p.isGameStarted)return p;const c=me(p),u=c.players.find(R=>R.id===f);if(u!=null&&u.announcedCard){if(["Support","Threat","Revealed"].includes(S)&&((w=u.announcedCard.statuses)==null?void 0:w.some(v=>v.type===S&&v.addedByPlayerId===_)))return p;u.announcedCard.statuses||(u.announcedCard.statuses=[]),u.announcedCard.statuses.push({type:S,addedByPlayerId:_})}return c})},[r]),d=H.useCallback((f,S)=>{r(_=>{var u;if(!_.isGameStarted)return _;const p=me(_),c=p.players.find(w=>w.id===f);if((u=c==null?void 0:c.announcedCard)!=null&&u.statuses){const w=c.announcedCard.statuses.map(R=>R.type).lastIndexOf(S);w>-1&&c.announcedCard.statuses.splice(w,1)}return p})},[r]),l=H.useCallback((f,S)=>{r(_=>{if(!_.isGameStarted)return _;const p=me(_),c=p.players.find(u=>u.id===f);return c!=null&&c.announcedCard&&(c.announcedCard.powerModifier===void 0&&(c.announcedCard.powerModifier=0),c.announcedCard.powerModifier+=S),p})},[r]),E=H.useCallback((f,S,_,p)=>{r(c=>{var R;if(!c.isGameStarted)return c;const u=me(c),w=u.players.find(v=>v.id===f);if(w!=null&&w.hand[S]){const v=w.hand[S];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(_)&&((R=v.statuses)==null?void 0:R.some(b=>b.type===_&&b.addedByPlayerId===p)))return c;v.statuses||(v.statuses=[]),v.statuses.push({type:_,addedByPlayerId:p})}return u})},[r]),g=H.useCallback((f,S,_)=>{r(p=>{if(!p.isGameStarted)return p;const c=me(p),u=c.players.find(R=>R.id===f),w=u==null?void 0:u.hand[S];if(w!=null&&w.statuses){const R=w.statuses.map(v=>v.type).lastIndexOf(_);R>-1&&w.statuses.splice(R,1),_==="Revealed"&&(w.statuses.some(D=>D.type==="Revealed")||delete w.revealedTo)}return c})},[r]),A=H.useCallback((f,S,_)=>{r(p=>{const c=p.players.find(R=>R.id===f);if(!(c!=null&&c.hand[S]))return p;const u=me(p),w=u.players.find(R=>R.id===f).hand[S];if(_==="all")w.revealedTo="all",w.statuses||(w.statuses=[]),w.statuses.some(R=>R.type==="Revealed"&&R.addedByPlayerId===f)||w.statuses.push({type:"Revealed",addedByPlayerId:f});else{(!w.revealedTo||w.revealedTo==="all"||!Array.isArray(w.revealedTo))&&(w.revealedTo=[]);const R=_.filter(v=>!w.revealedTo.includes(v));w.revealedTo.push(...R)}return u})},[r]),y=H.useCallback((f,S)=>{r(_=>{if(!_.board[f.row][f.col].card)return _;const c=me(_),u=c.board[f.row][f.col].card,w=u.ownerId;if(S==="all")u.revealedTo="all",w!==void 0&&(u.statuses||(u.statuses=[]),u.statuses.some(R=>R.type==="Revealed"&&R.addedByPlayerId===w)||u.statuses.push({type:"Revealed",addedByPlayerId:w}));else{(!u.revealedTo||u.revealedTo==="all"||!Array.isArray(u.revealedTo))&&(u.revealedTo=[]);const R=S.filter(v=>!u.revealedTo.includes(v));u.revealedTo.push(...R)}return c})},[r]),P=H.useCallback((f,S)=>{r(_=>{var w;const p=f.boardCoords?(w=_.board[f.boardCoords.row][f.boardCoords.col].card)==null?void 0:w.ownerId:f.ownerId;if(!p)return _;const c=me(_),u=c.revealRequests.find(R=>R.fromPlayerId===S&&R.toPlayerId===p);return u?u.cardIdentifiers.some(v=>JSON.stringify(v)===JSON.stringify(f))||u.cardIdentifiers.push(f):c.revealRequests.push({fromPlayerId:S,toPlayerId:p,cardIdentifiers:[f]}),c})},[r]),T=H.useCallback((f,S)=>{r(_=>{const p=_.revealRequests.findIndex(w=>w.toPlayerId===t.current&&w.fromPlayerId===f);if(p===-1)return _;const c=me(_),u=c.revealRequests[p];if(S){const{cardIdentifiers:w}=u;for(const R of w){let v=null;if(R.source==="board"&&R.boardCoords)v=c.board[R.boardCoords.row][R.boardCoords.col].card;else if(R.source==="hand"&&R.ownerId&&R.cardIndex!==void 0){const D=c.players.find(b=>b.id===R.ownerId);D&&(v=D.hand[R.cardIndex])}v&&(v.statuses||(v.statuses=[]),v.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===f)||v.statuses.push({type:"Revealed",addedByPlayerId:f}))}}return c.revealRequests.splice(p,1),c})},[r,t]),h=H.useCallback(f=>{r(S=>{const _=me(S);let p=null;if(f.source==="board"&&f.boardCoords)p=_.board[f.boardCoords.row][f.boardCoords.col].card;else if(f.source==="hand"&&f.playerId&&f.cardIndex!==void 0){const c=_.players.find(u=>u.id===f.playerId);c&&(p=c.hand[f.cardIndex])}return p&&(p.statuses&&(p.statuses=p.statuses.filter(c=>c.type!=="Revealed")),delete p.revealedTo),_})},[r]);return{addBoardCardStatus:a,removeBoardCardStatus:n,removeBoardCardStatusByOwner:i,modifyBoardCardPower:o,addAnnouncedCardStatus:s,removeAnnouncedCardStatus:d,modifyAnnouncedCardPower:l,addHandCardStatus:E,removeHandCardStatus:g,revealHandCard:A,revealBoardCard:y,requestCardReveal:P,respondToRevealRequest:T,removeRevealedStatus:h}}function Ts(e){const{webrtcIsHostRef:t,sendWebrtcAction:r,webrtcManagerRef:a,localPlayerIdRef:n,getCardDefinition:i,commandCardIds:o,createDeck:s,updateState:d}=e,l=H.useCallback((T,h)=>{const f=Oe();let S=!1;if(d(p=>{const c=p.players.find(D=>D.id===T);if(!c)return p;S=c.isDummy||!1;const u=S,w=t.current,R=!u||w;if(f&&!w)try{localStorage.setItem("webrtc_preferred_deck",h),m.info(`[changePlayerDeck] Guest saved deck preference: ${h}`)}catch(D){m.warn("[changePlayerDeck] Failed to save deck preference:",D)}const v=R?s(h,T,c.name):[];return f?w?{...p,players:p.players.map(D=>D.id===T?{...D,deck:v,selectedDeck:h,hand:[],discard:[],announcedCard:null,boardHistory:[]}:D)}:{...p,players:p.players.map(D=>D.id===T?{...D,selectedDeck:h}:D)}:{...p,players:p.players.map(D=>D.id===T?{...D,deck:v,selectedDeck:h,hand:[],discard:[],announcedCard:null,boardHistory:[]}:D)}}),m.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${f}, isHost=${t.current}, hasSendAction=${!!r}, hasManager=${!!(a!=null&&a.current)}`),!f)return;if(t.current){const c=s(h,T,"Player "+T).map(u=>({id:u.id,baseId:u.baseId,power:u.power,powerModifier:u.powerModifier||0,isFaceDown:u.isFaceDown||!1,statuses:u.statuses||[]}));a!=null&&a.current?(a.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:a.current.getPeerId(),timestamp:Date.now(),data:{playerId:T,deckType:h,deck:c,deckSize:c.length}}),m.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${T}, deck ${h}, ${c.length} cards, isDummy=${S}`)):m.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available")}else r?r("CHANGE_PLAYER_DECK",{playerId:T,deckType:h,deck:void 0,deckSize:0}):m.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[d,s,r,t,a,n]),E=H.useCallback((T,h)=>{const f=Oe();let S=[];const _=new Map;for(const{cardId:c,quantity:u}of h.cards){const w=i(c);if(!w)continue;const R=o.has(c),v=R?Ce.Command:Ce.Custom,D=R?"CMD":"CUS";for(let b=0;b<u;b++){const L=(_.get(c)||0)+1;_.set(c,L),S.push({...w,id:`${D}_${c.toUpperCase()}_${L}`,baseId:c,deck:v,ownerId:T,ownerName:"Player "+T})}}if(S=ir(S),d(c=>c.isGameStarted||!c.players.find(w=>w.id===T)?c:{...c,players:c.players.map(w=>w.id===T?{...w,deck:S,selectedDeck:Ce.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:w)}),!f)return;const p=S.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier||0,isFaceDown:c.isFaceDown||!1,statuses:c.statuses||[]}));t.current?a!=null&&a.current&&(a.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:a.current.getPeerId(),timestamp:Date.now(),data:{playerId:T,deckType:Ce.Custom,deck:p,deckSize:p.length}}),m.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${T}, ${p.length} cards`)):r&&(r("CHANGE_PLAYER_DECK",{playerId:T,deckType:Ce.Custom,deck:p,deckSize:p.length}),m.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${T}, ${p.length} cards`))},[d,i,o,r,t,a,n]),g=H.useCallback((T,h,f,S)=>{d(_=>{if(!_.isGameStarted||_.board[f.row][f.col].card!==null)return _;const p=me(_),c=p.players.find(u=>u.id===T);if(c&&c.discard.length>h){const[u]=c.discard.splice(h,1);u.enteredThisTurn=!0,rr(u,T),(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius"))&&(u.powerModifier===void 0&&(u.powerModifier=0),u.powerModifier+=2),u.statuses||(u.statuses=[]),u.statuses.push({type:"Resurrected",addedByPlayerId:T}),S&&S.forEach(w=>{var R;w.type!=="Resurrected"&&((R=u.statuses)==null||R.push({type:w.type,addedByPlayerId:T}))}),c.boardHistory||(c.boardHistory=[]),c.boardHistory.push(u.id),p.board[f.row][f.col].card=u,Ya(p.board,c),p.board=Ne(p)}return p})},[d]),A=H.useCallback((T,h)=>{d(f=>{const S=me(f),_=S.players.find(p=>p.id===T);if(_&&h.length>0){const p=new Set(h.map(u=>u.id)),c=_.deck.filter(u=>!p.has(u.id));_.deck=[...h,...c]}return S})},[d]),y=H.useCallback((T,h,f)=>{d(S=>{const _=me(S),p=_.players.find(c=>c.id===T);return p&&(f==="deck"?p.deck=h:f==="discard"&&(p.discard=h)),_})},[d]),P=H.useCallback((T,h)=>{d(f=>{if(!f.isGameStarted)return f;const S=me(f),_=S.players.find(p=>p.id===T);if(_&&_.discard.length>h){const[p]=_.discard.splice(h,1);_.hand.push(p)}return S})},[d]);return{changePlayerDeck:l,loadCustomDeck:E,resurrectDiscardedCard:g,reorderTopDeck:A,reorderCards:y,recoverDiscardedCard:P}}function gs(e){const{ws:t,webrtcManagerRef:r,webrtcIsHostRef:a,gameStateRef:n,scoreDeltaAccumulator:i,setGameState:o,updateState:s,abilityMode:d,setAbilityMode:l,createDeck:E}=e,g=H.useCallback(_=>{Oe()&&r.current?a.current?o(c=>{const u=Ba(c,_);return r.current&&r.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:r.current.getPeerId(),data:{activePlayerId:u.activePlayerId,currentPhase:u.currentPhase,turnNumber:u.turnNumber},timestamp:Date.now()}),u}):r.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:_},timestamp:Date.now()}):t.current&&t.current.readyState===WebSocket.OPEN&&(i.forEach((c,u)=>{clearTimeout(c.timerId),m.info(`[ScoreFlush] Flushing on toggle: player=${u}, delta=${c.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:n.current.gameId,playerId:u,delta:c.delta}))}),i.clear(),t.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:n.current.gameId,playerId:_})))},[t,r,a,n,i,o]),A=H.useCallback((_,p)=>{t.current&&t.current.readyState===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:n.current.gameId,playerId:_,enabled:p}))},[]),y=H.useCallback(_=>{const p=d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode);p&&l(null),s(c=>{if(!c.isGameStarted)return c;const u=Math.max(1,Math.min(_,4));return{...c,currentPhase:u,...u===4&&!p?{isScoringStep:!0}:{},...p?{isScoringStep:!1}:{}}})},[s,d,l]),P=H.useCallback(()=>{var c;d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&l(null);const _=n.current,p=Oe();if(_.isGameStarted&&_.currentPhase===4&&_.isScoringStep&&!p){((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&(i.forEach((u,w)=>{clearTimeout(u.timerId),m.info(`[ScoreFlush] Flushing pending score: player=${w}, delta=${u.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:_.gameId,playerId:w,delta:u.delta}))}),i.clear(),t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:_.gameId})));return}if(p&&_.isGameStarted&&_.currentPhase===4&&_.isScoringStep){s(u=>ht(u));return}s(u=>{if(!u.isGameStarted)return u;const w=me(u),R=u.currentPhase+1;return u.preserveDeployAbilities||w.board.forEach(v=>{v.forEach(D=>{var b;(b=D.card)!=null&&b.statuses&&(D.card.statuses=D.card.statuses.filter(L=>L.type!=="readyDeploy"))})}),p&&R===4&&u.currentPhase===3?ss(u,u.activePlayerId)?(w.isScoringStep=!0,w.currentPhase=4,w):(m.info(`[nextPhase] Player ${u.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),ht(u)):R===4&&u.currentPhase===3?(w.isScoringStep=!0,w.currentPhase=4,w):(w.board.forEach(v=>{v.forEach(D=>{var b;if((b=D.card)!=null&&b.statuses){const L=D.card.statuses.findIndex(G=>G.type==="Resurrected");if(L!==-1){const G=D.card.statuses[L].addedByPlayerId;D.card.statuses.splice(L,1),D.card.baseId!=="luciusTheImmortal"&&(D.card.statuses.push({type:"Stun",addedByPlayerId:G}),D.card.statuses.push({type:"Stun",addedByPlayerId:G}))}}})}),w.board=Ne(w),w.currentPhase=R,w)})},[s,d,l,n,t,i]),T=H.useCallback(()=>{s(_=>_.isGameStarted?(d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&l(null),_.isScoringStep?{..._,isScoringStep:!1,currentPhase:Math.max(1,_.currentPhase-1)}:{..._,currentPhase:Math.max(1,_.currentPhase-1)}):_)},[s,d,l]),h=H.useCallback(()=>{var p;Oe()?s(c=>({...c,isRoundEndModalOpen:!1,currentRound:(c.currentRound||1)+1,players:c.players.map(u=>({...u,score:0}))})):((p=t.current)==null?void 0:p.readyState)===WebSocket.OPEN&&n.current.gameId&&(o(c=>({...c,isRoundEndModalOpen:!1,currentRound:(c.currentRound||1)+1,players:c.players.map(u=>({...u,score:0}))})),t.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:n.current.gameId})))},[o,s,t,n]),f=H.useCallback(()=>{o(_=>({..._,isRoundEndModalOpen:!1}))},[o]),S=H.useCallback(()=>{var p;if(Oe()){const c=n.current,u=c.players.map(D=>{const b=D.selectedDeck||"SynchroTech";return{...D,hand:[],deck:E(b,D.id,D.name),discard:[],score:0,isReady:D.isDummy||!1,announcedCard:null,boardHistory:[]}}),w=c.activeGridSize||8,R=[];for(let D=0;D<w;D++){const b=[];for(let L=0;L<w;L++)b.push({card:null});R.push(b)}const v={...c,players:u,board:R,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};o(v),n.current=v,r.current&&r.current.broadcastToGuests({type:"GAME_RESET",senderId:r.current.getPeerId(),data:{players:u.map(D=>({id:D.id,name:D.name,color:D.color,selectedDeck:D.selectedDeck,isDummy:D.isDummy,isDisconnected:D.isDisconnected,autoDrawEnabled:D.autoDrawEnabled,handSize:D.hand.length,deckSize:D.deck.length,discardSize:D.discard.length,...D.isDummy&&{hand:D.hand.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses})),deck:D.deck.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses})),discard:D.discard.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses}))},score:D.score,isReady:D.isReady,announcedCard:D.announcedCard})),gameMode:v.gameMode,isPrivate:v.isPrivate,activeGridSize:v.activeGridSize,dummyPlayerCount:v.dummyPlayerCount,autoAbilitiesEnabled:v.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((p=t.current)==null?void 0:p.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"RESET_GAME",gameId:n.current.gameId}))},[t,r,n,o,E]);return{toggleActivePlayer:g,toggleAutoDraw:A,setPhase:y,nextPhase:P,prevPhase:T,closeRoundEndModal:h,closeRoundEndModalOnly:f,resetGame:S}}function ws(e){const{ws:t,gameStateRef:r,updateState:a,updatePlayerScore:n,triggerFloatingText:i,clearTargetingMode:o}=e,s=H.useCallback((l,E,g,A,y)=>{var R,v;const P=r.current;if(!P.isGameStarted||P.isRoundEndModalOpen)return;const T=P.board.some(D=>D.some(b=>{var L,G;return((L=b.card)==null?void 0:L.ownerId)===y&&b.card.name.toLowerCase().includes("data liberator")&&((G=b.card.statuses)==null?void 0:G.some(N=>N.type==="Support"))})),h=P.board.length;let f=l,S=l,_=E,p=E;if(l===g)f=l,S=l,_=0,p=h-1;else if(E===A)_=E,p=E,f=0,S=h-1;else return;let c=0;const u=[];for(let D=f;D<=S;D++)for(let b=_;b<=p;b++){const G=P.board[D][b].card;if(G&&!((R=G.statuses)!=null&&R.some(N=>N.type==="Stun"))){const N=G.ownerId===y,M=(v=G.statuses)==null?void 0:v.some($=>$.type==="Exploit"&&$.addedByPlayerId===y);if(N||T&&M&&G.ownerId!==y){const $=Math.max(0,G.power+(G.powerModifier||0)+(G.bonusPower||0));$>0&&(c+=$,u.push({row:D,col:b,text:`+${$}`,playerId:y}))}}}u.length>0&&i(u);const w=Oe();if(w?a(D=>({...D,players:D.players.map(b=>b.id===y?{...b,score:Math.max(0,(b.score||0)+c)}:b)})):n(y,c),w||n(y,c),c>0&&P.currentPhase===4&&P.activePlayerId===y){const D=P.gameId;setTimeout(()=>{var b;o==null||o(),w?a(L=>ht(L)):((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&D&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:D}))},100)}},[i,n,a,t,r,o,ht]),d=H.useCallback((l,E,g,A,y,P)=>{var w,R;const T=r.current;if(!T.isGameStarted||T.isRoundEndModalOpen)return;const h=g>l?1:-1,f=A>E?1:-1,S=Math.abs(l-g);let _=0,p=0;const c=[];for(let v=0;v<=S;v++){const D=l+v*h,b=E+v*f;if(D<0||D>=T.board.length||b<0||b>=T.board.length)continue;const G=T.board[D][b].card;if(G&&!((w=G.statuses)!=null&&w.some(N=>N.type==="Stun"))&&G.ownerId===y){const M=Math.max(0,G.power+(G.powerModifier||0)+(G.bonusPower||0));M>0&&(_+=M,c.push({row:D,col:b,text:`+${M}`,playerId:y})),P&&((R=G.statuses)!=null&&R.some($=>$.type==="Support"&&$.addedByPlayerId===y))&&(p+=1)}}P==="point_per_support"&&p>0&&(_+=p),c.length>0&&i(c);const u=Oe();if(u?a(v=>({...v,players:v.players.map(D=>D.id===y?{...D,score:Math.max(0,(D.score||0)+_)}:D)})):n(y,_),u||n(y,_),P==="draw_per_support"&&p>0&&a(v=>{const D=me(v),b=D.players.find(L=>L.id===y);if(b&&b.deck.length>0)for(let L=0;L<p;L++)b.deck.length>0&&b.hand.push(b.deck.shift());return D}),_>0&&T.currentPhase===4&&T.activePlayerId===y){const v=T.gameId;setTimeout(()=>{var D;o==null||o(),u?a(b=>ht(b)):((D=t.current)==null?void 0:D.readyState)===WebSocket.OPEN&&v&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:v}))},500)}},[i,n,a,t,r,o,ht]);return{scoreLine:s,scoreDiagonal:d}}const _s=e=>{const{updateState:t,rawJsonData:r}=e,a=H.useCallback((g,A,y,P)=>{t(T=>{var S,_;if(!T.isGameStarted||g.row<0||g.col<0)return T;const h=me(T),f=(_=(S=h.board[g.row])==null?void 0:S[g.col])==null?void 0:_.card;if(f){const p=f.statuses?f.statuses.map(c=>c.type):[];if(P&&f.statuses){f.statuses=f.statuses.filter(u=>u.type!==P);const c=f.statuses.map(u=>u.type);m.debug(`[markAbilityUsed] Removed status '${P}' from ${f.name} at [${g.row},${g.col}]: [${p.join(", ")}] -> [${c.join(", ")}]`)}else m.debug(`[markAbilityUsed] Called for ${f.name} at [${g.row},${g.col}] but no readyStatusToRemove specified. Current statuses: [${p.join(", ")}]`)}return h})},[t]),n=H.useCallback(g=>{t(A=>{var T,h;if(!A.isGameStarted||g.row<0||g.col<0)return A;const y=me(A),P=(h=(T=y.board[g.row])==null?void 0:T[g.col])==null?void 0:h.card;if(P&&(P.statuses||(P.statuses=[]),(P.ability||"").toLowerCase().includes("deploy:")&&!P.statuses.some(S=>S.type==="readyDeploy"))){const S=P.ownerId;if(S==null||S===0)return A;P.statuses.push({type:"readyDeploy",addedByPlayerId:S})}return y})},[t]),i=H.useCallback((g,A)=>{t(y=>{if(!y.isGameStarted)return y;const P=me(y),T=P.board[g.row][g.col].card;return T!=null&&T.statuses&&(T.statuses=T.statuses.filter(h=>h.type!==A)),P.board=Ne(P),P})},[t]),o=H.useCallback((g,A,y,P,T)=>{t(h=>{if(!h.isGameStarted)return h;const f=me(h);return A.forEach(({row:S,col:_})=>{var c;const p=f.board[S][_].card;if(p){if(y==="Stun"&&(p.baseId==="luciusTheImmortal"||p.name.includes("Lucius")&&((c=p.types)!=null&&c.includes("Hero"))))return;p.statuses||(p.statuses=[]),["Support","Threat","Revealed"].includes(y)?p.statuses.some(w=>w.type===y&&w.addedByPlayerId===P)||p.statuses.push({type:y,addedByPlayerId:P}):p.statuses.push({type:y,addedByPlayerId:P})}}),f})},[t]),s=H.useCallback((g,A)=>{t(y=>{if(!y.isGameStarted)return y;const P=me(y),T=P.board[g.row][g.col].card,h=P.board[A.row][A.col].card;return P.board[g.row][g.col].card=h,P.board[A.row][A.col].card=T,P.board=Ne(P),P})},[t]),d=H.useCallback((g,A,y)=>{t(P=>{if(!P.isGameStarted)return P;const T=me(P),h=T.board[g.row][g.col].card,f=T.board[A.row][A.col].card;if(h&&f&&h.statuses){const S=h.statuses.findIndex(_=>_.type===y);if(S>-1){const[_]=h.statuses.splice(S,1);f.statuses||(f.statuses=[]),f.statuses.push(_)}}return T.board=Ne(T),T})},[t]),l=H.useCallback((g,A)=>{t(y=>{if(!y.isGameStarted)return y;const P=me(y),T=P.board[g.row][g.col].card,h=P.board[A.row][A.col].card,f=["Support","Threat","LastPlayed"];if(T&&h&&T.statuses){const S=T.statuses.filter(p=>!f.includes(p.type)),_=T.statuses.filter(p=>f.includes(p.type));S.length>0&&(h.statuses||(h.statuses=[]),h.statuses.push(...S),T.statuses=_)}return P.board=Ne(P),P})},[t]),E=H.useCallback((g,A,y)=>{t(P=>{if(!P.isGameStarted)return P;const T=me(P);if(!r)return P;const h=r.tokenDatabase,f=Object.keys(h).find(p=>h[p].name===A);if(!f)return P;const S=h[f],_=T.players.find(p=>p.id===y);if(S&&T.board[g.row][g.col].card===null){const p={id:`TKN_${A.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:Ce.Tokens,name:A,baseId:S.baseId||f,imageUrl:S.imageUrl,fallbackImage:S.fallbackImage,power:S.power,ability:S.ability,flavorText:S.flavorText,color:S.color,types:S.types||["Unit"],faction:"Tokens",ownerId:y,ownerName:_==null?void 0:_.name,enteredThisTurn:!0,statuses:[]};rr(p,y),T.board[g.row][g.col].card=p}return T.board=Ne(T),T})},[t,r]);return{markAbilityUsed:a,applyGlobalEffect:o,swapCards:s,transferStatus:d,transferAllCounters:l,spawnToken:E,resetDeployStatus:n,removeStatusByType:i}};function bs(e){const{updateState:t,localPlayerIdRef:r,updatePlayerScore:a}=e,n=H.useCallback((o,s)=>{t(d=>{var T,h,f,S,_,p;if(!d.isGameStarted||s.target==="board"&&s.boardCoords&&d.board[s.boardCoords.row][s.boardCoords.col].card!==null&&o.source!=="counter_panel")return d;let l=!1;try{const c=localStorage.getItem("auto_abilities_enabled");l=c===null?!0:c==="true"}catch{l=!0}const E=l&&d.currentPhase===1&&o.source==="hand"&&s.target==="board"&&(((T=o.card.types)==null?void 0:T.includes("Unit"))||((h=o.card.types)==null?void 0:h.includes("Command"))),g=me(d);if(o.source==="board"&&["hand","deck","discard"].includes(s.target)&&!o.bypassOwnershipCheck){const c=o.card.ownerId,u=g.players.find(v=>v.id===c),w=c===r.current,R=!!(u!=null&&u.isDummy);if(!w&&!R)return d}let A=null;if(o.source==="board"&&s.target==="board"&&o.boardCoords){const c=g.board[o.boardCoords.row][o.boardCoords.col];c.card&&(A=c.card);const w=d.board[o.boardCoords.row][o.boardCoords.col].card||A;if(w&&((f=w.statuses)==null?void 0:f.some(v=>v.type==="Stun"))){const v=r.current,D=w.ownerId,b=d.players.find(M=>M.id===v),L=d.players.find(M=>M.id===D),G=v===D,N=(b==null?void 0:b.teamId)!==void 0&&(L==null?void 0:L.teamId)!==void 0&&b.teamId===L.teamId;if((G||N)&&!o.isManual)return d}}if(o.source==="counter_panel"&&o.statusType){const c=it[o.statusType],u=(c==null?void 0:c.allowedTargets)??["board","hand"];if(!u.includes(s.target)&&!u.includes("board-facedown"))return d;let w=null;if(s.target==="board"&&s.boardCoords){if(w=g.board[s.boardCoords.row][s.boardCoords.col].card,u.includes("board-facedown")&&w&&!w.isFaceDown)return d}else if(s.playerId!==void 0){const R=g.players.find(v=>v.id===s.playerId);R&&(s.target==="hand"&&s.cardIndex!==void 0&&(w=R.hand[s.cardIndex]),s.target==="announced"&&(w=R.announcedCard||null),s.target==="deck"&&R.deck.length>0?s.deckPosition==="top"||!s.deckPosition?w=R.deck[0]:w=R.deck[R.deck.length-1]:s.target==="discard"&&R.discard.length>0&&(w=R.discard[R.discard.length-1]))}if(w){if(o.statusType==="Stun"&&(w.baseId==="luciusTheImmortal"||w.name.includes("Lucius")&&((S=w.types)!=null&&S.includes("Hero"))))return g;const R=o.count||1;let v;if(o.ownerId!==void 0)v=o.ownerId;else if(o.card.ownerId!==void 0)v=o.card.ownerId;else{const D=g.players.find(b=>b.id===g.activePlayerId);v=D!=null&&D.isDummy?D.id:r.current!==null?r.current:0}if(o.statusType==="Revealed"&&(s.target==="board"&&w.ownerId===v||s.target==="hand"&&s.playerId===v))return d;if(o.statusType==="Power+")w.powerModifier===void 0&&(w.powerModifier=0),w.powerModifier+=1*R;else if(o.statusType==="Power-")w.powerModifier===void 0&&(w.powerModifier=0),w.powerModifier-=1*R;else if(o.statusType==="Revealed"&&s.target==="hand"){if(w.revealedTo||(w.revealedTo=[]),w.revealedTo!=="all"){const b=Array.isArray(w.revealedTo)?w.revealedTo:[];b.includes(v)||b.push(v),w.revealedTo=b}w.statuses||(w.statuses=[]),w.statuses.some(b=>b.type==="Revealed"&&b.addedByPlayerId===v)||w.statuses.push({type:"Revealed",addedByPlayerId:v})}else if(w.statuses||(w.statuses=[]),o.replaceStatusType&&o.statusType)for(let D=0;D<R;D++){const b=w.statuses.findIndex(L=>L.type===o.replaceStatusType&&L.addedByPlayerId===v);b!==-1?w.statuses[b]={type:o.statusType,addedByPlayerId:v}:w.statuses.push({type:o.statusType,addedByPlayerId:v})}else for(let D=0;D<R;D++)["Support","Threat","Revealed"].includes(o.statusType)?w.statuses.some(L=>L.type===o.statusType&&L.addedByPlayerId===v)||w.statuses.push({type:o.statusType,addedByPlayerId:v}):w.statuses.push({type:o.statusType,addedByPlayerId:v});return s.target==="board"&&(g.board=Ne(g)),g}return d}const y=A?{...A}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const c=g.players.find(u=>u.id===o.playerId);if(c){const u=c.hand[o.cardIndex];if(u&&u.id===o.card.id&&u.ownerId===o.card.ownerId)c.hand.splice(o.cardIndex,1);else{const w=c.hand.findIndex(R=>R.id===o.card.id&&R.ownerId===o.card.ownerId);if(w!==-1)c.hand.splice(w,1);else return d}}}else if(o.source==="board"&&o.boardCoords){const c=g.board[o.boardCoords.row][o.boardCoords.col];if(c.card&&c.card.id===o.card.id&&c.card.ownerId===o.card.ownerId)g.board[o.boardCoords.row][o.boardCoords.col].card=null;else return d}else if(o.source==="discard"&&o.playerId!==void 0){const c=g.players.find(u=>u.id===o.playerId);if(c){let u=!1;if(o.cardIndex!==void 0){const w=c.discard[o.cardIndex];w&&w.id===o.card.id&&w.ownerId===o.card.ownerId&&(c.discard.splice(o.cardIndex,1),u=!0)}if(!u){const w=c.discard.findIndex(R=>R.id===o.card.id&&R.ownerId===o.card.ownerId);if(w!==-1)c.discard.splice(w,1);else return d}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const c=g.players.find(u=>u.id===o.playerId);if(c){const u=c.deck[o.cardIndex];if(u&&u.id===o.card.id&&u.ownerId===o.card.ownerId)c.deck.splice(o.cardIndex,1);else{const w=c.deck.findIndex(R=>R.id===o.card.id&&R.ownerId===o.card.ownerId);if(w!==-1)c.deck.splice(w,1);else return d}}}else if(o.source==="announced"&&o.playerId!==void 0){const c=g.players.find(u=>u.id===o.playerId);if(c)if(c.announcedCard&&c.announcedCard.id===o.card.id)c.announcedCard=null;else return d}if(["hand","deck","discard"].includes(s.target))y.statuses&&(y.statuses=y.statuses.filter(c=>c.type==="Revealed")),y.isFaceDown=!1,delete y.powerModifier,delete y.bonusPower,delete y.enteredThisTurn;else if(s.target==="board"&&(y.statuses||(y.statuses=[]),o.source!=="board"&&y.isFaceDown===void 0&&(y.isFaceDown=!1),o.source!=="board")){y.enteredThisTurn=!0;let c=y.ownerId;c===void 0&&(o.source==="token_panel"?o.ownerId!==void 0?c=o.ownerId:c=g.activePlayerId??r.current??0:o.playerId!==void 0?c=o.playerId:c=r.current??0,y.ownerId=c),rr(y,c),o.source==="discard"&&(y.baseId==="luciusTheImmortal"||y.name.includes("Lucius"))&&(y.powerModifier===void 0&&(y.powerModifier=0),y.powerModifier+=2)}if(s.target==="hand"&&s.playerId!==void 0){if(y.deck===Ce.Tokens)return g.board[o.boardCoords.row][o.boardCoords.col].card=null,g;$t(y);const u=g.players.find(R=>R.id===s.playerId);if(!u)return d;let w=s.cardIndex!==void 0?s.cardIndex:u.hand.length;if(o.source==="hand"&&o.playerId===s.playerId&&o.cardIndex!==void 0&&(o.cardIndex<w&&(w-=1),o.cardIndex===w))return d;u.hand.splice(w,0,y)}else if(s.target==="board"&&s.boardCoords){if(g.board[s.boardCoords.row][s.boardCoords.col].card===null){if(y.ownerId===void 0&&r.current!==null){const c=g.players.find(u=>u.id===r.current);c&&(y.ownerId=c.id,y.ownerName=c.name)}if(o.source!=="board"&&y.ownerId!==void 0){const c=g.players.find(u=>u.id===y.ownerId);c&&(c.boardHistory||(c.boardHistory=[]),c.boardHistory.push(y.id))}g.board[s.boardCoords.row][s.boardCoords.col].card=y}}else if(s.target==="discard"&&s.playerId!==void 0){if(y.deck===Ce.Tokens)return g.board[o.boardCoords.row][o.boardCoords.col].card=null,g;$t(y);const u=g.players.find(w=>w.id===s.playerId);u&&(y.ownerId===void 0&&(y.ownerId=s.playerId,y.ownerName=u.name),u.discard.some(R=>R.id===y.id)||u.discard.push(y))}else if(s.target==="deck"&&s.playerId!==void 0){if(y.deck===Ce.Tokens)return g.board[o.boardCoords.row][o.boardCoords.col].card=null,g;$t(y);const u=g.players.find(w=>w.id===s.playerId);if(!u)return d;y.ownerId===void 0&&(y.ownerId=s.playerId,y.ownerName=u.name),s.deckPosition==="top"||!s.deckPosition?u.deck.unshift(y):u.deck.push(y)}else if(s.target==="announced"&&s.playerId!==void 0){const c=g.players.find(u=>u.id===s.playerId);c&&(c.announcedCard&&(c.announcedCard.statuses&&(c.announcedCard.statuses=c.announcedCard.statuses.filter(u=>u.type==="Revealed")),delete c.announcedCard.enteredThisTurn,delete c.announcedCard.powerModifier,delete c.announcedCard.bonusPower,c.hand.push(c.announcedCard)),c.announcedCard=y)}if(o.source==="board"&&s.target!=="board"&&y.ownerId!==void 0){const c=g.players.find(u=>u.id===y.ownerId);c&&(c.boardHistory||(c.boardHistory=[]),c.boardHistory=c.boardHistory.filter(u=>u!==y.id))}if((o.source==="board"||s.target==="board")&&y.ownerId!==void 0){const c=g.players.find(u=>u.id===y.ownerId);c&&Ya(g.board,c)}if(o.source==="hand"&&s.target==="board"){const c=y;if(c.revealedTo==="all"||((_=c.statuses)==null?void 0:_.some(w=>w.type==="Revealed"))){const w=g.board.length;for(let R=0;R<w;R++)for(let v=0;v<w;v++){const D=g.board[R][v].card;if(D&&D.name.toLowerCase().includes("vigilant spotter")&&D.ownerId!==c.ownerId&&(g.board=Ne(g),(p=g.board[R][v].card.statuses)!=null&&p.some(L=>L.type==="Support"))){const L=g.players.find(G=>G.id===D.ownerId);L&&setTimeout(()=>{a(L.id,2)},0)}}}}return(o.source==="board"||s.target==="board")&&(g.board=Ne(g)),E&&(g.currentPhase=2),g})},[t,r,a]),i=H.useCallback((o,s)=>{t(d=>{if(!d.isGameStarted)return d;const l=me(d),E=l.board.length;if(o.row<0||o.row>=E||o.col<0||o.col>=E||s.row<0||s.row>=E||s.col<0||s.col>=E)return d;const g=l.board[o.row][o.col],A=l.board[s.row][s.col],y=g.card,P=A.card;return!y||!P?d:(l.board[o.row][o.col].card=P,l.board[s.row][s.col].card=y,l.board=Ne(l),l)})},[t]);return{moveItem:n,swapBoardCards:i}}function As(e){const{ws:t,webrtcManager:r,gameStateRef:a,webrtcIsHostRef:n,setGameState:i}=e,o=H.useCallback((d,l,E,g,A,y)=>{var _,p,c,u,w,R,v;const P=a.current;if(typeof l!="number"){m.error(`[TargetingMode] Invalid playerId type: ${typeof l}, value:`,l);return}let T=[];g?T=g:T=Nt(d,P,l,A);let h=[];if(y)h=y;else if(h=[],(_=d.payload)!=null&&_.filter&&d.mode==="SELECT_TARGET"){m.info("[TargetingMode] Calculating hand targets for action",{actionMode:d.mode,filterType:typeof d.payload.filter,hasActionType:!!d.payload.actionType});for(const D of P.players)D.hand&&D.hand.forEach((b,L)=>{try{d.payload.filter(b)&&(h.push({playerId:D.id,cardIndex:L}),m.debug(`[TargetingMode] Found hand target: player ${D.id}, card ${L}, card ${b.name}`))}catch(G){m.warn(`[TargetingMode] Filter failed for card ${b.name}:`,G)}});m.info(`[TargetingMode] Hand targets calculated: ${h.length} targets`)}else m.info("[TargetingMode] No hand targets calculated - no filter or wrong mode",{hasFilter:!!((p=d.payload)!=null&&p.filter),mode:d.mode});const f=d.mode==="SELECT_DECK",S={playerId:l,action:d,sourceCoords:E,timestamp:Date.now(),boardTargets:T,handTargets:h.length>0?h:void 0,isDeckSelectable:f||void 0,originalOwnerId:d.originalOwnerId};if(i(D=>({...D,targetingMode:S})),a.current.targetingMode=S,((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&P.gameId&&t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:P.gameId,targetingMode:S})),r.current)if(n.current)r.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((w=(u=r.current).getPeerId)==null?void 0:w.call(u))??void 0,data:{targetingMode:S},timestamp:Date.now()});else{const D=r.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((v=(R=r.current).getPeerId)==null?void 0:v.call(R))??void 0,data:{targetingMode:S},timestamp:Date.now()});m.info("[TargetingMode] Guest sent SET_TARGETING_MODE to host",{success:D,playerId:l,boardTargetsCount:T.length,handTargetsCount:h.length})}m.info(`[TargetingMode] Player ${l} (type: ${typeof l}) activated targeting mode`,{mode:d.mode,boardTargetsCount:T.length,handTargetsCount:h.length,isDeckSelectable:f||!1})},[t,r,a,n,i]),s=H.useCallback(()=>{var l,E,g,A,y;const d=a.current;i(P=>({...P,targetingMode:null})),a.current.targetingMode=null,((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&d.gameId&&t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:d.gameId})),r.current&&(n.current?r.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((g=(E=r.current).getPeerId)==null?void 0:g.call(E))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):r.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((y=(A=r.current).getPeerId)==null?void 0:y.call(A))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[t,r,a,n,i]);return{setTargetingMode:o,clearTargetingMode:s}}function Ss(e){const{webrtcManagerRef:t,webrtcIsHostRef:r,setWebrtcIsHost:a,setConnectionStatus:n,setWebrtcHostId:i,gameStateRef:o,localPlayerIdRef:s}=e,d=H.useCallback(async()=>{var y;if(!t.current)return m.error("WebRTC manager not initialized"),null;try{a(!0),n("Connecting");const P=await t.current.initializeAsHost();i(P),n("Connected");const T=o.current.gameId;T&&Qt(P,T);const h=(y=o.current.players)==null?void 0:y.find(f=>f.id===s.current);return Uo({peerId:P,isHost:!0,playerName:(h==null?void 0:h.name)||null}),m.info("[initializeWebrtcHost] Saved host data for auto-restore"),P}catch(P){return m.error("Failed to initialize WebRTC host:",P),n("Disconnected"),null}},[t,a,n,i,o,s]),l=H.useCallback(async y=>{if(!t.current)return m.error("WebRTC manager not initialized"),!1;try{return a(!1),i(y),n("Connecting"),await t.current.initializeAsGuest(y),!0}catch(P){return m.error("Failed to connect as guest:",P),n("Disconnected"),!1}},[t,a,n,i]),E=H.useCallback((y,P)=>t.current?r.current?(m.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):t.current.sendAction(y,P):(m.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[t,r]),g=H.useCallback(y=>{var T,h;if(!t.current||r.current)return m.warn("[requestDeckView] Only guests can request deck view from host"),!1;const P={type:"REQUEST_DECK_VIEW",senderId:t.current.getPeerId(),playerId:r.current||(h=(T=t.current).getLocalPlayerId)==null?void 0:h.call(T),data:{targetPlayerId:y},timestamp:Date.now()};return t.current.sendMessageToHost(P)},[t,r]),A=H.useCallback((y,P,T)=>!t.current||r.current?(m.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):t.current.sendFullDeckToHost(y,P,T),[t,r]);return{initializeWebrtcHost:d,connectAsGuest:l,sendWebrtcAction:E,requestDeckView:g,sendFullDeckToHost:A}}function Cs(){const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return m.warn("No custom WebSocket URL configured in settings."),null;let t=e.trim();return t.endsWith("/")&&(t=t.slice(0,-1)),t.startsWith("https://")?t=t.replace("https://","wss://"):t.startsWith("http://")&&(t=t.replace("http://","ws://")),!t.startsWith("ws://")&&!t.startsWith("wss://")?(m.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",t),t)}function Ds(e){const{gameStateRef:t,localPlayerIdRef:r,setGameState:a,setLocalPlayerId:n,setConnectionStatus:i,setGamesList:o,setLatestHighlight:s,setLatestNoTarget:d,setLatestDeckSelections:l,setLatestHandCardSelections:E,setClickWaves:g,setLatestFloatingTexts:A,setRemoteValidTargets:y,isManualExitRef:P,joiningGameIdRef:T,playerTokenRef:h,receivedServerStateRef:f,isJoinAttemptRef:S}=e,_=H.useRef(null),p=H.useRef(null),c=H.useCallback(()=>{if(Oe()){i("Connected");return}if(P.current||_.current&&(_.current.readyState===WebSocket.OPEN||_.current.readyState===WebSocket.CONNECTING))return;const L=Cs();if(!L){m.warn("No WebSocket URL configured in settings. Waiting for user input."),i("Disconnected"),p.current&&clearTimeout(p.current);return}try{_.current=new WebSocket(L)}catch(G){m.error("Failed to create WebSocket:",G),i("Disconnected"),p.current&&clearTimeout(p.current),p.current=window.setTimeout(c,re.RECONNECT_DELAY);return}i("Connecting"),_.current.onopen=()=>{var M;f.current=!1,i("Connected");const G=localStorage.getItem("custom_ws_url");G&&G.trim()!==""&&localStorage.setItem("websocket_url",G.trim());const N=t.current;if(m.info("Current gameState on open:",N?`gameId=${N.gameId}`:"null"),m.info("playerTokenRef.current on open:",h.current?"YES":"NO"),N&&N.gameId&&((M=_.current)==null?void 0:M.readyState)===WebSocket.OPEN){let $=h.current;if(!$){try{const F=localStorage.getItem(nt);if(F){const q=JSON.parse(F);m.info("RECONNECTION_DATA_KEY:",q==null?void 0:q.gameId,N.gameId),q!=null&&q.playerToken&&($=q.playerToken,h.current=$,m.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(F){console.warn("Failed to parse reconnection data:",F instanceof Error?F.message:String(F))}if(!$&&N.players&&r.current){const F=N.players.find(q=>q.id===r.current);F!=null&&F.playerToken&&($=F.playerToken,h.current=$)}}m.info("JoinGame: Sending reconnection with token:",$?"YES":"NO","gameId:",N.gameId),_.current.send(JSON.stringify({type:"JOIN_GAME",gameId:N.gameId,playerToken:$}))}},_.current.onmessage=G=>{try{const N=JSON.parse(G.data);if(N.type==="GAMES_LIST")o(N.games);else if(N.type==="JOIN_SUCCESS"){if(N.isSpectator){n(null),m.info("Joined as spectator:",N.message||"Spectator mode"),T.current=null;return}n(N.playerId);const M=T.current||t.current.gameId;M&&N.playerId!==null&&N.playerToken?(h.current=N.playerToken,localStorage.setItem(nt,JSON.stringify({gameId:M,playerId:N.playerId,playerToken:N.playerToken,timestamp:Date.now()})),t.current.gameId===M&&wa(t.current,N.playerId,N.playerToken)):N.playerId===null&&(yt(),h.current=void 0),T.current=null,N.playerId===1&&setTimeout(()=>{var $;(($=_.current)==null?void 0:$.readyState)===WebSocket.OPEN&&_.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe}))},re.DECK_SYNC_DELAY)}else if(N.type==="CONNECTION_ESTABLISHED"){m.info("Connection acknowledged by server");const M=sessionStorage.getItem("pending_invite_game"),$=sessionStorage.getItem("pending_invite_name");M&&_.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),m.info("Auto-joining invite game:",M),_.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:M,playerName:$||"Player"})))}else if(N.type==="DECK_DATA_UPDATED")m.info("Deck data synced with server");else if(N.type==="ERROR")if(N.message.includes("not found")||N.message.includes("Dummy")){m.info("Game not found error - clearing state");const M=at();a(M),t.current=M,n(null),yt(),T.current=null}else if(N.message.includes("already started")&&S.current){m.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const M=at();a(M),t.current=M,n(null),yt(),T.current=null,S.current=!1}else console.warn("Server Error:",N.message);else if(N.type==="HIGHLIGHT_TRIGGERED")s(N.highlightData);else if(N.type==="NO_TARGET_TRIGGERED")d({coords:N.coords,timestamp:N.timestamp});else if(N.type==="DECK_SELECTION_TRIGGERED")l(M=>[...M,N.deckSelectionData]),setTimeout(()=>{l(M=>M.filter($=>$.timestamp!==N.deckSelectionData.timestamp))},1e3);else if(N.type==="HAND_CARD_SELECTION_TRIGGERED")E(M=>[...M,N.handCardSelectionData]),setTimeout(()=>{E(M=>M.filter($=>$.timestamp!==N.handCardSelectionData.timestamp))},1e3);else if(N.type==="FLOATING_TEXT_TRIGGERED")a(M=>({...M,floatingTexts:[...M.floatingTexts,N.floatingTextData].filter($=>Date.now()-$.timestamp<re.FLOATING_TEXT_DURATION)}));else if(N.type==="FLOATING_TEXT_BATCH_TRIGGERED")a(M=>({...M,floatingTexts:[...M.floatingTexts,...N.batch].filter($=>Date.now()-$.timestamp<re.FLOATING_TEXT_DURATION)}));else if(N.type==="CLICK_WAVE_TRIGGERED")N.wave&&N.wave.clickedByPlayerId!==r.current&&(g(M=>[...M,N.wave]),setTimeout(()=>{g(M=>M.filter($=>$.timestamp!==N.wave.timestamp))},600));else if(N.type==="TARGETING_MODE_SET"){const M=N.targetingMode;M&&(a($=>({...$,targetingMode:M})),t.current.targetingMode=M,m.info("[TargetingMode] Received targeting mode from server",{playerId:M.playerId,mode:M.action.mode}))}else if(N.type==="TARGETING_MODE_CLEARED")a(M=>({...M,targetingMode:null})),t.current.targetingMode=null,m.debug("[TargetingMode] Cleared targeting mode from server");else if(N.type==="ABILITY_MODE_SET")N.abilityMode&&(a(M=>({...M,abilityMode:N.abilityMode})),m.info("[AbilityMode] Received ability mode from host",{playerId:N.abilityMode.playerId,mode:N.abilityMode.mode,sourceCard:N.abilityMode.sourceCardName}));else if(N.type==="ABILITY_TARGET_SELECTED")m.info("[Ability] Target selected",N.data);else if(N.type==="ABILITY_COMPLETED")a(M=>({...M,abilityMode:void 0})),m.info("[Ability] Ability completed",N.data);else if(N.type==="ABILITY_CANCELLED")a(M=>({...M,abilityMode:void 0})),m.info("[Ability] Ability cancelled");else if(N.type==="GAME_RESET")m.info("[GameReset] Received GAME_RESET message from server"),a(M=>{const $=N.activeGridSize||8,F=[];for(let Z=0;Z<$;Z++){const X=[];for(let de=0;de<$;de++)X.push({card:null});F.push(X)}const q={...M,players:N.players||[],gameMode:N.gameMode,isPrivate:N.isPrivate,activeGridSize:N.activeGridSize,dummyPlayerCount:N.dummyPlayerCount,autoAbilitiesEnabled:N.autoAbilitiesEnabled,isGameStarted:N.isGameStarted,currentPhase:N.currentPhase,currentRound:N.currentRound,turnNumber:N.turnNumber,activePlayerId:N.activePlayerId,startingPlayerId:N.startingPlayerId,roundWinners:N.roundWinners||{},gameWinner:N.gameWinner,isRoundEndModalOpen:N.isRoundEndModalOpen,isReadyCheckActive:N.isReadyCheckActive,board:F,targetingMode:null,floatingTexts:[]};return t.current=q,q});else if(!N.type&&N.players&&N.board){const M=Ct(N),$=t.current;if(!$.isScoringStep&&M.isScoringStep&&M.currentPhase!==2){m.debug("Ignoring delayed scoring state update");return}if($.isScoringStep&&(M.currentPhase!==$.currentPhase||M.activePlayerId!==$.activePlayerId||M.currentPhase!==4)&&(M.isScoringStep=!1),a(M),t.current=M,r.current!==null&&M.gameId){let q;try{const Z=localStorage.getItem(nt);Z&&(q=JSON.parse(Z).playerToken)}catch{}if(!q&&M.players){const Z=M.players.find(X=>X.id===r.current);Z!=null&&Z.playerToken&&(q=Z.playerToken,h.current=q)}wa(M,r.current,q)}}else console.warn("Unknown message type:",N.type,"keys:",Object.keys(N),"data:",N)}catch(N){m.error("Failed to parse message from server:",G.data,N)}},_.current.onclose=()=>{i("Disconnected"),P.current||(p.current&&clearTimeout(p.current),p.current=window.setTimeout(c,re.RECONNECT_DELAY))},_.current.onerror=G=>m.error("WebSocket error event:",G)},[a,i,o,s,d,l,E,g,A,y,n,at,P,t,r,h,f,T]),u=H.useCallback(()=>{_.current&&(_.current.readyState===WebSocket.OPEN||_.current.readyState===WebSocket.CONNECTING)?_.current.close():c()},[_,c]),w=H.useCallback(L=>{var G;if(P.current=!1,((G=_.current)==null?void 0:G.readyState)===WebSocket.OPEN){T.current=L;let N=null;try{const $=localStorage.getItem(nt);$&&(N=JSON.parse($))}catch{yt()}const M={type:"JOIN_GAME",gameId:L};(N==null?void 0:N.gameId)===L&&N.playerToken?(M.playerToken=N.playerToken,m.info(`JoinGame: Sending reconnection with token ${N.playerToken.substring(0,8)}... for player ${N.playerId}`)):m.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${N==null?void 0:N.gameId}, requestedGameId=${L}`),_.current.send(JSON.stringify(M))}else c(),T.current=L},[_,P,T,c]),R=H.useCallback((L,G="Player")=>{var N;P.current=!1,((N=_.current)==null?void 0:N.readyState)===WebSocket.OPEN?_.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:L,playerName:G})):(sessionStorage.setItem("pending_invite_game",L),sessionStorage.setItem("pending_invite_name",G),c())},[c]),v=H.useCallback(()=>{P.current=!1,yt();const L=Ka(),G={...at(),gameId:L,players:[za(1)]};return f.current=!0,setTimeout(()=>{var N;((N=_.current)==null?void 0:N.readyState)===WebSocket.OPEN&&(_.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:L})),_.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe})))},re.DECK_SYNC_DELAY),{gameId:L,initialState:G}},[P,f]),D=H.useCallback(()=>{var L;((L=_.current)==null?void 0:L.readyState)===WebSocket.OPEN&&_.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[_]),b=H.useCallback((L,G,N,M)=>{var q;if(L.current)return;P.current=!0;const $=t.current.gameId,F=r.current;$&&G.current&&N($);try{M(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),m.info("[exitGame] Cleared WebRTC persistence data")}catch(Z){m.warn("[exitGame] Failed to clear WebRTC data:",Z)}a(at()),n(null),yt(),_.current&&(_.current.onclose=null),((q=_.current)==null?void 0:q.readyState)===WebSocket.OPEN&&$&&F!==null&&_.current.send(JSON.stringify({type:"EXIT_GAME",gameId:$,playerId:F})),_.current&&_.current.close(),setTimeout(()=>{P.current=!1,c()},re.RECONNECT_DELAY)},[t,r,P,a,n,_,c]);return{ws:_,reconnectTimeoutRef:p,connectWebSocket:c,forceReconnect:u,createGame:v,joinGame:w,joinAsInvite:R,exitGame:b,requestGamesList:D}}const Xe=new Map,Oi=(e={})=>{const{abilityMode:t,setAbilityMode:r}=e,[a,n]=H.useState(at()),i=H.useRef(at()),o=H.useCallback(I=>{n(te=>{const Q=typeof I=="function"?I(te):I;return i.current=te,Oe()&&j.current&&setTimeout(()=>{Y.current&&(Y.current.broadcastGameState(Q),m.debug(`[setGameStateWithDelta] Broadcast state: phase=${Q.currentPhase}, round=${Q.currentRound}`))},0),Q})},[]),[s,d]=H.useState(null),l=H.useRef(a),E=H.useRef(s),[g,A]=H.useState(null),[y,P]=H.useState("Connecting"),[T,h]=H.useState([]),[f,S]=H.useState(null),[_,p]=H.useState(null),[c,u]=H.useState(null),[w,R]=H.useState([]),[v,D]=H.useState([]),[b,L]=H.useState([]),[G,N]=H.useState(null),[M,$]=H.useState(!!Fe),[F,q]=H.useState(!1),[Z,X]=H.useState(null),[de,Ee]=H.useState(!1),j=H.useRef(!1),[Ae,Re]=H.useState(!1),[Se,ve]=H.useState(null),Pe=H.useRef(!1),ge=H.useRef(null),We=H.useRef(!1),Lt=H.useRef(!1),ct=H.useRef(),ze=H.useRef(!1),Y=H.useRef(null),ke=H.useRef(()=>{}),xe=Ss({webrtcManagerRef:Y,webrtcIsHostRef:j,setWebrtcIsHost:Ee,setConnectionStatus:P,setWebrtcHostId:X,gameStateRef:l,localPlayerIdRef:E}),{initializeWebrtcHost:Ve,connectAsGuest:Qe,sendWebrtcAction:et,requestDeckView:cr,sendFullDeckToHost:tt}=xe,lt=Ds({gameStateRef:l,localPlayerIdRef:E,setGameState:n,setLocalPlayerId:d,setConnectionStatus:P,setGamesList:h,setLatestHighlight:S,setLatestNoTarget:u,setLatestDeckSelections:R,setLatestHandCardSelections:D,setClickWaves:L,setLatestFloatingTexts:p,setRemoteValidTargets:N,isManualExitRef:We,joiningGameIdRef:ge,playerTokenRef:ct,receivedServerStateRef:ze,isJoinAttemptRef:Lt}),{ws:Te,reconnectTimeoutRef:ut,connectWebSocket:lr,forceReconnect:qa,joinGame:ur,joinAsInvite:ja,requestGamesList:Va}=lt;H.useEffect(()=>{ke.current=o},[o]),H.useEffect(()=>{j.current=de},[de]),H.useEffect(()=>{const I=Oe();if(q(I),I){Y.current=as();const te=Y.current.on(Q=>{an(Q)});return()=>{te()}}},[]),H.useEffect(()=>{if(!Oe())return;const te=window.location.hash.slice(1);if(te&&new URLSearchParams(te).get("hostId"))return;const Q="webrtc_auto_restore_attempted";if(sessionStorage.getItem(Q))return;sessionStorage.setItem(Q,"true");const ee=Ho();if(ee==="none"){sessionStorage.removeItem(Q);return}setTimeout(async()=>{var ie,ne;if(!Y.current){m.warn("[Auto-restore] WebRTC manager not ready");return}try{if(ee==="host"){Be.current=!0,m.info("[Auto-restore] Setting restoration flag to prevent premature exit");const le=Na(),V=Ia();if(!le||!V){m.warn("[Auto-restore] Missing host data or state data"),rt(),Be.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}m.info(`[Auto-restore] Restoring host session: old peerId=${le.peerId}`);const Ie=await Y.current.initializeAsHost();j.current=!0,Ee(!0),X(Ie),P("Connected"),(ie=V.gameState)!=null&&ie.gameId&&(Qt(Ie,V.gameState.gameId),m.info(`[Auto-restore] Broadcasted NEW host peerId ${Ie} for game ${V.gameState.gameId}`)),(V.gameState||V.localPlayerId!==null)&&(V.gameState&&(l.current=V.gameState),V.localPlayerId!==null&&(E.current=V.localPlayerId),Pe.current=!0,setTimeout(()=>{Pe.current=!1},1e4),setTimeout(()=>{var we;V.gameState&&(n(V.gameState),m.info(`[Auto-restore] Restored game state with ${((we=V.gameState.players)==null?void 0:we.length)||0} players, gameId=${V.gameState.gameId}`)),V.localPlayerId!==null&&(d(V.localPlayerId),m.info(`[Auto-restore] Restored local player ID: ${V.localPlayerId}`))},0)),setTimeout(()=>{if(Be.current=!1,m.info("[Auto-restore] Cleared restoration flag"),Y.current&&V.gameState){const we=V.gameState.players.filter(Me=>!Me.isDummy&&Me.id!==V.localPlayerId);we.length>0&&(m.info(`[Auto-restore] Requesting deck data from ${we.length} guest players`),Y.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:Y.current.getPeerId(),timestamp:Date.now()}))}},500),m.info("[Auto-restore] Host session restoration initiated")}else if(ee==="guest"){Be.current=!0,m.info("[Auto-restore] Setting restoration flag to prevent premature exit");const le=Ma(),V=Ia();if(!le||!V){m.warn("[Auto-restore] Missing guest data or state data"),rt(),Be.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}m.info(`[Auto-restore] Restoring guest session: old hostPeerId=${le.hostPeerId}, playerId=${le.playerId}`),j.current=!1,Ee(!1),P("Connecting");let Ie=le.hostPeerId;if((ne=V.gameState)!=null&&ne.gameId){const we=Wt(V.gameState.gameId);we&&we.peerId&&(Ie=we.peerId,m.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Ie}`))}if(X(Ie),le.playerId!==null){m.info(`[Auto-restore] Reconnecting as existing player ${le.playerId} to host ${Ie}`);try{await Y.current.initializeAsReconnectingGuest(Ie,le.playerId),P("Connected"),m.info("[Auto-restore] Successfully reconnected to host")}catch(we){m.error("[Auto-restore] Failed to reconnect to host:",we),P("Disconnected"),rt(),m.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),Be.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else m.info("[Auto-restore] Connecting as new player"),await Y.current.initializeAsGuest(Ie),P("Connected");(V.gameState||V.localPlayerId!==null)&&(V.gameState&&(l.current=V.gameState),V.localPlayerId!==null&&(E.current=V.localPlayerId),Pe.current=!0,setTimeout(()=>{Pe.current=!1},1e4),setTimeout(()=>{var we,Me;if(V.gameState&&(n(V.gameState),m.info(`[Auto-restore] Restored game state with ${((we=V.gameState.players)==null?void 0:we.length)||0} players, gameId=${V.gameState.gameId}, isGameStarted=${V.gameState.isGameStarted}`),V.localPlayerId!==null)){const ue=(Me=V.gameState.players)==null?void 0:Me.some(pe=>pe.id===V.localPlayerId);m.info(`[Auto-restore] Player ${V.localPlayerId} exists in restored state: ${ue}`)}V.localPlayerId!==null&&(d(V.localPlayerId),m.info(`[Auto-restore] Restored local player ID: ${V.localPlayerId}`))},0)),setTimeout(()=>{Be.current=!1,m.info("[Auto-restore] Cleared restoration flag")},100),m.info("[Auto-restore] Guest session restoration initiated")}}catch(le){m.error("[Auto-restore] Failed to restore session:",le),rt(),Be.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),H.useEffect(()=>{if(!F||!Y.current)return;const I=window.location.hash.slice(1);if(!I)return;const Q=new URLSearchParams(I).get("hostId");Q&&Qe(Q)},[F]),H.useEffect(()=>{l.current=a},[a]),H.useEffect(()=>{E.current=s},[s]),H.useEffect(()=>{if(!a||!a.players||!s)return;const I=Lo(a.players,s);Mo.preloadMany(I,"low")},[a==null?void 0:a.players,s]);const Ja=ps({ws:Te,webrtcManager:Y,gameStateRef:l,localPlayerIdRef:E,webrtcIsHostRef:j,setLatestHighlight:S,setLatestFloatingTexts:p,setLatestNoTarget:u,setLatestDeckSelections:R,setLatestHandCardSelections:D,setClickWaves:L,setGameState:n}),{triggerHighlight:Xa,triggerFloatingText:fr,triggerNoTarget:Za,triggerDeckSelection:Qa,triggerHandCardSelection:en,syncValidTargets:tn,triggerClickWave:rn}=Ja,Be=H.useRef(!1);H.useEffect(()=>{if(!F||!j.current||!(a!=null&&a.gameId))return;const I=a.gameId,te=()=>{var ie;const ee=(ie=Y.current)==null?void 0:ie.getPeerId();ee&&I&&Qt(ee,I)};te();const Q=setInterval(te,2e3);return()=>clearInterval(Q)},[F,a==null?void 0:a.gameId]),H.useEffect(()=>{if(!F||j.current||!(a!=null&&a.gameId))return;const I=a.gameId,te=ie=>{var ne;X(ie),P("Connecting"),(ne=Y.current)==null||ne.initializeAsReconnectingGuest(ie,E.current||0).then(()=>{P("Connected")}).catch(le=>{m.error("[Guest Auto-Reconnect] Failed to reconnect:",le),P("Disconnected")})},Q=ie=>{const ne=`webrtc_host_${I}`;if(!(ie.key!==ne||!ie.newValue))try{const V=JSON.parse(ie.newValue).peerId;V&&V!==Z&&te(V)}catch(le){m.error("[Guest Auto-Reconnect] Failed to parse storage event:",le)}},ee=setInterval(()=>{const ie=Wt(I);ie&&ie.peerId!==Z&&(m.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${ie.peerId}`),te(ie.peerId))},2e3);return window.addEventListener("storage",Q),()=>{window.removeEventListener("storage",Q),clearInterval(ee)}},[F,a==null?void 0:a.gameId,Z]),H.useEffect(()=>{const I=setInterval(()=>{n(te=>{const Q=Date.now(),ee=te.floatingTexts||[],ie=ee.filter(ne=>Q-ne.timestamp<re.FLOATING_TEXT_DURATION);return ie.length!==ee.length?{...te,floatingTexts:ie}:te})},re.DECK_SYNC_DELAY);return()=>clearInterval(I)},[]);const an=H.useCallback(I=>{var te,Q,ee;switch(I.type){case"peer_open":(te=I.data)!=null&&te.peerId&&(X(I.data.peerId),m.info(`WebRTC peer opened with ID: ${I.data.peerId}`));break;case"guest_connected":m.info("Guest connected via WebRTC:",(Q=I.data)==null?void 0:Q.peerId);break;case"connected_to_host":(ee=I.data)!=null&&ee.hostPeerId&&Z!==I.data.hostPeerId&&(X(I.data.hostPeerId),m.info(`Updated webrtcHostId to: ${I.data.hostPeerId}`)),P("Connected"),Re(!1),ve(null),Pe.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(m.warn("WebRTC peer disconnected"),P("Disconnected"),Re(!0),!j.current&&Z&&a)try{const ie={hostPeerId:Z,playerId:s,gameState:a,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ie)),m.info("[Reconnection] Stored reconnection data before disconnect"),sn(Z)}catch(ie){m.error("[Reconnection] Failed to store data:",ie)}break;case"message_received":on(I.data);break;case"error":m.error("WebRTC error:",I.data);break}},[a,s,Z,de]),nn=H.useCallback((I,te)=>{if(m.info(`[handleWebrtcGuestJoin] Called for guest ${I}, isHost: ${j.current}`),!j.current||!Y.current){m.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const Q=(te==null?void 0:te.preferredDeck)||"Random";n(ee=>{if(!ee)return m.error("[handleWebrtcGuestJoin] No previous state"),ee;m.info(`[handleWebrtcGuestJoin] Current state has ${ee.players.length} players`);const ie=ee.players.map(ue=>ue.id);let ne=1;for(;ie.includes(ne);)ne++;const le={id:ne,name:`Player ${ne}`,color:mt[(ne-1)%mt.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:Q,boardHistory:[],autoDrawEnabled:!0},V={...ee,players:[...ee.players,le]},Ie=ee.board.map(ue=>ue.map(pe=>({...pe,card:pe.card?{id:pe.card.id,baseId:pe.card.baseId,ownerId:pe.card.ownerId,name:pe.card.name,imageUrl:pe.card.imageUrl,power:pe.card.power,ability:pe.card.ability,isFaceDown:pe.card.isFaceDown,statuses:pe.card.statuses||[]}:null}))),we=ue=>ue.map(pe=>({id:pe.id,baseId:pe.baseId,name:pe.name,imageUrl:pe.imageUrl,power:pe.power,powerModifier:pe.powerModifier,ability:pe.ability,ownerId:pe.ownerId,color:pe.color,deck:pe.deck,isFaceDown:pe.isFaceDown,types:pe.types,faction:pe.faction,statuses:pe.statuses}));Y.current.acceptGuestMinimal(I,{playerId:ne,gameId:ee.gameId,isGameStarted:ee.isGameStarted,players:V.players.map(ue=>ue.isDummy?{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,hand:we(ue.hand||[]),deck:we(ue.deck||[]),discard:we(ue.discard||[]),handSize:ue.hand.length,deckSize:ue.deck.length,discardSize:ue.discard.length}:{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,deckSize:ue.deck.length,handSize:ue.hand.length,discardSize:ue.discard.length}),deckSelections:V.players.map(ue=>({id:ue.id,selectedDeck:ue.selectedDeck})),gameMode:ee.gameMode,currentRound:ee.currentRound,currentPhase:ee.currentPhase,activePlayerId:ee.activePlayerId,startingPlayerId:ee.startingPlayerId,activeGridSize:ee.activeGridSize,board:Ie},ne),Y.current.broadcastGameState(V,I),Y.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:Y.current.getPeerId(),data:{playerId:ne,selectedDeck:Q},timestamp:Date.now()});const Me=V.players.find(ue=>ue.id===E.current);if(Me&&Me.deck.length>0){const ue=Me.deck.map(pe=>({id:pe.id,baseId:pe.baseId,power:pe.power,powerModifier:pe.powerModifier||0,isFaceDown:pe.isFaceDown||!1,statuses:pe.statuses||[]}));Y.current.sendToGuest(I,{type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:Me.id,data:{playerId:Me.id,deckType:Me.selectedDeck,deck:ue,deckSize:ue.length},timestamp:Date.now()}),m.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${Me.selectedDeck}, ${ue.length} cards`)}return V})},[]),Gt=H.useCallback(I=>{const te=j.current;if(m.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!Y.current}, webrtcIsHostRef.current=${te}`),!Y.current||!te){m.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}Y.current.broadcastGameState(I)},[]),on=H.useCallback(I=>{var te,Q,ee,ie,ne,le,V,Ie,we,Me,ue,pe,hr,mr,Ir,Er,Tr,gr,wr,_r,br,Ar,Sr,Cr,Dr,Rr,Pr,kr,Or,vr,Nr,Mr,Lr,Gr,xr,Ur,Hr,$r,Fr,Wr,Br,Yr,Kr,zr,qr,jr,Vr,Jr,Xr,Zr,Qr,ea,ta,ra,aa,na,oa,sa,ia,da,ca,la,ua,fa,pa,ya;if(!(!I||!I.type))switch(m.info(`[handleWebrtcMessage] Received: ${I.type}`),I.type){case"JOIN_ACCEPT_MINIMAL":if(m.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${I.playerId}`),I.data){const C=I.data;m.info(`[handleWebrtcMessage] Creating minimal state with ${((te=C.players)==null?void 0:te.length)||0} players`);const k={gameId:C.gameId||Ka(),isGameStarted:C.isGameStarted||!1,isPrivate:!1,activeGridSize:C.activeGridSize||4,gameMode:C.gameMode||er.FreeForAll,dummyPlayerCount:0,players:((Q=C.players)==null?void 0:Q.map(O=>{if((O.isDummy||!1)&&O.hand&&O.deck&&O.discard)return{id:O.id,name:O.name,color:O.color,isDummy:!0,isReady:O.isReady||!1,score:O.score||0,hand:O.hand||[],deck:O.deck||[],discard:O.discard||[],announcedCard:null,selectedDeck:O.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const B=[],x=[],K=[];for(let U=0;U<(O.handSize||0);U++)B.push({id:`placeholder_${O.id}_hand_${U}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});for(let U=0;U<(O.deckSize||0);U++)x.push({id:`placeholder_${O.id}_deck_${U}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});for(let U=0;U<(O.discardSize||0);U++)K.push({id:`placeholder_${O.id}_discard_${U}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});return{id:O.id,name:O.name,color:O.color,isDummy:!1,isReady:O.isReady||!1,score:O.score||0,hand:B,deck:x,discard:K,announcedCard:null,selectedDeck:O.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:C.board||La(),hostId:1,currentPhase:C.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:C.currentRound||1,turnNumber:C.turnNumber||1,activePlayerId:C.activePlayerId??null,startingPlayerId:C.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};n(k),I.playerId!==void 0&&(d(I.playerId),m.info(`[handleWebrtcMessage] Set local player ID to ${I.playerId}`)),n(O=>{const W=O.players.map(B=>{var K;const x=(K=C.players)==null?void 0:K.find(U=>U.id===B.id);if(B.id===I.playerId){const z=B.deck.length===0||B.deck.some(J=>J.isPlaceholder)||B.deck.length!==30;if(x!=null&&x.selectedDeck&&z){const J=Ze(x.selectedDeck,B.id,B.name);m.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${J.length} cards from ${x.selectedDeck}`),Y.current&&J.length>0&&setTimeout(()=>{const fe=J.map(oe=>({id:oe.id,baseId:oe.baseId,power:oe.power,powerModifier:oe.powerModifier||0,isFaceDown:oe.isFaceDown||!1,statuses:oe.statuses||[]}));Y.current.sendAction("DECK_DATA_UPDATE",{playerId:I.playerId,deck:fe,deckSize:fe.length}),m.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${x.selectedDeck}, ${fe.length} cards`)},0);const ae=[...B.hand],ce=[...J];if(C.isGameStarted&&ae.length===0&&ce.length>0){for(let oe=0;oe<6&&oe<ce.length;oe++){const _e=ce[0];ce.splice(0,1),ae.push(_e)}m.info(`[JOIN_ACCEPT_MINIMAL] Drew ${ae.length} cards, deck now has ${ce.length} cards`)}return{...B,deck:ce,hand:ae,selectedDeck:x.selectedDeck}}}return B});return{...O,players:W}});try{const O=(ee=Y.current)==null?void 0:ee.getHostPeerId();O&&Ft({hostPeerId:O,playerId:I.playerId,playerName:((ie=k.players.find(W=>W.id===I.playerId))==null?void 0:ie.name)||null,isHost:!1})}catch(O){m.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",O)}}break;case"JOIN_ACCEPT":if(m.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${I.playerId}, hasState: ${!!((ne=I.data)!=null&&ne.gameState)}`),(le=I.data)!=null&&le.gameState){const C=I.data.gameState;if(m.info(`[handleWebrtcMessage] Setting game state with ${((V=C.players)==null?void 0:V.length)||0} players`),n(C),I.playerId!==void 0){d(I.playerId),m.info(`[handleWebrtcMessage] Set local player ID to ${I.playerId}`);try{const k=(Ie=Y.current)==null?void 0:Ie.getHostPeerId(),O=C.players.find(W=>W.id===I.playerId);k&&Ft({hostPeerId:k,playerId:I.playerId,playerName:(O==null?void 0:O.name)||null,isHost:!1})}catch(k){m.warn("[JOIN_ACCEPT] Failed to save guest data:",k)}}}break;case"JOIN_ACCEPT_BINARY":if(m.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${I.playerId}`),I.data instanceof Uint8Array)try{const C=Vo(I.data),k=C;if(m.info(`[handleWebrtcMessage] Expanded binary state with ${((we=k.players)==null?void 0:we.length)||0} players`),n(k),I.playerId!==void 0){d(I.playerId),m.info(`[handleWebrtcMessage] Set local player ID to ${I.playerId}`);try{const O=(Me=Y.current)==null?void 0:Me.getHostPeerId(),W=k.players.find(B=>B.id===I.playerId);O&&Ft({hostPeerId:O,playerId:I.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(O){m.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",O)}}m.info(`[handleWebrtcMessage] Received optimized binary game state: ${I.data.byteLength} bytes`)}catch(C){m.error("[handleWebrtcMessage] Failed to deserialize binary game state:",C)}break;case"STATE_UPDATE_COMPACT":if(j.current){if(I.senderId&&I.senderId!==((ue=Y.current)==null?void 0:ue.getPeerId())&&(m.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${I.senderId}`),(pe=I.data)!=null&&pe.gameState)){const C=I.data.gameState;n(k=>{const O=I.playerId;if(O===void 0)return m.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),k;const W=k.players.map(K=>{if(K.id===O){const U=C.players.find(z=>z.id===O);if(U){const z=fe=>{const oe=Ye(fe.baseId);return oe?{...oe,id:fe.id,baseId:fe.baseId,ownerId:O,power:fe.power,powerModifier:fe.powerModifier,isFaceDown:fe.isFaceDown,statuses:fe.statuses||[]}:{id:fe.id,baseId:fe.baseId,name:"Unknown",power:0}},J=(U.handCards||[]).map(z),ae=(U.deckCards||[]).map(z),ce=(U.discardCards||[]).map(z);return m.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${O}: hand=${J.length}, deck=${ae.length}, discard=${ce.length}, score=${U.score||0}`),{...K,hand:J,deck:ae,discard:ce,handSize:J.length,deckSize:ae.length,discardSize:ce.length,score:U.score||K.score}}}else{const U=C.players.find(z=>z.id===K.id);if(U&&(U.handCards||[]).length>0&&K.hand){const z=U.handCards||[],J=K.hand.map(ae=>{const ce=z.find(fe=>fe.id===ae.id);return ce&&ce.statuses?{...ae,statuses:ce.statuses,isFaceDown:ce.isFaceDown}:ae});return{...K,hand:J,handSize:J.length}}}return K}),B=C.board?C.board.map(K=>K.map(U=>{if(!U||!U.card)return U;const z=Ye(U.card.baseId||U.card.id);if(z){const J=U.card.ownerId;return{...U,card:{...z,id:U.card.id,baseId:U.card.baseId||U.card.id,ownerId:J,ownerName:U.card.ownerName,power:U.card.power,powerModifier:U.card.powerModifier,isFaceDown:U.card.isFaceDown||!1,statuses:U.card.statuses||[],enteredThisTurn:U.card.enteredThisTurn,deck:U.card.deck}}}return U})):k.board,x={...k,...C,players:W,board:B};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(x,I.senderId)},0),x})}}else if(!j.current&&((hr=I.data)!=null&&hr.gameState)){const C=I.data.recipientPlayerId??null,k=I.data.gameState;if(Pe.current){n(O=>({...O,currentPhase:k.currentPhase,activePlayerId:k.activePlayerId,startingPlayerId:k.startingPlayerId,isReadyCheckActive:k.isReadyCheckActive,isGameStarted:k.isGameStarted}));return}n(O=>{const W=C===null||C===E.current;m.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${C}, local=${E.current}, isForLocal=${W}`);const B=k.players.map(U=>{var J,ae;const z=O.players.find(ce=>ce.id===U.id);if(U.id===E.current&&z){const ce=oe=>{if(oe.baseId){const be=Ye(oe.baseId);if(be)return{...be,id:oe.id,ownerId:E.current,power:oe.power,powerModifier:oe.powerModifier,isFaceDown:oe.isFaceDown,statuses:oe.statuses||[]}}return z.hand.find(be=>be.id===oe.id)||z.deck.find(be=>be.id===oe.id)||z.discard.find(be=>be.id===oe.id)||{id:oe.id,name:"Unknown",power:0}};if(U.handCards&&U.handCards.length>0||U.deckCards&&U.deckCards.length>0||U.discardCards&&U.discardCards.length>0){const oe=(U.handCards||[]).map(ce),_e=(U.deckCards||[]).map(ce),be=(U.discardCards||[]).map(ce);return oe.forEach((he,ye)=>{var se,Le;(Le=(se=U.handCards)==null?void 0:se[ye])!=null&&Le.baseId&&!he.baseId&&(he.baseId=U.handCards[ye].baseId)}),_e.forEach((he,ye)=>{var se,Le;(Le=(se=U.deckCards)==null?void 0:se[ye])!=null&&Le.baseId&&!he.baseId&&(he.baseId=U.deckCards[ye].baseId)}),be.forEach((he,ye)=>{var se,Le;(Le=(se=U.discardCards)==null?void 0:se[ye])!=null&&Le.baseId&&!he.baseId&&(he.baseId=U.discardCards[ye].baseId)}),m.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${oe.length} hand, ${_e.length} deck, ${be.length} discard`),{...U,hand:oe,deck:_e,discard:be}}else{const oe=(U.handIds||[]).map(he=>z.hand.find(se=>se.id===he)||z.deck.find(se=>se.id===he)||z.discard.find(se=>se.id===he)||{id:he,name:"?",isPlaceholder:!1}),_e=(U.deckIds||[]).map(he=>z.deck.find(se=>se.id===he)||z.hand.find(se=>se.id===he)||z.discard.find(se=>se.id===he)||{id:he,name:"?",isPlaceholder:!1}),be=(U.discardIds||[]).map(he=>z.discard.find(se=>se.id===he)||z.hand.find(se=>se.id===he)||z.deck.find(se=>se.id===he)||{id:he,name:"?",isPlaceholder:!1});return m.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${oe.length} hand, ${_e.length} deck, ${be.length} discard`),{...U,hand:oe,deck:_e,discard:be}}}else{const ce=U.deckSize??((J=U.deck)==null?void 0:J.length)??0,fe=U.handSize??((ae=U.hand)==null?void 0:ae.length)??0,oe=U.deckCards&&U.deckCards.length>0;let _e;if(oe){const ye=se=>{if(se.baseId){const Le=Ye(se.baseId);if(Le)return{...Le,id:se.id,baseId:se.baseId,ownerId:U.id,power:se.power,powerModifier:se.powerModifier,isFaceDown:se.isFaceDown,statuses:se.statuses||[]}}return{id:se.id,name:"Unknown",power:0}};_e=U.deckCards.map(ye),m.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${U.id}: ${_e.length} cards`)}else if(z&&z.deck.length>0&&z.deck.some(se=>!se.isPlaceholder))_e=z.deck.slice(0,ce),m.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${U.id}: ${_e.length} cards`);else{_e=[];for(let se=0;se<ce;se++)_e.push({id:`placeholder_${U.id}_deck_${se}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color})}const be=(ye,se)=>{if(ye.baseId&&!ye.isPlaceholder&&!ye.isCardBack){const Le=Ye(ye.baseId);if(Le)return{...Le,id:ye.id,baseId:ye.baseId,ownerId:U.id,power:ye.power,powerModifier:ye.powerModifier||0,isFaceDown:ye.isFaceDown||!1,statuses:ye.statuses||[]}}return{id:ye.id||`placeholder_${U.id}_hand_${se}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color}};let he;if(U.hand&&U.hand.length>0){he=U.hand.map((se,Le)=>be(se,Le));const ye=he.filter(se=>!se.isPlaceholder).length;ye>0&&m.info(`[STATE_UPDATE_COMPACT] Reconstructed ${ye}/${he.length} revealed hand cards for player ${U.id}`)}else{he=[];for(let ye=0;ye<fe;ye++)he.push({id:`placeholder_${U.id}_hand_${ye}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color})}return{...U,hand:he,deck:_e,discard:(z==null?void 0:z.discard)||[]}}}),x=k.board?k.board.map(U=>U.map(z=>{if(!z||!z.card)return z;const J=Ye(z.card.baseId||z.card.id);return J?{...z,card:{...J,id:z.card.id,baseId:z.card.baseId||z.card.id,ownerId:z.card.ownerId,ownerName:z.card.ownerName,power:z.card.power,powerModifier:z.card.powerModifier,isFaceDown:z.card.isFaceDown||!1,statuses:z.card.statuses||[],enteredThisTurn:z.card.enteredThisTurn,deck:z.card.deck}}:z})):O.board,K=Ne({...k,players:B,board:x});return{...k,players:B,board:K}})}break;case"STATE_UPDATE":if(j.current&&I.senderId&&I.senderId!==((mr=Y.current)==null?void 0:mr.getPeerId())){if(m.info(`[STATE_UPDATE] Host received state from guest ${I.senderId}`),(Ir=I.data)!=null&&Ir.gameState){const C=I.data.gameState;n(k=>{const O=I.playerId;if(O===void 0)return m.warn("[STATE_UPDATE] Guest state missing playerId"),k;const W=k.players.map(K=>{if(K.id===O){const U=C.players.find(z=>z.id===O);if(U){const z=oe=>({...oe,ownerId:O}),J=(U.hand||[]).map(z),ae=(U.deck||[]).map(z),ce=(U.discard||[]).map(z);m.info(`[STATE_UPDATE] Merging guest ${O} state: hand=${J.length}, deck=${ae.length}, discard=${ce.length}`);const fe={...K,hand:J,deck:ae,discard:ce,handSize:J.length,deckSize:ae.length,discardSize:ce.length};return m.info(`[STATE_UPDATE] After merge - player ${O}: deckSize=${fe.deckSize}, handSize=${fe.handSize}`),fe}}return K}),B=C.board?C.board.map(K=>K.map(U=>!U||!U.card?U:{...U,card:{...U.card,ownerId:U.card.ownerId}})):k.board,x={...k,players:W,board:B};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(x,I.senderId)},0),x})}break}if(ze.current=!0,(Er=I.data)!=null&&Er.gameState){const C=I.data.gameState;if(Pe.current){n(k=>({...k,currentPhase:C.currentPhase,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,isReadyCheckActive:C.isReadyCheckActive,isGameStarted:C.isGameStarted}));return}n(k=>{var B;const O=C.players.map(x=>{var U,z,J;const K=k.players.find(ae=>ae.id===x.id);if(x.id===E.current&&K){const ae=K.hand.every(fe=>fe.isPlaceholder)||K.hand.length===0,ce=x.handSize??((U=x.hand)==null?void 0:U.length)??0;if(ae&&x.hand&&x.hand.length>0)return{...x,hand:x.hand,deck:x.deck||K.deck,discard:x.discard||K.discard};{let fe=K.hand,oe=K.deck;if(ce>K.hand.length&&oe.length>0){const _e=ce-K.hand.length,be=[...K.hand],he=[...K.deck];for(let ye=0;ye<_e&&ye<he.length;ye++){const se=he[0];he.splice(0,1),be.push(se)}fe=be,oe=he}return{...x,hand:fe,deck:oe,discard:x.discard||K.discard}}}else{if(x.isDummy||!1)return m.info(`[STATE_UPDATE] Using real cards for dummy player ${x.id}`),{...x,hand:x.hand||[],deck:x.deck||[],discard:x.discard||[]};const ce=x.deckSize??((z=x.deck)==null?void 0:z.length)??0,fe=x.handSize??((J=x.hand)==null?void 0:J.length)??0;m.info(`[STATE_UPDATE] Player ${x.id}: deckSize=${ce}, handSize=${fe}`);const oe=[];for(let be=0;be<ce;be++)oe.push({id:`placeholder_${x.id}_deck_${be}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const _e=[];for(let be=0;be<fe;be++)_e.push({id:`placeholder_${x.id}_hand_${be}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});return m.info(`[STATE_UPDATE] Created ${oe.length} deck placeholders and ${_e.length} hand placeholders for player ${x.id}`),{...x,hand:_e,deck:oe,discard:x.discard||[]}}}),W={...C,players:O};if(!j.current)try{((B=Y.current)==null?void 0:B.getHostPeerId())&&E.current!==null&&(It({gameState:W,localPlayerId:E.current,isHost:!1}),m.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(x){m.warn("[STATE_UPDATE] Failed to persist guest state:",x)}return W})}break;case"RECONNECT_SNAPSHOT":if(ze.current=!0,I.data){const C=I.data;n(k=>{const O=E.current,W=C.players.map(x=>{const K=k.players.find(ae=>ae.id===x.id);if(x.id===O&&K&&K.hand.some(ce=>!ce.isPlaceholder)){let ce=[...K.hand];const fe=[...K.deck];if(x.handSize>ce.length){const oe=x.handSize-ce.length;for(let _e=0;_e<oe&&fe.length>0;_e++)ce.push(fe.shift())}else x.handSize<ce.length&&(ce=ce.slice(0,x.handSize));return{...x,hand:ce,deck:fe,discard:K.discard}}const U=[];for(let ae=0;ae<x.handSize;ae++)U.push({id:`placeholder_${x.id}_hand_${ae}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const z=[];for(let ae=0;ae<x.deckSize;ae++)z.push({id:`placeholder_${x.id}_deck_${ae}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const J=[];for(let ae=0;ae<x.discardSize;ae++)J.push({id:`placeholder_${x.id}_discard_${ae}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});return{...x,hand:U,deck:z,discard:J}}),B={gameId:C.gameId,gameMode:C.gameMode,isPrivate:C.isPrivate,isGameStarted:C.isGameStarted,isReadyCheckActive:C.isReadyCheckActive,activeGridSize:C.activeGridSize,currentPhase:C.currentPhase,isScoringStep:C.isScoringStep,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,currentRound:C.currentRound,turnNumber:C.turnNumber,roundWinners:C.roundWinners||{},gameWinner:C.gameWinner,isRoundEndModalOpen:C.isRoundEndModalOpen,dummyPlayerCount:C.dummyPlayerCount,players:W,board:C.board,spectators:k.spectators,hostId:k.hostId,revealRequests:k.revealRequests,preserveDeployAbilities:k.preserveDeployAbilities,highlights:k.highlights,floatingTexts:k.floatingTexts,targetingMode:k.targetingMode,abilityMode:k.abilityMode};if(!j.current&&O!==null)try{It({gameState:B,localPlayerId:O,isHost:!1}),m.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(x){m.warn("[RECONNECT_SNAPSHOT] Failed to save state:",x)}return m.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${B.currentPhase}, players=${B.players.length}`),B})}break;case"STATE_DELTA":if(j.current||(ze.current=!0),m.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${j.current}, senderId: ${I.senderId}`),(Tr=I.data)!=null&&Tr.delta){const C=I.data.delta;m.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((gr=C.boardCells)==null?void 0:gr.length)||0}, phaseDelta=${!!C.phaseDelta}`),C.boardCells&&C.boardCells.length>0&&C.boardCells.forEach(k=>{var O,W;m.info(`[STATE_DELTA] Board cell [${k.row},${k.col}]: card=${((O=k.card)==null?void 0:O.name)||"(empty)"}, owner=${(W=k.card)==null?void 0:W.ownerId}`)}),j.current&&I.senderId&&Y.current&&(m.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${I.senderId} to other guests`),Y.current.broadcastStateDelta(C,I.senderId)),C.phaseDelta&&m.info("[STATE_DELTA] phaseDelta:",JSON.stringify(C.phaseDelta)),C.playerDeltas&&Object.entries(C.playerDeltas).forEach(([k,O])=>{m.info(`[STATE_DELTA] Player ${k} delta: handSizeDelta=${O.handSizeDelta}, deckSizeDelta=${O.deckSizeDelta}`)}),n(k=>{const O=E.current||k.localPlayerId;m.info(`[STATE_DELTA] Applying delta with localPlayerId=${O}, currentPhase before=${k.currentPhase}`);const W=jt(k);m.info(`[STATE_DELTA] Applying delta with localPlayerId=${O}, currentPhase after=${W.currentPhase}`);try{W.gameId&&O!==null&&(It({gameState:W,localPlayerId:O,isHost:j.current}),m.debug(`[STATE_DELTA] Saved state for ${j.current?"host":"guest"} auto-restore`))}catch(B){m.warn("[STATE_DELTA] Failed to persist state:",B)}return W})}break;case"STATE_DELTA_BINARY":{j.current||(ze.current=!0),m.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${j.current}, senderId: ${I.senderId}, dataType=${(_r=(wr=I.data)==null?void 0:wr.constructor)==null?void 0:_r.name}, typeof=${typeof I.data}`);let C=null;if(I.data instanceof Uint8Array)try{C=Fa(I.data),C&&m.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((br=C.boardCells)==null?void 0:br.length)||0}`)}catch(k){m.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",k)}else if(typeof I.data=="string")try{C=Xo(I.data),C&&m.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${I.data.length} chars): playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Ar=C.boardCells)==null?void 0:Ar.length)||0}, phaseDelta=${!!C.phaseDelta}`)}catch(k){m.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",k)}else m.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof I.data}, constructor: ${(Cr=(Sr=I.data)==null?void 0:Sr.constructor)==null?void 0:Cr.name}`);C&&(j.current&&I.senderId&&Y.current&&(m.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${I.senderId} to other guests`),Y.current.broadcastStateDelta(C,I.senderId)),n(k=>{const O=E.current||k.localPlayerId;m.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${O}, currentPhase before=${k.currentPhase}`);const W=jt(k);m.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${W.currentPhase}, board has ${W.board.flat().filter(B=>B==null?void 0:B.card).length} cards`);try{W.gameId&&O!==null&&(It({gameState:W,localPlayerId:O,isHost:j.current}),m.debug(`[STATE_DELTA_BINARY] Saved state for ${j.current?"host":"guest"} auto-restore`))}catch(B){m.warn("[STATE_DELTA_BINARY] Failed to persist state:",B)}return W}));break}case"CARD_STATE":if(typeof I.data=="string")try{const C=atob(I.data),k=new Uint8Array(C.length);for(let O=0;O<C.length;O++)k[O]=C.charCodeAt(O);n(O=>pt(2,k,O,E.current||O.localPlayerId).gameState)}catch(C){m.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",C)}else I.data instanceof Uint8Array&&n(C=>pt(2,I.data,C,E.current||C.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof I.data=="string")try{const C=atob(I.data),k=new Uint8Array(C.length);for(let O=0;O<C.length;O++)k[O]=C.charCodeAt(O);n(O=>{const{gameState:W}=pt(3,k,O,E.current||O.localPlayerId);return W})}catch(C){m.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",C)}else I.data instanceof Uint8Array&&n(C=>{const{gameState:k}=pt(3,I.data,C,E.current||C.localPlayerId);return k});break;case"SESSION_EVENT":if(typeof I.data=="string")try{const C=atob(I.data),k=new Uint8Array(C.length);for(let O=0;O<C.length;O++)k[O]=C.charCodeAt(O);n(O=>pt(4,k,O,E.current||O.localPlayerId).gameState)}catch(C){m.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",C)}else I.data instanceof Uint8Array&&n(C=>pt(4,I.data,C,E.current||C.localPlayerId).gameState);break;case"JOIN_REQUEST":m.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${I.senderId}, isHost: ${j.current}`),j.current&&I.senderId?(m.info(`Host received JOIN_REQUEST from ${I.senderId}, data:`,I.data),nn(I.senderId,I.data)):m.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${j.current}, senderId: ${I.senderId}`);break;case"ACTION":if(j.current&&I.data){const{actionType:C,actionData:k}=I.data;if(C==="STATE_UPDATE"&&(k!=null&&k.gameState)){if(Pe.current){Y.current&&I.senderId&&Y.current.sendToGuest(I.senderId,{type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:l.current},timestamp:Date.now()});break}n(O=>{const W=k.gameState,B=W.players.map(K=>{const U=O.players.find(z=>z.id===K.id);return U&&K.id!==E.current?{...K,deck:U.deck||K.deck,discard:U.discard||K.discard,score:U.score}:K}),x={...W,players:B};return Y.current&&Y.current.broadcastToGuests({type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:x},timestamp:Date.now()}),x})}else if(C==="STATE_DELTA"&&(k!=null&&k.delta))n(O=>{const W=k.delta;let B=W;Pe.current&&W.playerDeltas&&(B={...W,playerDeltas:Object.fromEntries(Object.entries(W.playerDeltas).map(([K,U])=>{const z={...U};return delete z.scoreDelta,[K,z]}))}),E.current||O.localPlayerId;const x=jt(O);return Y.current&&Y.current.broadcastStateDelta(B),x});else if(C==="NEXT_PHASE")n(O=>{const W=O,B=W.currentPhase,x=B===2&&!W.isScoringStep,K=B+1;return{...W,currentPhase:K,...x&&{isScoringStep:!0}}});else if(C==="PREV_PHASE")n(O=>{const W=O;return W.isScoringStep?{...W,isScoringStep:!1,currentPhase:Math.max(1,W.currentPhase-1)}:{...W,currentPhase:Math.max(1,W.currentPhase-1)}});else if(C==="SET_PHASE"&&(k==null?void 0:k.phaseIndex)!==void 0)n(O=>({...O,currentPhase:k.phaseIndex}));else if(C==="UPDATE_PLAYER_NAME"&&(k==null?void 0:k.playerId)!==void 0&&(k==null?void 0:k.name)!==void 0)n(O=>({...O,players:O.players.map(W=>W.id===k.playerId?{...W,name:k.name}:W)}));else if(C==="CHANGE_PLAYER_COLOR"&&(k==null?void 0:k.playerId)!==void 0&&(k==null?void 0:k.color)!==void 0){const O=k.playerId,W=k.color;n(B=>{const x={...B,players:B.players.map(K=>K.id===O?{...K,color:W}:K)};return Y.current&&Y.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:Y.current.getPeerId(),data:{playerId:O,color:W},timestamp:Date.now()}),x})}else if(C==="UPDATE_PLAYER_SCORE"&&(k==null?void 0:k.playerId)!==void 0&&(k==null?void 0:k.delta)!==void 0){const O=k.playerId,W=k.delta;n(B=>{const x={...B,players:B.players.map(K=>K.id===O?{...K,score:Math.max(0,K.score+W)}:K)};return Y.current&&Y.current.broadcastToGuests({type:"UPDATE_PLAYER_SCORE",senderId:Y.current.getPeerId(),data:{playerId:O,delta:W},timestamp:Date.now()}),x})}else if(C==="CHANGE_PLAYER_DECK"&&(k==null?void 0:k.playerId)!==void 0){const O=k.playerId,W=k.deckType,B=k.deck;n(x=>{const K=x.players.find(J=>J.id===O);if(!K)return x;let U;B&&B.length>0?(m.info(`[CHANGE_PLAYER_DECK] Host received ${B.length} cards for player ${O}`),U=B.map(J=>{if(J.baseId){const ae=Ye(J.baseId);if(ae)return{...ae,id:J.id,baseId:J.baseId,deck:W,ownerId:O,ownerName:K.name,power:J.power,powerModifier:J.powerModifier||0,isFaceDown:J.isFaceDown||!1,statuses:J.statuses||[]}}return{id:J.id,baseId:J.id,name:"Unknown",deck:W,ownerId:O,ownerName:K.name,power:J.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(U=Ze(W,O,K.name),m.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${O} with ${U.length} cards from ${W}`));const z={...x,players:x.players.map(J=>J.id===O?{...J,selectedDeck:W,deck:U,hand:[],discard:[],announcedCard:null,boardHistory:[]}:J)};if(Y.current){const J=U.map(ae=>({id:ae.id,baseId:ae.baseId,power:ae.power,powerModifier:ae.powerModifier||0,isFaceDown:ae.isFaceDown||!1,statuses:ae.statuses||[]}));Y.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:O,data:{playerId:O,deckType:W,deck:J,deckSize:J.length},timestamp:Date.now()})}return z})}else if(C==="TOGGLE_ACTIVE_PLAYER"&&(k==null?void 0:k.playerId)!==void 0)n(O=>{if(!O.players.find(x=>x.id===k.playerId))return O;const B=Ba(O,k.playerId);return Y.current&&Y.current.broadcastGameState(B),B});else if(C==="TOGGLE_AUTO_DRAW"&&(k==null?void 0:k.playerId)!==void 0)n(O=>({...O,players:O.players.map(W=>W.id===k.playerId?{...W,autoDrawEnabled:!W.autoDrawEnabled}:W)}));else if(C==="START_NEXT_ROUND")n(O=>({...O,isRoundEndModalOpen:!1,currentRound:(O.currentRound||1)+1,players:O.players.map(W=>({...W,score:0}))}));else if(C==="RESET_DEPLOY_STATUS")n(O=>{const W=O.board.map(B=>B.map(x=>{var K;return(K=x.card)!=null&&K.statuses?{...x,card:{...x.card,statuses:x.card.statuses.filter(U=>U.type!=="DeployAbilityUsed")}}:x}));return{...O,board:W,preserveDeployAbilities:!1}});else if(C==="DECK_DATA_UPDATE"&&(k==null?void 0:k.playerId)!==void 0&&(k!=null&&k.deck)){const O=k.playerId,W=k.deck,B=k.deckSize;m.info(`[ACTION] DECK_DATA_UPDATE: Received ${W.length} cards for guest ${O}`),n(x=>({...x,players:x.players.map(K=>K.id===O?{...K,deck:[...W],deckSize:B||W.length}:K)}))}else m.warn(`[ACTION] Unknown action type: ${C}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(m.info(`[PLAYER_RECONNECT] Guest ${I.playerId} reconnecting from ${I.senderId}`),j.current&&I.playerId!==void 0&&I.senderId){const C=l.current;if(m.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(C!=null&&C.gameId)}, gameId=${C==null?void 0:C.gameId}, hasPlayers=${((Dr=C==null?void 0:C.players)==null?void 0:Dr.length)||0}`),C&&C.gameId){m.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${I.playerId}`);const k=is(C,I.playerId);(Rr=Y.current)==null||Rr.sendToGuest(I.senderId,{type:"RECONNECT_SNAPSHOT",senderId:Y.current.getPeerId(),data:k.data,timestamp:Date.now()}),m.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${I.playerId}`)}else m.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((Pr=I.data)==null?void 0:Pr.isReadyCheckActive)!==void 0||((kr=I.data)==null?void 0:kr.isPrivate)!==void 0)&&n(C=>({...C,isReadyCheckActive:I.data.isReadyCheckActive??!0,isPrivate:I.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((Or=I.data)==null?void 0:Or.isReadyCheckActive)!==void 0&&n(C=>({...C,isReadyCheckActive:I.data.isReadyCheckActive}));break;case"PLAYER_READY":j.current&&I.playerId!==void 0?n(C=>{const k=C.players.map(x=>x.id===I.playerId?{...x,isReady:!0}:x),O={...C,players:k};m.info(`Player ${I.playerId} is ready via WebRTC`),Y.current&&(Y.current.broadcastGameState(O),m.info(`[PLAYER_READY] Broadcasted ready status for player ${I.playerId}`));const W=O.players.filter(x=>!x.isDummy&&!x.isDisconnected);if(W.length>0&&W.every(x=>x.isReady)&&!O.isGameStarted){const x=O.players.filter(J=>!J.isDisconnected),K=Math.floor(Math.random()*x.length),U=x[K].id;let z={...O};return z.isReadyCheckActive=!1,z.isGameStarted=!0,z.startingPlayerId=U,z.activePlayerId=U,z.currentPhase=0,z.players=z.players.map(J=>{if(J.hand.length===0&&J.deck.length>0){const ce=[...J.hand],fe=[...J.deck];for(let oe=0;oe<6&&oe<fe.length;oe++){const _e=fe[0];fe.splice(0,1),ce.push(_e)}return m.info(`[PLAYER_READY] Drew ${ce.length} cards for player ${J.id}`),{...J,hand:ce,deck:fe}}return J}),z=sr(z,U),m.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${z.currentPhase}`),Y.current&&(Y.current.broadcastToGuests({type:"GAME_START",senderId:Y.current.getPeerId(),data:{startingPlayerId:U,activePlayerId:U,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var J,ae;m.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(J=z.players[0])==null?void 0:J.deck.length}, hand=${(ae=z.players[0])==null?void 0:ae.hand.length}`),m.info(`[PLAYER_READY] Broadcasting state with currentPhase=${z.currentPhase}`),Gt(z)},100)),z}return O}):j.current;break;case"ASSIGN_TEAMS":(vr=I.data)!=null&&vr.assignments&&n(C=>{const k=C.players.map(O=>{let W=O.teamId||1;for(const[B,x]of Object.entries(I.data.assignments))if(x.includes(O.id)){W=parseInt(B);break}return{...O,teamId:W}});return{...C,players:k}});break;case"SET_GAME_MODE":((Nr=I.data)==null?void 0:Nr.mode)!==void 0&&n(C=>({...C,gameMode:I.data.mode}));break;case"SET_GAME_PRIVACY":((Mr=I.data)==null?void 0:Mr.isPrivate)!==void 0&&n(C=>({...C,isPrivate:I.data.isPrivate}));break;case"SET_GRID_SIZE":((Lr=I.data)==null?void 0:Lr.size)!==void 0&&n(C=>{const k=I.data.size,O=[];for(let W=0;W<k;W++){const B=[];for(let x=0;x<k;x++)B.push({card:null});O.push(B)}return{...C,activeGridSize:k,board:O}});break;case"SET_DUMMY_PLAYER_COUNT":((Gr=I.data)==null?void 0:Gr.count)!==void 0&&n(C=>({...C,dummyPlayerCount:I.data.count}));break;case"HOST_READY":I.playerId!==void 0&&(m.info(`[handleWebrtcMessage] Host (player ${I.playerId}) is ready`),n(C=>{const k=C.players.map(O=>O.id===I.playerId?{...O,isReady:!0}:O);return{...C,players:k}}));break;case"GAME_START":ze.current=!0,m.info("[handleWebrtcMessage] Game starting!",I.data),l.current&&(m.info(`[GAME_START] Current phase before: ${l.current.currentPhase}`),l.current.players.forEach(C=>{m.info(`[GAME_START] Before: Player ${C.id} - deck: ${C.deck.length}, hand: ${C.hand.length}`)})),I.data&&n(C=>{m.info(`[GAME_START] Processing for localPlayerId=${E.current}`),C.players.forEach(B=>{m.info(`[GAME_START] Player ${B.id} before: deck=${B.deck.length}, hand=${B.hand.length}`)});const k=I.data.startingPlayerId??I.data.activePlayerId,O={...C,isGameStarted:I.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:k,activePlayerId:I.data.activePlayerId,currentPhase:C.currentPhase},W=O.players.find(B=>B.id===E.current);if(W&&W.hand.length===0&&W.deck.length>0){const x=[...W.hand],K=[...W.deck];for(let U=0;U<6&&U<K.length;U++){const z=K[0];K.splice(0,1),x.push(z)}O.players=O.players.map(U=>U.id===E.current?{...U,hand:x,deck:K}:U),m.info(`[GAME_START] Drew ${x.length} cards for local player ${E.current}, deck now has ${K.length} cards`)}return O.players.forEach(B=>{m.info(`[GAME_START] Player ${B.id} after: deck=${B.deck.length}, hand=${B.hand.length}`)}),m.info(`[GAME_START] Final state: currentPhase=${O.currentPhase}, activePlayerId=${O.activePlayerId}, startingPlayerId=${O.startingPlayerId}`),O});break;case"ACTIVE_PLAYER_CHANGED":m.info("[handleWebrtcMessage] Active player changed!",I.data),I.data&&n(C=>{const k={...C,activePlayerId:I.data.activePlayerId};if(I.data.currentPhase!==void 0&&(k.currentPhase=I.data.currentPhase),I.data.turnNumber!==void 0&&(k.turnNumber=I.data.turnNumber),k.currentPhase===0&&k.activePlayerId===E.current){const O=k.players.find(W=>W.id===E.current);if(O&&O.deck.length>0){const W=O.deck[0],B=[...O.deck.slice(1)],x=[...O.hand,W];k.players=k.players.map(K=>K.id===E.current?{...K,deck:B,hand:x}:K)}k.currentPhase=1,Zt(k,k.activePlayerId)}return k.activePlayerId&&k.activePlayerId!==C.activePlayerId&&Zt(k,k.activePlayerId),k});break;case"SYNC_DECK_SELECTIONS":m.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",I.data),I.data&&n(C=>I.data.playerId!==void 0&&I.data.selectedDeck!==void 0?I.data.playerId===E.current?(m.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${I.data.playerId}`),C):{...C,players:C.players.map(k=>k.id===I.data.playerId?{...k,selectedDeck:I.data.selectedDeck}:k)}:I.data.deckSelections&&Array.isArray(I.data.deckSelections)?{...C,players:C.players.map(k=>{if(k.id===E.current)return k;const O=I.data.deckSelections.find(W=>W.id===k.id);return O?{...k,selectedDeck:O.selectedDeck}:k})}:C);break;case"CHANGE_PLAYER_DECK":if(m.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",I.data),!I.data||I.data.playerId===void 0)break;{const C=I.data.playerId,k=I.data.deckType,O=I.data.deck;n(W=>{const B=W.players.find(U=>U.id===C);if(!B)return W;const x=j.current;let K;if(O&&O.length>0)K=O.map(U=>{if(U.baseId){const z=Ye(U.baseId);return z?{...z,id:U.id,baseId:U.baseId,deck:k,ownerId:C,ownerName:B.name,power:U.power,powerModifier:U.powerModifier||0,isFaceDown:U.isFaceDown||!1,statuses:U.statuses||[]}:{id:U.id,baseId:U.baseId,name:"Unknown",deck:k,ownerId:C,ownerName:B.name,power:U.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}return{id:U.id,baseId:U.id,name:"Unknown",deck:k,ownerId:C,ownerName:B.name,power:U.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}),m.info(`[CHANGE_PLAYER_DECK] Reconstructed deck for player ${C} from host data: ${K.length} cards`);else if(!x)K=Ze(k,C,B.name),m.warn(`[CHANGE_PLAYER_DECK] No deck data from host, creating locally for player ${C} from ${k}`);else return W;return{...W,players:W.players.map(U=>U.id===C?{...U,selectedDeck:k,deck:K,hand:[],discard:[],announcedCard:null,boardHistory:[]}:U)}})}break;case"GAME_RESET":n(C=>{const k=I.data.activeGridSize||8,O=[];for(let x=0;x<k;x++){const K=[];for(let U=0;U<k;U++)K.push({card:null});O.push(K)}const W=(I.data.players||[]).map(x=>{if(x.isDummy&&x.hand&&x.deck&&x.discard)return{...x,boardHistory:[]};{const K=x.selectedDeck||"SynchroTech";return{...x,hand:[],deck:Ze(K,x.id,x.name),discard:[],boardHistory:[]}}}),B={...C,players:W,gameMode:I.data.gameMode,isPrivate:I.data.isPrivate,activeGridSize:I.data.activeGridSize,dummyPlayerCount:I.data.dummyPlayerCount,autoAbilitiesEnabled:I.data.autoAbilitiesEnabled,isGameStarted:I.data.isGameStarted,currentPhase:I.data.currentPhase,currentRound:I.data.currentRound,turnNumber:I.data.turnNumber,activePlayerId:I.data.activePlayerId,startingPlayerId:I.data.startingPlayerId,roundWinners:I.data.roundWinners||{},gameWinner:I.data.gameWinner,isRoundEndModalOpen:I.data.isRoundEndModalOpen,isReadyCheckActive:I.data.isReadyCheckActive,board:O,targetingMode:null,floatingTexts:[]};return l.current=B,B});break;case"ABILITY_MODE_SET":(xr=I.data)!=null&&xr.abilityMode&&(n(C=>({...C,abilityMode:I.data.abilityMode})),m.info("[AbilityMode] Received ability mode from host",{playerId:I.data.abilityMode.playerId,mode:I.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":m.info("[Ability] Target selected",I.data);break;case"ABILITY_COMPLETED":n(C=>({...C,abilityMode:void 0})),m.info("[Ability] Ability completed",I.data);break;case"ABILITY_CANCELLED":n(C=>({...C,abilityMode:void 0}));break;case"CHANGE_PLAYER_COLOR":if(m.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",I.data),!I.data||I.data.playerId===void 0)break;{const C=I.data.playerId,k=I.data.color;if(C===E.current)break;n(O=>({...O,players:O.players.map(W=>W.id===C?{...W,color:k}:W)}))}break;case"UPDATE_PLAYER_SCORE":if(m.info("[UPDATE_PLAYER_SCORE] Received score update broadcast",I.data),!I.data||I.data.playerId===void 0)break;{const C=I.data.playerId,k=I.data.delta;if(C===E.current)break;n(O=>({...O,players:O.players.map(W=>W.id===C?{...W,score:Math.max(0,W.score+k)}:W)}))}break;case"TRIGGER_HIGHLIGHT":if((Ur=I.data)!=null&&Ur.highlightData){const C=I.data.highlightData;S(C),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(I.data){const C=(Hr=Y.current)==null?void 0:Hr.getPeerId();I.senderId!==C&&S(I.data)}break;case"TRIGGER_FLOATING_TEXT":if(($r=I.data)!=null&&$r.textData){const C=I.data.textData;n(k=>({...k,floatingTexts:[...k.floatingTexts,C].filter(O=>Date.now()-O.timestamp<re.FLOATING_TEXT_DURATION)})),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((Fr=I.data)!=null&&Fr.batch){const C=I.data.batch;n(k=>({...k,floatingTexts:[...k.floatingTexts,...C].filter(O=>Date.now()-O.timestamp<re.FLOATING_TEXT_DURATION)})),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:I.senderId,data:{batch:C},timestamp:Date.now()},I.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const C=(Wr=Y.current)==null?void 0:Wr.getPeerId();(Br=I.data)!=null&&Br.batch&&I.senderId!==C?n(k=>({...k,floatingTexts:[...k.floatingTexts,...I.data.batch].filter(O=>Date.now()-O.timestamp<re.FLOATING_TEXT_DURATION)})):(Yr=I.data)!=null&&Yr.textData&&I.senderId!==C&&n(k=>({...k,floatingTexts:[...k.floatingTexts,I.data.textData].filter(O=>Date.now()-O.timestamp<re.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((Kr=I.data)!=null&&Kr.coords){const C=I.data.coords,k=I.data.timestamp;u({coords:C,timestamp:k}),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:I.senderId,data:{coords:C,timestamp:k},timestamp:Date.now()},I.senderId)}break;case"NO_TARGET_TRIGGERED":if((zr=I.data)!=null&&zr.coords){const C=(qr=Y.current)==null?void 0:qr.getPeerId();I.senderId!==C&&u({coords:I.data.coords,timestamp:I.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(I.data){const C=I.data;R(k=>[...k,C]),setTimeout(()=>{R(k=>k.filter(O=>O.timestamp!==C.timestamp))},1e3),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(I.data){const C=I.data;D(k=>[...k,C]),setTimeout(()=>{D(k=>k.filter(O=>O.timestamp!==C.timestamp))},1e3),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"TRIGGER_CLICK_WAVE":if(I.data){const C=I.data;L(k=>[...k,C]),setTimeout(()=>{L(k=>k.filter(O=>O.timestamp!==C.timestamp))},600),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"CLICK_WAVE_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"CLICK_WAVE_TRIGGERED":I.data&&I.senderId!==((jr=Y.current)==null?void 0:jr.getPeerId())&&(L(C=>[...C,I.data]),setTimeout(()=>{L(C=>C.filter(k=>k.timestamp!==I.data.timestamp))},600));break;case"DECK_SELECTION_TRIGGERED":I.data&&I.senderId!==((Vr=Y.current)==null?void 0:Vr.getPeerId())&&(R(C=>[...C,I.data]),setTimeout(()=>{R(C=>C.filter(k=>k.timestamp!==I.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":I.data&&I.senderId!==((Jr=Y.current)==null?void 0:Jr.getPeerId())&&(D(C=>[...C,I.data]),setTimeout(()=>{D(C=>C.filter(k=>k.timestamp!==I.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((Xr=I.data)!=null&&Xr.targetingMode){const C=I.data.targetingMode;m.info("[TargetingMode] Received SET_TARGETING_MODE via WebRTC",{playerId:C.playerId,mode:C.action.mode,boardTargetsCount:((Zr=C.boardTargets)==null?void 0:Zr.length)||0,handTargetsCount:((Qr=C.handTargets)==null?void 0:Qr.length)||0,isDeckSelectable:C.isDeckSelectable||!1,timestamp:C.timestamp,isHost:j.current}),n(k=>({...k,targetingMode:C})),l.current.targetingMode=C,j.current&&Y.current&&Y.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((ta=(ea=Y.current).getPeerId)==null?void 0:ta.call(ea))??void 0,data:{targetingMode:C},timestamp:Date.now()})}break;case"CLEAR_TARGETING_MODE":m.info("[TargetingMode] Received CLEAR_TARGETING_MODE via WebRTC",{isHost:j.current}),n(C=>({...C,targetingMode:null})),l.current.targetingMode=null,j.current&&Y.current&&Y.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((aa=(ra=Y.current).getPeerId)==null?void 0:aa.call(ra))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()});break;case"RECONNECT_ACCEPT":if((na=I.data)!=null&&na.gameState){const C=I.data.gameState;n(C),P("Connected"),m.info(`[Reconnection] State restored with ${((oa=C.players)==null?void 0:oa.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(k){m.warn("[Reconnection] Failed to clear stored data:",k)}}break;case"RECONNECT_REJECT":{const C=((sa=I.data)==null?void 0:sa.reason)||"unknown";m.warn(`[Reconnection] Reconnection rejected: ${C}`),P("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((ia=I.data)==null?void 0:ia.playerId)!==void 0&&(m.info(`[Reconnection] Player ${I.data.playerId} disconnected, reconnection window open`),n(C=>({...C,players:C.players.map(k=>k.id===I.data.playerId?{...k,isDisconnected:!0}:k)})));break;case"PLAYER_RECONNECTED":((da=I.data)==null?void 0:da.playerId)!==void 0&&(m.info(`[Reconnection] Player ${I.data.playerId} reconnected`),n(C=>({...C,players:C.players.map(k=>k.id===I.data.playerId?{...k,isDisconnected:!1}:k)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((ca=I.data)==null?void 0:ca.playerId)!==void 0&&(m.info(`[Reconnection] Player ${I.data.playerId} converted to dummy`),n(C=>({...C,players:C.players.map(k=>k.id===I.data.playerId?{...k,isDummy:!0,isDisconnected:!0}:k)})));break;case"REQUEST_DECK_VIEW":if(j.current&&((la=I.data)==null?void 0:la.targetPlayerId)!==void 0){const C=I.data.targetPlayerId;I.playerId;const k=a.players.find(O=>O.id===C);if(k&&Y.current){let O=[];C===E.current||k.isDummy?(m.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${k.deck.length} cards, first card baseId: ${(ua=k.deck[0])==null?void 0:ua.baseId}`),O=k.deck.map(x=>({id:x.id,baseId:x.baseId,deck:x.deck,power:x.power,powerModifier:x.powerModifier,isFaceDown:x.isFaceDown,statuses:x.statuses||[]}))):k.deckCards&&k.deckCards.length>0?O=k.deckCards:O=k.deck.map(x=>({id:x.id,baseId:x.baseId,power:x.power,powerModifier:x.powerModifier,isFaceDown:x.isFaceDown,statuses:x.statuses||[]}));const W={targetPlayerId:C,deckCards:O,deckSize:O.length},B={type:"DECK_VIEW_DATA",senderId:Y.current.getPeerId(),data:W,timestamp:Date.now()};Y.current.sendToGuest(I.senderId||"",B),m.info(`[REQUEST_DECK_VIEW] Sent ${W.deckCards.length} cards for player ${C}`)}}break;case"DECK_VIEW_DATA":if(((fa=I.data)==null?void 0:fa.targetPlayerId)!==void 0&&((pa=I.data)!=null&&pa.deckCards)){const C=I.data.targetPlayerId,k=I.data.deckCards;m.info(`[DECK_VIEW_DATA] Received ${k.length} deck cards for player ${C}`);const O=B=>{if(B.baseId){const K=Ye(B.baseId);if(K)return{...K,id:B.id,baseId:B.baseId,deck:B.deck||Ce.SynchroTech,ownerId:C,power:B.power,powerModifier:B.powerModifier,isFaceDown:B.isFaceDown,statuses:B.statuses||[]};m.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${B.baseId}`)}else m.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${B.id}`);return{id:B.id,baseId:B.baseId||B.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:B.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:Ce.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}},W=k.map(O);n(B=>({...B,players:B.players.map(x=>x.id===C?{...x,deck:W}:x)}))}break;case"DECK_DATA_UPDATE":if(j.current&&I.playerId!==void 0&&((ya=I.data)!=null&&ya.deck)){const C=I.playerId,k=I.data.deck,O=I.data.deckSize;m.info(`[DECK_DATA_UPDATE] Received ${k.length} cards for guest ${C}, deckSize=${O}`),n(W=>({...W,players:W.players.map(B=>{if(B.id===C){const x=k.map(K=>({...K,ownerId:K.ownerId??C}));return{...B,deck:x,deckSize:O}}return B})}))}break;case"REQUEST_DECK_DATA":if(!j.current&&Y.current){const C=a.players.find(k=>k.id===E.current);if(C&&C.deck.length>0){m.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${C.deck.length} cards`);const k=C.deck.map(O=>({id:O.id,baseId:O.baseId,ownerId:O.ownerId??E.current,power:O.power,powerModifier:O.powerModifier||0,isFaceDown:O.isFaceDown||!1,statuses:O.statuses||[]}));Y.current.sendAction("DECK_DATA_UPDATE",{playerId:E.current,deck:k,deckSize:k.length})}}break;default:m.warn(`[handleWebrtcMessage] Unknown message type: ${I.type}`,I);break}},[de,Ze,Gt,a,s]),sn=H.useCallback(I=>{if(!Y.current||Ae)return;Re(!0),P("Connecting");const te=3e4,Q=1e3;let ee=0;const ie=te/Q;try{const le={hostPeerId:I,playerId:s,gameState:a,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(le))}catch(le){m.error("[Reconnection] Failed to store data:",le)}const ne=async()=>{ee++;const le=Math.max(0,te-ee*Q);if(ve({attempt:ee,maxAttempts:ie,timeRemaining:le}),le<=0){m.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Re(!1),ve(null),rt();return}let V=I;if(a!=null&&a.gameId){const Ie=Wt(a.gameId);if(Ie&&Ie.peerId!==I){V=Ie.peerId;try{const we={hostPeerId:V,playerId:s,gameState:a,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(we))}catch(we){m.error("[Reconnection] Failed to update reconnection data:",we)}}}try{const Ie=s||E.current;Ie!==null?(m.info(`[Reconnection] Reconnecting as existing player ${Ie} to host ${V}`),await Y.current.initializeAsReconnectingGuest(V,Ie)):(m.info("[Reconnection] No playerId, connecting as new player"),await Y.current.initializeAsGuest(V)),m.info("[Reconnection] Successfully reconnected!"),Re(!1),ve(null)}catch(Ie){m.warn("[Reconnection] Reconnection attempt failed:",Ie),setTimeout(ne,Q)}};ne()},[Ae,a,s]),Ue=H.useCallback(I=>{n(te=>{if(!te)return m.error("[updateState] prevState is undefined, skipping update"),te;const Q=typeof I=="function"?I(te):I;if(!Q)return m.error("[updateState] newState is undefined, skipping update"),te;const ee=!te.gameId&&Q.gameId;if(!ze.current&&!ee)return Q;if(F&&Y.current){if(j.current){if(Y.current.broadcastGameState(Q),m.info(`[updateState] Host broadcast state: phase=${Q.currentPhase}, activePlayer=${Q.activePlayerId}`),Q.gameId&&E.current!==null)try{It({gameState:Q,localPlayerId:E.current,isHost:!0}),m.debug("[updateState] Saved game state for host auto-restore")}catch(ie){m.warn("[updateState] Failed to save game state:",ie)}}else Y.current&&(Y.current.sendStateToHost(Q,E.current),m.info(`[updateState] Guest sent state to host: phase=${Q.currentPhase}, activePlayer=${Q.activePlayerId}`));return Q}if(Te.current&&Te.current.readyState===WebSocket.OPEN){const ie={type:"UPDATE_STATE",gameState:Q};ct.current&&(ie.playerToken=ct.current),Te.current.send(JSON.stringify(ie))}return Q})},[F,de,Gt]),dn=H.useCallback(()=>{const{initialState:I}=lt.createGame();Ue(I)},[lt,Ue]),cn=H.useCallback(()=>{lt.exitGame(Be,j,Ea,rt)},[lt,Be,j,Ea,rt]),ln=ys({ws:Te,webrtcManager:Y,gameStateRef:l,webrtcIsHostRef:j,setGameState:n,updateState:Ue}),un=hs({ws:Te,webrtcManager:Y,gameStateRef:l,localPlayerIdRef:E,webrtcIsHostRef:j,setGameState:n}),fn=ms({updateState:Ue,sendWebrtcAction:et,webrtcIsHostRef:j,webrtcManagerRef:Y}),pn=Is({updateState:Ue}),yn=Es({localPlayerIdRef:E,updateState:Ue}),{addBoardCardStatus:hn,removeBoardCardStatus:mn,removeBoardCardStatusByOwner:In,modifyBoardCardPower:En,addAnnouncedCardStatus:Tn,removeAnnouncedCardStatus:gn,modifyAnnouncedCardPower:wn,addHandCardStatus:_n,removeHandCardStatus:bn,revealHandCard:An,revealBoardCard:Sn,requestCardReveal:Cn,respondToRevealRequest:Dn,removeRevealedStatus:Rn}=yn,Pn=Ts({webrtcIsHostRef:j,sendWebrtcAction:et,webrtcManagerRef:Y,localPlayerIdRef:E,getCardDefinition:Ye,commandCardIds:Ao,createDeck:Ze,updateState:Ue}),{changePlayerDeck:kn,loadCustomDeck:On,resurrectDiscardedCard:vn,reorderTopDeck:Nn,reorderCards:Mn,recoverDiscardedCard:Ln}=Pn,Gn=gs({ws:Te,webrtcManagerRef:Y,webrtcIsHostRef:j,gameStateRef:l,scoreDeltaAccumulator:Xe,setGameState:n,updateState:Ue,abilityMode:t,setAbilityMode:r,createDeck:Ze}),{toggleActivePlayer:xn,toggleAutoDraw:Un,setPhase:Hn,nextPhase:$n,prevPhase:Fn,closeRoundEndModal:Wn,closeRoundEndModalOnly:Bn,resetGame:Yn}=Gn;H.useEffect(()=>{We.current=!1;const I=sessionStorage.getItem("invite_game_id"),te=sessionStorage.getItem("invite_host_id");if(I&&!te)return lr(),()=>{We.current=!0,ut.current&&clearTimeout(ut.current),Te.current&&(Te.current.onclose=null,Te.current.close())};if(I&&te)return()=>{We.current=!0,ut.current&&clearTimeout(ut.current),Te.current&&(Te.current.onclose=null,Te.current.close())};const Q=performance.getEntriesByType("navigation"),ee=Q.length>0?Q[0]:null,ie=(ee==null?void 0:ee.type)??0,ne=us();return ne&&(m.info(`Restoring saved game state (nav type: ${ie}):`,ne.gameState.gameId),n(ne.gameState),d(ne.localPlayerId),l.current=ne.gameState,E.current=ne.localPlayerId,ct.current=ne.playerToken),lr(),()=>{We.current=!0,ut.current&&clearTimeout(ut.current),Te.current&&(Te.current.onclose=null,Te.current.close())}},[]),H.useEffect(()=>{if(Fe&&l.current&&l.current.gameId){const I=Ct(l.current);I!==l.current&&(n(I),l.current=I)}},[]),H.useEffect(()=>{if(M)return;const I=setInterval(()=>{if(Fe&&l.current&&l.current.gameId){const te=Ct(l.current);n({...te}),l.current=te,$(!0),clearInterval(I)}},100);return()=>clearInterval(I)},[M]);const{startReadyCheck:Kn,cancelReadyCheck:zn,playerReady:qn}=un,{updatePlayerName:jn,changePlayerColor:Vn}=fn,{drawCard:Jn,drawCardsBatch:Xn,shufflePlayerDeck:Zn,flipBoardCard:Qn,flipBoardCardFaceDown:eo}=pn,{assignTeams:to,setGameMode:ro,setGamePrivacy:ao,setActiveGridSize:no,setDummyPlayerCount:oo}=ln,so=H.useCallback(()=>{var I;if(((I=Te.current)==null?void 0:I.readyState)===WebSocket.OPEN&&l.current.gameId&&E.current===1){Te.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe}));const te=l.current,Q=me(te);Q.players.forEach(ee=>{if(["hand","deck","discard"].forEach(ne=>{ee[ne]&&(ee[ne]=ee[ne].map(le=>{const V=Ht(le.name);return V?{...le,...V}:le}))}),ee.announcedCard){const ne=Ht(ee.announcedCard.name);ne&&(ee.announcedCard={...ee.announcedCard,...ne})}}),Q.board.forEach(ee=>{ee.forEach(ie=>{if(ie.card){const ne=Ht(ie.card.name);ne&&(ie.card={...ie.card,...ne})}})}),Te.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:Q})),n(Q)}},[]),xt=H.useCallback((I,te)=>{var ie;const Q=l.current;if(!Q.isGameStarted){m.warn("[ScoreUpdate] Blocked: game not started");return}if(Q.isRoundEndModalOpen){m.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(te===0)return;const ee=Oe();if(ee?Ue(ne=>({...ne,players:ne.players.map(le=>le.id===I?{...le,score:Math.max(0,(le.score||0)+te)}:le)})):n(ne=>({...ne,players:ne.players.map(le=>le.id===I?{...le,score:Math.max(0,(le.score||0)+te)}:le)})),!ee){if(((ie=Te.current)==null?void 0:ie.readyState)!==WebSocket.OPEN){m.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const ne=Xe.get(I);if(ne){clearTimeout(ne.timerId);const le=ne.delta+te,V=setTimeout(()=>{var we;const Ie=Xe.get(I);Ie&&((we=Te.current)==null?void 0:we.readyState)===WebSocket.OPEN&&(m.info(`[ScoreUpdate] Sending accumulated delta: player=${I}, delta=${Ie.delta}`),Te.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:l.current.gameId,playerId:I,delta:Ie.delta}))),Xe.delete(I)},500);Xe.set(I,{delta:le,timerId:V})}else{const le=setTimeout(()=>{var Ie;const V=Xe.get(I);V&&((Ie=Te.current)==null?void 0:Ie.readyState)===WebSocket.OPEN&&(m.info(`[ScoreUpdate] Sending delta: player=${I}, delta=${V.delta}`),Te.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:l.current.gameId,playerId:I,delta:V.delta}))),Xe.delete(I)},500);Xe.set(I,{delta:te,timerId:le})}}},[n,Ue]),io=As({ws:Te,webrtcManager:Y,gameStateRef:l,webrtcIsHostRef:j,setGameState:n}),{setTargetingMode:co,clearTargetingMode:pr}=io,lo=ws({ws:Te,gameStateRef:l,updateState:Ue,updatePlayerScore:xt,triggerFloatingText:fr,clearTargetingMode:pr}),{scoreLine:uo,scoreDiagonal:fo}=lo,Je=_s({updateState:Ue,rawJsonData:Fe}),po=bs({updateState:Ue,localPlayerIdRef:E,updatePlayerScore:xt}),{moveItem:yr}=po;return{gameState:a,localPlayerId:s,setLocalPlayerId:d,draggedItem:g,setDraggedItem:A,connectionStatus:y,gamesList:T,latestHighlight:f,latestFloatingTexts:_,latestNoTarget:c,latestDeckSelections:w,latestHandCardSelections:v,joinAsInvite:ja,startReadyCheck:Kn,cancelReadyCheck:zn,playerReady:qn,assignTeams:to,setGameMode:ro,setGamePrivacy:ao,setActiveGridSize:no,setDummyPlayerCount:oo,updatePlayerName:jn,changePlayerColor:Vn,updatePlayerScore:xt,changePlayerDeck:kn,loadCustomDeck:On,drawCard:Jn,drawCardsBatch:Xn,shufflePlayerDeck:Zn,moveItem:yr,handleDrop:yr,addBoardCardStatus:hn,removeBoardCardStatus:mn,removeBoardCardStatusByOwner:In,modifyBoardCardPower:En,addAnnouncedCardStatus:Tn,removeAnnouncedCardStatus:gn,modifyAnnouncedCardPower:wn,addHandCardStatus:_n,removeHandCardStatus:bn,flipBoardCard:Qn,flipBoardCardFaceDown:eo,revealHandCard:An,revealBoardCard:Sn,requestCardReveal:Cn,respondToRevealRequest:Dn,syncGame:so,removeRevealedStatus:Rn,toggleActivePlayer:xn,toggleAutoDraw:Un,triggerHighlight:Xa,triggerFloatingText:fr,triggerNoTarget:Za,triggerDeckSelection:Qa,triggerHandCardSelection:en,triggerClickWave:rn,clickWaves:b,syncValidTargets:tn,setTargetingMode:co,clearTargetingMode:pr,nextPhase:$n,prevPhase:Fn,setPhase:Hn,markAbilityUsed:Je.markAbilityUsed,applyGlobalEffect:Je.applyGlobalEffect,swapCards:Je.swapCards,transferStatus:Je.transferStatus,transferAllCounters:Je.transferAllCounters,spawnToken:Je.spawnToken,resetDeployStatus:Je.resetDeployStatus,removeStatusByType:Je.removeStatusByType,recoverDiscardedCard:Ln,resurrectDiscardedCard:vn,scoreLine:uo,closeRoundEndModal:Wn,closeRoundEndModalOnly:Bn,resetGame:Yn,scoreDiagonal:fo,reorderTopDeck:Nn,reorderCards:Mn,updateState:Ue,requestDeckView:cr,sendFullDeckToHost:tt,createGame:dn,joinGame:ur,joinGameViaModal:ur,exitGame:cn,requestGamesList:Va,forceReconnect:qa,webrtcHostId:Z,webrtcIsHost:de,initializeWebrtcHost:Ve,connectAsGuest:Qe,sendWebrtcAction:et,isReconnecting:Ae,reconnectProgress:Se}};function ba(e,t,r){const{gameState:a,localPlayerId:n,abilityMode:i,cursorStack:o,handleActionExecution:s,markAbilityUsed:d}=r;if(i||o||!a.isGameStarted||n===null)return null;const l=a.players.find(A=>A.id===e.ownerId),E=n===e.ownerId||(l==null?void 0:l.isDummy);if(a.activePlayerId!==e.ownerId||!E||!Oa(e,a)||!ka(e,a.currentPhase,a.activePlayerId,a))return null;const g=Oo(e,a,e.ownerId,t);if(g){g.readyStatusToRemove&&d(t,!!g.isDeployAbility,!1,g.readyStatusToRemove);const A={...g,chainedAction:g.chainedAction?{...g.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};return s(A,t),A}return null}function vi(e){const t=it[e],r=(t==null?void 0:t.allowedTargets)||[];return{allowedTargets:r,allowHand:r.includes("hand"),allowBoard:r.includes("board"),allowBoardFaceDown:r.includes("board-facedown"),allowDeck:r.includes("deck"),allowDiscard:r.includes("discard")}}function dr(e,t,r,a){const n={type:e,count:r?r.count+1:1,isDragging:!0,originalOwnerId:t,sourceCoords:r==null?void 0:r.sourceCoords},i={};return e==="Revealed"&&(i.excludeOwnerId=t,i.onlyFaceDown=!0),{...n,...i,...a,...r&&{chainedAction:r.chainedAction,isDeployAbility:r.isDeployAbility,readyStatusToRemove:r.readyStatusToRemove}}}function qe(e,t){var a;const r=(a=e.sourceCard)==null?void 0:a.ownerId;return typeof r=="number"?r:typeof t=="number"?t:0}function Rs(e,t,r){var E;const{gameState:a,localPlayerId:n,commandContext:i,triggerNoTarget:o,onAbilityComplete:s,handleActionExecution:d}=r;if(e.type==="ABILITY_COMPLETE"){s==null||s();return}if(e.type==="REVEREND_SETUP_SCORE"){Ps(e,t,r);return}if(e.type==="GLOBAL_AUTO_APPLY"){ks(e,t,r);return}if(!At(e,a,((E=e.sourceCard)==null?void 0:E.ownerId)||n,i)){o(t),e.chainedAction&&!e.skipChainedActionOnNoTargets&&setTimeout(()=>{d(e.chainedAction,t)},500);return}if(e.type==="CREATE_STACK"){Os(e,t,r);return}if(e.type==="OPEN_MODAL"){vs(e,t,r);return}if(e.type==="ENTER_MODE"){Ns(e,t,r);return}m.warn("[handleActionExecution] Unknown action type:",e.type)}function Ps(e,t,r){var l,E;const{gameState:a,updatePlayerScore:n,triggerFloatingText:i,markAbilityUsed:o}=r,s=((l=e.sourceCard)==null?void 0:l.ownerId)??0;let d=0;for(let g=0;g<a.board.length;g++)for(let A=0;A<a.board[g].length;A++){const y=(E=a.board[g][A])==null?void 0:E.card;if(y!=null&&y.statuses){const P=y.statuses.filter(T=>T.type==="Exploit"&&T.addedByPlayerId===s);d+=P.length}}d>0&&n(s,d),i([{row:t.row,col:t.col,text:`+${d}`,playerId:s}]),o(t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function ks(e,t,r){var P,T,h,f,S,_;const{gameState:a,localPlayerId:n,commandContext:i,markAbilityUsed:o,triggerNoTarget:s,triggerFloatingText:d,updatePlayerScore:l,applyGlobalEffect:E,addBoardCardStatus:g,removeStatusByType:A,handleActionExecution:y}=r;if(((P=e.payload)==null?void 0:P.customAction)==="FINN_SCORING"){const p=(T=e.sourceCard)==null?void 0:T.ownerId;if(p===void 0){m.warn("[FINN_SCORING] Source card missing ownerId"),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}let c=0;if(a.players.forEach(u=>{u.id!==p&&u.hand.forEach(w=>{var R;(R=w.statuses)!=null&&R.some(v=>v.type==="Revealed"&&v.addedByPlayerId===p)&&c++})}),a.board.forEach(u=>{u.forEach(w=>{var v;const R=w.card;if(R&&R.ownerId!==p){const D=((v=R.statuses)==null?void 0:v.filter(b=>b.type==="Revealed"&&b.addedByPlayerId===p).length)||0;c+=D}})}),c>0){const u=e.sourceCoords||t;d({row:u.row,col:u.col,text:`+${c}`,playerId:p}),l(p,c)}o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(((h=e.payload)==null?void 0:h.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){e.sourceCoords&&e.sourceCoords.row>=0?A(e.sourceCoords,"Aim"):i.lastMovedCardCoords&&A(i.lastMovedCardCoords,"Aim");return}if((f=e.payload)!=null&&f.tokenType&&e.payload.filter){const{tokenType:p,filter:c}=e.payload,u=[],w=a.board.length;for(let R=0;R<w;R++)for(let v=0;v<w;v++){const D=a.board[R][v].card;D&&c(D,R,v)&&u.push({row:R,col:v})}if(u.length===0){s(e.sourceCoords||t),e.chainedAction&&setTimeout(()=>y(e.chainedAction,t),500),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}u.forEach(R=>{var v;g(R,p,((v=e.sourceCard)==null?void 0:v.ownerId)||0)}),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove),e.chainedAction&&setTimeout(()=>y(e.chainedAction,t),re.MODE_CLEAR_DELAY);return}if((S=e.payload)!=null&&S.contextReward){Aa(e,t,r);return}if(e.payload&&!e.payload.cleanupCommand){const{tokenType:p,filter:c}=e.payload,u=[],w=a.board.length;if(e.payload.contextReward&&e.sourceCard){Aa(e,t,r);return}if(c)for(let R=0;R<w;R++)for(let v=0;v<w;v++){const D=a.board[R][v].card;D&&c(D)&&u.push({row:R,col:v})}else e.sourceCoords&&e.sourceCoords.row>=0?u.push(e.sourceCoords):t&&t.row>=0?u.push(t):i.lastMovedCardCoords&&u.push(i.lastMovedCardCoords);if(u.length>0){if(p){const R=e.payload.count||1,v=e.payload.ownerId!==void 0?e.payload.ownerId:((_=e.sourceCard)==null?void 0:_.ownerId)??n??0;for(let D=0;D<R;D++)E(t,u,p,v,!!e.isDeployAbility)}}else s(t),o(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}}function Os(e,t,r){var l,E;const{gameState:a,setAbilityMode:n,setCursorStack:i,triggerNoTarget:o,localPlayerId:s}=r;let d=e.count||0;if(e.dynamicCount){const{factor:g,ownerId:A}=e.dynamicCount;let y=0;a.board.forEach(P=>{P.forEach(T=>{var h;if((h=T.card)!=null&&h.statuses){const f=T.card.statuses.filter(S=>S.type===g&&S.addedByPlayerId===A);y+=f.length}})}),d=y}if(d>0){n(null);let g=((l=e.sourceCard)==null?void 0:l.ownerId)??s??0;!((E=e.sourceCard)!=null&&E.ownerId)&&s!==null&&(g=s);const A={count:d,sourceCoords:e.sourceCoords||t,sourceCard:e.sourceCard,isDeployAbility:e.isDeployAbility,readyStatusToRemove:e.readyStatusToRemove,targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,placeAllAtOnce:e.placeAllAtOnce,replaceStatus:e.replaceStatus,chainedAction:e.chainedAction,recordContext:e.recordContext};i(dr(e.tokenType||"Aim",g,null,A))}else o(t)}function vs(e,t,r){var l,E;const{gameState:a,localPlayerId:n,commandContext:i,setViewingDiscard:o,markAbilityUsed:s}=r;if(!At(e,a,((l=e.sourceCard)==null?void 0:l.ownerId)||n,i)){s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(e.mode==="RETRIEVE_DEVICE"){const g=a.players.find(A=>{var y;return A.id===((y=e.sourceCard)==null?void 0:y.ownerId)});g&&(o({player:g,pickConfig:{filterType:"Device",action:"recover"}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}else if(e.mode==="IMMUNIS_RETRIEVE"){const g=a.players.find(A=>{var y;return A.id===((y=e.sourceCard)==null?void 0:y.ownerId)});g&&o({player:g,pickConfig:{filterType:"Optimates",action:"resurrect"}})}else if(e.mode==="SEARCH_DECK"){const g=a.players.find(A=>{var y;return A.id===((y=e.sourceCard)==null?void 0:y.ownerId)});g&&(o({player:g,pickConfig:{filterType:((E=e.payload)==null?void 0:E.filterType)||"Unit",action:"recover",isDeck:!0}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Ns(e,t,r){var y,P;const{gameState:a,localPlayerId:n,commandContext:i,triggerNoTarget:o,setAbilityMode:s,markAbilityUsed:d,addBoardCardStatus:l,setTargetingMode:E,handleActionExecution:g}=r,A=e.mode;if(A==="SHIELD_SELF_THEN_RIOT_PUSH"){const T=e.sourceCard.ownerId;if(l(t,"Shield",T),!At(e,a,T,i)){o(t),d(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),E(e,qe(e,n),t,void 0,i);return}if(A==="SHIELD_SELF_THEN_SPAWN"){const T=qe(e,n);l(t,"Shield",T),s({...e,payload:{...e.payload,shieldApplied:!0}}),E(e,T,t);return}if(A==="PRINCEPS_SHIELD_THEN_AIM"){const T=qe(e,n);l(t,"Shield",T);const h={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};g(h,t);return}if(A==="GAWAIN_DEPLOY_SHIELD_AIM"){const T=e.sourceCard.ownerId;l(t,"Shield",T);const h={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};g(h,t);return}if(A==="ABR_DEPLOY_SHIELD_AIM"){const T=e.sourceCard.ownerId;l(t,"Shield",T);const h={type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};g(h,t);return}if(A==="RIOT_PUSH"){if(e.isDeployAbility){s(e),E(e,qe(e,n),t);return}if(!At(e,a,((y=e.sourceCard)==null?void 0:y.ownerId)||n,i)){o(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),E(e,qe(e,n),t);return}if(A==="PATROL_MOVE"){s(e),E(e,qe(e,n),t);return}if(A==="SELECT_TARGET"){if(e.isDeployAbility){s(e),E(e,qe(e,n),t,void 0,i);return}if(!At(e,a,((P=e.sourceCard)==null?void 0:P.ownerId)||n,i)){o(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),E(e,qe(e,n),t,void 0,i);return}s(e),E(e,qe(e,n),t)}function Aa(e,t,r){var f,S,_,p,c,u,w;const{gameState:a,commandContext:n,updatePlayerScore:i,triggerFloatingText:o,drawCardsBatch:s,removeBoardCardStatus:d,addBoardCardStatus:l,modifyBoardCardPower:E,markAbilityUsed:g}=r,A=(f=e.payload)==null?void 0:f.contextReward,y=n.lastMovedCardCoords||t;if(!y||y.row<0)return;let P=a.board[y.row][y.col].card;const T=((S=e.payload)==null?void 0:S._tempContextId)||n.lastMovedCardId;if((!P||T&&P.id!==T)&&T)for(let R=0;R<a.board.length;R++){for(let v=0;v<a.board[R].length;v++)if(((_=a.board[R][v].card)==null?void 0:_.id)===T){P=a.board[R][v].card;break}if(P)break}if(!P){m.warn("[ContextReward] No card at coords");return}const h=Math.max(0,P.power+(P.powerModifier||0)+(P.bonusPower||0));A==="DRAW_MOVED_POWER"||A==="DRAW_EQUAL_POWER"?s(((p=e.sourceCard)==null?void 0:p.ownerId)||0,h):A==="SCORE_MOVED_POWER"?(o({row:y.row,col:y.col,text:`+${h}`,playerId:((c=e.sourceCard)==null?void 0:c.ownerId)||0}),i(((u=e.sourceCard)==null?void 0:u.ownerId)||0,h)):A==="STUN_MOVED_UNIT"?l(y,"Stun",((w=e.sourceCard)==null?void 0:w.ownerId)||0):A==="REMOVE_AIM"?d(y,"Aim"):A==="WEAKEN"&&E(y,-1),g(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Ms(e,t){var u;const{gameState:r,localPlayerId:a,abilityMode:n,setAbilityMode:i,cursorStack:o,commandContext:s,setCommandContext:d,playMode:l,draggedItem:E,interactionLock:g,handleActionExecution:A,handleDrop:y,moveItem:P,markAbilityUsed:T,spawnToken:h,resurrectDiscardedCard:f,updatePlayerScore:S,triggerFloatingText:_,handleLineSelection:p}=t;if(g.current)return!1;const c=r.board.length;if(E)return e.row>=0&&e.row<c&&e.col>=0&&e.col<r.board[e.row].length?(y(E,{location:"board",row:e.row,col:e.col}),!0):!1;if(o&&o.isDragging){if(st({location:"board",row:e.row,col:e.col},{...o.targetOwnerId!==void 0&&{targetOwnerId:o.targetOwnerId},...o.excludeOwnerId!==void 0&&{excludeOwnerId:o.excludeOwnerId},onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.targetType&&{targetType:o.targetType},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},...o.requireStatusFromSourceOwner!==void 0&&{requireStatusFromSourceOwner:o.requireStatusFromSourceOwner},...o.mustBeAdjacentToSource&&o.sourceCoords&&{mustBeAdjacentTo:o.sourceCoords},...o.mustBeInLineWithSource&&o.sourceCoords&&{mustBeInLineWith:o.sourceCoords},...o.maxDistanceFromSource!==void 0&&{maxDistance:o.maxDistanceFromSource},...o.range&&{range:o.range}},a??0,r.players)){let R=null;if(o.sourceCoords){const{row:v,col:D}=o.sourceCoords;v>=0&&v<c&&D>=0&&D<r.board[v].length&&(R=r.board[v][D].card)}if(R)return A({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:o.type,count:o.count,targetOwnerId:o.targetOwnerId,onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.range&&{range:o.range},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},cleanupCommand:!0},sourceCard:R,sourceCoords:o.sourceCoords},e),!0}return!1}if(n&&n.mode==="SPAWN_TOKEN"){const{sourceCoords:w,payload:R,sourceCard:v,isDeployAbility:D,readyStatusToRemove:b}=n;if(!w||!(R!=null&&R.tokenName)||!(Math.abs(e.row-w.row)+Math.abs(e.col-w.col)===1))return!1;const G=(v==null?void 0:v.ownerId)??((u=n.sourceCard)==null?void 0:u.ownerId);return h(e,R.tokenName,G),T(w,D,!1,b),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="SELECT_CELL"){const{sourceCoords:w,sourceCard:R,isDeployAbility:v,readyStatusToRemove:D,payload:b}=n,L=(()=>{var M;if(w&&w.row>=0)return w;if(!R)return null;for(let $=0;$<r.board.length;$++)for(let F=0;F<r.board.length;F++)if(((M=r.board[$][F].card)==null?void 0:M.id)===R.id)return{row:$,col:F};return null})();if(!L||!R)return!1;let G=!1;if((b==null?void 0:b.range)==="line")G=e.row===L.row||e.col===L.col;else if((b==null?void 0:b.range)==="global")G=!0;else if((b==null?void 0:b.range)===2){const M=Math.abs(e.row-L.row)+Math.abs(e.col-L.col);if(M===1)G=!0;else if(M===2){const $=L.row,F=L.col,q=e.row,Z=e.col;G=[{r:q,c:F},{r:$,c:Z},{r:($+q)/2,c:(F+Z)/2}].some(de=>{if(!Number.isInteger(de.r)||!Number.isInteger(de.c))return!1;const Ee=Math.floor((r.board.length-r.activeGridSize)/2),j=Ee,Ae=Ee+r.activeGridSize-1;return de.r<j||de.r>Ae||de.c<j||de.c>Ae||Math.abs(de.r-$)+Math.abs(de.c-F)!==1?!1:!r.board[de.r][de.c].card})}}else b!=null&&b.filter?G=b.filter(null,e.row,e.col):G=Math.abs(e.row-L.row)+Math.abs(e.col-L.col)===1;if(!G)return!1;if(b!=null&&b.moveFromHand&&s.selectedHandCard){const{playerId:M,cardIndex:$}=s.selectedHandCard,F=r.players.find(Z=>Z.id===M),q=F==null?void 0:F.hand[$];if(q)return P({card:q,source:"hand",playerId:M,cardIndex:$,isManual:!0},{target:"board",boardCoords:e}),T(w||e,v,!1,D),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0}if(!((b==null?void 0:b.allowSelf)&&e.row===L.row&&e.col===L.col)){const M=r.board[L.row][L.col].card;M&&P({card:M,source:"board",boardCoords:L,bypassOwnershipCheck:!0},{target:"board",boardCoords:e})}if(b!=null&&b.recordContext&&d({lastMovedCardCoords:e,lastMovedCardId:R.id}),T(w||e,v,!1,D),b!=null&&b.chainedAction){const M={...b.chainedAction};M.targetOwnerId===-2&&(M.targetOwnerId=R.ownerId),b.recordContext&&(M.payload||(M.payload={}),M.payload._tempContextId=R.id),i(null),setTimeout(()=>{A(M,e)},re.MODE_CLEAR_DELAY)}else setTimeout(()=>i(null),re.MODE_CLEAR_DELAY);return!0}if(n&&n.mode==="PATROL_MOVE"){const{sourceCoords:w,sourceCard:R,isDeployAbility:v,readyStatusToRemove:D}=n;if(!w||!R)return!1;if(e.row===w.row&&e.col===w.col)return T(w,v,!1,D),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0;const b=e.row===w.row,L=e.col===w.col;return!b&&!L||r.board[e.row][e.col].card!==null?!1:(P({card:R,source:"board",boardCoords:w},{target:"board",boardCoords:e}),T(e,v,!1,D),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0)}if(n&&n.mode==="RIOT_MOVE"){const{sourceCoords:w,sourceCard:R,isDeployAbility:v,readyStatusToRemove:D,payload:b}=n;return!w||!R||!(b!=null&&b.vacatedCoords)?!1:e.row===b.vacatedCoords.row&&e.col===b.vacatedCoords.col?(P({card:R,source:"board",boardCoords:w},{target:"board",boardCoords:e}),T(e,v,!1,D),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0):(T(w,v,!1,D),i(null),!0)}if(n&&n.mode==="IMMUNIS_RETRIEVE"){const{sourceCoords:w,payload:R,isDeployAbility:v,readyStatusToRemove:D,sourceCard:b}=n;if(!w||!(Math.abs(e.row-w.row)+Math.abs(e.col-w.col)===1))return!1;if((R==null?void 0:R.selectedCardIndex)!==void 0){const G=(b==null?void 0:b.ownerId)||0;return f(G,R.selectedCardIndex,e),T(w,v,!1,D),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0}return!1}if(n&&n.mode==="INTEGRATOR_LINE_SELECT"){const{sourceCoords:w,sourceCard:R,isDeployAbility:v,readyStatusToRemove:D}=n;if(!w||w.row<0)return!1;const b=e.row===w.row,L=e.col===w.col;if(!b&&!L)return!1;const G=(R==null?void 0:R.ownerId)||0;let N=0;if(b)for(let M=0;M<c;M++){const $=r.board[e.row][M].card;$!=null&&$.statuses&&(N+=$.statuses.filter(F=>F.type==="Exploit"&&F.addedByPlayerId===G).length)}else for(let M=0;M<c;M++){const $=r.board[M][e.col].card;M!==w.row&&$!=null&&$.statuses&&(N+=$.statuses.filter(F=>F.type==="Exploit"&&F.addedByPlayerId===G).length)}return N>0&&(S(G,N),_({row:w.row,col:w.col,text:`+${N}`,playerId:G})),T(w,v,!1,D),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="IP_AGENT_THREAT_SCORING"){const{sourceCoords:w,sourceCard:R,isDeployAbility:v,readyStatusToRemove:D}=n;if(!w)return!1;const b=e.row===w.row,L=e.col===w.col;if(!b&&!L)return!1;const G=(R==null?void 0:R.ownerId)||0;let N=0;if(b)for(let $=0;$<c;$++){const F=r.board[e.row][$].card;F!=null&&F.statuses&&(N+=F.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===G).length)}else for(let $=0;$<c;$++){const F=r.board[$][e.col].card;$!==w.row&&F!=null&&F.statuses&&(N+=F.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===G).length)}const M=N*2;return M>0&&(S(G,M),_({row:w.row,col:w.col,text:`+${M}`,playerId:G})),T(w,v,!1,D),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="ZIUS_LINE_SELECT"){const{sourceCoords:w,sourceCard:R,isDeployAbility:v,readyStatusToRemove:D}=n,b=s.lastMovedCardCoords||w;if(!b)return!1;const L=e.row===b.row,G=e.col===b.col;if(!L&&!G)return!1;const N=(R==null?void 0:R.ownerId)||0;let M=0;const $=[];if(L)for(let F=0;F<c;F++){const q=r.board[e.row][F].card;if(q!=null&&q.statuses){const Z=q.statuses.filter(X=>X.type==="Exploit"&&X.addedByPlayerId===N);M+=Z.length,Z.length>0&&$.push({row:e.row,col:F})}}else for(let F=0;F<c;F++){const q=r.board[F][e.col].card;if(F!==b.row&&q!=null&&q.statuses){const Z=q.statuses.filter(X=>X.type==="Exploit"&&X.addedByPlayerId===N);M+=Z.length,Z.length>0&&$.push({row:F,col:e.col})}}return M>0&&(S(N,M),$.forEach(F=>{_({row:F.row,col:F.col,text:"+1",playerId:N})})),T(w||b,v,!1,D),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0}return n!=null&&n.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","SELECT_LINE_START","SELECT_DIAGONAL"].includes(n.mode)?(p(e),!0):l!=null&&l.card&&l.sourceCoords?(y({card:l.card,source:"hand",playerId:l.playerId,cardIndex:l.cardIndex},{location:"board",row:e.row,col:e.col}),!0):!1}function Ls(e,t,r,a){var S;const{gameState:n,localPlayerId:i,abilityMode:o,cursorStack:s,interactionLock:d,setCommandContext:l,setAbilityMode:E,moveItem:g,markAbilityUsed:A,handleActionExecution:y,triggerHandCardSelection:P,setCursorStack:T,clearTargetingMode:h,clearValidTargets:f}=a;if(!d.current){if(s){if(["Aim","Exploit","Stun","Shield"].includes(s.type))return;const p={targetOwnerId:s.targetOwnerId,excludeOwnerId:s.excludeOwnerId,onlyOpponents:s.onlyOpponents||s.targetOwnerId===-1,onlyFaceDown:s.onlyFaceDown,targetType:s.targetType,requiredTargetStatus:s.requiredTargetStatus,tokenType:s.type};if(st({card:t,ownerId:e.id,location:"hand"},p,n.activePlayerId,n.players)&&s.type==="Revealed"){const u=((S=s.sourceCard)==null?void 0:S.ownerId)??n.activePlayerId??i??1;t.statuses||(t.statuses=[]),t.statuses.some(R=>R.type==="Revealed"&&R.addedByPlayerId===u)||(t.statuses.push({type:"Revealed",addedByPlayerId:u}),g({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:e.id,cardIndex:r}),s.sourceCoords&&s.sourceCoords.row>=0&&A(s.sourceCoords,s.isDeployAbility,!1,s.readyStatusToRemove),s.count>1?T(R=>R?{...R,count:R.count-1}:null):(h(),f==null||f(),s.chainedAction&&y(s.chainedAction,s.sourceCoords||{row:-1,col:-1}),T(null)))}return}if((o==null?void 0:o.type)==="ENTER_MODE"&&o.mode==="SELECT_TARGET"){const{payload:_,sourceCoords:p,isDeployAbility:c,sourceCard:u,readyStatusToRemove:w}=o;if(P(e.id,r,n.activePlayerId??i??1),_.actionType==="SELECT_HAND_FOR_DEPLOY"){if(_.filter&&!_.filter(t))return;l(R=>({...R,selectedHandCard:{playerId:e.id,cardIndex:r}})),E({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,payload:{range:"global",moveFromHand:!0}});return}if(_.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(_.filter&&!_.filter(t)||e.id!==(u==null?void 0:u.ownerId))return;g({card:t,source:"hand",playerId:e.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),h(),f==null||f();const R={type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:u,sourceCoords:p,isDeployAbility:c,payload:{tokenName:_.tokenName}};E(R),p&&p.row>=0&&setTimeout(()=>{y(R,p)},0);return}if(_.actionType==="LUCIUS_SETUP"){if(e.id!==(u==null?void 0:u.ownerId))return;g({card:t,source:"hand",playerId:e.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),y({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:u,sourceCoords:p,isDeployAbility:c,payload:{filterType:"Command"}},p||{row:-1,col:-1}),E(null);return}if(_.actionType==="DESTROY"){if(_.filter&&!_.filter(t))return;g({card:t,source:"hand",playerId:e.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),p&&p.row>=0&&A(p,c,!1,w),setTimeout(()=>E(null),re.MODE_CLEAR_DELAY)}}}}function Gs(e,t,r){const{abilityMode:a,cursorStack:n,interactionLock:i,gameState:o,activateAbility:s}=r;a||n||i.current||o.isGameStarted&&o.activePlayerId===e.id&&Ro(t,"setup",o.currentPhase)&&s(t,{row:-1,col:-1})}function xs(e,t){var c,u,w,R,v;const{gameState:r,localPlayerId:a,abilityMode:n,interactionLock:i,setAbilityMode:o,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:l,nextPhase:E,modifyBoardCardPower:g,scoreLine:A,scoreDiagonal:y,commandContext:P}=t;if(!n)return!1;const{mode:T,sourceCard:h,sourceCoords:f,payload:S,isDeployAbility:_,readyStatusToRemove:p}=n;if(T==="SCORE_LAST_PLAYED_LINE"&&n.sourceCoords){if(i.current)return!0;const{row:D,col:b}=n.sourceCoords,{row:L,col:G}=e;if(D!==L&&b!==G)return!0;i.current=!0;const N=r.activePlayerId,M=r.board.length;let $=D,F=D,q=b,Z=b;if(D===L)$=D,F=D,q=0,Z=M-1;else if(b===G)q=G,Z=G,$=0,F=M-1;else return i.current=!1,!0;const X=r.board.some(j=>j.some(Ae=>{var Re,Se;return((Re=Ae.card)==null?void 0:Re.ownerId)===N&&Ae.card.name.toLowerCase().includes("data liberator")&&((Se=Ae.card.statuses)==null?void 0:Se.some(ve=>ve.type==="Support"))}));let de=0;const Ee=[];for(let j=$;j<=F;j++)for(let Ae=q;Ae<=Z;Ae++){const Se=r.board[j][Ae].card;if(Se&&!((c=Se.statuses)!=null&&c.some(ve=>ve.type==="Stun"))){const ve=Se.ownerId===N,Pe=(u=Se.statuses)==null?void 0:u.some(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===N);if(ve||X&&Pe&&Se.ownerId!==N){const ge=Math.max(0,Se.power+(Se.powerModifier||0)+(Se.bonusPower||0));ge>0&&(de+=ge,Ee.push({row:j,col:Ae,text:`+${ge}`,playerId:N}))}}}return o(null),Ee.length>0&&l(Ee),de>0&&d(N,de),E(),setTimeout(()=>{i.current=!1},200),!0}if(T==="SELECT_LINE_START")return o({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:h,sourceCoords:f,isDeployAbility:_,payload:{...S,firstCoords:e}}),!0;if(T==="SELECT_LINE_END"&&(S!=null&&S.firstCoords)){const{row:D,col:b}=S.firstCoords,{row:L,col:G}=e;if(D!==L&&b!==G)return!0;const N=S.actionType,M=(h==null?void 0:h.ownerId)??((w=r.players.find($=>$.id===r.activePlayerId))!=null&&w.isDummy?r.activePlayerId:a||r.activePlayerId);if(N==="ZIUS_SCORING"){const $=P.lastMovedCardCoords;if($){const j=D===L&&$.row===D,Ae=b===G&&$.col===b;if(!j&&!Ae)return!0}const F=r.board.length;let q=0,Z=F-1,X=0,de=F-1;if(D===L)q=Z=D;else if(b===G)X=de=b;else return!0;let Ee=0;for(let j=q;j<=Z;j++)for(let Ae=X;Ae<=de;Ae++){const Re=r.board[j][Ae];Re.card&&(Ee+=((R=Re.card.statuses)==null?void 0:R.filter(Se=>Se.type==="Exploit"&&Se.addedByPlayerId===M).length)||0)}Ee>0&&M&&(f&&l({row:f.row,col:f.col,text:`+${Ee}`,playerId:M}),d(M,Ee)),f&&f.row>=0&&s(f,_,!1,p)}else if(N==="CENTURION_BUFF"&&h&&f&&M){const $=r.board.length;let F=0,q=$-1,Z=0,X=$-1;D===L?F=q=D:Z=X=b;for(let de=F;de<=q;de++)for(let Ee=Z;Ee<=X;Ee++){const j=r.board[de][Ee].card;if(j){const Ae=j.id===h.id,Re=j.ownerId===M,Se=r.players.find(ge=>ge.id===M),ve=r.players.find(ge=>ge.id===j.ownerId),Pe=(Se==null?void 0:Se.teamId)!==void 0&&(ve==null?void 0:ve.teamId)!==void 0&&Se.teamId===ve.teamId;!Ae&&(Re||Pe)&&g({row:de,col:Ee},1)}}s(f,_,!1,p)}else(N==="SCORE_LINE"||!N)&&(A(D,b,L,G,M),S.skipNextPhase||E());return setTimeout(()=>o(null),re.MODE_CLEAR_DELAY),!0}if(T==="SELECT_DIAGONAL"&&S.actionType==="SCORE_DIAGONAL"){const D=(h==null?void 0:h.ownerId)??((v=r.players.find(b=>b.id===r.activePlayerId))!=null&&v.isDummy?r.activePlayerId:a||r.activePlayerId);if(S.firstCoords){const{row:b,col:L}=S.firstCoords,{row:G,col:N}=e;return Math.abs(b-G)!==Math.abs(L-N)?(o(null),!0):(y(b,L,G,N,D,S.bonusType),S.skipNextPhase||E(),o(null),!0)}else return o({...n,payload:{...S,firstCoords:e}}),!0}return!1}function Us(e,t,r){const{gameState:a,localPlayerId:n,abilityMode:i,interactionLock:o,handleLineSelection:s}=r;if(!i||i.type!=="ENTER_MODE"||o.current||i.sourceCard&&i.sourceCard.id===e.id&&i.mode!=="SELECT_LINE_START"&&i.mode!=="INTEGRATOR_LINE_SELECT"&&i.mode!=="ZIUS_LINE_SELECT"&&i.mode!=="IP_AGENT_THREAT_SCORING"&&i.mode!=="SELECT_UNIT_FOR_MOVE"&&i.mode!=="SELECT_TARGET"&&i.mode!=="RIOT_PUSH"&&i.mode!=="RIOT_MOVE"&&i.mode!=="REVEREND_DOUBLE_EXPLOIT"&&i.mode!=="SHIELD_SELF_THEN_RIOT_PUSH")return!1;const{mode:d,payload:l,sourceCard:E}=i;return d==="SELECT_LINE_START"||d==="SELECT_LINE_END"?(s(t),!0):d==="SELECT_TARGET"&&l.tokenType?Hs(e,t,r):d==="SELECT_TARGET"?$s(e,t,r):d==="RIOT_PUSH"?Fs(e,t,r):d==="SHIELD_SELF_THEN_RIOT_PUSH"?Bs(e,t,r):d==="RIOT_MOVE"?Ws(e,t,r):d==="SWAP_POSITIONS"?Ys(e,t,r):d==="TRANSFER_STATUS_SELECT"?Ks(e,t,r):d==="ZEALOUS_WEAKEN"?zs(e,t,r):d==="REVEREND_DOUBLE_EXPLOIT"?qs(e,t,r):d==="SELECT_UNIT_FOR_MOVE"?js(e,t,r):d==="PATROL_MOVE"?Vs(e,t,r):d==="SPAWN_TOKEN"?Js(e,t,r):d==="REVEAL_ENEMY"?Xs(e,t,r):d==="SELECT_CELL"?Zs(e,t,r):d==="IMMUNIS_RETRIEVE"?Qs(e,t,r):d==="INTEGRATOR_LINE_SELECT"?ei(e,t,r):d==="IP_AGENT_THREAT_SCORING"?ti(e,t,r):d==="ZIUS_LINE_SELECT"?ri(e,t,r):d==="SELECT_DIAGONAL"?ai(e,t,r):d==="SCORE_LAST_PLAYED_LINE"?ni(e,t,r):d==="SEARCH_DECK"?oi(e,t,r):d==="RETRIEVE_DEVICE"?si(e,t,r):d==="SELECT_DECK"?ii(e,t,r):!1}function Hs(e,t,r){const{abilityMode:a,triggerClickWave:n,moveItem:i,markAbilityUsed:o,setAbilityMode:s,setCommandContext:d,handleActionExecution:l,clearValidTargets:E}=r,{payload:g,sourceCoords:A,isDeployAbility:y,readyStatusToRemove:P}=a;if(g.filter&&!g.filter(e,t.row,t.col))return!1;if(i({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:g.tokenType,count:g.count||1},{target:"board",boardCoords:t}),n("board",t),g.recordContext&&d({lastMovedCardCoords:t,lastMovedCardId:e.id}),g.chainedAction){const T={...g.chainedAction,sourceCard:g.chainedAction.sourceCard??e,sourceCoords:g.chainedAction.sourceCoords??t,isDeployAbility:y,recordContext:!0};l(T,t),setTimeout(()=>n("board",t),100),T.type!=="ENTER_MODE"&&(s(null),E())}else A&&A.row>=0&&o(A,y,!1,P),setTimeout(()=>{s(null),E()},re.MODE_CLEAR_DELAY);return!0}function $s(e,t,r){var c,u,w,R,v;const{abilityMode:a,markAbilityUsed:n,setAbilityMode:i,moveItem:o,modifyBoardCardPower:s,addBoardCardStatus:d,removeBoardCardStatus:l,removeBoardCardStatusByOwner:E,removeStatusByType:g,resetDeployStatus:A,setCounterSelectionData:y,handleActionExecution:P,gameState:T}=r,{payload:h,sourceCoords:f,isDeployAbility:S,readyStatusToRemove:_}=a,p=((c=a.sourceCard)==null?void 0:c.ownerId)??((u=T.players.find(D=>D.id===T.activePlayerId))!=null&&u.isDummy?T.activePlayerId:r.localPlayerId||T.activePlayerId);if(h.actionType==="OPEN_COUNTER_MODAL")return h.filter&&!h.filter(e)?!1:(y({card:e,callbackAction:h.rewardType}),i(null),!0);if(h.actionType==="SACRIFICE_AND_BUFF_LINES"){if(h.filter&&!h.filter(e,t.row,t.col))return!1;const D=((w=a.sourceCard)==null?void 0:w.ownerId)??p;o({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"discard",playerId:e.ownerId});const b=T.board.length,{row:L,col:G}=t;for(let N=0;N<b;N++){if(N===G)continue;const $=T.board[L][N].card;$&&$.ownerId===D&&s({row:L,col:N},1)}for(let N=0;N<b;N++){if(N===L)continue;const $=T.board[N][G].card;$&&$.ownerId===D&&s({row:N,col:G},1)}return n(f||t,S,!1,_),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0}if(h.actionType==="SHIELD_AND_REMOVE_AIM")return h.filter&&!h.filter(e)?!1:(d(t,"Shield",p),g(t,"Aim"),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0);if(h.actionType==="RESET_DEPLOY")return h.filter&&!h.filter(e)?!1:(A(t),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0);if(h.actionType==="MODIFY_POWER")return h.filter&&!h.filter(e)?!1:(h.amount&&s(t,h.amount),f&&f.row>=0&&n(f,S,!1,_),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0);if(h.actionType==="DESTROY")return h.filter&&!h.filter(e)?!1:(((R=e.statuses)==null?void 0:R.some(b=>b.type==="Shield"))?l(t,"Shield"):o({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),n(f||t,S,!1,_),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0);if(h.actionType==="LUCIUS_SETUP")return h.filter&&!h.filter(e)?!1:(o({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),h.chainedAction&&P(h.chainedAction,t),!0);if(h.actionType==="CENSOR_SWAP"){if(h.filter&&!h.filter(e))return!1;const D=((v=e.statuses)==null?void 0:v.filter(b=>b.type==="Exploit"&&b.addedByPlayerId===p).length)||0;if(D>0){E(t,"Exploit",p);for(let b=0;b<D;b++)d(t,"Stun",p)}return n(f||t,S,!1,_),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0}if(h.actionType==="REVEAL_ENEMY_CHAINED"){if(h.filter&&!h.filter(e,t.row,t.col))return!1;const D=e.ownerId;if(a.chainedAction){const b={...a.chainedAction,targetOwnerId:D,sourceCoords:f||t,sourceCard:a.sourceCard};P(b,t)}return n(f||t,S,!1,_),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0}return!1}function Fs(e,t,r){const{abilityMode:a,gameState:n,setAbilityMode:i,moveItem:o,markAbilityUsed:s,interactionLock:d}=r;if(d.current)return!1;const{sourceCoords:l,isDeployAbility:E,readyStatusToRemove:g,sourceCard:A}=a;if(!l||l.row<0)return!1;if(t.row===l.row&&t.col===l.col)return s(l,E,!1,g),setTimeout(()=>i(null),re.MODE_CLEAR_DELAY),!0;const y=Math.abs(t.row-l.row)+Math.abs(t.col-l.col)===1,P=n.players.find(v=>v.id===e.ownerId),T=n.players.find(v=>v.id===(A==null?void 0:A.ownerId)),h=(P==null?void 0:P.teamId)!==void 0&&(T==null?void 0:T.teamId)!==void 0&&P.teamId===T.teamId;if(!y||e.ownerId===(A==null?void 0:A.ownerId)||h)return!1;const f=t.row-l.row,S=t.col-l.col,_=t.row+f,p=t.col+S,c=n.board.length,u=Math.floor((c-n.activeGridSize)/2),w=u,R=u+n.activeGridSize-1;return _<w||_>R||p<w||p>R||n.board[_][p].card!==null?!1:(o({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:_,col:p}}),i({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:A,sourceCoords:l,isDeployAbility:E,payload:{vacatedCoords:t}}),!0)}function Ws(e,t,r){const{abilityMode:a,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=r;if(!a||a.mode!=="RIOT_MOVE")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:l,readyStatusToRemove:E,payload:g}=a;return!s||!d||!(g!=null&&g.vacatedCoords)?!1:t.row===g.vacatedCoords.row&&t.col===g.vacatedCoords.col?(n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),i(t,l,!1,E),setTimeout(()=>o(null),re.MODE_CLEAR_DELAY),!0):(i(s,l,!1,E),o(null),!0)}function Bs(e,t,r){const{abilityMode:a,setAbilityMode:n,addBoardCardStatus:i,markAbilityUsed:o,interactionLock:s}=r;if(s.current)return!1;const{sourceCoords:d,isDeployAbility:l,readyStatusToRemove:E,sourceCard:g}=a;if(!d||d.row<0||!g)return!1;const A=g.ownerId;return t.row===d.row&&t.col===d.col?(i(d,"Shield",A),o(d,l,!1,E),setTimeout(()=>n(null),re.MODE_CLEAR_DELAY),!0):(i(d,"Shield",A),n({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:g,sourceCoords:d,isDeployAbility:l,readyStatusToRemove:E,payload:{}}),!0)}function Ys(e,t,r){const{abilityMode:a,gameState:n,swapCards:i,markAbilityUsed:o,setAbilityMode:s,validTargets:d}=r;if(!a||a.mode!=="SWAP_POSITIONS")return!1;const{sourceCoords:l,sourceCard:E,isDeployAbility:g,readyStatusToRemove:A,payload:y}=a;if(!l||l.row<0)return!1;const P=n.board[l.row][l.col].card;return!P||P.id!==(E==null?void 0:E.id)?(s(null),!1):E&&E.id===e.id||y.filter&&!y.filter(e,t.row,t.col)||!y.filter&&d&&!d.some(h=>h.row===t.row&&h.col===t.col)?!1:(i(l,t),o(t,g,!1,A),setTimeout(()=>s(null),re.MODE_CLEAR_DELAY),!0)}function Ks(e,t,r){const{abilityMode:a,transferStatus:n,markAbilityUsed:i,setAbilityMode:o}=r;if(!a||a.mode!=="TRANSFER_STATUS_SELECT")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:l,readyStatusToRemove:E}=a;return!s||s.row<0||d&&d.id===e.id||!e.statuses||e.statuses.length===0?!1:(n(t,s,e.statuses[0].type),i(s,l,!1,E),setTimeout(()=>o(null),re.MODE_CLEAR_DELAY),!0)}function zs(e,t,r){const{abilityMode:a,modifyBoardCardPower:n,markAbilityUsed:i,setAbilityMode:o}=r;if(!a||a.mode!=="ZEALOUS_WEAKEN")return!1;const{payload:s,sourceCoords:d,isDeployAbility:l,readyStatusToRemove:E}=a;return s.filter&&!s.filter(e)?!1:(n(t,-1),i(d||t,l,!1,E),setTimeout(()=>o(null),re.MODE_CLEAR_DELAY),!0)}function qs(e,t,r){const{abilityMode:a,gameState:n,addBoardCardStatus:i,markAbilityUsed:o,triggerFloatingText:s,setAbilityMode:d}=r;if(!a||a.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{sourceCoords:l,sourceCard:E,isDeployAbility:g,readyStatusToRemove:A}=a,y=(E==null?void 0:E.ownerId)||0,P=(e.statuses||[]).filter(T=>T.type==="Exploit"&&T.addedByPlayerId===y).length;if(P>0){for(let T=0;T<P;T++)i(t,"Exploit",y);s({row:t.row,col:t.col,text:`+${P}`,playerId:y,timestamp:Date.now()})}return o(l||t,g,!1,A),setTimeout(()=>d(null),re.MODE_CLEAR_DELAY),!0}function js(e,t,r){const{abilityMode:a,setAbilityMode:n}=r;if(!a||a.mode!=="SELECT_UNIT_FOR_MOVE")return!1;const{sourceCard:i,payload:o,isDeployAbility:s,readyStatusToRemove:d}=a;return i&&i.id===e.id||o.filter&&!o.filter(e,t.row,t.col)?!1:(n({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:t,isDeployAbility:s,readyStatusToRemove:d,payload:{range:o.range||2,moveFromHand:o.moveFromHand||!1,selectedCard:e,allowSelf:!1}}),!0)}function Vs(e,t,r){const{abilityMode:a,gameState:n,moveItem:i,markAbilityUsed:o,setAbilityMode:s}=r;if(!a||a.mode!=="PATROL_MOVE")return!1;const{sourceCoords:d,sourceCard:l,isDeployAbility:E,readyStatusToRemove:g}=a;if(!d||!l)return!1;if(t.row===d.row&&t.col===d.col)return o(d,E,!1,g),setTimeout(()=>s(null),re.MODE_CLEAR_DELAY),!0;const A=t.row===d.row,y=t.col===d.col;return!A&&!y||n.board[t.row][t.col].card!==null?!1:(i({card:l,source:"board",boardCoords:d},{target:"board",boardCoords:t}),o(t,E,!1,g),setTimeout(()=>s(null),re.MODE_CLEAR_DELAY),!0)}function Js(e,t,r){var P;const{abilityMode:a,spawnToken:n,markAbilityUsed:i,setAbilityMode:o}=r;if(!a||a.mode!=="SPAWN_TOKEN")return!1;const{sourceCoords:s,payload:d,isDeployAbility:l,readyStatusToRemove:E,sourceCard:g}=a;if(!s||!(d!=null&&d.tokenName)||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1))return!1;const y=(g==null?void 0:g.ownerId)??((P=a.sourceCard)==null?void 0:P.ownerId);return n(t,d.tokenName,y),i(s,l,!1,E),setTimeout(()=>o(null),re.MODE_CLEAR_DELAY),!0}function Xs(e,t,r){var c;const{abilityMode:a,setAbilityMode:n,setCursorStack:i,moveItem:o,markAbilityUsed:s,gameState:d,localPlayerId:l}=r;if(!a||a.mode!=="REVEAL_ENEMY")return!1;const{sourceCoords:E,sourceCard:g,isDeployAbility:A,readyStatusToRemove:y,payload:P}=a;if(!E||!g||!(Math.abs(t.row-E.row)+Math.abs(t.col-E.col)===1)||e.deck==="Tokens"||((c=e.types)==null?void 0:c.includes("Token")))return!1;const f=e.ownerId,S=d.players.find(u=>u.id===d.activePlayerId),_=S!=null&&S.isDummy&&d.activePlayerId!==null?d.activePlayerId:l??0;return i(dr("Revealed",_,null,{targetOwnerId:f,onlyFaceDown:!0,sourceCoords:t,sourceCard:e,isDeployAbility:A,readyStatusToRemove:y})),s(E,A,!1,y),setTimeout(()=>n(null),re.MODE_CLEAR_DELAY),!0}function Zs(e,t,r){const{abilityMode:a,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=r;if(!a||a.mode!=="SELECT_CELL")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:l,readyStatusToRemove:E,payload:g}=a;return g!=null&&g.filter&&!g.filter(null,t.row,t.col)?!1:(g!=null&&g.moveFromHand&&(g!=null&&g.selectedCard)?n({card:g.selectedCard,source:"hand"},{target:"board",boardCoords:t}):s&&s.row>=0&&d&&n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),i(s||t,l,!1,E),setTimeout(()=>o(null),re.MODE_CLEAR_DELAY),!0)}function Qs(e,t,r){const{abilityMode:a,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=r;if(!a||a.mode!=="IMMUNIS_RETRIEVE")return!1;const{sourceCoords:s,payload:d,isDeployAbility:l,readyStatusToRemove:E}=a;return!s||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1)?!1:d!=null&&d.selectedCard?(n({card:d.selectedCard,source:"discard"},{target:"board",boardCoords:t}),i(s,l,!1,E),setTimeout(()=>o(null),re.MODE_CLEAR_DELAY),!0):!1}function ei(e,t,r){const{abilityMode:a,gameState:n,moveItem:i,markAbilityUsed:o,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:l}=r;if(!a||a.mode!=="INTEGRATOR_LINE_SELECT")return!1;const{sourceCoords:E,sourceCard:g,isDeployAbility:A,readyStatusToRemove:y}=a,P=(g==null?void 0:g.ownerId)||0,T=E!==void 0&&t.row===E.row,h=E!==void 0&&t.col===E.col;if(!T&&!h)return!1;let f=0;if(T&&E)for(let S=0;S<n.board.length;S++){const _=n.board[t.row][S].card;_!=null&&_.statuses&&(f+=_.statuses.filter(p=>p.type==="Exploit"&&p.addedByPlayerId===P).length)}else if(E)for(let S=0;S<n.board.length;S++){const _=n.board[S][t.col].card;S!==E.row&&_!=null&&_.statuses&&(f+=_.statuses.filter(p=>p.type==="Exploit"&&p.addedByPlayerId===P).length)}return f>0&&(s(P,f),d({row:E.row,col:E.col,text:`+${f}`,playerId:P,timestamp:Date.now()})),o(E||t,A,!1,y),setTimeout(()=>l(null),re.MODE_CLEAR_DELAY),!0}function ti(e,t,r){const{abilityMode:a,gameState:n,updatePlayerScore:i,triggerFloatingText:o,markAbilityUsed:s,setAbilityMode:d}=r;if(!a||a.mode!=="IP_AGENT_THREAT_SCORING")return!1;const{sourceCoords:l,sourceCard:E,isDeployAbility:g,readyStatusToRemove:A}=a,y=(E==null?void 0:E.ownerId)||0;if(!l)return!1;const P=t.row===l.row,T=t.col===l.col;if(!P&&!T)return!1;let h=0;if(P)for(let S=0;S<n.board.length;S++){const _=n.board[t.row][S].card;_!=null&&_.statuses&&(h+=_.statuses.filter(p=>p.type==="Threat"&&p.addedByPlayerId===y).length)}else for(let S=0;S<n.board.length;S++){const _=n.board[S][t.col].card;S!==l.row&&_!=null&&_.statuses&&(h+=_.statuses.filter(p=>p.type==="Threat"&&p.addedByPlayerId===y).length)}const f=h*2;return f>0&&(i(y,f),o({row:l.row,col:l.col,text:`+${f}`,playerId:y,timestamp:Date.now()})),s(l||t,g,!1,A),setTimeout(()=>d(null),re.MODE_CLEAR_DELAY),!0}function ri(e,t,r){const{abilityMode:a,gameState:n,commandContext:i,updatePlayerScore:o,triggerFloatingText:s,markAbilityUsed:d,setAbilityMode:l}=r;if(!a||a.mode!=="ZIUS_LINE_SELECT")return!1;const{sourceCoords:E,sourceCard:g,isDeployAbility:A,readyStatusToRemove:y}=a,P=(g==null?void 0:g.ownerId)||0,T=i.lastMovedCardCoords||E;if(!T)return!1;const h=t.row===T.row,f=t.col===T.col;if(!h&&!f)return!1;let S=0;const _=[];if(h)for(let p=0;p<n.board.length;p++){const c=n.board[t.row][p].card;if(c!=null&&c.statuses){const u=c.statuses.filter(w=>w.type==="Exploit"&&w.addedByPlayerId===P);S+=u.length,u.length>0&&_.push({row:t.row,col:p})}}else for(let p=0;p<n.board.length;p++){const c=n.board[p][t.col].card;if(p!==T.row&&c!=null&&c.statuses){const u=c.statuses.filter(w=>w.type==="Exploit"&&w.addedByPlayerId===P);S+=u.length,u.length>0&&_.push({row:p,col:t.col})}}return S>0&&(o(P,S),_.forEach(p=>{s({row:p.row,col:p.col,text:"+1",playerId:P,timestamp:Date.now()})})),d(E||t,A,!1,y),setTimeout(()=>l(null),re.MODE_CLEAR_DELAY),!0}function ai(e,t,r){var R;const{abilityMode:a,gameState:n,moveItem:i,markAbilityUsed:o,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:l}=r;if(!a||a.mode!=="SELECT_DIAGONAL")return!1;const{sourceCoords:E,sourceCard:g,isDeployAbility:A,readyStatusToRemove:y,payload:P}=a,T=(g==null?void 0:g.ownerId)||0,{row:h,col:f}=t,{row:S,col:_}=E||{row:0,col:0},p=h-f===S-_,c=h+f===S+_;if(!p&&!c)return!1;if(P!=null&&P.selectForMove&&e)return P.chainedAction&&r.handleActionExecution(P.chainedAction,t),!0;let u=0;const w=n.board.length;if(p){const v=S-_;for(let D=0;D<w;D++){const b=v+D,L=D;if(b>=0&&b<w&&L>=0&&L<w){const G=n.board[b][L].card;G!=null&&G.statuses&&(u+=G.statuses.filter(N=>N.type==="Exploit"&&N.addedByPlayerId===T).length)}}}if(c){const v=S+_;for(let D=0;D<w;D++){const b=D,L=v-b;if(b>=0&&b<w&&L>=0&&L<w){const G=n.board[b][L].card;G!=null&&G.statuses&&(u+=G.statuses.filter(N=>N.type==="Exploit"&&N.addedByPlayerId===T).length)}}}return P!=null&&P.bonusForSupport&&((R=g==null?void 0:g.statuses)!=null&&R.some(v=>v.type==="Support"))&&(u+=P.bonusForSupport),u>0&&(s(T,u),d({row:(E==null?void 0:E.row)||t.row,col:(E==null?void 0:E.col)||t.col,text:`+${u}`,playerId:T,timestamp:Date.now()})),o(E||t,A,!1,y),setTimeout(()=>l(null),re.MODE_CLEAR_DELAY),!0}function ni(e,t,r){const{abilityMode:a,gameState:n,commandContext:i,moveItem:o,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:l,setAbilityMode:E}=r;if(!a||a.mode!=="SCORE_LAST_PLAYED_LINE")return!1;const{sourceCoords:g,sourceCard:A,isDeployAbility:y,readyStatusToRemove:P,payload:T}=a,h=(A==null?void 0:A.ownerId)||0,f=i.lastMovedCardCoords;if(!f)return!1;const S=n.board[f.row][f.col].card;if(!S)return!1;const _=t.row===f.row,p=t.col===f.col;if(!_&&!p)return!1;const c=Math.max(0,S.power+(S.powerModifier||0));return(T==null?void 0:T.rewardType)==="SCORE"?(d(h,c),l({row:f.row,col:f.col,text:`+${c}`,playerId:h,timestamp:Date.now()})):T==null||T.rewardType,s(g||t,y,!1,P),setTimeout(()=>E(null),re.MODE_CLEAR_DELAY),!0}function oi(e,t,r){const{abilityMode:a,setViewingDiscard:n,markAbilityUsed:i,setAbilityMode:o}=r;if(!a||a.mode!=="SEARCH_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:l}=a;return n(!0),i(s||t,d,!1,l),o(null),!0}function si(e,t,r){const{abilityMode:a,setViewingDiscard:n,markAbilityUsed:i,setAbilityMode:o}=r;if(!a||a.mode!=="RETRIEVE_DEVICE")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:l}=a;return n(!0),i(s||t,d,!1,l),o(null),!0}function ii(e,t,r){const{abilityMode:a,triggerDeckSelection:n,markAbilityUsed:i,setAbilityMode:o}=r;if(!a||a.mode!=="SELECT_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:l}=a;return n(e.ownerId??0),i(s||t,d,!1,l),setTimeout(()=>o(null),re.MODE_CLEAR_DELAY),!0}const Ni=({gameState:e,localPlayerId:t,abilityMode:r,setAbilityMode:a,cursorStack:n,setCursorStack:i,commandContext:o,setCommandContext:s,setViewingDiscard:d,triggerNoTarget:l,triggerClickWave:E,playMode:g,setPlayMode:A,setCounterSelectionData:y,interactionLock:P,onAbilityComplete:T,updateState:h,moveItem:f,drawCard:S,drawCardsBatch:_,updatePlayerScore:p,markAbilityUsed:c,applyGlobalEffect:u,swapCards:w,transferStatus:R,transferAllCounters:v,resurrectDiscardedCard:D,spawnToken:b,scoreLine:L,nextPhase:G,modifyBoardCardPower:N,addBoardCardStatus:M,removeBoardCardStatus:$,removeBoardCardStatusByOwner:F,resetDeployStatus:q,scoreDiagonal:Z,removeStatusByType:X,triggerFloatingText:de,triggerHandCardSelection:Ee,clearValidTargets:j,setTargetingMode:Ae,clearTargetingMode:Re,validTargets:Se})=>{const ve=H.useRef(()=>{}),Pe=H.useCallback(ke=>{xs(ke,{gameState:e,localPlayerId:t,abilityMode:r,interactionLock:P,setAbilityMode:a,markAbilityUsed:c,updatePlayerScore:p,triggerFloatingText:de,nextPhase:G,modifyBoardCardPower:N,scoreLine:L,scoreDiagonal:Z,commandContext:o})},[r,e,t,P,a,c,p,de,G,N,L,Z,o]);ve.current=Pe;const ge=H.useCallback((ke,xe)=>{Rs(ke,xe,{gameState:e,localPlayerId:t,setAbilityMode:a,setCursorStack:i,commandContext:o,markAbilityUsed:c,triggerNoTarget:l,handleActionExecution:ge,modifyBoardCardPower:N,addBoardCardStatus:M,removeBoardCardStatus:$,removeStatusByType:X,updatePlayerScore:p,triggerFloatingText:de,setViewingDiscard:d,handleLineSelection:ve.current,onAbilityComplete:T,applyGlobalEffect:u,drawCardsBatch:_,setTargetingMode:Ae})},[e,t,r,a,n,i,o,s,A,c,l,P,f,w,R,v,b,N,M,$,F,X,q,p,de,y,d,Se,T,u,_,Ae]);H.useEffect(()=>{(r==null?void 0:r.type)==="GLOBAL_AUTO_APPLY"&&(ge(r,r.sourceCoords||{row:-1,col:-1}),a(null))},[r,ge,a]),H.useEffect(()=>{r||Re()},[r,Re]);const We=H.useCallback((ke,xe)=>{ba(ke,xe,{gameState:e,localPlayerId:t,abilityMode:r,cursorStack:n,handleActionExecution:ge,markAbilityUsed:c})},[e,t,r,n,ge,c]),Lt=H.useCallback((ke,xe)=>{var Ve,Qe;if(n&&A!==null&&A!==void 0){const et={targetOwnerId:n.targetOwnerId,excludeOwnerId:n.excludeOwnerId,onlyOpponents:n.onlyOpponents||n.targetOwnerId===-1,onlyFaceDown:n.onlyFaceDown,targetType:n.targetType,requiredTargetStatus:n.requiredTargetStatus,tokenType:n.type};if(st({card:ke,ownerId:ke.ownerId??0,location:"board"},et,e.activePlayerId,e.players)){if(n.type==="Revealed"){const tt=((Ve=n.sourceCard)==null?void 0:Ve.ownerId)??e.activePlayerId??t??1;if((Qe=ke.statuses)==null?void 0:Qe.some(Te=>Te.type==="Revealed"&&Te.addedByPlayerId===tt))return}f({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:n.type,count:1},{target:"board",boardCoords:xe}),n.sourceCoords&&n.sourceCoords.row>=0&&c(n.sourceCoords,n.isDeployAbility,!1,n.readyStatusToRemove),n.count>1?i(tt=>tt?{...tt,count:tt.count-1}:null):(Re(),j(),n.chainedAction&&ge(n.chainedAction,n.sourceCoords||{row:-1,col:-1}),i(null))}return}if(!P.current){if(!r&&!n&&e.isGameStarted&&Oa(ke,e)){We(ke,xe);return}if(r&&(r.mode==="SCORE_LAST_PLAYED_LINE"||r.mode==="SELECT_LINE_END")){Pe(xe);return}(r==null?void 0:r.type)==="ENTER_MODE"&&Us(ke,xe,{gameState:e,localPlayerId:t,abilityMode:r,setAbilityMode:a,cursorStack:n,setCursorStack:i,commandContext:o,setCommandContext:s,playMode:null,setPlayMode:A,draggedItem:null,setDraggedItem:()=>{},openContextMenu:()=>{},markAbilityUsed:c,triggerNoTarget:l,triggerClickWave:E,handleActionExecution:ge,interactionLock:P,moveItem:f,swapCards:w,transferStatus:R,transferAllCounters:v,spawnToken:b,modifyBoardCardPower:N,addBoardCardStatus:M,removeBoardCardStatus:$,removeBoardCardStatusByOwner:F,removeStatusByType:X,resetDeployStatus:q,updatePlayerScore:p,triggerFloatingText:de,setCounterSelectionData:y,setViewingDiscard:d,clearValidTargets:j,validTargets:Se,handleLineSelection:Pe})||!r&&!n&&We(ke,xe)}},[n,A,e,t,P,r,Pe,f,c,i,ge,a,s,y,d,b,w,R,v,N,M,$,F,X,q,p,de,l,E,Se,Re,We]),ct=H.useCallback(ke=>{Ms(ke,{gameState:e,localPlayerId:t,abilityMode:r,setAbilityMode:a,cursorStack:n,commandContext:o,setCommandContext:s,playMode:g,draggedItem:null,interactionLock:P,handleActionExecution:ge,handleDrop:f,moveItem:f,markAbilityUsed:c,spawnToken:b,resurrectDiscardedCard:D,updatePlayerScore:p,triggerFloatingText:de,handleLineSelection:Pe})},[e,t,r,a,n,o,s,g,P,ge,f,i,l,c,b,D,p,de,Pe]),ze=H.useCallback((ke,xe,Ve)=>{Ls(ke,xe,Ve,{gameState:e,localPlayerId:t,abilityMode:r,cursorStack:n,interactionLock:P,setCommandContext:s,setAbilityMode:a,moveItem:f,markAbilityUsed:c,handleActionExecution:ge,triggerHandCardSelection:Ee,setCursorStack:i,clearTargetingMode:Re,clearValidTargets:j})},[r,n,e,t,ge,c,a,s,Ee,f,i,Re,j,P]),Y=H.useCallback((ke,xe)=>{Gs(ke,xe,{abilityMode:r,cursorStack:n,gameState:e,activateAbility:(Ve,Qe)=>ba(Ve,Qe,{gameState:e,localPlayerId:t,abilityMode:r,cursorStack:n,handleActionExecution:ge,markAbilityUsed:c})})},[r,n,e,t,ge,c]);return{activateAbility:We,executeAction:ge,handleLineSelection:Pe,handleBoardCardClick:Lt,handleEmptyCellClick:ct,handleHandCardClick:ze,handleAnnouncedCardDoubleClick:Y}},Vt=(e,t,r,a,n)=>{const i=(r.baseId||e.split("_")[1]||e).toLowerCase(),o=t===-1,s=[];i==="overwatch"?o?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},targetOwnerId:-1,onlyOpponents:!0,sourceCard:r}):t===1&&s.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:n,baseCount:0}},sourceCard:r}):i==="tacticalmaneuver"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:l=>l.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:r}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:l=>l.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:r}}}):i==="inspiration"?o&&s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"OPEN_COUNTER_MODAL",filter:l=>l.ownerId===n}}):i==="datainterception"?o?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:l=>{var E;return((E=l.statuses)==null?void 0:E.some(g=>g.type==="Exploit"&&g.addedByPlayerId===n))||!1}}}):i==="falseorders"?o?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):t===0?s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:n,sourceCard:r,originalOwnerId:r.ownerId}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:n}}}}):i==="experimentalstimulants"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"RESET_DEPLOY",filter:l=>{var E;return l.ownerId===n&&((E=l.types)==null?void 0:E.includes("Unit"))}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:"line",filter:l=>l.ownerId===n}}):i==="logisticschain"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):i==="quickresponseteam"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:l=>{var E;return l.ownerId===n&&((E=l.types)==null?void 0:E.includes("Unit"))}}}):t===1&&s.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:r,payload:{filterType:"Unit"}}):i==="temporaryshelter"?t===0?s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:r,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):t===1&&s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:r,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):i==="enhancedinterrogation"?o?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:l=>{var E;return((E=l.statuses)==null?void 0:E.some(g=>g.type==="Aim"&&g.addedByPlayerId===n))||!1}}}):(i==="mobilization1"||i==="linebreach")&&o&&s.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:r,payload:{actionType:"SCORE_LINE"}});const d=r.ownerId||n;return s.forEach(l=>{l.originalOwnerId=d,l.sourceCard&&!l.sourceCard.ownerId&&(l.sourceCard.ownerId=d)}),s},Mi=({gameState:e,localPlayerId:t,setActionQueue:r,setCommandContext:a,setCommandModalCard:n,setCounterSelectionData:i,moveItem:o,updatePlayerScore:s,updateState:d})=>{const l=H.useCallback((A,y)=>{if(t===null)return;const P=e.players.find(S=>S.id===y.playerId);if(!(y.playerId===t||(P==null?void 0:P.isDummy)))return;o(y,{target:"announced",playerId:y.playerId}),a({});const h=(A.baseId||A.id.split("_")[1]||A.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(S=>h.includes(S)))n(A);else{const S=Vt(A.id,-1,A,e,y.playerId);S.length>0?r([...S,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:A,ownerId:y.playerId},sourceCard:A}]):r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:A,ownerId:y.playerId},sourceCard:A}])}},[e,t,o,r,a,n]),E=H.useCallback((A,y)=>{var _,p;if(!y||t===null)return;const P=y.ownerId||t,T=[],h=Vt(y.id,-1,y,e,P);let f;(_=y.baseId)!=null&&_.toLowerCase().includes("inspiration")&&(f=A===0?"DRAW_REMOVED":"SCORE_REMOVED",h.length>0&&h[0].type==="ENTER_MODE"&&(h[0]={...h[0],payload:{...h[0].payload,rewardType:f}})),h.forEach(c=>{T.push(c)}),Vt(y.id,A,y,e,P).forEach(c=>{T.push(c)}),(p=y.baseId)!=null&&p.toLowerCase().includes("inspiration")||T.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:y,ownerId:P},sourceCard:y}),r(T),n(null)},[e,t,r,n]),g=H.useCallback((A,y)=>{var f;if(t===null)return;const P=y.card.ownerId||t;let T=null;for(let S=0;S<e.board.length;S++){for(let _=0;_<e.board[S].length;_++)if(((f=e.board[S][_].card)==null?void 0:f.id)===y.card.id){T={row:S,col:_};break}if(T)break}if(!T){m.warn(`Card ${y.card.id} not found on board during counter removal`),i(null);return}if(d(S=>{if(!S.isGameStarted)return S;const _=me(S),p=_.board[T.row][T.col].card;let c=0;const u=(p==null?void 0:p.statuses)??[];if(Object.entries(A).forEach(([w,R])=>{for(let v=0;v<R;v++){const D=u.map(b=>b.type).lastIndexOf(w);D>-1&&(p!=null&&p.statuses)&&(p.statuses.splice(D,1),c++)}}),!(p!=null&&p.statuses)&&p&&(p.statuses=[]),_.board=Ne(_),c>0&&y.callbackAction==="DRAW_REMOVED"){const w=_.players.find(R=>R.id===P);if(w){const R=Math.min(c,w.deck.length);for(let v=0;v<R;v++){const D=w.deck.shift();D&&w.hand.push(D)}}}return _}),y.callbackAction==="SCORE_REMOVED"){const S=Object.values(A).reduce((_,p)=>_+p,0);S>0&&s(P,S)}const h=e.players.find(S=>S.id===P);h!=null&&h.announcedCard&&r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:h.announcedCard,ownerId:P},sourceCard:h.announcedCard}]),i(null)},[t,s,r,i,e,d]);return{playCommandCard:l,handleCommandConfirm:E,handleCounterSelectionConfirm:g}},Li=({gameState:e,localPlayerId:t,handleDrop:r,markAbilityUsed:a,requestCardReveal:n,interactionLock:i,setCommandContext:o,onAction:s,cursorStack:d,setCursorStack:l,setAbilityMode:E,triggerClickWave:g,clearTargetingMode:A})=>{const y=H.useRef(null),P=H.useRef({x:0,y:0});return H.useLayoutEffect(()=>{if(d&&y.current){const{x:h,y:f}=P.current;y.current.style.transform=`translate(${h-24}px, ${f-24}px)`}},[d]),H.useEffect(()=>{const h=f=>{P.current={x:f.clientX,y:f.clientY},y.current&&(y.current.style.transform=`translate(${f.clientX-24}px, ${f.clientY-24}px)`)};return window.addEventListener("mousemove",h),()=>window.removeEventListener("mousemove",h)},[]),H.useEffect(()=>{const h=f=>{var c,u,w,R,v,D;if(f.button!==0||!d)return;const S=document.elementFromPoint(f.clientX,f.clientY);let _=t;if(d.originalOwnerId!==void 0)_=d.originalOwnerId;else if((c=d.sourceCard)!=null&&c.ownerId)_=d.sourceCard.ownerId;else if(d.sourceCoords&&d.sourceCoords.row>=0){const{row:b,col:L}=d.sourceCoords;if(b>=0&&b<e.board.length&&L>=0&&L<((u=e.board[b])==null?void 0:u.length)){const G=e.board[b][L].card;G&&(_=G.ownerId||t)}}else if(e.activePlayerId){const b=e.players.find(L=>L.id===e.activePlayerId);b!=null&&b.isDummy&&(_=b.id)}let p=S==null?void 0:S.closest("[data-hand-card]");if(!p&&S)if(S.getAttribute("data-hand-card"))p=S;else{const b=S.querySelectorAll("[data-hand-card]");if(b.length>0){let L=1/0,G=null;const N=f.clientX,M=f.clientY;for(const $ of Array.from(b)){const F=$.getBoundingClientRect();if(N>=F.left&&N<=F.right&&M>=F.top&&M<=F.bottom){const q=F.left+F.width/2,Z=F.top+F.height/2,X=Math.hypot(N-q,M-Z);X<L&&(L=X,G=$)}}p=G}}if(p){const b=p.getAttribute("data-hand-card");if(b){const[L,G]=b.split(","),N=parseInt(L,10),M=parseInt(G,10),$=e.players.find(q=>q.id===N),F=$==null?void 0:$.hand[M];if($&&F){if(d.type==="Revealed"&&!$.isDummy){if((w=F.statuses)==null?void 0:w.some(Ee=>Ee.type==="Revealed"&&Ee.addedByPlayerId===_))return;d.count===1&&(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),A()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((R=d.sourceCard)==null?void 0:R.ownerId)??_??void 0,statusType:d.type,count:1},{target:"hand",playerId:N,cardIndex:M,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&a(d.sourceCoords,d.isDeployAbility),d.count>1?l(Ee=>Ee?{...Ee,count:Ee.count-1}:null):l(null),i.current=!0,setTimeout(()=>{i.current=!1},300);return}const Z={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,tokenType:d.type};if(!st({card:F,ownerId:N,location:"hand"},Z,_,e.players))return;d.count===1&&(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),A()),r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((v=d.sourceCard)==null?void 0:v.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:N,cardIndex:M,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&a(d.sourceCoords,d.isDeployAbility),d.count>1?l(de=>de?{...de,count:de.count-1}:null):l(null),i.current=!0,setTimeout(()=>{i.current=!1},300);return}}}if(!p){const b=S==null?void 0:S.closest("[data-board-coords]");if(b){const L=b.getAttribute("data-board-coords");if(L){const[G,N]=L.split(","),M=parseInt(G,10),$=parseInt(N,10);if(!isNaN(M)&&!isNaN($)&&M>=0&&M<e.board.length&&e.board[M]&&$>=0&&$<e.board[M].length&&e.board[M][$]){const F=e.board[M][$].card;if((F==null?void 0:F.ownerId)!==void 0){const q={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,mustBeAdjacentToSource:d.mustBeAdjacentToSource,mustBeInLineWithSource:d.mustBeInLineWithSource,sourceCoords:d.sourceCoords,tokenType:d.type};if(!st({card:F,ownerId:F.ownerId,location:"board",boardCoords:{row:M,col:$}},q,_,e.players))return;e.players.find(X=>X.id===F.ownerId)}if(F){const q=d.placeAllAtOnce?d.count:1;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((D=d.sourceCard)==null?void 0:D.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:q},{target:"board",boardCoords:{row:M,col:$}}),g("board",{row:M,col:$}),d.recordContext&&o(X=>({...X,lastMovedCardCoords:{row:M,col:$},lastMovedCardId:F.id})),d.sourceCoords&&d.sourceCoords.row>=0&&a(d.sourceCoords,d.isDeployAbility);const Z=d.count-q;if(Z>0)l(X=>X?{...X,count:Z}:null);else{if(d.chainedAction){const X={...d.chainedAction};d.recordContext&&(X.mode==="SELECT_CELL"&&(X.sourceCard=F,X.sourceCoords={row:M,col:$},X.recordContext=!0),X.type==="GLOBAL_AUTO_APPLY"&&(X.sourceCoords={row:M,col:$}),X.type==="CREATE_STACK"&&(X.sourceCoords={row:M,col:$},X.originalOwnerId||(X.sourceCard=F)),X.mode==="ZIUS_LINE_SELECT"&&(X.sourceCoords={row:M,col:$})),X.type==="CREATE_STACK"&&E(null),s(X,{row:M,col:$})}A(),l(null)}i.current=!0,setTimeout(()=>{i.current=!1},300)}}}}else{const L=S==null?void 0:S.closest(".counter-modal-content"),G=(S==null?void 0:S.closest("[data-board-coords]"))!==null,N=(S==null?void 0:S.closest("[data-hand-card]"))!==null;d.isDragging?L?l(M=>M?{...M,isDragging:!1}:null):!G&&!N&&(A(),l(null)):!L&&!G&&!N&&(A(),l(null))}}};return window.addEventListener("mouseup",h),()=>{window.removeEventListener("mouseup",h)}},[d,r,e,t,n,a,i,o,s,l,E,g]),H.useEffect(()=>{const h=f=>{d&&(f.preventDefault(),A(),l(null))};return window.addEventListener("contextmenu",h),()=>{window.removeEventListener("contextmenu",h)}},[d,l,A]),{cursorFollowerRef:y,handleCounterMouseDown:(h,f)=>{P.current={x:f.clientX,y:f.clientY};const S=e.players.find(p=>p.id===e.activePlayerId),_=S!=null&&S.isDummy&&e.activePlayerId!==null?e.activePlayerId:t??0;l(p=>dr(h,_,p))}}};export{rt as A,Mt as B,vi as C,mi as D,Ci as E,Ei as F,hi as G,Oi as H,Mi as I,Ni as J,Li as K,ui as L,So as M,Nt as N,Vt as O,Co as P,st as Q,At as R,gi as S,re as T,ir as U,fi as V,Ao as W,it as a,Ii as b,Da as c,Mo as d,_i as e,Ce as f,bi as g,Oa as h,Ye as i,pi as j,_o as k,Si as l,m,er as n,Oe as o,Ti as p,bo as q,Ai as r,Do as s,wo as t,yi as u,wi as v,Pi as w,ki as x,Ri as y,Di as z};
