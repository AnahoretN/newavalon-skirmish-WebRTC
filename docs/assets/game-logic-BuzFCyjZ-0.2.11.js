import{r as $,j as Io}from"./vendor-react-JYPVbgc1-0.2.11.js";import{$ as kt}from"./vendor-webrtc-BBsnVRmn-0.2.11.js";import{d as Ra,e as Eo}from"./vendor-BPR6uEV2-0.2.11.js";var De=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(De||{}),rr=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(rr||{});const f={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},To={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365235/SYN_IP_DEPT_AGENT_pbvh9e.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_TACTICAL_AGENT_vquxfm.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_PATROL_AGENT_nlyneg.webp",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_RIOT_AGENT_i4lk5m.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_THREAT_ANALYST_uqxbsp.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367440/HERO_Mr._Pearl_Director_of_BioSynch_lsesol.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_RECKLESS_PROVOCATEUR_wvfdcr.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_DATA_LIBERATOR_qeru3j.webp",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_CAUTIOUS_AVENGER_xzk6pd.webp",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_VIGILANT_SPOTTER_xo8ig7.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_INVENTIVE_MAKER_sicb73.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367436/HERO_Finn_c8637x.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_FABER_cr804w.webp",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365250/OPT_CENSOR_w4qijk.webp",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_PRINCEPS_aaqakx.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_IMMUNIS_hvlxhi.webp",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_CENTURION_grztbi.webp",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367435/HERO_Lucius_The_Immortal_irhhaj.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_CODE_KEEPER_yhowqj.webp",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_DEVOUT_SYNTHETIC_nkr1tx.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_UNWAVERING_INTEGRATOR_g1cbag.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_SIGNAL_PROPHET_rmk9me.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_ZEALOUS_MISSIONARY_v7qjhw.webp",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367438/HERO_Reverend_of_The_Choir_njrrih.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365196/CMD_OVERWATCH_djwlqo.webp",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_REPOSITIONING_uhwvrk.webp",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_INSPIRATION_v0bi3l.webp",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_DATA_INTERCEPTION_gen1qw.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_FALSE_ORDERS_aatcmc.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367418/CMD_Experimental_Stimulants_plsnet.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367415/CMD_Logistics_Chain_odmwxq.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367414/CMD_Quick_Response_Team_xff2yt.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367411/CMD_Temporary_Shelter_podjbj.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367413/CMD_Enhanced_Interrogation_legiod.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367446/N_Autonomous_Battle_Robot_Gawain_oni745.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Reclaimed_Gawain_sjmlsp.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Secret_informant_w0w6g5.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367432/HERO_Michael_Falk_sv5i5c.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367434/HERO_Edith_Byron_ny23vb.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367429/HERO_Pinkunoneko_cqhpuy.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367431/HERO_Maria_Eleftheria_Damanaki_cpw12i.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367428/HERO_Zius_xhuyxa.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},wo={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_RECON_DRONE_w3elir.webp",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_WALKING_TURRET_c0mttm.webp",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},go={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365400/Aim_qzeaqn.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365398/Exploit_pf2zwf.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Revealed_lsan64.webp",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand and face-down cards on board.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board-facedown","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365403/Stun_pbe7ex.webp",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Shield_yilhdt.webp",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365402/Support_hxzufw.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771368527/Threat_dqnnsq.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365394/Resurrected_awaucv.webp",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},_o=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],Ht={cardDatabase:To,tokenDatabase:wo,countersDatabase:go,deckFiles:_o};let Ea=null,it=new Map,Zt=new Map,_t={},Nt=[],Qt={};const ka=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function yi(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const a=await fetch("/api/content/database");if(a.ok){const r=await a.json(),n=r.cards.map(([o,s])=>[o,s]),i=r.tokens.map(([o,s])=>[o,s]);e={cardDatabase:Object.fromEntries(n),tokenDatabase:Object.fromEntries(i),countersDatabase:Object.fromEntries(r.counters),deckFiles:r.deckFiles}}else e=Ht}catch{e=Ht}else e=Ht;Ea=e,it=new Map(Object.entries(e.cardDatabase)),Zt=new Map(Object.entries(e.tokenDatabase)),_t=e.countersDatabase,Nt=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(_t)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(a){console.warn("Could not save counters database to localStorage:",a)}ze=Ea,Pa=it,Ao=Zt,ct=_t,So=Nt,Qt=bo(),Co=Qt}catch(e){throw console.error("Failed to load content database:",e),e}}function bo(){const e={};for(const t of Nt){const a=[];for(const r of t.cards){const n=it.get(r.cardId);if(!n){console.warn(`Card definition not found for ID: ${r.cardId} in deck: ${t.name}`);continue}const i=ka.has(r.cardId);for(let o=0;o<r.quantity;o++){const d=r.cardId.replace(/-/g,"--DASH--").toUpperCase();i?a.push({...n,deck:De.Command,id:`CMD_${d}_${o+1}`,baseId:r.cardId,faction:n.faction||"Command"}):a.push({...n,deck:t.id,id:`${t.id.substring(0,3).toUpperCase()}_${d}_${o+1}`,baseId:r.cardId,faction:n.faction||t.id})}}if(e[t.id]=a,t.id==="Optimates"){const r=new Set;let n=!1;a.forEach(i=>{r.has(i.id)&&(f.error(`[buildDecksData] DUPLICATE ID in Optimates: ${i.id}`),n=!0),r.add(i.id),i.baseId||i.id}),n&&f.warn("[buildDecksData] Optimates deck has duplicate IDs!")}}return e[De.Tokens]=Array.from(Zt.entries()).map(([t,a])=>{const r=a.types?[...a.types]:[];return{id:`TKN_${a.name.toUpperCase().replace(/\s/g,"_")}`,baseId:t,deck:De.Tokens,name:a.name,imageUrl:a.imageUrl,fallbackImage:a.fallbackImage,power:a.power,ability:a.ability,color:a.color,types:r,flavorText:a.flavorText,faction:"Tokens"}}),e}let ze=null,Pa=new Map,Ao=new Map,ct={};try{const e=localStorage.getItem("counters_database");e&&(_t=JSON.parse(e),ct=_t)}catch{}let So=[],Co={};const Do=ka,hi=()=>Nt.filter(e=>e.isSelectable);function Be(e){return it.get(e)}function Ft(e){return Array.from(it.values()).find(t=>t.name===e)}function mi(){return Array.from(it.entries()).map(([e,t])=>({id:e,card:t}))}function Ii(){return it}function Oa(){return Qt}const Ro=4,Ei={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/medal_tavarc.webp"},Ti={[De.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[De.Hoods]:{prefix:"HOO",color:"border-purple-500"},[De.Optimates]:{prefix:"OPT",color:"border-red-500"},[De.Fusion]:{prefix:"FUS",color:"border-green-400"},[De.Command]:{prefix:"CMD",color:"border-yellow-500"},[De.Tokens]:{prefix:"TKN",color:"border-gray-400"},[De.Custom]:{prefix:"CUS",color:"border-purple-400"},[De.Neutral]:{prefix:"NEU",color:"border-gray-400"},[De.Random]:{prefix:"RND",color:"border-gray-400"}},wi={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},ko={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},gi={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},Et=["blue","purple","red","green","yellow","orange","pink","brown"],_i=["Setup","Main","Commit","Scoring"],Pt=()=>Object.fromEntries(Object.entries(ct).map(([e,t])=>[e,t.imageUrl])),bi=new Proxy({},{get(e,t){return Pt()[t]},ownKeys(){return Object.keys(Pt())},has(e,t){return t in Pt()},getOwnPropertyDescriptor(e,t){const a=Pt()[t];return a!==void 0?{enumerable:!0,configurable:!0,value:a}:void 0}}),Ot=()=>Object.fromEntries(Object.entries(ct).map(([e,t])=>[e,t.description])),Ai=new Proxy({},{get(e,t){return Ot()[t]},ownKeys(){return Object.keys(Ot())},has(e,t){return t in Ot()},getOwnPropertyDescriptor(e,t){const a=Ot()[t];return a!==void 0?{enumerable:!0,configurable:!0,value:a}:void 0}}),Po=()=>Object.entries(ct).filter(([e,t])=>e!=="Resurrected"&&(!t.allowedPanels||t.allowedPanels.includes("COUNTER_PANEL"))).sort(([,e],[,t])=>e.sortOrder-t.sortOrder).map(([e,t])=>({type:e,label:t.name}));Po();const Je="readyDeploy",He="readySetup",We="readyCommit",Re=(e,t,a)=>e.statuses?e.statuses.some(r=>r.type===t&&(a===void 0||r.addedByPlayerId===a)):!1,xe=(e,t)=>e.statuses?e.statuses.some(a=>a.type===t):!1,Oo=(e,t,a)=>a===1&&xe(e,He),vo=(e,t,a,r,n)=>!!(a&&xe(e,Je)||t===1&&r&&xe(e,He)||t===3&&n&&xe(e,We)),Wt=e=>{e.statuses&&(e.statuses=e.statuses.filter(t=>t.type!==Je&&t.type!==He&&t.type!==We))},yt=(e,t,a,r)=>Math.abs(e-a)+Math.abs(t-r)===1,va=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,t,a,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:a})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,t,a,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>{var i;return n.ownerId!==a&&((i=n.statuses)==null?void 0:i.some(o=>o.type==="Threat"))}},sourceCard:e,sourceCoords:r})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.ownerId!==a&&Re(n,"Exploit",a)}})},{baseId:"centurion",activationType:"commit",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(n,i,o)=>{var s;return n.ownerId===a&&((s=n.types)==null?void 0:s.includes("Unit"))&&i!==void 0&&o!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:r,payload:{filter:(n,i,o)=>yt(i,o,r.row,r.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.id===e.id?!1:n.ownerId===a}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:r,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,originalOwnerId:a,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:n=>n.ownerId===a}})},{baseId:"censor",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:r,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,t,a,r)=>Re(e,"Support",a)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:r,payload:{filter:(n,i)=>yt(n,i,r.row,r.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(n,i,o)=>yt(i,o,r.row,r.col)&&n.ownerId!==a&&(Re(n,"Threat",a)||Re(n,"Stun",a))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,t,a,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>n.ownerId===a&&Re(n,"Support",a)},sourceCard:e,sourceCoords:r})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.ownerId===a&&Re(n,"Exploit",a)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:r,payload:{filter:n=>Re(n,"Exploit",a)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"MODIFY_POWER",amount:-1,filter:n=>Re(n,"Aim",a)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:r,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"REVEAL_ENEMY_CHAINED",filter:(n,i,o)=>{const s=yt(i,o,r.row,r.col),d=n.ownerId!==a;return s&&d},targetOwnerId:void 0},skipChainedActionOnNoTargets:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:1}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(n,i,o)=>yt(i,o,r.row,r.col)&&n.ownerId!==a&&(Re(n,"Threat",a)||Re(n,"Stun",a))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,t,a,r)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:a})},{baseId:"edithByron",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:r,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:r,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:(n,i,o)=>yt(i,o,r.row,r.col)&&(Re(n,"Threat",a)||Re(n,"Stun",a)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"DESTROY",filter:n=>Re(n,"Aim",a)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,t,a,r)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:r,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:r,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,t,a,r)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:r,ownerId:a})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:r,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:r,payload:{actionType:"LUCIUS_SETUP",filter:n=>n.ownerId===a}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,t,a,r)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:r,payload:{filter:n=>n.ownerId===a,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,t,a,r)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:r})}],ar=e=>{const t=e.baseId||"";return va.filter(a=>{var r;return a.baseId===t||((r=a.baseIdAlt)==null?void 0:r.includes(t))})},No=e=>{const a=ar(e).map(r=>r.activationType);return[...new Set(a)]},Na=(e,t,a,r)=>{var o;if(a!==e.ownerId)return!1;if(r&&e.ownerId!==void 0){const s=r.players.find(d=>d.id===e.ownerId);if(s!=null&&s.isDummy&&r.activePlayerId!==e.ownerId)return!1}if((o=e.statuses)!=null&&o.some(s=>s.type==="Stun"))return!1;const n=ar(e),i=t===1&&n.some(s=>s.activationType==="setup")||t===3&&n.some(s=>s.activationType==="commit");if(t===1){const s=n.find(d=>d.activationType==="setup");if(s&&xe(e,He))return!(s.supportRequired&&!Re(e,"Support",a))}if(t===3){const s=n.find(d=>d.activationType==="commit");if(s&&xe(e,We))return!(s.supportRequired&&!Re(e,"Support",a))}if(!i){const s=n.find(d=>d.activationType==="deploy");if(s&&xe(e,Je))return!(s.supportRequired&&!Re(e,"Support",a))}return!1},Mo=(e,t,a,r)=>{if(a!==e.ownerId)if(e.ownerId!==void 0){const d=t.players.find(c=>c.id===e.ownerId);if(!(d!=null&&d.isDummy))return null}else return null;const n=ar(e),i=e.ownerId??a??0,o=t.currentPhase,s=o===1&&n.some(d=>d.activationType==="setup")||o===3&&n.some(d=>d.activationType==="commit");if(o===1){const d=n.find(c=>c.activationType==="setup");if(d&&xe(e,He)){if(d.supportRequired&&!Re(e,"Support",i))return null;const c=d.getAction(e,t,i,r);if(c)return{...c,readyStatusToRemove:He}}}if(o===3){const d=n.find(c=>c.activationType==="commit");if(d&&xe(e,We)){if(d.supportRequired&&!Re(e,"Support",i))return null;const c=d.getAction(e,t,i,r);if(c)return{...c,readyStatusToRemove:We}}}if(!s){const d=n.find(c=>c.activationType==="deploy");if(d&&xe(e,Je)){if(d.supportRequired&&!Re(e,"Support",i))return null;const c=d.getAction(e,t,i,r);if(c)return{...c,isDeployAbility:!0,readyStatusToRemove:Je}}}return null},Lo=(e,t)=>t===1&&xe(e,He)?He:t===3&&xe(e,We)?We:xe(e,Je)?Je:null,Si=(e,t)=>{var o;let a,r;typeof t=="object"?(a=t.currentPhase,r=t):a=t;const n=r==null?void 0:r.activePlayerId;return n===void 0||e.ownerId!==n||(o=e.statuses)!=null&&o.some(s=>s.type==="Stun")||!Lo(e,a)?!1:Na(e,a,e.ownerId,r)},Ma=(e,t,a)=>{var s;let r;if(typeof t=="object"?(r=t.currentPhase,a=t.activePlayerId??void 0):r=t,a===void 0||e.ownerId!==a||(s=e.statuses)!=null&&s.some(d=>d.type==="Stun"))return!1;const n=xe(e,Je),i=xe(e,He),o=xe(e,We);return vo(e,r,n,i,o)},nr=(e,t)=>{e.statuses||(e.statuses=[]);const a=No(e);for(const r of a){let n="";r==="deploy"?n=Je:r==="setup"?n=He:r==="commit"&&(n=We),n&&(e.statuses.some(o=>o.type===n)||e.statuses.push({type:n,addedByPlayerId:t}))}},er=(e,t)=>{const a=Ta("setup"),r=Ta("commit");for(let n=0;n<e.board.length;n++)for(let i=0;i<e.board[n].length;i++){const s=e.board[n][i].card;if(!s||s.ownerId!==t)continue;const d=s.baseId||s.id;if(d){if(f.debug(`[resetReadyStatusesForTurn] Processing card: ${s.name} (baseId: ${d}, ownerId: ${s.ownerId})`),s.statuses||(s.statuses=[]),a.includes(d)){const c=s.statuses.some(E=>E.type===He);s.statuses=s.statuses.filter(E=>E.type!==He),s.statuses.push({type:He,addedByPlayerId:t}),c||f.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_SETUP to ${s.name}`)}else s.statuses=s.statuses.filter(c=>c.type!==He);if(r.includes(d)){const c=s.statuses.some(E=>E.type===We);s.statuses=s.statuses.filter(E=>E.type!==We),s.statuses.push({type:We,addedByPlayerId:t}),c||f.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_COMMIT to ${s.name}`)}else s.statuses=s.statuses.filter(c=>c.type!==We)}}};function Ta(e){const t=[];return va.forEach(a=>{a.activationType===e&&(t.push(a.baseId),a.baseIdAlt&&t.push(...a.baseIdAlt))}),[...new Set(t)]}class Go{constructor(){this.queue=[],this.loading=new Set,this.loaded=new Set,this.minDelayBetweenLoads=1e3,this.lastLoadTime=0,this.isProcessing=!1}preload(t,a="low"){!t||this.loaded.has(t)||this.loading.has(t)||this.queue.some(n=>n.url===t)||(this.queue.push({url:t,priority:a,timestamp:Date.now()}),this.queue.sort((n,i)=>{const o={high:0,normal:1,low:2},s=o[n.priority]-o[i.priority];return s!==0?s:n.timestamp-i.timestamp}),this.processQueue())}preloadMany(t,a="low"){t.forEach(r=>this.preload(r,a))}isLoaded(t){return this.loaded.has(t)}clearQueue(){this.queue=[]}clear(){this.queue=[],this.loading.clear(),this.loaded.clear()}processQueue(){if(this.isProcessing||this.queue.length===0)return;this.isProcessing=!0;const t=()=>{if(this.queue.length===0){this.isProcessing=!1;return}const r=Date.now()-this.lastLoadTime,n=Math.max(0,this.minDelayBetweenLoads-r);setTimeout(()=>{const i=this.queue.shift();if(!i){this.isProcessing=!1;return}this.loadImage(i.url).then(()=>{this.lastLoadTime=Date.now(),t()}).catch(()=>{this.lastLoadTime=Date.now(),t()})},n)};t()}loadImage(t){return new Promise((a,r)=>{this.loading.add(t);const n=new Image;n.onload=()=>{this.loading.delete(t),this.loaded.add(t),a()},n.onerror=()=>{this.loading.delete(t),r(new Error(`Failed to load: ${t}`))},n.src=t})}}const xo=new Go;function Uo(e,t){const a=[];for(const r of e)if(r.id!==t){if(r.hand)for(const n of r.hand)n.imageUrl&&!a.includes(n.imageUrl)&&a.push(n.imageUrl);if(r.deck)for(const n of r.deck)n.imageUrl&&!a.includes(n.imageUrl)&&a.push(n.imageUrl);if(r.discard)for(const n of r.discard)n.imageUrl&&!a.includes(n.imageUrl)&&a.push(n.imageUrl)}return a}function he(e){const t=e,a=t==null?void 0:t.targetingMode;a&&delete t.targetingMode;let r;return typeof structuredClone<"u"?r=structuredClone(e):r=JSON.parse(JSON.stringify(e)),a&&(r.targetingMode=a,t.targetingMode=a),r}const ne={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function Ci(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function Di(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}function Ri(e,t){return e?ko[e]:t}function ve(){return localStorage.getItem("webrtc_enabled")==="true"}const La=$.createContext(null),ki=({children:e})=>{const[t,a]=$.useState(null),[r,n]=$.useState({}),[i,o]=$.useState("lg"),s=$.useCallback((h,k={},T="lg")=>{a(h),n(k),o(T)},[]),d=$.useCallback(()=>{a(null),n({}),o("lg")},[]),c=$.useCallback(h=>t===h,[t]),E=$.useCallback(()=>r,[r]),w=$.useCallback(()=>i,[i]),A={openModal:t,modalData:r,modalSize:i,open:s,close:d,isOpen:c,getData:E,getSize:w};return Io.jsx(La.Provider,{value:A,children:e})},Gt=()=>{const e=$.useContext(La);if(!e)throw new Error("useModals must be used within ModalsProvider");return e},Pi=()=>{const{open:e,close:t,isOpen:a}=Gt();return{isOpen:a("rules"),open:r=>e("rules",r,"full"),close:t}},Oi=()=>{const{open:e,close:t,isOpen:a}=Gt();return{isOpen:a("settings"),open:r=>e("settings",r,"md"),close:t}},vi=()=>{const{open:e,close:t,isOpen:a,getData:r}=Gt();return{isOpen:a("joinGame"),open:n=>e("joinGame",n,"lg"),close:t,getData:()=>r()}},Ni=()=>{const{open:e,close:t,isOpen:a}=Gt();return{isOpen:a("deckBuilder"),open:r=>e("deckBuilder",r,"full"),close:t}},bt="webrtc_game_state",At="webrtc_host_data",St="webrtc_guest_data",$o="webrtc_current_host_peerId",Ho=30*60*1e3;function or(){return Date.now()}function Dt(e){return Date.now()-e<Ho}function Fo(e){try{const t={...e,timestamp:or()};localStorage.setItem(At,JSON.stringify(t)),f.info("[WebRTC Persistence] Saved host data:",{peerId:t.peerId})}catch(t){f.error("[WebRTC Persistence] Failed to save host data:",t)}}function Bt(e){try{const t={...e,timestamp:or()};localStorage.setItem(St,JSON.stringify(t)),f.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId})}catch(t){f.error("[WebRTC Persistence] Failed to save guest data:",t)}}function Tt(e){try{const t={...e,timestamp:or()};localStorage.setItem(bt,JSON.stringify(t)),f.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(t.timestamp).toISOString())}catch(t){f.error("[WebRTC Persistence] Failed to save game state:",t)}}function Ga(){try{const e=localStorage.getItem(At);if(!e)return null;const t=JSON.parse(e);return Dt(t.timestamp)?(f.info("[WebRTC Persistence] Loaded valid host data:",{peerId:t.peerId}),t):(f.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(At),null)}catch(e){return f.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(At),null}}function xa(){try{const e=localStorage.getItem(St);if(!e)return null;const t=JSON.parse(e);return Dt(t.timestamp)?(f.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId}),t):(f.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(St),null)}catch(e){return f.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(St),null}}function wa(){try{const e=localStorage.getItem(bt);if(!e)return null;const t=JSON.parse(e);return Dt(t.timestamp)?(f.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(t.timestamp).toISOString()),t):(f.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(bt),null)}catch(e){return f.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(bt),null}}function nt(){localStorage.removeItem(bt),localStorage.removeItem(At),localStorage.removeItem(St),localStorage.removeItem($o)}function tr(e,t){try{const a=`webrtc_host_${t}`,r={peerId:e,gameId:t,timestamp:Date.now()};localStorage.setItem(a,JSON.stringify(r)),f.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${t}:`,e)}catch(a){f.error("[WebRTC Persistence] Failed to broadcast host peerId:",a)}}function Yt(e){try{const t=`webrtc_host_${e}`,a=localStorage.getItem(t);if(!a)return null;const r=JSON.parse(a);return Date.now()-r.timestamp>15e3?null:{peerId:r.peerId,timestamp:r.timestamp}}catch(t){return f.error("[WebRTC Persistence] Failed to get host peerId:",t),null}}function ga(e){try{const t=`webrtc_host_${e}`;localStorage.removeItem(t),f.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(t){f.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",t)}}function Wo(){const e=sessionStorage.getItem("invite_host_id"),t=sessionStorage.getItem("invite_auto_join");if(e&&t)return"none";const a=Ga();if(a&&Dt(a.timestamp))return"host";const r=xa();return r&&Dt(r.timestamp)?"guest":"none"}const _a=7,zt="mrPearlDoF",Bo="reverendOfTheChoir",Yo="threatAnalyst";function zo(e,t){return e!=null&&e.statuses?e.statuses.some(a=>a.type==="Exploit"&&a.addedByPlayerId!==void 0&&t.has(a.addedByPlayerId)):!1}function Ko(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const Ua=()=>Array(_a).fill(null).map(()=>Array(_a).fill(null).map(()=>({card:null}))),Le=e=>{var T,m,p,S,_;const{board:t,activeGridSize:a,players:r}=e,n=Ko(t),i=n.length,o=Math.floor((i-a)/2),s=new Map;r.forEach(y=>s.set(y.id,y.teamId));for(let y=0;y<i;y++)for(let l=0;l<i;l++){const u=n[y][l].card;u&&(u.statuses&&(u.statuses=u.statuses.filter(g=>g.type!=="Support"&&g.type!=="Threat")),delete u.bonusPower)}for(let y=0;y<i;y++)for(let l=0;l<i;l++){const u=n[y][l].card;if((u==null?void 0:u.ownerId)===void 0||u.isFaceDown)continue;const g=u.ownerId,D=s.get(g),v=[{r:y-1,c:l},{r:y+1,c:l},{r:y,c:l-1},{r:y,c:l+1}],R={};let b=!1;for(const x of v){const{r:N,c:M}=x;if(N>=0&&N<i&&M>=0&&M<i){const H=n[N][M].card,F=(T=H==null?void 0:H.statuses)==null?void 0:T.some(q=>q.type==="Stun");if((H==null?void 0:H.ownerId)!==void 0&&!H.isFaceDown&&!F){const q=H.ownerId,Q=s.get(q);g===q||D!==void 0&&D===Q?b=!0:(R[q]||(R[q]=[]),R[q].push({r:N,c:M}))}}}b&&(u.statuses||(u.statuses=[]),u.statuses.some(x=>x.type==="Support")||u.statuses.push({type:"Support",addedByPlayerId:g}));let G=null;for(const x in R){const N=R[x];if(N&&N.length>=2){G=parseInt(x,10);break}}if(G===null&&y>=o&&y<o+a&&l>=o&&l<o+a){const N=y===o||y===o+a-1||l===o||l===o+a-1,M=Object.keys(R).length>0;if(N&&M){const H=Object.keys(R)[0];H&&(G=parseInt(H,10))}}G!==null&&(u.statuses||(u.statuses=[]),u.statuses.some(x=>x.type==="Threat")||u.statuses.push({type:"Threat",addedByPlayerId:G}))}const d=new Set;for(let y=0;y<i;y++)for(let l=0;l<i;l++){const u=n[y][l].card,g=(m=u==null?void 0:u.statuses)==null?void 0:m.some(D=>D.type==="Stun");if((u==null?void 0:u.baseId)===Yo&&!u.isFaceDown&&u.ownerId!==void 0&&!g){const D=[{r:y-1,c:l},{r:y+1,c:l},{r:y,c:l-1},{r:y,c:l+1}];let v=!1;const R=u.ownerId,b=s.get(R);for(const G of D){const{r:x,c:N}=G;if(x>=0&&x<i&&N>=0&&N<i){const M=n[x][N].card;if((M==null?void 0:M.ownerId)!==void 0&&!M.isFaceDown){const H=M.ownerId,F=s.get(H),q=R===H||b!==void 0&&b===F,Q=(p=M==null?void 0:M.statuses)==null?void 0:p.some(X=>X.type==="Stun");if(q&&!Q){v=!0;break}}}}v&&d.add(R)}}for(let y=0;y<i;y++)for(let l=0;l<i;l++){const u=n[y][l].card;if(!u||u.isFaceDown||u.ownerId===void 0)continue;const g=u.ownerId,D=s.get(g),v=[{r:y-1,c:l},{r:y+1,c:l},{r:y,c:l-1},{r:y,c:l+1}],R={};for(const G of v){const{r:x,c:N}=G;if(x>=0&&x<i&&N>=0&&N<i){const M=n[x][N].card,H=(S=M==null?void 0:M.statuses)==null?void 0:S.some(F=>F.type==="Stun");if((M==null?void 0:M.ownerId)!==void 0&&!M.isFaceDown&&!H){const F=M.ownerId,q=s.get(F);if(!(g===F||D!==void 0&&D===q)){const X=d.has(F),de=zo(u,d);X&&de&&(R[F]||(R[F]=0),R[F]++)}}}}if(Object.keys(R).length>0){u.statuses||(u.statuses=[]);const G=Object.keys(R).map(x=>parseInt(x,10));for(const x of G)u.statuses.some(N=>N.type==="Threat"&&N.addedByPlayerId===x)||u.statuses.push({type:"Threat",addedByPlayerId:x})}}const c=[],E=[];for(let y=0;y<i;y++)for(let l=0;l<i;l++){const u=n[y][l].card,g=(_=u==null?void 0:u.statuses)==null?void 0:_.some(D=>D.type==="Stun");u!=null&&u.baseId&&!u.isFaceDown&&u.ownerId!==void 0&&!g&&(u.baseId===Bo?c.push({r:y,c:l,ownerId:u.ownerId,baseId:u.baseId}):u.baseId===zt&&E.push({r:y,c:l,ownerId:u.ownerId,baseId:u.baseId}))}const w=new Set,A=new Set;for(const y of c){const{r:l,c:u,ownerId:g}=y,D=`${l}-${g}`;if(!w.has(D)){w.add(D);for(let R=0;R<i;R++){const b=n[l][R].card;b&&b.ownerId===g&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(G=>G.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:g}))}}const v=`${u}-${g}`;if(!A.has(v)){A.add(v);for(let R=0;R<i;R++){const b=n[R][u].card;b&&b.ownerId===g&&!b.isFaceDown&&(b.statuses||(b.statuses=[]),b.statuses.some(G=>G.type==="Support")||b.statuses.push({type:"Support",addedByPlayerId:g}))}}}const h=new Set,k=new Set;for(const y of E){const{r:l,c:u,ownerId:g}=y,D=`${l}-${g}`;if(!h.has(D)){h.add(D);for(let R=0;R<i;R++){const b=n[l][R].card;b&&b.ownerId===g&&!b.isFaceDown&&b.baseId!==zt&&(b.bonusPower=(b.bonusPower||0)+1)}}const v=`${u}-${g}`;if(!k.has(v)){k.add(v);for(let R=0;R<i;R++){const b=n[R][u].card;b&&b.ownerId===g&&!b.isFaceDown&&b.baseId!==zt&&(b.bonusPower=(b.bonusPower||0)+1)}}}return n};var lt=(e=>(e[e.CARD_REGISTRY=1]="CARD_REGISTRY",e[e.CARD_STATE=2]="CARD_STATE",e[e.ABILITY_EFFECT=3]="ABILITY_EFFECT",e[e.SESSION_EVENT=4]="SESSION_EVENT",e))(lt||{});function qo(){const e={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},t=new Set,a=Array.from(Pa.values());for(const r of a)if(r.baseId&&!t.has(r.baseId)){t.add(r.baseId);const n=e.cardDefinitions.length;e.baseIdToIndex.set(r.baseId,n),e.indexToBaseId.set(n,r.baseId),e.cardDefinitions.push({baseId:r.baseId,name:r.name,imageUrl:r.imageUrl,power:r.power,ability:r.ability||"",types:r.types||[],faction:r.faction||""})}return e.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],f.info(`[CardRegistry] Built registry with ${e.cardDefinitions.length} cards, ${e.statusTypes.length} status types`),e}function $a(e,t){let a=0;for(const r of e||[]){const n=t.statusTypes.indexOf(r.type);n>=0&&n<32&&(a|=1<<n)}return a>>>0}function Ha(e,t,a){const r=[];for(let n=0;n<32;n++)if(e&1<<n){const i=a.statusTypes[n];i&&r.push({type:i,addedByPlayerId:t})}return r}function Fa(e){let t=0;return e.isFaceDown&&(t|=1),e.enteredThisTurn&&(t|=2),e.revealedTo==="all"&&(t|=4),t}function Kt(e,t){const a=new Uint8Array(13);let r=0;const n=sr(e.id);a[r++]=n>>24&255,a[r++]=n>>16&255,a[r++]=n>>8&255,a[r++]=n&255;const i=e.baseId?t.baseIdToIndex.get(e.baseId)??0:0;a[r++]=i>>8&255,a[r++]=i&255,a[r++]=(e.ownerId??0)&255;const o=Math.round(e.power||0);a[r++]=Math.clamp(o,-128,127)&255,a[r++]=Fa(e);const s=$a(e.statuses||[],t);return a[r++]=s>>24&255,a[r++]=s>>16&255,a[r++]=s>>8&255,a[r++]=s&255,a}function jo(e,t,a){const r=new Uint8Array(10);let n=0;const i=sr(e.id);r[n++]=i>>24&255,r[n++]=i>>16&255,r[n++]=i>>8&255,r[n++]=i&255,r[n++]=(e.ownerId??a)&255,r[n++]=Fa(e);const o=$a(e.statuses||[],t);return r[n++]=o>>24&255,r[n++]=o>>16&255,r[n++]=o>>8&255,r[n++]=o&255,r}function sr(e){let t=0;for(let a=0;a<e.length;a++){const r=e.charCodeAt(a);t=(t<<5)-t+r,t=t&t}return t>>>0}function Vo(e,t,a){var T;const r=[],n=Date.now(),i=new Uint8Array(7);i[0]=lt.CARD_STATE,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,r.push(i);const o=[],s=Math.min(e.players.length,255);o.push(new Uint8Array([s]));for(const m of e.players){o.push(new Uint8Array([m.id&255]));const p=Et.indexOf(m.color);o.push(new Uint8Array([p>=0?p:0]));const S=Math.min(m.deck.length,255),_=Math.min(m.hand.length,255),y=Math.min(m.discard.length,255);o.push(new Uint8Array([S,_,y,m.announcedCard?1:0])),o.push(new Uint8Array([Math.min(m.score,255)]));const l=Math.min(m.hand.length,255);o.push(new Uint8Array([l]));const u=m.id===a;for(const D of m.hand)u?o.push(Kt(D,t)):o.push(jo(D,t,m.id));const g=Math.min(m.discard.length,255);o.push(new Uint8Array([g]));for(const D of m.discard){const v=sr(D.id),R=new Uint8Array(4);R[0]=v>>24&255,R[1]=v>>16&255,R[2]=v>>8&255,R[3]=v&255,o.push(R)}m.announcedCard&&o.push(Kt(m.announcedCard,t))}const d=e.board.length;o.push(new Uint8Array([d,d,d]));const c=[];for(let m=0;m<e.board.length;m++)for(let p=0;p<((T=e.board[m])==null?void 0:T.length);p++){const S=e.board[m][p];S!=null&&S.card&&c.push({row:m,col:p,card:S.card})}const E=c.length,w=new Uint8Array(2);w[0]=E>>8&255,w[1]=E&255,o.push(w);for(const{row:m,col:p,card:S}of c)o.push(new Uint8Array([m,p])),o.push(Kt(S,t));o.push(new Uint8Array([e.currentPhase===void 0?255:Math.clamp(e.currentPhase,0,254),(e.activePlayerId??255)&255,e.currentRound===void 0?255:Math.clamp(e.currentRound,0,254)]));let A=0;for(const m of o)A+=m.length;i[5]=A>>8&255,i[6]=A&255,r.push(...o);const h=new Uint8Array(r.reduce((m,p)=>m+p.length,0));let k=0;for(const m of r)h.set(m,k),k+=m.length;return f.info(`[GameCodec] Encoded card state: ${h.length} bytes (${E} board cards, ${e.players.length} players)`),h}function Jo(e,t,a){let r=0;if(e[r++]!==lt.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],e[r++]<<8|e[r++];const n=e[r++],i=[];for(let T=0;T<n;T++){const m=e[r++],p=e[r++],S=Et[p]||"blue",_=e[r++];e[r++],e[r++];const y=e[r++]===1,l=e[r++],u=e[r++],g=[],D=m===a;for(let x=0;x<u;x++)if(D)g.push(qt(e,r,t)),r+=13;else{const N=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++],M=e[r++],H=e[r++],F=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];g.push({id:`card_${N}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:M,isFaceDown:(H&1)!==0,revealedTo:H&4?"all":void 0,statuses:Ha(F,m,t),isPlaceholder:!0})}const v=e[r++],R=[];for(let x=0;x<v;x++){const N=e[r++]<<24|e[r++]<<16|e[r++]<<8|e[r++];R.push({id:`discard_${N}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:m,isPlaceholder:!0})}let b=null;y&&(b=qt(e,r,t),r+=13);const G=[];for(let x=0;x<_;x++)G.push({id:`deck_${m}_${x}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",ownerId:m,isPlaceholder:!0});i.push({id:m,name:`Player ${m}`,score:l,hand:g,deck:G,discard:R,announcedCard:b,selectedDeck:"Random",color:S,boardHistory:[]})}const o=e[r++];r++,r++;const s=e[r++]<<8|e[r++],d=[];for(let T=0;T<o;T++){const m=[];for(let p=0;p<o;p++)m.push({card:null});d.push(m)}for(let T=0;T<s;T++){const m=e[r++],p=e[r++],S=qt(e,r,t);r+=13,m<d.length&&p<d[m].length&&(d[m][p]={card:S})}const c=e[r++],E=e[r++],w=e[r++];return{players:i,board:d,currentPhase:c===255?void 0:c,activePlayerId:E===255?null:E,currentRound:w===255?void 0:w}}function qt(e,t,a){const n=`card_${e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++]}_${Date.now()}`,i=e[t++]<<8|e[t++],o=e[t++];let s=e[t++];s>127&&(s=s-256);const d=e[t++],c=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++],E=a.cardDefinitions[i],w=(E==null?void 0:E.baseId)||"";return{id:n,baseId:w,deck:"Random",name:(E==null?void 0:E.name)||"?",imageUrl:(E==null?void 0:E.imageUrl)||"",power:s,ability:(E==null?void 0:E.ability)||"",types:(E==null?void 0:E.types)||[],faction:(E==null?void 0:E.faction)||"",ownerId:o,isFaceDown:(d&1)!==0,enteredThisTurn:(d&2)!==0,revealedTo:d&4?"all":void 0,statuses:Ha(c,0,a)}}Math.clamp||(Math.clamp=function(e,t,a){return Math.min(Math.max(e,t),a)});let jt=null;function Wa(){return jt||(jt=qo()),jt}function ba(e,t){const a=Wa();return Vo(e,a,t)}function Xo(e,t){const a=Wa();return Jo(e,a,t)}function Zo(e){return Ra(e)}function Ba(e){f.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return Eo(e)}catch(t){return f.error("[webrtcSerialization] Failed to serialize delta:",t),new Uint8Array(0)}}function Ya(e){f.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return Ra(e)}catch(t){return f.error("[webrtcSerialization] Failed to deserialize delta:",t),{}}}function Qo(e){const t=Ba(e);let a="";const r=new Uint8Array(t),n=r.byteLength;for(let i=0;i<n;i++)a+=String.fromCharCode(r[i]);return btoa(a)}function es(e){const t=atob(e),a=new Uint8Array(t.length);for(let r=0;r<t.length;r++)a[r]=t.charCodeAt(r);return Ya(a)}function ts(e,t){var w;const a=new TextEncoder,r=[],n=Date.now(),i=new Uint8Array(7);i[0]=lt.ABILITY_EFFECT,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,r.push(i);const o=[];if(o.push(new Uint8Array([e])),t.sourcePos){const A=(t.sourcePos.row&15)<<4|t.sourcePos.col&15;o.push(new Uint8Array([A]))}else o.push(new Uint8Array([255]));const s=((w=t.targetPositions)==null?void 0:w.length)||0;if(o.push(new Uint8Array([Math.min(s,255)])),t.targetPositions)for(const A of t.targetPositions.slice(0,255)){const h=(A.row&15)<<4|A.col&15;o.push(new Uint8Array([h]))}if(t.text){const A=a.encode(t.text),h=Math.min(A.length,255);o.push(new Uint8Array([h])),o.push(A.slice(0,h))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(t.value??0)&255])),o.push(new Uint8Array([(t.playerId??0)&255]));let d=0;for(const A of o)d+=A.length;i[5]=d>>8&255,i[6]=d&255,r.push(...o);const c=new Uint8Array(r.reduce((A,h)=>A+h.length,0));let E=0;for(const A of r)c.set(A,E),E+=A.length;return f.debug(`[AbilityMessages] Encoded effect type ${e}: ${c.length} bytes`),c}function rs(e){let t=0;if(e[t++]!==lt.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const a=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={effectType:e[t++],timestamp:a,data:{}},n=e[t++];n!==255&&(r.data.sourcePos={row:n>>4&15,col:n&15});const i=e[t++];if(i>0){r.data.targetPositions=[];for(let s=0;s<i;s++){const d=e[t++];r.data.targetPositions.push({row:d>>4&15,col:d&15})}}const o=e[t++];if(o>0){const s=new TextDecoder;r.data.text=s.decode(e.subarray(t,t+o)),t+=o}return r.data.value=e[t++],r.data.playerId=e[t++],r}function as(e,t={}){const a=new TextEncoder,r=[],n=Date.now(),i=new Uint8Array(7);i[0]=lt.SESSION_EVENT,i[1]=n>>24&255,i[2]=n>>16&255,i[3]=n>>8&255,i[4]=n&255,r.push(i);const o=[];if(o.push(new Uint8Array([e])),o.push(new Uint8Array([(t.playerId??0)&255])),t.playerName){const w=a.encode(t.playerName),A=Math.min(w.length,255);o.push(new Uint8Array([A])),o.push(w.slice(0,A))}else o.push(new Uint8Array([0]));o.push(new Uint8Array([(t.startingPlayerId??0)&255])),o.push(new Uint8Array([Math.min(t.roundNumber??0,255)])),o.push(new Uint8Array([Math.min(t.newPhase??0,255)])),o.push(new Uint8Array([(t.newActivePlayerId??0)&255])),o.push(new Uint8Array([(t.gameWinner??255)&255]));let s=0;if(t.winners)for(const w of t.winners)w<32&&(s|=1<<w);o.push(new Uint8Array([s>>24&255,s>>16&255,s>>8&255,s&255]));let d=0;for(const w of o)d+=w.length;i[5]=d>>8&255,i[6]=d&255,r.push(...o);const c=new Uint8Array(r.reduce((w,A)=>w+A.length,0));let E=0;for(const w of r)c.set(w,E),E+=w.length;return f.debug(`[SessionMessages] Encoded event type ${e}: ${c.length} bytes`),c}function ns(e){let t=0;if(e[t++]!==lt.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const a=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const r={eventType:e[t++],timestamp:a,data:{}};r.data.playerId=e[t++];const n=e[t++];if(n>0){const s=new TextDecoder;r.data.playerName=s.decode(e.subarray(t,t+n)),t+=n}r.data.startingPlayerId=e[t++],r.data.roundNumber=e[t++],r.data.newPhase=e[t++],r.data.newActivePlayerId=e[t++];const i=e[t++];r.data.gameWinner=i===255?null:i;const o=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];if(o!==0){r.data.winners=[];for(let s=0;s<32;s++)o&1<<s&&r.data.winners.push(s)}return r}const os=!0;class Ye{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,this.guestPlayerIds=new Map,localStorage.getItem("webrtc_enabled")}async initializeAsHost(t){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((a,r)=>{this.peer=t?new kt(t):new kt,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),a(n)}),this.peer.on("connection",n=>{f.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{f.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)}),this.peer.on("close",()=>{f.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(t){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((a,r)=>{this.peer=new kt,this.peer.on("open",n=>{const i=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(i),i.on("open",()=>{this.hostConnection=i,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}});let o=null;try{const s=localStorage.getItem("webrtc_preferred_deck");s&&(o=s,f.info(`[initializeAsGuest] Found deck preference in localStorage: ${o}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(s){f.warn("[initializeAsGuest] Failed to read deck preference:",s)}this.sendMessageToHost({type:"JOIN_REQUEST",senderId:n,data:{preferredDeck:o||void 0},timestamp:Date.now()}),a()}),i.on("error",o=>{f.error("Host connection error:",o),this.emitEvent({type:"error",data:o}),r(o)})}),this.peer.on("error",n=>{f.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),r(n)})})}async initializeAsReconnectingGuest(t,a){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((r,n)=>{this.peer=new kt,this.peer.on("open",i=>{const o=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(o),o.on("open",()=>{this.hostConnection=o,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:i,playerId:a,timestamp:Date.now()}),this.isReconnecting=!1,r()}),o.on("error",s=>{f.error("Host connection error:",s),this.emitEvent({type:"error",data:s}),this.isReconnecting=!1,n(s)})}),this.peer.on("error",i=>{f.error("WebRTC Peer error:",i),this.emitEvent({type:"error",data:i}),this.isReconnecting=!1,n(i)})})}handleGuestConnection(t){this.connections.set(t.peer,t),t.on("open",()=>{f.info(`Guest connected: ${t.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:t.peer}})}),t.on("data",a=>{this.handleMessage(a,t)}),t.on("close",()=>{f.info(`Guest disconnected: ${t.peer}`),this.connections.delete(t.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:t.peer}})}),t.on("error",a=>{f.error(`Guest connection error (${t.peer}):`,a)})}setupHostConnection(t){this.hostConnection=t,t.on("data",a=>{this.handleMessage(a,t)}),t.on("close",()=>{f.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),t.on("error",a=>{f.error("Host connection error:",a)})}handleMessage(t,a){f.debug("Received WebRTC message:",t.type),this.emitEvent({type:"message_received",data:t})}sendMessageToHost(t){var a,r,n,i;if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(t),(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&f.info(`[WebrtcManager] Sent ${t.type} to host`,{hasData:!!t.data,hasTargetingMode:!!((a=t.data)!=null&&a.targetingMode),targetingModePlayerId:(n=(r=t.data)==null?void 0:r.targetingMode)==null?void 0:n.playerId}),!0}catch(o){return f.error("Failed to send message to host:",o),!1}return(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&f.warn(`[WebrtcManager] Could not send ${t.type} to host`,{isHost:this.isHost,hasHostConnection:!!this.hostConnection,isConnectionOpen:((i=this.hostConnection)==null?void 0:i.open)??!1}),!1}broadcastToGuests(t,a){if(!this.isHost)return f.warn("Only host can broadcast to guests"),0;let r=0;return this.connections.forEach((n,i)=>{if(n.open&&i!==a)try{n.send(t),r++}catch(o){f.error(`Failed to send to guest ${i}:`,o)}}),f.debug(`Broadcast to ${r}/${this.connections.size} guests`),r}sendToGuest(t,a){if(!this.isHost)return f.warn("Only host can send to specific guest"),!1;const r=this.connections.get(t);if(!r)return f.error(`[sendToGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!r.open)return f.error(`[sendToGuest] Connection for guest ${t} is not open`),!1;try{return r.send(a),f.debug(`Sent message to guest ${t}`),!0}catch(n){return f.error(`[sendToGuest] Failed to send message to ${t}:`,n),!1}}acceptGuest(t,a,r){var i;const n=this.connections.get(t);if(!n){f.error(`[acceptGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){f.error(`[acceptGuest] Connection for guest ${t} is not open`);return}try{if(os){const o=ba(a,null),s={type:"JOIN_ACCEPT_BINARY",senderId:(i=this.peer)==null?void 0:i.id,playerId:r,data:o,timestamp:Date.now()};n.send(s),f.info(`Accepted guest ${t} as player ${r} (BINARY, ${o.byteLength} bytes)`)}}catch(o){f.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${t}:`,o)}}acceptGuestMinimal(t,a,r){var o;const n=this.connections.get(t);if(!n){f.error(`[acceptGuestMinimal] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){f.error(`[acceptGuestMinimal] Connection for guest ${t} is not open`);return}this.guestPlayerIds.set(t,r);const i={type:"JOIN_ACCEPT_MINIMAL",senderId:(o=this.peer)==null?void 0:o.id,playerId:r,data:a,timestamp:Date.now()};try{n.send(i),f.info(`Accepted guest ${t} as player ${r} (minimal)`)}catch(s){f.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${t}:`,s)}}broadcastGameState(t,a){this.broadcastGameStateLegacy(t,a)}broadcastGameStateLegacy(t,a){let r=0;this.connections.forEach((n,i)=>{var c;if(!n.open||i===a)return;const o=this.guestPlayerIds.get(i)??null,s=Ye.createPersonalizedGameState(t,o),d={type:"STATE_UPDATE_COMPACT",senderId:(c=this.peer)==null?void 0:c.id,data:{gameState:s,recipientPlayerId:o},timestamp:Date.now()};try{n.send(d),r++}catch(E){f.error(`[broadcastGameStateLegacy] Failed to send to guest ${i} (player ${o}):`,E)}}),f.debug(`[broadcastGameStateLegacy] Sent to ${r}/${this.connections.size} guests`)}static createPersonalizedGameState(t,a){return{...t,players:t.players.map(r=>{const n=a!==null&&r.id===a,i=r.isDummy===!0;if(n){const o=r.deck.length??0,s=r.discard.length??0,d=r.hand.length??0;return f.debug(`[createPersonalizedGameState] Player ${r.id} (own): ${d} hand, ${o} deck, ${s} discard`),{...r,handCards:r.hand.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier,isFaceDown:c.isFaceDown,statuses:c.statuses||[]})),deckCards:r.deck.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier,isFaceDown:c.isFaceDown,statuses:c.statuses||[]})),discardCards:r.discard.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier,isFaceDown:c.isFaceDown,statuses:c.statuses||[]})),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?Ye.optimizeCard(r.announcedCard):null,deckSize:o,discardSize:s,handSize:d}}else if(i){const o=r.deck.length??0,s=r.discard.length??0,d=r.hand.length??0;return f.info(`[createPersonalizedGameState] Player ${r.id} (dummy): sending ${d} hand, ${o} deck, ${s} discard`),{...r,handCards:r.hand.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier,isFaceDown:c.isFaceDown,statuses:c.statuses||[]})),deckCards:r.deck.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier,isFaceDown:c.isFaceDown,statuses:c.statuses||[]})),discardCards:r.discard.map(c=>({id:c.id,baseId:c.baseId,power:c.power,powerModifier:c.powerModifier,isFaceDown:c.isFaceDown,statuses:c.statuses||[]})),hand:[],deck:[],discard:[],announcedCard:r.announcedCard?Ye.optimizeCard(r.announcedCard):null,deckSize:o,discardSize:s,handSize:d}}else{const o=r.deckSize??r.deck.length??0,s=r.hand.filter(d=>!d.isFaceDown).length;return s>0&&f.debug(`[createPersonalizedGameState] Player ${r.id} (other): ${s} revealed, ${r.hand.length-s} face-down`),{...r,hand:r.hand.map(d=>d.isFaceDown?Ye.createCardBack(d):{id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier||0,isFaceDown:d.isFaceDown,statuses:d.statuses||[],ownerId:d.ownerId,ownerName:d.ownerName,deck:d.deck}),deck:[],discard:[],announcedCard:r.announcedCard?Ye.createCardBack(r.announcedCard):null,deckSize:o,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0}}}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?Ye.optimizeCard(n.card):null})))}}static createCompactStateForHost(t,a){return{...t,players:t.players.map(r=>{if(r.id===a)return f.debug(`[createCompactStateForHost] Player ${r.id} (local): sending ${r.hand.length} hand cards, ${r.deck.length} deck cards`),{...r,handCards:r.hand.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),deckCards:r.deck.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),discardCards:r.discard.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),hand:[],deck:[],discard:[],handSize:r.hand.length,deckSize:r.deck.length,discardSize:r.discard.length};{const i=r.hand.filter(d=>d.statuses&&d.statuses.length>0).length>0,o=r.isDummy===!0,s={...r,...i&&{handCards:r.hand.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier||0,isFaceDown:d.isFaceDown,statuses:d.statuses||[]}))},hand:[],deck:[],discard:[],announcedCard:null,deckSize:r.deckSize??r.deck.length??0,handSize:r.handSize??r.hand.length??0,discardSize:r.discardSize??r.discard.length??0};return o&&(f.info(`[createCompactStateForHost] Dummy player ${r.id}: sending ${r.hand.length} hand, ${r.deck.length} deck, ${r.discard.length} discard`),s.handCards=r.hand.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier||0,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),s.deckCards=r.deck.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier||0,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),s.discardCards=r.discard.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier||0,isFaceDown:d.isFaceDown,statuses:d.statuses||[]}))),r.id===a?f.info(`[createCompactStateForHost] Local player ${r.id} score: ${r.score}`):f.info(`[createCompactStateForHost] Other player ${r.id} (${o?"dummy":"real"}) score: ${s.score} (from original)`),s}}),board:t.board.map(r=>r.map(n=>({...n,card:n.card?Ye.optimizeCard(n.card):null})))}}static optimizeCard(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier,ability:t.ability,ownerId:t.ownerId,color:t.color,deck:t.deck,isFaceDown:t.isFaceDown,types:t.types,faction:t.faction,statuses:t.statuses||[],hasRevealToken:t.hasRevealToken||!1,imageUrl:t.imageUrl}}static createCardBack(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,hasRevealToken:t.hasRevealToken||!1,statuses:t.statuses||[],ownerId:t.ownerId,deck:t.deck}}broadcastStateDelta(t,a){var r,n;{const i=Qo(t),o={type:"STATE_DELTA_BINARY",senderId:(r=this.peer)==null?void 0:r.id,data:i,timestamp:Date.now()};f.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${i.length} chars, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, boardCells=${((n=t.boardCells)==null?void 0:n.length)||0}`),this.broadcastToGuests(o,a),f.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${t.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(t,a,r){var n;try{const i=ba(t,a),o=btoa(String.fromCharCode(...i)),s={type:"CARD_STATE",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,r);return f.info(`[broadcastCardState] Sent ${i.length} bytes to ${d} guests`),d}catch(i){return f.error("[broadcastCardState] Failed to encode/broadcast state:",i),0}}broadcastAbilityEffect(t,a,r){var n;try{const i=ts(t,a),o=btoa(String.fromCharCode(...i)),s={type:"ABILITY_EFFECT",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,r);return f.debug(`[broadcastAbilityEffect] Sent effect ${t} to ${d} guests`),d}catch(i){return f.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",i),0}}broadcastSessionEvent(t,a,r){var n;try{const i=as(t,a),o=btoa(String.fromCharCode(...i)),s={type:"SESSION_EVENT",senderId:(n=this.peer)==null?void 0:n.id,data:o,timestamp:Date.now()},d=this.broadcastToGuests(s,r);return f.debug(`[broadcastSessionEvent] Sent event ${t} to ${d} guests`),d}catch(i){return f.error("[broadcastSessionEvent] Failed to encode/broadcast event:",i),0}}sendAction(t,a){var n;const r={type:"ACTION",senderId:(n=this.peer)==null?void 0:n.id,data:{actionType:t,actionData:a},timestamp:Date.now()};return this.sendMessageToHost(r)}sendStateDelta(t){var a;{const r=Ba(t),n={type:"STATE_DELTA_BINARY",senderId:(a=this.peer)==null?void 0:a.id,data:r,timestamp:Date.now()};return this.sendMessageToHost(n)}}sendStateToHost(t,a){var o,s,d;if(a===null)return f.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const r=Ye.createCompactStateForHost(t,a),n=t.players.find(c=>c.id===a);n&&f.info(`[sendStateToHost] Player ${a} sending compact state: hand=${((o=n.hand)==null?void 0:o.length)??0}, deck=${((s=n.deck)==null?void 0:s.length)??0}, score=${n.score}`);const i={type:"STATE_UPDATE_COMPACT",senderId:(d=this.peer)==null?void 0:d.id,playerId:a,data:{gameState:r},timestamp:Date.now()};return this.sendMessageToHost(i)}sendFullDeckToHost(t,a,r){var i;const n={type:"DECK_DATA_UPDATE",senderId:(i=this.peer)==null?void 0:i.id,playerId:t,data:{playerId:t,deck:a.map(o=>Ye.optimizeCard(o)),deckSize:r},timestamp:Date.now()};return this.sendMessageToHost(n)}sendCustomDeckData(t,a,r){var o;if(!r)return!0;f.info(`[sendCustomDeckData] Player ${t} sending ${a.length} custom deck cards to host`);const n=a.map(s=>({id:s.id,baseId:s.baseId,name:s.name,power:s.power,powerModifier:s.powerModifier,ability:s.ability,types:s.types,faction:s.faction,imageUrl:s.imageUrl,color:s.color,deck:s.deck})),i={type:"CUSTOM_DECK_DATA",senderId:(o=this.peer)==null?void 0:o.id,playerId:t,data:{playerId:t,deckCards:n},timestamp:Date.now()};return this.sendMessageToHost(i)}getConnectionInfo(){const t=[];return this.isHost?this.connections.forEach((a,r)=>{t.push({peerId:r,playerId:null,playerName:null,connected:a.open})}):this.hostConnection&&t.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),t}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getHostPeerId(){var t,a;return this.isHost?((t=this.peer)==null?void 0:t.id)||null:((a=this.hostConnection)==null?void 0:a.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var t;return this.isHost?this.connections.size:(t=this.hostConnection)!=null&&t.open?1:0}on(t){return this.eventHandlers.add(t),()=>this.eventHandlers.delete(t)}emitEvent(t){this.eventHandlers.forEach(a=>{try{a(t)}catch(r){f.error("Error in WebRTC event handler:",r)}})}cleanup(){this.connections.forEach(t=>t.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let Vt=null;const ss=()=>(Vt||(Vt=new Ye),Vt);function is(e){return 10+e*10}function ir(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const t=e.currentPhase===1,a=e.activePlayerId===e.startingPlayerId;if(!t||!a)return{shouldEnd:!1,roundWinners:[]};const r=e.currentRound||1,n=is(r),i=[];for(const s of e.players)!s.isDummy&&!s.isDisconnected&&s.score>=n&&i.push(s.id);return{shouldEnd:i.length>0,roundWinners:i}}function za(e){const{shouldEnd:t,roundWinners:a}=ir(e);if(!t)return e;const r=e.currentRound||1,n={...e.roundWinners,[r]:a},i=new Map;for(const[,s]of Object.entries(n))for(const d of s){const c=i.get(d)||0;i.set(d,c+1)}let o=null;for(const[s,d]of i.entries())if(d>=2){o=s;break}return f.info(`[endRound] Round ${r} ended. Winners: [${a.join(", ")}], Game winner: ${o||"none"}`),{...e,roundWinners:n,gameWinner:o,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function dr(e,t){if(e.currentPhase!==0)return f.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const a=e.players.find(i=>i.id===t);if(!a)return f.error(`[performPreparationPhase] Active player ${t} not found!`),e;f.info(`[performPreparationPhase] Player ${t} has deck size: ${a.deck.length}, hand size: ${a.hand.length}`);const r=e.players.map(i=>{if(i.id===t&&i.deck.length>0){const o=i.deck[0],s=[...i.deck.slice(1)],d=[...i.hand,o];return f.info(`[performPreparationPhase] Player ${t} drew card ${(o==null?void 0:o.id)||"unknown"}, deck now: ${s.length}, hand: ${d.length}`),{...i,deck:s,hand:d,readySetup:!1,readyCommit:!1}}return i});let n={...e,players:r,currentPhase:1};return er(n,t),ir(n).shouldEnd?za(n):(f.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${n.activePlayerId}`),n)}function Ka(e,t){const a=e.activePlayerId;if(a===t){const s={...e,activePlayerId:null};return t===e.startingPlayerId&&e.currentPhase===1&&ir(s).shouldEnd?za(s):s}if(!e.players.filter(s=>!s.isDisconnected).find(s=>s.id===t))return f.warn(`[toggleActivePlayer] Player ${t} not found or disconnected`),e;let i=e.turnNumber||1;t===e.startingPlayerId&&a!==null&&i++;const o={...e,activePlayerId:t,turnNumber:i,currentPhase:0};return dr(o,t)}function ds(e,t){const a=e.players.filter(i=>!i.isDisconnected).sort((i,o)=>i.id-o.id);if(a.length===0)return null;if(t===null)return a[0].id;const r=a.findIndex(i=>i.id===t);if(r===-1)return a[0].id;const n=(r+1)%a.length;return a[n].id}function cs(e,t){var a;for(const r of e.board)for(const n of r)if(((a=n.card)==null?void 0:a.ownerId)===t)return!0;return!1}function It(e){const t=ds(e,e.activePlayerId);if(t===null)return f.warn("[passTurnToNextPlayer] No next player found"),e;f.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${t}`);let a={...e,board:e.board.map(r=>r.map(n=>{var i;return((i=n.card)==null?void 0:i.ownerId)===e.activePlayerId&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(o=>o.type!=="Stun")}}:n}))};return a={...a,board:a.board.map(r=>r.map(n=>n.card&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(i=>i.type!=="enteredThisTurn")}}:n))},a={...a,activePlayerId:t,currentPhase:0,isScoringStep:!1,targetingMode:null},dr(a,t)}function Jt(e,t,a){return f.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),e}function ls(e,t){return{type:"RECONNECT_SNAPSHOT",data:e}}function us(e,t,a){var r,n,i,o;try{const s=Xo(e,a);f.info(`[WebRTCCodec] Received card state: ${(r=s.board)==null?void 0:r.length}x${((i=(n=s.board)==null?void 0:n[0])==null?void 0:i.length)||0}, ${((o=s.players)==null?void 0:o.length)||0} players`);const d={...t};return s.players&&(d.players=s.players.map(c=>{const E=t.players.find(w=>w.id===c.id);if(E){const w=c.id===a;return{...E,...c,hand:w?E.hand:c.hand,color:E.color}}return c})),s.board&&(d.board=s.board),s.currentPhase!==void 0&&(d.currentPhase=s.currentPhase),s.activePlayerId!==void 0&&(d.activePlayerId=s.activePlayerId),s.currentRound!==void 0&&(d.currentRound=s.currentRound),d}catch(s){return f.error("[WebRTCCodec] Failed to deserialize card state:",s),t}}function fs(e,t){try{const{effectType:a,timestamp:r,data:n}=rs(e);f.debug(`[WebRTCCodec] Received ability effect: ${a}`);let i=t;switch(a){case 1:return{gameState:i,effectData:{type:"highlight",...n,timestamp:r}};case 2:return{gameState:i,effectData:{type:"floatingText",...n,timestamp:r}};case 3:return{gameState:i,effectData:{type:"noTarget",...n}};case 8:return{gameState:i,effectData:{type:"targetingMode",...n}};case 9:return{gameState:i,effectData:{type:"clearTargeting"}};default:return f.warn(`[WebRTCCodec] Unknown ability effect type: ${a}`),{gameState:i,effectData:null}}}catch(a){return f.error("[WebRTCCodec] Failed to handle ability effect:",a),{gameState:t,effectData:null}}}function ps(e,t){var a;try{const{eventType:r,data:n}=ns(e);f.info(`[WebRTCCodec] Received session event: ${r}`);const i={...t};switch(r){case 1:f.info(`[WebRTCCodec] Player connected: ${n.playerName} (ID: ${n.playerId})`);break;case 2:f.info(`[WebRTCCodec] Player disconnected: ID: ${n.playerId}`),i.players=i.players.map(o=>o.id===n.playerId?{...o,isDisconnected:!0}:o);break;case 3:f.info(`[WebRTCCodec] Game starting, first player: ${n.startingPlayerId}`),i.isGameStarted=!0,n.startingPlayerId!==void 0&&(i.activePlayerId=n.startingPlayerId,i.startingPlayerId=n.startingPlayerId);break;case 4:f.info(`[WebRTCCodec] Round ${n.roundNumber} starting`),i.currentRound=n.roundNumber??1;break;case 5:if(f.info(`[WebRTCCodec] Round ${n.roundNumber} ended, winners: ${(a=n.winners)==null?void 0:a.join(", ")}`),i.isRoundEndModalOpen=!0,n.winners&&n.roundNumber!==void 0){const o=i.roundWinners||{};o[n.roundNumber]=n.winners,i.roundWinners=o}break;case 6:f.info(`[WebRTCCodec] Phase change: ${n.newPhase}`),n.newPhase!==void 0&&(i.currentPhase=n.newPhase),n.newActivePlayerId!==void 0&&(i.activePlayerId=n.newActivePlayerId);break;case 7:f.info(`[WebRTCCodec] Turn change: player ${n.newActivePlayerId}`),n.newActivePlayerId!==void 0&&(i.activePlayerId=n.newActivePlayerId);break;case 8:f.info(`[WebRTCCodec] Game ended, winner: ${n.gameWinner}`),n.gameWinner!==void 0&&(i.gameWinner=n.gameWinner===255?null:n.gameWinner);break;default:f.warn(`[WebRTCCodec] Unknown session event type: ${r}`)}return i}catch(r){return f.error("[WebRTCCodec] Failed to handle session event:",r),t}}function ht(e,t,a,r){return e===2?{gameState:us(t,a,r)}:e===3?fs(t,a):e===4?{gameState:ps(t,a)}:(f.warn(`[WebRTCCodec] Unknown codec message type: ${e}`),{gameState:a})}const Mt="avalon_game_state",st="reconnection_data";function qa(e,t){var r;e.forEach(n=>n.forEach(i=>{var o;(o=i.card)!=null&&o.statuses&&(i.card.statuses=i.card.statuses.filter(s=>!(s.type==="LastPlayed"&&s.addedByPlayerId===t.id)))})),t.boardHistory||(t.boardHistory=[]);let a=!1;for(;t.boardHistory.length>0&&!a;){const n=t.boardHistory[t.boardHistory.length-1];for(let i=0;i<e.length;i++){for(let o=0;o<e[i].length;o++)if(((r=e[i][o].card)==null?void 0:r.id)===n){const s=e[i][o].card;if(!s||s.ownerId!==t.id)continue;s.statuses||(s.statuses=[]),s.statuses.push({type:"LastPlayed",addedByPlayerId:t.id}),a=!0;break}if(a)break}a||t.boardHistory.pop()}}function wt(e){var r;if(!e||!ze)return e;const{cardDatabase:t,tokenDatabase:a}=ze;if(e.deck===De.Tokens||(r=e.id)!=null&&r.startsWith("TKN_")){if(e.baseId&&a[e.baseId]){const i=a[e.baseId];return{...e,imageUrl:i.imageUrl,fallbackImage:i.fallbackImage}}const n=Object.keys(a).find(i=>a[i].name===e.name);if(n){const i=a[n];return{...e,imageUrl:i.imageUrl,fallbackImage:i.fallbackImage,baseId:n}}}else if(e.baseId&&t[e.baseId]){const n=t[e.baseId];return{...e,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage}}return e}function Rt(e){var r,n;if(!ze)return e;const t=((r=e.board)==null?void 0:r.map(i=>i.map(o=>({...o,card:o.card?wt(o.card):null}))))||e.board,a=((n=e.players)==null?void 0:n.map(i=>{var o,s,d;return{...i,hand:((o=i.hand)==null?void 0:o.map(wt))||[],deck:((s=i.deck)==null?void 0:s.map(wt))||[],discard:((d=i.discard)==null?void 0:d.map(wt))||[],announcedCard:i.announcedCard?wt(i.announcedCard):null}}))||e.players;return{...e,board:t,players:a,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}}function Aa(e,t,a){try{const r=Rt(e),n={gameState:r,localPlayerId:t,playerToken:a,timestamp:Date.now()};localStorage.setItem(Mt,JSON.stringify(n)),r.gameId&&t!==null&&localStorage.setItem(st,JSON.stringify({gameId:r.gameId,playerId:t,playerToken:a||null,timestamp:Date.now()}))}catch(r){console.warn("Failed to save game state:",r)}}function ys(){try{const e=localStorage.getItem(Mt);if(!e)return null;const t=JSON.parse(e),a=24*60*60*1e3;if(Date.now()-t.timestamp>a)return localStorage.removeItem(Mt),localStorage.removeItem(st),null;const r=t.gameState;return{gameState:Rt(r),localPlayerId:t.localPlayerId,playerToken:t.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}}function mt(){localStorage.removeItem(Mt),localStorage.removeItem(st)}function cr(e){const t=[...e];for(let a=t.length-1;a>0;a--){const r=Math.floor(Math.random()*(a+1));[t[a],t[r]]=[t[r],t[a]]}return t}function ja(){return Math.random().toString(36).substring(2,18).toUpperCase()}function et(e,t,a){const r=Oa();let n=e;if(e==="Random"||!r[e]){const s=Object.keys(r);if(s.length===0)return f.error("[createDeck] No decks loaded yet!"),[];n=s[0],e==="Random"||f.warn(`[createDeck] Deck ${e} not found, using ${n} instead`)}const i=r[n];if(!i)return f.error(`Deck data for ${n} not loaded! Returning empty deck. Available decks:`,Object.keys(r)),[];if(n==="Optimates"){const s={};i.forEach(d=>{const c=d.baseId||d.id;s[c]=(s[c]||0)+1})}const o=[...i].map(s=>({...s,ownerId:t,ownerName:a}));return cr(o)}function Va(e,t=!1){const a=Oa(),r=Object.keys(a);if(r.length===0)return f.error("[createNewPlayer] No decks loaded yet!"),{id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:Et[e-1]||"blue",isDummy:t,isReady:t,boardHistory:[],autoDrawEnabled:!0};const n=r[0],i={id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:n,color:Et[e-1]||"blue",isDummy:t,isReady:t,boardHistory:[],autoDrawEnabled:!0};return i.deck=et(n,e,i.name),i}function ot(){return{players:[],spectators:[],board:Ua(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:rr.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}const Sa=-1,hs=-2,gt=1,vt=2,dt=(e,t,a,r)=>{var s,d,c,E,w;const{card:n,ownerId:i,location:o}=e;if(t.targetOwnerId!==void 0&&t.targetOwnerId!==Sa&&t.targetOwnerId!==hs&&t.targetOwnerId!==i||t.excludeOwnerId!==void 0&&t.excludeOwnerId===i)return!1;if(t.onlyOpponents||t.targetOwnerId===Sa){if(i===a)return!1;const A=r.find(k=>k.id===a),h=r.find(k=>k.id===i);if(A&&h&&A.teamId!==void 0&&A.teamId===h.teamId)return!1}if(t.targetType&&!((s=n.types)!=null&&s.includes(t.targetType))||t.onlyFaceDown&&((d=n.statuses)!=null&&d.some(A=>A.type==="Revealed"&&A.addedByPlayerId===a)||o==="board"&&!n.isFaceDown)||t.tokenType==="Revealed"&&(c=n.statuses)!=null&&c.some(A=>A.type==="Revealed"&&A.addedByPlayerId===a)||t.requiredTargetStatus&&(!((E=n.statuses)!=null&&E.some(A=>A.type===t.requiredTargetStatus))||t.requireStatusFromSourceOwner&&a!==null&&!((w=n.statuses)==null?void 0:w.some(h=>h.type===t.requiredTargetStatus&&h.addedByPlayerId===a))))return!1;if(t.mustBeAdjacentToSource&&t.sourceCoords&&e.boardCoords){const{row:A,col:h}=t.sourceCoords,{row:k,col:T}=e.boardCoords;if(Math.abs(A-k)+Math.abs(h-T)!==gt)return!1}if(t.mustBeInLineWithSource&&t.sourceCoords&&e.boardCoords){const{row:A,col:h}=t.sourceCoords,{row:k,col:T}=e.boardCoords;if(A!==k&&h!==T)return!1}if(t.maxDistanceFromSource!==void 0&&t.sourceCoords&&e.boardCoords){const{row:A,col:h}=t.sourceCoords,{row:k,col:T}=e.boardCoords;if(Math.max(Math.abs(A-k),Math.abs(h-T))>t.maxDistanceFromSource)return!1}if(t.maxOrthogonalDistance!==void 0&&t.sourceCoords&&e.boardCoords){const{row:A,col:h}=t.sourceCoords,{row:k,col:T}=e.boardCoords;if(Math.abs(A-k)+Math.abs(h-T)>t.maxOrthogonalDistance)return!1}return!0},Lt=(e,t,a,r)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const n=[],i=t.board,o=i.length,s=t.activeGridSize,d=Math.floor((o-s)/2),c=d,E=d+s-1;if(e.type==="CREATE_STACK"){const T={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let m=c;m<=E;m++)for(let p=c;p<=E;p++){const S=i[m][p];S.card&&S.card.ownerId!==void 0&&dt({card:S.card,ownerId:S.card.ownerId,location:"board",boardCoords:{row:m,col:p}},T,a,t.players)&&n.push({row:m,col:p})}return n}const{mode:w,payload:A,sourceCoords:h,contextCheck:k}=e;if(w==="REVEREND_DOUBLE_EXPLOIT"){for(let T=c;T<=E;T++)for(let m=c;m<=E;m++)i[T][m].card&&n.push({row:T,col:m});return n}if((w==="SELECT_TARGET"||w==="CENSOR_SWAP"||w==="ZEALOUS_WEAKEN"||w==="CENTURION_BUFF"||w==="SELECT_UNIT_FOR_MOVE")&&A.filter&&typeof A.filter=="function"){if(A.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||A.actionType==="LUCIUS_SETUP"||A.actionType==="SELECT_HAND_FOR_DEPLOY"||A.handOnly)return[];for(let T=c;T<=E;T++)for(let m=c;m<=E;m++){const p=i[T][m];let S=p.card&&A.filter(p.card,T,m);if(S&&k==="ADJACENT_TO_LAST_MOVE"&&(r!=null&&r.lastMovedCardCoords)){const{row:_,col:y}=r.lastMovedCardCoords;Math.abs(T-_)+Math.abs(m-y)===1||(S=!1)}S&&n.push({row:T,col:m})}}else if(w==="SELECT_TARGET"&&(A.actionType==="ENHANCED_INT_REVEAL"||A.actionType==="ENHANCED_INT_MOVE"))for(let T=c;T<=E;T++)for(let m=c;m<=E;m++)i[T][m].card&&n.push({row:T,col:m});else if(w==="PATROL_MOVE"&&h)for(let T=c;T<=E;T++)for(let m=c;m<=E;m++){const p=T===h.row||m===h.col,S=T===h.row&&m===h.col,_=!i[T][m].card;p&&(_||S)&&n.push({row:T,col:m})}else if(w==="RIOT_PUSH"&&h){const T=[{r:h.row-1,c:h.col},{r:h.row+1,c:h.col},{r:h.row,c:h.col-1},{r:h.row,c:h.col+1}],m=(p,S)=>p>=c&&p<=E&&S>=c&&S<=E;T.forEach(p=>{if(m(p.r,p.c)){const S=i[p.r][p.c].card;if(S&&S.ownerId!==a){const _=t.players.find(u=>u.id===a),y=t.players.find(u=>u.id===S.ownerId);if(!((_==null?void 0:_.teamId)!==void 0&&(y==null?void 0:y.teamId)!==void 0&&_.teamId===y.teamId)){const u=p.r-h.row,g=p.c-h.col,D=p.r+u,v=p.c+g;m(D,v)&&(i[D][v].card||n.push({row:p.r,col:p.c}))}}}})}else if(w==="SHIELD_SELF_THEN_RIOT_PUSH"&&h){h&&n.push(h);const T=[{r:h.row-1,c:h.col},{r:h.row+1,c:h.col},{r:h.row,c:h.col-1},{r:h.row,c:h.col+1}],m=(p,S)=>p>=c&&p<=E&&S>=c&&S<=E;T.forEach(p=>{if(m(p.r,p.c)){const S=i[p.r][p.c].card;if(S&&S.ownerId!==a){const _=t.players.find(u=>u.id===a),y=t.players.find(u=>u.id===S.ownerId);if(!((_==null?void 0:_.teamId)!==void 0&&(y==null?void 0:y.teamId)!==void 0&&_.teamId===y.teamId)){const u=p.r-h.row,g=p.c-h.col,D=p.r+u,v=p.c+g;m(D,v)&&(i[D][v].card||n.push({row:p.r,col:p.c}))}}}})}else if(w==="RIOT_MOVE"&&A.vacatedCoords)n.push(A.vacatedCoords),h&&n.push(h);else if(w==="SWAP_POSITIONS"&&A.filter)for(let T=c;T<=E;T++)for(let m=c;m<=E;m++){const p=i[T][m];p.card&&A.filter(p.card,T,m)&&n.push({row:T,col:m})}else if((w==="TRANSFER_STATUS_SELECT"||w==="TRANSFER_ALL_STATUSES")&&A.filter)for(let T=c;T<=E;T++)for(let m=c;m<=E;m++){const p=i[T][m];p.card&&A.filter(p.card,T,m)&&n.push({row:T,col:m})}else if(w==="SPAWN_TOKEN"||w==="SELECT_CELL"||w==="IMMUNIS_RETRIEVE")for(let T=c;T<=E;T++)for(let m=c;m<=E;m++){const p=!i[T][m].card;if(w==="IMMUNIS_RETRIEVE"&&A.filter){p&&A.filter(T,m)&&n.push({row:T,col:m});continue}if(w==="SELECT_CELL"){if(A.moveFromHand){p&&n.push({row:T,col:m});continue}if(!h)continue;const S=T===h.row&&m===h.col,_=A.range==="global";let y=!1;if(_)y=!0;else if(A.range==="line")y=T===h.row||m===h.col;else if(A.range===vt){const l=Math.abs(T-h.row),u=Math.abs(m-h.col),g=l+u;if(g===gt)y=!0;else if(g===vt){const D=[];l===vt&&u===0?D.push({r:(T+h.row)/2,c:m}):l===0&&u===vt?D.push({r:T,c:(m+h.col)/2}):l===gt&&u===gt&&(D.push({r:T,c:h.col}),D.push({r:h.row,c:m})),y=D.some(v=>v.r<0||v.r>=o||v.c<0||v.c>=o?!1:!i[v.r][v.c].card)}}else y=Math.abs(T-h.row)+Math.abs(m-h.col)===gt;(p&&y||A.allowSelf&&S)&&n.push({row:T,col:m})}else if(w==="SPAWN_TOKEN"&&h){const S=Math.abs(T-h.row)+Math.abs(m-h.col)===1;p&&S&&n.push({row:T,col:m})}}else if(w==="REVEAL_ENEMY"&&A.filter)for(let T=c;T<=E;T++)for(let m=c;m<=E;m++){const p=i[T][m];p.card&&A.filter(p.card,T,m)&&n.push({row:T,col:m})}else if(w==="SELECT_LINE_START")for(let T=c;T<=E;T++)for(let m=c;m<=E;m++)n.push({row:T,col:m});else if(w==="SELECT_LINE_END"&&A.firstCoords){const{row:T,col:m}=A.firstCoords;for(let p=c;p<=E;p++)n.push({row:T,col:p});for(let p=c;p<=E;p++)n.push({row:p,col:m})}else if(w==="INTEGRATOR_LINE_SELECT"&&h){const{row:T,col:m}=h;for(let p=c;p<=E;p++)n.push({row:T,col:p});for(let p=c;p<=E;p++)n.push({row:p,col:m})}else if(w==="ZIUS_LINE_SELECT"&&h){const{row:T,col:m}=h;for(let p=c;p<=E;p++)n.push({row:T,col:p});for(let p=c;p<=E;p++)n.push({row:p,col:m})}else if(w==="IP_AGENT_THREAT_SCORING"&&h){const{row:T,col:m}=h;for(let p=c;p<=E;p++)n.push({row:T,col:p});for(let p=c;p<=E;p++)n.push({row:p,col:m})}else if(w==="SELECT_DIAGONAL")if(A.firstCoords){const{row:T,col:m}=A.firstCoords;for(let p=c;p<=E;p++)for(let S=c;S<=E;S++)Math.abs(p-T)===Math.abs(S-m)&&n.push({row:p,col:S})}else for(let T=c;T<=E;T++)for(let m=c;m<=E;m++)n.push({row:T,col:m});return n},Ct=(e,t,a,r)=>{var i,o,s,d,c;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let E=0;E<t.board.length;E++)for(let w=0;w<t.board[E].length;w++)if(t.board[E][w].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((i=e.payload)!=null&&i.actionType)){const E=e.payload.actionType;if(E==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||E==="LUCIUS_SETUP"||E==="SELECT_HAND_FOR_DEPLOY"){const w=((o=e.sourceCard)==null?void 0:o.ownerId)||a;if(w!==null){const A=t.players.find(h=>h.id===w);if(A&&A.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(Lt(e,t,a,r).length>0)return!0;const w=["Aim","Exploit","Stun","Shield"];if(!(e.tokenType&&w.includes(e.tokenType))&&(e.tokenType==="Revealed"||(s=e.tokenType)!=null&&s.startsWith("Power")))for(const h of t.players)for(let k=0;k<h.hand.length;k++){const T={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(dt({card:h.hand[k],ownerId:h.id,location:"hand"},T,a,t.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((d=e.payload)!=null&&d.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const E of t.players)if(E.hand.some(w=>e.payload.filter(w))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return Lt(e,t,a,r).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((c=e.payload)!=null&&c.filter),!1)};function ms(e){const{ws:t,webrtcManager:a,gameStateRef:r,localPlayerIdRef:n,webrtcIsHostRef:i,setLatestHighlight:o,setLatestFloatingTexts:s,setLatestNoTarget:d,setLatestDeckSelections:c,setLatestHandCardSelections:E,setClickWaves:w,setGameState:A}=e,h=$.useRef({}),k=500,T=$.useCallback(D=>{var R;const v={...D,timestamp:Date.now()};if(o(v),((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:r.current.gameId,highlightData:v}));else if(a.current){const b={type:"HIGHLIGHT_TRIGGERED",senderId:a.current.getPeerId(),data:v,timestamp:Date.now()};i.current?a.current.broadcastToGuests(b):a.current.sendMessageToHost(b)}},[t,a,r,i,o]),m=$.useCallback(D=>{var G;const v=Array.isArray(D)?D:[D],R=Date.now(),b=v.map((x,N)=>({...x,timestamp:R+N}));if(s(b),((G=t.current)==null?void 0:G.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:r.current.gameId,batch:b}));else if(a.current){const x={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:a.current.getPeerId(),data:{batch:b},timestamp:Date.now()};i.current?a.current.broadcastToGuests(x):a.current.sendMessageToHost(x)}},[t,a,r,i,s]),p=$.useCallback(D=>{var R;const v=Date.now();if(d({coords:D,timestamp:v}),((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:r.current.gameId,coords:D,timestamp:v}));else if(a.current){const b={type:"NO_TARGET_TRIGGERED",senderId:a.current.getPeerId(),data:{coords:D,timestamp:v},timestamp:Date.now()};i.current?a.current.broadcastToGuests(b):a.current.sendMessageToHost(b)}},[t,a,r,i,d]),S=$.useCallback((D,v)=>{var b;const R={playerId:D,selectedByPlayerId:v,timestamp:Date.now()};if(c(G=>[...G,R]),((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:r.current.gameId,deckSelectionData:R}));else if(a.current){const G={type:"DECK_SELECTION_TRIGGERED",senderId:a.current.getPeerId(),data:R,timestamp:Date.now()};i.current?a.current.broadcastToGuests(G):a.current.sendMessageToHost(G)}setTimeout(()=>{c(G=>G.filter(x=>x.timestamp!==R.timestamp))},1e3)},[t,a,r,i,c]),_=$.useCallback((D,v,R)=>{var G;const b={playerId:D,cardIndex:v,selectedByPlayerId:R,timestamp:Date.now()};if(E(x=>[...x,b]),((G=t.current)==null?void 0:G.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:r.current.gameId,handCardSelectionData:b}));else if(a.current){const x={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:a.current.getPeerId(),data:b,timestamp:Date.now()};i.current?a.current.broadcastToGuests(x):a.current.sendMessageToHost(x)}setTimeout(()=>{E(x=>x.filter(N=>N.timestamp!==b.timestamp))},1e3)},[t,a,r,i,E]),y=$.useCallback(D=>{},[]),l=$.useCallback((D,v,R)=>{var H;if(n.current===null)return;const b=n.current,G=Date.now(),x=h.current[b]||0;if(G-x<k)return;h.current[b]=G;const N=r.current.players.find(F=>F.id===b);if(!N)return;const M={timestamp:Date.now(),location:D,boardCoords:v,handTarget:R,clickedByPlayerId:b,playerColor:N.color};if(w(F=>[...F,M]),((H=t.current)==null?void 0:H.readyState)===WebSocket.OPEN&&r.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_CLICK_WAVE",gameId:r.current.gameId,wave:M}));else if(a.current){const F={type:"CLICK_WAVE_TRIGGERED",senderId:a.current.getPeerId(),data:M,timestamp:Date.now()};i.current?a.current.broadcastToGuests(F):a.current.sendMessageToHost(F)}setTimeout(()=>{w(F=>F.filter(q=>q.timestamp!==M.timestamp))},600)},[t,a,r,i,w]),u=$.useCallback((D,v,R,b,G,x)=>{var F;const N=r.current;if(!N||!N.board){console.warn("[setTargetingMode] No game state or board available");return}let M;b?M=b:R&&(M=Lt(D,N,v,G));const H={playerId:v,action:D,sourceCoords:R,timestamp:Date.now(),boardTargets:M,handTargets:x};if(A(q=>({...q,targetingMode:H})),((F=t.current)==null?void 0:F.readyState)===WebSocket.OPEN&&N.gameId)t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:N.gameId,targetingMode:H}));else if(a.current){const q={type:"SET_TARGETING_MODE",senderId:a.current.getPeerId(),data:H,timestamp:Date.now()};i.current?a.current.broadcastToGuests(q):a.current.sendMessageToHost(q)}},[t,a,r,i,A]),g=$.useCallback(()=>{var v;const D=r.current;if(A(R=>({...R,targetingMode:null})),((v=t.current)==null?void 0:v.readyState)===WebSocket.OPEN&&(D!=null&&D.gameId))t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:D.gameId}));else if(a.current){const R={type:"CLEAR_TARGETING_MODE",senderId:a.current.getPeerId(),data:{},timestamp:Date.now()};i.current?a.current.broadcastToGuests(R):a.current.sendMessageToHost(R)}},[t,a,r,i,A]);return{triggerHighlight:T,triggerFloatingText:m,triggerNoTarget:p,triggerDeckSelection:S,triggerHandCardSelection:_,syncValidTargets:y,triggerClickWave:l,setTargetingMode:u,clearTargetingMode:g}}function Is(e){const{ws:t,webrtcManager:a,gameStateRef:r,webrtcIsHostRef:n,setGameState:i,updateState:o}=e,s=$.useCallback(A=>{var k;if(ve()&&a.current&&n.current){i(T=>{const m=T.players.map(p=>{let S=1;for(const[_,y]of Object.entries(A))if(y.includes(p.id)){S=parseInt(_);break}return{...p,teamId:S}});return{...T,players:m}}),a.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:a.current.getPeerId(),data:{assignments:A},timestamp:Date.now()});return}((k=t.current)==null?void 0:k.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:r.current.gameId,assignments:A}))},[t,a,r,n,i]),d=$.useCallback(A=>{var k;if(ve()&&a.current&&n.current){i(T=>({...T,gameMode:A})),a.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:a.current.getPeerId(),data:{mode:A},timestamp:Date.now()});return}((k=t.current)==null?void 0:k.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:r.current.gameId,mode:A}))},[t,a,r,n,i]),c=$.useCallback(A=>{var k;if(ve()&&a.current&&n.current){i(T=>({...T,isPrivate:A})),a.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:a.current.getPeerId(),data:{isPrivate:A},timestamp:Date.now()});return}((k=t.current)==null?void 0:k.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:r.current.gameId,isPrivate:A}))},[t,a,r,n,i]),E=$.useCallback(A=>{o(h=>{if(h.isGameStarted)return h;const k={...h,activeGridSize:A};if(h.board.length!==A){k.board=[];for(let m=0;m<A;m++){const p=[];for(let S=0;S<A;S++)p.push({card:null});k.board.push(p)}}return k})},[o]),w=$.useCallback(A=>{o(h=>{if(h.isGameStarted)return h;const k=h.players.filter(p=>!p.isDummy);if(k.length+A>Ro)return h;const T=[...k],m=Math.max(...k.map(p=>p.id),0);for(let p=0;p<A;p++){const S=m+p+1,_=Va(S,!0);_.name=`Dummy ${p+1}`,T.push(_)}return{...h,players:T,dummyPlayerCount:A}})},[o]);return{assignTeams:s,setGameMode:d,setGamePrivacy:c,setActiveGridSize:E,setDummyPlayerCount:w}}function Es(e){const{ws:t,webrtcManager:a,gameStateRef:r,localPlayerIdRef:n,webrtcIsHostRef:i,setGameState:o}=e,s=$.useCallback(()=>{var w;if(ve()&&a.current&&i.current){o(A=>({...A,isReadyCheckActive:!0,isPrivate:!0})),a.current.broadcastToGuests({type:"START_READY_CHECK",senderId:a.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN&&r.current.gameId&&t.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:r.current.gameId}))},[t,a,r,i,o]),d=$.useCallback(()=>{var w;if(ve()&&a.current&&i.current){o(A=>({...A,isReadyCheckActive:!1})),a.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:a.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN&&r.current.gameId?t.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:r.current.gameId})):o(A=>({...A,isReadyCheckActive:!1}))},[t,a,r,i,o]),c=$.useCallback(()=>{var w;const E=ve();if(E&&a.current&&i.current&&n.current!==null){o(A=>{const h=A.players.map(p=>p.id===n.current?{...p,isReady:!0}:p),k={...A,players:h},T=k.players.filter(p=>!p.isDummy&&!p.isDisconnected);if(T.length>0&&T.every(p=>p.isReady)&&!k.isGameStarted){const p=k.players.filter(u=>!u.isDisconnected),S=Math.floor(Math.random()*p.length),_=p[S].id,y={...k};y.isReadyCheckActive=!1,y.isGameStarted=!0,y.startingPlayerId=_,y.activePlayerId=_,y.currentPhase=0,y.players=y.players.map(u=>{if(u.hand.length===0&&u.deck.length>0){const D=[...u.hand],v=[...u.deck];for(let R=0;R<6&&R<v.length;R++){const b=v[0];v.splice(0,1),D.push(b)}return f.info(`[playerReady] Drew initial ${D.length} cards for player ${u.id}`),{...u,hand:D,deck:v}}return u});const l=y.players.find(u=>u.id===_);if(l&&l.deck.length>0){const u=l.deck[0],g=[...l.deck.slice(1)],D=[...l.hand,u];y.players=y.players.map(v=>v.id===_?{...v,deck:g,hand:D,readySetup:!1,readyCommit:!1}:v),y.currentPhase=1}return a.current.broadcastGameState(y),a.current.broadcastToGuests({type:"GAME_START",senderId:a.current.getPeerId(),data:{startingPlayerId:_,activePlayerId:_,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),y}return a.current.broadcastToGuests({type:"HOST_READY",senderId:a.current.getPeerId(),playerId:n.current??void 0,timestamp:Date.now()}),k});return}if(E&&a.current&&!i.current&&n.current!==null){a.current.sendMessageToHost({type:"PLAYER_READY",senderId:a.current.getPeerId(),playerId:n.current,timestamp:Date.now()}),o(A=>({...A,players:A.players.map(h=>h.id===n.current?{...h,isReady:!0}:h)}));return}((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN&&r.current.gameId&&n.current!==null&&t.current.send(JSON.stringify({type:"PLAYER_READY",gameId:r.current.gameId,playerId:n.current}))},[t,a,r,n,i,o]);return{startReadyCheck:s,cancelReadyCheck:d,playerReady:c}}function Ts(e){const{updateState:t,sendWebrtcAction:a,webrtcIsHostRef:r,webrtcManagerRef:n}=e,i=$.useCallback((s,d)=>{t(c=>c.isGameStarted?c:{...c,players:c.players.map(E=>E.id===s?{...E,name:d}:E)})},[t]),o=$.useCallback((s,d)=>{t(E=>({...E,players:E.players.map(w=>w.id===s?{...w,color:d}:w)})),a!==null&&(r!=null&&r.current&&(n!=null&&n.current)?n.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:n.current.getPeerId(),data:{playerId:s,color:d},timestamp:Date.now()}):!(r!=null&&r.current)&&a&&a("CHANGE_PLAYER_COLOR",{playerId:s,color:d}))},[t,a,r,n]);return{updatePlayerName:i,changePlayerColor:o}}function ws(e){const{updateState:t}=e,a=$.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const c=d.players.find(h=>h.id===s);if(!c||c.deck.length===0)return d;const E=he(d),w=E.players.find(h=>h.id===s),A=w.deck.shift();return A&&w.hand.push(A),E})},[t]),r=$.useCallback((s,d)=>{d<=0||t(c=>{if(!c.isGameStarted)return c;const E=c.players.find(k=>k.id===s);if(!E||E.deck.length===0)return c;const w=he(c),A=w.players.find(k=>k.id===s),h=Math.min(d,A.deck.length);for(let k=0;k<h;k++){const T=A.deck.shift();T&&A.hand.push(T)}return w})},[t]),n=$.useCallback(s=>{t(d=>{if(!d.isGameStarted||!d.players.find(A=>A.id===s))return d;const E=he(d),w=E.players.find(A=>A.id===s);return w.deck=cr([...w.deck]),E})},[t]),i=$.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const c={...d},E=c.board[s.row][s.col].card;return E&&(E.isFaceDown=!1),{...c,board:Le(c)}})},[t]),o=$.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const c={...d},E=c.board[s.row][s.col].card;return E&&(E.isFaceDown=!0),{...c,board:Le(c)}})},[t]);return{drawCard:a,drawCardsBatch:r,shufflePlayerDeck:n,flipBoardCard:i,flipBoardCardFaceDown:o}}function gs(e){const{localPlayerIdRef:t,updateState:a}=e,r=$.useCallback((p,S,_)=>{a(y=>{var g,D;if(!y.isGameStarted)return y;const l=he(y),u=l.board[p.row][p.col].card;if(u){if(S==="Stun"&&(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius")&&((g=u.types)!=null&&g.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(S)&&((D=u.statuses)==null?void 0:D.some(R=>R.type===S&&R.addedByPlayerId===_)))return y;u.statuses||(u.statuses=[]),u.statuses.push({type:S,addedByPlayerId:_})}return l})},[a]),n=$.useCallback((p,S)=>{a(_=>{if(!_.isGameStarted)return _;const y=he(_),l=y.board[p.row][p.col].card;if(l!=null&&l.statuses){const u=l.statuses.map(g=>g.type).lastIndexOf(S);u>-1&&l.statuses.splice(u,1)}return y.board=Le(y),y})},[a]),i=$.useCallback((p,S,_)=>{a(y=>{if(!y.isGameStarted)return y;const l=he(y),u=l.board[p.row][p.col].card;if(u!=null&&u.statuses){const g=u.statuses.findIndex(D=>D.type===S&&D.addedByPlayerId===_);g>-1&&u.statuses.splice(g,1)}return l.board=Le(l),l})},[a]),o=$.useCallback((p,S)=>{a(_=>{if(!_.isGameStarted)return _;const y=he(_),l=y.board[p.row][p.col].card;return l&&(l.powerModifier===void 0&&(l.powerModifier=0),l.powerModifier+=S),y})},[a]),s=$.useCallback((p,S,_)=>{a(y=>{var g;if(!y.isGameStarted)return y;const l=he(y),u=l.players.find(D=>D.id===p);if(u!=null&&u.announcedCard){if(["Support","Threat","Revealed"].includes(S)&&((g=u.announcedCard.statuses)==null?void 0:g.some(v=>v.type===S&&v.addedByPlayerId===_)))return y;u.announcedCard.statuses||(u.announcedCard.statuses=[]),u.announcedCard.statuses.push({type:S,addedByPlayerId:_})}return l})},[a]),d=$.useCallback((p,S)=>{a(_=>{var u;if(!_.isGameStarted)return _;const y=he(_),l=y.players.find(g=>g.id===p);if((u=l==null?void 0:l.announcedCard)!=null&&u.statuses){const g=l.announcedCard.statuses.map(D=>D.type).lastIndexOf(S);g>-1&&l.announcedCard.statuses.splice(g,1)}return y})},[a]),c=$.useCallback((p,S)=>{a(_=>{if(!_.isGameStarted)return _;const y=he(_),l=y.players.find(u=>u.id===p);return l!=null&&l.announcedCard&&(l.announcedCard.powerModifier===void 0&&(l.announcedCard.powerModifier=0),l.announcedCard.powerModifier+=S),y})},[a]),E=$.useCallback((p,S,_,y)=>{a(l=>{var D;if(!l.isGameStarted)return l;const u=he(l),g=u.players.find(v=>v.id===p);if(g!=null&&g.hand[S]){const v=g.hand[S];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(_)&&((D=v.statuses)==null?void 0:D.some(b=>b.type===_&&b.addedByPlayerId===y)))return l;v.statuses||(v.statuses=[]),v.statuses.push({type:_,addedByPlayerId:y})}return u})},[a]),w=$.useCallback((p,S,_)=>{a(y=>{if(!y.isGameStarted)return y;const l=he(y),u=l.players.find(D=>D.id===p),g=u==null?void 0:u.hand[S];if(g!=null&&g.statuses){const D=g.statuses.map(v=>v.type).lastIndexOf(_);D>-1&&g.statuses.splice(D,1),_==="Revealed"&&(g.statuses.some(R=>R.type==="Revealed")||delete g.revealedTo)}return l})},[a]),A=$.useCallback((p,S,_)=>{a(y=>{const l=y.players.find(D=>D.id===p);if(!(l!=null&&l.hand[S]))return y;const u=he(y),g=u.players.find(D=>D.id===p).hand[S];if(_==="all")g.revealedTo="all",g.statuses||(g.statuses=[]),g.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===p)||g.statuses.push({type:"Revealed",addedByPlayerId:p});else{(!g.revealedTo||g.revealedTo==="all"||!Array.isArray(g.revealedTo))&&(g.revealedTo=[]);const D=_.filter(v=>!g.revealedTo.includes(v));g.revealedTo.push(...D)}return u})},[a]),h=$.useCallback((p,S)=>{a(_=>{if(!_.board[p.row][p.col].card)return _;const l=he(_),u=l.board[p.row][p.col].card,g=u.ownerId;if(S==="all")u.revealedTo="all",g!==void 0&&(u.statuses||(u.statuses=[]),u.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===g)||u.statuses.push({type:"Revealed",addedByPlayerId:g}));else{(!u.revealedTo||u.revealedTo==="all"||!Array.isArray(u.revealedTo))&&(u.revealedTo=[]);const D=S.filter(v=>!u.revealedTo.includes(v));u.revealedTo.push(...D)}return l})},[a]),k=$.useCallback((p,S)=>{a(_=>{var g;const y=p.boardCoords?(g=_.board[p.boardCoords.row][p.boardCoords.col].card)==null?void 0:g.ownerId:p.ownerId;if(!y)return _;const l=he(_),u=l.revealRequests.find(D=>D.fromPlayerId===S&&D.toPlayerId===y);return u?u.cardIdentifiers.some(v=>JSON.stringify(v)===JSON.stringify(p))||u.cardIdentifiers.push(p):l.revealRequests.push({fromPlayerId:S,toPlayerId:y,cardIdentifiers:[p]}),l})},[a]),T=$.useCallback((p,S)=>{a(_=>{const y=_.revealRequests.findIndex(g=>g.toPlayerId===t.current&&g.fromPlayerId===p);if(y===-1)return _;const l=he(_),u=l.revealRequests[y];if(S){const{cardIdentifiers:g}=u;for(const D of g){let v=null;if(D.source==="board"&&D.boardCoords)v=l.board[D.boardCoords.row][D.boardCoords.col].card;else if(D.source==="hand"&&D.ownerId&&D.cardIndex!==void 0){const R=l.players.find(b=>b.id===D.ownerId);R&&(v=R.hand[D.cardIndex])}v&&(v.statuses||(v.statuses=[]),v.statuses.some(R=>R.type==="Revealed"&&R.addedByPlayerId===p)||v.statuses.push({type:"Revealed",addedByPlayerId:p}))}}return l.revealRequests.splice(y,1),l})},[a,t]),m=$.useCallback(p=>{a(S=>{const _=he(S);let y=null;if(p.source==="board"&&p.boardCoords)y=_.board[p.boardCoords.row][p.boardCoords.col].card;else if(p.source==="hand"&&p.playerId&&p.cardIndex!==void 0){const l=_.players.find(u=>u.id===p.playerId);l&&(y=l.hand[p.cardIndex])}return y&&(y.statuses&&(y.statuses=y.statuses.filter(l=>l.type!=="Revealed")),delete y.revealedTo),_})},[a]);return{addBoardCardStatus:r,removeBoardCardStatus:n,removeBoardCardStatusByOwner:i,modifyBoardCardPower:o,addAnnouncedCardStatus:s,removeAnnouncedCardStatus:d,modifyAnnouncedCardPower:c,addHandCardStatus:E,removeHandCardStatus:w,revealHandCard:A,revealBoardCard:h,requestCardReveal:k,respondToRevealRequest:T,removeRevealedStatus:m}}function _s(e){const{webrtcIsHostRef:t,sendWebrtcAction:a,webrtcManagerRef:r,localPlayerIdRef:n,getCardDefinition:i,commandCardIds:o,createDeck:s,updateState:d}=e,c=$.useCallback((T,m)=>{const p=ve();let S=!1;if(d(y=>{const l=y.players.find(R=>R.id===T);if(!l)return y;S=l.isDummy||!1;const u=S,g=t.current,D=!u||g;if(p&&!g)try{localStorage.setItem("webrtc_preferred_deck",m),f.info(`[changePlayerDeck] Guest saved deck preference: ${m}`)}catch(R){f.warn("[changePlayerDeck] Failed to save deck preference:",R)}const v=D?s(m,T,l.name):[];return p?g?{...y,players:y.players.map(R=>R.id===T?{...R,deck:v,selectedDeck:m,hand:[],discard:[],announcedCard:null,boardHistory:[]}:R)}:{...y,players:y.players.map(R=>R.id===T?{...R,selectedDeck:m}:R)}:{...y,players:y.players.map(R=>R.id===T?{...R,deck:v,selectedDeck:m,hand:[],discard:[],announcedCard:null,boardHistory:[]}:R)}}),f.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${p}, isHost=${t.current}, hasSendAction=${!!a}, hasManager=${!!(r!=null&&r.current)}`),!p)return;if(t.current){const l=s(m,T,"Player "+T).map(u=>({id:u.id,baseId:u.baseId,power:u.power,powerModifier:u.powerModifier||0,isFaceDown:u.isFaceDown||!1,statuses:u.statuses||[]}));if(m==="Optimates"){const u={};l.forEach(g=>{const D=g.baseId||g.id;u[D]=(u[D]||0)+1}),f.info("[changePlayerDeck] Host sending Optimates deck data:",{totalCards:l.length,baseIdCounts:u})}r!=null&&r.current?(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:T,deckType:m,deck:l,deckSize:l.length}}),f.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${T}, deck ${m}, ${l.length} cards, isDummy=${S}`)):f.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available")}else a?a("CHANGE_PLAYER_DECK",{playerId:T,deckType:m,deck:void 0,deckSize:0}):f.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[d,s,a,t,r,n]),E=$.useCallback((T,m)=>{const p=ve();let S=[];const _=new Map;for(const{cardId:l,quantity:u}of m.cards){const g=i(l);if(!g)continue;const D=o.has(l),v=D?De.Command:De.Custom,R=D?"CMD":"CUS";for(let b=0;b<u;b++){const G=(_.get(l)||0)+1;_.set(l,G),S.push({...g,id:`${R}_${l.toUpperCase()}_${G}`,baseId:l,deck:v,ownerId:T,ownerName:"Player "+T})}}if(S=cr(S),d(l=>l.isGameStarted||!l.players.find(g=>g.id===T)?l:{...l,players:l.players.map(g=>g.id===T?{...g,deck:S,selectedDeck:De.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:g)}),!p)return;const y=S.map(l=>({id:l.id,baseId:l.baseId,power:l.power,powerModifier:l.powerModifier||0,isFaceDown:l.isFaceDown||!1,statuses:l.statuses||[]}));t.current?r!=null&&r.current&&(r.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:r.current.getPeerId(),timestamp:Date.now(),data:{playerId:T,deckType:De.Custom,deck:y,deckSize:y.length}}),f.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${T}, ${y.length} cards`)):a&&(a("CHANGE_PLAYER_DECK",{playerId:T,deckType:De.Custom,deck:y,deckSize:y.length}),f.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${T}, ${y.length} cards`))},[d,i,o,a,t,r,n]),w=$.useCallback((T,m,p,S)=>{d(_=>{if(!_.isGameStarted||_.board[p.row][p.col].card!==null)return _;const y=he(_),l=y.players.find(u=>u.id===T);if(l&&l.discard.length>m){const[u]=l.discard.splice(m,1);u.enteredThisTurn=!0,nr(u,T),(u.baseId==="luciusTheImmortal"||u.name.includes("Lucius"))&&(u.powerModifier===void 0&&(u.powerModifier=0),u.powerModifier+=2),u.statuses||(u.statuses=[]),u.statuses.push({type:"Resurrected",addedByPlayerId:T}),S&&S.forEach(g=>{var D;g.type!=="Resurrected"&&((D=u.statuses)==null||D.push({type:g.type,addedByPlayerId:T}))}),l.boardHistory||(l.boardHistory=[]),l.boardHistory.push(u.id),y.board[p.row][p.col].card=u,qa(y.board,l),y.board=Le(y)}return y})},[d]),A=$.useCallback((T,m)=>{d(p=>{const S=he(p),_=S.players.find(y=>y.id===T);if(_&&m.length>0){const y=new Set(m.map(u=>u.id)),l=_.deck.filter(u=>!y.has(u.id));_.deck=[...m,...l]}return S})},[d]),h=$.useCallback((T,m,p)=>{d(S=>{const _=he(S),y=_.players.find(l=>l.id===T);return y&&(p==="deck"?y.deck=m:p==="discard"&&(y.discard=m)),_})},[d]),k=$.useCallback((T,m)=>{d(p=>{if(!p.isGameStarted)return p;const S=he(p),_=S.players.find(y=>y.id===T);if(_&&_.discard.length>m){const[y]=_.discard.splice(m,1);_.hand.push(y)}return S})},[d]);return{changePlayerDeck:c,loadCustomDeck:E,resurrectDiscardedCard:w,reorderTopDeck:A,reorderCards:h,recoverDiscardedCard:k}}function bs(e){const{ws:t,webrtcManagerRef:a,webrtcIsHostRef:r,gameStateRef:n,scoreDeltaAccumulator:i,setGameState:o,updateState:s,abilityMode:d,setAbilityMode:c,createDeck:E}=e,w=$.useCallback(_=>{ve()&&a.current?r.current?o(l=>{const u=Ka(l,_);return a.current&&a.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:a.current.getPeerId(),data:{activePlayerId:u.activePlayerId,currentPhase:u.currentPhase,turnNumber:u.turnNumber},timestamp:Date.now()}),u}):a.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:_},timestamp:Date.now()}):t.current&&t.current.readyState===WebSocket.OPEN&&(i.forEach((l,u)=>{clearTimeout(l.timerId),f.info(`[ScoreFlush] Flushing on toggle: player=${u}, delta=${l.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:n.current.gameId,playerId:u,delta:l.delta}))}),i.clear(),t.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:n.current.gameId,playerId:_})))},[t,a,r,n,i,o]),A=$.useCallback((_,y)=>{t.current&&t.current.readyState===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:n.current.gameId,playerId:_,enabled:y}))},[]),h=$.useCallback(_=>{const y=d&&c&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode);y&&c(null),s(l=>{if(!l.isGameStarted)return l;const u=Math.max(1,Math.min(_,4));return{...l,currentPhase:u,...u===4&&!y?{isScoringStep:!0}:{},...y?{isScoringStep:!1}:{}}})},[s,d,c]),k=$.useCallback(()=>{var l;d&&c&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&c(null);const _=n.current,y=ve();if(_.isGameStarted&&_.currentPhase===4&&_.isScoringStep&&!y){((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&(i.forEach((u,g)=>{clearTimeout(u.timerId),f.info(`[ScoreFlush] Flushing pending score: player=${g}, delta=${u.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:_.gameId,playerId:g,delta:u.delta}))}),i.clear(),t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:_.gameId})));return}if(y&&_.isGameStarted&&_.currentPhase===4&&_.isScoringStep){s(u=>It(u));return}s(u=>{if(!u.isGameStarted)return u;const g=he(u),D=u.currentPhase+1;return u.preserveDeployAbilities||g.board.forEach(v=>{v.forEach(R=>{var b;(b=R.card)!=null&&b.statuses&&(R.card.statuses=R.card.statuses.filter(G=>G.type!=="readyDeploy"))})}),y&&D===4&&u.currentPhase===3?cs(u,u.activePlayerId)?(g.isScoringStep=!0,g.currentPhase=4,g):(f.info(`[nextPhase] Player ${u.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),It(u)):D===4&&u.currentPhase===3?(g.isScoringStep=!0,g.currentPhase=4,g):(g.board.forEach(v=>{v.forEach(R=>{var b;if((b=R.card)!=null&&b.statuses){const G=R.card.statuses.findIndex(x=>x.type==="Resurrected");if(G!==-1){const x=R.card.statuses[G].addedByPlayerId;R.card.statuses.splice(G,1),R.card.baseId!=="luciusTheImmortal"&&(R.card.statuses.push({type:"Stun",addedByPlayerId:x}),R.card.statuses.push({type:"Stun",addedByPlayerId:x}))}}})}),g.board=Le(g),g.currentPhase=D,g)})},[s,d,c,n,t,i]),T=$.useCallback(()=>{s(_=>_.isGameStarted?(d&&c&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&c(null),_.isScoringStep?{..._,isScoringStep:!1,currentPhase:Math.max(1,_.currentPhase-1)}:{..._,currentPhase:Math.max(1,_.currentPhase-1)}):_)},[s,d,c]),m=$.useCallback(()=>{var y;ve()?s(l=>({...l,isRoundEndModalOpen:!1,currentRound:(l.currentRound||1)+1,players:l.players.map(u=>({...u,score:0}))})):((y=t.current)==null?void 0:y.readyState)===WebSocket.OPEN&&n.current.gameId&&(o(l=>({...l,isRoundEndModalOpen:!1,currentRound:(l.currentRound||1)+1,players:l.players.map(u=>({...u,score:0}))})),t.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:n.current.gameId})))},[o,s,t,n]),p=$.useCallback(()=>{o(_=>({..._,isRoundEndModalOpen:!1}))},[o]),S=$.useCallback(()=>{var y;if(ve()){const l=n.current,u=l.players.map(R=>{const b=R.selectedDeck||"SynchroTech";return{...R,hand:[],deck:E(b,R.id,R.name),discard:[],score:0,isReady:R.isDummy||!1,announcedCard:null,boardHistory:[]}}),g=l.activeGridSize||8,D=[];for(let R=0;R<g;R++){const b=[];for(let G=0;G<g;G++)b.push({card:null});D.push(b)}const v={...l,players:u,board:D,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};o(v),n.current=v,a.current&&a.current.broadcastToGuests({type:"GAME_RESET",senderId:a.current.getPeerId(),data:{players:u.map(R=>({id:R.id,name:R.name,color:R.color,selectedDeck:R.selectedDeck,isDummy:R.isDummy,isDisconnected:R.isDisconnected,autoDrawEnabled:R.autoDrawEnabled,handSize:R.hand.length,deckSize:R.deck.length,discardSize:R.discard.length,...R.isDummy&&{hand:R.hand.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses})),deck:R.deck.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses})),discard:R.discard.map(b=>({id:b.id,baseId:b.baseId,name:b.name,imageUrl:b.imageUrl,power:b.power,powerModifier:b.powerModifier,ability:b.ability,ownerId:b.ownerId,color:b.color,deck:b.deck,isFaceDown:b.isFaceDown,types:b.types,faction:b.faction,statuses:b.statuses}))},score:R.score,isReady:R.isReady,announcedCard:R.announcedCard})),gameMode:v.gameMode,isPrivate:v.isPrivate,activeGridSize:v.activeGridSize,dummyPlayerCount:v.dummyPlayerCount,autoAbilitiesEnabled:v.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((y=t.current)==null?void 0:y.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"RESET_GAME",gameId:n.current.gameId}))},[t,a,n,o,E]);return{toggleActivePlayer:w,toggleAutoDraw:A,setPhase:h,nextPhase:k,prevPhase:T,closeRoundEndModal:m,closeRoundEndModalOnly:p,resetGame:S}}function As(e){const{ws:t,gameStateRef:a,updateState:r,updatePlayerScore:n,triggerFloatingText:i,clearTargetingMode:o}=e,s=$.useCallback((c,E,w,A,h)=>{var D,v;const k=a.current;if(!k.isGameStarted||k.isRoundEndModalOpen)return;const T=k.board.some(R=>R.some(b=>{var G,x;return((G=b.card)==null?void 0:G.ownerId)===h&&b.card.name.toLowerCase().includes("data liberator")&&((x=b.card.statuses)==null?void 0:x.some(N=>N.type==="Support"))})),m=k.board.length;let p=c,S=c,_=E,y=E;if(c===w)p=c,S=c,_=0,y=m-1;else if(E===A)_=E,y=E,p=0,S=m-1;else return;let l=0;const u=[];for(let R=p;R<=S;R++)for(let b=_;b<=y;b++){const x=k.board[R][b].card;if(x&&!((D=x.statuses)!=null&&D.some(N=>N.type==="Stun"))){const N=x.ownerId===h,M=(v=x.statuses)==null?void 0:v.some(H=>H.type==="Exploit"&&H.addedByPlayerId===h);if(N||T&&M&&x.ownerId!==h){const H=Math.max(0,x.power+(x.powerModifier||0)+(x.bonusPower||0));H>0&&(l+=H,u.push({row:R,col:b,text:`+${H}`,playerId:h}))}}}u.length>0&&i(u);const g=ve();if(g?r(R=>({...R,players:R.players.map(b=>b.id===h?{...b,score:Math.max(0,(b.score||0)+l)}:b)})):n(h,l),g||n(h,l),l>0&&k.currentPhase===4&&k.activePlayerId===h){const R=k.gameId;setTimeout(()=>{var b;o==null||o(),g?r(G=>It(G)):((b=t.current)==null?void 0:b.readyState)===WebSocket.OPEN&&R&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:R}))},100)}},[i,n,r,t,a,o,It]),d=$.useCallback((c,E,w,A,h,k)=>{var g,D;const T=a.current;if(!T.isGameStarted||T.isRoundEndModalOpen)return;const m=w>c?1:-1,p=A>E?1:-1,S=Math.abs(c-w);let _=0,y=0;const l=[];for(let v=0;v<=S;v++){const R=c+v*m,b=E+v*p;if(R<0||R>=T.board.length||b<0||b>=T.board.length)continue;const x=T.board[R][b].card;if(x&&!((g=x.statuses)!=null&&g.some(N=>N.type==="Stun"))&&x.ownerId===h){const M=Math.max(0,x.power+(x.powerModifier||0)+(x.bonusPower||0));M>0&&(_+=M,l.push({row:R,col:b,text:`+${M}`,playerId:h})),k&&((D=x.statuses)!=null&&D.some(H=>H.type==="Support"&&H.addedByPlayerId===h))&&(y+=1)}}k==="point_per_support"&&y>0&&(_+=y),l.length>0&&i(l);const u=ve();if(u?r(v=>({...v,players:v.players.map(R=>R.id===h?{...R,score:Math.max(0,(R.score||0)+_)}:R)})):n(h,_),u||n(h,_),k==="draw_per_support"&&y>0&&r(v=>{const R=he(v),b=R.players.find(G=>G.id===h);if(b&&b.deck.length>0)for(let G=0;G<y;G++)b.deck.length>0&&b.hand.push(b.deck.shift());return R}),_>0&&T.currentPhase===4&&T.activePlayerId===h){const v=T.gameId;setTimeout(()=>{var R;o==null||o(),u?r(b=>It(b)):((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&v&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:v}))},500)}},[i,n,r,t,a,o,It]);return{scoreLine:s,scoreDiagonal:d}}const Ss=e=>{const{updateState:t,rawJsonData:a}=e,r=$.useCallback((w,A,h,k)=>{t(T=>{var S,_;if(!T.isGameStarted||w.row<0||w.col<0)return T;const m=he(T),p=(_=(S=m.board[w.row])==null?void 0:S[w.col])==null?void 0:_.card;if(p){const y=p.statuses?p.statuses.map(l=>l.type):[];if(k&&p.statuses){p.statuses=p.statuses.filter(u=>u.type!==k);const l=p.statuses.map(u=>u.type);f.debug(`[markAbilityUsed] Removed status '${k}' from ${p.name} at [${w.row},${w.col}]: [${y.join(", ")}] -> [${l.join(", ")}]`)}else f.debug(`[markAbilityUsed] Called for ${p.name} at [${w.row},${w.col}] but no readyStatusToRemove specified. Current statuses: [${y.join(", ")}]`)}return m})},[t]),n=$.useCallback(w=>{t(A=>{var T,m;if(!A.isGameStarted||w.row<0||w.col<0)return A;const h=he(A),k=(m=(T=h.board[w.row])==null?void 0:T[w.col])==null?void 0:m.card;if(k&&(k.statuses||(k.statuses=[]),(k.ability||"").toLowerCase().includes("deploy:")&&!k.statuses.some(S=>S.type==="readyDeploy"))){const S=k.ownerId;if(S==null||S===0)return A;k.statuses.push({type:"readyDeploy",addedByPlayerId:S})}return h})},[t]),i=$.useCallback((w,A)=>{t(h=>{if(!h.isGameStarted)return h;const k=he(h),T=k.board[w.row][w.col].card;return T!=null&&T.statuses&&(T.statuses=T.statuses.filter(m=>m.type!==A)),k.board=Le(k),k})},[t]),o=$.useCallback((w,A,h,k,T)=>{t(m=>{if(!m.isGameStarted)return m;const p=he(m);return A.forEach(({row:S,col:_})=>{var l;const y=p.board[S][_].card;if(y){if(h==="Stun"&&(y.baseId==="luciusTheImmortal"||y.name.includes("Lucius")&&((l=y.types)!=null&&l.includes("Hero"))))return;y.statuses||(y.statuses=[]),["Support","Threat","Revealed"].includes(h)?y.statuses.some(g=>g.type===h&&g.addedByPlayerId===k)||y.statuses.push({type:h,addedByPlayerId:k}):y.statuses.push({type:h,addedByPlayerId:k})}}),p})},[t]),s=$.useCallback((w,A)=>{t(h=>{if(!h.isGameStarted)return h;const k=he(h),T=k.board[w.row][w.col].card,m=k.board[A.row][A.col].card;return k.board[w.row][w.col].card=m,k.board[A.row][A.col].card=T,k.board=Le(k),k})},[t]),d=$.useCallback((w,A,h)=>{t(k=>{if(!k.isGameStarted)return k;const T=he(k),m=T.board[w.row][w.col].card,p=T.board[A.row][A.col].card;if(m&&p&&m.statuses){const S=m.statuses.findIndex(_=>_.type===h);if(S>-1){const[_]=m.statuses.splice(S,1);p.statuses||(p.statuses=[]),p.statuses.push(_)}}return T.board=Le(T),T})},[t]),c=$.useCallback((w,A)=>{t(h=>{if(!h.isGameStarted)return h;const k=he(h),T=k.board[w.row][w.col].card,m=k.board[A.row][A.col].card,p=["Support","Threat","LastPlayed"];if(T&&m&&T.statuses){const S=T.statuses.filter(y=>!p.includes(y.type)),_=T.statuses.filter(y=>p.includes(y.type));S.length>0&&(m.statuses||(m.statuses=[]),m.statuses.push(...S),T.statuses=_)}return k.board=Le(k),k})},[t]),E=$.useCallback((w,A,h)=>{t(k=>{if(!k.isGameStarted)return k;const T=he(k);if(!a)return k;const m=a.tokenDatabase,p=Object.keys(m).find(y=>m[y].name===A);if(!p)return k;const S=m[p],_=T.players.find(y=>y.id===h);if(S&&T.board[w.row][w.col].card===null){const y={id:`TKN_${A.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:De.Tokens,name:A,baseId:S.baseId||p,imageUrl:S.imageUrl,fallbackImage:S.fallbackImage,power:S.power,ability:S.ability,flavorText:S.flavorText,color:S.color,types:S.types||["Unit"],faction:"Tokens",ownerId:h,ownerName:_==null?void 0:_.name,enteredThisTurn:!0,statuses:[]};nr(y,h),T.board[w.row][w.col].card=y}return T.board=Le(T),T})},[t,a]);return{markAbilityUsed:r,applyGlobalEffect:o,swapCards:s,transferStatus:d,transferAllCounters:c,spawnToken:E,resetDeployStatus:n,removeStatusByType:i}};function Cs(e){const{updateState:t,localPlayerIdRef:a,updatePlayerScore:r}=e,n=$.useCallback((o,s)=>{t(d=>{var T,m,p,S,_,y;if(!d.isGameStarted||s.target==="board"&&s.boardCoords&&d.board[s.boardCoords.row][s.boardCoords.col].card!==null&&o.source!=="counter_panel")return d;let c=!1;try{const l=localStorage.getItem("auto_abilities_enabled");c=l===null?!0:l==="true"}catch{c=!0}const E=c&&d.currentPhase===1&&o.source==="hand"&&s.target==="board"&&(((T=o.card.types)==null?void 0:T.includes("Unit"))||((m=o.card.types)==null?void 0:m.includes("Command"))),w=he(d);if(o.source==="board"&&["hand","deck","discard"].includes(s.target)&&!o.bypassOwnershipCheck){const l=o.card.ownerId,u=w.players.find(v=>v.id===l),g=l===a.current,D=!!(u!=null&&u.isDummy);if(!g&&!D)return d}let A=null;if(o.source==="board"&&s.target==="board"&&o.boardCoords){const l=w.board[o.boardCoords.row][o.boardCoords.col];l.card&&(A=l.card);const g=d.board[o.boardCoords.row][o.boardCoords.col].card||A;if(g&&((p=g.statuses)==null?void 0:p.some(v=>v.type==="Stun"))){const v=a.current,R=g.ownerId,b=d.players.find(M=>M.id===v),G=d.players.find(M=>M.id===R),x=v===R,N=(b==null?void 0:b.teamId)!==void 0&&(G==null?void 0:G.teamId)!==void 0&&b.teamId===G.teamId;if((x||N)&&!o.isManual)return d}}if(o.source==="counter_panel"&&o.statusType){const l=ct[o.statusType],u=(l==null?void 0:l.allowedTargets)??["board","hand"];if(!u.includes(s.target)&&!u.includes("board-facedown"))return d;let g=null;if(s.target==="board"&&s.boardCoords){if(g=w.board[s.boardCoords.row][s.boardCoords.col].card,u.includes("board-facedown")&&g&&!g.isFaceDown)return d}else if(s.playerId!==void 0){const D=w.players.find(v=>v.id===s.playerId);D&&(s.target==="hand"&&s.cardIndex!==void 0&&(g=D.hand[s.cardIndex]),s.target==="announced"&&(g=D.announcedCard||null),s.target==="deck"&&D.deck.length>0?s.deckPosition==="top"||!s.deckPosition?g=D.deck[0]:g=D.deck[D.deck.length-1]:s.target==="discard"&&D.discard.length>0&&(g=D.discard[D.discard.length-1]))}if(g){if(o.statusType==="Stun"&&(g.baseId==="luciusTheImmortal"||g.name.includes("Lucius")&&((S=g.types)!=null&&S.includes("Hero"))))return w;const D=o.count||1;let v;if(o.ownerId!==void 0)v=o.ownerId;else if(o.card.ownerId!==void 0)v=o.card.ownerId;else{const R=w.players.find(b=>b.id===w.activePlayerId);v=R!=null&&R.isDummy?R.id:a.current!==null?a.current:0}if(o.statusType==="Revealed"&&(s.target==="board"&&g.ownerId===v||s.target==="hand"&&s.playerId===v))return d;if(o.statusType==="Power+")g.powerModifier===void 0&&(g.powerModifier=0),g.powerModifier+=1*D;else if(o.statusType==="Power-")g.powerModifier===void 0&&(g.powerModifier=0),g.powerModifier-=1*D;else if(o.statusType==="Revealed"&&s.target==="hand"){if(g.revealedTo||(g.revealedTo=[]),g.revealedTo!=="all"){const b=Array.isArray(g.revealedTo)?g.revealedTo:[];b.includes(v)||b.push(v),g.revealedTo=b}g.statuses||(g.statuses=[]),g.statuses.some(b=>b.type==="Revealed"&&b.addedByPlayerId===v)||g.statuses.push({type:"Revealed",addedByPlayerId:v})}else if(g.statuses||(g.statuses=[]),o.replaceStatusType&&o.statusType)for(let R=0;R<D;R++){const b=g.statuses.findIndex(G=>G.type===o.replaceStatusType&&G.addedByPlayerId===v);b!==-1?g.statuses[b]={type:o.statusType,addedByPlayerId:v}:g.statuses.push({type:o.statusType,addedByPlayerId:v})}else for(let R=0;R<D;R++)["Support","Threat","Revealed"].includes(o.statusType)?g.statuses.some(G=>G.type===o.statusType&&G.addedByPlayerId===v)||g.statuses.push({type:o.statusType,addedByPlayerId:v}):g.statuses.push({type:o.statusType,addedByPlayerId:v});return s.target==="board"&&(w.board=Le(w)),w}return d}const h=A?{...A}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const l=w.players.find(u=>u.id===o.playerId);if(l){const u=l.hand[o.cardIndex];if(u&&u.id===o.card.id&&u.ownerId===o.card.ownerId)l.hand.splice(o.cardIndex,1);else{const g=l.hand.findIndex(D=>D.id===o.card.id&&D.ownerId===o.card.ownerId);if(g!==-1)l.hand.splice(g,1);else return d}}}else if(o.source==="board"&&o.boardCoords){const l=w.board[o.boardCoords.row][o.boardCoords.col];if(l.card&&l.card.id===o.card.id&&l.card.ownerId===o.card.ownerId)w.board[o.boardCoords.row][o.boardCoords.col].card=null;else return d}else if(o.source==="discard"&&o.playerId!==void 0){const l=w.players.find(u=>u.id===o.playerId);if(l){let u=!1;if(o.cardIndex!==void 0){const g=l.discard[o.cardIndex];g&&g.id===o.card.id&&g.ownerId===o.card.ownerId&&(l.discard.splice(o.cardIndex,1),u=!0)}if(!u){const g=l.discard.findIndex(D=>D.id===o.card.id&&D.ownerId===o.card.ownerId);if(g!==-1)l.discard.splice(g,1);else return d}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const l=w.players.find(u=>u.id===o.playerId);if(l){const u=l.deck[o.cardIndex];if(u&&u.id===o.card.id&&u.ownerId===o.card.ownerId)l.deck.splice(o.cardIndex,1);else{const g=l.deck.findIndex(D=>D.id===o.card.id&&D.ownerId===o.card.ownerId);if(g!==-1)l.deck.splice(g,1);else return d}}}else if(o.source==="announced"&&o.playerId!==void 0){const l=w.players.find(u=>u.id===o.playerId);if(l)if(l.announcedCard&&l.announcedCard.id===o.card.id)l.announcedCard=null;else return d}if(["hand","deck","discard"].includes(s.target))h.statuses&&(h.statuses=h.statuses.filter(l=>l.type==="Revealed")),h.isFaceDown=!1,delete h.powerModifier,delete h.bonusPower,delete h.enteredThisTurn;else if(s.target==="board"&&(h.statuses||(h.statuses=[]),o.source!=="board"&&h.isFaceDown===void 0&&(h.isFaceDown=!1),o.source!=="board")){h.enteredThisTurn=!0;let l=h.ownerId;l===void 0&&(o.source==="token_panel"?o.ownerId!==void 0?l=o.ownerId:l=w.activePlayerId??a.current??0:o.playerId!==void 0?l=o.playerId:l=a.current??0,h.ownerId=l),nr(h,l),o.source==="discard"&&(h.baseId==="luciusTheImmortal"||h.name.includes("Lucius"))&&(h.powerModifier===void 0&&(h.powerModifier=0),h.powerModifier+=2)}if(s.target==="hand"&&s.playerId!==void 0){if(h.deck===De.Tokens)return w.board[o.boardCoords.row][o.boardCoords.col].card=null,w;Wt(h);const u=w.players.find(D=>D.id===s.playerId);if(!u)return d;let g=s.cardIndex!==void 0?s.cardIndex:u.hand.length;if(o.source==="hand"&&o.playerId===s.playerId&&o.cardIndex!==void 0&&(o.cardIndex<g&&(g-=1),o.cardIndex===g))return d;u.hand.splice(g,0,h)}else if(s.target==="board"&&s.boardCoords){if(w.board[s.boardCoords.row][s.boardCoords.col].card===null){if(h.ownerId===void 0&&a.current!==null){const l=w.players.find(u=>u.id===a.current);l&&(h.ownerId=l.id,h.ownerName=l.name)}if(o.source!=="board"&&h.ownerId!==void 0){const l=w.players.find(u=>u.id===h.ownerId);l&&(l.boardHistory||(l.boardHistory=[]),l.boardHistory.push(h.id))}w.board[s.boardCoords.row][s.boardCoords.col].card=h}}else if(s.target==="discard"&&s.playerId!==void 0){if(h.deck===De.Tokens)return w.board[o.boardCoords.row][o.boardCoords.col].card=null,w;Wt(h);const u=w.players.find(g=>g.id===s.playerId);u&&(h.ownerId===void 0&&(h.ownerId=s.playerId,h.ownerName=u.name),u.discard.some(D=>D.id===h.id)||u.discard.push(h))}else if(s.target==="deck"&&s.playerId!==void 0){if(h.deck===De.Tokens)return w.board[o.boardCoords.row][o.boardCoords.col].card=null,w;Wt(h);const u=w.players.find(g=>g.id===s.playerId);if(!u)return d;h.ownerId===void 0&&(h.ownerId=s.playerId,h.ownerName=u.name),s.deckPosition==="top"||!s.deckPosition?u.deck.unshift(h):u.deck.push(h)}else if(s.target==="announced"&&s.playerId!==void 0){const l=w.players.find(u=>u.id===s.playerId);l&&(l.announcedCard&&(l.announcedCard.statuses&&(l.announcedCard.statuses=l.announcedCard.statuses.filter(u=>u.type==="Revealed")),delete l.announcedCard.enteredThisTurn,delete l.announcedCard.powerModifier,delete l.announcedCard.bonusPower,l.hand.push(l.announcedCard)),l.announcedCard=h)}if(o.source==="board"&&s.target!=="board"&&h.ownerId!==void 0){const l=w.players.find(u=>u.id===h.ownerId);l&&(l.boardHistory||(l.boardHistory=[]),l.boardHistory=l.boardHistory.filter(u=>u!==h.id))}if((o.source==="board"||s.target==="board")&&h.ownerId!==void 0){const l=w.players.find(u=>u.id===h.ownerId);l&&qa(w.board,l)}if(o.source==="hand"&&s.target==="board"){const l=h;if(l.revealedTo==="all"||((_=l.statuses)==null?void 0:_.some(g=>g.type==="Revealed"))){const g=w.board.length;for(let D=0;D<g;D++)for(let v=0;v<g;v++){const R=w.board[D][v].card;if(R&&R.name.toLowerCase().includes("vigilant spotter")&&R.ownerId!==l.ownerId&&(w.board=Le(w),(y=w.board[D][v].card.statuses)!=null&&y.some(G=>G.type==="Support"))){const G=w.players.find(x=>x.id===R.ownerId);G&&setTimeout(()=>{r(G.id,2)},0)}}}}return(o.source==="board"||s.target==="board")&&(w.board=Le(w)),E&&(w.currentPhase=2),w})},[t,a,r]),i=$.useCallback((o,s)=>{t(d=>{if(!d.isGameStarted)return d;const c=he(d),E=c.board.length;if(o.row<0||o.row>=E||o.col<0||o.col>=E||s.row<0||s.row>=E||s.col<0||s.col>=E)return d;const w=c.board[o.row][o.col],A=c.board[s.row][s.col],h=w.card,k=A.card;return!h||!k?d:(c.board[o.row][o.col].card=k,c.board[s.row][s.col].card=h,c.board=Le(c),c)})},[t]);return{moveItem:n,swapBoardCards:i}}function Ds(e){const{ws:t,webrtcManager:a,gameStateRef:r,webrtcIsHostRef:n,setGameState:i}=e,o=$.useCallback((d,c,E,w,A,h)=>{var _,y,l,u,g,D,v;const k=r.current;if(typeof c!="number"){f.error(`[TargetingMode] Invalid playerId type: ${typeof c}, value:`,c);return}let T=[];w?T=w:T=Lt(d,k,c,A);let m=[];if(h)m=h;else if(m=[],(_=d.payload)!=null&&_.filter&&d.mode==="SELECT_TARGET"){f.info("[TargetingMode] Calculating hand targets for action",{actionMode:d.mode,filterType:typeof d.payload.filter,hasActionType:!!d.payload.actionType});for(const R of k.players)R.hand&&R.hand.forEach((b,G)=>{try{d.payload.filter(b)&&(m.push({playerId:R.id,cardIndex:G}),f.debug(`[TargetingMode] Found hand target: player ${R.id}, card ${G}, card ${b.name}`))}catch(x){f.warn(`[TargetingMode] Filter failed for card ${b.name}:`,x)}});f.info(`[TargetingMode] Hand targets calculated: ${m.length} targets`)}else f.info("[TargetingMode] No hand targets calculated - no filter or wrong mode",{hasFilter:!!((y=d.payload)!=null&&y.filter),mode:d.mode});const p=d.mode==="SELECT_DECK",S={playerId:c,action:d,sourceCoords:E,timestamp:Date.now(),boardTargets:T,handTargets:m.length>0?m:void 0,isDeckSelectable:p||void 0,originalOwnerId:d.originalOwnerId};if(i(R=>({...R,targetingMode:S})),r.current.targetingMode=S,((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&k.gameId&&t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:k.gameId,targetingMode:S})),a.current)if(n.current)a.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((g=(u=a.current).getPeerId)==null?void 0:g.call(u))??void 0,data:{targetingMode:S},timestamp:Date.now()});else{const R=a.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((v=(D=a.current).getPeerId)==null?void 0:v.call(D))??void 0,data:{targetingMode:S},timestamp:Date.now()});f.info("[TargetingMode] Guest sent SET_TARGETING_MODE to host",{success:R,playerId:c,boardTargetsCount:T.length,handTargetsCount:m.length})}f.info(`[TargetingMode] Player ${c} (type: ${typeof c}) activated targeting mode`,{mode:d.mode,boardTargetsCount:T.length,handTargetsCount:m.length,isDeckSelectable:p||!1})},[t,a,r,n,i]),s=$.useCallback(()=>{var c,E,w,A,h;const d=r.current;i(k=>({...k,targetingMode:null})),r.current.targetingMode=null,((c=t.current)==null?void 0:c.readyState)===WebSocket.OPEN&&d.gameId&&t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:d.gameId})),a.current&&(n.current?a.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((w=(E=a.current).getPeerId)==null?void 0:w.call(E))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):a.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((h=(A=a.current).getPeerId)==null?void 0:h.call(A))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[t,a,r,n,i]);return{setTargetingMode:o,clearTargetingMode:s}}function Rs(e){const{webrtcManagerRef:t,webrtcIsHostRef:a,setWebrtcIsHost:r,setConnectionStatus:n,setWebrtcHostId:i,gameStateRef:o,localPlayerIdRef:s}=e,d=$.useCallback(async()=>{var h;if(!t.current)return f.error("WebRTC manager not initialized"),null;try{r(!0),n("Connecting");const k=await t.current.initializeAsHost();i(k),n("Connected");const T=o.current.gameId;T&&tr(k,T);const m=(h=o.current.players)==null?void 0:h.find(p=>p.id===s.current);return Fo({peerId:k,isHost:!0,playerName:(m==null?void 0:m.name)||null}),f.info("[initializeWebrtcHost] Saved host data for auto-restore"),k}catch(k){return f.error("Failed to initialize WebRTC host:",k),n("Disconnected"),null}},[t,r,n,i,o,s]),c=$.useCallback(async h=>{if(!t.current)return f.error("WebRTC manager not initialized"),!1;try{return r(!1),i(h),n("Connecting"),await t.current.initializeAsGuest(h),!0}catch(k){return f.error("Failed to connect as guest:",k),n("Disconnected"),!1}},[t,r,n,i]),E=$.useCallback((h,k)=>t.current?a.current?(f.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):t.current.sendAction(h,k):(f.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[t,a]),w=$.useCallback(h=>{var T,m;if(!t.current||a.current)return f.warn("[requestDeckView] Only guests can request deck view from host"),!1;const k={type:"REQUEST_DECK_VIEW",senderId:t.current.getPeerId(),playerId:a.current||(m=(T=t.current).getLocalPlayerId)==null?void 0:m.call(T),data:{targetPlayerId:h},timestamp:Date.now()};return t.current.sendMessageToHost(k)},[t,a]),A=$.useCallback((h,k,T)=>!t.current||a.current?(f.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):t.current.sendFullDeckToHost(h,k,T),[t,a]);return{initializeWebrtcHost:d,connectAsGuest:c,sendWebrtcAction:E,requestDeckView:w,sendFullDeckToHost:A}}function ks(){const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return f.warn("No custom WebSocket URL configured in settings."),null;let t=e.trim();return t.endsWith("/")&&(t=t.slice(0,-1)),t.startsWith("https://")?t=t.replace("https://","wss://"):t.startsWith("http://")&&(t=t.replace("http://","ws://")),!t.startsWith("ws://")&&!t.startsWith("wss://")?(f.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",t),t)}function Ps(e){const{gameStateRef:t,localPlayerIdRef:a,setGameState:r,setLocalPlayerId:n,setConnectionStatus:i,setGamesList:o,setLatestHighlight:s,setLatestNoTarget:d,setLatestDeckSelections:c,setLatestHandCardSelections:E,setClickWaves:w,setLatestFloatingTexts:A,setRemoteValidTargets:h,isManualExitRef:k,joiningGameIdRef:T,playerTokenRef:m,receivedServerStateRef:p,isJoinAttemptRef:S}=e,_=$.useRef(null),y=$.useRef(null),l=$.useCallback(()=>{if(ve()){i("Connected");return}if(k.current||_.current&&(_.current.readyState===WebSocket.OPEN||_.current.readyState===WebSocket.CONNECTING))return;const G=ks();if(!G){f.warn("No WebSocket URL configured in settings. Waiting for user input."),i("Disconnected"),y.current&&clearTimeout(y.current);return}try{_.current=new WebSocket(G)}catch(x){f.error("Failed to create WebSocket:",x),i("Disconnected"),y.current&&clearTimeout(y.current),y.current=window.setTimeout(l,ne.RECONNECT_DELAY);return}i("Connecting"),_.current.onopen=()=>{var M;p.current=!1,i("Connected");const x=localStorage.getItem("custom_ws_url");x&&x.trim()!==""&&localStorage.setItem("websocket_url",x.trim());const N=t.current;if(f.info("Current gameState on open:",N?`gameId=${N.gameId}`:"null"),f.info("playerTokenRef.current on open:",m.current?"YES":"NO"),N&&N.gameId&&((M=_.current)==null?void 0:M.readyState)===WebSocket.OPEN){let H=m.current;if(!H){try{const F=localStorage.getItem(st);if(F){const q=JSON.parse(F);f.info("RECONNECTION_DATA_KEY:",q==null?void 0:q.gameId,N.gameId),q!=null&&q.playerToken&&(H=q.playerToken,m.current=H,f.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(F){console.warn("Failed to parse reconnection data:",F instanceof Error?F.message:String(F))}if(!H&&N.players&&a.current){const F=N.players.find(q=>q.id===a.current);F!=null&&F.playerToken&&(H=F.playerToken,m.current=H)}}f.info("JoinGame: Sending reconnection with token:",H?"YES":"NO","gameId:",N.gameId),_.current.send(JSON.stringify({type:"JOIN_GAME",gameId:N.gameId,playerToken:H}))}},_.current.onmessage=x=>{try{const N=JSON.parse(x.data);if(N.type==="GAMES_LIST")o(N.games);else if(N.type==="JOIN_SUCCESS"){if(N.isSpectator){n(null),f.info("Joined as spectator:",N.message||"Spectator mode"),T.current=null;return}n(N.playerId);const M=T.current||t.current.gameId;M&&N.playerId!==null&&N.playerToken?(m.current=N.playerToken,localStorage.setItem(st,JSON.stringify({gameId:M,playerId:N.playerId,playerToken:N.playerToken,timestamp:Date.now()})),t.current.gameId===M&&Aa(t.current,N.playerId,N.playerToken)):N.playerId===null&&(mt(),m.current=void 0),T.current=null,N.playerId===1&&setTimeout(()=>{var H;((H=_.current)==null?void 0:H.readyState)===WebSocket.OPEN&&_.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ze}))},ne.DECK_SYNC_DELAY)}else if(N.type==="CONNECTION_ESTABLISHED"){f.info("Connection acknowledged by server");const M=sessionStorage.getItem("pending_invite_game"),H=sessionStorage.getItem("pending_invite_name");M&&_.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),f.info("Auto-joining invite game:",M),_.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:M,playerName:H||"Player"})))}else if(N.type==="DECK_DATA_UPDATED")f.info("Deck data synced with server");else if(N.type==="ERROR")if(N.message.includes("not found")||N.message.includes("Dummy")){f.info("Game not found error - clearing state");const M=ot();r(M),t.current=M,n(null),mt(),T.current=null}else if(N.message.includes("already started")&&S.current){f.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const M=ot();r(M),t.current=M,n(null),mt(),T.current=null,S.current=!1}else console.warn("Server Error:",N.message);else if(N.type==="HIGHLIGHT_TRIGGERED")s(N.highlightData);else if(N.type==="NO_TARGET_TRIGGERED")d({coords:N.coords,timestamp:N.timestamp});else if(N.type==="DECK_SELECTION_TRIGGERED")c(M=>[...M,N.deckSelectionData]),setTimeout(()=>{c(M=>M.filter(H=>H.timestamp!==N.deckSelectionData.timestamp))},1e3);else if(N.type==="HAND_CARD_SELECTION_TRIGGERED")E(M=>[...M,N.handCardSelectionData]),setTimeout(()=>{E(M=>M.filter(H=>H.timestamp!==N.handCardSelectionData.timestamp))},1e3);else if(N.type==="FLOATING_TEXT_TRIGGERED")r(M=>({...M,floatingTexts:[...M.floatingTexts,N.floatingTextData].filter(H=>Date.now()-H.timestamp<ne.FLOATING_TEXT_DURATION)}));else if(N.type==="FLOATING_TEXT_BATCH_TRIGGERED")r(M=>({...M,floatingTexts:[...M.floatingTexts,...N.batch].filter(H=>Date.now()-H.timestamp<ne.FLOATING_TEXT_DURATION)}));else if(N.type==="CLICK_WAVE_TRIGGERED")N.wave&&N.wave.clickedByPlayerId!==a.current&&(w(M=>[...M,N.wave]),setTimeout(()=>{w(M=>M.filter(H=>H.timestamp!==N.wave.timestamp))},600));else if(N.type==="TARGETING_MODE_SET"){const M=N.targetingMode;M&&(r(H=>({...H,targetingMode:M})),t.current.targetingMode=M,f.info("[TargetingMode] Received targeting mode from server",{playerId:M.playerId,mode:M.action.mode}))}else if(N.type==="TARGETING_MODE_CLEARED")r(M=>({...M,targetingMode:null})),t.current.targetingMode=null,f.debug("[TargetingMode] Cleared targeting mode from server");else if(N.type==="ABILITY_MODE_SET")N.abilityMode&&(r(M=>({...M,abilityMode:N.abilityMode})),f.info("[AbilityMode] Received ability mode from host",{playerId:N.abilityMode.playerId,mode:N.abilityMode.mode,sourceCard:N.abilityMode.sourceCardName}));else if(N.type==="ABILITY_TARGET_SELECTED")f.info("[Ability] Target selected",N.data);else if(N.type==="ABILITY_COMPLETED")r(M=>({...M,abilityMode:void 0})),f.info("[Ability] Ability completed",N.data);else if(N.type==="ABILITY_CANCELLED")r(M=>({...M,abilityMode:void 0})),f.info("[Ability] Ability cancelled");else if(N.type==="GAME_RESET")f.info("[GameReset] Received GAME_RESET message from server"),r(M=>{const H=N.activeGridSize||8,F=[];for(let Q=0;Q<H;Q++){const X=[];for(let de=0;de<H;de++)X.push({card:null});F.push(X)}const q={...M,players:N.players||[],gameMode:N.gameMode,isPrivate:N.isPrivate,activeGridSize:N.activeGridSize,dummyPlayerCount:N.dummyPlayerCount,autoAbilitiesEnabled:N.autoAbilitiesEnabled,isGameStarted:N.isGameStarted,currentPhase:N.currentPhase,currentRound:N.currentRound,turnNumber:N.turnNumber,activePlayerId:N.activePlayerId,startingPlayerId:N.startingPlayerId,roundWinners:N.roundWinners||{},gameWinner:N.gameWinner,isRoundEndModalOpen:N.isRoundEndModalOpen,isReadyCheckActive:N.isReadyCheckActive,board:F,targetingMode:null,floatingTexts:[]};return t.current=q,q});else if(!N.type&&N.players&&N.board){const M=Rt(N),H=t.current;if(!H.isScoringStep&&M.isScoringStep&&M.currentPhase!==2){f.debug("Ignoring delayed scoring state update");return}if(H.isScoringStep&&(M.currentPhase!==H.currentPhase||M.activePlayerId!==H.activePlayerId||M.currentPhase!==4)&&(M.isScoringStep=!1),r(M),t.current=M,a.current!==null&&M.gameId){let q;try{const Q=localStorage.getItem(st);Q&&(q=JSON.parse(Q).playerToken)}catch{}if(!q&&M.players){const Q=M.players.find(X=>X.id===a.current);Q!=null&&Q.playerToken&&(q=Q.playerToken,m.current=q)}Aa(M,a.current,q)}}else console.warn("Unknown message type:",N.type,"keys:",Object.keys(N),"data:",N)}catch(N){f.error("Failed to parse message from server:",x.data,N)}},_.current.onclose=()=>{i("Disconnected"),k.current||(y.current&&clearTimeout(y.current),y.current=window.setTimeout(l,ne.RECONNECT_DELAY))},_.current.onerror=x=>f.error("WebSocket error event:",x)},[r,i,o,s,d,c,E,w,A,h,n,ot,k,t,a,m,p,T]),u=$.useCallback(()=>{_.current&&(_.current.readyState===WebSocket.OPEN||_.current.readyState===WebSocket.CONNECTING)?_.current.close():l()},[_,l]),g=$.useCallback(G=>{var x;if(k.current=!1,((x=_.current)==null?void 0:x.readyState)===WebSocket.OPEN){T.current=G;let N=null;try{const H=localStorage.getItem(st);H&&(N=JSON.parse(H))}catch{mt()}const M={type:"JOIN_GAME",gameId:G};(N==null?void 0:N.gameId)===G&&N.playerToken?(M.playerToken=N.playerToken,f.info(`JoinGame: Sending reconnection with token ${N.playerToken.substring(0,8)}... for player ${N.playerId}`)):f.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${N==null?void 0:N.gameId}, requestedGameId=${G}`),_.current.send(JSON.stringify(M))}else l(),T.current=G},[_,k,T,l]),D=$.useCallback((G,x="Player")=>{var N;k.current=!1,((N=_.current)==null?void 0:N.readyState)===WebSocket.OPEN?_.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:G,playerName:x})):(sessionStorage.setItem("pending_invite_game",G),sessionStorage.setItem("pending_invite_name",x),l())},[l]),v=$.useCallback(()=>{k.current=!1,mt();const G=ja(),x={...ot(),gameId:G,players:[Va(1)]};return p.current=!0,setTimeout(()=>{var N;((N=_.current)==null?void 0:N.readyState)===WebSocket.OPEN&&(_.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:G})),_.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ze})))},ne.DECK_SYNC_DELAY),{gameId:G,initialState:x}},[k,p]),R=$.useCallback(()=>{var G;((G=_.current)==null?void 0:G.readyState)===WebSocket.OPEN&&_.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[_]),b=$.useCallback((G,x,N,M)=>{var q;if(G.current)return;k.current=!0;const H=t.current.gameId,F=a.current;H&&x.current&&N(H);try{M(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),f.info("[exitGame] Cleared WebRTC persistence data")}catch(Q){f.warn("[exitGame] Failed to clear WebRTC data:",Q)}r(ot()),n(null),mt(),_.current&&(_.current.onclose=null),((q=_.current)==null?void 0:q.readyState)===WebSocket.OPEN&&H&&F!==null&&_.current.send(JSON.stringify({type:"EXIT_GAME",gameId:H,playerId:F})),_.current&&_.current.close(),setTimeout(()=>{k.current=!1,l()},ne.RECONNECT_DELAY)},[t,a,k,r,n,_,l]);return{ws:_,reconnectTimeoutRef:y,connectWebSocket:l,forceReconnect:u,createGame:v,joinGame:g,joinAsInvite:D,exitGame:b,requestGamesList:R}}const Qe=new Map,Mi=(e={})=>{const{abilityMode:t,setAbilityMode:a}=e,[r,n]=$.useState(ot()),i=$.useRef(ot()),o=$.useCallback(I=>{n(ae=>{const ee=typeof I=="function"?I(ae):I;return i.current=ae,ve()&&j.current&&setTimeout(()=>{Y.current&&(Y.current.broadcastGameState(ee),f.debug(`[setGameStateWithDelta] Broadcast state: phase=${ee.currentPhase}, round=${ee.currentRound}`))},0),ee})},[]),[s,d]=$.useState(null),c=$.useRef(r),E=$.useRef(s),[w,A]=$.useState(null),[h,k]=$.useState("Connecting"),[T,m]=$.useState([]),[p,S]=$.useState(null),[_,y]=$.useState(null),[l,u]=$.useState(null),[g,D]=$.useState([]),[v,R]=$.useState([]),[b,G]=$.useState([]),[x,N]=$.useState(null),[M,H]=$.useState(!!ze),[F,q]=$.useState(!1),[Q,X]=$.useState(null),[de,Te]=$.useState(!1),j=$.useRef(!1),[Se,ke]=$.useState(!1),[Ce,Ne]=$.useState(null),Pe=$.useRef(!1),_e=$.useRef(null),Ke=$.useRef(!1),xt=$.useRef(!1),ut=$.useRef(),je=$.useRef(!1),Y=$.useRef(null),Oe=$.useRef(()=>{}),Ue=Rs({webrtcManagerRef:Y,webrtcIsHostRef:j,setWebrtcIsHost:Te,setConnectionStatus:k,setWebrtcHostId:X,gameStateRef:c,localPlayerIdRef:E}),{initializeWebrtcHost:Xe,connectAsGuest:tt,sendWebrtcAction:rt,requestDeckView:ur,sendFullDeckToHost:at}=Ue,ft=Ps({gameStateRef:c,localPlayerIdRef:E,setGameState:n,setLocalPlayerId:d,setConnectionStatus:k,setGamesList:m,setLatestHighlight:S,setLatestNoTarget:u,setLatestDeckSelections:D,setLatestHandCardSelections:R,setClickWaves:G,setLatestFloatingTexts:y,setRemoteValidTargets:N,isManualExitRef:Ke,joiningGameIdRef:_e,playerTokenRef:ut,receivedServerStateRef:je,isJoinAttemptRef:xt}),{ws:ge,reconnectTimeoutRef:pt,connectWebSocket:fr,forceReconnect:Ja,joinGame:pr,joinAsInvite:Xa,requestGamesList:Za}=ft;$.useEffect(()=>{Oe.current=o},[o]),$.useEffect(()=>{j.current=de},[de]),$.useEffect(()=>{const I=ve();if(q(I),I){Y.current=ss();const ae=Y.current.on(ee=>{sn(ee)});return()=>{ae()}}},[]),$.useEffect(()=>{if(!ve())return;const ae=window.location.hash.slice(1);if(ae&&new URLSearchParams(ae).get("hostId"))return;const ee="webrtc_auto_restore_attempted";if(sessionStorage.getItem(ee))return;sessionStorage.setItem(ee,"true");const te=Wo();if(te==="none"){sessionStorage.removeItem(ee);return}setTimeout(async()=>{var ie,oe;if(!Y.current){f.warn("[Auto-restore] WebRTC manager not ready");return}try{if(te==="host"){qe.current=!0,f.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ce=Ga(),J=wa();if(!ce||!J){f.warn("[Auto-restore] Missing host data or state data"),nt(),qe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}f.info(`[Auto-restore] Restoring host session: old peerId=${ce.peerId}`);const Ie=await Y.current.initializeAsHost();j.current=!0,Te(!0),X(Ie),k("Connected"),(ie=J.gameState)!=null&&ie.gameId&&(tr(Ie,J.gameState.gameId),f.info(`[Auto-restore] Broadcasted NEW host peerId ${Ie} for game ${J.gameState.gameId}`)),(J.gameState||J.localPlayerId!==null)&&(J.gameState&&(c.current=J.gameState),J.localPlayerId!==null&&(E.current=J.localPlayerId),Pe.current=!0,setTimeout(()=>{Pe.current=!1},1e4),setTimeout(()=>{var be;J.gameState&&(n(J.gameState),f.info(`[Auto-restore] Restored game state with ${((be=J.gameState.players)==null?void 0:be.length)||0} players, gameId=${J.gameState.gameId}`)),J.localPlayerId!==null&&(d(J.localPlayerId),f.info(`[Auto-restore] Restored local player ID: ${J.localPlayerId}`))},0)),setTimeout(()=>{if(qe.current=!1,f.info("[Auto-restore] Cleared restoration flag"),Y.current&&J.gameState){const be=J.gameState.players.filter(Ge=>!Ge.isDummy&&Ge.id!==J.localPlayerId);be.length>0&&(f.info(`[Auto-restore] Requesting deck data from ${be.length} guest players`),Y.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:Y.current.getPeerId(),timestamp:Date.now()}))}},500),f.info("[Auto-restore] Host session restoration initiated")}else if(te==="guest"){qe.current=!0,f.info("[Auto-restore] Setting restoration flag to prevent premature exit");const ce=xa(),J=wa();if(!ce||!J){f.warn("[Auto-restore] Missing guest data or state data"),nt(),qe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}f.info(`[Auto-restore] Restoring guest session: old hostPeerId=${ce.hostPeerId}, playerId=${ce.playerId}`),j.current=!1,Te(!1),k("Connecting");let Ie=ce.hostPeerId;if((oe=J.gameState)!=null&&oe.gameId){const be=Yt(J.gameState.gameId);be&&be.peerId&&(Ie=be.peerId,f.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Ie}`))}if(X(Ie),ce.playerId!==null){f.info(`[Auto-restore] Reconnecting as existing player ${ce.playerId} to host ${Ie}`);try{await Y.current.initializeAsReconnectingGuest(Ie,ce.playerId),k("Connected"),f.info("[Auto-restore] Successfully reconnected to host")}catch(be){f.error("[Auto-restore] Failed to reconnect to host:",be),k("Disconnected"),nt(),f.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),qe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else f.info("[Auto-restore] Connecting as new player"),await Y.current.initializeAsGuest(Ie),k("Connected");(J.gameState||J.localPlayerId!==null)&&(J.gameState&&(c.current=J.gameState),J.localPlayerId!==null&&(E.current=J.localPlayerId),Pe.current=!0,setTimeout(()=>{Pe.current=!1},1e4),setTimeout(()=>{var be,Ge;if(J.gameState&&(n(J.gameState),f.info(`[Auto-restore] Restored game state with ${((be=J.gameState.players)==null?void 0:be.length)||0} players, gameId=${J.gameState.gameId}, isGameStarted=${J.gameState.isGameStarted}`),J.localPlayerId!==null)){const ue=(Ge=J.gameState.players)==null?void 0:Ge.some(fe=>fe.id===J.localPlayerId);f.info(`[Auto-restore] Player ${J.localPlayerId} exists in restored state: ${ue}`)}J.localPlayerId!==null&&(d(J.localPlayerId),f.info(`[Auto-restore] Restored local player ID: ${J.localPlayerId}`))},0)),setTimeout(()=>{qe.current=!1,f.info("[Auto-restore] Cleared restoration flag")},100),f.info("[Auto-restore] Guest session restoration initiated")}}catch(ce){f.error("[Auto-restore] Failed to restore session:",ce),nt(),qe.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),$.useEffect(()=>{if(!F||!Y.current)return;const I=window.location.hash.slice(1);if(!I)return;const ee=new URLSearchParams(I).get("hostId");ee&&tt(ee)},[F]),$.useEffect(()=>{c.current=r},[r]),$.useEffect(()=>{E.current=s},[s]),$.useEffect(()=>{if(!r||!r.players||!s)return;const I=Uo(r.players,s);xo.preloadMany(I,"low")},[r==null?void 0:r.players,s]);const Qa=ms({ws:ge,webrtcManager:Y,gameStateRef:c,localPlayerIdRef:E,webrtcIsHostRef:j,setLatestHighlight:S,setLatestFloatingTexts:y,setLatestNoTarget:u,setLatestDeckSelections:D,setLatestHandCardSelections:R,setClickWaves:G,setGameState:n}),{triggerHighlight:en,triggerFloatingText:yr,triggerNoTarget:tn,triggerDeckSelection:rn,triggerHandCardSelection:an,syncValidTargets:nn,triggerClickWave:on}=Qa,qe=$.useRef(!1);$.useEffect(()=>{if(!F||!j.current||!(r!=null&&r.gameId))return;const I=r.gameId,ae=()=>{var ie;const te=(ie=Y.current)==null?void 0:ie.getPeerId();te&&I&&tr(te,I)};ae();const ee=setInterval(ae,2e3);return()=>clearInterval(ee)},[F,r==null?void 0:r.gameId]),$.useEffect(()=>{if(!F||j.current||!(r!=null&&r.gameId))return;const I=r.gameId,ae=ie=>{var oe;X(ie),k("Connecting"),(oe=Y.current)==null||oe.initializeAsReconnectingGuest(ie,E.current||0).then(()=>{k("Connected")}).catch(ce=>{f.error("[Guest Auto-Reconnect] Failed to reconnect:",ce),k("Disconnected")})},ee=ie=>{const oe=`webrtc_host_${I}`;if(!(ie.key!==oe||!ie.newValue))try{const J=JSON.parse(ie.newValue).peerId;J&&J!==Q&&ae(J)}catch(ce){f.error("[Guest Auto-Reconnect] Failed to parse storage event:",ce)}},te=setInterval(()=>{const ie=Yt(I);ie&&ie.peerId!==Q&&(f.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${ie.peerId}`),ae(ie.peerId))},2e3);return window.addEventListener("storage",ee),()=>{window.removeEventListener("storage",ee),clearInterval(te)}},[F,r==null?void 0:r.gameId,Q]),$.useEffect(()=>{const I=setInterval(()=>{n(ae=>{const ee=Date.now(),te=ae.floatingTexts||[],ie=te.filter(oe=>ee-oe.timestamp<ne.FLOATING_TEXT_DURATION);return ie.length!==te.length?{...ae,floatingTexts:ie}:ae})},ne.DECK_SYNC_DELAY);return()=>clearInterval(I)},[]);const sn=$.useCallback(I=>{var ae,ee,te;switch(I.type){case"peer_open":(ae=I.data)!=null&&ae.peerId&&(X(I.data.peerId),f.info(`WebRTC peer opened with ID: ${I.data.peerId}`));break;case"guest_connected":f.info("Guest connected via WebRTC:",(ee=I.data)==null?void 0:ee.peerId);break;case"connected_to_host":(te=I.data)!=null&&te.hostPeerId&&Q!==I.data.hostPeerId&&(X(I.data.hostPeerId),f.info(`Updated webrtcHostId to: ${I.data.hostPeerId}`)),k("Connected"),ke(!1),Ne(null),Pe.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(f.warn("WebRTC peer disconnected"),k("Disconnected"),ke(!0),!j.current&&Q&&r)try{const ie={hostPeerId:Q,playerId:s,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ie)),f.info("[Reconnection] Stored reconnection data before disconnect"),ln(Q)}catch(ie){f.error("[Reconnection] Failed to store data:",ie)}break;case"message_received":cn(I.data);break;case"error":f.error("WebRTC error:",I.data);break}},[r,s,Q,de]),dn=$.useCallback((I,ae)=>{if(f.info(`[handleWebrtcGuestJoin] Called for guest ${I}, isHost: ${j.current}`),!j.current||!Y.current){f.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const ee=(ae==null?void 0:ae.preferredDeck)||"Random";n(te=>{if(!te)return f.error("[handleWebrtcGuestJoin] No previous state"),te;f.info(`[handleWebrtcGuestJoin] Current state has ${te.players.length} players`);const ie=te.players.map(ue=>ue.id);let oe=1;for(;ie.includes(oe);)oe++;const ce={id:oe,name:`Player ${oe}`,color:Et[(oe-1)%Et.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:ee,boardHistory:[],autoDrawEnabled:!0},J={...te,players:[...te.players,ce]},Ie=te.board.map(ue=>ue.map(fe=>({...fe,card:fe.card?{id:fe.card.id,baseId:fe.card.baseId,ownerId:fe.card.ownerId,name:fe.card.name,imageUrl:fe.card.imageUrl,power:fe.card.power,ability:fe.card.ability,isFaceDown:fe.card.isFaceDown,statuses:fe.card.statuses||[]}:null}))),be=ue=>ue.map(fe=>({id:fe.id,baseId:fe.baseId,name:fe.name,imageUrl:fe.imageUrl,power:fe.power,powerModifier:fe.powerModifier,ability:fe.ability,ownerId:fe.ownerId,color:fe.color,deck:fe.deck,isFaceDown:fe.isFaceDown,types:fe.types,faction:fe.faction,statuses:fe.statuses}));Y.current.acceptGuestMinimal(I,{playerId:oe,gameId:te.gameId,isGameStarted:te.isGameStarted,players:J.players.map(ue=>ue.isDummy?{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,hand:be(ue.hand||[]),deck:be(ue.deck||[]),discard:be(ue.discard||[]),handSize:ue.hand.length,deckSize:ue.deck.length,discardSize:ue.discard.length}:{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,deckSize:ue.deck.length,handSize:ue.hand.length,discardSize:ue.discard.length}),deckSelections:J.players.map(ue=>({id:ue.id,selectedDeck:ue.selectedDeck})),gameMode:te.gameMode,currentRound:te.currentRound,currentPhase:te.currentPhase,activePlayerId:te.activePlayerId,startingPlayerId:te.startingPlayerId,activeGridSize:te.activeGridSize,board:Ie},oe),Y.current.broadcastGameState(J,I),Y.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:Y.current.getPeerId(),data:{playerId:oe,selectedDeck:ee},timestamp:Date.now()});const Ge=J.players.find(ue=>ue.id===E.current);if(Ge&&Ge.deck.length>0){const ue=Ge.deck.map(fe=>({id:fe.id,baseId:fe.baseId,power:fe.power,powerModifier:fe.powerModifier||0,isFaceDown:fe.isFaceDown||!1,statuses:fe.statuses||[]}));Y.current.sendToGuest(I,{type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:Ge.id,data:{playerId:Ge.id,deckType:Ge.selectedDeck,deck:ue,deckSize:ue.length},timestamp:Date.now()}),f.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${Ge.selectedDeck}, ${ue.length} cards`)}return J})},[]),Ut=$.useCallback(I=>{const ae=j.current;if(f.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!Y.current}, webrtcIsHostRef.current=${ae}`),!Y.current||!ae){f.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}Y.current.broadcastGameState(I)},[]),cn=$.useCallback(I=>{var ae,ee,te,ie,oe,ce,J,Ie,be,Ge,ue,fe,Ir,Er,Tr,wr,gr,_r,br,Ar,Sr,Cr,Dr,Rr,kr,Pr,Or,vr,Nr,Mr,Lr,Gr,xr,Ur,$r,Hr,Fr,Wr,Br,Yr,zr,Kr,qr,jr,Vr,Jr,Xr,Zr,Qr,ea,ta,ra,aa,na,oa,sa,ia,da,ca,la,ua,fa,pa,ya,ha,ma;if(!(!I||!I.type))switch(f.info(`[handleWebrtcMessage] Received: ${I.type}`),I.type){case"JOIN_ACCEPT_MINIMAL":if(f.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${I.playerId}`),I.data){const C=I.data;f.info(`[handleWebrtcMessage] Creating minimal state with ${((ae=C.players)==null?void 0:ae.length)||0} players`);const P={gameId:C.gameId||ja(),isGameStarted:C.isGameStarted||!1,isPrivate:!1,activeGridSize:C.activeGridSize||4,gameMode:C.gameMode||rr.FreeForAll,dummyPlayerCount:0,players:((ee=C.players)==null?void 0:ee.map(O=>{if((O.isDummy||!1)&&O.hand&&O.deck&&O.discard)return{id:O.id,name:O.name,color:O.color,isDummy:!0,isReady:O.isReady||!1,score:O.score||0,hand:O.hand||[],deck:O.deck||[],discard:O.discard||[],announcedCard:null,selectedDeck:O.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const B=[],U=[],z=[];for(let L=0;L<(O.handSize||0);L++)B.push({id:`placeholder_${O.id}_hand_${L}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});for(let L=0;L<(O.deckSize||0);L++)U.push({id:`placeholder_${O.id}_deck_${L}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});for(let L=0;L<(O.discardSize||0);L++)z.push({id:`placeholder_${O.id}_discard_${L}`,name:"?",isPlaceholder:!0,ownerId:O.id,deck:O.selectedDeck||"Random",color:O.color});return{id:O.id,name:O.name,color:O.color,isDummy:!1,isReady:O.isReady||!1,score:O.score||0,hand:B,deck:U,discard:z,announcedCard:null,selectedDeck:O.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:C.board||Ua(),hostId:1,currentPhase:C.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:C.currentRound||1,turnNumber:C.turnNumber||1,activePlayerId:C.activePlayerId??null,startingPlayerId:C.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};n(P),I.playerId!==void 0&&(d(I.playerId),f.info(`[handleWebrtcMessage] Set local player ID to ${I.playerId}`)),n(O=>{const W=O.players.map(B=>{var z;const U=(z=C.players)==null?void 0:z.find(L=>L.id===B.id);if(B.id===I.playerId){const K=B.deck.length===0||B.deck.some(V=>V.isPlaceholder)||B.deck.length!==30;if(U!=null&&U.selectedDeck&&K){const V=et(U.selectedDeck,B.id,B.name);f.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${V.length} cards from ${U.selectedDeck}`),Y.current&&V.length>0&&setTimeout(()=>{const le=V.map(Z=>({id:Z.id,baseId:Z.baseId,power:Z.power,powerModifier:Z.powerModifier||0,isFaceDown:Z.isFaceDown||!1,statuses:Z.statuses||[]}));Y.current.sendAction("DECK_DATA_UPDATE",{playerId:I.playerId,deck:le,deckSize:le.length}),f.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${U.selectedDeck}, ${le.length} cards`)},0);const re=[...B.hand],se=[...V];if(C.isGameStarted&&re.length===0&&se.length>0){for(let Z=0;Z<6&&Z<se.length;Z++){const me=se[0];se.splice(0,1),re.push(me)}f.info(`[JOIN_ACCEPT_MINIMAL] Drew ${re.length} cards, deck now has ${se.length} cards`)}return{...B,deck:se,hand:re,selectedDeck:U.selectedDeck}}}return B});return{...O,players:W}});try{const O=(te=Y.current)==null?void 0:te.getHostPeerId();O&&Bt({hostPeerId:O,playerId:I.playerId,playerName:((ie=P.players.find(W=>W.id===I.playerId))==null?void 0:ie.name)||null,isHost:!1})}catch(O){f.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",O)}}break;case"JOIN_ACCEPT":if(f.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${I.playerId}, hasState: ${!!((oe=I.data)!=null&&oe.gameState)}`),(ce=I.data)!=null&&ce.gameState){const C=I.data.gameState;if(f.info(`[handleWebrtcMessage] Setting game state with ${((J=C.players)==null?void 0:J.length)||0} players`),n(C),I.playerId!==void 0){d(I.playerId),f.info(`[handleWebrtcMessage] Set local player ID to ${I.playerId}`);try{const P=(Ie=Y.current)==null?void 0:Ie.getHostPeerId(),O=C.players.find(W=>W.id===I.playerId);P&&Bt({hostPeerId:P,playerId:I.playerId,playerName:(O==null?void 0:O.name)||null,isHost:!1})}catch(P){f.warn("[JOIN_ACCEPT] Failed to save guest data:",P)}}}break;case"JOIN_ACCEPT_BINARY":if(f.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${I.playerId}`),I.data instanceof Uint8Array)try{const C=Zo(I.data),P=C;if(f.info(`[handleWebrtcMessage] Expanded binary state with ${((be=P.players)==null?void 0:be.length)||0} players`),n(P),I.playerId!==void 0){d(I.playerId),f.info(`[handleWebrtcMessage] Set local player ID to ${I.playerId}`);try{const O=(Ge=Y.current)==null?void 0:Ge.getHostPeerId(),W=P.players.find(B=>B.id===I.playerId);O&&Bt({hostPeerId:O,playerId:I.playerId,playerName:(W==null?void 0:W.name)||null,isHost:!1})}catch(O){f.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",O)}}f.info(`[handleWebrtcMessage] Received optimized binary game state: ${I.data.byteLength} bytes`)}catch(C){f.error("[handleWebrtcMessage] Failed to deserialize binary game state:",C)}break;case"STATE_UPDATE_COMPACT":if(j.current){if(I.senderId&&I.senderId!==((ue=Y.current)==null?void 0:ue.getPeerId())&&(f.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${I.senderId}`),(fe=I.data)!=null&&fe.gameState)){const C=I.data.gameState;n(P=>{const O=I.playerId;if(O===void 0)return f.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),P;const W=P.players.map(z=>{if(z.id===O){const L=C.players.find(K=>K.id===O);if(L){const K=le=>{const Z=Be(le.baseId);return Z?{...Z,id:le.id,baseId:le.baseId,ownerId:O,power:le.power,powerModifier:le.powerModifier,isFaceDown:le.isFaceDown,statuses:le.statuses||[]}:{id:le.id,baseId:le.baseId,name:"Unknown",power:0}},V=(L.handCards||[]).map(K),re=(L.deckCards||[]).map(K),se=(L.discardCards||[]).map(K);return f.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${O}: hand=${V.length}, deck=${re.length}, discard=${se.length}, score=${L.score||0}`),{...z,hand:V,deck:re,discard:se,handSize:V.length,deckSize:re.length,discardSize:se.length,score:L.score||z.score}}}else{const L=C.players.find(V=>V.id===z.id);if(!L)return z;if(z.isDummy===!0&&(L.handCards&&L.handCards.length>0||L.deckCards&&L.deckCards.length>0||L.discardCards&&L.discardCards.length>0)){const V=Z=>{const me=Be(Z.baseId);return me?{...me,id:Z.id,baseId:Z.baseId,ownerId:z.id,power:Z.power,powerModifier:Z.powerModifier||0,isFaceDown:Z.isFaceDown||!1,statuses:Z.statuses||[]}:{id:Z.id,baseId:Z.baseId,name:"Unknown",power:0}},re=(L.handCards||[]).map(V),se=(L.deckCards||[]).map(V),le=(L.discardCards||[]).map(V);return f.info(`[STATE_UPDATE_COMPACT] Host: Guest ${O} modified dummy player ${z.id}: hand=${re.length}, deck=${se.length}, discard=${le.length}`),{...z,hand:re,deck:se,discard:le,handSize:re.length,deckSize:se.length,discardSize:le.length}}else if(L.handCards&&L.handCards.length>0&&z.hand){const V=L.handCards||[],re=z.hand.map(se=>{const le=V.find(Z=>Z.id===se.id);return le&&le.statuses?{...se,statuses:le.statuses,isFaceDown:le.isFaceDown}:se});return{...z,hand:re,handSize:re.length}}}return z}),B=C.board?C.board.map(z=>z.map(L=>{if(!L||!L.card)return L;const K=Be(L.card.baseId||L.card.id);if(K){const V=L.card.ownerId;return{...L,card:{...K,id:L.card.id,baseId:L.card.baseId||L.card.id,ownerId:V,ownerName:L.card.ownerName,power:L.card.power,powerModifier:L.card.powerModifier,isFaceDown:L.card.isFaceDown||!1,statuses:L.card.statuses||[],enteredThisTurn:L.card.enteredThisTurn,deck:L.card.deck}}}return L})):P.board,U={...P,...C,players:W,board:B};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(U,I.senderId)},0),U})}}else if(!j.current&&((Ir=I.data)!=null&&Ir.gameState)){const C=I.data.recipientPlayerId??null,P=I.data.gameState;if(Pe.current){n(O=>({...O,currentPhase:P.currentPhase,activePlayerId:P.activePlayerId,startingPlayerId:P.startingPlayerId,isReadyCheckActive:P.isReadyCheckActive,isGameStarted:P.isGameStarted}));return}n(O=>{const W=C===null||C===E.current;f.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${C}, local=${E.current}, isForLocal=${W}`);const B=P.players.map(L=>{var V,re;const K=O.players.find(se=>se.id===L.id);if(L.id===E.current&&K){const se=Z=>{if(Z.baseId){const Ae=Be(Z.baseId);if(Ae)return{...Ae,id:Z.id,ownerId:E.current,power:Z.power,powerModifier:Z.powerModifier,isFaceDown:Z.isFaceDown,statuses:Z.statuses||[]}}return K.hand.find(Ae=>Ae.id===Z.id)||K.deck.find(Ae=>Ae.id===Z.id)||K.discard.find(Ae=>Ae.id===Z.id)||{id:Z.id,name:"Unknown",power:0}};if(L.handCards&&L.handCards.length>0||L.deckCards&&L.deckCards.length>0||L.discardCards&&L.discardCards.length>0){const Z=(L.handCards||[]).map(se),me=(L.deckCards||[]).map(se),Ae=(L.discardCards||[]).map(se);return Z.forEach((ye,Me)=>{var we,Ee;(Ee=(we=L.handCards)==null?void 0:we[Me])!=null&&Ee.baseId&&!ye.baseId&&(ye.baseId=L.handCards[Me].baseId)}),me.forEach((ye,Me)=>{var we,Ee;(Ee=(we=L.deckCards)==null?void 0:we[Me])!=null&&Ee.baseId&&!ye.baseId&&(ye.baseId=L.deckCards[Me].baseId)}),Ae.forEach((ye,Me)=>{var we,Ee;(Ee=(we=L.discardCards)==null?void 0:we[Me])!=null&&Ee.baseId&&!ye.baseId&&(ye.baseId=L.discardCards[Me].baseId)}),f.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${Z.length} hand, ${me.length} deck, ${Ae.length} discard`),{...L,hand:Z,deck:me,discard:Ae}}else{const Z=(L.handIds||[]).map(ye=>K.hand.find(we=>we.id===ye)||K.deck.find(we=>we.id===ye)||K.discard.find(we=>we.id===ye)||{id:ye,name:"?",isPlaceholder:!1}),me=(L.deckIds||[]).map(ye=>K.deck.find(we=>we.id===ye)||K.hand.find(we=>we.id===ye)||K.discard.find(we=>we.id===ye)||{id:ye,name:"?",isPlaceholder:!1}),Ae=(L.discardIds||[]).map(ye=>K.discard.find(we=>we.id===ye)||K.hand.find(we=>we.id===ye)||K.deck.find(we=>we.id===ye)||{id:ye,name:"?",isPlaceholder:!1});return f.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${Z.length} hand, ${me.length} deck, ${Ae.length} discard`),{...L,hand:Z,deck:me,discard:Ae}}}else{const se=L.deckSize??((V=L.deck)==null?void 0:V.length)??0,le=L.handSize??((re=L.hand)==null?void 0:re.length)??0,Z=L.deckCards&&L.deckCards.length>0;let me;if(Z){const Ee=pe=>{if(pe.baseId){const Fe=Be(pe.baseId);if(Fe)return{...Fe,id:pe.id,baseId:pe.baseId,ownerId:L.id,power:pe.power,powerModifier:pe.powerModifier,isFaceDown:pe.isFaceDown,statuses:pe.statuses||[]}}return{id:pe.id,name:"Unknown",power:0}};if(me=L.deckCards.map(Ee),L.id===3){const pe={};me.forEach(Fe=>{const Ia=Fe.baseId||Fe.id;pe[Ia]=(pe[Ia]||0)+1}),f.info(`[STATE_UPDATE_COMPACT] Reconstructed deck for Player 3 (dummy): ${me.length} cards`,pe)}f.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${L.id}: ${me.length} cards`)}else if(K&&K.deck.length>0&&K.deck.some(pe=>!pe.isPlaceholder)){const pe=K.deck.length;me=K.deck.slice(0,se),L.id===3&&f.info(`[STATE_UPDATE_COMPACT] Player 3 deck slice: before=${pe}, remoteDeckSize=${se}, after=${me.length}`),f.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${L.id}: ${me.length} cards`)}else{me=[];for(let pe=0;pe<se;pe++)me.push({id:`placeholder_${L.id}_deck_${pe}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color})}const Ae=(Ee,pe)=>{if(Ee.baseId&&!Ee.isPlaceholder&&!Ee.isCardBack){const Fe=Be(Ee.baseId);if(Fe)return{...Fe,id:Ee.id,baseId:Ee.baseId,ownerId:L.id,power:Ee.power,powerModifier:Ee.powerModifier||0,isFaceDown:Ee.isFaceDown||!1,statuses:Ee.statuses||[]}}return{id:Ee.id||`placeholder_${L.id}_hand_${pe}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color}};let ye;const Me=L.handCards&&L.handCards.length>0,we=L.hand&&L.hand.length>0;if(Me)ye=L.handCards.map(pe=>{const Fe=Be(pe.baseId);return Fe?{...Fe,id:pe.id,baseId:pe.baseId,ownerId:L.id,power:pe.power,powerModifier:pe.powerModifier||0,isFaceDown:pe.isFaceDown||!1,statuses:pe.statuses||[]}:{id:pe.id,baseId:pe.baseId,name:"Unknown",power:pe.power||0,ownerId:L.id,isPlaceholder:!1}}),f.info(`[STATE_UPDATE_COMPACT] Reconstructed ${ye.length} hand cards from handCards for player ${L.id}`);else if(we){ye=L.hand.map((pe,Fe)=>Ae(pe,Fe));const Ee=ye.filter(pe=>!pe.isPlaceholder).length;Ee>0&&f.info(`[STATE_UPDATE_COMPACT] Reconstructed ${Ee}/${ye.length} revealed hand cards for player ${L.id}`)}else{ye=[];for(let Ee=0;Ee<le;Ee++)ye.push({id:`placeholder_${L.id}_hand_${Ee}`,name:"?",isPlaceholder:!0,ownerId:L.id,deck:L.selectedDeck||"Random",color:L.color})}return{...L,hand:ye,deck:me,discard:(K==null?void 0:K.discard)||[]}}}),U=P.board?P.board.map(L=>L.map(K=>{if(!K||!K.card)return K;const V=Be(K.card.baseId||K.card.id);return V?{...K,card:{...V,id:K.card.id,baseId:K.card.baseId||K.card.id,ownerId:K.card.ownerId,ownerName:K.card.ownerName,power:K.card.power,powerModifier:K.card.powerModifier,isFaceDown:K.card.isFaceDown||!1,statuses:K.card.statuses||[],enteredThisTurn:K.card.enteredThisTurn,deck:K.card.deck}}:K})):O.board,z=Le({...P,players:B,board:U});return{...P,players:B,board:z}})}break;case"STATE_UPDATE":if(j.current&&I.senderId&&I.senderId!==((Er=Y.current)==null?void 0:Er.getPeerId())){if(f.info(`[STATE_UPDATE] Host received state from guest ${I.senderId}`),(Tr=I.data)!=null&&Tr.gameState){const C=I.data.gameState;n(P=>{const O=I.playerId;if(O===void 0)return f.warn("[STATE_UPDATE] Guest state missing playerId"),P;const W=P.players.map(z=>{if(z.id===O){const L=C.players.find(K=>K.id===O);if(L){const K=Z=>({...Z,ownerId:O}),V=(L.hand||[]).map(K),re=(L.deck||[]).map(K),se=(L.discard||[]).map(K);f.info(`[STATE_UPDATE] Merging guest ${O} state: hand=${V.length}, deck=${re.length}, discard=${se.length}`);const le={...z,hand:V,deck:re,discard:se,handSize:V.length,deckSize:re.length,discardSize:se.length};return f.info(`[STATE_UPDATE] After merge - player ${O}: deckSize=${le.deckSize}, handSize=${le.handSize}`),le}}return z}),B=C.board?C.board.map(z=>z.map(L=>!L||!L.card?L:{...L,card:{...L.card,ownerId:L.card.ownerId}})):P.board,U={...P,players:W,board:B};return Y.current&&setTimeout(()=>{Y.current.broadcastGameState(U,I.senderId)},0),U})}break}if(je.current=!0,(wr=I.data)!=null&&wr.gameState){const C=I.data.gameState;if(Pe.current){n(P=>({...P,currentPhase:C.currentPhase,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,isReadyCheckActive:C.isReadyCheckActive,isGameStarted:C.isGameStarted}));return}n(P=>{var B;const O=C.players.map(U=>{var L,K,V;const z=P.players.find(re=>re.id===U.id);if(U.id===E.current&&z){const re=z.hand.every(le=>le.isPlaceholder)||z.hand.length===0,se=U.handSize??((L=U.hand)==null?void 0:L.length)??0;if(re&&U.hand&&U.hand.length>0)return{...U,hand:U.hand,deck:U.deck||z.deck,discard:U.discard||z.discard};{let le=z.hand,Z=z.deck;if(se>z.hand.length&&Z.length>0){const me=se-z.hand.length,Ae=[...z.hand],ye=[...z.deck];for(let Me=0;Me<me&&Me<ye.length;Me++){const we=ye[0];ye.splice(0,1),Ae.push(we)}le=Ae,Z=ye}return{...U,hand:le,deck:Z,discard:U.discard||z.discard}}}else{if(U.isDummy||!1)return f.info(`[STATE_UPDATE] Using real cards for dummy player ${U.id}`),{...U,hand:U.hand||[],deck:U.deck||[],discard:U.discard||[]};const se=U.deckSize??((K=U.deck)==null?void 0:K.length)??0,le=U.handSize??((V=U.hand)==null?void 0:V.length)??0;f.info(`[STATE_UPDATE] Player ${U.id}: deckSize=${se}, handSize=${le}`);const Z=[];for(let Ae=0;Ae<se;Ae++)Z.push({id:`placeholder_${U.id}_deck_${Ae}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});const me=[];for(let Ae=0;Ae<le;Ae++)me.push({id:`placeholder_${U.id}_hand_${Ae}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});return f.info(`[STATE_UPDATE] Created ${Z.length} deck placeholders and ${me.length} hand placeholders for player ${U.id}`),{...U,hand:me,deck:Z,discard:U.discard||[]}}}),W={...C,players:O};if(!j.current)try{((B=Y.current)==null?void 0:B.getHostPeerId())&&E.current!==null&&(Tt({gameState:W,localPlayerId:E.current,isHost:!1}),f.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(U){f.warn("[STATE_UPDATE] Failed to persist guest state:",U)}return W})}break;case"RECONNECT_SNAPSHOT":if(je.current=!0,I.data){const C=I.data;n(P=>{const O=E.current,W=C.players.map(U=>{const z=P.players.find(re=>re.id===U.id);if(U.id===O&&z&&z.hand.some(se=>!se.isPlaceholder)){let se=[...z.hand];const le=[...z.deck];if(U.handSize>se.length){const Z=U.handSize-se.length;for(let me=0;me<Z&&le.length>0;me++)se.push(le.shift())}else U.handSize<se.length&&(se=se.slice(0,U.handSize));return{...U,hand:se,deck:le,discard:z.discard}}const L=[];for(let re=0;re<U.handSize;re++)L.push({id:`placeholder_${U.id}_hand_${re}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});const K=[];for(let re=0;re<U.deckSize;re++)K.push({id:`placeholder_${U.id}_deck_${re}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});const V=[];for(let re=0;re<U.discardSize;re++)V.push({id:`placeholder_${U.id}_discard_${re}`,name:"?",isPlaceholder:!0,ownerId:U.id,deck:U.selectedDeck||"Random",color:U.color});return{...U,hand:L,deck:K,discard:V}}),B={gameId:C.gameId,gameMode:C.gameMode,isPrivate:C.isPrivate,isGameStarted:C.isGameStarted,isReadyCheckActive:C.isReadyCheckActive,activeGridSize:C.activeGridSize,currentPhase:C.currentPhase,isScoringStep:C.isScoringStep,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,currentRound:C.currentRound,turnNumber:C.turnNumber,roundWinners:C.roundWinners||{},gameWinner:C.gameWinner,isRoundEndModalOpen:C.isRoundEndModalOpen,dummyPlayerCount:C.dummyPlayerCount,players:W,board:C.board,spectators:P.spectators,hostId:P.hostId,revealRequests:P.revealRequests,preserveDeployAbilities:P.preserveDeployAbilities,highlights:P.highlights,floatingTexts:P.floatingTexts,targetingMode:P.targetingMode,abilityMode:P.abilityMode};if(!j.current&&O!==null)try{Tt({gameState:B,localPlayerId:O,isHost:!1}),f.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(U){f.warn("[RECONNECT_SNAPSHOT] Failed to save state:",U)}return f.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${B.currentPhase}, players=${B.players.length}`),B})}break;case"STATE_DELTA":if(j.current||(je.current=!0),f.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${j.current}, senderId: ${I.senderId}`),(gr=I.data)!=null&&gr.delta){const C=I.data.delta;f.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((_r=C.boardCells)==null?void 0:_r.length)||0}, phaseDelta=${!!C.phaseDelta}`),C.boardCells&&C.boardCells.length>0&&C.boardCells.forEach(P=>{var O,W;f.info(`[STATE_DELTA] Board cell [${P.row},${P.col}]: card=${((O=P.card)==null?void 0:O.name)||"(empty)"}, owner=${(W=P.card)==null?void 0:W.ownerId}`)}),j.current&&I.senderId&&Y.current&&(f.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${I.senderId} to other guests`),Y.current.broadcastStateDelta(C,I.senderId)),C.phaseDelta&&f.info("[STATE_DELTA] phaseDelta:",JSON.stringify(C.phaseDelta)),C.playerDeltas&&Object.entries(C.playerDeltas).forEach(([P,O])=>{f.info(`[STATE_DELTA] Player ${P} delta: handSizeDelta=${O.handSizeDelta}, deckSizeDelta=${O.deckSizeDelta}`)}),n(P=>{const O=E.current||P.localPlayerId;f.info(`[STATE_DELTA] Applying delta with localPlayerId=${O}, currentPhase before=${P.currentPhase}`);const W=Jt(P);f.info(`[STATE_DELTA] Applying delta with localPlayerId=${O}, currentPhase after=${W.currentPhase}`);try{W.gameId&&O!==null&&(Tt({gameState:W,localPlayerId:O,isHost:j.current}),f.debug(`[STATE_DELTA] Saved state for ${j.current?"host":"guest"} auto-restore`))}catch(B){f.warn("[STATE_DELTA] Failed to persist state:",B)}return W})}break;case"STATE_DELTA_BINARY":{j.current||(je.current=!0),f.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${j.current}, senderId: ${I.senderId}, dataType=${(Ar=(br=I.data)==null?void 0:br.constructor)==null?void 0:Ar.name}, typeof=${typeof I.data}`);let C=null;if(I.data instanceof Uint8Array)try{C=Ya(I.data),C&&f.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Sr=C.boardCells)==null?void 0:Sr.length)||0}`)}catch(P){f.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",P)}else if(typeof I.data=="string")try{C=es(I.data),C&&f.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${I.data.length} chars): playerDeltas=${Object.keys(C.playerDeltas||{}).length}, boardCells=${((Cr=C.boardCells)==null?void 0:Cr.length)||0}, phaseDelta=${!!C.phaseDelta}`)}catch(P){f.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",P)}else f.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof I.data}, constructor: ${(Rr=(Dr=I.data)==null?void 0:Dr.constructor)==null?void 0:Rr.name}`);C&&(j.current&&I.senderId&&Y.current&&(f.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${I.senderId} to other guests`),Y.current.broadcastStateDelta(C,I.senderId)),n(P=>{const O=E.current||P.localPlayerId;f.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${O}, currentPhase before=${P.currentPhase}`);const W=Jt(P);f.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${W.currentPhase}, board has ${W.board.flat().filter(B=>B==null?void 0:B.card).length} cards`);try{W.gameId&&O!==null&&(Tt({gameState:W,localPlayerId:O,isHost:j.current}),f.debug(`[STATE_DELTA_BINARY] Saved state for ${j.current?"host":"guest"} auto-restore`))}catch(B){f.warn("[STATE_DELTA_BINARY] Failed to persist state:",B)}return W}));break}case"CARD_STATE":if(typeof I.data=="string")try{const C=atob(I.data),P=new Uint8Array(C.length);for(let O=0;O<C.length;O++)P[O]=C.charCodeAt(O);n(O=>ht(2,P,O,E.current||O.localPlayerId).gameState)}catch(C){f.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",C)}else I.data instanceof Uint8Array&&n(C=>ht(2,I.data,C,E.current||C.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof I.data=="string")try{const C=atob(I.data),P=new Uint8Array(C.length);for(let O=0;O<C.length;O++)P[O]=C.charCodeAt(O);n(O=>{const{gameState:W}=ht(3,P,O,E.current||O.localPlayerId);return W})}catch(C){f.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",C)}else I.data instanceof Uint8Array&&n(C=>{const{gameState:P}=ht(3,I.data,C,E.current||C.localPlayerId);return P});break;case"SESSION_EVENT":if(typeof I.data=="string")try{const C=atob(I.data),P=new Uint8Array(C.length);for(let O=0;O<C.length;O++)P[O]=C.charCodeAt(O);n(O=>ht(4,P,O,E.current||O.localPlayerId).gameState)}catch(C){f.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",C)}else I.data instanceof Uint8Array&&n(C=>ht(4,I.data,C,E.current||C.localPlayerId).gameState);break;case"JOIN_REQUEST":f.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${I.senderId}, isHost: ${j.current}`),j.current&&I.senderId?(f.info(`Host received JOIN_REQUEST from ${I.senderId}, data:`,I.data),dn(I.senderId,I.data)):f.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${j.current}, senderId: ${I.senderId}`);break;case"ACTION":if(j.current&&I.data){const{actionType:C,actionData:P}=I.data;if(C==="STATE_UPDATE"&&(P!=null&&P.gameState)){if(Pe.current){Y.current&&I.senderId&&Y.current.sendToGuest(I.senderId,{type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:c.current},timestamp:Date.now()});break}n(O=>{const W=P.gameState,B=W.players.map(z=>{const L=O.players.find(K=>K.id===z.id);return L&&z.id!==E.current?{...z,deck:L.deck||z.deck,discard:L.discard||z.discard,score:L.score}:z}),U={...W,players:B};return Y.current&&Y.current.broadcastToGuests({type:"STATE_UPDATE",senderId:Y.current.getPeerId(),data:{gameState:U},timestamp:Date.now()}),U})}else if(C==="STATE_DELTA"&&(P!=null&&P.delta))n(O=>{const W=P.delta;let B=W;Pe.current&&W.playerDeltas&&(B={...W,playerDeltas:Object.fromEntries(Object.entries(W.playerDeltas).map(([z,L])=>{const K={...L};return delete K.scoreDelta,[z,K]}))}),E.current||O.localPlayerId;const U=Jt(O);return Y.current&&Y.current.broadcastStateDelta(B),U});else if(C==="NEXT_PHASE")n(O=>{const W=O,B=W.currentPhase,U=B===2&&!W.isScoringStep,z=B+1;return{...W,currentPhase:z,...U&&{isScoringStep:!0}}});else if(C==="PREV_PHASE")n(O=>{const W=O;return W.isScoringStep?{...W,isScoringStep:!1,currentPhase:Math.max(1,W.currentPhase-1)}:{...W,currentPhase:Math.max(1,W.currentPhase-1)}});else if(C==="SET_PHASE"&&(P==null?void 0:P.phaseIndex)!==void 0)n(O=>({...O,currentPhase:P.phaseIndex}));else if(C==="UPDATE_PLAYER_NAME"&&(P==null?void 0:P.playerId)!==void 0&&(P==null?void 0:P.name)!==void 0)n(O=>({...O,players:O.players.map(W=>W.id===P.playerId?{...W,name:P.name}:W)}));else if(C==="CHANGE_PLAYER_COLOR"&&(P==null?void 0:P.playerId)!==void 0&&(P==null?void 0:P.color)!==void 0){const O=P.playerId,W=P.color;n(B=>{const U={...B,players:B.players.map(z=>z.id===O?{...z,color:W}:z)};return Y.current&&Y.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:Y.current.getPeerId(),data:{playerId:O,color:W},timestamp:Date.now()}),U})}else if(C==="UPDATE_PLAYER_SCORE"&&(P==null?void 0:P.playerId)!==void 0&&(P==null?void 0:P.delta)!==void 0){const O=P.playerId,W=P.delta;n(B=>{const U={...B,players:B.players.map(z=>z.id===O?{...z,score:Math.max(0,z.score+W)}:z)};return Y.current&&Y.current.broadcastToGuests({type:"UPDATE_PLAYER_SCORE",senderId:Y.current.getPeerId(),data:{playerId:O,delta:W},timestamp:Date.now()}),U})}else if(C==="CHANGE_PLAYER_DECK"&&(P==null?void 0:P.playerId)!==void 0){const O=P.playerId,W=P.deckType,B=P.deck;n(U=>{const z=U.players.find(V=>V.id===O);if(!z)return U;let L;B&&B.length>0?(f.info(`[CHANGE_PLAYER_DECK] Host received ${B.length} cards for player ${O}`),L=B.map(V=>{if(V.baseId){const re=Be(V.baseId);if(re)return{...re,id:V.id,baseId:V.baseId,deck:W,ownerId:O,ownerName:z.name,power:V.power,powerModifier:V.powerModifier||0,isFaceDown:V.isFaceDown||!1,statuses:V.statuses||[]}}return{id:V.id,baseId:V.id,name:"Unknown",deck:W,ownerId:O,ownerName:z.name,power:V.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(L=et(W,O,z.name),f.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${O} with ${L.length} cards from ${W}`));const K={...U,players:U.players.map(V=>V.id===O?{...V,selectedDeck:W,deck:L,hand:[],discard:[],announcedCard:null,boardHistory:[]}:V)};if(Y.current){const V=L.map(re=>({id:re.id,baseId:re.baseId,power:re.power,powerModifier:re.powerModifier||0,isFaceDown:re.isFaceDown||!1,statuses:re.statuses||[]}));Y.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:Y.current.getPeerId(),playerId:O,data:{playerId:O,deckType:W,deck:V,deckSize:V.length},timestamp:Date.now()})}return K})}else if(C==="TOGGLE_ACTIVE_PLAYER"&&(P==null?void 0:P.playerId)!==void 0)n(O=>{if(!O.players.find(U=>U.id===P.playerId))return O;const B=Ka(O,P.playerId);return Y.current&&Y.current.broadcastGameState(B),B});else if(C==="TOGGLE_AUTO_DRAW"&&(P==null?void 0:P.playerId)!==void 0)n(O=>({...O,players:O.players.map(W=>W.id===P.playerId?{...W,autoDrawEnabled:!W.autoDrawEnabled}:W)}));else if(C==="START_NEXT_ROUND")n(O=>({...O,isRoundEndModalOpen:!1,currentRound:(O.currentRound||1)+1,players:O.players.map(W=>({...W,score:0}))}));else if(C==="RESET_DEPLOY_STATUS")n(O=>{const W=O.board.map(B=>B.map(U=>{var z;return(z=U.card)!=null&&z.statuses?{...U,card:{...U.card,statuses:U.card.statuses.filter(L=>L.type!=="DeployAbilityUsed")}}:U}));return{...O,board:W,preserveDeployAbilities:!1}});else if(C==="DECK_DATA_UPDATE"&&(P==null?void 0:P.playerId)!==void 0&&(P!=null&&P.deck)){const O=P.playerId,W=P.deck,B=P.deckSize;f.info(`[ACTION] DECK_DATA_UPDATE: Received ${W.length} cards for guest ${O}`),n(U=>({...U,players:U.players.map(z=>z.id===O?{...z,deck:[...W],deckSize:B||W.length}:z)}))}else f.warn(`[ACTION] Unknown action type: ${C}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(f.info(`[PLAYER_RECONNECT] Guest ${I.playerId} reconnecting from ${I.senderId}`),j.current&&I.playerId!==void 0&&I.senderId){const C=c.current;if(f.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(C!=null&&C.gameId)}, gameId=${C==null?void 0:C.gameId}, hasPlayers=${((kr=C==null?void 0:C.players)==null?void 0:kr.length)||0}`),C&&C.gameId){f.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${I.playerId}`);const P=ls(C,I.playerId);(Pr=Y.current)==null||Pr.sendToGuest(I.senderId,{type:"RECONNECT_SNAPSHOT",senderId:Y.current.getPeerId(),data:P.data,timestamp:Date.now()}),f.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${I.playerId}`)}else f.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((Or=I.data)==null?void 0:Or.isReadyCheckActive)!==void 0||((vr=I.data)==null?void 0:vr.isPrivate)!==void 0)&&n(C=>({...C,isReadyCheckActive:I.data.isReadyCheckActive??!0,isPrivate:I.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((Nr=I.data)==null?void 0:Nr.isReadyCheckActive)!==void 0&&n(C=>({...C,isReadyCheckActive:I.data.isReadyCheckActive}));break;case"PLAYER_READY":j.current&&I.playerId!==void 0?n(C=>{const P=C.players.map(U=>U.id===I.playerId?{...U,isReady:!0}:U),O={...C,players:P};f.info(`Player ${I.playerId} is ready via WebRTC`),Y.current&&(Y.current.broadcastGameState(O),f.info(`[PLAYER_READY] Broadcasted ready status for player ${I.playerId}`));const W=O.players.filter(U=>!U.isDummy&&!U.isDisconnected);if(W.length>0&&W.every(U=>U.isReady)&&!O.isGameStarted){const U=O.players.filter(V=>!V.isDisconnected),z=Math.floor(Math.random()*U.length),L=U[z].id;let K={...O};return K.isReadyCheckActive=!1,K.isGameStarted=!0,K.startingPlayerId=L,K.activePlayerId=L,K.currentPhase=0,K.players=K.players.map(V=>{if(V.hand.length===0&&V.deck.length>0){const se=[...V.hand],le=[...V.deck];for(let Z=0;Z<6&&Z<le.length;Z++){const me=le[0];le.splice(0,1),se.push(me)}return f.info(`[PLAYER_READY] Drew ${se.length} cards for player ${V.id}`),{...V,hand:se,deck:le}}return V}),K=dr(K,L),f.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${K.currentPhase}`),Y.current&&(Y.current.broadcastToGuests({type:"GAME_START",senderId:Y.current.getPeerId(),data:{startingPlayerId:L,activePlayerId:L,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var V,re;f.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(V=K.players[0])==null?void 0:V.deck.length}, hand=${(re=K.players[0])==null?void 0:re.hand.length}`),f.info(`[PLAYER_READY] Broadcasting state with currentPhase=${K.currentPhase}`),Ut(K)},100)),K}return O}):j.current;break;case"ASSIGN_TEAMS":(Mr=I.data)!=null&&Mr.assignments&&n(C=>{const P=C.players.map(O=>{let W=O.teamId||1;for(const[B,U]of Object.entries(I.data.assignments))if(U.includes(O.id)){W=parseInt(B);break}return{...O,teamId:W}});return{...C,players:P}});break;case"SET_GAME_MODE":((Lr=I.data)==null?void 0:Lr.mode)!==void 0&&n(C=>({...C,gameMode:I.data.mode}));break;case"SET_GAME_PRIVACY":((Gr=I.data)==null?void 0:Gr.isPrivate)!==void 0&&n(C=>({...C,isPrivate:I.data.isPrivate}));break;case"SET_GRID_SIZE":((xr=I.data)==null?void 0:xr.size)!==void 0&&n(C=>{const P=I.data.size,O=[];for(let W=0;W<P;W++){const B=[];for(let U=0;U<P;U++)B.push({card:null});O.push(B)}return{...C,activeGridSize:P,board:O}});break;case"SET_DUMMY_PLAYER_COUNT":((Ur=I.data)==null?void 0:Ur.count)!==void 0&&n(C=>({...C,dummyPlayerCount:I.data.count}));break;case"HOST_READY":I.playerId!==void 0&&(f.info(`[handleWebrtcMessage] Host (player ${I.playerId}) is ready`),n(C=>{const P=C.players.map(O=>O.id===I.playerId?{...O,isReady:!0}:O);return{...C,players:P}}));break;case"GAME_START":je.current=!0,f.info("[handleWebrtcMessage] Game starting!",I.data),c.current&&(f.info(`[GAME_START] Current phase before: ${c.current.currentPhase}`),c.current.players.forEach(C=>{f.info(`[GAME_START] Before: Player ${C.id} - deck: ${C.deck.length}, hand: ${C.hand.length}`)})),I.data&&n(C=>{f.info(`[GAME_START] Processing for localPlayerId=${E.current}`),C.players.forEach(B=>{f.info(`[GAME_START] Player ${B.id} before: deck=${B.deck.length}, hand=${B.hand.length}`)});const P=I.data.startingPlayerId??I.data.activePlayerId,O={...C,isGameStarted:I.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:P,activePlayerId:I.data.activePlayerId,currentPhase:C.currentPhase},W=O.players.find(B=>B.id===E.current);if(W&&W.hand.length===0&&W.deck.length>0){const U=[...W.hand],z=[...W.deck];for(let L=0;L<6&&L<z.length;L++){const K=z[0];z.splice(0,1),U.push(K)}O.players=O.players.map(L=>L.id===E.current?{...L,hand:U,deck:z}:L),f.info(`[GAME_START] Drew ${U.length} cards for local player ${E.current}, deck now has ${z.length} cards`)}return O.players.forEach(B=>{f.info(`[GAME_START] Player ${B.id} after: deck=${B.deck.length}, hand=${B.hand.length}`)}),f.info(`[GAME_START] Final state: currentPhase=${O.currentPhase}, activePlayerId=${O.activePlayerId}, startingPlayerId=${O.startingPlayerId}`),O});break;case"ACTIVE_PLAYER_CHANGED":f.info("[handleWebrtcMessage] Active player changed!",I.data),I.data&&n(C=>{const P={...C,activePlayerId:I.data.activePlayerId};if(I.data.currentPhase!==void 0&&(P.currentPhase=I.data.currentPhase),I.data.turnNumber!==void 0&&(P.turnNumber=I.data.turnNumber),P.currentPhase===0&&P.activePlayerId===E.current){const O=P.players.find(W=>W.id===E.current);if(O&&O.deck.length>0){const W=O.deck[0],B=[...O.deck.slice(1)],U=[...O.hand,W];P.players=P.players.map(z=>z.id===E.current?{...z,deck:B,hand:U}:z)}P.currentPhase=1,er(P,P.activePlayerId)}return P.activePlayerId&&P.activePlayerId!==C.activePlayerId&&er(P,P.activePlayerId),P});break;case"SYNC_DECK_SELECTIONS":f.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",I.data),I.data&&n(C=>I.data.playerId!==void 0&&I.data.selectedDeck!==void 0?I.data.playerId===E.current?(f.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${I.data.playerId}`),C):{...C,players:C.players.map(P=>P.id===I.data.playerId?{...P,selectedDeck:I.data.selectedDeck}:P)}:I.data.deckSelections&&Array.isArray(I.data.deckSelections)?{...C,players:C.players.map(P=>{if(P.id===E.current)return P;const O=I.data.deckSelections.find(W=>W.id===P.id);return O?{...P,selectedDeck:O.selectedDeck}:P})}:C);break;case"CHANGE_PLAYER_DECK":if(f.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",I.data),!I.data||I.data.playerId===void 0)break;{const C=I.data.playerId,P=I.data.deckType,O=I.data.deck;n(W=>{const B=W.players.find(L=>L.id===C);if(!B)return W;const U=j.current;let z;if(O&&O.length>0)if(z=O.map(L=>{if(L.baseId){const K=Be(L.baseId);return K?{...K,id:L.id,baseId:L.baseId,deck:P,ownerId:C,ownerName:B.name,power:L.power,powerModifier:L.powerModifier||0,isFaceDown:L.isFaceDown||!1,statuses:L.statuses||[]}:(f.warn(`[CHANGE_PLAYER_DECK] Card definition not found for baseId: ${L.baseId}, id: ${L.id}`),{id:L.id,baseId:L.baseId,name:"Unknown",deck:P,ownerId:C,ownerName:B.name,power:L.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""})}return f.warn(`[CHANGE_PLAYER_DECK] Card without baseId: ${L.id}`),{id:L.id,baseId:L.id,name:"Unknown",deck:P,ownerId:C,ownerName:B.name,power:L.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}),P==="Optimates"||P==="Command"){const L={};z.forEach(K=>{const V=K.baseId||K.id;L[V]=(L[V]||0)+1}),f.info(`[CHANGE_PLAYER_DECK] Reconstructed ${P} deck for player ${C}:`,{totalCards:z.length,cardCounts:L})}else f.info(`[CHANGE_PLAYER_DECK] Reconstructed deck for player ${C} from host data: ${z.length} cards`);else if(!U)z=et(P,C,B.name),f.warn(`[CHANGE_PLAYER_DECK] No deck data from host, creating locally for player ${C} from ${P}`);else return W;return{...W,players:W.players.map(L=>L.id===C?{...L,selectedDeck:P,deck:z,hand:[],discard:[],announcedCard:null,boardHistory:[]}:L)}})}break;case"GAME_RESET":n(C=>{const P=I.data.activeGridSize||8,O=[];for(let U=0;U<P;U++){const z=[];for(let L=0;L<P;L++)z.push({card:null});O.push(z)}const W=(I.data.players||[]).map(U=>{if(U.isDummy&&U.hand&&U.deck&&U.discard)return{...U,boardHistory:[]};{const z=U.selectedDeck||"SynchroTech";return{...U,hand:[],deck:et(z,U.id,U.name),discard:[],boardHistory:[]}}}),B={...C,players:W,gameMode:I.data.gameMode,isPrivate:I.data.isPrivate,activeGridSize:I.data.activeGridSize,dummyPlayerCount:I.data.dummyPlayerCount,autoAbilitiesEnabled:I.data.autoAbilitiesEnabled,isGameStarted:I.data.isGameStarted,currentPhase:I.data.currentPhase,currentRound:I.data.currentRound,turnNumber:I.data.turnNumber,activePlayerId:I.data.activePlayerId,startingPlayerId:I.data.startingPlayerId,roundWinners:I.data.roundWinners||{},gameWinner:I.data.gameWinner,isRoundEndModalOpen:I.data.isRoundEndModalOpen,isReadyCheckActive:I.data.isReadyCheckActive,board:O,targetingMode:null,floatingTexts:[]};return c.current=B,B});break;case"ABILITY_MODE_SET":($r=I.data)!=null&&$r.abilityMode&&(n(C=>({...C,abilityMode:I.data.abilityMode})),f.info("[AbilityMode] Received ability mode from host",{playerId:I.data.abilityMode.playerId,mode:I.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":f.info("[Ability] Target selected",I.data);break;case"ABILITY_COMPLETED":n(C=>({...C,abilityMode:void 0})),f.info("[Ability] Ability completed",I.data);break;case"ABILITY_CANCELLED":n(C=>({...C,abilityMode:void 0}));break;case"CHANGE_PLAYER_COLOR":if(f.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",I.data),!I.data||I.data.playerId===void 0)break;{const C=I.data.playerId,P=I.data.color;if(C===E.current)break;n(O=>({...O,players:O.players.map(W=>W.id===C?{...W,color:P}:W)}))}break;case"UPDATE_PLAYER_SCORE":if(f.info("[UPDATE_PLAYER_SCORE] Received score update broadcast",I.data),!I.data||I.data.playerId===void 0)break;{const C=I.data.playerId,P=I.data.delta;if(C===E.current)break;n(O=>({...O,players:O.players.map(W=>W.id===C?{...W,score:Math.max(0,W.score+P)}:W)}))}break;case"TRIGGER_HIGHLIGHT":if((Hr=I.data)!=null&&Hr.highlightData){const C=I.data.highlightData;S(C),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(I.data){const C=(Fr=Y.current)==null?void 0:Fr.getPeerId();I.senderId!==C&&S(I.data)}break;case"TRIGGER_FLOATING_TEXT":if((Wr=I.data)!=null&&Wr.textData){const C=I.data.textData;n(P=>({...P,floatingTexts:[...P.floatingTexts,C].filter(O=>Date.now()-O.timestamp<ne.FLOATING_TEXT_DURATION)})),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((Br=I.data)!=null&&Br.batch){const C=I.data.batch;n(P=>({...P,floatingTexts:[...P.floatingTexts,...C].filter(O=>Date.now()-O.timestamp<ne.FLOATING_TEXT_DURATION)})),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:I.senderId,data:{batch:C},timestamp:Date.now()},I.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const C=(Yr=Y.current)==null?void 0:Yr.getPeerId();(zr=I.data)!=null&&zr.batch&&I.senderId!==C?n(P=>({...P,floatingTexts:[...P.floatingTexts,...I.data.batch].filter(O=>Date.now()-O.timestamp<ne.FLOATING_TEXT_DURATION)})):(Kr=I.data)!=null&&Kr.textData&&I.senderId!==C&&n(P=>({...P,floatingTexts:[...P.floatingTexts,I.data.textData].filter(O=>Date.now()-O.timestamp<ne.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((qr=I.data)!=null&&qr.coords){const C=I.data.coords,P=I.data.timestamp;u({coords:C,timestamp:P}),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:I.senderId,data:{coords:C,timestamp:P},timestamp:Date.now()},I.senderId)}break;case"NO_TARGET_TRIGGERED":if((jr=I.data)!=null&&jr.coords){const C=(Vr=Y.current)==null?void 0:Vr.getPeerId();I.senderId!==C&&u({coords:I.data.coords,timestamp:I.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(I.data){const C=I.data;D(P=>[...P,C]),setTimeout(()=>{D(P=>P.filter(O=>O.timestamp!==C.timestamp))},1e3),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(I.data){const C=I.data;R(P=>[...P,C]),setTimeout(()=>{R(P=>P.filter(O=>O.timestamp!==C.timestamp))},1e3),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"TRIGGER_CLICK_WAVE":if(I.data){const C=I.data;G(P=>[...P,C]),setTimeout(()=>{G(P=>P.filter(O=>O.timestamp!==C.timestamp))},600),j.current&&Y.current&&I.senderId&&Y.current.broadcastToGuests({type:"CLICK_WAVE_TRIGGERED",senderId:I.senderId,data:C,timestamp:Date.now()},I.senderId)}break;case"CLICK_WAVE_TRIGGERED":I.data&&I.senderId!==((Jr=Y.current)==null?void 0:Jr.getPeerId())&&(G(C=>[...C,I.data]),setTimeout(()=>{G(C=>C.filter(P=>P.timestamp!==I.data.timestamp))},600));break;case"DECK_SELECTION_TRIGGERED":I.data&&I.senderId!==((Xr=Y.current)==null?void 0:Xr.getPeerId())&&(D(C=>[...C,I.data]),setTimeout(()=>{D(C=>C.filter(P=>P.timestamp!==I.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":I.data&&I.senderId!==((Zr=Y.current)==null?void 0:Zr.getPeerId())&&(R(C=>[...C,I.data]),setTimeout(()=>{R(C=>C.filter(P=>P.timestamp!==I.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((Qr=I.data)!=null&&Qr.targetingMode){const C=I.data.targetingMode;f.info("[TargetingMode] Received SET_TARGETING_MODE via WebRTC",{playerId:C.playerId,mode:C.action.mode,boardTargetsCount:((ea=C.boardTargets)==null?void 0:ea.length)||0,handTargetsCount:((ta=C.handTargets)==null?void 0:ta.length)||0,isDeckSelectable:C.isDeckSelectable||!1,timestamp:C.timestamp,isHost:j.current}),n(P=>({...P,targetingMode:C})),c.current.targetingMode=C,j.current&&Y.current&&Y.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((aa=(ra=Y.current).getPeerId)==null?void 0:aa.call(ra))??void 0,data:{targetingMode:C},timestamp:Date.now()})}break;case"CLEAR_TARGETING_MODE":f.info("[TargetingMode] Received CLEAR_TARGETING_MODE via WebRTC",{isHost:j.current}),n(C=>({...C,targetingMode:null})),c.current.targetingMode=null,j.current&&Y.current&&Y.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((oa=(na=Y.current).getPeerId)==null?void 0:oa.call(na))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()});break;case"RECONNECT_ACCEPT":if((sa=I.data)!=null&&sa.gameState){const C=I.data.gameState;n(C),k("Connected"),f.info(`[Reconnection] State restored with ${((ia=C.players)==null?void 0:ia.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(P){f.warn("[Reconnection] Failed to clear stored data:",P)}}break;case"RECONNECT_REJECT":{const C=((da=I.data)==null?void 0:da.reason)||"unknown";f.warn(`[Reconnection] Reconnection rejected: ${C}`),k("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((ca=I.data)==null?void 0:ca.playerId)!==void 0&&(f.info(`[Reconnection] Player ${I.data.playerId} disconnected, reconnection window open`),n(C=>({...C,players:C.players.map(P=>P.id===I.data.playerId?{...P,isDisconnected:!0}:P)})));break;case"PLAYER_RECONNECTED":((la=I.data)==null?void 0:la.playerId)!==void 0&&(f.info(`[Reconnection] Player ${I.data.playerId} reconnected`),n(C=>({...C,players:C.players.map(P=>P.id===I.data.playerId?{...P,isDisconnected:!1}:P)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((ua=I.data)==null?void 0:ua.playerId)!==void 0&&(f.info(`[Reconnection] Player ${I.data.playerId} converted to dummy`),n(C=>({...C,players:C.players.map(P=>P.id===I.data.playerId?{...P,isDummy:!0,isDisconnected:!0}:P)})));break;case"REQUEST_DECK_VIEW":if(j.current&&((fa=I.data)==null?void 0:fa.targetPlayerId)!==void 0){const C=I.data.targetPlayerId;I.playerId;const P=r.players.find(O=>O.id===C);if(P&&Y.current){let O=[];C===E.current||P.isDummy?(f.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${P.deck.length} cards, first card baseId: ${(pa=P.deck[0])==null?void 0:pa.baseId}`),O=P.deck.map(U=>({id:U.id,baseId:U.baseId,deck:U.deck,power:U.power,powerModifier:U.powerModifier,isFaceDown:U.isFaceDown,statuses:U.statuses||[]}))):P.deckCards&&P.deckCards.length>0?O=P.deckCards:O=P.deck.map(U=>({id:U.id,baseId:U.baseId,power:U.power,powerModifier:U.powerModifier,isFaceDown:U.isFaceDown,statuses:U.statuses||[]}));const W={targetPlayerId:C,deckCards:O,deckSize:O.length},B={type:"DECK_VIEW_DATA",senderId:Y.current.getPeerId(),data:W,timestamp:Date.now()};Y.current.sendToGuest(I.senderId||"",B),f.info(`[REQUEST_DECK_VIEW] Sent ${W.deckCards.length} cards for player ${C}`)}}break;case"DECK_VIEW_DATA":if(((ya=I.data)==null?void 0:ya.targetPlayerId)!==void 0&&((ha=I.data)!=null&&ha.deckCards)){const C=I.data.targetPlayerId,P=I.data.deckCards;f.info(`[DECK_VIEW_DATA] Received ${P.length} deck cards for player ${C}`);const O=B=>{if(B.baseId){const z=Be(B.baseId);if(z)return{...z,id:B.id,baseId:B.baseId,deck:B.deck||De.SynchroTech,ownerId:C,power:B.power,powerModifier:B.powerModifier,isFaceDown:B.isFaceDown,statuses:B.statuses||[]};f.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${B.baseId}`)}else f.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${B.id}`);return{id:B.id,baseId:B.baseId||B.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:B.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:De.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}},W=P.map(O);n(B=>({...B,players:B.players.map(U=>U.id===C?{...U,deck:W}:U)}))}break;case"DECK_DATA_UPDATE":if(j.current&&I.playerId!==void 0&&((ma=I.data)!=null&&ma.deck)){const C=I.playerId,P=I.data.deck,O=I.data.deckSize;f.info(`[DECK_DATA_UPDATE] Received ${P.length} cards for guest ${C}, deckSize=${O}`),n(W=>({...W,players:W.players.map(B=>{if(B.id===C){const U=P.map(z=>({...z,ownerId:z.ownerId??C}));return{...B,deck:U,deckSize:O}}return B})}))}break;case"REQUEST_DECK_DATA":if(!j.current&&Y.current){const C=r.players.find(P=>P.id===E.current);if(C&&C.deck.length>0){f.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${C.deck.length} cards`);const P=C.deck.map(O=>({id:O.id,baseId:O.baseId,ownerId:O.ownerId??E.current,power:O.power,powerModifier:O.powerModifier||0,isFaceDown:O.isFaceDown||!1,statuses:O.statuses||[]}));Y.current.sendAction("DECK_DATA_UPDATE",{playerId:E.current,deck:P,deckSize:P.length})}}break;default:f.warn(`[handleWebrtcMessage] Unknown message type: ${I.type}`,I);break}},[de,et,Ut,r,s]),ln=$.useCallback(I=>{if(!Y.current||Se)return;ke(!0),k("Connecting");const ae=3e4,ee=1e3;let te=0;const ie=ae/ee;try{const ce={hostPeerId:I,playerId:s,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(ce))}catch(ce){f.error("[Reconnection] Failed to store data:",ce)}const oe=async()=>{te++;const ce=Math.max(0,ae-te*ee);if(Ne({attempt:te,maxAttempts:ie,timeRemaining:ce}),ce<=0){f.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),ke(!1),Ne(null),nt();return}let J=I;if(r!=null&&r.gameId){const Ie=Yt(r.gameId);if(Ie&&Ie.peerId!==I){J=Ie.peerId;try{const be={hostPeerId:J,playerId:s,gameState:r,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(be))}catch(be){f.error("[Reconnection] Failed to update reconnection data:",be)}}}try{const Ie=s||E.current;Ie!==null?(f.info(`[Reconnection] Reconnecting as existing player ${Ie} to host ${J}`),await Y.current.initializeAsReconnectingGuest(J,Ie)):(f.info("[Reconnection] No playerId, connecting as new player"),await Y.current.initializeAsGuest(J)),f.info("[Reconnection] Successfully reconnected!"),ke(!1),Ne(null)}catch(Ie){f.warn("[Reconnection] Reconnection attempt failed:",Ie),setTimeout(oe,ee)}};oe()},[Se,r,s]),$e=$.useCallback(I=>{n(ae=>{if(!ae)return f.error("[updateState] prevState is undefined, skipping update"),ae;const ee=typeof I=="function"?I(ae):I;if(!ee)return f.error("[updateState] newState is undefined, skipping update"),ae;const te=!ae.gameId&&ee.gameId;if(!je.current&&!te)return ee;if(F&&Y.current){if(j.current){if(Y.current.broadcastGameState(ee),f.info(`[updateState] Host broadcast state: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`),ee.gameId&&E.current!==null)try{Tt({gameState:ee,localPlayerId:E.current,isHost:!0}),f.debug("[updateState] Saved game state for host auto-restore")}catch(ie){f.warn("[updateState] Failed to save game state:",ie)}}else Y.current&&(Y.current.sendStateToHost(ee,E.current),f.info(`[updateState] Guest sent state to host: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`));return ee}if(ge.current&&ge.current.readyState===WebSocket.OPEN){const ie={type:"UPDATE_STATE",gameState:ee};ut.current&&(ie.playerToken=ut.current),ge.current.send(JSON.stringify(ie))}return ee})},[F,de,Ut]),un=$.useCallback(()=>{const{initialState:I}=ft.createGame();$e(I)},[ft,$e]),fn=$.useCallback(()=>{ft.exitGame(qe,j,ga,nt)},[ft,qe,j,ga,nt]),pn=Is({ws:ge,webrtcManager:Y,gameStateRef:c,webrtcIsHostRef:j,setGameState:n,updateState:$e}),yn=Es({ws:ge,webrtcManager:Y,gameStateRef:c,localPlayerIdRef:E,webrtcIsHostRef:j,setGameState:n}),hn=Ts({updateState:$e,sendWebrtcAction:rt,webrtcIsHostRef:j,webrtcManagerRef:Y}),mn=ws({updateState:$e}),In=gs({localPlayerIdRef:E,updateState:$e}),{addBoardCardStatus:En,removeBoardCardStatus:Tn,removeBoardCardStatusByOwner:wn,modifyBoardCardPower:gn,addAnnouncedCardStatus:_n,removeAnnouncedCardStatus:bn,modifyAnnouncedCardPower:An,addHandCardStatus:Sn,removeHandCardStatus:Cn,revealHandCard:Dn,revealBoardCard:Rn,requestCardReveal:kn,respondToRevealRequest:Pn,removeRevealedStatus:On}=In,vn=_s({webrtcIsHostRef:j,sendWebrtcAction:rt,webrtcManagerRef:Y,localPlayerIdRef:E,getCardDefinition:Be,commandCardIds:Do,createDeck:et,updateState:$e}),{changePlayerDeck:Nn,loadCustomDeck:Mn,resurrectDiscardedCard:Ln,reorderTopDeck:Gn,reorderCards:xn,recoverDiscardedCard:Un}=vn,$n=bs({ws:ge,webrtcManagerRef:Y,webrtcIsHostRef:j,gameStateRef:c,scoreDeltaAccumulator:Qe,setGameState:n,updateState:$e,abilityMode:t,setAbilityMode:a,createDeck:et}),{toggleActivePlayer:Hn,toggleAutoDraw:Fn,setPhase:Wn,nextPhase:Bn,prevPhase:Yn,closeRoundEndModal:zn,closeRoundEndModalOnly:Kn,resetGame:qn}=$n;$.useEffect(()=>{Ke.current=!1;const I=sessionStorage.getItem("invite_game_id"),ae=sessionStorage.getItem("invite_host_id");if(I&&!ae)return fr(),()=>{Ke.current=!0,pt.current&&clearTimeout(pt.current),ge.current&&(ge.current.onclose=null,ge.current.close())};if(I&&ae)return()=>{Ke.current=!0,pt.current&&clearTimeout(pt.current),ge.current&&(ge.current.onclose=null,ge.current.close())};const ee=performance.getEntriesByType("navigation"),te=ee.length>0?ee[0]:null,ie=(te==null?void 0:te.type)??0,oe=ys();return oe&&(f.info(`Restoring saved game state (nav type: ${ie}):`,oe.gameState.gameId),n(oe.gameState),d(oe.localPlayerId),c.current=oe.gameState,E.current=oe.localPlayerId,ut.current=oe.playerToken),fr(),()=>{Ke.current=!0,pt.current&&clearTimeout(pt.current),ge.current&&(ge.current.onclose=null,ge.current.close())}},[]),$.useEffect(()=>{if(ze&&c.current&&c.current.gameId){const I=Rt(c.current);I!==c.current&&(n(I),c.current=I)}},[]),$.useEffect(()=>{if(M)return;const I=setInterval(()=>{if(ze&&c.current&&c.current.gameId){const ae=Rt(c.current);n({...ae}),c.current=ae,H(!0),clearInterval(I)}},100);return()=>clearInterval(I)},[M]);const{startReadyCheck:jn,cancelReadyCheck:Vn,playerReady:Jn}=yn,{updatePlayerName:Xn,changePlayerColor:Zn}=hn,{drawCard:Qn,drawCardsBatch:eo,shufflePlayerDeck:to,flipBoardCard:ro,flipBoardCardFaceDown:ao}=mn,{assignTeams:no,setGameMode:oo,setGamePrivacy:so,setActiveGridSize:io,setDummyPlayerCount:co}=pn,lo=$.useCallback(()=>{var I;if(((I=ge.current)==null?void 0:I.readyState)===WebSocket.OPEN&&c.current.gameId&&E.current===1){ge.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:ze}));const ae=c.current,ee=he(ae);ee.players.forEach(te=>{if(["hand","deck","discard"].forEach(oe=>{te[oe]&&(te[oe]=te[oe].map(ce=>{const J=Ft(ce.name);return J?{...ce,...J}:ce}))}),te.announcedCard){const oe=Ft(te.announcedCard.name);oe&&(te.announcedCard={...te.announcedCard,...oe})}}),ee.board.forEach(te=>{te.forEach(ie=>{if(ie.card){const oe=Ft(ie.card.name);oe&&(ie.card={...ie.card,...oe})}})}),ge.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:ee})),n(ee)}},[]),$t=$.useCallback((I,ae)=>{var ie;const ee=c.current;if(!ee.isGameStarted){f.warn("[ScoreUpdate] Blocked: game not started");return}if(ee.isRoundEndModalOpen){f.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(ae===0)return;const te=ve();if(te?$e(oe=>({...oe,players:oe.players.map(ce=>ce.id===I?{...ce,score:Math.max(0,(ce.score||0)+ae)}:ce)})):n(oe=>({...oe,players:oe.players.map(ce=>ce.id===I?{...ce,score:Math.max(0,(ce.score||0)+ae)}:ce)})),!te){if(((ie=ge.current)==null?void 0:ie.readyState)!==WebSocket.OPEN){f.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const oe=Qe.get(I);if(oe){clearTimeout(oe.timerId);const ce=oe.delta+ae,J=setTimeout(()=>{var be;const Ie=Qe.get(I);Ie&&((be=ge.current)==null?void 0:be.readyState)===WebSocket.OPEN&&(f.info(`[ScoreUpdate] Sending accumulated delta: player=${I}, delta=${Ie.delta}`),ge.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:c.current.gameId,playerId:I,delta:Ie.delta}))),Qe.delete(I)},500);Qe.set(I,{delta:ce,timerId:J})}else{const ce=setTimeout(()=>{var Ie;const J=Qe.get(I);J&&((Ie=ge.current)==null?void 0:Ie.readyState)===WebSocket.OPEN&&(f.info(`[ScoreUpdate] Sending delta: player=${I}, delta=${J.delta}`),ge.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:c.current.gameId,playerId:I,delta:J.delta}))),Qe.delete(I)},500);Qe.set(I,{delta:ae,timerId:ce})}}},[n,$e]),uo=Ds({ws:ge,webrtcManager:Y,gameStateRef:c,webrtcIsHostRef:j,setGameState:n}),{setTargetingMode:fo,clearTargetingMode:hr}=uo,po=As({ws:ge,gameStateRef:c,updateState:$e,updatePlayerScore:$t,triggerFloatingText:yr,clearTargetingMode:hr}),{scoreLine:yo,scoreDiagonal:ho}=po,Ze=Ss({updateState:$e,rawJsonData:ze}),mo=Cs({updateState:$e,localPlayerIdRef:E,updatePlayerScore:$t}),{moveItem:mr}=mo;return{gameState:r,localPlayerId:s,setLocalPlayerId:d,draggedItem:w,setDraggedItem:A,connectionStatus:h,gamesList:T,latestHighlight:p,latestFloatingTexts:_,latestNoTarget:l,latestDeckSelections:g,latestHandCardSelections:v,joinAsInvite:Xa,startReadyCheck:jn,cancelReadyCheck:Vn,playerReady:Jn,assignTeams:no,setGameMode:oo,setGamePrivacy:so,setActiveGridSize:io,setDummyPlayerCount:co,updatePlayerName:Xn,changePlayerColor:Zn,updatePlayerScore:$t,changePlayerDeck:Nn,loadCustomDeck:Mn,drawCard:Qn,drawCardsBatch:eo,shufflePlayerDeck:to,moveItem:mr,handleDrop:mr,addBoardCardStatus:En,removeBoardCardStatus:Tn,removeBoardCardStatusByOwner:wn,modifyBoardCardPower:gn,addAnnouncedCardStatus:_n,removeAnnouncedCardStatus:bn,modifyAnnouncedCardPower:An,addHandCardStatus:Sn,removeHandCardStatus:Cn,flipBoardCard:ro,flipBoardCardFaceDown:ao,revealHandCard:Dn,revealBoardCard:Rn,requestCardReveal:kn,respondToRevealRequest:Pn,syncGame:lo,removeRevealedStatus:On,toggleActivePlayer:Hn,toggleAutoDraw:Fn,triggerHighlight:en,triggerFloatingText:yr,triggerNoTarget:tn,triggerDeckSelection:rn,triggerHandCardSelection:an,triggerClickWave:on,clickWaves:b,syncValidTargets:nn,setTargetingMode:fo,clearTargetingMode:hr,nextPhase:Bn,prevPhase:Yn,setPhase:Wn,markAbilityUsed:Ze.markAbilityUsed,applyGlobalEffect:Ze.applyGlobalEffect,swapCards:Ze.swapCards,transferStatus:Ze.transferStatus,transferAllCounters:Ze.transferAllCounters,spawnToken:Ze.spawnToken,resetDeployStatus:Ze.resetDeployStatus,removeStatusByType:Ze.removeStatusByType,recoverDiscardedCard:Un,resurrectDiscardedCard:Ln,scoreLine:yo,closeRoundEndModal:zn,closeRoundEndModalOnly:Kn,resetGame:qn,scoreDiagonal:ho,reorderTopDeck:Gn,reorderCards:xn,updateState:$e,requestDeckView:ur,sendFullDeckToHost:at,createGame:un,joinGame:pr,joinGameViaModal:pr,exitGame:fn,requestGamesList:Za,forceReconnect:Ja,webrtcHostId:Q,webrtcIsHost:de,initializeWebrtcHost:Xe,connectAsGuest:tt,sendWebrtcAction:rt,isReconnecting:Se,reconnectProgress:Ce}};function Ca(e,t,a){const{gameState:r,localPlayerId:n,abilityMode:i,cursorStack:o,handleActionExecution:s,markAbilityUsed:d}=a;if(i||o||!r.isGameStarted||n===null)return null;const c=r.players.find(A=>A.id===e.ownerId),E=n===e.ownerId||(c==null?void 0:c.isDummy);if(r.activePlayerId!==e.ownerId||!E||!Ma(e,r)||!Na(e,r.currentPhase,r.activePlayerId,r))return null;const w=Mo(e,r,e.ownerId,t);if(w){w.readyStatusToRemove&&d(t,!!w.isDeployAbility,!1,w.readyStatusToRemove);const A={...w,chainedAction:w.chainedAction?{...w.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};return s(A,t),A}return null}function Li(e){const t=ct[e],a=(t==null?void 0:t.allowedTargets)||[];return{allowedTargets:a,allowHand:a.includes("hand"),allowBoard:a.includes("board"),allowBoardFaceDown:a.includes("board-facedown"),allowDeck:a.includes("deck"),allowDiscard:a.includes("discard")}}function lr(e,t,a,r){const n={type:e,count:a?a.count+1:1,isDragging:!0,originalOwnerId:t,sourceCoords:a==null?void 0:a.sourceCoords},i={};return e==="Revealed"&&(i.excludeOwnerId=t,i.onlyFaceDown=!0),{...n,...i,...r,...a&&{chainedAction:a.chainedAction,isDeployAbility:a.isDeployAbility,readyStatusToRemove:a.readyStatusToRemove}}}function Ve(e,t){var r;const a=(r=e.sourceCard)==null?void 0:r.ownerId;return typeof a=="number"?a:typeof t=="number"?t:0}function Os(e,t,a){var E;const{gameState:r,localPlayerId:n,commandContext:i,triggerNoTarget:o,onAbilityComplete:s,handleActionExecution:d}=a;if(e.type==="ABILITY_COMPLETE"){s==null||s();return}if(e.type==="REVEREND_SETUP_SCORE"){vs(e,t,a);return}if(e.type==="GLOBAL_AUTO_APPLY"){Ns(e,t,a);return}if(!Ct(e,r,((E=e.sourceCard)==null?void 0:E.ownerId)||n,i)){o(t),e.chainedAction&&!e.skipChainedActionOnNoTargets&&setTimeout(()=>{d(e.chainedAction,t)},500);return}if(e.type==="CREATE_STACK"){Ms(e,t,a);return}if(e.type==="OPEN_MODAL"){Ls(e,t,a);return}if(e.type==="ENTER_MODE"){Gs(e,t,a);return}f.warn("[handleActionExecution] Unknown action type:",e.type)}function vs(e,t,a){var c,E;const{gameState:r,updatePlayerScore:n,triggerFloatingText:i,markAbilityUsed:o}=a,s=((c=e.sourceCard)==null?void 0:c.ownerId)??0;let d=0;for(let w=0;w<r.board.length;w++)for(let A=0;A<r.board[w].length;A++){const h=(E=r.board[w][A])==null?void 0:E.card;if(h!=null&&h.statuses){const k=h.statuses.filter(T=>T.type==="Exploit"&&T.addedByPlayerId===s);d+=k.length}}d>0&&n(s,d),i([{row:t.row,col:t.col,text:`+${d}`,playerId:s}]),o(t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Ns(e,t,a){var k,T,m,p,S,_;const{gameState:r,localPlayerId:n,commandContext:i,markAbilityUsed:o,triggerNoTarget:s,triggerFloatingText:d,updatePlayerScore:c,applyGlobalEffect:E,addBoardCardStatus:w,removeStatusByType:A,handleActionExecution:h}=a;if(((k=e.payload)==null?void 0:k.customAction)==="FINN_SCORING"){const y=(T=e.sourceCard)==null?void 0:T.ownerId;if(y===void 0){f.warn("[FINN_SCORING] Source card missing ownerId"),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}let l=0;if(r.players.forEach(u=>{u.id!==y&&u.hand.forEach(g=>{var D;(D=g.statuses)!=null&&D.some(v=>v.type==="Revealed"&&v.addedByPlayerId===y)&&l++})}),r.board.forEach(u=>{u.forEach(g=>{var v;const D=g.card;if(D&&D.ownerId!==y){const R=((v=D.statuses)==null?void 0:v.filter(b=>b.type==="Revealed"&&b.addedByPlayerId===y).length)||0;l+=R}})}),l>0){const u=e.sourceCoords||t;d({row:u.row,col:u.col,text:`+${l}`,playerId:y}),c(y,l)}o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(((m=e.payload)==null?void 0:m.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){e.sourceCoords&&e.sourceCoords.row>=0?A(e.sourceCoords,"Aim"):i.lastMovedCardCoords&&A(i.lastMovedCardCoords,"Aim");return}if((p=e.payload)!=null&&p.tokenType&&e.payload.filter){const{tokenType:y,filter:l}=e.payload,u=[],g=r.board.length;for(let D=0;D<g;D++)for(let v=0;v<g;v++){const R=r.board[D][v].card;R&&l(R,D,v)&&u.push({row:D,col:v})}if(u.length===0){s(e.sourceCoords||t),e.chainedAction&&setTimeout(()=>h(e.chainedAction,t),500),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}u.forEach(D=>{var v;w(D,y,((v=e.sourceCard)==null?void 0:v.ownerId)||0)}),o(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove),e.chainedAction&&setTimeout(()=>h(e.chainedAction,t),ne.MODE_CLEAR_DELAY);return}if((S=e.payload)!=null&&S.contextReward){Da(e,t,a);return}if(e.payload&&!e.payload.cleanupCommand){const{tokenType:y,filter:l}=e.payload,u=[],g=r.board.length;if(e.payload.contextReward&&e.sourceCard){Da(e,t,a);return}if(l)for(let D=0;D<g;D++)for(let v=0;v<g;v++){const R=r.board[D][v].card;R&&l(R)&&u.push({row:D,col:v})}else e.sourceCoords&&e.sourceCoords.row>=0?u.push(e.sourceCoords):t&&t.row>=0?u.push(t):i.lastMovedCardCoords&&u.push(i.lastMovedCardCoords);if(u.length>0){if(y){const D=e.payload.count||1,v=e.payload.ownerId!==void 0?e.payload.ownerId:((_=e.sourceCard)==null?void 0:_.ownerId)??n??0;for(let R=0;R<D;R++)E(t,u,y,v,!!e.isDeployAbility)}}else s(t),o(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}}function Ms(e,t,a){var c,E;const{gameState:r,setAbilityMode:n,setCursorStack:i,triggerNoTarget:o,localPlayerId:s}=a;let d=e.count||0;if(e.dynamicCount){const{factor:w,ownerId:A}=e.dynamicCount;let h=0;r.board.forEach(k=>{k.forEach(T=>{var m;if((m=T.card)!=null&&m.statuses){const p=T.card.statuses.filter(S=>S.type===w&&S.addedByPlayerId===A);h+=p.length}})}),d=h}if(d>0){n(null);let w=((c=e.sourceCard)==null?void 0:c.ownerId)??s??0;!((E=e.sourceCard)!=null&&E.ownerId)&&s!==null&&(w=s);const A={count:d,sourceCoords:e.sourceCoords||t,sourceCard:e.sourceCard,isDeployAbility:e.isDeployAbility,readyStatusToRemove:e.readyStatusToRemove,targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,placeAllAtOnce:e.placeAllAtOnce,replaceStatus:e.replaceStatus,chainedAction:e.chainedAction,recordContext:e.recordContext};i(lr(e.tokenType||"Aim",w,null,A))}else o(t)}function Ls(e,t,a){var c,E;const{gameState:r,localPlayerId:n,commandContext:i,setViewingDiscard:o,markAbilityUsed:s}=a;if(!Ct(e,r,((c=e.sourceCard)==null?void 0:c.ownerId)||n,i)){s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(e.mode==="RETRIEVE_DEVICE"){const w=r.players.find(A=>{var h;return A.id===((h=e.sourceCard)==null?void 0:h.ownerId)});w&&(o({player:w,pickConfig:{filterType:"Device",action:"recover"}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}else if(e.mode==="IMMUNIS_RETRIEVE"){const w=r.players.find(A=>{var h;return A.id===((h=e.sourceCard)==null?void 0:h.ownerId)});w&&o({player:w,pickConfig:{filterType:"Optimates",action:"resurrect"}})}else if(e.mode==="SEARCH_DECK"){const w=r.players.find(A=>{var h;return A.id===((h=e.sourceCard)==null?void 0:h.ownerId)});w&&(o({player:w,pickConfig:{filterType:((E=e.payload)==null?void 0:E.filterType)||"Unit",action:"recover",isDeck:!0}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Gs(e,t,a){var h,k;const{gameState:r,localPlayerId:n,commandContext:i,triggerNoTarget:o,setAbilityMode:s,markAbilityUsed:d,addBoardCardStatus:c,setTargetingMode:E,handleActionExecution:w}=a,A=e.mode;if(A==="SHIELD_SELF_THEN_RIOT_PUSH"){const T=e.sourceCard.ownerId;if(c(t,"Shield",T),!Ct(e,r,T,i)){o(t),d(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),E(e,Ve(e,n),t,void 0,i);return}if(A==="SHIELD_SELF_THEN_SPAWN"){const T=Ve(e,n);c(t,"Shield",T),s({...e,payload:{...e.payload,shieldApplied:!0}}),E(e,T,t);return}if(A==="PRINCEPS_SHIELD_THEN_AIM"){const T=Ve(e,n);c(t,"Shield",T);const m={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};w(m,t);return}if(A==="GAWAIN_DEPLOY_SHIELD_AIM"){const T=e.sourceCard.ownerId;c(t,"Shield",T);const m={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};w(m,t);return}if(A==="ABR_DEPLOY_SHIELD_AIM"){const T=e.sourceCard.ownerId;c(t,"Shield",T);const m={type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};w(m,t);return}if(A==="RIOT_PUSH"){if(e.isDeployAbility){s(e),E(e,Ve(e,n),t);return}if(!Ct(e,r,((h=e.sourceCard)==null?void 0:h.ownerId)||n,i)){o(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),E(e,Ve(e,n),t);return}if(A==="PATROL_MOVE"){s(e),E(e,Ve(e,n),t);return}if(A==="SELECT_TARGET"){if(e.isDeployAbility){s(e),E(e,Ve(e,n),t,void 0,i);return}if(!Ct(e,r,((k=e.sourceCard)==null?void 0:k.ownerId)||n,i)){o(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),E(e,Ve(e,n),t,void 0,i);return}s(e),E(e,Ve(e,n),t)}function Da(e,t,a){var p,S,_,y,l,u,g;const{gameState:r,commandContext:n,updatePlayerScore:i,triggerFloatingText:o,drawCardsBatch:s,removeBoardCardStatus:d,addBoardCardStatus:c,modifyBoardCardPower:E,markAbilityUsed:w}=a,A=(p=e.payload)==null?void 0:p.contextReward,h=n.lastMovedCardCoords||t;if(!h||h.row<0)return;let k=r.board[h.row][h.col].card;const T=((S=e.payload)==null?void 0:S._tempContextId)||n.lastMovedCardId;if((!k||T&&k.id!==T)&&T)for(let D=0;D<r.board.length;D++){for(let v=0;v<r.board[D].length;v++)if(((_=r.board[D][v].card)==null?void 0:_.id)===T){k=r.board[D][v].card;break}if(k)break}if(!k){f.warn("[ContextReward] No card at coords");return}const m=Math.max(0,k.power+(k.powerModifier||0)+(k.bonusPower||0));A==="DRAW_MOVED_POWER"||A==="DRAW_EQUAL_POWER"?s(((y=e.sourceCard)==null?void 0:y.ownerId)||0,m):A==="SCORE_MOVED_POWER"?(o({row:h.row,col:h.col,text:`+${m}`,playerId:((l=e.sourceCard)==null?void 0:l.ownerId)||0}),i(((u=e.sourceCard)==null?void 0:u.ownerId)||0,m)):A==="STUN_MOVED_UNIT"?c(h,"Stun",((g=e.sourceCard)==null?void 0:g.ownerId)||0):A==="REMOVE_AIM"?d(h,"Aim"):A==="WEAKEN"&&E(h,-1),w(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function xs(e,t){var u;const{gameState:a,localPlayerId:r,abilityMode:n,setAbilityMode:i,cursorStack:o,commandContext:s,setCommandContext:d,playMode:c,draggedItem:E,interactionLock:w,handleActionExecution:A,handleDrop:h,moveItem:k,markAbilityUsed:T,spawnToken:m,resurrectDiscardedCard:p,updatePlayerScore:S,triggerFloatingText:_,handleLineSelection:y}=t;if(w.current)return!1;const l=a.board.length;if(E)return e.row>=0&&e.row<l&&e.col>=0&&e.col<a.board[e.row].length?(h(E,{location:"board",row:e.row,col:e.col}),!0):!1;if(o&&o.isDragging){if(dt({location:"board",row:e.row,col:e.col},{...o.targetOwnerId!==void 0&&{targetOwnerId:o.targetOwnerId},...o.excludeOwnerId!==void 0&&{excludeOwnerId:o.excludeOwnerId},onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.targetType&&{targetType:o.targetType},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},...o.requireStatusFromSourceOwner!==void 0&&{requireStatusFromSourceOwner:o.requireStatusFromSourceOwner},...o.mustBeAdjacentToSource&&o.sourceCoords&&{mustBeAdjacentTo:o.sourceCoords},...o.mustBeInLineWithSource&&o.sourceCoords&&{mustBeInLineWith:o.sourceCoords},...o.maxDistanceFromSource!==void 0&&{maxDistance:o.maxDistanceFromSource},...o.range&&{range:o.range}},r??0,a.players)){let D=null;if(o.sourceCoords){const{row:v,col:R}=o.sourceCoords;v>=0&&v<l&&R>=0&&R<a.board[v].length&&(D=a.board[v][R].card)}if(D)return A({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:o.type,count:o.count,targetOwnerId:o.targetOwnerId,onlyOpponents:o.onlyOpponents,onlyFaceDown:o.onlyFaceDown,...o.range&&{range:o.range},...o.requiredTargetStatus&&{requiredTargetStatus:o.requiredTargetStatus},cleanupCommand:!0},sourceCard:D,sourceCoords:o.sourceCoords},e),!0}return!1}if(n&&n.mode==="SPAWN_TOKEN"){const{sourceCoords:g,payload:D,sourceCard:v,isDeployAbility:R,readyStatusToRemove:b}=n;if(!g||!(D!=null&&D.tokenName)||!(Math.abs(e.row-g.row)+Math.abs(e.col-g.col)===1))return!1;const x=(v==null?void 0:v.ownerId)??((u=n.sourceCard)==null?void 0:u.ownerId);return m(e,D.tokenName,x),T(g,R,!1,b),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="SELECT_CELL"){const{sourceCoords:g,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R,payload:b}=n,G=(()=>{var M;if(g&&g.row>=0)return g;if(!D)return null;for(let H=0;H<a.board.length;H++)for(let F=0;F<a.board.length;F++)if(((M=a.board[H][F].card)==null?void 0:M.id)===D.id)return{row:H,col:F};return null})();if(!G||!D)return!1;let x=!1;if((b==null?void 0:b.range)==="line")x=e.row===G.row||e.col===G.col;else if((b==null?void 0:b.range)==="global")x=!0;else if((b==null?void 0:b.range)===2){const M=Math.abs(e.row-G.row)+Math.abs(e.col-G.col);if(M===1)x=!0;else if(M===2){const H=G.row,F=G.col,q=e.row,Q=e.col;x=[{r:q,c:F},{r:H,c:Q},{r:(H+q)/2,c:(F+Q)/2}].some(de=>{if(!Number.isInteger(de.r)||!Number.isInteger(de.c))return!1;const Te=Math.floor((a.board.length-a.activeGridSize)/2),j=Te,Se=Te+a.activeGridSize-1;return de.r<j||de.r>Se||de.c<j||de.c>Se||Math.abs(de.r-H)+Math.abs(de.c-F)!==1?!1:!a.board[de.r][de.c].card})}}else b!=null&&b.filter?x=b.filter(null,e.row,e.col):x=Math.abs(e.row-G.row)+Math.abs(e.col-G.col)===1;if(!x)return!1;if(b!=null&&b.moveFromHand&&s.selectedHandCard){const{playerId:M,cardIndex:H}=s.selectedHandCard,F=a.players.find(Q=>Q.id===M),q=F==null?void 0:F.hand[H];if(q)return k({card:q,source:"hand",playerId:M,cardIndex:H,isManual:!0},{target:"board",boardCoords:e}),T(g||e,v,!1,R),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0}if(!((b==null?void 0:b.allowSelf)&&e.row===G.row&&e.col===G.col)){const M=a.board[G.row][G.col].card;M&&k({card:M,source:"board",boardCoords:G,bypassOwnershipCheck:!0},{target:"board",boardCoords:e})}if(b!=null&&b.recordContext&&d({lastMovedCardCoords:e,lastMovedCardId:D.id}),T(g||e,v,!1,R),b!=null&&b.chainedAction){const M={...b.chainedAction};M.targetOwnerId===-2&&(M.targetOwnerId=D.ownerId),b.recordContext&&(M.payload||(M.payload={}),M.payload._tempContextId=D.id),i(null),setTimeout(()=>{A(M,e)},ne.MODE_CLEAR_DELAY)}else setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY);return!0}if(n&&n.mode==="PATROL_MOVE"){const{sourceCoords:g,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R}=n;if(!g||!D)return!1;if(e.row===g.row&&e.col===g.col)return T(g,v,!1,R),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0;const b=e.row===g.row,G=e.col===g.col;return!b&&!G||a.board[e.row][e.col].card!==null?!1:(k({card:D,source:"board",boardCoords:g},{target:"board",boardCoords:e}),T(e,v,!1,R),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0)}if(n&&n.mode==="RIOT_MOVE"){const{sourceCoords:g,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R,payload:b}=n;return!g||!D||!(b!=null&&b.vacatedCoords)?!1:e.row===b.vacatedCoords.row&&e.col===b.vacatedCoords.col?(k({card:D,source:"board",boardCoords:g},{target:"board",boardCoords:e}),T(e,v,!1,R),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0):(T(g,v,!1,R),i(null),!0)}if(n&&n.mode==="IMMUNIS_RETRIEVE"){const{sourceCoords:g,payload:D,isDeployAbility:v,readyStatusToRemove:R,sourceCard:b}=n;if(!g||!(Math.abs(e.row-g.row)+Math.abs(e.col-g.col)===1))return!1;if((D==null?void 0:D.selectedCardIndex)!==void 0){const x=(b==null?void 0:b.ownerId)||0;return p(x,D.selectedCardIndex,e),T(g,v,!1,R),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0}return!1}if(n&&n.mode==="INTEGRATOR_LINE_SELECT"){const{sourceCoords:g,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R}=n;if(!g||g.row<0)return!1;const b=e.row===g.row,G=e.col===g.col;if(!b&&!G)return!1;const x=(D==null?void 0:D.ownerId)||0;let N=0;if(b)for(let M=0;M<l;M++){const H=a.board[e.row][M].card;H!=null&&H.statuses&&(N+=H.statuses.filter(F=>F.type==="Exploit"&&F.addedByPlayerId===x).length)}else for(let M=0;M<l;M++){const H=a.board[M][e.col].card;M!==g.row&&H!=null&&H.statuses&&(N+=H.statuses.filter(F=>F.type==="Exploit"&&F.addedByPlayerId===x).length)}return N>0&&(S(x,N),_({row:g.row,col:g.col,text:`+${N}`,playerId:x})),T(g,v,!1,R),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="IP_AGENT_THREAT_SCORING"){const{sourceCoords:g,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R}=n;if(!g)return!1;const b=e.row===g.row,G=e.col===g.col;if(!b&&!G)return!1;const x=(D==null?void 0:D.ownerId)||0;let N=0;if(b)for(let H=0;H<l;H++){const F=a.board[e.row][H].card;F!=null&&F.statuses&&(N+=F.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===x).length)}else for(let H=0;H<l;H++){const F=a.board[H][e.col].card;H!==g.row&&F!=null&&F.statuses&&(N+=F.statuses.filter(q=>q.type==="Threat"&&q.addedByPlayerId===x).length)}const M=N*2;return M>0&&(S(x,M),_({row:g.row,col:g.col,text:`+${M}`,playerId:x})),T(g,v,!1,R),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="ZIUS_LINE_SELECT"){const{sourceCoords:g,sourceCard:D,isDeployAbility:v,readyStatusToRemove:R}=n,b=s.lastMovedCardCoords||g;if(!b)return!1;const G=e.row===b.row,x=e.col===b.col;if(!G&&!x)return!1;const N=(D==null?void 0:D.ownerId)||0;let M=0;const H=[];if(G)for(let F=0;F<l;F++){const q=a.board[e.row][F].card;if(q!=null&&q.statuses){const Q=q.statuses.filter(X=>X.type==="Exploit"&&X.addedByPlayerId===N);M+=Q.length,Q.length>0&&H.push({row:e.row,col:F})}}else for(let F=0;F<l;F++){const q=a.board[F][e.col].card;if(F!==b.row&&q!=null&&q.statuses){const Q=q.statuses.filter(X=>X.type==="Exploit"&&X.addedByPlayerId===N);M+=Q.length,Q.length>0&&H.push({row:F,col:e.col})}}return M>0&&(S(N,M),H.forEach(F=>{_({row:F.row,col:F.col,text:"+1",playerId:N})})),T(g||b,v,!1,R),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0}return n!=null&&n.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","SELECT_LINE_START","SELECT_DIAGONAL"].includes(n.mode)?(y(e),!0):c!=null&&c.card&&c.sourceCoords?(h({card:c.card,source:"hand",playerId:c.playerId,cardIndex:c.cardIndex},{location:"board",row:e.row,col:e.col}),!0):!1}function Us(e,t,a,r){var S;const{gameState:n,localPlayerId:i,abilityMode:o,cursorStack:s,interactionLock:d,setCommandContext:c,setAbilityMode:E,moveItem:w,markAbilityUsed:A,handleActionExecution:h,triggerHandCardSelection:k,setCursorStack:T,clearTargetingMode:m,clearValidTargets:p}=r;if(!d.current){if(s){if(["Aim","Exploit","Stun","Shield"].includes(s.type))return;const y={targetOwnerId:s.targetOwnerId,excludeOwnerId:s.excludeOwnerId,onlyOpponents:s.onlyOpponents||s.targetOwnerId===-1,onlyFaceDown:s.onlyFaceDown,targetType:s.targetType,requiredTargetStatus:s.requiredTargetStatus,tokenType:s.type};if(dt({card:t,ownerId:e.id,location:"hand"},y,n.activePlayerId,n.players)&&s.type==="Revealed"){const u=((S=s.sourceCard)==null?void 0:S.ownerId)??n.activePlayerId??i??1;t.statuses||(t.statuses=[]),t.statuses.some(D=>D.type==="Revealed"&&D.addedByPlayerId===u)||(t.statuses.push({type:"Revealed",addedByPlayerId:u}),w({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:e.id,cardIndex:a}),s.sourceCoords&&s.sourceCoords.row>=0&&A(s.sourceCoords,s.isDeployAbility,!1,s.readyStatusToRemove),s.count>1?T(D=>D?{...D,count:D.count-1}:null):(m(),p==null||p(),s.chainedAction&&h(s.chainedAction,s.sourceCoords||{row:-1,col:-1}),T(null)))}return}if((o==null?void 0:o.type)==="ENTER_MODE"&&o.mode==="SELECT_TARGET"){const{payload:_,sourceCoords:y,isDeployAbility:l,sourceCard:u,readyStatusToRemove:g}=o;if(k(e.id,a,n.activePlayerId??i??1),_.actionType==="SELECT_HAND_FOR_DEPLOY"){if(_.filter&&!_.filter(t))return;c(D=>({...D,selectedHandCard:{playerId:e.id,cardIndex:a}})),E({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,payload:{range:"global",moveFromHand:!0}});return}if(_.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(_.filter&&!_.filter(t)||e.id!==(u==null?void 0:u.ownerId))return;w({card:t,source:"hand",playerId:e.id,cardIndex:a,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),m(),p==null||p();const D={type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:u,sourceCoords:y,isDeployAbility:l,payload:{tokenName:_.tokenName}};E(D),y&&y.row>=0&&setTimeout(()=>{h(D,y)},0);return}if(_.actionType==="LUCIUS_SETUP"){if(e.id!==(u==null?void 0:u.ownerId))return;w({card:t,source:"hand",playerId:e.id,cardIndex:a,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),h({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:u,sourceCoords:y,isDeployAbility:l,payload:{filterType:"Command"}},y||{row:-1,col:-1}),E(null);return}if(_.actionType==="DESTROY"){if(_.filter&&!_.filter(t))return;w({card:t,source:"hand",playerId:e.id,cardIndex:a,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),y&&y.row>=0&&A(y,l,!1,g),setTimeout(()=>E(null),ne.MODE_CLEAR_DELAY)}}}}function $s(e,t,a){const{abilityMode:r,cursorStack:n,interactionLock:i,gameState:o,activateAbility:s}=a;r||n||i.current||o.isGameStarted&&o.activePlayerId===e.id&&Oo(t,"setup",o.currentPhase)&&s(t,{row:-1,col:-1})}function Hs(e,t){var l,u,g,D,v;const{gameState:a,localPlayerId:r,abilityMode:n,interactionLock:i,setAbilityMode:o,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:c,nextPhase:E,modifyBoardCardPower:w,scoreLine:A,scoreDiagonal:h,commandContext:k}=t;if(!n)return!1;const{mode:T,sourceCard:m,sourceCoords:p,payload:S,isDeployAbility:_,readyStatusToRemove:y}=n;if(T==="SCORE_LAST_PLAYED_LINE"&&n.sourceCoords){if(i.current)return!0;const{row:R,col:b}=n.sourceCoords,{row:G,col:x}=e;if(R!==G&&b!==x)return!0;i.current=!0;const N=a.activePlayerId,M=a.board.length;let H=R,F=R,q=b,Q=b;if(R===G)H=R,F=R,q=0,Q=M-1;else if(b===x)q=x,Q=x,H=0,F=M-1;else return i.current=!1,!0;const X=a.board.some(j=>j.some(Se=>{var ke,Ce;return((ke=Se.card)==null?void 0:ke.ownerId)===N&&Se.card.name.toLowerCase().includes("data liberator")&&((Ce=Se.card.statuses)==null?void 0:Ce.some(Ne=>Ne.type==="Support"))}));let de=0;const Te=[];for(let j=H;j<=F;j++)for(let Se=q;Se<=Q;Se++){const Ce=a.board[j][Se].card;if(Ce&&!((l=Ce.statuses)!=null&&l.some(Ne=>Ne.type==="Stun"))){const Ne=Ce.ownerId===N,Pe=(u=Ce.statuses)==null?void 0:u.some(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===N);if(Ne||X&&Pe&&Ce.ownerId!==N){const _e=Math.max(0,Ce.power+(Ce.powerModifier||0)+(Ce.bonusPower||0));_e>0&&(de+=_e,Te.push({row:j,col:Se,text:`+${_e}`,playerId:N}))}}}return o(null),Te.length>0&&c(Te),de>0&&d(N,de),E(),setTimeout(()=>{i.current=!1},200),!0}if(T==="SELECT_LINE_START")return o({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:m,sourceCoords:p,isDeployAbility:_,payload:{...S,firstCoords:e}}),!0;if(T==="SELECT_LINE_END"&&(S!=null&&S.firstCoords)){const{row:R,col:b}=S.firstCoords,{row:G,col:x}=e;if(R!==G&&b!==x)return!0;const N=S.actionType,M=(m==null?void 0:m.ownerId)??((g=a.players.find(H=>H.id===a.activePlayerId))!=null&&g.isDummy?a.activePlayerId:r||a.activePlayerId);if(N==="ZIUS_SCORING"){const H=k.lastMovedCardCoords;if(H){const j=R===G&&H.row===R,Se=b===x&&H.col===b;if(!j&&!Se)return!0}const F=a.board.length;let q=0,Q=F-1,X=0,de=F-1;if(R===G)q=Q=R;else if(b===x)X=de=b;else return!0;let Te=0;for(let j=q;j<=Q;j++)for(let Se=X;Se<=de;Se++){const ke=a.board[j][Se];ke.card&&(Te+=((D=ke.card.statuses)==null?void 0:D.filter(Ce=>Ce.type==="Exploit"&&Ce.addedByPlayerId===M).length)||0)}Te>0&&M&&(p&&c({row:p.row,col:p.col,text:`+${Te}`,playerId:M}),d(M,Te)),p&&p.row>=0&&s(p,_,!1,y)}else if(N==="CENTURION_BUFF"&&m&&p&&M){const H=a.board.length;let F=0,q=H-1,Q=0,X=H-1;R===G?F=q=R:Q=X=b;for(let de=F;de<=q;de++)for(let Te=Q;Te<=X;Te++){const j=a.board[de][Te].card;if(j){const Se=j.id===m.id,ke=j.ownerId===M,Ce=a.players.find(_e=>_e.id===M),Ne=a.players.find(_e=>_e.id===j.ownerId),Pe=(Ce==null?void 0:Ce.teamId)!==void 0&&(Ne==null?void 0:Ne.teamId)!==void 0&&Ce.teamId===Ne.teamId;!Se&&(ke||Pe)&&w({row:de,col:Te},1)}}s(p,_,!1,y)}else(N==="SCORE_LINE"||!N)&&(A(R,b,G,x,M),S.skipNextPhase||E());return setTimeout(()=>o(null),ne.MODE_CLEAR_DELAY),!0}if(T==="SELECT_DIAGONAL"&&S.actionType==="SCORE_DIAGONAL"){const R=(m==null?void 0:m.ownerId)??((v=a.players.find(b=>b.id===a.activePlayerId))!=null&&v.isDummy?a.activePlayerId:r||a.activePlayerId);if(S.firstCoords){const{row:b,col:G}=S.firstCoords,{row:x,col:N}=e;return Math.abs(b-x)!==Math.abs(G-N)?(o(null),!0):(h(b,G,x,N,R,S.bonusType),S.skipNextPhase||E(),o(null),!0)}else return o({...n,payload:{...S,firstCoords:e}}),!0}return!1}function Fs(e,t,a){const{gameState:r,localPlayerId:n,abilityMode:i,interactionLock:o,handleLineSelection:s}=a;if(!i||i.type!=="ENTER_MODE"||o.current||i.sourceCard&&i.sourceCard.id===e.id&&i.mode!=="SELECT_LINE_START"&&i.mode!=="INTEGRATOR_LINE_SELECT"&&i.mode!=="ZIUS_LINE_SELECT"&&i.mode!=="IP_AGENT_THREAT_SCORING"&&i.mode!=="SELECT_UNIT_FOR_MOVE"&&i.mode!=="SELECT_TARGET"&&i.mode!=="RIOT_PUSH"&&i.mode!=="RIOT_MOVE"&&i.mode!=="REVEREND_DOUBLE_EXPLOIT"&&i.mode!=="SHIELD_SELF_THEN_RIOT_PUSH")return!1;const{mode:d,payload:c,sourceCard:E}=i;return d==="SELECT_LINE_START"||d==="SELECT_LINE_END"?(s(t),!0):d==="SELECT_TARGET"&&c.tokenType?Ws(e,t,a):d==="SELECT_TARGET"?Bs(e,t,a):d==="RIOT_PUSH"?Ys(e,t,a):d==="SHIELD_SELF_THEN_RIOT_PUSH"?Ks(e,t,a):d==="RIOT_MOVE"?zs(e,t,a):d==="SWAP_POSITIONS"?qs(e,t,a):d==="TRANSFER_STATUS_SELECT"?js(e,t,a):d==="ZEALOUS_WEAKEN"?Vs(e,t,a):d==="REVEREND_DOUBLE_EXPLOIT"?Js(e,t,a):d==="SELECT_UNIT_FOR_MOVE"?Xs(e,t,a):d==="PATROL_MOVE"?Zs(e,t,a):d==="SPAWN_TOKEN"?Qs(e,t,a):d==="REVEAL_ENEMY"?ei(e,t,a):d==="SELECT_CELL"?ti(e,t,a):d==="IMMUNIS_RETRIEVE"?ri(e,t,a):d==="INTEGRATOR_LINE_SELECT"?ai(e,t,a):d==="IP_AGENT_THREAT_SCORING"?ni(e,t,a):d==="ZIUS_LINE_SELECT"?oi(e,t,a):d==="SELECT_DIAGONAL"?si(e,t,a):d==="SCORE_LAST_PLAYED_LINE"?ii(e,t,a):d==="SEARCH_DECK"?di(e,t,a):d==="RETRIEVE_DEVICE"?ci(e,t,a):d==="SELECT_DECK"?li(e,t,a):!1}function Ws(e,t,a){const{abilityMode:r,triggerClickWave:n,moveItem:i,markAbilityUsed:o,setAbilityMode:s,setCommandContext:d,handleActionExecution:c,clearValidTargets:E}=a,{payload:w,sourceCoords:A,isDeployAbility:h,readyStatusToRemove:k}=r;if(w.filter&&!w.filter(e,t.row,t.col))return!1;if(i({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:w.tokenType,count:w.count||1},{target:"board",boardCoords:t}),n("board",t),w.recordContext&&d({lastMovedCardCoords:t,lastMovedCardId:e.id}),w.chainedAction){const T={...w.chainedAction,sourceCard:w.chainedAction.sourceCard??e,sourceCoords:w.chainedAction.sourceCoords??t,isDeployAbility:h,recordContext:!0};c(T,t),setTimeout(()=>n("board",t),100),T.type!=="ENTER_MODE"&&(s(null),E())}else A&&A.row>=0&&o(A,h,!1,k),setTimeout(()=>{s(null),E()},ne.MODE_CLEAR_DELAY);return!0}function Bs(e,t,a){var l,u,g,D,v;const{abilityMode:r,markAbilityUsed:n,setAbilityMode:i,moveItem:o,modifyBoardCardPower:s,addBoardCardStatus:d,removeBoardCardStatus:c,removeBoardCardStatusByOwner:E,removeStatusByType:w,resetDeployStatus:A,setCounterSelectionData:h,handleActionExecution:k,gameState:T}=a,{payload:m,sourceCoords:p,isDeployAbility:S,readyStatusToRemove:_}=r,y=((l=r.sourceCard)==null?void 0:l.ownerId)??((u=T.players.find(R=>R.id===T.activePlayerId))!=null&&u.isDummy?T.activePlayerId:a.localPlayerId||T.activePlayerId);if(m.actionType==="OPEN_COUNTER_MODAL")return m.filter&&!m.filter(e)?!1:(h({card:e,callbackAction:m.rewardType}),i(null),!0);if(m.actionType==="SACRIFICE_AND_BUFF_LINES"){if(m.filter&&!m.filter(e,t.row,t.col))return!1;const R=((g=r.sourceCard)==null?void 0:g.ownerId)??y;o({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"discard",playerId:e.ownerId});const b=T.board.length,{row:G,col:x}=t;for(let N=0;N<b;N++){if(N===x)continue;const H=T.board[G][N].card;H&&H.ownerId===R&&s({row:G,col:N},1)}for(let N=0;N<b;N++){if(N===G)continue;const H=T.board[N][x].card;H&&H.ownerId===R&&s({row:N,col:x},1)}return n(p||t,S,!1,_),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0}if(m.actionType==="SHIELD_AND_REMOVE_AIM")return m.filter&&!m.filter(e)?!1:(d(t,"Shield",y),w(t,"Aim"),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0);if(m.actionType==="RESET_DEPLOY")return m.filter&&!m.filter(e)?!1:(A(t),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0);if(m.actionType==="MODIFY_POWER")return m.filter&&!m.filter(e)?!1:(m.amount&&s(t,m.amount),p&&p.row>=0&&n(p,S,!1,_),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0);if(m.actionType==="DESTROY")return m.filter&&!m.filter(e)?!1:(((D=e.statuses)==null?void 0:D.some(b=>b.type==="Shield"))?c(t,"Shield"):o({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),n(p||t,S,!1,_),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0);if(m.actionType==="LUCIUS_SETUP")return m.filter&&!m.filter(e)?!1:(o({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),m.chainedAction&&k(m.chainedAction,t),!0);if(m.actionType==="CENSOR_SWAP"){if(m.filter&&!m.filter(e))return!1;const R=((v=e.statuses)==null?void 0:v.filter(b=>b.type==="Exploit"&&b.addedByPlayerId===y).length)||0;if(R>0){E(t,"Exploit",y);for(let b=0;b<R;b++)d(t,"Stun",y)}return n(p||t,S,!1,_),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0}if(m.actionType==="REVEAL_ENEMY_CHAINED"){if(m.filter&&!m.filter(e,t.row,t.col))return!1;const R=e.ownerId;if(r.chainedAction){const b={...r.chainedAction,targetOwnerId:R,sourceCoords:p||t,sourceCard:r.sourceCard};k(b,t)}return n(p||t,S,!1,_),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0}return!1}function Ys(e,t,a){const{abilityMode:r,gameState:n,setAbilityMode:i,moveItem:o,markAbilityUsed:s,interactionLock:d}=a;if(d.current)return!1;const{sourceCoords:c,isDeployAbility:E,readyStatusToRemove:w,sourceCard:A}=r;if(!c||c.row<0)return!1;if(t.row===c.row&&t.col===c.col)return s(c,E,!1,w),setTimeout(()=>i(null),ne.MODE_CLEAR_DELAY),!0;const h=Math.abs(t.row-c.row)+Math.abs(t.col-c.col)===1,k=n.players.find(v=>v.id===e.ownerId),T=n.players.find(v=>v.id===(A==null?void 0:A.ownerId)),m=(k==null?void 0:k.teamId)!==void 0&&(T==null?void 0:T.teamId)!==void 0&&k.teamId===T.teamId;if(!h||e.ownerId===(A==null?void 0:A.ownerId)||m)return!1;const p=t.row-c.row,S=t.col-c.col,_=t.row+p,y=t.col+S,l=n.board.length,u=Math.floor((l-n.activeGridSize)/2),g=u,D=u+n.activeGridSize-1;return _<g||_>D||y<g||y>D||n.board[_][y].card!==null?!1:(o({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:_,col:y}}),i({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:A,sourceCoords:c,isDeployAbility:E,payload:{vacatedCoords:t}}),!0)}function zs(e,t,a){const{abilityMode:r,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="RIOT_MOVE")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:c,readyStatusToRemove:E,payload:w}=r;return!s||!d||!(w!=null&&w.vacatedCoords)?!1:t.row===w.vacatedCoords.row&&t.col===w.vacatedCoords.col?(n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),i(t,c,!1,E),setTimeout(()=>o(null),ne.MODE_CLEAR_DELAY),!0):(i(s,c,!1,E),o(null),!0)}function Ks(e,t,a){const{abilityMode:r,setAbilityMode:n,addBoardCardStatus:i,markAbilityUsed:o,interactionLock:s}=a;if(s.current)return!1;const{sourceCoords:d,isDeployAbility:c,readyStatusToRemove:E,sourceCard:w}=r;if(!d||d.row<0||!w)return!1;const A=w.ownerId;return t.row===d.row&&t.col===d.col?(i(d,"Shield",A),o(d,c,!1,E),setTimeout(()=>n(null),ne.MODE_CLEAR_DELAY),!0):(i(d,"Shield",A),n({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:w,sourceCoords:d,isDeployAbility:c,readyStatusToRemove:E,payload:{}}),!0)}function qs(e,t,a){const{abilityMode:r,gameState:n,swapCards:i,markAbilityUsed:o,setAbilityMode:s,validTargets:d}=a;if(!r||r.mode!=="SWAP_POSITIONS")return!1;const{sourceCoords:c,sourceCard:E,isDeployAbility:w,readyStatusToRemove:A,payload:h}=r;if(!c||c.row<0)return!1;const k=n.board[c.row][c.col].card;return!k||k.id!==(E==null?void 0:E.id)?(s(null),!1):E&&E.id===e.id||h.filter&&!h.filter(e,t.row,t.col)||!h.filter&&d&&!d.some(m=>m.row===t.row&&m.col===t.col)?!1:(i(c,t),o(t,w,!1,A),setTimeout(()=>s(null),ne.MODE_CLEAR_DELAY),!0)}function js(e,t,a){const{abilityMode:r,transferStatus:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="TRANSFER_STATUS_SELECT")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:c,readyStatusToRemove:E}=r;return!s||s.row<0||d&&d.id===e.id||!e.statuses||e.statuses.length===0?!1:(n(t,s,e.statuses[0].type),i(s,c,!1,E),setTimeout(()=>o(null),ne.MODE_CLEAR_DELAY),!0)}function Vs(e,t,a){const{abilityMode:r,modifyBoardCardPower:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="ZEALOUS_WEAKEN")return!1;const{payload:s,sourceCoords:d,isDeployAbility:c,readyStatusToRemove:E}=r;return s.filter&&!s.filter(e)?!1:(n(t,-1),i(d||t,c,!1,E),setTimeout(()=>o(null),ne.MODE_CLEAR_DELAY),!0)}function Js(e,t,a){const{abilityMode:r,gameState:n,addBoardCardStatus:i,markAbilityUsed:o,triggerFloatingText:s,setAbilityMode:d}=a;if(!r||r.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{sourceCoords:c,sourceCard:E,isDeployAbility:w,readyStatusToRemove:A}=r,h=(E==null?void 0:E.ownerId)||0,k=(e.statuses||[]).filter(T=>T.type==="Exploit"&&T.addedByPlayerId===h).length;if(k>0){for(let T=0;T<k;T++)i(t,"Exploit",h);s({row:t.row,col:t.col,text:`+${k}`,playerId:h,timestamp:Date.now()})}return o(c||t,w,!1,A),setTimeout(()=>d(null),ne.MODE_CLEAR_DELAY),!0}function Xs(e,t,a){const{abilityMode:r,setAbilityMode:n}=a;if(!r||r.mode!=="SELECT_UNIT_FOR_MOVE")return!1;const{sourceCard:i,payload:o,isDeployAbility:s,readyStatusToRemove:d}=r;return i&&i.id===e.id||o.filter&&!o.filter(e,t.row,t.col)?!1:(n({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:t,isDeployAbility:s,readyStatusToRemove:d,payload:{range:o.range||2,moveFromHand:o.moveFromHand||!1,selectedCard:e,allowSelf:!1}}),!0)}function Zs(e,t,a){const{abilityMode:r,gameState:n,moveItem:i,markAbilityUsed:o,setAbilityMode:s}=a;if(!r||r.mode!=="PATROL_MOVE")return!1;const{sourceCoords:d,sourceCard:c,isDeployAbility:E,readyStatusToRemove:w}=r;if(!d||!c)return!1;if(t.row===d.row&&t.col===d.col)return o(d,E,!1,w),setTimeout(()=>s(null),ne.MODE_CLEAR_DELAY),!0;const A=t.row===d.row,h=t.col===d.col;return!A&&!h||n.board[t.row][t.col].card!==null?!1:(i({card:c,source:"board",boardCoords:d},{target:"board",boardCoords:t}),o(t,E,!1,w),setTimeout(()=>s(null),ne.MODE_CLEAR_DELAY),!0)}function Qs(e,t,a){var k;const{abilityMode:r,spawnToken:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SPAWN_TOKEN")return!1;const{sourceCoords:s,payload:d,isDeployAbility:c,readyStatusToRemove:E,sourceCard:w}=r;if(!s||!(d!=null&&d.tokenName)||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1))return!1;const h=(w==null?void 0:w.ownerId)??((k=r.sourceCard)==null?void 0:k.ownerId);return n(t,d.tokenName,h),i(s,c,!1,E),setTimeout(()=>o(null),ne.MODE_CLEAR_DELAY),!0}function ei(e,t,a){var l;const{abilityMode:r,setAbilityMode:n,setCursorStack:i,moveItem:o,markAbilityUsed:s,gameState:d,localPlayerId:c}=a;if(!r||r.mode!=="REVEAL_ENEMY")return!1;const{sourceCoords:E,sourceCard:w,isDeployAbility:A,readyStatusToRemove:h,payload:k}=r;if(!E||!w||!(Math.abs(t.row-E.row)+Math.abs(t.col-E.col)===1)||e.deck==="Tokens"||((l=e.types)==null?void 0:l.includes("Token")))return!1;const p=e.ownerId,S=d.players.find(u=>u.id===d.activePlayerId),_=S!=null&&S.isDummy&&d.activePlayerId!==null?d.activePlayerId:c??0;return i(lr("Revealed",_,null,{targetOwnerId:p,onlyFaceDown:!0,sourceCoords:t,sourceCard:e,isDeployAbility:A,readyStatusToRemove:h})),s(E,A,!1,h),setTimeout(()=>n(null),ne.MODE_CLEAR_DELAY),!0}function ti(e,t,a){const{abilityMode:r,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SELECT_CELL")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:c,readyStatusToRemove:E,payload:w}=r;return w!=null&&w.filter&&!w.filter(null,t.row,t.col)?!1:(w!=null&&w.moveFromHand&&(w!=null&&w.selectedCard)?n({card:w.selectedCard,source:"hand"},{target:"board",boardCoords:t}):s&&s.row>=0&&d&&n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),i(s||t,c,!1,E),setTimeout(()=>o(null),ne.MODE_CLEAR_DELAY),!0)}function ri(e,t,a){const{abilityMode:r,moveItem:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="IMMUNIS_RETRIEVE")return!1;const{sourceCoords:s,payload:d,isDeployAbility:c,readyStatusToRemove:E}=r;return!s||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1)?!1:d!=null&&d.selectedCard?(n({card:d.selectedCard,source:"discard"},{target:"board",boardCoords:t}),i(s,c,!1,E),setTimeout(()=>o(null),ne.MODE_CLEAR_DELAY),!0):!1}function ai(e,t,a){const{abilityMode:r,gameState:n,moveItem:i,markAbilityUsed:o,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:c}=a;if(!r||r.mode!=="INTEGRATOR_LINE_SELECT")return!1;const{sourceCoords:E,sourceCard:w,isDeployAbility:A,readyStatusToRemove:h}=r,k=(w==null?void 0:w.ownerId)||0,T=E!==void 0&&t.row===E.row,m=E!==void 0&&t.col===E.col;if(!T&&!m)return!1;let p=0;if(T&&E)for(let S=0;S<n.board.length;S++){const _=n.board[t.row][S].card;_!=null&&_.statuses&&(p+=_.statuses.filter(y=>y.type==="Exploit"&&y.addedByPlayerId===k).length)}else if(E)for(let S=0;S<n.board.length;S++){const _=n.board[S][t.col].card;S!==E.row&&_!=null&&_.statuses&&(p+=_.statuses.filter(y=>y.type==="Exploit"&&y.addedByPlayerId===k).length)}return p>0&&(s(k,p),d({row:E.row,col:E.col,text:`+${p}`,playerId:k,timestamp:Date.now()})),o(E||t,A,!1,h),setTimeout(()=>c(null),ne.MODE_CLEAR_DELAY),!0}function ni(e,t,a){const{abilityMode:r,gameState:n,updatePlayerScore:i,triggerFloatingText:o,markAbilityUsed:s,setAbilityMode:d}=a;if(!r||r.mode!=="IP_AGENT_THREAT_SCORING")return!1;const{sourceCoords:c,sourceCard:E,isDeployAbility:w,readyStatusToRemove:A}=r,h=(E==null?void 0:E.ownerId)||0;if(!c)return!1;const k=t.row===c.row,T=t.col===c.col;if(!k&&!T)return!1;let m=0;if(k)for(let S=0;S<n.board.length;S++){const _=n.board[t.row][S].card;_!=null&&_.statuses&&(m+=_.statuses.filter(y=>y.type==="Threat"&&y.addedByPlayerId===h).length)}else for(let S=0;S<n.board.length;S++){const _=n.board[S][t.col].card;S!==c.row&&_!=null&&_.statuses&&(m+=_.statuses.filter(y=>y.type==="Threat"&&y.addedByPlayerId===h).length)}const p=m*2;return p>0&&(i(h,p),o({row:c.row,col:c.col,text:`+${p}`,playerId:h,timestamp:Date.now()})),s(c||t,w,!1,A),setTimeout(()=>d(null),ne.MODE_CLEAR_DELAY),!0}function oi(e,t,a){const{abilityMode:r,gameState:n,commandContext:i,updatePlayerScore:o,triggerFloatingText:s,markAbilityUsed:d,setAbilityMode:c}=a;if(!r||r.mode!=="ZIUS_LINE_SELECT")return!1;const{sourceCoords:E,sourceCard:w,isDeployAbility:A,readyStatusToRemove:h}=r,k=(w==null?void 0:w.ownerId)||0,T=i.lastMovedCardCoords||E;if(!T)return!1;const m=t.row===T.row,p=t.col===T.col;if(!m&&!p)return!1;let S=0;const _=[];if(m)for(let y=0;y<n.board.length;y++){const l=n.board[t.row][y].card;if(l!=null&&l.statuses){const u=l.statuses.filter(g=>g.type==="Exploit"&&g.addedByPlayerId===k);S+=u.length,u.length>0&&_.push({row:t.row,col:y})}}else for(let y=0;y<n.board.length;y++){const l=n.board[y][t.col].card;if(y!==T.row&&l!=null&&l.statuses){const u=l.statuses.filter(g=>g.type==="Exploit"&&g.addedByPlayerId===k);S+=u.length,u.length>0&&_.push({row:y,col:t.col})}}return S>0&&(o(k,S),_.forEach(y=>{s({row:y.row,col:y.col,text:"+1",playerId:k,timestamp:Date.now()})})),d(E||t,A,!1,h),setTimeout(()=>c(null),ne.MODE_CLEAR_DELAY),!0}function si(e,t,a){var D;const{abilityMode:r,gameState:n,moveItem:i,markAbilityUsed:o,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:c}=a;if(!r||r.mode!=="SELECT_DIAGONAL")return!1;const{sourceCoords:E,sourceCard:w,isDeployAbility:A,readyStatusToRemove:h,payload:k}=r,T=(w==null?void 0:w.ownerId)||0,{row:m,col:p}=t,{row:S,col:_}=E||{row:0,col:0},y=m-p===S-_,l=m+p===S+_;if(!y&&!l)return!1;if(k!=null&&k.selectForMove&&e)return k.chainedAction&&a.handleActionExecution(k.chainedAction,t),!0;let u=0;const g=n.board.length;if(y){const v=S-_;for(let R=0;R<g;R++){const b=v+R,G=R;if(b>=0&&b<g&&G>=0&&G<g){const x=n.board[b][G].card;x!=null&&x.statuses&&(u+=x.statuses.filter(N=>N.type==="Exploit"&&N.addedByPlayerId===T).length)}}}if(l){const v=S+_;for(let R=0;R<g;R++){const b=R,G=v-b;if(b>=0&&b<g&&G>=0&&G<g){const x=n.board[b][G].card;x!=null&&x.statuses&&(u+=x.statuses.filter(N=>N.type==="Exploit"&&N.addedByPlayerId===T).length)}}}return k!=null&&k.bonusForSupport&&((D=w==null?void 0:w.statuses)!=null&&D.some(v=>v.type==="Support"))&&(u+=k.bonusForSupport),u>0&&(s(T,u),d({row:(E==null?void 0:E.row)||t.row,col:(E==null?void 0:E.col)||t.col,text:`+${u}`,playerId:T,timestamp:Date.now()})),o(E||t,A,!1,h),setTimeout(()=>c(null),ne.MODE_CLEAR_DELAY),!0}function ii(e,t,a){const{abilityMode:r,gameState:n,commandContext:i,moveItem:o,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:c,setAbilityMode:E}=a;if(!r||r.mode!=="SCORE_LAST_PLAYED_LINE")return!1;const{sourceCoords:w,sourceCard:A,isDeployAbility:h,readyStatusToRemove:k,payload:T}=r,m=(A==null?void 0:A.ownerId)||0,p=i.lastMovedCardCoords;if(!p)return!1;const S=n.board[p.row][p.col].card;if(!S)return!1;const _=t.row===p.row,y=t.col===p.col;if(!_&&!y)return!1;const l=Math.max(0,S.power+(S.powerModifier||0));return(T==null?void 0:T.rewardType)==="SCORE"?(d(m,l),c({row:p.row,col:p.col,text:`+${l}`,playerId:m,timestamp:Date.now()})):T==null||T.rewardType,s(w||t,h,!1,k),setTimeout(()=>E(null),ne.MODE_CLEAR_DELAY),!0}function di(e,t,a){const{abilityMode:r,setViewingDiscard:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SEARCH_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:c}=r;return n(!0),i(s||t,d,!1,c),o(null),!0}function ci(e,t,a){const{abilityMode:r,setViewingDiscard:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="RETRIEVE_DEVICE")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:c}=r;return n(!0),i(s||t,d,!1,c),o(null),!0}function li(e,t,a){const{abilityMode:r,triggerDeckSelection:n,markAbilityUsed:i,setAbilityMode:o}=a;if(!r||r.mode!=="SELECT_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:c}=r;return n(e.ownerId??0),i(s||t,d,!1,c),setTimeout(()=>o(null),ne.MODE_CLEAR_DELAY),!0}const Gi=({gameState:e,localPlayerId:t,abilityMode:a,setAbilityMode:r,cursorStack:n,setCursorStack:i,commandContext:o,setCommandContext:s,setViewingDiscard:d,triggerNoTarget:c,triggerClickWave:E,playMode:w,setPlayMode:A,setCounterSelectionData:h,interactionLock:k,onAbilityComplete:T,updateState:m,moveItem:p,drawCard:S,drawCardsBatch:_,updatePlayerScore:y,markAbilityUsed:l,applyGlobalEffect:u,swapCards:g,transferStatus:D,transferAllCounters:v,resurrectDiscardedCard:R,spawnToken:b,scoreLine:G,nextPhase:x,modifyBoardCardPower:N,addBoardCardStatus:M,removeBoardCardStatus:H,removeBoardCardStatusByOwner:F,resetDeployStatus:q,scoreDiagonal:Q,removeStatusByType:X,triggerFloatingText:de,triggerHandCardSelection:Te,clearValidTargets:j,setTargetingMode:Se,clearTargetingMode:ke,validTargets:Ce})=>{const Ne=$.useRef(()=>{}),Pe=$.useCallback(Oe=>{Hs(Oe,{gameState:e,localPlayerId:t,abilityMode:a,interactionLock:k,setAbilityMode:r,markAbilityUsed:l,updatePlayerScore:y,triggerFloatingText:de,nextPhase:x,modifyBoardCardPower:N,scoreLine:G,scoreDiagonal:Q,commandContext:o})},[a,e,t,k,r,l,y,de,x,N,G,Q,o]);Ne.current=Pe;const _e=$.useCallback((Oe,Ue)=>{Os(Oe,Ue,{gameState:e,localPlayerId:t,setAbilityMode:r,setCursorStack:i,commandContext:o,markAbilityUsed:l,triggerNoTarget:c,handleActionExecution:_e,modifyBoardCardPower:N,addBoardCardStatus:M,removeBoardCardStatus:H,removeStatusByType:X,updatePlayerScore:y,triggerFloatingText:de,setViewingDiscard:d,handleLineSelection:Ne.current,onAbilityComplete:T,applyGlobalEffect:u,drawCardsBatch:_,setTargetingMode:Se})},[e,t,a,r,n,i,o,s,A,l,c,k,p,g,D,v,b,N,M,H,F,X,q,y,de,h,d,Ce,T,u,_,Se]);$.useEffect(()=>{(a==null?void 0:a.type)==="GLOBAL_AUTO_APPLY"&&(_e(a,a.sourceCoords||{row:-1,col:-1}),r(null))},[a,_e,r]),$.useEffect(()=>{a||ke()},[a,ke]);const Ke=$.useCallback((Oe,Ue)=>{Ca(Oe,Ue,{gameState:e,localPlayerId:t,abilityMode:a,cursorStack:n,handleActionExecution:_e,markAbilityUsed:l})},[e,t,a,n,_e,l]),xt=$.useCallback((Oe,Ue)=>{var Xe,tt;if(n&&A!==null&&A!==void 0){const rt={targetOwnerId:n.targetOwnerId,excludeOwnerId:n.excludeOwnerId,onlyOpponents:n.onlyOpponents||n.targetOwnerId===-1,onlyFaceDown:n.onlyFaceDown,targetType:n.targetType,requiredTargetStatus:n.requiredTargetStatus,tokenType:n.type};if(dt({card:Oe,ownerId:Oe.ownerId??0,location:"board"},rt,e.activePlayerId,e.players)){if(n.type==="Revealed"){const at=((Xe=n.sourceCard)==null?void 0:Xe.ownerId)??e.activePlayerId??t??1;if((tt=Oe.statuses)==null?void 0:tt.some(ge=>ge.type==="Revealed"&&ge.addedByPlayerId===at))return}p({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:n.type,count:1},{target:"board",boardCoords:Ue}),n.sourceCoords&&n.sourceCoords.row>=0&&l(n.sourceCoords,n.isDeployAbility,!1,n.readyStatusToRemove),n.count>1?i(at=>at?{...at,count:at.count-1}:null):(ke(),j(),n.chainedAction&&_e(n.chainedAction,n.sourceCoords||{row:-1,col:-1}),i(null))}return}if(!k.current){if(!a&&!n&&e.isGameStarted&&Ma(Oe,e)){Ke(Oe,Ue);return}if(a&&(a.mode==="SCORE_LAST_PLAYED_LINE"||a.mode==="SELECT_LINE_END")){Pe(Ue);return}(a==null?void 0:a.type)==="ENTER_MODE"&&Fs(Oe,Ue,{gameState:e,localPlayerId:t,abilityMode:a,setAbilityMode:r,cursorStack:n,setCursorStack:i,commandContext:o,setCommandContext:s,playMode:null,setPlayMode:A,draggedItem:null,setDraggedItem:()=>{},openContextMenu:()=>{},markAbilityUsed:l,triggerNoTarget:c,triggerClickWave:E,handleActionExecution:_e,interactionLock:k,moveItem:p,swapCards:g,transferStatus:D,transferAllCounters:v,spawnToken:b,modifyBoardCardPower:N,addBoardCardStatus:M,removeBoardCardStatus:H,removeBoardCardStatusByOwner:F,removeStatusByType:X,resetDeployStatus:q,updatePlayerScore:y,triggerFloatingText:de,setCounterSelectionData:h,setViewingDiscard:d,clearValidTargets:j,validTargets:Ce,handleLineSelection:Pe})||!a&&!n&&Ke(Oe,Ue)}},[n,A,e,t,k,a,Pe,p,l,i,_e,r,s,h,d,b,g,D,v,N,M,H,F,X,q,y,de,c,E,Ce,ke,Ke]),ut=$.useCallback(Oe=>{xs(Oe,{gameState:e,localPlayerId:t,abilityMode:a,setAbilityMode:r,cursorStack:n,commandContext:o,setCommandContext:s,playMode:w,draggedItem:null,interactionLock:k,handleActionExecution:_e,handleDrop:p,moveItem:p,markAbilityUsed:l,spawnToken:b,resurrectDiscardedCard:R,updatePlayerScore:y,triggerFloatingText:de,handleLineSelection:Pe})},[e,t,a,r,n,o,s,w,k,_e,p,i,c,l,b,R,y,de,Pe]),je=$.useCallback((Oe,Ue,Xe)=>{Us(Oe,Ue,Xe,{gameState:e,localPlayerId:t,abilityMode:a,cursorStack:n,interactionLock:k,setCommandContext:s,setAbilityMode:r,moveItem:p,markAbilityUsed:l,handleActionExecution:_e,triggerHandCardSelection:Te,setCursorStack:i,clearTargetingMode:ke,clearValidTargets:j})},[a,n,e,t,_e,l,r,s,Te,p,i,ke,j,k]),Y=$.useCallback((Oe,Ue)=>{$s(Oe,Ue,{abilityMode:a,cursorStack:n,gameState:e,activateAbility:(Xe,tt)=>Ca(Xe,tt,{gameState:e,localPlayerId:t,abilityMode:a,cursorStack:n,handleActionExecution:_e,markAbilityUsed:l})})},[a,n,e,t,_e,l]);return{activateAbility:Ke,executeAction:_e,handleLineSelection:Pe,handleBoardCardClick:xt,handleEmptyCellClick:ut,handleHandCardClick:je,handleAnnouncedCardDoubleClick:Y}},Xt=(e,t,a,r,n)=>{const i=(a.baseId||e.split("_")[1]||e).toLowerCase(),o=t===-1,s=[];i==="overwatch"?o?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:a}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},targetOwnerId:-1,onlyOpponents:!0,sourceCard:a}):t===1&&s.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:n,baseCount:0}},sourceCard:a}):i==="tacticalmaneuver"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:a,payload:{range:"line",filter:c=>c.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:a}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:a,payload:{range:"line",filter:c=>c.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:a}}}):i==="inspiration"?o&&s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:a,payload:{actionType:"OPEN_COUNTER_MODAL",filter:c=>c.ownerId===n}}):i==="datainterception"?o?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:a}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:a}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:a,payload:{range:2,filter:c=>{var E;return((E=c.statuses)==null?void 0:E.some(w=>w.type==="Exploit"&&w.addedByPlayerId===n))||!1}}}):i==="falseorders"?o?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:a,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):t===0?s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:a,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:n,sourceCard:a,originalOwnerId:a.ownerId}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:a,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:n}}}}):i==="experimentalstimulants"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:a,payload:{actionType:"RESET_DEPLOY",filter:c=>{var E;return c.ownerId===n&&((E=c.types)==null?void 0:E.includes("Unit"))}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:a,payload:{range:"line",filter:c=>c.ownerId===n}}):i==="logisticschain"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:a,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:a,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):i==="quickresponseteam"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:a,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:c=>{var E;return c.ownerId===n&&((E=c.types)==null?void 0:E.includes("Unit"))}}}):t===1&&s.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:a,payload:{filterType:"Unit"}}):i==="temporaryshelter"?t===0?s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:a,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):t===1&&s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:a,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):i==="enhancedinterrogation"?o?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:a}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:a}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:a,payload:{range:2,filter:c=>{var E;return((E=c.statuses)==null?void 0:E.some(w=>w.type==="Aim"&&w.addedByPlayerId===n))||!1}}}):(i==="mobilization1"||i==="linebreach")&&o&&s.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:a,payload:{actionType:"SCORE_LINE"}});const d=a.ownerId||n;return s.forEach(c=>{c.originalOwnerId=d,c.sourceCard&&!c.sourceCard.ownerId&&(c.sourceCard.ownerId=d)}),s},xi=({gameState:e,localPlayerId:t,setActionQueue:a,setCommandContext:r,setCommandModalCard:n,setCounterSelectionData:i,moveItem:o,updatePlayerScore:s,updateState:d})=>{const c=$.useCallback((A,h)=>{if(t===null)return;const k=e.players.find(S=>S.id===h.playerId);if(!(h.playerId===t||(k==null?void 0:k.isDummy)))return;o(h,{target:"announced",playerId:h.playerId}),r({});const m=(A.baseId||A.id.split("_")[1]||A.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(S=>m.includes(S)))n(A);else{const S=Xt(A.id,-1,A,e,h.playerId);S.length>0?a([...S,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:A,ownerId:h.playerId},sourceCard:A}]):a([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:A,ownerId:h.playerId},sourceCard:A}])}},[e,t,o,a,r,n]),E=$.useCallback((A,h)=>{var _,y;if(!h||t===null)return;const k=h.ownerId||t,T=[],m=Xt(h.id,-1,h,e,k);let p;(_=h.baseId)!=null&&_.toLowerCase().includes("inspiration")&&(p=A===0?"DRAW_REMOVED":"SCORE_REMOVED",m.length>0&&m[0].type==="ENTER_MODE"&&(m[0]={...m[0],payload:{...m[0].payload,rewardType:p}})),m.forEach(l=>{T.push(l)}),Xt(h.id,A,h,e,k).forEach(l=>{T.push(l)}),(y=h.baseId)!=null&&y.toLowerCase().includes("inspiration")||T.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:h,ownerId:k},sourceCard:h}),a(T),n(null)},[e,t,a,n]),w=$.useCallback((A,h)=>{var p;if(t===null)return;const k=h.card.ownerId||t;let T=null;for(let S=0;S<e.board.length;S++){for(let _=0;_<e.board[S].length;_++)if(((p=e.board[S][_].card)==null?void 0:p.id)===h.card.id){T={row:S,col:_};break}if(T)break}if(!T){f.warn(`Card ${h.card.id} not found on board during counter removal`),i(null);return}if(d(S=>{if(!S.isGameStarted)return S;const _=he(S),y=_.board[T.row][T.col].card;let l=0;const u=(y==null?void 0:y.statuses)??[];if(Object.entries(A).forEach(([g,D])=>{for(let v=0;v<D;v++){const R=u.map(b=>b.type).lastIndexOf(g);R>-1&&(y!=null&&y.statuses)&&(y.statuses.splice(R,1),l++)}}),!(y!=null&&y.statuses)&&y&&(y.statuses=[]),_.board=Le(_),l>0&&h.callbackAction==="DRAW_REMOVED"){const g=_.players.find(D=>D.id===k);if(g){const D=Math.min(l,g.deck.length);for(let v=0;v<D;v++){const R=g.deck.shift();R&&g.hand.push(R)}}}return _}),h.callbackAction==="SCORE_REMOVED"){const S=Object.values(A).reduce((_,y)=>_+y,0);S>0&&s(k,S)}const m=e.players.find(S=>S.id===k);m!=null&&m.announcedCard&&a([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:m.announcedCard,ownerId:k},sourceCard:m.announcedCard}]),i(null)},[t,s,a,i,e,d]);return{playCommandCard:c,handleCommandConfirm:E,handleCounterSelectionConfirm:w}},Ui=({gameState:e,localPlayerId:t,handleDrop:a,markAbilityUsed:r,requestCardReveal:n,interactionLock:i,setCommandContext:o,onAction:s,cursorStack:d,setCursorStack:c,setAbilityMode:E,triggerClickWave:w,clearTargetingMode:A})=>{const h=$.useRef(null),k=$.useRef({x:0,y:0});return $.useLayoutEffect(()=>{if(d&&h.current){const{x:m,y:p}=k.current;h.current.style.transform=`translate(${m-24}px, ${p-24}px)`}},[d]),$.useEffect(()=>{const m=p=>{k.current={x:p.clientX,y:p.clientY},h.current&&(h.current.style.transform=`translate(${p.clientX-24}px, ${p.clientY-24}px)`)};return window.addEventListener("mousemove",m),()=>window.removeEventListener("mousemove",m)},[]),$.useEffect(()=>{const m=p=>{var l,u,g,D,v,R;if(p.button!==0||!d)return;const S=document.elementFromPoint(p.clientX,p.clientY);let _=t;if(d.originalOwnerId!==void 0)_=d.originalOwnerId;else if((l=d.sourceCard)!=null&&l.ownerId)_=d.sourceCard.ownerId;else if(d.sourceCoords&&d.sourceCoords.row>=0){const{row:b,col:G}=d.sourceCoords;if(b>=0&&b<e.board.length&&G>=0&&G<((u=e.board[b])==null?void 0:u.length)){const x=e.board[b][G].card;x&&(_=x.ownerId||t)}}else if(e.activePlayerId){const b=e.players.find(G=>G.id===e.activePlayerId);b!=null&&b.isDummy&&(_=b.id)}let y=S==null?void 0:S.closest("[data-hand-card]");if(!y&&S)if(S.getAttribute("data-hand-card"))y=S;else{const b=S.querySelectorAll("[data-hand-card]");if(b.length>0){let G=1/0,x=null;const N=p.clientX,M=p.clientY;for(const H of Array.from(b)){const F=H.getBoundingClientRect();if(N>=F.left&&N<=F.right&&M>=F.top&&M<=F.bottom){const q=F.left+F.width/2,Q=F.top+F.height/2,X=Math.hypot(N-q,M-Q);X<G&&(G=X,x=H)}}y=x}}if(y){const b=y.getAttribute("data-hand-card");if(b){const[G,x]=b.split(","),N=parseInt(G,10),M=parseInt(x,10),H=e.players.find(q=>q.id===N),F=H==null?void 0:H.hand[M];if(H&&F){if(d.type==="Revealed"&&!H.isDummy){if((g=F.statuses)==null?void 0:g.some(Te=>Te.type==="Revealed"&&Te.addedByPlayerId===_))return;d.count===1&&(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),A()),a({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((D=d.sourceCard)==null?void 0:D.ownerId)??_??void 0,statusType:d.type,count:1},{target:"hand",playerId:N,cardIndex:M,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?c(Te=>Te?{...Te,count:Te.count-1}:null):c(null),i.current=!0,setTimeout(()=>{i.current=!1},300);return}const Q={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,tokenType:d.type};if(!dt({card:F,ownerId:N,location:"hand"},Q,_,e.players))return;d.count===1&&(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),A()),a({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((v=d.sourceCard)==null?void 0:v.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:N,cardIndex:M,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility),d.count>1?c(de=>de?{...de,count:de.count-1}:null):c(null),i.current=!0,setTimeout(()=>{i.current=!1},300);return}}}if(!y){const b=S==null?void 0:S.closest("[data-board-coords]");if(b){const G=b.getAttribute("data-board-coords");if(G){const[x,N]=G.split(","),M=parseInt(x,10),H=parseInt(N,10);if(!isNaN(M)&&!isNaN(H)&&M>=0&&M<e.board.length&&e.board[M]&&H>=0&&H<e.board[M].length&&e.board[M][H]){const F=e.board[M][H].card;if((F==null?void 0:F.ownerId)!==void 0){const q={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,mustBeAdjacentToSource:d.mustBeAdjacentToSource,mustBeInLineWithSource:d.mustBeInLineWithSource,sourceCoords:d.sourceCoords,tokenType:d.type};if(!dt({card:F,ownerId:F.ownerId,location:"board",boardCoords:{row:M,col:H}},q,_,e.players))return;e.players.find(X=>X.id===F.ownerId)}if(F){const q=d.placeAllAtOnce?d.count:1;a({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((R=d.sourceCard)==null?void 0:R.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:q},{target:"board",boardCoords:{row:M,col:H}}),w("board",{row:M,col:H}),d.recordContext&&o(X=>({...X,lastMovedCardCoords:{row:M,col:H},lastMovedCardId:F.id})),d.sourceCoords&&d.sourceCoords.row>=0&&r(d.sourceCoords,d.isDeployAbility);const Q=d.count-q;if(Q>0)c(X=>X?{...X,count:Q}:null);else{if(d.chainedAction){const X={...d.chainedAction};d.recordContext&&(X.mode==="SELECT_CELL"&&(X.sourceCard=F,X.sourceCoords={row:M,col:H},X.recordContext=!0),X.type==="GLOBAL_AUTO_APPLY"&&(X.sourceCoords={row:M,col:H}),X.type==="CREATE_STACK"&&(X.sourceCoords={row:M,col:H},X.originalOwnerId||(X.sourceCard=F)),X.mode==="ZIUS_LINE_SELECT"&&(X.sourceCoords={row:M,col:H})),X.type==="CREATE_STACK"&&E(null),s(X,{row:M,col:H})}A(),c(null)}i.current=!0,setTimeout(()=>{i.current=!1},300)}}}}else{const G=S==null?void 0:S.closest(".counter-modal-content"),x=(S==null?void 0:S.closest("[data-board-coords]"))!==null,N=(S==null?void 0:S.closest("[data-hand-card]"))!==null;d.isDragging?G?c(M=>M?{...M,isDragging:!1}:null):!x&&!N&&(A(),c(null)):!G&&!x&&!N&&(A(),c(null))}}};return window.addEventListener("mouseup",m),()=>{window.removeEventListener("mouseup",m)}},[d,a,e,t,n,r,i,o,s,c,E,w]),$.useEffect(()=>{const m=p=>{d&&(p.preventDefault(),A(),c(null))};return window.addEventListener("contextmenu",m),()=>{window.removeEventListener("contextmenu",m)}},[d,c,A]),{cursorFollowerRef:h,handleCounterMouseDown:(m,p)=>{k.current={x:p.clientX,y:p.clientY};const S=e.players.find(y=>y.id===e.activePlayerId),_=S!=null&&S.isDummy&&e.activePlayerId!==null?e.activePlayerId:t??0;c(y=>lr(m,_,y))}}};export{nt as A,Gt as B,Li as C,Ti as D,ki as E,gi as F,Ei as G,Mi as H,xi as I,Gi as J,Ui as K,yi as L,Ro as M,Lt as N,Xt as O,ko as P,dt as Q,Ct as R,bi as S,ne as T,cr as U,hi as V,Do as W,ct as a,wi as b,Pa as c,xo as d,Si as e,De as f,Ci as g,Ma as h,Be as i,mi as j,So as k,Ri as l,f as m,rr as n,ve as o,_i as p,Co as q,Di as r,Po as s,Ao as t,Ii as u,Ai as v,vi as w,Ni as x,Oi as y,Pi as z};
