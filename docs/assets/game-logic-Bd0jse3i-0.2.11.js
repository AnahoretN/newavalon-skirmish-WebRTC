import{r as U,j as co}from"./vendor-react-JYPVbgc1-0.2.11.js";import{$ as Ct}from"./vendor-webrtc-BBsnVRmn-0.2.11.js";import{d as _a,e as lo}from"./vendor-BPR6uEV2-0.2.11.js";var Re=(e=>(e.SynchroTech="SynchroTech",e.Hoods="Hoods",e.Optimates="Optimates",e.Fusion="Fusion",e.Command="Command",e.Tokens="Tokens",e.Custom="Custom",e.Neutral="Neutral",e.Random="Random",e))(Re||{}),Qt=(e=>(e.FreeForAll="FFA",e.TwoVTwo="2v2",e.ThreeVOne="3v1",e))(Qt||{});const uo={ipDeptAgent:{name:"IP Dept Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365235/SYN_IP_DEPT_AGENT_pbvh9e.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:2,ability:`Deploy: Place 2 Stun tokens on a card with your Threat.
Setup (requires Support): Gain 2 Points for each of your Threat in a chosen line.`,flavorText:`- "You've violated copyright. Open the door. We have a search warrant."`,types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},tacticalAgent:{name:"Tactical Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_TACTICAL_AGENT_vquxfm.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on a card with your Threat.
Setup: Destroy a card with your Aim token.`,flavorText:'- "Nobody move! SynchroTech Security Service!"',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},patrolAgent:{name:"Patrol Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_PATROL_AGENT_nlyneg.webp",fallbackImage:"/images/cards/SYN_PATROL_AGENT.png",power:2,ability:`Setup: Move to an empty cell in its line.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:"They say the city never sleeps. We make sure it doesn't even blink.",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},riotAgent:{name:"Riot Agent",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365236/SYN_RIOT_AGENT_i4lk5m.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Commit: Place a Stun token on an adjacent opponent card with your Threat.`,flavorText:'- "Citizens, disperse! This meeting is unauthorized by SynchroTech."',types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},threatAnalyst:{name:"Threat Analyst",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365237/SYN_THREAT_ANALYST_uqxbsp.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Pass (requires Support): Your units can individually threaten opponent cards that have your Exploit counter.`,flavorText:"",types:["Unit","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},mrPearlDoF:{name:"Mr. Pearl, Director of BioSynch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367440/HERO_Mr._Pearl_Director_of_BioSynch_lsesol.webp",fallbackImage:"/images/cards/SYN_IP_DEPT_AGENT.png",power:1,ability:`Pass: Your other units in lines get +1 power.
Deploy: Search your deck for a unit card, put it into your hand, then shuffle.`,flavorText:"Efficiency is the only metric that matters.",types:["Unit","Hero","SynchroTech"],faction:"SynchroTech",allowedPanels:["DECK_BUILDER"]},recklessProvocateur:{name:"Reckless Provocateur",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_RECKLESS_PROVOCATEUR_wvfdcr.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:3,ability:`Deploy: Swap places with an adjacent card.
Commit: Move all tokens from a chosen allied card onto this card.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},dataLiberator:{name:"Data Liberator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_DATA_LIBERATOR_qeru3j.webp",fallbackImage:"/images/cards/HOO_DATA_LIBERATOR.png",power:2,ability:`Pass (requires Support): Cards with your Exploit tokens score Points for you.
Deploy: Place an Exploit token on any card.`,flavorText:`- "Information doesn't want to be free. It needs to be."`,types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},cautiousAvenger:{name:"Cautious Avenger",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_CAUTIOUS_AVENGER_xzk6pd.webp",fallbackImage:"/images/cards/HOO_CAUTIOUS_AVENGER.png",power:2,ability:`Deploy: Place an Aim token on a card within 2 cells.
Setup (requires Support): Destroy a card with your Aim token.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},vigilantSpotter:{name:"Vigilant Spotter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_VIGILANT_SPOTTER_xo8ig7.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:1,ability:`Pass (requires Support): When a revealed card of the opponent enters the battlefield, gain 2 points.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},inventiveMaker:{name:"Inventive Maker",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365268/HOO_INVENTIVE_MAKER_sicb73.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:1,ability:`Deploy: Create a Recon Drone token in an adjacent empty cell.
Setup (requires Support): Return a Device card from your discard pile to your hand.`,flavorText:'- "Patience is a weapon. Vengeance is an art."',types:["Unit","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},finnMW:{name:"Finn, Most Wanted",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367436/HERO_Finn_c8637x.webp",fallbackImage:"/images/cards/HOO_RECKLESS_PROVOCATEUR.png",power:2,ability:`Setup: Move any one of your cards 1 or 2 cells.
Commit: Gain 1 point for each card that is revealed to you in opponents' hands or on the battlefield.`,flavorText:"Catch me if you can. Spoiler: You can't.",types:["Unit","Hero","Hoods"],faction:"Hoods",allowedPanels:["DECK_BUILDER"]},faber:{name:"Faber",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_FABER_cr804w.webp",fallbackImage:"/images/cards/OPT_FABER.png",power:1,ability:"Deploy: Discard 1 card from your hand ⇒ Create a Walking Turret token in an adjacent empty cell.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},censor:{name:"Censor",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365250/OPT_CENSOR_w4qijk.webp",fallbackImage:"/images/cards/OPT_CENSOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Replace your Exploit token on a card with a Stun token.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},princeps:{name:"Princeps",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_PRINCEPS_aaqakx.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:3,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Order is not requested. It is imposed.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},immunis:{name:"Immunis",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365252/OPT_IMMUNIS_hvlxhi.webp",fallbackImage:"/images/cards/OPT_IMMUNIS.png",power:1,ability:`Deploy (requires Support): Return an Optimates card from your discard pile to an adjacent empty cell with a Resurrection token.
At the end of the phase, replace that Resurrection token with 2 Stun tokens.`,flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},centurion:{name:"Centurion",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365251/OPT_CENTURION_grztbi.webp",fallbackImage:"/images/cards/OPT_CENTURION.png",power:2,ability:"Commit: Sacrifice an allied unit ⇒ All allied cards in that unit's lines get +1 power.",flavorText:"In the gilded halls of the Optimates, even the tools of war are works of art.",types:["Unit","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},luciusTheImmortal:{name:"Lucius, The Immortal",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367435/HERO_Lucius_The_Immortal_irhhaj.webp",fallbackImage:"/images/cards/OPT_PRINCEPS.png",power:2,ability:`Pass: Immunity to Stun. If exited from discard, gets +2 power.
Setup: Discard a card ⇒ Find a command card in your deck. Put it into your hand and shuffle.`,flavorText:"Death implies a cessation of function. I have simply optimized it.",types:["Unit","Hero","Optimates"],faction:"Optimates",allowedPanels:["DECK_BUILDER"]},codeKeeper:{name:"Code Keeper",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_CODE_KEEPER_yhowqj.webp",fallbackImage:"/images/cards/FUS_CODE_KEEPER.png",power:2,ability:`Deploy: Place 1 Exploit token on each opponent card in lines with any Threat.
Commit (requires Support): Move an opponent card with your Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},devoutSynthetic:{name:"Devout Synthetic",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_DEVOUT_SYNTHETIC_nkr1tx.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:3,ability:`Deploy: Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with a Threat or Stun token.`,flavorText:"Flesh is a bug. The Signal is the patch.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},unwaveringIntegrator:{name:"Unwavering Integrator",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_UNWAVERING_INTEGRATOR_g1cbag.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Gain 1 point for each of your Exploit tokens in a chosen line.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},signalProphet:{name:"Signal Prophet",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365286/FUS_SIGNAL_PROPHET_rmk9me.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Deploy: Place 1 Exploit token on each of your cards with Support in lines.
Commit (requires Support): Move one of your cards with an Exploit token 1 cell.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},zealousMissionary:{name:"Zealous Missionary",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365287/FUS_ZEALOUS_MISSIONARY_v7qjhw.webp",fallbackImage:"/images/cards/FUS_ZEALOUS_MISSIONARY.png",power:1,ability:`Deploy: Place an Exploit token on any card.
Commit (requires Support): Give -1 power to a card with your Exploit token.`,flavorText:"The Signal is truth. All else is noise.",types:["Unit","Fusion"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},reverendOfTheChoir:{name:"Reverend of The Choir",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367438/HERO_Reverend_of_The_Choir_njrrih.webp",fallbackImage:"/images/cards/FUS_SIGNAL_PROPHET.png",power:2,ability:`Setup (requires Support): Gain 1 point for each of your Exploit tokens on the battlefield.
Deploy: Double the number of Exploit tokens on any one card.`,flavorText:"The hum of the servers is a hymn to the initiated.",types:["Unit","Hero","Fusion","Device"],faction:"Fusion",allowedPanels:["DECK_BUILDER"]},overwatch:{name:"Overwatch",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365196/CMD_OVERWATCH_djwlqo.webp",fallbackImage:"/images/cards/CMD_OVERWATCH.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Draw 1 card for each of your Aim tokens on the battlefield.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},tacticalManeuver:{name:"Tactical Maneuver",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_REPOSITIONING_uhwvrk.webp",fallbackImage:"/images/cards/CMD_REPOSITIONING.png",power:0,ability:`● Move one of your units to an empty cell in its line. Draw cards equal to that unit's power.
● Move one of your units to an empty cell in its line. Gain points equal to that unit's power.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},inspiration:{name:"Inspiration",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_INSPIRATION_v0bi3l.webp",fallbackImage:"/images/cards/CMD_INSPIRATION.png",power:0,ability:`● Remove any number of tokens from one of your units. Draw 1 card for each token removed.
● Remove any number of tokens from one of your units. Gain 1 point for each token removed.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},dataInterception:{name:"Data Interception",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_DATA_INTERCEPTION_gen1qw.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on any card. Reveal 1 card from an opponent's hand for each of your Exploit tokens on the battlefield.
● Place 1 Exploit token on any card. Move a unit with your Exploit token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},falseOrders:{name:"False Orders",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365197/CMD_FALSE_ORDERS_aatcmc.webp",fallbackImage:"/images/cards/CMD_DATA_INTERCEPTION.png",power:0,ability:`● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Reveal up to 2 cards from that opponent's hand.
● Place 1 Exploit token on an opponent's card. Move that opponent unit with your Exploit token 1 or 2 cells. Place 2 Stun tokens on it.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},experimentalStimulants:{name:"Experimental Stimulants",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367418/CMD_Experimental_Stimulants_plsnet.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● A unit you control on the battlefield may activate its Deploy ability one additional time.
● Move one of your units to an empty cell in its line.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},logisticsChain:{name:"Logistics Chain",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367415/CMD_Logistics_Chain_odmwxq.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Score points in a diagonal. Gain +1 point for each of your cards with Support in that diagonal.
● Score points in a diagonal. Draw 1 card for each of your cards with Support in that diagonal.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},quickResponseTeam:{name:"Quick Response Team",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367414/CMD_Quick_Response_Team_xff2yt.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Play a unit from your hand into an empty cell.
● Search your deck for a unit card and put it into your hand. Then shuffle your deck.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},temporaryShelter:{name:"Temporary Shelter",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367411/CMD_Temporary_Shelter_podjbj.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Shield token on one of your cards. Remove all Aim tokens from that card.
● Place 1 Shield token on one of your cards. Move that card 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},enhancedInterrogation:{name:"Enhanced Interrogation",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367413/CMD_Enhanced_Interrogation_legiod.webp",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:`● Place 1 Aim token on any card. Reveal 1 card from an opponent's hand for each of your Aim tokens on the battlefield.
● Place 1 Aim token on any card. Move any card with your Aim token 1 or 2 cells.`,types:["Command"],faction:"Command",allowedPanels:["DECK_BUILDER"]},mobilization1:{name:"Line Breach",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1763894862/line_ocsoyj.png",fallbackImage:"/images/cards/CMD_MOBILIZATION.png",power:0,ability:"Gain points in a chosen line of the battlefield.",types:["Command"],faction:"Command",allowedPanels:[]},abrGawain:{name:'ABR "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367446/N_Autonomous_Battle_Robot_Gawain_oni745.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Place an Aim token on a card in its line.
Setup: Destroy a card with your Aim token.`,flavorText:"Protocol initiated. Threat assessment: Extreme.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},reclaimedGawain:{name:'Reclaimed "Gawain"',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Reclaimed_Gawain_sjmlsp.webp",fallbackImage:"/images/cards/FUS_DEVOUT_SYNTHETIC.png",power:4,ability:`Deploy: Gain a Shield token. Push an adjacent opponent card 1 cell; you may move into its former cell.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Once a knight of the system, now a ghost in the machine.",types:["Unit","Device","Rarity"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},secretInformant:{name:"Secret Informant",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367448/N_Secret_informant_w0w6g5.webp",fallbackImage:"/images/cards/SYN_THREAT_ANALYST.png",power:1,ability:"Deploy: Look at the top 3 cards of any deck. Put any number of them on the bottom of that deck. Draw 1 card.",flavorText:"Knowledge is power. And leverage.",types:["Unit"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},FalkPD:{name:"Michael Falk, Private Detective",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367432/HERO_Michael_Falk_sv5i5c.webp",fallbackImage:"/images/cards/HOO_VIGILANT_SPOTTER.png",power:3,ability:`Deploy: Find any card in your deck. Put it into your hand and shuffle.
Commit: Reveal 1 card from an opponent's hand.`,flavorText:"He finds things. Sometimes things that should stay lost.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},edithByron:{name:"Edith Byron, Extreme Engineer",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367434/HERO_Edith_Byron_ny23vb.webp",fallbackImage:"/images/cards/HOO_INVENTIVE_MAKER.png",power:3,ability:`Setup: Move to an empty cell in a line.
Deploy: Gain a Shield token. Create a Recon Drone token in an adjacent empty cell.`,flavorText:"Building the future, one explosion at a time.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},pinkunonekoSV:{name:"Pinkunoneko, Street Vigilante",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367429/HERO_Pinkunoneko_cqhpuy.webp",fallbackImage:"/images/cards/SYN_RIOT_AGENT.png",power:3,ability:`Deploy: Place a Stun token on an adjacent opponent card.
Setup: Destroy an adjacent opponent card with Threat or Stun.`,flavorText:"Neon claws in the dark alley.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},EleftheriaMD:{name:'Maria "Eleftheria" Damanaki',imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367431/HERO_Maria_Eleftheria_Damanaki_cpw12i.webp",fallbackImage:"/images/cards/SYN_TACTICAL_AGENT.png",power:3,ability:`Deploy: Place an Aim token on any card.
Setup: Destroy a card with your Aim token.`,flavorText:"Freedom has a price. She collects it.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]},ziusIJ:{name:"Zius, Independent Journalist",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771367428/HERO_Zius_xhuyxa.webp",fallbackImage:"/images/cards/FUS_UNWAVERING_INTEGRATOR.png",power:2,ability:`Deploy: Place an Exploit token on any card.
Setup (requires Support): Place an Exploit token on any card. Gain 1 point for each of your Exploit tokens in that card's line.`,flavorText:"The truth is out there, and he's streaming it live.",types:["Unit","Hero"],faction:"Neutral",allowedPanels:["DECK_BUILDER"]}},fo={reconDrone:{baseId:"reconDrone",name:"Recon Drone",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_RECON_DRONE_w3elir.webp",fallbackImage:"/images/cards/TKN_RECON_DRONE.png",power:1,ability:`Setup: Move to any cell on the battlefield.
Commit: Choose an opponent card in an adjacent cell. Reveal 1 card from that opponent's hand.`,flavorText:"SynchroTech has created lightweight drones to patrol the streets, but the Hoods have other plans for them.",color:"bg-gray-400",types:["Unit","Device"],allowedPanels:["TOKEN_PANEL"]},walkingTurret:{baseId:"walkingTurret",name:"Walking Turret",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365220/TKN_WALKING_TURRET_c0mttm.webp",fallbackImage:"/images/cards/TKN_WALKING_TURRET.png",power:2,ability:`Deploy: Place an Aim token on a card in its line.
Setup: Give -1 power to a card with an Aim token.`,flavorText:"This military monster clearly has no place on the city streets.",color:"bg-gray-400",types:["Unit","Optimates","Device"],allowedPanels:["TOKEN_PANEL"]}},po={Aim:{name:"Aim",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365400/Aim_qzeaqn.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is easier to destroy.`,sortOrder:1,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Exploit:{name:"Exploit",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365398/Exploit_pf2zwf.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
Hacker and programmer cards will have a greater effect on this card.`,sortOrder:2,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},LastPlayed:{name:"LastPlayed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",description:"This card was last played by its owner.",sortOrder:99,allowedPanels:[],allowedTargets:["board"]},Revealed:{name:"Revealed",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Revealed_lsan64.webp",description:"This card's face is visible to the owner of the counter revealed. Can be placed on cards in hand and face-down cards on board.",sortOrder:7,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board-facedown","hand"]},Stun:{name:"Stun",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365403/Stun_pbe7ex.webp",description:`A stunned card cannot activate abilities or gain points. Its owner's effects cannot move it, but opponent effects can.
Remove 1 stun counter from the card after the Scoring Phase.`,sortOrder:4,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Shield:{name:"Shield",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365393/Shield_yilhdt.webp",description:"If an effect attempts to destroy this card, remove 1 shield counter from it instead.",sortOrder:3,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board"]},Support:{name:"Support",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365402/Support_hxzufw.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is adjacent to its ally.`,sortOrder:5,allowedPanels:[],allowedTargets:["board"]},Threat:{name:"Threat",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771368527/Threat_dqnnsq.webp",description:`This counter has no effect on its own, but it can modify the abilities of cards.
This card is surrounded and pinned to the edge of the battlefield by an opponent's cards.`,sortOrder:6,allowedPanels:[],allowedTargets:["board"]},Resurrected:{name:"Resurrected",imageUrl:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365394/Resurrected_awaucv.webp",description:"This unit recently returned from the discard pile. It will become Stunned at the start of the next phase.",sortOrder:8,allowedPanels:["COUNTER_PANEL"],allowedTargets:["board","hand"]},"Power+":{name:"Power+",imageUrl:"",description:"Increases the power of the card by 1.",sortOrder:10,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]},"Power-":{name:"Power-",imageUrl:"",description:"Decreases the power of the card by 1.",sortOrder:11,allowedPanels:[],allowedTargets:["board","hand","deck","discard"]}},yo=[{id:"SynchroTech",name:"SynchroTech",isSelectable:!0,cards:[{cardId:"mrPearlDoF",quantity:1},{cardId:"EleftheriaMD",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"ipDeptAgent",quantity:3},{cardId:"tacticalAgent",quantity:3},{cardId:"patrolAgent",quantity:3},{cardId:"riotAgent",quantity:3},{cardId:"threatAnalyst",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Hoods",name:"Hoods",isSelectable:!0,cards:[{cardId:"finnMW",quantity:1},{cardId:"pinkunonekoSV",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"recklessProvocateur",quantity:3},{cardId:"dataLiberator",quantity:3},{cardId:"cautiousAvenger",quantity:3},{cardId:"vigilantSpotter",quantity:3},{cardId:"inventiveMaker",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Optimates",name:"Optimates",isSelectable:!0,cards:[{cardId:"luciusTheImmortal",quantity:1},{cardId:"edithByron",quantity:1},{cardId:"abrGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"faber",quantity:3},{cardId:"censor",quantity:3},{cardId:"princeps",quantity:3},{cardId:"immunis",quantity:3},{cardId:"centurion",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]},{id:"Fusion",name:"Fusion",isSelectable:!0,cards:[{cardId:"reverendOfTheChoir",quantity:1},{cardId:"ziusIJ",quantity:1},{cardId:"reclaimedGawain",quantity:1},{cardId:"secretInformant",quantity:2},{cardId:"devoutSynthetic",quantity:3},{cardId:"unwaveringIntegrator",quantity:3},{cardId:"signalProphet",quantity:3},{cardId:"zealousMissionary",quantity:3},{cardId:"codeKeeper",quantity:3},{cardId:"overwatch",quantity:1},{cardId:"tacticalManeuver",quantity:1},{cardId:"inspiration",quantity:1},{cardId:"dataInterception",quantity:1},{cardId:"falseOrders",quantity:1},{cardId:"experimentalStimulants",quantity:1},{cardId:"logisticsChain",quantity:1},{cardId:"quickResponseTeam",quantity:1},{cardId:"temporaryShelter",quantity:1},{cardId:"enhancedInterrogation",quantity:1}]}],Ut={cardDatabase:uo,tokenDatabase:fo,countersDatabase:po,deckFiles:yo};let ua=null,ot=new Map,Jt=new Map,Tt={},kt=[],Xt={};const ba=new Set(["overwatch","repositioning","tacticalManeuver","mobilization","inspiration","dataInterception","falseOrders","experimentalStimulants","logisticsChain","quickResponseTeam","temporaryShelter","enhancedInterrogation"]);async function ni(){try{let e;if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")try{const r=await fetch("/api/content/database");if(r.ok){const a=await r.json(),n=a.cards.map(([i,s])=>[i,s]),o=a.tokens.map(([i,s])=>[i,s]);e={cardDatabase:Object.fromEntries(n),tokenDatabase:Object.fromEntries(o),countersDatabase:Object.fromEntries(a.counters),deckFiles:a.deckFiles}}else e=Ut}catch{e=Ut}else e=Ut;ua=e,ot=new Map(Object.entries(e.cardDatabase)),Jt=new Map(Object.entries(e.tokenDatabase)),Tt=e.countersDatabase,kt=e.deckFiles;try{localStorage.setItem("counters_database",JSON.stringify(Tt)),localStorage.setItem("counters_timestamp",Date.now().toString())}catch(r){console.warn("Could not save counters database to localStorage:",r)}Fe=ua,er=ot,mo=Jt,ht=Tt,Io=kt,Xt=ho(),Eo=Xt}catch(e){throw console.error("Failed to load content database:",e),e}}function ho(){const e={};for(const t of kt){const r=[];for(const a of t.cards){const n=ot.get(a.cardId);if(!n){console.warn(`Card definition not found for ID: ${a.cardId} in deck: ${t.name}`);continue}const o=ba.has(a.cardId);for(let i=0;i<a.quantity;i++){const d=a.cardId.replace(/-/g,"--DASH--").toUpperCase();o?r.push({...n,deck:Re.Command,id:`CMD_${d}_${i+1}`,baseId:a.cardId,faction:n.faction||"Command"}):r.push({...n,deck:t.id,id:`${t.id.substring(0,3).toUpperCase()}_${d}_${i+1}`,baseId:a.cardId,faction:n.faction||t.id})}}e[t.id]=r}return e[Re.Tokens]=Array.from(Jt.entries()).map(([t,r])=>{const a=r.types?[...r.types]:[];return{id:`TKN_${r.name.toUpperCase().replace(/\s/g,"_")}`,baseId:t,deck:Re.Tokens,name:r.name,imageUrl:r.imageUrl,fallbackImage:r.fallbackImage,power:r.power,ability:r.ability,color:r.color,types:a,flavorText:r.flavorText,faction:"Tokens"}}),e}let Fe=null,er=new Map,mo=new Map,ht={};try{const e=localStorage.getItem("counters_database");e&&(Tt=JSON.parse(e),ht=Tt)}catch{}let Io=[],Eo={};const To=ba,oi=()=>kt.filter(e=>e.isSelectable);function Ye(e){return ot.get(e)}function $t(e){return Array.from(ot.values()).find(t=>t.name===e)}function si(){return Array.from(ot.entries()).map(([e,t])=>({id:e,card:t}))}function ii(){return ot}function Sa(){return Xt}const go=4,di={FIRST_PLAYER:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/LastPlayed_ge4gyh.webp",ROUND_WIN_MEDAL:"https://res.cloudinary.com/dxxh6meej/image/upload/v1771365397/medal_tavarc.webp"},ci={[Re.SynchroTech]:{prefix:"SYN",color:"border-cyan-400"},[Re.Hoods]:{prefix:"HOO",color:"border-purple-500"},[Re.Optimates]:{prefix:"OPT",color:"border-red-500"},[Re.Fusion]:{prefix:"FUS",color:"border-green-400"},[Re.Command]:{prefix:"CMD",color:"border-yellow-500"},[Re.Tokens]:{prefix:"TKN",color:"border-gray-400"},[Re.Custom]:{prefix:"CUS",color:"border-purple-400"},[Re.Neutral]:{prefix:"NEU",color:"border-gray-400"},[Re.Random]:{prefix:"RND",color:"border-gray-400"}},li={blue:{bg:"bg-blue-600",border:"border-blue-600",outline:"outline-blue-600",glow:"shadow-[0_0_15px_#2563eb]"},purple:{bg:"bg-purple-600",border:"border-purple-600",outline:"outline-purple-600",glow:"shadow-[0_0_15px_#9333ea]"},red:{bg:"bg-red-600",border:"border-red-600",outline:"outline-red-600",glow:"shadow-[0_0_15px_#dc2626]"},green:{bg:"bg-green-600",border:"border-green-600",outline:"outline-green-600",glow:"shadow-[0_0_15px_#16a34a]"},yellow:{bg:"bg-yellow-500",border:"border-yellow-500",outline:"outline-yellow-500",glow:"shadow-[0_0_15px_#eab308]"},orange:{bg:"bg-orange-500",border:"border-orange-500",outline:"outline-orange-500",glow:"shadow-[0_0_15px_#f97316]"},pink:{bg:"bg-pink-500",border:"border-pink-500",outline:"outline-pink-500",glow:"shadow-[0_0_15px_#ec4899]"},brown:{bg:"bg-[#8B4513]",border:"border-[#8B4513]",outline:"outline-[#8B4513]",glow:"shadow-[0_0_15px_#8B4513]"}},wo={blue:{r:37,g:99,b:235},purple:{r:147,g:51,b:234},red:{r:220,g:38,b:38},green:{r:22,g:163,b:74},yellow:{r:234,g:179,b:8},orange:{r:249,g:115,b:22},pink:{r:236,g:72,b:153},brown:{r:139,g:69,b:19}},ui={blue:"text-blue-400 drop-shadow-[0_0_4px_rgba(59,130,246,0.8)]",purple:"text-purple-400 drop-shadow-[0_0_4px_rgba(168,85,247,0.8)]",red:"text-red-500 drop-shadow-[0_0_4px_rgba(239,68,68,0.8)]",green:"text-green-400 drop-shadow-[0_0_4px_rgba(34,197,94,0.8)]",yellow:"text-yellow-400 drop-shadow-[0_0_4px_rgba(234,179,8,0.8)]",orange:"text-orange-400 drop-shadow-[0_0_4px_rgba(249,115,22,0.8)]",pink:"text-pink-400 drop-shadow-[0_0_4px_rgba(236,72,153,0.8)]",brown:"text-[#A0522D] drop-shadow-[0_0_4px_rgba(139,69,19,0.8)]"},Ot=["blue","purple","red","green","yellow","orange","pink","brown"],fi=["Setup","Main","Commit","Scoring"],Rt=()=>Object.fromEntries(Object.entries(ht).map(([e,t])=>[e,t.imageUrl])),pi=new Proxy({},{get(e,t){return Rt()[t]},ownKeys(){return Object.keys(Rt())},has(e,t){return t in Rt()},getOwnPropertyDescriptor(e,t){const r=Rt()[t];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),Dt=()=>Object.fromEntries(Object.entries(ht).map(([e,t])=>[e,t.description])),yi=new Proxy({},{get(e,t){return Dt()[t]},ownKeys(){return Object.keys(Dt())},has(e,t){return t in Dt()},getOwnPropertyDescriptor(e,t){const r=Dt()[t];return r!==void 0?{enumerable:!0,configurable:!0,value:r}:void 0}}),_o=()=>Object.entries(ht).filter(([e,t])=>e!=="Resurrected"&&(!t.allowedPanels||t.allowedPanels.includes("COUNTER_PANEL"))).sort(([,e],[,t])=>e.sortOrder-t.sortOrder).map(([e,t])=>({type:e,label:t.name}));_o();const je="readyDeploy",$e="readySetup",He="readyCommit",Pe=(e,t,r)=>e.statuses?e.statuses.some(a=>a.type===t&&(r===void 0||a.addedByPlayerId===r)):!1,Ge=(e,t)=>e.statuses?e.statuses.some(r=>r.type===t):!1,bo=(e,t,r)=>r===1&&Ge(e,$e),So=(e,t,r,a,n)=>!!(r&&Ge(e,je)||t===1&&a&&Ge(e,$e)||t===3&&n&&Ge(e,He)),Ht=e=>{e.statuses&&(e.statuses=e.statuses.filter(t=>t.type!==je&&t.type!==$e&&t.type!==He))},ut=(e,t,r,a)=>Math.abs(e-r)+Math.abs(t-a)===1,Ao=[{baseId:"ipDeptAgent",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:2,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,placeAllAtOnce:!0})},{baseId:"ipDeptAgent",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"IP_AGENT_THREAT_SCORING",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"tacticalAgent",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0})},{baseId:"tacticalAgent",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",r)}})},{baseId:"patrolAgent",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"patrolAgent",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"riotAgent",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"riotAgent",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Threat",onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"threatAnalyst",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"mrPearlDoF",activationType:"deploy",getAction:(e,t,r,a)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Unit",actionType:"RETRIEVE_FROM_DECK"}})},{baseId:"vigilantSpotter",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"codeKeeper",activationType:"deploy",getAction:(e,t,r,a)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>{var o;return n.ownerId!==r&&((o=n.statuses)==null?void 0:o.some(i=>i.type==="Threat"))}},sourceCard:e,sourceCoords:a})},{baseId:"codeKeeper",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.ownerId!==r&&Pe(n,"Exploit",r)}})},{baseId:"centurion",activationType:"commit",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"SACRIFICE_AND_BUFF_LINES",filter:(n,o,i)=>{var s;return n.ownerId===r&&((s=n.types)==null?void 0:s.includes("Unit"))&&o!==void 0&&i!==void 0}}})},{baseId:"recklessProvocateur",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SWAP_POSITIONS",sourceCard:e,sourceCoords:a,payload:{filter:(n,o,i)=>ut(o,i,a.row,a.col)}})},{baseId:"recklessProvocateur",activationType:"commit",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"TRANSFER_ALL_STATUSES",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.id===e.id?!1:n.ownerId===r}})},{baseId:"dataLiberator",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"cautiousAvenger",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCoords:a,maxOrthogonalDistance:2,sourceCard:e})},{baseId:"cautiousAvenger",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",r)}})},{baseId:"inventiveMaker",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:e,sourceCoords:a,payload:{tokenName:"Recon Drone"}})},{baseId:"inventiveMaker",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"OPEN_MODAL",mode:"RETRIEVE_DEVICE",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"faber",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,originalOwnerId:r,payload:{actionType:"SELECT_HAND_FOR_DISCARD_THEN_SPAWN",tokenName:"Walking Turret",filter:n=>n.ownerId===r}})},{baseId:"censor",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"censor",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,requiredTargetStatus:"Exploit",requireStatusFromSourceOwner:!0,sourceCoords:a,sourceCard:e,replaceStatus:!0})},{baseId:"princeps",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"PRINCEPS_SHIELD_THEN_AIM",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"princeps",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",r)}})},{baseId:"immunis",activationType:"deploy",supportRequired:!0,getAction:(e,t,r,a)=>Pe(e,"Support",r)?{type:"OPEN_MODAL",mode:"IMMUNIS_RETRIEVE",sourceCard:e,sourceCoords:a,payload:{filter:(n,o)=>ut(n,o,a.row,a.col)}}:null},{baseId:"devoutSynthetic",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"RIOT_PUSH",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"devoutSynthetic",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:(n,o,i)=>ut(o,i,a.row,a.col)&&n.ownerId!==r&&(Pe(n,"Threat",r)||Pe(n,"Stun",r))}})},{baseId:"unwaveringIntegrator",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"unwaveringIntegrator",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"INTEGRATOR_LINE_SELECT",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"signalProphet",activationType:"deploy",getAction:(e,t,r,a)=>({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Exploit",filter:n=>n.ownerId===r&&Pe(n,"Support",r)},sourceCard:e,sourceCoords:a})},{baseId:"signalProphet",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.ownerId===r&&Pe(n,"Exploit",r)}})},{baseId:"zealousMissionary",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"zealousMissionary",activationType:"commit",supportRequired:!0,getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"ZEALOUS_WEAKEN",sourceCard:e,sourceCoords:a,payload:{filter:n=>Pe(n,"Exploit",r)}})},{baseId:"walkingTurret",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"walkingTurret",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"MODIFY_POWER",amount:-1,filter:n=>Pe(n,"Aim",r)}})},{baseId:"reconDrone",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:a,payload:{allowSelf:!1,range:"global"}})},{baseId:"reconDrone",activationType:"commit",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"REVEAL_ENEMY",sourceCard:e,sourceCoords:a,payload:{filter:(n,o,i)=>ut(o,i,a.row,a.col)&&n.ownerId!==r}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"GAWAIN_DEPLOY_SHIELD_AIM",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"abrGawain",baseIdAlt:["autonomousBattleRobot"],activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",r)}})},{baseId:"reclaimedGawain",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_RIOT_PUSH",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"reclaimedGawain",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:(n,o,i)=>ut(o,i,a.row,a.col)&&n.ownerId!==r&&(Pe(n,"Threat",r)||Pe(n,"Stun",r))}})},{baseId:"FalkPD",activationType:"deploy",getAction:(e,t,r,a)=>({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:e,payload:{filterType:"Any"}})},{baseId:"FalkPD",activationType:"commit",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Revealed",count:1,onlyFaceDown:!0,excludeOwnerId:r})},{baseId:"edithByron",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SHIELD_SELF_THEN_SPAWN",sourceCard:e,sourceCoords:a,payload:{tokenName:"Recon Drone"}})},{baseId:"edithByron",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"PATROL_MOVE",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"pinkunonekoSV",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Stun",count:1,onlyOpponents:!0,mustBeAdjacentToSource:!0,sourceCoords:a,sourceCard:e})},{baseId:"pinkunonekoSV",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:(n,o,i)=>ut(o,i,a.row,a.col)&&(Pe(n,"Threat",r)||Pe(n,"Stun",r)),chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:1,allowSelf:!0}}}})},{baseId:"EleftheriaMD",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Aim",count:1})},{baseId:"EleftheriaMD",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"DESTROY",filter:n=>Pe(n,"Aim",r)}})},{baseId:"ziusIJ",activationType:"deploy",getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1})},{baseId:"ziusIJ",activationType:"setup",supportRequired:!0,getAction:(e,t,r,a)=>({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:e,sourceCoords:a,recordContext:!0,chainedAction:{type:"ENTER_MODE",mode:"ZIUS_LINE_SELECT",sourceCard:e,sourceCoords:a,payload:{actionType:"ZIUS_SCORING"}}})},{baseId:"secretInformant",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_DECK",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"reverendOfTheChoir",activationType:"setup",getAction:(e,t,r,a)=>({type:"REVEREND_SETUP_SCORE",sourceCard:e,sourceCoords:a,ownerId:r})},{baseId:"reverendOfTheChoir",activationType:"deploy",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"REVEREND_DOUBLE_EXPLOIT",sourceCard:e,sourceCoords:a,payload:{}})},{baseId:"luciusTheImmortal",activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:e,sourceCoords:a,payload:{actionType:"LUCIUS_SETUP",filter:n=>n.ownerId===r}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"setup",getAction:(e,t,r,a)=>({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:e,sourceCoords:a,payload:{filter:n=>n.ownerId===r,range:2}})},{baseId:"finnMW",baseIdAlt:["finnSD"],activationType:"commit",getAction:(e,t,r,a)=>({type:"GLOBAL_AUTO_APPLY",payload:{customAction:"FINN_SCORING"},sourceCard:e,sourceCoords:a})}],tr=e=>{const t=e.baseId||"";return Ao.filter(r=>{var a;return r.baseId===t||((a=r.baseIdAlt)==null?void 0:a.includes(t))})},Co=e=>{const r=tr(e).map(a=>a.activationType);return[...new Set(r)]},Aa=(e,t,r,a)=>{var i;if(r!==e.ownerId)return!1;if(a&&e.ownerId!==void 0){const s=a.players.find(d=>d.id===e.ownerId);if(s!=null&&s.isDummy&&a.activePlayerId!==e.ownerId)return!1}if((i=e.statuses)!=null&&i.some(s=>s.type==="Stun"))return!1;const n=tr(e),o=t===1&&n.some(s=>s.activationType==="setup")||t===3&&n.some(s=>s.activationType==="commit");if(t===1){const s=n.find(d=>d.activationType==="setup");if(s&&Ge(e,$e))return!(s.supportRequired&&!Pe(e,"Support",r))}if(t===3){const s=n.find(d=>d.activationType==="commit");if(s&&Ge(e,He))return!(s.supportRequired&&!Pe(e,"Support",r))}if(!o){const s=n.find(d=>d.activationType==="deploy");if(s&&Ge(e,je))return!(s.supportRequired&&!Pe(e,"Support",r))}return!1},Ro=(e,t,r,a)=>{if(r!==e.ownerId)if(e.ownerId!==void 0){const d=t.players.find(l=>l.id===e.ownerId);if(!(d!=null&&d.isDummy))return null}else return null;const n=tr(e),o=e.ownerId??r??0,i=t.currentPhase,s=i===1&&n.some(d=>d.activationType==="setup")||i===3&&n.some(d=>d.activationType==="commit");if(i===1){const d=n.find(l=>l.activationType==="setup");if(d&&Ge(e,$e)){if(d.supportRequired&&!Pe(e,"Support",o))return null;const l=d.getAction(e,t,o,a);if(l)return{...l,readyStatusToRemove:$e}}}if(i===3){const d=n.find(l=>l.activationType==="commit");if(d&&Ge(e,He)){if(d.supportRequired&&!Pe(e,"Support",o))return null;const l=d.getAction(e,t,o,a);if(l)return{...l,readyStatusToRemove:He}}}if(!s){const d=n.find(l=>l.activationType==="deploy");if(d&&Ge(e,je)){if(d.supportRequired&&!Pe(e,"Support",o))return null;const l=d.getAction(e,t,o,a);if(l)return{...l,isDeployAbility:!0,readyStatusToRemove:je}}}return null},y={info:(...e)=>{},warn:(...e)=>{console.warn(...e)},error:(...e)=>{console.error(...e)},debug:(...e)=>{}},Do=(e,t)=>t===1&&Ge(e,$e)?$e:t===3&&Ge(e,He)?He:Ge(e,je)?je:null,hi=(e,t)=>{var i;let r,a;typeof t=="object"?(r=t.currentPhase,a=t):r=t;const n=a==null?void 0:a.activePlayerId;return n===void 0||e.ownerId!==n||(i=e.statuses)!=null&&i.some(s=>s.type==="Stun")||!Do(e,r)?!1:Aa(e,r,e.ownerId,a)},Ca=(e,t,r)=>{var s;let a;if(typeof t=="object"?(a=t.currentPhase,r=t.activePlayerId??void 0):a=t,r===void 0||e.ownerId!==r||(s=e.statuses)!=null&&s.some(d=>d.type==="Stun"))return!1;const n=Ge(e,je),o=Ge(e,$e),i=Ge(e,He);return So(e,a,n,o,i)},rr=(e,t)=>{e.statuses||(e.statuses=[]);const r=Co(e);for(const a of r){let n="";a==="deploy"?n=je:a==="setup"?n=$e:a==="commit"&&(n=He),n&&(e.statuses.some(i=>i.type===n)||e.statuses.push({type:n,addedByPlayerId:t}))}},Po=(e,t)=>{const r=fa("setup"),a=fa("commit");for(let n=0;n<e.board.length;n++)for(let o=0;o<e.board[n].length;o++){const s=e.board[n][o].card;if(!s||s.ownerId!==t)continue;const d=s.baseId||s.id;if(d){if(y.debug(`[resetReadyStatusesForTurn] Processing card: ${s.name} (baseId: ${d}, ownerId: ${s.ownerId})`),s.statuses||(s.statuses=[]),r.includes(d)){const l=s.statuses.some(c=>c.type===$e);s.statuses=s.statuses.filter(c=>c.type!==$e),s.statuses.push({type:$e,addedByPlayerId:t}),l||y.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_SETUP to ${s.name}`)}else s.statuses=s.statuses.filter(l=>l.type!==$e);if(a.includes(d)){const l=s.statuses.some(c=>c.type===He);s.statuses=s.statuses.filter(c=>c.type!==He),s.statuses.push({type:He,addedByPlayerId:t}),l||y.debug(`[resetReadyStatusesForTurn] Added NEW READY_STATUS_COMMIT to ${s.name}`)}else s.statuses=s.statuses.filter(l=>l.type!==He)}}};function fa(e){const t=[];for(const[r,a]of Object.entries(er))(a.abilities||[]).some(o=>o.activationType===e)&&t.push(r);return t}function Ie(e){const t=e,r=t==null?void 0:t.targetingMode;r&&delete t.targetingMode;let a;return typeof structuredClone<"u"?a=structuredClone(e):a=JSON.parse(JSON.stringify(e)),r&&(a.targetingMode=r,t.targetingMode=r),a}const oe={MODE_CLEAR_DELAY:100,TOOLTIP_DELAY:250,RECONNECT_DELAY:3e3,DECK_SYNC_DELAY:500,FLOATING_TEXT_DURATION:1e4,INACTIVITY_TIMEOUT:3e5,GAME_CLEANUP_DELAY:3e4,PLAYER_DUMMY_DELAY:12e4,NO_TARGET_DURATION:2e3,HIGHLIGHT_DURATION:1e3,COPY_SUCCESS_DURATION:1500,LINK_COPY_SUCCESS_DURATION:2e3,DRAG_END_FALLBACK:500,DEBOUNCE_SHORT:100};function mi(e){return{r:Math.min(255,Math.round(e.r*1.3)),g:Math.min(255,Math.round(e.g*1.3)),b:Math.min(255,Math.round(e.b*1.3))}}function Ii(e,t){return`rgba(${e.r}, ${e.g}, ${e.b}, ${t})`}function Ei(e,t){return e?wo[e]:t}function ve(){return localStorage.getItem("webrtc_enabled")==="true"}const Ra=U.createContext(null),Ti=({children:e})=>{const[t,r]=U.useState(null),[a,n]=U.useState({}),[o,i]=U.useState("lg"),s=U.useCallback((b,R={},I="lg")=>{r(b),n(R),i(I)},[]),d=U.useCallback(()=>{r(null),n({}),i("lg")},[]),l=U.useCallback(b=>t===b,[t]),c=U.useCallback(()=>a,[a]),A=U.useCallback(()=>o,[o]),f={openModal:t,modalData:a,modalSize:o,open:s,close:d,isOpen:l,getData:c,getSize:A};return co.jsx(Ra.Provider,{value:f,children:e})},Mt=()=>{const e=U.useContext(Ra);if(!e)throw new Error("useModals must be used within ModalsProvider");return e},gi=()=>{const{open:e,close:t,isOpen:r}=Mt();return{isOpen:r("rules"),open:a=>e("rules",a,"full"),close:t}},wi=()=>{const{open:e,close:t,isOpen:r}=Mt();return{isOpen:r("settings"),open:a=>e("settings",a,"md"),close:t}},_i=()=>{const{open:e,close:t,isOpen:r,getData:a}=Mt();return{isOpen:r("joinGame"),open:n=>e("joinGame",n,"lg"),close:t,getData:()=>a()}},bi=()=>{const{open:e,close:t,isOpen:r}=Mt();return{isOpen:r("deckBuilder"),open:a=>e("deckBuilder",a,"full"),close:t}},gt="webrtc_game_state",wt="webrtc_host_data",_t="webrtc_guest_data",ko="webrtc_current_host_peerId",Oo=30*60*1e3;function ar(){return Date.now()}function St(e){return Date.now()-e<Oo}function vo(e){try{const t={...e,timestamp:ar()};localStorage.setItem(wt,JSON.stringify(t)),y.info("[WebRTC Persistence] Saved host data:",{peerId:t.peerId})}catch(t){y.error("[WebRTC Persistence] Failed to save host data:",t)}}function Ft(e){try{const t={...e,timestamp:ar()};localStorage.setItem(_t,JSON.stringify(t)),y.info("[WebRTC Persistence] Saved guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId})}catch(t){y.error("[WebRTC Persistence] Failed to save guest data:",t)}}function mt(e){try{const t={...e,timestamp:ar()};localStorage.setItem(gt,JSON.stringify(t)),y.info("[WebRTC Persistence] Saved game state, timestamp:",new Date(t.timestamp).toISOString())}catch(t){y.error("[WebRTC Persistence] Failed to save game state:",t)}}function Da(){try{const e=localStorage.getItem(wt);if(!e)return null;const t=JSON.parse(e);return St(t.timestamp)?(y.info("[WebRTC Persistence] Loaded valid host data:",{peerId:t.peerId}),t):(y.info("[WebRTC Persistence] Host data expired, removing"),localStorage.removeItem(wt),null)}catch(e){return y.error("[WebRTC Persistence] Failed to load host data:",e),localStorage.removeItem(wt),null}}function Pa(){try{const e=localStorage.getItem(_t);if(!e)return null;const t=JSON.parse(e);return St(t.timestamp)?(y.info("[WebRTC Persistence] Loaded valid guest data:",{hostPeerId:t.hostPeerId,playerId:t.playerId}),t):(y.info("[WebRTC Persistence] Guest data expired, removing"),localStorage.removeItem(_t),null)}catch(e){return y.error("[WebRTC Persistence] Failed to load guest data:",e),localStorage.removeItem(_t),null}}function pa(){try{const e=localStorage.getItem(gt);if(!e)return null;const t=JSON.parse(e);return St(t.timestamp)?(y.info("[WebRTC Persistence] Loaded valid game state, timestamp:",new Date(t.timestamp).toISOString()),t):(y.info("[WebRTC Persistence] Game state expired, removing"),localStorage.removeItem(gt),null)}catch(e){return y.error("[WebRTC Persistence] Failed to load game state:",e),localStorage.removeItem(gt),null}}function rt(){localStorage.removeItem(gt),localStorage.removeItem(wt),localStorage.removeItem(_t),localStorage.removeItem(ko)}function Zt(e,t){try{const r=`webrtc_host_${t}`,a={peerId:e,gameId:t,timestamp:Date.now()};localStorage.setItem(r,JSON.stringify(a)),y.debug(`[WebRTC Persistence] Broadcasted host peerId for game ${t}:`,e)}catch(r){y.error("[WebRTC Persistence] Failed to broadcast host peerId:",r)}}function Bt(e){try{const t=`webrtc_host_${e}`,r=localStorage.getItem(t);if(!r)return null;const a=JSON.parse(r);return Date.now()-a.timestamp>15e3?null:{peerId:a.peerId,timestamp:a.timestamp}}catch(t){return y.error("[WebRTC Persistence] Failed to get host peerId:",t),null}}function ya(e){try{const t=`webrtc_host_${e}`;localStorage.removeItem(t),y.debug(`[WebRTC Persistence] Cleared host peerId broadcast for game ${e}`)}catch(t){y.error("[WebRTC Persistence] Failed to clear host peerId broadcast:",t)}}function No(){const e=sessionStorage.getItem("invite_host_id"),t=sessionStorage.getItem("invite_auto_join");if(e&&t)return"none";const r=Da();if(r&&St(r.timestamp))return"host";const a=Pa();return a&&St(a.timestamp)?"guest":"none"}const ha=7,Wt="mrPearlDoF",Mo="reverendOfTheChoir",Lo="threatAnalyst";function Go(e,t){return e!=null&&e.statuses?e.statuses.some(r=>r.type==="Exploit"&&r.addedByPlayerId!==void 0&&t.has(r.addedByPlayerId)):!1}function xo(e){return typeof structuredClone<"u"?structuredClone(e):JSON.parse(JSON.stringify(e))}const ka=()=>Array(ha).fill(null).map(()=>Array(ha).fill(null).map(()=>({card:null}))),Le=e=>{var I,g,u,D,E;const{board:t,activeGridSize:r,players:a}=e,n=xo(t),o=n.length,i=Math.floor((o-r)/2),s=new Map;a.forEach(h=>s.set(h.id,h.teamId));for(let h=0;h<o;h++)for(let w=0;w<o;w++){const T=n[h][w].card;T&&(T.statuses&&(T.statuses=T.statuses.filter(N=>N.type!=="Support"&&N.type!=="Threat")),delete T.bonusPower)}for(let h=0;h<o;h++)for(let w=0;w<o;w++){const T=n[h][w].card;if((T==null?void 0:T.ownerId)===void 0||T.isFaceDown)continue;const N=T.ownerId,L=s.get(N),M=[{r:h-1,c:w},{r:h+1,c:w},{r:h,c:w-1},{r:h,c:w+1}],_={};let m=!1;for(const G of M){const{r:C,c:O}=G;if(C>=0&&C<o&&O>=0&&O<o){const $=n[C][O].card,B=(I=$==null?void 0:$.statuses)==null?void 0:I.some(X=>X.type==="Stun");if(($==null?void 0:$.ownerId)!==void 0&&!$.isFaceDown&&!B){const X=$.ownerId,q=s.get(X);N===X||L!==void 0&&L===q?m=!0:(_[X]||(_[X]=[]),_[X].push({r:C,c:O}))}}}m&&(T.statuses||(T.statuses=[]),T.statuses.some(G=>G.type==="Support")||T.statuses.push({type:"Support",addedByPlayerId:N}));let v=null;for(const G in _){const C=_[G];if(C&&C.length>=2){v=parseInt(G,10);break}}if(v===null&&h>=i&&h<i+r&&w>=i&&w<i+r){const C=h===i||h===i+r-1||w===i||w===i+r-1,O=Object.keys(_).length>0;if(C&&O){const $=Object.keys(_)[0];$&&(v=parseInt($,10))}}v!==null&&(T.statuses||(T.statuses=[]),T.statuses.some(G=>G.type==="Threat")||T.statuses.push({type:"Threat",addedByPlayerId:v}))}const d=new Set;for(let h=0;h<o;h++)for(let w=0;w<o;w++){const T=n[h][w].card,N=(g=T==null?void 0:T.statuses)==null?void 0:g.some(L=>L.type==="Stun");if((T==null?void 0:T.baseId)===Lo&&!T.isFaceDown&&T.ownerId!==void 0&&!N){const L=[{r:h-1,c:w},{r:h+1,c:w},{r:h,c:w-1},{r:h,c:w+1}];let M=!1;const _=T.ownerId,m=s.get(_);for(const v of L){const{r:G,c:C}=v;if(G>=0&&G<o&&C>=0&&C<o){const O=n[G][C].card;if((O==null?void 0:O.ownerId)!==void 0&&!O.isFaceDown){const $=O.ownerId,B=s.get($),X=_===$||m!==void 0&&m===B,q=(u=O==null?void 0:O.statuses)==null?void 0:u.some(K=>K.type==="Stun");if(X&&!q){M=!0;break}}}}M&&d.add(_)}}for(let h=0;h<o;h++)for(let w=0;w<o;w++){const T=n[h][w].card;if(!T||T.isFaceDown||T.ownerId===void 0)continue;const N=T.ownerId,L=s.get(N),M=[{r:h-1,c:w},{r:h+1,c:w},{r:h,c:w-1},{r:h,c:w+1}],_={};for(const v of M){const{r:G,c:C}=v;if(G>=0&&G<o&&C>=0&&C<o){const O=n[G][C].card,$=(D=O==null?void 0:O.statuses)==null?void 0:D.some(B=>B.type==="Stun");if((O==null?void 0:O.ownerId)!==void 0&&!O.isFaceDown&&!$){const B=O.ownerId,X=s.get(B);if(!(N===B||L!==void 0&&L===X)){const K=d.has(B),V=Go(T,d);K&&V&&(_[B]||(_[B]=0),_[B]++)}}}}if(Object.keys(_).length>0){T.statuses||(T.statuses=[]);const v=Object.keys(_).map(G=>parseInt(G,10));for(const G of v)T.statuses.some(C=>C.type==="Threat"&&C.addedByPlayerId===G)||T.statuses.push({type:"Threat",addedByPlayerId:G})}}const l=[],c=[];for(let h=0;h<o;h++)for(let w=0;w<o;w++){const T=n[h][w].card,N=(E=T==null?void 0:T.statuses)==null?void 0:E.some(L=>L.type==="Stun");T!=null&&T.baseId&&!T.isFaceDown&&T.ownerId!==void 0&&!N&&(T.baseId===Mo?l.push({r:h,c:w,ownerId:T.ownerId,baseId:T.baseId}):T.baseId===Wt&&c.push({r:h,c:w,ownerId:T.ownerId,baseId:T.baseId}))}const A=new Set,f=new Set;for(const h of l){const{r:w,c:T,ownerId:N}=h,L=`${w}-${N}`;if(!A.has(L)){A.add(L);for(let _=0;_<o;_++){const m=n[w][_].card;m&&m.ownerId===N&&!m.isFaceDown&&(m.statuses||(m.statuses=[]),m.statuses.some(v=>v.type==="Support")||m.statuses.push({type:"Support",addedByPlayerId:N}))}}const M=`${T}-${N}`;if(!f.has(M)){f.add(M);for(let _=0;_<o;_++){const m=n[_][T].card;m&&m.ownerId===N&&!m.isFaceDown&&(m.statuses||(m.statuses=[]),m.statuses.some(v=>v.type==="Support")||m.statuses.push({type:"Support",addedByPlayerId:N}))}}}const b=new Set,R=new Set;for(const h of c){const{r:w,c:T,ownerId:N}=h,L=`${w}-${N}`;if(!b.has(L)){b.add(L);for(let _=0;_<o;_++){const m=n[w][_].card;m&&m.ownerId===N&&!m.isFaceDown&&m.baseId!==Wt&&(m.bonusPower=(m.bonusPower||0)+1)}}const M=`${T}-${N}`;if(!R.has(M)){R.add(M);for(let _=0;_<o;_++){const m=n[_][T].card;m&&m.ownerId===N&&!m.isFaceDown&&m.baseId!==Wt&&(m.bonusPower=(m.bonusPower||0)+1)}}}return n};var it=(e=>(e[e.CARD_REGISTRY=1]="CARD_REGISTRY",e[e.CARD_STATE=2]="CARD_STATE",e[e.ABILITY_EFFECT=3]="ABILITY_EFFECT",e[e.SESSION_EVENT=4]="SESSION_EVENT",e))(it||{});function Uo(){const e={baseIdToIndex:new Map,indexToBaseId:new Map,cardDefinitions:[],statusTypes:[]},t=new Set,r=Array.from(er.values());for(const a of r)if(a.baseId&&!t.has(a.baseId)){t.add(a.baseId);const n=e.cardDefinitions.length;e.baseIdToIndex.set(a.baseId,n),e.indexToBaseId.set(n,a.baseId),e.cardDefinitions.push({baseId:a.baseId,name:a.name,imageUrl:a.imageUrl,power:a.power,ability:a.ability||"",types:a.types||[],faction:a.faction||""})}return e.statusTypes=["Stun","Aim","Exploit","Poison","Shield","Riot","Flying","Deploy","Setup","Commit","LastPlayed","readyDeploy","readySetup","readyCommit"],y.info(`[CardRegistry] Built registry with ${e.cardDefinitions.length} cards, ${e.statusTypes.length} status types`),e}function Oa(e,t){let r=0;for(const a of e||[]){const n=t.statusTypes.indexOf(a.type);n>=0&&n<32&&(r|=1<<n)}return r>>>0}function va(e,t,r){const a=[];for(let n=0;n<32;n++)if(e&1<<n){const o=r.statusTypes[n];o&&a.push({type:o,addedByPlayerId:t})}return a}function Na(e){let t=0;return e.isFaceDown&&(t|=1),e.enteredThisTurn&&(t|=2),e.revealedTo==="all"&&(t|=4),t}function Yt(e,t){const r=new Uint8Array(13);let a=0;const n=nr(e.id);r[a++]=n>>24&255,r[a++]=n>>16&255,r[a++]=n>>8&255,r[a++]=n&255;const o=e.baseId?t.baseIdToIndex.get(e.baseId)??0:0;r[a++]=o>>8&255,r[a++]=o&255,r[a++]=(e.ownerId??0)&255;const i=Math.round(e.power||0);r[a++]=Math.clamp(i,-128,127)&255,r[a++]=Na(e);const s=Oa(e.statuses||[],t);return r[a++]=s>>24&255,r[a++]=s>>16&255,r[a++]=s>>8&255,r[a++]=s&255,r}function $o(e,t){const r=new Uint8Array(9);let a=0;const n=nr(e.id);r[a++]=n>>24&255,r[a++]=n>>16&255,r[a++]=n>>8&255,r[a++]=n&255,r[a++]=Na(e);const o=Oa(e.statuses||[],t);return r[a++]=o>>24&255,r[a++]=o>>16&255,r[a++]=o>>8&255,r[a++]=o&255,r}function nr(e){let t=0;for(let r=0;r<e.length;r++){const a=e.charCodeAt(r);t=(t<<5)-t+a,t=t&t}return t>>>0}function Ho(e,t,r){var I;const a=[],n=Date.now(),o=new Uint8Array(7);o[0]=it.CARD_STATE,o[1]=n>>24&255,o[2]=n>>16&255,o[3]=n>>8&255,o[4]=n&255,a.push(o);const i=[],s=Math.min(e.players.length,255);i.push(new Uint8Array([s]));for(const g of e.players){i.push(new Uint8Array([g.id&255]));const u=Math.min(g.deck.length,255),D=Math.min(g.hand.length,255),E=Math.min(g.discard.length,255);i.push(new Uint8Array([u,D,E,g.announcedCard?1:0])),i.push(new Uint8Array([Math.min(g.score,255)]));const h=Math.min(g.hand.length,255);i.push(new Uint8Array([h]));const w=g.id===r;for(const N of g.hand)w?i.push(Yt(N,t)):i.push($o(N,t));const T=Math.min(g.discard.length,255);i.push(new Uint8Array([T]));for(const N of g.discard){const L=nr(N.id),M=new Uint8Array(4);M[0]=L>>24&255,M[1]=L>>16&255,M[2]=L>>8&255,M[3]=L&255,i.push(M)}g.announcedCard&&i.push(Yt(g.announcedCard,t))}const d=e.board.length;i.push(new Uint8Array([d,d,d]));const l=[];for(let g=0;g<e.board.length;g++)for(let u=0;u<((I=e.board[g])==null?void 0:I.length);u++){const D=e.board[g][u];D!=null&&D.card&&l.push({row:g,col:u,card:D.card})}const c=l.length,A=new Uint8Array(2);A[0]=c>>8&255,A[1]=c&255,i.push(A);for(const{row:g,col:u,card:D}of l)i.push(new Uint8Array([g,u])),i.push(Yt(D,t));i.push(new Uint8Array([e.currentPhase===void 0?255:Math.clamp(e.currentPhase,0,254),(e.activePlayerId??255)&255,e.currentRound===void 0?255:Math.clamp(e.currentRound,0,254)]));let f=0;for(const g of i)f+=g.length;o[5]=f>>8&255,o[6]=f&255,a.push(...i);const b=new Uint8Array(a.reduce((g,u)=>g+u.length,0));let R=0;for(const g of a)b.set(g,R),R+=g.length;return y.info(`[GameCodec] Encoded card state: ${b.length} bytes (${c} board cards, ${e.players.length} players)`),b}function Fo(e,t,r){let a=0;if(e[a++]!==it.CARD_STATE)throw new Error("Invalid message type, expected CARD_STATE");e[a++]<<24|e[a++]<<16|e[a++]<<8|e[a++],e[a++]<<8|e[a++];const n=e[a++],o=[];for(let I=0;I<n;I++){const g=e[a++],u=e[a++];e[a++],e[a++];const D=e[a++]===1,E=e[a++],h=e[a++],w=[],T=g===r;for(let m=0;m<h;m++)if(T)w.push(zt(e,a,t)),a+=13;else{const v=e[a++]<<24|e[a++]<<16|e[a++]<<8|e[a++],G=e[a++],C=e[a++]<<24|e[a++]<<16|e[a++]<<8|e[a++];w.push({id:`card_${v}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isFaceDown:(G&1)!==0,revealedTo:G&4?"all":void 0,statuses:va(C,g,t),isPlaceholder:!0})}const N=e[a++],L=[];for(let m=0;m<N;m++){const v=e[a++]<<24|e[a++]<<16|e[a++]<<8|e[a++];L.push({id:`discard_${v}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isPlaceholder:!0})}let M=null;D&&(M=zt(e,a,t),a+=13);const _=[];for(let m=0;m<u;m++)_.push({id:`deck_${g}_${m}`,name:"?",imageUrl:"",deck:"Random",power:0,ability:"",isPlaceholder:!0});o.push({id:g,name:`Player ${g}`,score:E,hand:w,deck:_,discard:L,announcedCard:M,selectedDeck:"Random",color:"blue",boardHistory:[]})}const i=e[a++];a++,a++;const s=e[a++]<<8|e[a++],d=[];for(let I=0;I<i;I++){const g=[];for(let u=0;u<i;u++)g.push({card:null});d.push(g)}for(let I=0;I<s;I++){const g=e[a++],u=e[a++],D=zt(e,a,t);a+=13,g<d.length&&u<d[g].length&&(d[g][u]={card:D})}const l=e[a++],c=e[a++],A=e[a++];return{players:o,board:d,currentPhase:l===255?void 0:l,activePlayerId:c===255?null:c,currentRound:A===255?void 0:A}}function zt(e,t,r){const n=`card_${e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++]}_${Date.now()}`,o=e[t++]<<8|e[t++],i=e[t++];let s=e[t++];s>127&&(s=s-256);const d=e[t++],l=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++],c=r.cardDefinitions[o],A=(c==null?void 0:c.baseId)||"";return{id:n,baseId:A,deck:"Random",name:(c==null?void 0:c.name)||"?",imageUrl:(c==null?void 0:c.imageUrl)||"",power:s,ability:(c==null?void 0:c.ability)||"",types:(c==null?void 0:c.types)||[],faction:(c==null?void 0:c.faction)||"",ownerId:i,isFaceDown:(d&1)!==0,enteredThisTurn:(d&2)!==0,revealedTo:d&4?"all":void 0,statuses:va(l,0,r)}}Math.clamp||(Math.clamp=function(e,t,r){return Math.min(Math.max(e,t),r)});let Kt=null;function Ma(){return Kt||(Kt=Uo()),Kt}function ma(e,t){const r=Ma();return Ho(e,r,t)}function Bo(e,t){const r=Ma();return Fo(e,r,t)}function Wo(e){return _a(e)}function La(e){y.warn("[webrtcSerialization] serializeDelta is deprecated, using MessagePack fallback");try{return lo(e)}catch(t){return y.error("[webrtcSerialization] Failed to serialize delta:",t),new Uint8Array(0)}}function Ga(e){y.warn("[webrtcSerialization] deserializeDelta is deprecated, using MessagePack fallback");try{return _a(e)}catch(t){return y.error("[webrtcSerialization] Failed to deserialize delta:",t),{}}}function Yo(e){const t=La(e);let r="";const a=new Uint8Array(t),n=a.byteLength;for(let o=0;o<n;o++)r+=String.fromCharCode(a[o]);return btoa(r)}function zo(e){const t=atob(e),r=new Uint8Array(t.length);for(let a=0;a<t.length;a++)r[a]=t.charCodeAt(a);return Ga(r)}function Ko(e,t){var A;const r=new TextEncoder,a=[],n=Date.now(),o=new Uint8Array(7);o[0]=it.ABILITY_EFFECT,o[1]=n>>24&255,o[2]=n>>16&255,o[3]=n>>8&255,o[4]=n&255,a.push(o);const i=[];if(i.push(new Uint8Array([e])),t.sourcePos){const f=(t.sourcePos.row&15)<<4|t.sourcePos.col&15;i.push(new Uint8Array([f]))}else i.push(new Uint8Array([255]));const s=((A=t.targetPositions)==null?void 0:A.length)||0;if(i.push(new Uint8Array([Math.min(s,255)])),t.targetPositions)for(const f of t.targetPositions.slice(0,255)){const b=(f.row&15)<<4|f.col&15;i.push(new Uint8Array([b]))}if(t.text){const f=r.encode(t.text),b=Math.min(f.length,255);i.push(new Uint8Array([b])),i.push(f.slice(0,b))}else i.push(new Uint8Array([0]));i.push(new Uint8Array([(t.value??0)&255])),i.push(new Uint8Array([(t.playerId??0)&255]));let d=0;for(const f of i)d+=f.length;o[5]=d>>8&255,o[6]=d&255,a.push(...i);const l=new Uint8Array(a.reduce((f,b)=>f+b.length,0));let c=0;for(const f of a)l.set(f,c),c+=f.length;return y.debug(`[AbilityMessages] Encoded effect type ${e}: ${l.length} bytes`),l}function qo(e){let t=0;if(e[t++]!==it.ABILITY_EFFECT)throw new Error("Invalid message type, expected ABILITY_EFFECT");const r=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const a={effectType:e[t++],timestamp:r,data:{}},n=e[t++];n!==255&&(a.data.sourcePos={row:n>>4&15,col:n&15});const o=e[t++];if(o>0){a.data.targetPositions=[];for(let s=0;s<o;s++){const d=e[t++];a.data.targetPositions.push({row:d>>4&15,col:d&15})}}const i=e[t++];if(i>0){const s=new TextDecoder;a.data.text=s.decode(e.subarray(t,t+i)),t+=i}return a.data.value=e[t++],a.data.playerId=e[t++],a}function jo(e,t={}){const r=new TextEncoder,a=[],n=Date.now(),o=new Uint8Array(7);o[0]=it.SESSION_EVENT,o[1]=n>>24&255,o[2]=n>>16&255,o[3]=n>>8&255,o[4]=n&255,a.push(o);const i=[];if(i.push(new Uint8Array([e])),i.push(new Uint8Array([(t.playerId??0)&255])),t.playerName){const A=r.encode(t.playerName),f=Math.min(A.length,255);i.push(new Uint8Array([f])),i.push(A.slice(0,f))}else i.push(new Uint8Array([0]));i.push(new Uint8Array([(t.startingPlayerId??0)&255])),i.push(new Uint8Array([Math.min(t.roundNumber??0,255)])),i.push(new Uint8Array([Math.min(t.newPhase??0,255)])),i.push(new Uint8Array([(t.newActivePlayerId??0)&255])),i.push(new Uint8Array([(t.gameWinner??255)&255]));let s=0;if(t.winners)for(const A of t.winners)A<32&&(s|=1<<A);i.push(new Uint8Array([s>>24&255,s>>16&255,s>>8&255,s&255]));let d=0;for(const A of i)d+=A.length;o[5]=d>>8&255,o[6]=d&255,a.push(...i);const l=new Uint8Array(a.reduce((A,f)=>A+f.length,0));let c=0;for(const A of a)l.set(A,c),c+=A.length;return y.debug(`[SessionMessages] Encoded event type ${e}: ${l.length} bytes`),l}function Vo(e){let t=0;if(e[t++]!==it.SESSION_EVENT)throw new Error("Invalid message type, expected SESSION_EVENT");const r=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];t+=2;const a={eventType:e[t++],timestamp:r,data:{}};a.data.playerId=e[t++];const n=e[t++];if(n>0){const s=new TextDecoder;a.data.playerName=s.decode(e.subarray(t,t+n)),t+=n}a.data.startingPlayerId=e[t++],a.data.roundNumber=e[t++],a.data.newPhase=e[t++],a.data.newActivePlayerId=e[t++];const o=e[t++];a.data.gameWinner=o===255?null:o;const i=e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++];if(i!==0){a.data.winners=[];for(let s=0;s<32;s++)i&1<<s&&a.data.winners.push(s)}return a}const Jo=!0;class ze{constructor(){this.peer=null,this.connections=new Map,this.isHost=!1,this.hostConnection=null,this.eventHandlers=new Set,this.isReconnecting=!1,this.guestPlayerIds=new Map,localStorage.getItem("webrtc_enabled")}async initializeAsHost(t){return this.peer&&this.cleanup(),this.isHost=!0,new Promise((r,a)=>{this.peer=t?new Ct(t):new Ct,this.peer.on("open",n=>{this.emitEvent({type:"peer_open",data:{peerId:n}}),r(n)}),this.peer.on("connection",n=>{y.info(`Guest connection request from: ${n.peer}`),this.handleGuestConnection(n)}),this.peer.on("error",n=>{y.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),a(n)}),this.peer.on("close",()=>{y.warn("WebRTC Peer closed"),this.emitEvent({type:"peer_closed"})})})}async initializeAsGuest(t){return this.peer&&this.cleanup(),this.isHost=!1,new Promise((r,a)=>{this.peer=new Ct,this.peer.on("open",n=>{const o=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(o),o.on("open",()=>{this.hostConnection=o,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}});let i=null;try{const s=localStorage.getItem("webrtc_preferred_deck");s&&(i=s,y.info(`[initializeAsGuest] Found deck preference in localStorage: ${i}`),localStorage.removeItem("webrtc_preferred_deck"))}catch(s){y.warn("[initializeAsGuest] Failed to read deck preference:",s)}this.sendMessageToHost({type:"JOIN_REQUEST",senderId:n,data:{preferredDeck:i||void 0},timestamp:Date.now()}),r()}),o.on("error",i=>{y.error("Host connection error:",i),this.emitEvent({type:"error",data:i}),a(i)})}),this.peer.on("error",n=>{y.error("WebRTC Peer error:",n),this.emitEvent({type:"error",data:n}),a(n)})})}async initializeAsReconnectingGuest(t,r){return this.peer&&this.cleanup(),this.isHost=!1,this.isReconnecting=!0,new Promise((a,n)=>{this.peer=new Ct,this.peer.on("open",o=>{const i=this.peer.connect(t,{reliable:!0,serialization:"json"});this.setupHostConnection(i),i.on("open",()=>{this.hostConnection=i,this.emitEvent({type:"connected_to_host",data:{hostPeerId:t}}),this.sendMessageToHost({type:"PLAYER_RECONNECT",senderId:o,playerId:r,timestamp:Date.now()}),this.isReconnecting=!1,a()}),i.on("error",s=>{y.error("Host connection error:",s),this.emitEvent({type:"error",data:s}),this.isReconnecting=!1,n(s)})}),this.peer.on("error",o=>{y.error("WebRTC Peer error:",o),this.emitEvent({type:"error",data:o}),this.isReconnecting=!1,n(o)})})}handleGuestConnection(t){this.connections.set(t.peer,t),t.on("open",()=>{y.info(`Guest connected: ${t.peer}`),this.emitEvent({type:"guest_connected",data:{peerId:t.peer}})}),t.on("data",r=>{this.handleMessage(r,t)}),t.on("close",()=>{y.info(`Guest disconnected: ${t.peer}`),this.connections.delete(t.peer),this.emitEvent({type:"guest_disconnected",data:{peerId:t.peer}})}),t.on("error",r=>{y.error(`Guest connection error (${t.peer}):`,r)})}setupHostConnection(t){this.hostConnection=t,t.on("data",r=>{this.handleMessage(r,t)}),t.on("close",()=>{y.warn("Host disconnected"),this.hostConnection=null,this.emitEvent({type:"host_disconnected"})}),t.on("error",r=>{y.error("Host connection error:",r)})}handleMessage(t,r){y.debug("Received WebRTC message:",t.type),this.emitEvent({type:"message_received",data:t})}sendMessageToHost(t){var r,a,n,o;if(!this.isHost&&this.hostConnection&&this.hostConnection.open)try{return this.hostConnection.send(t),(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&y.info(`[WebrtcManager] Sent ${t.type} to host`,{hasData:!!t.data,hasTargetingMode:!!((r=t.data)!=null&&r.targetingMode),targetingModePlayerId:(n=(a=t.data)==null?void 0:a.targetingMode)==null?void 0:n.playerId}),!0}catch(i){return y.error("Failed to send message to host:",i),!1}return(t.type==="SET_TARGETING_MODE"||t.type==="CLEAR_TARGETING_MODE")&&y.warn(`[WebrtcManager] Could not send ${t.type} to host`,{isHost:this.isHost,hasHostConnection:!!this.hostConnection,isConnectionOpen:((o=this.hostConnection)==null?void 0:o.open)??!1}),!1}broadcastToGuests(t,r){if(!this.isHost)return y.warn("Only host can broadcast to guests"),0;let a=0;return this.connections.forEach((n,o)=>{if(n.open&&o!==r)try{n.send(t),a++}catch(i){y.error(`Failed to send to guest ${o}:`,i)}}),y.debug(`Broadcast to ${a}/${this.connections.size} guests`),a}sendToGuest(t,r){if(!this.isHost)return y.warn("Only host can send to specific guest"),!1;const a=this.connections.get(t);if(!a)return y.error(`[sendToGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`),!1;if(!a.open)return y.error(`[sendToGuest] Connection for guest ${t} is not open`),!1;try{return a.send(r),y.debug(`Sent message to guest ${t}`),!0}catch(n){return y.error(`[sendToGuest] Failed to send message to ${t}:`,n),!1}}acceptGuest(t,r,a){var o;const n=this.connections.get(t);if(!n){y.error(`[acceptGuest] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){y.error(`[acceptGuest] Connection for guest ${t} is not open`);return}try{if(Jo){const i=ma(r,null),s={type:"JOIN_ACCEPT_BINARY",senderId:(o=this.peer)==null?void 0:o.id,playerId:a,data:i,timestamp:Date.now()};n.send(s),y.info(`Accepted guest ${t} as player ${a} (BINARY, ${i.byteLength} bytes)`)}}catch(i){y.error(`[acceptGuest] Failed to send JOIN_ACCEPT to ${t}:`,i)}}acceptGuestMinimal(t,r,a){var i;const n=this.connections.get(t);if(!n){y.error(`[acceptGuestMinimal] No connection found for guest ${t}. Available connections: ${Array.from(this.connections.keys()).join(", ")}`);return}if(!n.open){y.error(`[acceptGuestMinimal] Connection for guest ${t} is not open`);return}this.guestPlayerIds.set(t,a);const o={type:"JOIN_ACCEPT_MINIMAL",senderId:(i=this.peer)==null?void 0:i.id,playerId:a,data:r,timestamp:Date.now()};try{n.send(o),y.info(`Accepted guest ${t} as player ${a} (minimal)`)}catch(s){y.error(`[acceptGuestMinimal] Failed to send JOIN_ACCEPT_MINIMAL to ${t}:`,s)}}broadcastGameState(t,r){this.broadcastGameStateLegacy(t,r)}broadcastGameStateLegacy(t,r){let a=0;this.connections.forEach((n,o)=>{var l;if(!n.open||o===r)return;const i=this.guestPlayerIds.get(o)??null,s=ze.createPersonalizedGameState(t,i),d={type:"STATE_UPDATE_COMPACT",senderId:(l=this.peer)==null?void 0:l.id,data:{gameState:s,recipientPlayerId:i},timestamp:Date.now()};try{n.send(d),a++}catch(c){y.error(`[broadcastGameStateLegacy] Failed to send to guest ${o} (player ${i}):`,c)}}),y.debug(`[broadcastGameStateLegacy] Sent to ${a}/${this.connections.size} guests`)}static createPersonalizedGameState(t,r){return{...t,players:t.players.map(a=>{if(r!==null&&a.id===r){const o=a.deck.length??0,i=a.discard.length??0,s=a.hand.length??0;return y.debug(`[createPersonalizedGameState] Player ${a.id} (own): ${s} hand, ${o} deck, ${i} discard`),{...a,handCards:a.hand.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),deckCards:a.deck.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),discardCards:a.discard.map(d=>({id:d.id,baseId:d.baseId,power:d.power,powerModifier:d.powerModifier,isFaceDown:d.isFaceDown,statuses:d.statuses||[]})),hand:[],deck:[],discard:[],announcedCard:a.announcedCard?ze.optimizeCard(a.announcedCard):null,deckSize:o,discardSize:i,handSize:s}}else{const o=a.deckSize??a.deck.length??0,i=a.hand.filter(s=>!s.isFaceDown).length;return i>0&&y.debug(`[createPersonalizedGameState] Player ${a.id} (other): ${i} revealed, ${a.hand.length-i} face-down`),{...a,hand:a.hand.map(s=>s.isFaceDown?ze.createCardBack(s):{id:s.id,baseId:s.baseId,power:s.power,powerModifier:s.powerModifier||0,isFaceDown:s.isFaceDown,statuses:s.statuses||[],ownerId:s.ownerId,ownerName:s.ownerName,deck:s.deck}),deck:[],discard:[],announcedCard:a.announcedCard?ze.createCardBack(a.announcedCard):null,deckSize:o,handSize:a.handSize??a.hand.length??0,discardSize:a.discardSize??a.discard.length??0}}}),board:t.board.map(a=>a.map(n=>({...n,card:n.card?ze.optimizeCard(n.card):null})))}}static createCompactStateForHost(t,r){return{...t,players:t.players.map(a=>a.id===r?(y.debug(`[createCompactStateForHost] Player ${a.id} (local): sending ${a.hand.length} hand cards, ${a.deck.length} deck cards`),{...a,handCards:a.hand.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),deckCards:a.deck.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),discardCards:a.discard.map(n=>({id:n.id,baseId:n.baseId,power:n.power,powerModifier:n.powerModifier,isFaceDown:n.isFaceDown,statuses:n.statuses||[]})),hand:[],deck:[],discard:[],handSize:a.hand.length,deckSize:a.deck.length,discardSize:a.discard.length}):{...a,hand:[],deck:[],discard:[],announcedCard:null,deckSize:a.deckSize??a.deck.length??0,handSize:a.handSize??a.hand.length??0,discardSize:a.discardSize??a.discard.length??0}),board:t.board.map(a=>a.map(n=>({...n,card:n.card?ze.optimizeCard(n.card):null})))}}static optimizeCard(t){return{id:t.id,baseId:t.baseId,name:t.name,power:t.power,powerModifier:t.powerModifier,ability:t.ability,ownerId:t.ownerId,color:t.color,deck:t.deck,isFaceDown:t.isFaceDown,types:t.types,faction:t.faction,statuses:t.statuses||[],hasRevealToken:t.hasRevealToken||!1,imageUrl:t.imageUrl}}static createCardBack(t){return{id:t.id,baseId:t.baseId,name:t.name,isFaceDown:t.isFaceDown,hasRevealToken:t.hasRevealToken||!1,statuses:t.statuses||[]}}broadcastStateDelta(t,r){var a,n;{const o=Yo(t),i={type:"STATE_DELTA_BINARY",senderId:(a=this.peer)==null?void 0:a.id,data:o,timestamp:Date.now()};y.info(`[broadcastStateDelta] Sending BINARY STATE_DELTA (base64): ${o.length} chars, playerDeltas=${Object.keys(t.playerDeltas||{}).length}, boardCells=${((n=t.boardCells)==null?void 0:n.length)||0}`),this.broadcastToGuests(i,r),y.info(`[broadcastStateDelta] Sent STATE_DELTA from player ${t.sourcePlayerId} to ${this.connections.size} guests`)}}broadcastCardState(t,r,a){var n;try{const o=ma(t,r),i=btoa(String.fromCharCode(...o)),s={type:"CARD_STATE",senderId:(n=this.peer)==null?void 0:n.id,data:i,timestamp:Date.now()},d=this.broadcastToGuests(s,a);return y.info(`[broadcastCardState] Sent ${o.length} bytes to ${d} guests`),d}catch(o){return y.error("[broadcastCardState] Failed to encode/broadcast state:",o),0}}broadcastAbilityEffect(t,r,a){var n;try{const o=Ko(t,r),i=btoa(String.fromCharCode(...o)),s={type:"ABILITY_EFFECT",senderId:(n=this.peer)==null?void 0:n.id,data:i,timestamp:Date.now()},d=this.broadcastToGuests(s,a);return y.debug(`[broadcastAbilityEffect] Sent effect ${t} to ${d} guests`),d}catch(o){return y.error("[broadcastAbilityEffect] Failed to encode/broadcast effect:",o),0}}broadcastSessionEvent(t,r,a){var n;try{const o=jo(t,r),i=btoa(String.fromCharCode(...o)),s={type:"SESSION_EVENT",senderId:(n=this.peer)==null?void 0:n.id,data:i,timestamp:Date.now()},d=this.broadcastToGuests(s,a);return y.debug(`[broadcastSessionEvent] Sent event ${t} to ${d} guests`),d}catch(o){return y.error("[broadcastSessionEvent] Failed to encode/broadcast event:",o),0}}sendAction(t,r){var n;const a={type:"ACTION",senderId:(n=this.peer)==null?void 0:n.id,data:{actionType:t,actionData:r},timestamp:Date.now()};return this.sendMessageToHost(a)}sendStateDelta(t){var r;{const a=La(t),n={type:"STATE_DELTA_BINARY",senderId:(r=this.peer)==null?void 0:r.id,data:a,timestamp:Date.now()};return this.sendMessageToHost(n)}}sendStateToHost(t,r){var i,s,d;if(r===null)return y.warn("[sendStateToHost] No local player ID, cannot send state to host"),!1;const a=ze.createCompactStateForHost(t,r),n=t.players.find(l=>l.id===r);n&&y.info(`[sendStateToHost] Player ${r} sending compact state: hand=${((i=n.hand)==null?void 0:i.length)??0}, deck=${((s=n.deck)==null?void 0:s.length)??0}`);const o={type:"STATE_UPDATE_COMPACT",senderId:(d=this.peer)==null?void 0:d.id,playerId:r,data:{gameState:a},timestamp:Date.now()};return this.sendMessageToHost(o)}sendFullDeckToHost(t,r,a){var o;const n={type:"DECK_DATA_UPDATE",senderId:(o=this.peer)==null?void 0:o.id,playerId:t,data:{playerId:t,deck:r.map(i=>ze.optimizeCard(i)),deckSize:a},timestamp:Date.now()};return this.sendMessageToHost(n)}sendCustomDeckData(t,r,a){var i;if(!a)return!0;y.info(`[sendCustomDeckData] Player ${t} sending ${r.length} custom deck cards to host`);const n=r.map(s=>({id:s.id,baseId:s.baseId,name:s.name,power:s.power,powerModifier:s.powerModifier,ability:s.ability,types:s.types,faction:s.faction,imageUrl:s.imageUrl,color:s.color,deck:s.deck})),o={type:"CUSTOM_DECK_DATA",senderId:(i=this.peer)==null?void 0:i.id,playerId:t,data:{playerId:t,deckCards:n},timestamp:Date.now()};return this.sendMessageToHost(o)}getConnectionInfo(){const t=[];return this.isHost?this.connections.forEach((r,a)=>{t.push({peerId:a,playerId:null,playerName:null,connected:r.open})}):this.hostConnection&&t.push({peerId:this.hostConnection.peer,playerId:null,playerName:null,connected:this.hostConnection.open}),t}getPeerId(){var t;return((t=this.peer)==null?void 0:t.id)||null}getHostPeerId(){var t,r;return this.isHost?((t=this.peer)==null?void 0:t.id)||null:((r=this.hostConnection)==null?void 0:r.peer)||null}isConnected(){return this.isHost?this.peer!==null&&this.connections.size>0:this.hostConnection!==null&&this.hostConnection.open}isHostMode(){return this.isHost}getConnectionCount(){var t;return this.isHost?this.connections.size:(t=this.hostConnection)!=null&&t.open?1:0}on(t){return this.eventHandlers.add(t),()=>this.eventHandlers.delete(t)}emitEvent(t){this.eventHandlers.forEach(r=>{try{r(t)}catch(a){y.error("Error in WebRTC event handler:",a)}})}cleanup(){this.connections.forEach(t=>t.close()),this.connections.clear(),this.hostConnection&&(this.hostConnection.close(),this.hostConnection=null),this.peer&&(this.peer.destroy(),this.peer=null),this.isHost=!1}}let qt=null;const Xo=()=>(qt||(qt=new ze),qt);function Zo(e){return 10+e*10}function or(e){if(!e.isGameStarted)return{shouldEnd:!1,roundWinners:[]};const t=e.currentPhase===1,r=e.activePlayerId===e.startingPlayerId;if(!t||!r)return{shouldEnd:!1,roundWinners:[]};const a=e.currentRound||1,n=Zo(a),o=[];for(const s of e.players)!s.isDummy&&!s.isDisconnected&&s.score>=n&&o.push(s.id);return{shouldEnd:o.length>0,roundWinners:o}}function xa(e){const{shouldEnd:t,roundWinners:r}=or(e);if(!t)return e;const a=e.currentRound||1,n={...e.roundWinners,[a]:r},o=new Map;for(const[,s]of Object.entries(n))for(const d of s){const l=o.get(d)||0;o.set(d,l+1)}let i=null;for(const[s,d]of o.entries())if(d>=2){i=s;break}return y.info(`[endRound] Round ${a} ended. Winners: [${r.join(", ")}], Game winner: ${i||"none"}`),{...e,roundWinners:n,gameWinner:i,isRoundEndModalOpen:!0,roundEndTriggered:!0}}function sr(e,t){if(e.currentPhase!==0)return y.warn(`[performPreparationPhase] Not in Preparation phase (current: ${e.currentPhase})`),e;const r=e.players.find(o=>o.id===t);if(!r)return y.error(`[performPreparationPhase] Active player ${t} not found!`),e;y.info(`[performPreparationPhase] Player ${t} has deck size: ${r.deck.length}, hand size: ${r.hand.length}`);const a=e.players.map(o=>{if(o.id===t&&o.deck.length>0){const i=o.deck[0],s=[...o.deck.slice(1)],d=[...o.hand,i];return y.info(`[performPreparationPhase] Player ${t} drew card ${(i==null?void 0:i.id)||"unknown"}, deck now: ${s.length}, hand: ${d.length}`),{...o,deck:s,hand:d,readySetup:!1,readyCommit:!1}}return o});let n={...e,players:a,currentPhase:1};return Po(n,t),or(n).shouldEnd?xa(n):(y.info(`[performPreparationPhase] Transitioned to Setup phase, activePlayerId=${n.activePlayerId}`),n)}function Ua(e,t){const r=e.activePlayerId;if(r===t){const s={...e,activePlayerId:null};return t===e.startingPlayerId&&e.currentPhase===1&&or(s).shouldEnd?xa(s):s}if(!e.players.filter(s=>!s.isDisconnected).find(s=>s.id===t))return y.warn(`[toggleActivePlayer] Player ${t} not found or disconnected`),e;let o=e.turnNumber||1;t===e.startingPlayerId&&r!==null&&o++;const i={...e,activePlayerId:t,turnNumber:o,currentPhase:0};return sr(i,t)}function Qo(e,t){const r=e.players.filter(o=>!o.isDisconnected).sort((o,i)=>o.id-i.id);if(r.length===0)return null;if(t===null)return r[0].id;const a=r.findIndex(o=>o.id===t);if(a===-1)return r[0].id;const n=(a+1)%r.length;return r[n].id}function es(e,t){var r;for(const a of e.board)for(const n of a)if(((r=n.card)==null?void 0:r.ownerId)===t)return!0;return!1}function yt(e){const t=Qo(e,e.activePlayerId);if(t===null)return y.warn("[passTurnToNextPlayer] No next player found"),e;y.info(`[passTurnToNextPlayer] Passing turn from ${e.activePlayerId} to ${t}`);let r={...e,board:e.board.map(a=>a.map(n=>{var o;return((o=n.card)==null?void 0:o.ownerId)===e.activePlayerId&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(i=>i.type!=="Stun")}}:n}))};return r={...r,board:r.board.map(a=>a.map(n=>n.card&&n.card.statuses?{...n,card:{...n.card,statuses:n.card.statuses.filter(o=>o.type!=="enteredThisTurn")}}:n))},r={...r,activePlayerId:t,currentPhase:0,isScoringStep:!1,targetingMode:null},sr(r,t)}function jt(e,t,r){return y.warn("[stateDelta] applyStateDelta is deprecated, returning current state"),e}function ts(e,t){return{type:"RECONNECT_SNAPSHOT",data:e}}function rs(e,t,r){var a,n,o,i;try{const s=Bo(e,r);y.info(`[WebRTCCodec] Received card state: ${(a=s.board)==null?void 0:a.length}x${((o=(n=s.board)==null?void 0:n[0])==null?void 0:o.length)||0}, ${((i=s.players)==null?void 0:i.length)||0} players`);const d={...t};return s.players&&(d.players=s.players.map(l=>{const c=t.players.find(A=>A.id===l.id);if(c){const A=l.id===r;return{...c,...l,hand:A?c.hand:l.hand}}return l})),s.board&&(d.board=s.board),s.currentPhase!==void 0&&(d.currentPhase=s.currentPhase),s.activePlayerId!==void 0&&(d.activePlayerId=s.activePlayerId),s.currentRound!==void 0&&(d.currentRound=s.currentRound),d}catch(s){return y.error("[WebRTCCodec] Failed to deserialize card state:",s),t}}function as(e,t){try{const{effectType:r,timestamp:a,data:n}=qo(e);y.debug(`[WebRTCCodec] Received ability effect: ${r}`);let o=t;switch(r){case 1:return{gameState:o,effectData:{type:"highlight",...n,timestamp:a}};case 2:return{gameState:o,effectData:{type:"floatingText",...n,timestamp:a}};case 3:return{gameState:o,effectData:{type:"noTarget",...n}};case 8:return{gameState:o,effectData:{type:"targetingMode",...n}};case 9:return{gameState:o,effectData:{type:"clearTargeting"}};default:return y.warn(`[WebRTCCodec] Unknown ability effect type: ${r}`),{gameState:o,effectData:null}}}catch(r){return y.error("[WebRTCCodec] Failed to handle ability effect:",r),{gameState:t,effectData:null}}}function ns(e,t){var r;try{const{eventType:a,data:n}=Vo(e);y.info(`[WebRTCCodec] Received session event: ${a}`);const o={...t};switch(a){case 1:y.info(`[WebRTCCodec] Player connected: ${n.playerName} (ID: ${n.playerId})`);break;case 2:y.info(`[WebRTCCodec] Player disconnected: ID: ${n.playerId}`),o.players=o.players.map(i=>i.id===n.playerId?{...i,isDisconnected:!0}:i);break;case 3:y.info(`[WebRTCCodec] Game starting, first player: ${n.startingPlayerId}`),o.isGameStarted=!0,n.startingPlayerId!==void 0&&(o.activePlayerId=n.startingPlayerId,o.startingPlayerId=n.startingPlayerId);break;case 4:y.info(`[WebRTCCodec] Round ${n.roundNumber} starting`),o.currentRound=n.roundNumber??1;break;case 5:if(y.info(`[WebRTCCodec] Round ${n.roundNumber} ended, winners: ${(r=n.winners)==null?void 0:r.join(", ")}`),o.isRoundEndModalOpen=!0,n.winners&&n.roundNumber!==void 0){const i=o.roundWinners||{};i[n.roundNumber]=n.winners,o.roundWinners=i}break;case 6:y.info(`[WebRTCCodec] Phase change: ${n.newPhase}`),n.newPhase!==void 0&&(o.currentPhase=n.newPhase),n.newActivePlayerId!==void 0&&(o.activePlayerId=n.newActivePlayerId);break;case 7:y.info(`[WebRTCCodec] Turn change: player ${n.newActivePlayerId}`),n.newActivePlayerId!==void 0&&(o.activePlayerId=n.newActivePlayerId);break;case 8:y.info(`[WebRTCCodec] Game ended, winner: ${n.gameWinner}`),n.gameWinner!==void 0&&(o.gameWinner=n.gameWinner===255?null:n.gameWinner);break;default:y.warn(`[WebRTCCodec] Unknown session event type: ${a}`)}return o}catch(a){return y.error("[WebRTCCodec] Failed to handle session event:",a),t}}function ft(e,t,r,a){return e===2?{gameState:rs(t,r,a)}:e===3?as(t,r):e===4?{gameState:ns(t,r)}:(y.warn(`[WebRTCCodec] Unknown codec message type: ${e}`),{gameState:r})}const vt="avalon_game_state",nt="reconnection_data";function $a(e,t){var a;e.forEach(n=>n.forEach(o=>{var i;(i=o.card)!=null&&i.statuses&&(o.card.statuses=o.card.statuses.filter(s=>!(s.type==="LastPlayed"&&s.addedByPlayerId===t.id)))})),t.boardHistory||(t.boardHistory=[]);let r=!1;for(;t.boardHistory.length>0&&!r;){const n=t.boardHistory[t.boardHistory.length-1];for(let o=0;o<e.length;o++){for(let i=0;i<e[o].length;i++)if(((a=e[o][i].card)==null?void 0:a.id)===n){const s=e[o][i].card;if(!s||s.ownerId!==t.id)continue;s.statuses||(s.statuses=[]),s.statuses.push({type:"LastPlayed",addedByPlayerId:t.id}),r=!0;break}if(r)break}r||t.boardHistory.pop()}}function It(e){var a;if(!e||!Fe)return e;const{cardDatabase:t,tokenDatabase:r}=Fe;if(e.deck===Re.Tokens||(a=e.id)!=null&&a.startsWith("TKN_")){if(e.baseId&&r[e.baseId]){const o=r[e.baseId];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage}}const n=Object.keys(r).find(o=>r[o].name===e.name);if(n){const o=r[n];return{...e,imageUrl:o.imageUrl,fallbackImage:o.fallbackImage,baseId:n}}}else if(e.baseId&&t[e.baseId]){const n=t[e.baseId];return{...e,imageUrl:n.imageUrl,fallbackImage:n.fallbackImage}}return e}function At(e){var a,n;if(!Fe)return e;const t=((a=e.board)==null?void 0:a.map(o=>o.map(i=>({...i,card:i.card?It(i.card):null}))))||e.board,r=((n=e.players)==null?void 0:n.map(o=>{var i,s,d;return{...o,hand:((i=o.hand)==null?void 0:i.map(It))||[],deck:((s=o.deck)==null?void 0:s.map(It))||[],discard:((d=o.discard)==null?void 0:d.map(It))||[],announcedCard:o.announcedCard?It(o.announcedCard):null}}))||e.players;return{...e,board:t,players:r,floatingTexts:e.floatingTexts||[],highlights:e.highlights||[]}}function Ia(e,t,r){try{const a=At(e),n={gameState:a,localPlayerId:t,playerToken:r,timestamp:Date.now()};localStorage.setItem(vt,JSON.stringify(n)),a.gameId&&t!==null&&localStorage.setItem(nt,JSON.stringify({gameId:a.gameId,playerId:t,playerToken:r||null,timestamp:Date.now()}))}catch(a){console.warn("Failed to save game state:",a)}}function os(){try{const e=localStorage.getItem(vt);if(!e)return null;const t=JSON.parse(e),r=24*60*60*1e3;if(Date.now()-t.timestamp>r)return localStorage.removeItem(vt),localStorage.removeItem(nt),null;const a=t.gameState;return{gameState:At(a),localPlayerId:t.localPlayerId,playerToken:t.playerToken}}catch(e){return console.warn("Failed to load game state:",e),null}}function pt(){localStorage.removeItem(vt),localStorage.removeItem(nt)}function ir(e){const t=[...e];for(let r=t.length-1;r>0;r--){const a=Math.floor(Math.random()*(r+1));[t[r],t[a]]=[t[a],t[r]]}return t}function Ha(){return Math.random().toString(36).substring(2,18).toUpperCase()}function Ze(e,t,r){const a=Sa();let n=e;if(e==="Random"||!a[e]){const s=Object.keys(a);if(s.length===0)return y.error("[createDeck] No decks loaded yet!"),[];n=s[0],e==="Random"||y.warn(`[createDeck] Deck ${e} not found, using ${n} instead`)}const o=a[n];if(!o)return y.error(`Deck data for ${n} not loaded! Returning empty deck. Available decks:`,Object.keys(a)),[];const i=[...o].map(s=>({...s,ownerId:t,ownerName:r}));return ir(i)}function Fa(e,t=!1){const r=Sa(),a=Object.keys(r);if(a.length===0)return y.error("[createNewPlayer] No decks loaded yet!"),{id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:"Damanaki",color:Ot[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};const n=a[0],o={id:e,name:t?`Dummy ${e-1}`:`Player ${e}`,score:0,hand:[],deck:[],discard:[],announcedCard:null,selectedDeck:n,color:Ot[e-1]||"blue",isDummy:t,isReady:!1,boardHistory:[],autoDrawEnabled:!0};return o.deck=Ze(n,e,o.name),o}function at(){return{players:[],spectators:[],board:ka(),activeGridSize:7,gameId:null,hostId:1,dummyPlayerCount:0,isGameStarted:!1,gameMode:Qt.FreeForAll,isPrivate:!0,isReadyCheckActive:!1,revealRequests:[],activePlayerId:null,startingPlayerId:null,currentPhase:0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:1,turnNumber:1,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,localPlayerId:null,isSpectator:!1}}const Ea=-1,ss=-2,Et=1,Pt=2,st=(e,t,r,a)=>{var s,d,l,c,A;const{card:n,ownerId:o,location:i}=e;if(t.targetOwnerId!==void 0&&t.targetOwnerId!==Ea&&t.targetOwnerId!==ss&&t.targetOwnerId!==o||t.excludeOwnerId!==void 0&&t.excludeOwnerId===o)return!1;if(t.onlyOpponents||t.targetOwnerId===Ea){if(o===r)return!1;const f=a.find(R=>R.id===r),b=a.find(R=>R.id===o);if(f&&b&&f.teamId!==void 0&&f.teamId===b.teamId)return!1}if(t.targetType&&!((s=n.types)!=null&&s.includes(t.targetType))||t.onlyFaceDown&&((d=n.statuses)!=null&&d.some(f=>f.type==="Revealed"&&f.addedByPlayerId===r)||i==="board"&&!n.isFaceDown)||t.tokenType==="Revealed"&&(l=n.statuses)!=null&&l.some(f=>f.type==="Revealed"&&f.addedByPlayerId===r)||t.requiredTargetStatus&&(!((c=n.statuses)!=null&&c.some(f=>f.type===t.requiredTargetStatus))||t.requireStatusFromSourceOwner&&r!==null&&!((A=n.statuses)==null?void 0:A.some(b=>b.type===t.requiredTargetStatus&&b.addedByPlayerId===r))))return!1;if(t.mustBeAdjacentToSource&&t.sourceCoords&&e.boardCoords){const{row:f,col:b}=t.sourceCoords,{row:R,col:I}=e.boardCoords;if(Math.abs(f-R)+Math.abs(b-I)!==Et)return!1}if(t.mustBeInLineWithSource&&t.sourceCoords&&e.boardCoords){const{row:f,col:b}=t.sourceCoords,{row:R,col:I}=e.boardCoords;if(f!==R&&b!==I)return!1}if(t.maxDistanceFromSource!==void 0&&t.sourceCoords&&e.boardCoords){const{row:f,col:b}=t.sourceCoords,{row:R,col:I}=e.boardCoords;if(Math.max(Math.abs(f-R),Math.abs(b-I))>t.maxDistanceFromSource)return!1}if(t.maxOrthogonalDistance!==void 0&&t.sourceCoords&&e.boardCoords){const{row:f,col:b}=t.sourceCoords,{row:R,col:I}=e.boardCoords;if(Math.abs(f-R)+Math.abs(b-I)>t.maxOrthogonalDistance)return!1}return!0},Nt=(e,t,r,a)=>{if(!e||e.type!=="ENTER_MODE"&&e.type!=="CREATE_STACK")return[];const n=[],o=t.board,i=o.length,s=t.activeGridSize,d=Math.floor((i-s)/2),l=d,c=d+s-1;if(e.type==="CREATE_STACK"){const I={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,sourceCoords:e.sourceCoords,tokenType:e.tokenType};for(let g=l;g<=c;g++)for(let u=l;u<=c;u++){const D=o[g][u];D.card&&D.card.ownerId!==void 0&&st({card:D.card,ownerId:D.card.ownerId,location:"board",boardCoords:{row:g,col:u}},I,r,t.players)&&n.push({row:g,col:u})}return n}const{mode:A,payload:f,sourceCoords:b,contextCheck:R}=e;if(A==="REVEREND_DOUBLE_EXPLOIT"){for(let I=l;I<=c;I++)for(let g=l;g<=c;g++)o[I][g].card&&n.push({row:I,col:g});return n}if((A==="SELECT_TARGET"||A==="CENSOR_SWAP"||A==="ZEALOUS_WEAKEN"||A==="CENTURION_BUFF"||A==="SELECT_UNIT_FOR_MOVE")&&f.filter&&typeof f.filter=="function"){if(f.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||f.actionType==="LUCIUS_SETUP"||f.actionType==="SELECT_HAND_FOR_DEPLOY"||f.handOnly)return[];for(let I=l;I<=c;I++)for(let g=l;g<=c;g++){const u=o[I][g];let D=u.card&&f.filter(u.card,I,g);if(D&&R==="ADJACENT_TO_LAST_MOVE"&&(a!=null&&a.lastMovedCardCoords)){const{row:E,col:h}=a.lastMovedCardCoords;Math.abs(I-E)+Math.abs(g-h)===1||(D=!1)}D&&n.push({row:I,col:g})}}else if(A==="SELECT_TARGET"&&(f.actionType==="ENHANCED_INT_REVEAL"||f.actionType==="ENHANCED_INT_MOVE"))for(let I=l;I<=c;I++)for(let g=l;g<=c;g++)o[I][g].card&&n.push({row:I,col:g});else if(A==="PATROL_MOVE"&&b)for(let I=l;I<=c;I++)for(let g=l;g<=c;g++){const u=I===b.row||g===b.col,D=I===b.row&&g===b.col,E=!o[I][g].card;u&&(E||D)&&n.push({row:I,col:g})}else if(A==="RIOT_PUSH"&&b){const I=[{r:b.row-1,c:b.col},{r:b.row+1,c:b.col},{r:b.row,c:b.col-1},{r:b.row,c:b.col+1}],g=(u,D)=>u>=l&&u<=c&&D>=l&&D<=c;I.forEach(u=>{if(g(u.r,u.c)){const D=o[u.r][u.c].card;if(D&&D.ownerId!==r){const E=t.players.find(T=>T.id===r),h=t.players.find(T=>T.id===D.ownerId);if(!((E==null?void 0:E.teamId)!==void 0&&(h==null?void 0:h.teamId)!==void 0&&E.teamId===h.teamId)){const T=u.r-b.row,N=u.c-b.col,L=u.r+T,M=u.c+N;g(L,M)&&(o[L][M].card||n.push({row:u.r,col:u.c}))}}}})}else if(A==="RIOT_MOVE"&&f.vacatedCoords)n.push(f.vacatedCoords),b&&n.push(b);else if(A==="SWAP_POSITIONS"&&f.filter)for(let I=l;I<=c;I++)for(let g=l;g<=c;g++){const u=o[I][g];u.card&&f.filter(u.card,I,g)&&n.push({row:I,col:g})}else if((A==="TRANSFER_STATUS_SELECT"||A==="TRANSFER_ALL_STATUSES")&&f.filter)for(let I=l;I<=c;I++)for(let g=l;g<=c;g++){const u=o[I][g];u.card&&f.filter(u.card,I,g)&&n.push({row:I,col:g})}else if(A==="SPAWN_TOKEN"||A==="SELECT_CELL"||A==="IMMUNIS_RETRIEVE")for(let I=l;I<=c;I++)for(let g=l;g<=c;g++){const u=!o[I][g].card;if(A==="IMMUNIS_RETRIEVE"&&f.filter){u&&f.filter(I,g)&&n.push({row:I,col:g});continue}if(A==="SELECT_CELL"){if(f.moveFromHand){u&&n.push({row:I,col:g});continue}if(!b)continue;const D=I===b.row&&g===b.col,E=f.range==="global";let h=!1;if(E)h=!0;else if(f.range==="line")h=I===b.row||g===b.col;else if(f.range===Pt){const w=Math.abs(I-b.row),T=Math.abs(g-b.col),N=w+T;if(N===Et)h=!0;else if(N===Pt){const L=[];w===Pt&&T===0?L.push({r:(I+b.row)/2,c:g}):w===0&&T===Pt?L.push({r:I,c:(g+b.col)/2}):w===Et&&T===Et&&(L.push({r:I,c:b.col}),L.push({r:b.row,c:g})),h=L.some(M=>M.r<0||M.r>=i||M.c<0||M.c>=i?!1:!o[M.r][M.c].card)}}else h=Math.abs(I-b.row)+Math.abs(g-b.col)===Et;(u&&h||f.allowSelf&&D)&&n.push({row:I,col:g})}else if(A==="SPAWN_TOKEN"&&b){const D=Math.abs(I-b.row)+Math.abs(g-b.col)===1;u&&D&&n.push({row:I,col:g})}}else if(A==="REVEAL_ENEMY"&&f.filter)for(let I=l;I<=c;I++)for(let g=l;g<=c;g++){const u=o[I][g];u.card&&f.filter(u.card,I,g)&&n.push({row:I,col:g})}else if(A==="SELECT_LINE_START")for(let I=l;I<=c;I++)for(let g=l;g<=c;g++)n.push({row:I,col:g});else if(A==="SELECT_LINE_END"&&f.firstCoords){const{row:I,col:g}=f.firstCoords;for(let u=l;u<=c;u++)n.push({row:I,col:u});for(let u=l;u<=c;u++)n.push({row:u,col:g})}else if(A==="INTEGRATOR_LINE_SELECT"&&b){const{row:I,col:g}=b;for(let u=l;u<=c;u++)n.push({row:I,col:u});for(let u=l;u<=c;u++)n.push({row:u,col:g})}else if(A==="ZIUS_LINE_SELECT"&&b){const{row:I,col:g}=b;for(let u=l;u<=c;u++)n.push({row:I,col:u});for(let u=l;u<=c;u++)n.push({row:u,col:g})}else if(A==="IP_AGENT_THREAT_SCORING"&&b){const{row:I,col:g}=b;for(let u=l;u<=c;u++)n.push({row:I,col:u});for(let u=l;u<=c;u++)n.push({row:u,col:g})}else if(A==="SELECT_DIAGONAL")if(f.firstCoords){const{row:I,col:g}=f.firstCoords;for(let u=l;u<=c;u++)for(let D=l;D<=c;D++)Math.abs(u-I)===Math.abs(D-g)&&n.push({row:u,col:D})}else for(let I=l;I<=c;I++)for(let g=l;g<=c;g++)n.push({row:I,col:g});return n},bt=(e,t,r,a)=>{var o,i,s,d,l;if(e.type==="OPEN_MODAL"||e.mode==="SELECT_DECK")return!0;if(e.mode==="REVEREND_DOUBLE_EXPLOIT"){for(let c=0;c<t.board.length;c++)for(let A=0;A<t.board[c].length;A++)if(t.board[c][A].card)return!0;return!1}if(e.mode==="PRINCEPS_SHIELD_THEN_AIM"||e.mode==="SHIELD_SELF_THEN_SPAWN"||e.mode==="SHIELD_SELF_THEN_RIOT_PUSH"||e.mode==="ABR_DEPLOY_SHIELD_AIM"||e.mode==="GAWAIN_DEPLOY_SHIELD_AIM")return!0;if(e.mode==="SELECT_TARGET"&&((o=e.payload)!=null&&o.actionType)){const c=e.payload.actionType;if(c==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"||c==="LUCIUS_SETUP"||c==="SELECT_HAND_FOR_DEPLOY"){const A=((i=e.sourceCard)==null?void 0:i.ownerId)||r;if(A!==null){const f=t.players.find(b=>b.id===A);if(f&&f.hand.length>0)return!0}return!1}}if(e.type==="CREATE_STACK"){if(Nt(e,t,r,a).length>0)return!0;const A=["Aim","Exploit","Stun","Shield"];if(!(e.tokenType&&A.includes(e.tokenType))&&(e.tokenType==="Revealed"||(s=e.tokenType)!=null&&s.startsWith("Power")))for(const b of t.players)for(let R=0;R<b.hand.length;R++){const I={targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,tokenType:e.tokenType};if(st({card:b.hand[R],ownerId:b.id,location:"hand"},I,r,t.players))return!0}return!1}if(e.mode==="SELECT_TARGET"&&((d=e.payload)!=null&&d.filter)){if(e.payload.handOnly||e.payload.allowHandTargets||e.payload.actionType==="DESTROY"){for(const c of t.players)if(c.hand.some(A=>e.payload.filter(A))&&e.payload.handOnly)return!0}if(e.payload.handOnly)return!1}return Nt(e,t,r,a).length>0?!0:((e.mode==="CENSOR_SWAP"||e.mode==="ZEALOUS_WEAKEN"||e.mode==="CENTURION_BUFF"||e.mode==="SELECT_UNIT_FOR_MOVE")&&((l=e.payload)!=null&&l.filter),!1)};function is(e){const{ws:t,webrtcManager:r,gameStateRef:a,localPlayerIdRef:n,webrtcIsHostRef:o,setLatestHighlight:i,setLatestFloatingTexts:s,setLatestNoTarget:d,setLatestDeckSelections:l,setLatestHandCardSelections:c,setTargetSelectionEffects:A,setGameState:f}=e,b=U.useCallback(T=>{var L;const N={...T,timestamp:Date.now()};if(i(N),((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HIGHLIGHT",gameId:a.current.gameId,highlightData:N}));else if(r.current){const M={type:"HIGHLIGHT_TRIGGERED",senderId:r.current.getPeerId(),data:N,timestamp:Date.now()};o.current?r.current.broadcastToGuests(M):r.current.sendMessageToHost(M)}},[t,r,a,o,i]),R=U.useCallback(T=>{var _;const N=Array.isArray(T)?T:[T],L=Date.now(),M=N.map((m,v)=>({...m,timestamp:L+v}));if(s(M),((_=t.current)==null?void 0:_.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_FLOATING_TEXT_BATCH",gameId:a.current.gameId,batch:M}));else if(r.current){const m={type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:r.current.getPeerId(),data:{batch:M},timestamp:Date.now()};o.current?r.current.broadcastToGuests(m):r.current.sendMessageToHost(m)}},[t,r,a,o,s]),I=U.useCallback(T=>{var L;const N=Date.now();if(d({coords:T,timestamp:N}),((L=t.current)==null?void 0:L.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_NO_TARGET",gameId:a.current.gameId,coords:T,timestamp:N}));else if(r.current){const M={type:"NO_TARGET_TRIGGERED",senderId:r.current.getPeerId(),data:{coords:T,timestamp:N},timestamp:Date.now()};o.current?r.current.broadcastToGuests(M):r.current.sendMessageToHost(M)}},[t,r,a,o,d]),g=U.useCallback((T,N)=>{var M;const L={playerId:T,selectedByPlayerId:N,timestamp:Date.now()};if(l(_=>[..._,L]),((M=t.current)==null?void 0:M.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_DECK_SELECTION",gameId:a.current.gameId,deckSelectionData:L}));else if(r.current){const _={type:"DECK_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:L,timestamp:Date.now()};o.current?r.current.broadcastToGuests(_):r.current.sendMessageToHost(_)}setTimeout(()=>{l(_=>_.filter(m=>m.timestamp!==L.timestamp))},1e3)},[t,r,a,o,l]),u=U.useCallback((T,N,L)=>{var _;const M={playerId:T,cardIndex:N,selectedByPlayerId:L,timestamp:Date.now()};if(c(m=>[...m,M]),((_=t.current)==null?void 0:_.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_HAND_CARD_SELECTION",gameId:a.current.gameId,handCardSelectionData:M}));else if(r.current){const m={type:"HAND_CARD_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:M,timestamp:Date.now()};o.current?r.current.broadcastToGuests(m):r.current.sendMessageToHost(m)}setTimeout(()=>{c(m=>m.filter(v=>v.timestamp!==M.timestamp))},1e3)},[t,r,a,o,c]),D=U.useCallback(T=>{var N;if(((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"SYNC_VALID_TARGETS",gameId:a.current.gameId,playerId:n.current,...T}));else if(r.current){const L={type:"SYNC_VALID_TARGETS",senderId:r.current.getPeerId(),data:{playerId:n.current,...T},timestamp:Date.now()};o.current?r.current.broadcastToGuests(L):r.current.sendMessageToHost(L)}},[t,r,a,o,n]),E=U.useCallback((T,N,L)=>{var _;if(n.current===null)return;const M={timestamp:Date.now(),location:T,boardCoords:N,handTarget:L,selectedByPlayerId:n.current};if(A(m=>[...m,M]),((_=t.current)==null?void 0:_.readyState)===WebSocket.OPEN&&a.current.gameId)t.current.send(JSON.stringify({type:"TRIGGER_TARGET_SELECTION",gameId:a.current.gameId,effect:M}));else if(r.current)if(o.current){const m={type:"TARGET_SELECTION_TRIGGERED",senderId:r.current.getPeerId(),data:M,timestamp:Date.now()};r.current.broadcastToGuests(m)}else{const m={type:"SET_TARGETING_MODE",senderId:r.current.getPeerId(),data:M,timestamp:Date.now()};r.current.sendMessageToHost(m)}setTimeout(()=>{A(m=>m.filter(v=>v.timestamp!==M.timestamp))},1e3)},[t,r,a,o,n,A]),h=U.useCallback((T,N,L,M,_)=>{var C;const m=a.current;if(!m||!m.board){console.warn("[setTargetingMode] No game state or board available");return}let v;M?v=M:L&&(v=Nt(T,m,N,_));const G={playerId:N,action:T,sourceCoords:L,timestamp:Date.now(),boardTargets:v};if(f(O=>({...O,targetingMode:G})),((C=t.current)==null?void 0:C.readyState)===WebSocket.OPEN&&m.gameId)t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:m.gameId,targetingMode:G}));else if(r.current){const O={type:"SET_TARGETING_MODE",senderId:r.current.getPeerId(),data:G,timestamp:Date.now()};o.current?r.current.broadcastToGuests(O):r.current.sendMessageToHost(O)}},[t,r,a,o,f]),w=U.useCallback(()=>{var N;const T=a.current;if(f(L=>({...L,targetingMode:null})),((N=t.current)==null?void 0:N.readyState)===WebSocket.OPEN&&(T!=null&&T.gameId))t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:T.gameId}));else if(r.current){const L={type:"CLEAR_TARGETING_MODE",senderId:r.current.getPeerId(),data:{},timestamp:Date.now()};o.current?r.current.broadcastToGuests(L):r.current.sendMessageToHost(L)}},[t,r,a,o,f]);return{triggerHighlight:b,triggerFloatingText:R,triggerNoTarget:I,triggerDeckSelection:g,triggerHandCardSelection:u,syncValidTargets:D,triggerTargetSelection:E,setTargetingMode:h,clearTargetingMode:w}}function ds(e){const{ws:t,webrtcManager:r,gameStateRef:a,webrtcIsHostRef:n,setGameState:o,updateState:i}=e,s=U.useCallback(f=>{var R;if(ve()&&r.current&&n.current){o(I=>{const g=I.players.map(u=>{let D=1;for(const[E,h]of Object.entries(f))if(h.includes(u.id)){D=parseInt(E);break}return{...u,teamId:D}});return{...I,players:g}}),r.current.broadcastToGuests({type:"ASSIGN_TEAMS",senderId:r.current.getPeerId(),data:{assignments:f},timestamp:Date.now()});return}((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"ASSIGN_TEAMS",gameId:a.current.gameId,assignments:f}))},[t,r,a,n,o]),d=U.useCallback(f=>{var R;if(ve()&&r.current&&n.current){o(I=>({...I,gameMode:f})),r.current.broadcastToGuests({type:"SET_GAME_MODE",senderId:r.current.getPeerId(),data:{mode:f},timestamp:Date.now()});return}((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_MODE",gameId:a.current.gameId,mode:f}))},[t,r,a,n,o]),l=U.useCallback(f=>{var R;if(ve()&&r.current&&n.current){o(I=>({...I,isPrivate:f})),r.current.broadcastToGuests({type:"SET_GAME_PRIVACY",senderId:r.current.getPeerId(),data:{isPrivate:f},timestamp:Date.now()});return}((R=t.current)==null?void 0:R.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"SET_GAME_PRIVACY",gameId:a.current.gameId,isPrivate:f}))},[t,r,a,n,o]),c=U.useCallback(f=>{i(b=>{if(b.isGameStarted)return b;const R={...b,activeGridSize:f};if(b.board.length!==f){R.board=[];for(let g=0;g<f;g++){const u=[];for(let D=0;D<f;D++)u.push({card:null});R.board.push(u)}}return R})},[i]),A=U.useCallback(f=>{i(b=>{if(b.isGameStarted)return b;const R=b.players.filter(u=>!u.isDummy);if(R.length+f>go)return b;const I=[...R],g=Math.max(...R.map(u=>u.id),0);for(let u=0;u<f;u++){const D=g+u+1,E=Fa(D,!0);E.name=`Dummy ${u+1}`,I.push(E)}return{...b,players:I,dummyPlayerCount:f}})},[i]);return{assignTeams:s,setGameMode:d,setGamePrivacy:l,setActiveGridSize:c,setDummyPlayerCount:A}}function cs(e){const{ws:t,webrtcManager:r,gameStateRef:a,localPlayerIdRef:n,webrtcIsHostRef:o,setGameState:i}=e,s=U.useCallback(()=>{var A;if(ve()&&r.current&&o.current){i(f=>({...f,isReadyCheckActive:!0,isPrivate:!0})),r.current.broadcastToGuests({type:"START_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!0,isPrivate:!0},timestamp:Date.now()});return}((A=t.current)==null?void 0:A.readyState)===WebSocket.OPEN&&a.current.gameId&&t.current.send(JSON.stringify({type:"START_READY_CHECK",gameId:a.current.gameId}))},[t,r,a,o,i]),d=U.useCallback(()=>{var A;if(ve()&&r.current&&o.current){i(f=>({...f,isReadyCheckActive:!1})),r.current.broadcastToGuests({type:"CANCEL_READY_CHECK",senderId:r.current.getPeerId(),data:{isReadyCheckActive:!1},timestamp:Date.now()});return}((A=t.current)==null?void 0:A.readyState)===WebSocket.OPEN&&a.current.gameId?t.current.send(JSON.stringify({type:"CANCEL_READY_CHECK",gameId:a.current.gameId})):i(f=>({...f,isReadyCheckActive:!1}))},[t,r,a,o,i]),l=U.useCallback(()=>{var A;const c=ve();if(c&&r.current&&o.current&&n.current!==null){i(f=>{const b=f.players.map(u=>u.id===n.current?{...u,isReady:!0}:u),R={...f,players:b},I=R.players.filter(u=>!u.isDummy&&!u.isDisconnected);if(I.length>0&&I.every(u=>u.isReady)&&!R.isGameStarted){const u=R.players.filter(T=>!T.isDisconnected),D=Math.floor(Math.random()*u.length),E=u[D].id,h={...R};h.isReadyCheckActive=!1,h.isGameStarted=!0,h.startingPlayerId=E,h.activePlayerId=E,h.currentPhase=0,h.players=h.players.map(T=>{if(T.hand.length===0&&T.deck.length>0){const L=[...T.hand],M=[...T.deck];for(let _=0;_<6&&_<M.length;_++){const m=M[0];M.splice(0,1),L.push(m)}return y.info(`[playerReady] Drew initial ${L.length} cards for player ${T.id}`),{...T,hand:L,deck:M}}return T});const w=h.players.find(T=>T.id===E);if(w&&w.deck.length>0){const T=w.deck[0],N=[...w.deck.slice(1)],L=[...w.hand,T];h.players=h.players.map(M=>M.id===E?{...M,deck:N,hand:L,readySetup:!1,readyCommit:!1}:M),h.currentPhase=1}return r.current.broadcastGameState(h),r.current.broadcastToGuests({type:"GAME_START",senderId:r.current.getPeerId(),data:{startingPlayerId:E,activePlayerId:E,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),h}return r.current.broadcastToGuests({type:"HOST_READY",senderId:r.current.getPeerId(),playerId:n.current??void 0,timestamp:Date.now()}),R});return}if(c&&r.current&&!o.current&&n.current!==null){r.current.sendMessageToHost({type:"PLAYER_READY",senderId:r.current.getPeerId(),playerId:n.current,timestamp:Date.now()}),i(f=>({...f,players:f.players.map(b=>b.id===n.current?{...b,isReady:!0}:b)}));return}((A=t.current)==null?void 0:A.readyState)===WebSocket.OPEN&&a.current.gameId&&n.current!==null&&t.current.send(JSON.stringify({type:"PLAYER_READY",gameId:a.current.gameId,playerId:n.current}))},[t,r,a,n,o,i]);return{startReadyCheck:s,cancelReadyCheck:d,playerReady:l}}function ls(e){const{updateState:t,sendWebrtcAction:r,webrtcIsHostRef:a,webrtcManagerRef:n}=e,o=U.useCallback((s,d)=>{t(l=>l.isGameStarted?l:{...l,players:l.players.map(c=>c.id===s?{...c,name:d}:c)})},[t]),i=U.useCallback((s,d)=>{t(c=>({...c,players:c.players.map(A=>A.id===s?{...A,color:d}:A)})),r!==null&&(a!=null&&a.current&&(n!=null&&n.current)?n.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:n.current.getPeerId(),data:{playerId:s,color:d},timestamp:Date.now()}):!(a!=null&&a.current)&&r&&r("CHANGE_PLAYER_COLOR",{playerId:s,color:d}))},[t,r,a,n]);return{updatePlayerName:o,changePlayerColor:i}}function us(e){const{updateState:t}=e,r=U.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const l=d.players.find(b=>b.id===s);if(!l||l.deck.length===0)return d;const c=Ie(d),A=c.players.find(b=>b.id===s),f=A.deck.shift();return f&&A.hand.push(f),c})},[t]),a=U.useCallback((s,d)=>{d<=0||t(l=>{if(!l.isGameStarted)return l;const c=l.players.find(R=>R.id===s);if(!c||c.deck.length===0)return l;const A=Ie(l),f=A.players.find(R=>R.id===s),b=Math.min(d,f.deck.length);for(let R=0;R<b;R++){const I=f.deck.shift();I&&f.hand.push(I)}return A})},[t]),n=U.useCallback(s=>{t(d=>{if(!d.isGameStarted||!d.players.find(f=>f.id===s))return d;const c=Ie(d),A=c.players.find(f=>f.id===s);return A.deck=ir([...A.deck]),c})},[t]),o=U.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const l={...d},c=l.board[s.row][s.col].card;return c&&(c.isFaceDown=!1),{...l,board:Le(l)}})},[t]),i=U.useCallback(s=>{t(d=>{if(!d.isGameStarted)return d;const l={...d},c=l.board[s.row][s.col].card;return c&&(c.isFaceDown=!0),{...l,board:Le(l)}})},[t]);return{drawCard:r,drawCardsBatch:a,shufflePlayerDeck:n,flipBoardCard:o,flipBoardCardFaceDown:i}}function fs(e){const{localPlayerIdRef:t,updateState:r}=e,a=U.useCallback((u,D,E)=>{r(h=>{var N,L;if(!h.isGameStarted)return h;const w=Ie(h),T=w.board[u.row][u.col].card;if(T){if(D==="Stun"&&(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius")&&((N=T.types)!=null&&N.includes("Hero")))||["Support","Threat","Revealed","Shield"].includes(D)&&((L=T.statuses)==null?void 0:L.some(_=>_.type===D&&_.addedByPlayerId===E)))return h;T.statuses||(T.statuses=[]),T.statuses.push({type:D,addedByPlayerId:E})}return w})},[r]),n=U.useCallback((u,D)=>{r(E=>{if(!E.isGameStarted)return E;const h=Ie(E),w=h.board[u.row][u.col].card;if(w!=null&&w.statuses){const T=w.statuses.map(N=>N.type).lastIndexOf(D);T>-1&&w.statuses.splice(T,1)}return h.board=Le(h),h})},[r]),o=U.useCallback((u,D,E)=>{r(h=>{if(!h.isGameStarted)return h;const w=Ie(h),T=w.board[u.row][u.col].card;if(T!=null&&T.statuses){const N=T.statuses.findIndex(L=>L.type===D&&L.addedByPlayerId===E);N>-1&&T.statuses.splice(N,1)}return w.board=Le(w),w})},[r]),i=U.useCallback((u,D)=>{r(E=>{if(!E.isGameStarted)return E;const h=Ie(E),w=h.board[u.row][u.col].card;return w&&(w.powerModifier===void 0&&(w.powerModifier=0),w.powerModifier+=D),h})},[r]),s=U.useCallback((u,D,E)=>{r(h=>{var N;if(!h.isGameStarted)return h;const w=Ie(h),T=w.players.find(L=>L.id===u);if(T!=null&&T.announcedCard){if(["Support","Threat","Revealed"].includes(D)&&((N=T.announcedCard.statuses)==null?void 0:N.some(M=>M.type===D&&M.addedByPlayerId===E)))return h;T.announcedCard.statuses||(T.announcedCard.statuses=[]),T.announcedCard.statuses.push({type:D,addedByPlayerId:E})}return w})},[r]),d=U.useCallback((u,D)=>{r(E=>{var T;if(!E.isGameStarted)return E;const h=Ie(E),w=h.players.find(N=>N.id===u);if((T=w==null?void 0:w.announcedCard)!=null&&T.statuses){const N=w.announcedCard.statuses.map(L=>L.type).lastIndexOf(D);N>-1&&w.announcedCard.statuses.splice(N,1)}return h})},[r]),l=U.useCallback((u,D)=>{r(E=>{if(!E.isGameStarted)return E;const h=Ie(E),w=h.players.find(T=>T.id===u);return w!=null&&w.announcedCard&&(w.announcedCard.powerModifier===void 0&&(w.announcedCard.powerModifier=0),w.announcedCard.powerModifier+=D),h})},[r]),c=U.useCallback((u,D,E,h)=>{r(w=>{var L;if(!w.isGameStarted)return w;const T=Ie(w),N=T.players.find(M=>M.id===u);if(N!=null&&N.hand[D]){const M=N.hand[D];if(["Support","Threat","Revealed","Shield","Resurrected"].includes(E)&&((L=M.statuses)==null?void 0:L.some(m=>m.type===E&&m.addedByPlayerId===h)))return w;M.statuses||(M.statuses=[]),M.statuses.push({type:E,addedByPlayerId:h})}return T})},[r]),A=U.useCallback((u,D,E)=>{r(h=>{if(!h.isGameStarted)return h;const w=Ie(h),T=w.players.find(L=>L.id===u),N=T==null?void 0:T.hand[D];if(N!=null&&N.statuses){const L=N.statuses.map(M=>M.type).lastIndexOf(E);L>-1&&N.statuses.splice(L,1),E==="Revealed"&&(N.statuses.some(_=>_.type==="Revealed")||delete N.revealedTo)}return w})},[r]),f=U.useCallback((u,D,E)=>{r(h=>{const w=h.players.find(L=>L.id===u);if(!(w!=null&&w.hand[D]))return h;const T=Ie(h),N=T.players.find(L=>L.id===u).hand[D];if(E==="all")N.revealedTo="all",N.statuses||(N.statuses=[]),N.statuses.some(L=>L.type==="Revealed"&&L.addedByPlayerId===u)||N.statuses.push({type:"Revealed",addedByPlayerId:u});else{(!N.revealedTo||N.revealedTo==="all"||!Array.isArray(N.revealedTo))&&(N.revealedTo=[]);const L=E.filter(M=>!N.revealedTo.includes(M));N.revealedTo.push(...L)}return T})},[r]),b=U.useCallback((u,D)=>{r(E=>{if(!E.board[u.row][u.col].card)return E;const w=Ie(E),T=w.board[u.row][u.col].card,N=T.ownerId;if(D==="all")T.revealedTo="all",N!==void 0&&(T.statuses||(T.statuses=[]),T.statuses.some(L=>L.type==="Revealed"&&L.addedByPlayerId===N)||T.statuses.push({type:"Revealed",addedByPlayerId:N}));else{(!T.revealedTo||T.revealedTo==="all"||!Array.isArray(T.revealedTo))&&(T.revealedTo=[]);const L=D.filter(M=>!T.revealedTo.includes(M));T.revealedTo.push(...L)}return w})},[r]),R=U.useCallback((u,D)=>{r(E=>{var N;const h=u.boardCoords?(N=E.board[u.boardCoords.row][u.boardCoords.col].card)==null?void 0:N.ownerId:u.ownerId;if(!h)return E;const w=Ie(E),T=w.revealRequests.find(L=>L.fromPlayerId===D&&L.toPlayerId===h);return T?T.cardIdentifiers.some(M=>JSON.stringify(M)===JSON.stringify(u))||T.cardIdentifiers.push(u):w.revealRequests.push({fromPlayerId:D,toPlayerId:h,cardIdentifiers:[u]}),w})},[r]),I=U.useCallback((u,D)=>{r(E=>{const h=E.revealRequests.findIndex(N=>N.toPlayerId===t.current&&N.fromPlayerId===u);if(h===-1)return E;const w=Ie(E),T=w.revealRequests[h];if(D){const{cardIdentifiers:N}=T;for(const L of N){let M=null;if(L.source==="board"&&L.boardCoords)M=w.board[L.boardCoords.row][L.boardCoords.col].card;else if(L.source==="hand"&&L.ownerId&&L.cardIndex!==void 0){const _=w.players.find(m=>m.id===L.ownerId);_&&(M=_.hand[L.cardIndex])}M&&(M.statuses||(M.statuses=[]),M.statuses.some(_=>_.type==="Revealed"&&_.addedByPlayerId===u)||M.statuses.push({type:"Revealed",addedByPlayerId:u}))}}return w.revealRequests.splice(h,1),w})},[r,t]),g=U.useCallback(u=>{r(D=>{const E=Ie(D);let h=null;if(u.source==="board"&&u.boardCoords)h=E.board[u.boardCoords.row][u.boardCoords.col].card;else if(u.source==="hand"&&u.playerId&&u.cardIndex!==void 0){const w=E.players.find(T=>T.id===u.playerId);w&&(h=w.hand[u.cardIndex])}return h&&(h.statuses&&(h.statuses=h.statuses.filter(w=>w.type!=="Revealed")),delete h.revealedTo),E})},[r]);return{addBoardCardStatus:a,removeBoardCardStatus:n,removeBoardCardStatusByOwner:o,modifyBoardCardPower:i,addAnnouncedCardStatus:s,removeAnnouncedCardStatus:d,modifyAnnouncedCardPower:l,addHandCardStatus:c,removeHandCardStatus:A,revealHandCard:f,revealBoardCard:b,requestCardReveal:R,respondToRevealRequest:I,removeRevealedStatus:g}}function ps(e){const{webrtcIsHostRef:t,sendWebrtcAction:r,webrtcManagerRef:a,localPlayerIdRef:n,getCardDefinition:o,commandCardIds:i,createDeck:s,updateState:d}=e,l=U.useCallback((I,g)=>{const u=ve();if(u&&!t.current)try{localStorage.setItem("webrtc_preferred_deck",g),y.info(`[changePlayerDeck] Saved deck preference: ${g}`)}catch(h){y.warn("[changePlayerDeck] Failed to save deck preference:",h)}const D=s(g,I,"Player "+I);if(d(h=>h.isGameStarted?h:{...h,players:h.players.map(w=>w.id===I?{...w,deck:D,selectedDeck:g,hand:[],discard:[],announcedCard:null,boardHistory:[]}:w)}),y.info(`[changePlayerDeck] Checking WebRTC mode: isWebRTCMode=${u}, isHost=${t.current}, hasSendAction=${!!r}, hasManager=${!!(a!=null&&a.current)}`),!u)return;const E=D.map(h=>({id:h.id,baseId:h.baseId,power:h.power,powerModifier:h.powerModifier||0,isFaceDown:h.isFaceDown||!1,statuses:h.statuses||[]}));t.current?a!=null&&a.current?(a.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:a.current.getPeerId(),timestamp:Date.now(),data:{playerId:I,deckType:g,deck:E,deckSize:E.length}}),y.info(`[changePlayerDeck] Host broadcasting deck data to all guests: player ${I}, deck ${g}, ${E.length} cards`)):y.warn("[changePlayerDeck] Host mode but no webrtcManagerRef available"):r?(r("CHANGE_PLAYER_DECK",{playerId:I,deckType:g,deck:E,deckSize:E.length}),y.info(`[changePlayerDeck] Guest sending deck data to host: player ${I}, deck ${g}, ${E.length} cards`)):y.warn("[changePlayerDeck] Guest mode but no sendWebrtcAction available")},[d,s,r,t,a,n]),c=U.useCallback((I,g)=>{const u=ve();let D=[];const E=new Map;for(const{cardId:w,quantity:T}of g.cards){const N=o(w);if(!N)continue;const L=i.has(w),M=L?Re.Command:Re.Custom,_=L?"CMD":"CUS";for(let m=0;m<T;m++){const v=(E.get(w)||0)+1;E.set(w,v),D.push({...N,id:`${_}_${w.toUpperCase()}_${v}`,baseId:w,deck:M,ownerId:I,ownerName:"Player "+I})}}if(D=ir(D),d(w=>w.isGameStarted||!w.players.find(N=>N.id===I)?w:{...w,players:w.players.map(N=>N.id===I?{...N,deck:D,selectedDeck:Re.Custom,hand:[],discard:[],announcedCard:null,boardHistory:[]}:N)}),!u)return;const h=D.map(w=>({id:w.id,baseId:w.baseId,power:w.power,powerModifier:w.powerModifier||0,isFaceDown:w.isFaceDown||!1,statuses:w.statuses||[]}));t.current?a!=null&&a.current&&(a.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:a.current.getPeerId(),timestamp:Date.now(),data:{playerId:I,deckType:Re.Custom,deck:h,deckSize:h.length}}),y.info(`[loadCustomDeck] Host broadcasting custom deck data: player ${I}, ${h.length} cards`)):r&&(r("CHANGE_PLAYER_DECK",{playerId:I,deckType:Re.Custom,deck:h,deckSize:h.length}),y.info(`[loadCustomDeck] Guest sending custom deck data to host: player ${I}, ${h.length} cards`))},[d,o,i,r,t,a,n]),A=U.useCallback((I,g,u,D)=>{d(E=>{if(!E.isGameStarted||E.board[u.row][u.col].card!==null)return E;const h=Ie(E),w=h.players.find(T=>T.id===I);if(w&&w.discard.length>g){const[T]=w.discard.splice(g,1);T.enteredThisTurn=!0,rr(T,I),(T.baseId==="luciusTheImmortal"||T.name.includes("Lucius"))&&(T.powerModifier===void 0&&(T.powerModifier=0),T.powerModifier+=2),T.statuses||(T.statuses=[]),T.statuses.push({type:"Resurrected",addedByPlayerId:I}),D&&D.forEach(N=>{var L;N.type!=="Resurrected"&&((L=T.statuses)==null||L.push({type:N.type,addedByPlayerId:I}))}),w.boardHistory||(w.boardHistory=[]),w.boardHistory.push(T.id),h.board[u.row][u.col].card=T,$a(h.board,w),h.board=Le(h)}return h})},[d]),f=U.useCallback((I,g)=>{d(u=>{const D=Ie(u),E=D.players.find(h=>h.id===I);if(E&&g.length>0){const h=new Set(g.map(T=>T.id)),w=E.deck.filter(T=>!h.has(T.id));E.deck=[...g,...w]}return D})},[d]),b=U.useCallback((I,g,u)=>{d(D=>{const E=Ie(D),h=E.players.find(w=>w.id===I);return h&&(u==="deck"?h.deck=g:u==="discard"&&(h.discard=g)),E})},[d]),R=U.useCallback((I,g)=>{d(u=>{if(!u.isGameStarted)return u;const D=Ie(u),E=D.players.find(h=>h.id===I);if(E&&E.discard.length>g){const[h]=E.discard.splice(g,1);E.hand.push(h)}return D})},[d]);return{changePlayerDeck:l,loadCustomDeck:c,resurrectDiscardedCard:A,reorderTopDeck:f,reorderCards:b,recoverDiscardedCard:R}}function ys(e){const{ws:t,webrtcManagerRef:r,webrtcIsHostRef:a,gameStateRef:n,scoreDeltaAccumulator:o,setGameState:i,updateState:s,abilityMode:d,setAbilityMode:l,createDeck:c}=e,A=U.useCallback(E=>{ve()&&r.current?a.current?i(w=>{const T=Ua(w,E);return r.current&&r.current.broadcastToGuests({type:"ACTIVE_PLAYER_CHANGED",senderId:r.current.getPeerId(),data:{activePlayerId:T.activePlayerId,currentPhase:T.currentPhase,turnNumber:T.turnNumber},timestamp:Date.now()}),T}):r.current.sendMessageToHost({type:"TOGGLE_ACTIVE_PLAYER",senderId:void 0,data:{playerId:E},timestamp:Date.now()}):t.current&&t.current.readyState===WebSocket.OPEN&&(o.forEach((w,T)=>{clearTimeout(w.timerId),y.info(`[ScoreFlush] Flushing on toggle: player=${T}, delta=${w.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:n.current.gameId,playerId:T,delta:w.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"TOGGLE_ACTIVE_PLAYER",gameId:n.current.gameId,playerId:E})))},[t,r,a,n,o,i]),f=U.useCallback((E,h)=>{t.current&&t.current.readyState===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"TOGGLE_AUTO_DRAW",gameId:n.current.gameId,playerId:E,enabled:h}))},[]),b=U.useCallback(E=>{const h=d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode);h&&l(null),s(w=>{if(!w.isGameStarted)return w;const T=Math.max(1,Math.min(E,4));return{...w,currentPhase:T,...T===4&&!h?{isScoringStep:!0}:{},...h?{isScoringStep:!1}:{}}})},[s,d,l]),R=U.useCallback(()=>{var w;d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&l(null);const E=n.current,h=ve();if(E.isGameStarted&&E.currentPhase===4&&E.isScoringStep&&!h){((w=t.current)==null?void 0:w.readyState)===WebSocket.OPEN&&(o.forEach((T,N)=>{clearTimeout(T.timerId),y.info(`[ScoreFlush] Flushing pending score: player=${N}, delta=${T.delta}`),t.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:E.gameId,playerId:N,delta:T.delta}))}),o.clear(),t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:E.gameId})));return}if(h&&E.isGameStarted&&E.currentPhase===4&&E.isScoringStep){s(T=>yt(T));return}s(T=>{if(!T.isGameStarted)return T;const N=Ie(T),L=T.currentPhase+1;return T.preserveDeployAbilities||N.board.forEach(M=>{M.forEach(_=>{var m;(m=_.card)!=null&&m.statuses&&(_.card.statuses=_.card.statuses.filter(v=>v.type!=="readyDeploy"))})}),h&&L===4&&T.currentPhase===3?es(T,T.activePlayerId)?(N.isScoringStep=!0,N.currentPhase=4,N):(y.info(`[nextPhase] Player ${T.activePlayerId} has no cards on board in Commit phase, auto-passing turn`),yt(T)):L===4&&T.currentPhase===3?(N.isScoringStep=!0,N.currentPhase=4,N):(N.board.forEach(M=>{M.forEach(_=>{var m;if((m=_.card)!=null&&m.statuses){const v=_.card.statuses.findIndex(G=>G.type==="Resurrected");if(v!==-1){const G=_.card.statuses[v].addedByPlayerId;_.card.statuses.splice(v,1),_.card.baseId!=="luciusTheImmortal"&&(_.card.statuses.push({type:"Stun",addedByPlayerId:G}),_.card.statuses.push({type:"Stun",addedByPlayerId:G}))}}})}),N.board=Le(N),N.currentPhase=L,N)})},[s,d,l,n,t,o]),I=U.useCallback(()=>{s(E=>E.isGameStarted?(d&&l&&d.mode&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","INTEGRATOR_LINE_SELECT","ZIUS_LINE_SELECT"].includes(d.mode)&&l(null),E.isScoringStep?{...E,isScoringStep:!1,currentPhase:Math.max(1,E.currentPhase-1)}:{...E,currentPhase:Math.max(1,E.currentPhase-1)}):E)},[s,d,l]),g=U.useCallback(()=>{var h;ve()?s(w=>({...w,isRoundEndModalOpen:!1,currentRound:(w.currentRound||1)+1,players:w.players.map(T=>({...T,score:0}))})):((h=t.current)==null?void 0:h.readyState)===WebSocket.OPEN&&n.current.gameId&&(i(w=>({...w,isRoundEndModalOpen:!1,currentRound:(w.currentRound||1)+1,players:w.players.map(T=>({...T,score:0}))})),t.current.send(JSON.stringify({type:"START_NEXT_ROUND",gameId:n.current.gameId})))},[i,s,t,n]),u=U.useCallback(()=>{i(E=>({...E,isRoundEndModalOpen:!1}))},[i]),D=U.useCallback(()=>{var h;if(ve()){const w=n.current,T=w.players.map(_=>{const m=_.selectedDeck||"SynchroTech";return{..._,hand:[],deck:c(m,_.id,_.name),discard:[],score:0,isReady:!1,announcedCard:null,boardHistory:[]}}),N=w.activeGridSize||8,L=[];for(let _=0;_<N;_++){const m=[];for(let v=0;v<N;v++)m.push({card:null});L.push(m)}const M={...w,players:T,board:L,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,roundEndTriggered:!1,isRoundEndModalOpen:!1,isReadyCheckActive:!1,targetingMode:null,floatingTexts:[]};i(M),n.current=M,r.current&&r.current.broadcastToGuests({type:"GAME_RESET",senderId:r.current.getPeerId(),data:{players:T.map(_=>({id:_.id,name:_.name,color:_.color,selectedDeck:_.selectedDeck,isDummy:_.isDummy,isDisconnected:_.isDisconnected,autoDrawEnabled:_.autoDrawEnabled,handSize:_.hand.length,deckSize:_.deck.length,discardSize:_.discard.length,..._.isDummy&&{hand:_.hand.map(m=>({id:m.id,baseId:m.baseId,name:m.name,imageUrl:m.imageUrl,power:m.power,powerModifier:m.powerModifier,ability:m.ability,ownerId:m.ownerId,color:m.color,deck:m.deck,isFaceDown:m.isFaceDown,types:m.types,faction:m.faction,statuses:m.statuses})),deck:_.deck.map(m=>({id:m.id,baseId:m.baseId,name:m.name,imageUrl:m.imageUrl,power:m.power,powerModifier:m.powerModifier,ability:m.ability,ownerId:m.ownerId,color:m.color,deck:m.deck,isFaceDown:m.isFaceDown,types:m.types,faction:m.faction,statuses:m.statuses})),discard:_.discard.map(m=>({id:m.id,baseId:m.baseId,name:m.name,imageUrl:m.imageUrl,power:m.power,powerModifier:m.powerModifier,ability:m.ability,ownerId:m.ownerId,color:m.color,deck:m.deck,isFaceDown:m.isFaceDown,types:m.types,faction:m.faction,statuses:m.statuses}))},score:_.score,isReady:_.isReady,announcedCard:_.announcedCard})),gameMode:M.gameMode,isPrivate:M.isPrivate,activeGridSize:M.activeGridSize,dummyPlayerCount:M.dummyPlayerCount,autoAbilitiesEnabled:M.autoAbilitiesEnabled,isGameStarted:!1,currentPhase:0,currentRound:1,turnNumber:1,activePlayerId:null,startingPlayerId:null,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,isReadyCheckActive:!1},timestamp:Date.now()})}else((h=t.current)==null?void 0:h.readyState)===WebSocket.OPEN&&t.current.send(JSON.stringify({type:"RESET_GAME",gameId:n.current.gameId}))},[t,r,n,i,c]);return{toggleActivePlayer:A,toggleAutoDraw:f,setPhase:b,nextPhase:R,prevPhase:I,closeRoundEndModal:g,closeRoundEndModalOnly:u,resetGame:D}}function hs(e){const{ws:t,gameStateRef:r,updateState:a,updatePlayerScore:n,triggerFloatingText:o,clearTargetingMode:i}=e,s=U.useCallback((l,c,A,f,b)=>{var L,M;const R=r.current;if(!R.isGameStarted||R.isRoundEndModalOpen)return;const I=R.board.some(_=>_.some(m=>{var v,G;return((v=m.card)==null?void 0:v.ownerId)===b&&m.card.name.toLowerCase().includes("data liberator")&&((G=m.card.statuses)==null?void 0:G.some(C=>C.type==="Support"))})),g=R.board.length;let u=l,D=l,E=c,h=c;if(l===A)u=l,D=l,E=0,h=g-1;else if(c===f)E=c,h=c,u=0,D=g-1;else return;let w=0;const T=[];for(let _=u;_<=D;_++)for(let m=E;m<=h;m++){const G=R.board[_][m].card;if(G&&!((L=G.statuses)!=null&&L.some(C=>C.type==="Stun"))){const C=G.ownerId===b,O=(M=G.statuses)==null?void 0:M.some($=>$.type==="Exploit"&&$.addedByPlayerId===b);if(C||I&&O&&G.ownerId!==b){const $=Math.max(0,G.power+(G.powerModifier||0)+(G.bonusPower||0));$>0&&(w+=$,T.push({row:_,col:m,text:`+${$}`,playerId:b}))}}}T.length>0&&o(T);const N=ve();if(N?a(_=>({..._,players:_.players.map(m=>m.id===b?{...m,score:Math.max(0,(m.score||0)+w)}:m)})):n(b,w),N||n(b,w),w>0&&R.currentPhase===4&&R.activePlayerId===b){const _=R.gameId;setTimeout(()=>{var m;i==null||i(),N?a(v=>yt(v)):((m=t.current)==null?void 0:m.readyState)===WebSocket.OPEN&&_&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:_}))},100)}},[o,n,a,t,r,i,yt]),d=U.useCallback((l,c,A,f,b,R)=>{var N,L;const I=r.current;if(!I.isGameStarted||I.isRoundEndModalOpen)return;const g=A>l?1:-1,u=f>c?1:-1,D=Math.abs(l-A);let E=0,h=0;const w=[];for(let M=0;M<=D;M++){const _=l+M*g,m=c+M*u;if(_<0||_>=I.board.length||m<0||m>=I.board.length)continue;const G=I.board[_][m].card;if(G&&!((N=G.statuses)!=null&&N.some(C=>C.type==="Stun"))&&G.ownerId===b){const O=Math.max(0,G.power+(G.powerModifier||0)+(G.bonusPower||0));O>0&&(E+=O,w.push({row:_,col:m,text:`+${O}`,playerId:b})),R&&((L=G.statuses)!=null&&L.some($=>$.type==="Support"&&$.addedByPlayerId===b))&&(h+=1)}}R==="point_per_support"&&h>0&&(E+=h),w.length>0&&o(w);const T=ve();if(T?a(M=>({...M,players:M.players.map(_=>_.id===b?{..._,score:Math.max(0,(_.score||0)+E)}:_)})):n(b,E),T||n(b,E),R==="draw_per_support"&&h>0&&a(M=>{const _=Ie(M),m=_.players.find(v=>v.id===b);if(m&&m.deck.length>0)for(let v=0;v<h;v++)m.deck.length>0&&m.hand.push(m.deck.shift());return _}),E>0&&I.currentPhase===4&&I.activePlayerId===b){const M=I.gameId;setTimeout(()=>{var _;i==null||i(),T?a(m=>yt(m)):((_=t.current)==null?void 0:_.readyState)===WebSocket.OPEN&&M&&t.current.send(JSON.stringify({type:"NEXT_PHASE",gameId:M}))},500)}},[o,n,a,t,r,i,yt]);return{scoreLine:s,scoreDiagonal:d}}const ms=e=>{const{updateState:t,rawJsonData:r}=e,a=U.useCallback((A,f,b,R)=>{t(I=>{var D,E;if(!I.isGameStarted||A.row<0||A.col<0)return I;const g=Ie(I),u=(E=(D=g.board[A.row])==null?void 0:D[A.col])==null?void 0:E.card;if(u){const h=u.statuses?u.statuses.map(w=>w.type):[];if(R&&u.statuses){u.statuses=u.statuses.filter(T=>T.type!==R);const w=u.statuses.map(T=>T.type);y.debug(`[markAbilityUsed] Removed status '${R}' from ${u.name} at [${A.row},${A.col}]: [${h.join(", ")}] -> [${w.join(", ")}]`)}else y.debug(`[markAbilityUsed] Called for ${u.name} at [${A.row},${A.col}] but no readyStatusToRemove specified. Current statuses: [${h.join(", ")}]`)}return g})},[t]),n=U.useCallback(A=>{t(f=>{var I,g;if(!f.isGameStarted||A.row<0||A.col<0)return f;const b=Ie(f),R=(g=(I=b.board[A.row])==null?void 0:I[A.col])==null?void 0:g.card;if(R&&(R.statuses||(R.statuses=[]),(R.ability||"").toLowerCase().includes("deploy:")&&!R.statuses.some(D=>D.type==="readyDeploy"))){const D=R.ownerId;if(D==null||D===0)return f;R.statuses.push({type:"readyDeploy",addedByPlayerId:D})}return b})},[t]),o=U.useCallback((A,f)=>{t(b=>{if(!b.isGameStarted)return b;const R=Ie(b),I=R.board[A.row][A.col].card;return I!=null&&I.statuses&&(I.statuses=I.statuses.filter(g=>g.type!==f)),R.board=Le(R),R})},[t]),i=U.useCallback((A,f,b,R,I)=>{t(g=>{if(!g.isGameStarted)return g;const u=Ie(g);return f.forEach(({row:D,col:E})=>{var w;const h=u.board[D][E].card;if(h){if(b==="Stun"&&(h.baseId==="luciusTheImmortal"||h.name.includes("Lucius")&&((w=h.types)!=null&&w.includes("Hero"))))return;h.statuses||(h.statuses=[]),["Support","Threat","Revealed"].includes(b)?h.statuses.some(N=>N.type===b&&N.addedByPlayerId===R)||h.statuses.push({type:b,addedByPlayerId:R}):h.statuses.push({type:b,addedByPlayerId:R})}}),u})},[t]),s=U.useCallback((A,f)=>{t(b=>{if(!b.isGameStarted)return b;const R=Ie(b),I=R.board[A.row][A.col].card,g=R.board[f.row][f.col].card;return R.board[A.row][A.col].card=g,R.board[f.row][f.col].card=I,R.board=Le(R),R})},[t]),d=U.useCallback((A,f,b)=>{t(R=>{if(!R.isGameStarted)return R;const I=Ie(R),g=I.board[A.row][A.col].card,u=I.board[f.row][f.col].card;if(g&&u&&g.statuses){const D=g.statuses.findIndex(E=>E.type===b);if(D>-1){const[E]=g.statuses.splice(D,1);u.statuses||(u.statuses=[]),u.statuses.push(E)}}return I.board=Le(I),I})},[t]),l=U.useCallback((A,f)=>{t(b=>{if(!b.isGameStarted)return b;const R=Ie(b),I=R.board[A.row][A.col].card,g=R.board[f.row][f.col].card,u=["Support","Threat","LastPlayed"];if(I&&g&&I.statuses){const D=I.statuses.filter(h=>!u.includes(h.type)),E=I.statuses.filter(h=>u.includes(h.type));D.length>0&&(g.statuses||(g.statuses=[]),g.statuses.push(...D),I.statuses=E)}return R.board=Le(R),R})},[t]),c=U.useCallback((A,f,b)=>{t(R=>{if(!R.isGameStarted)return R;const I=Ie(R);if(!r)return R;const g=r.tokenDatabase,u=Object.keys(g).find(h=>g[h].name===f);if(!u)return R;const D=g[u],E=I.players.find(h=>h.id===b);if(D&&I.board[A.row][A.col].card===null){const h={id:`TKN_${f.toUpperCase().replace(/\s/g,"_")}_${Date.now()}`,deck:Re.Tokens,name:f,baseId:D.baseId||u,imageUrl:D.imageUrl,fallbackImage:D.fallbackImage,power:D.power,ability:D.ability,flavorText:D.flavorText,color:D.color,types:D.types||["Unit"],faction:"Tokens",ownerId:b,ownerName:E==null?void 0:E.name,enteredThisTurn:!0,statuses:[]};rr(h,b),I.board[A.row][A.col].card=h}return I.board=Le(I),I})},[t,r]);return{markAbilityUsed:a,applyGlobalEffect:i,swapCards:s,transferStatus:d,transferAllCounters:l,spawnToken:c,resetDeployStatus:n,removeStatusByType:o}};function Is(e){const{updateState:t,localPlayerIdRef:r,updatePlayerScore:a}=e;return{moveItem:U.useCallback((o,i)=>{t(s=>{var R,I,g,u,D,E,h,w,T,N,L,M;if(!s.isGameStarted||i.target==="board"&&i.boardCoords&&s.board[i.boardCoords.row][i.boardCoords.col].card!==null&&o.source!=="counter_panel")return s;let d=!1;try{const _=localStorage.getItem("auto_abilities_enabled");d=_===null?!0:_==="true"}catch{d=!0}const l=d&&s.currentPhase===1&&o.source==="hand"&&i.target==="board"&&(((R=o.card.types)==null?void 0:R.includes("Unit"))||((I=o.card.types)==null?void 0:I.includes("Command"))),c=Ie(s);if(o.source==="board"&&["hand","deck","discard"].includes(i.target)&&!o.bypassOwnershipCheck){const _=o.card.ownerId,m=c.players.find(C=>C.id===_),v=_===r.current,G=!!(m!=null&&m.isDummy);if(!v&&!G)return s}let A=null;if(o.source==="board"&&i.target==="board"&&o.boardCoords){const _=c.board[o.boardCoords.row][o.boardCoords.col];_.card&&(A=_.card);const v=s.board[o.boardCoords.row][o.boardCoords.col].card||A;if(v&&((g=v.statuses)==null?void 0:g.some(C=>C.type==="Stun"))){const C=r.current,O=v.ownerId,$=s.players.find(K=>K.id===C),B=s.players.find(K=>K.id===O),X=C===O,q=($==null?void 0:$.teamId)!==void 0&&(B==null?void 0:B.teamId)!==void 0&&$.teamId===B.teamId;if((X||q)&&!o.isManual)return s}}if(o.source==="counter_panel"&&o.statusType){const _=ht[o.statusType],m=(_==null?void 0:_.allowedTargets)??["board","hand"];if(!m.includes(i.target)&&!m.includes("board-facedown"))return s;let v=null;if(i.target==="board"&&i.boardCoords){if(v=c.board[i.boardCoords.row][i.boardCoords.col].card,m.includes("board-facedown")&&v&&!v.isFaceDown)return s}else if(i.playerId!==void 0){const G=c.players.find(C=>C.id===i.playerId);G&&(i.target==="hand"&&i.cardIndex!==void 0&&(v=G.hand[i.cardIndex]),i.target==="announced"&&(v=G.announcedCard||null),i.target==="deck"&&G.deck.length>0?i.deckPosition==="top"||!i.deckPosition?v=G.deck[0]:v=G.deck[G.deck.length-1]:i.target==="discard"&&G.discard.length>0&&(v=G.discard[G.discard.length-1]))}if(v){if(o.statusType==="Revealed"){const O=r.current;if(i.target==="board"&&v.ownerId===O||i.target==="hand"&&i.playerId===O)return s}if(o.statusType==="Stun"&&(v.baseId==="luciusTheImmortal"||v.name.includes("Lucius")&&((u=v.types)!=null&&u.includes("Hero"))))return c;const G=o.count||1;let C;if(o.ownerId!==void 0)C=o.ownerId;else if(o.card.ownerId!==void 0)C=o.card.ownerId;else{const O=c.players.find($=>$.id===c.activePlayerId);C=O!=null&&O.isDummy?O.id:r.current!==null?r.current:0}if(o.statusType==="Power+")v.powerModifier===void 0&&(v.powerModifier=0),v.powerModifier+=1*G;else if(o.statusType==="Power-")v.powerModifier===void 0&&(v.powerModifier=0),v.powerModifier-=1*G;else if(v.statuses||(v.statuses=[]),o.replaceStatusType&&o.statusType)for(let O=0;O<G;O++){const $=v.statuses.findIndex(B=>B.type===o.replaceStatusType&&B.addedByPlayerId===C);$!==-1?v.statuses[$]={type:o.statusType,addedByPlayerId:C}:v.statuses.push({type:o.statusType,addedByPlayerId:C})}else for(let O=0;O<G;O++)["Support","Threat","Revealed"].includes(o.statusType)?v.statuses.some(B=>B.type===o.statusType&&B.addedByPlayerId===C)||v.statuses.push({type:o.statusType,addedByPlayerId:C}):v.statuses.push({type:o.statusType,addedByPlayerId:C});return i.target==="board"&&(c.board=Le(c)),c}return s}const f=A?{...A}:{...o.card};if(o.source==="hand"&&o.playerId!==void 0&&o.cardIndex!==void 0){const _=c.players.find(m=>m.id===o.playerId);if(_){const m=_.hand[o.cardIndex];if(m&&m.id===o.card.id&&m.ownerId===o.card.ownerId)_.hand.splice(o.cardIndex,1);else{const v=_.hand.findIndex(G=>G.id===o.card.id&&G.ownerId===o.card.ownerId);if(v!==-1)_.hand.splice(v,1);else return s}}}else if(o.source==="board"&&o.boardCoords){const _=c.board[o.boardCoords.row][o.boardCoords.col];if(_.card&&_.card.id===o.card.id&&_.card.ownerId===o.card.ownerId)c.board[o.boardCoords.row][o.boardCoords.col].card=null;else return s}else if(o.source==="discard"&&o.playerId!==void 0){const _=c.players.find(m=>m.id===o.playerId);if(_){let m=!1;if(o.cardIndex!==void 0){const v=_.discard[o.cardIndex];v&&v.id===o.card.id&&v.ownerId===o.card.ownerId&&(_.discard.splice(o.cardIndex,1),m=!0)}if(!m){const v=_.discard.findIndex(G=>G.id===o.card.id&&G.ownerId===o.card.ownerId);if(v!==-1)_.discard.splice(v,1);else return s}}}else if(o.source==="deck"&&o.playerId!==void 0&&o.cardIndex!==void 0){const _=c.players.find(m=>m.id===o.playerId);if(_){const m=_.deck[o.cardIndex];if(m&&m.id===o.card.id&&m.ownerId===o.card.ownerId)_.deck.splice(o.cardIndex,1);else{const v=_.deck.findIndex(G=>G.id===o.card.id&&G.ownerId===o.card.ownerId);if(v!==-1)_.deck.splice(v,1);else return s}}}else if(o.source==="announced"&&o.playerId!==void 0){const _=c.players.find(m=>m.id===o.playerId);if(_)if(_.announcedCard&&_.announcedCard.id===o.card.id)_.announcedCard=null;else return s}if(["hand","deck","discard"].includes(i.target))f.statuses&&(f.statuses=f.statuses.filter(_=>_.type==="Revealed")),f.isFaceDown=!1,delete f.powerModifier,delete f.bonusPower,delete f.enteredThisTurn;else if(i.target==="board"&&(f.statuses||(f.statuses=[]),o.source!=="board"&&f.isFaceDown===void 0&&(f.isFaceDown=!1),o.source!=="board")){f.enteredThisTurn=!0;let _=f.ownerId;_===void 0&&(o.source==="token_panel"?_=c.activePlayerId??r.current??0:o.playerId!==void 0?_=o.playerId:_=r.current??0,f.ownerId=_),rr(f,_),o.source==="discard"&&(f.baseId==="luciusTheImmortal"||f.name.includes("Lucius"))&&(f.powerModifier===void 0&&(f.powerModifier=0),f.powerModifier+=2)}if(i.target==="hand"&&i.playerId!==void 0){if((f.deck===Re.Tokens||f.deck==="counter")&&(((D=f.types)==null?void 0:D.includes("Token"))||((E=f.types)==null?void 0:E.includes("Token Unit"))))return c.board[o.sourceBoardCoords.row][o.sourceBoardCoords.col].card=null,c;Ht(f);const m=c.players.find(G=>G.id===i.playerId);if(!m)return s;let v=i.cardIndex!==void 0?i.cardIndex:m.hand.length;if(o.source==="hand"&&o.playerId===i.playerId&&o.cardIndex!==void 0&&(o.cardIndex<v&&(v-=1),o.cardIndex===v))return s;m.hand.splice(v,0,f)}else if(i.target==="board"&&i.boardCoords){if(c.board[i.boardCoords.row][i.boardCoords.col].card===null){if(f.ownerId===void 0&&r.current!==null){const _=c.players.find(m=>m.id===r.current);_&&(f.ownerId=_.id,f.ownerName=_.name)}if(o.source!=="board"&&f.ownerId!==void 0){const _=c.players.find(m=>m.id===f.ownerId);_&&(_.boardHistory||(_.boardHistory=[]),_.boardHistory.push(f.id))}c.board[i.boardCoords.row][i.boardCoords.col].card=f}}else if(i.target==="discard"&&i.playerId!==void 0){if((f.deck===Re.Tokens||f.deck==="counter")&&(((h=f.types)==null?void 0:h.includes("Token"))||((w=f.types)==null?void 0:w.includes("Token Unit"))))return c.board[o.sourceBoardCoords.row][o.sourceBoardCoords.col].card=null,c;Ht(f),f.statuses&&(f.statuses=f.statuses.filter(v=>v.type!=="Revealed"));const m=c.players.find(v=>v.id===i.playerId);m&&(f.ownerId===void 0&&(f.ownerId=i.playerId,f.ownerName=m.name),m.discard.some(G=>G.id===f.id)||m.discard.push(f))}else if(i.target==="deck"&&i.playerId!==void 0){if((f.deck===Re.Tokens||f.deck==="counter")&&(((T=f.types)==null?void 0:T.includes("Token"))||((N=f.types)==null?void 0:N.includes("Token Unit"))))return c.board[o.sourceBoardCoords.row][o.sourceBoardCoords.col].card=null,c;Ht(f),f.statuses&&(f.statuses=f.statuses.filter(v=>v.type!=="Revealed"));const m=c.players.find(v=>v.id===i.playerId);if(!m)return s;f.ownerId===void 0&&(f.ownerId=i.playerId,f.ownerName=m.name),i.deckPosition==="top"||!i.deckPosition?m.deck.unshift(f):m.deck.push(f)}else if(i.target==="announced"&&i.playerId!==void 0){const _=c.players.find(m=>m.id===i.playerId);_&&(_.announcedCard&&(_.announcedCard.statuses&&(_.announcedCard.statuses=_.announcedCard.statuses.filter(m=>m.type==="Revealed")),delete _.announcedCard.enteredThisTurn,delete _.announcedCard.powerModifier,delete _.announcedCard.bonusPower,_.hand.push(_.announcedCard)),_.announcedCard=f)}if(o.source==="board"&&i.target!=="board"&&f.ownerId!==void 0){const _=c.players.find(m=>m.id===f.ownerId);_&&(_.boardHistory||(_.boardHistory=[]),_.boardHistory=_.boardHistory.filter(m=>m!==f.id))}if((o.source==="board"||i.target==="board")&&f.ownerId!==void 0){const _=c.players.find(m=>m.id===f.ownerId);_&&$a(c.board,_)}if(o.source==="hand"&&i.target==="board"){const _=f;if(_.revealedTo==="all"||((L=_.statuses)==null?void 0:L.some(v=>v.type==="Revealed"))){const v=c.board.length;for(let G=0;G<v;G++)for(let C=0;C<v;C++){const O=c.board[G][C].card;if(O&&O.name.toLowerCase().includes("vigilant spotter")&&O.ownerId!==_.ownerId&&(c.board=Le(c),(M=c.board[G][C].card.statuses)!=null&&M.some(B=>B.type==="Support"))){const B=c.players.find(X=>X.id===O.ownerId);B&&setTimeout(()=>{a(B.id,2)},0)}}}}return(o.source==="board"||i.target==="board")&&(c.board=Le(c)),l&&(c.currentPhase=2),c})},[t,r,a])}}function Es(e){const{ws:t,webrtcManager:r,gameStateRef:a,webrtcIsHostRef:n,setGameState:o}=e,i=U.useCallback((d,l,c,A,f)=>{var D,E,h,w,T,N,L;const b=a.current;if(typeof l!="number"){y.error(`[TargetingMode] Invalid playerId type: ${typeof l}, value:`,l);return}let R=[];A?R=A:R=Nt(d,b,l,f);const I=[],g=d.mode==="SELECT_DECK";if((D=d.payload)!=null&&D.filter&&d.mode==="SELECT_TARGET"){y.info("[TargetingMode] Calculating hand targets for action",{actionMode:d.mode,filterType:typeof d.payload.filter,hasActionType:!!d.payload.actionType});for(const M of b.players)M.hand&&M.hand.forEach((_,m)=>{try{d.payload.filter(_)&&(I.push({playerId:M.id,cardIndex:m}),y.debug(`[TargetingMode] Found hand target: player ${M.id}, card ${m}, card ${_.name}`))}catch(v){y.warn(`[TargetingMode] Filter failed for card ${_.name}:`,v)}});y.info(`[TargetingMode] Hand targets calculated: ${I.length} targets`)}else y.info("[TargetingMode] No hand targets calculated - no filter or wrong mode",{hasFilter:!!((E=d.payload)!=null&&E.filter),mode:d.mode});const u={playerId:l,action:d,sourceCoords:c,timestamp:Date.now(),boardTargets:R,handTargets:I.length>0?I:void 0,isDeckSelectable:g||void 0,originalOwnerId:d.originalOwnerId};if(o(M=>({...M,targetingMode:u})),a.current.targetingMode=u,((h=t.current)==null?void 0:h.readyState)===WebSocket.OPEN&&b.gameId&&t.current.send(JSON.stringify({type:"SET_TARGETING_MODE",gameId:b.gameId,targetingMode:u})),r.current)if(n.current)r.current.broadcastToGuests({type:"SET_TARGETING_MODE",senderId:((T=(w=r.current).getPeerId)==null?void 0:T.call(w))??void 0,data:{targetingMode:u},timestamp:Date.now()});else{const M=r.current.sendMessageToHost({type:"SET_TARGETING_MODE",senderId:((L=(N=r.current).getPeerId)==null?void 0:L.call(N))??void 0,data:{targetingMode:u},timestamp:Date.now()});y.info("[TargetingMode] Guest sent SET_TARGETING_MODE to host",{success:M,playerId:l,boardTargetsCount:R.length,handTargetsCount:I.length})}y.info(`[TargetingMode] Player ${l} (type: ${typeof l}) activated targeting mode`,{mode:d.mode,boardTargetsCount:R.length,handTargetsCount:I.length,isDeckSelectable:g||!1})},[t,r,a,n,o]),s=U.useCallback(()=>{var l,c,A,f,b;const d=a.current;o(R=>({...R,targetingMode:null})),a.current.targetingMode=null,((l=t.current)==null?void 0:l.readyState)===WebSocket.OPEN&&d.gameId&&t.current.send(JSON.stringify({type:"CLEAR_TARGETING_MODE",gameId:d.gameId})),r.current&&(n.current?r.current.broadcastToGuests({type:"CLEAR_TARGETING_MODE",senderId:((A=(c=r.current).getPeerId)==null?void 0:A.call(c))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}):r.current.sendMessageToHost({type:"CLEAR_TARGETING_MODE",senderId:((b=(f=r.current).getPeerId)==null?void 0:b.call(f))??void 0,data:{timestamp:Date.now()},timestamp:Date.now()}))},[t,r,a,n,o]);return{setTargetingMode:i,clearTargetingMode:s}}function Ts(e){const{webrtcManagerRef:t,webrtcIsHostRef:r,setWebrtcIsHost:a,setConnectionStatus:n,setWebrtcHostId:o,gameStateRef:i,localPlayerIdRef:s}=e,d=U.useCallback(async()=>{var b;if(!t.current)return y.error("WebRTC manager not initialized"),null;try{a(!0),n("Connecting");const R=await t.current.initializeAsHost();o(R),n("Connected");const I=i.current.gameId;I&&Zt(R,I);const g=(b=i.current.players)==null?void 0:b.find(u=>u.id===s.current);return vo({peerId:R,isHost:!0,playerName:(g==null?void 0:g.name)||null}),y.info("[initializeWebrtcHost] Saved host data for auto-restore"),R}catch(R){return y.error("Failed to initialize WebRTC host:",R),n("Disconnected"),null}},[t,a,n,o,i,s]),l=U.useCallback(async b=>{if(!t.current)return y.error("WebRTC manager not initialized"),!1;try{return a(!1),o(b),n("Connecting"),await t.current.initializeAsGuest(b),!0}catch(R){return y.error("Failed to connect as guest:",R),n("Disconnected"),!1}},[t,a,n,o]),c=U.useCallback((b,R)=>t.current?r.current?(y.warn("[sendWebrtcAction] Host mode, cannot send action to self"),!1):t.current.sendAction(b,R):(y.warn("[sendWebrtcAction] No webrtcManagerRef.current"),!1),[t,r]),A=U.useCallback(b=>{var I,g;if(!t.current||r.current)return y.warn("[requestDeckView] Only guests can request deck view from host"),!1;const R={type:"REQUEST_DECK_VIEW",senderId:t.current.getPeerId(),playerId:r.current||(g=(I=t.current).getLocalPlayerId)==null?void 0:g.call(I),data:{targetPlayerId:b},timestamp:Date.now()};return t.current.sendMessageToHost(R)},[t,r]),f=U.useCallback((b,R,I)=>!t.current||r.current?(y.warn("[sendFullDeckToHost] Only guests can send deck data to host"),!1):t.current.sendFullDeckToHost(b,R,I),[t,r]);return{initializeWebrtcHost:d,connectAsGuest:l,sendWebrtcAction:c,requestDeckView:A,sendFullDeckToHost:f}}function gs(){const e=localStorage.getItem("custom_ws_url");if(!e||e.trim()==="")return y.warn("No custom WebSocket URL configured in settings."),null;let t=e.trim();return t.endsWith("/")&&(t=t.slice(0,-1)),t.startsWith("https://")?t=t.replace("https://","wss://"):t.startsWith("http://")&&(t=t.replace("http://","ws://")),!t.startsWith("ws://")&&!t.startsWith("wss://")?(y.warn("Invalid WebSocket URL format (must start with ws:// or wss://)"),null):(localStorage.setItem("websocket_url",t),t)}function ws(e){const{gameStateRef:t,localPlayerIdRef:r,setGameState:a,setLocalPlayerId:n,setConnectionStatus:o,setGamesList:i,setLatestHighlight:s,setLatestNoTarget:d,setLatestDeckSelections:l,setLatestHandCardSelections:c,setTargetSelectionEffects:A,setLatestFloatingTexts:f,setRemoteValidTargets:b,isManualExitRef:R,joiningGameIdRef:I,playerTokenRef:g,receivedServerStateRef:u,isJoinAttemptRef:D}=e,E=U.useRef(null),h=U.useRef(null),w=U.useCallback(()=>{if(ve()){o("Connected");return}if(R.current||E.current&&(E.current.readyState===WebSocket.OPEN||E.current.readyState===WebSocket.CONNECTING))return;const v=gs();if(!v){y.warn("No WebSocket URL configured in settings. Waiting for user input."),o("Disconnected"),h.current&&clearTimeout(h.current);return}try{E.current=new WebSocket(v)}catch(G){y.error("Failed to create WebSocket:",G),o("Disconnected"),h.current&&clearTimeout(h.current),h.current=window.setTimeout(w,oe.RECONNECT_DELAY);return}o("Connecting"),E.current.onopen=()=>{var O;u.current=!1,o("Connected");const G=localStorage.getItem("custom_ws_url");G&&G.trim()!==""&&localStorage.setItem("websocket_url",G.trim());const C=t.current;if(y.info("Current gameState on open:",C?`gameId=${C.gameId}`:"null"),y.info("playerTokenRef.current on open:",g.current?"YES":"NO"),C&&C.gameId&&((O=E.current)==null?void 0:O.readyState)===WebSocket.OPEN){let $=g.current;if(!$){try{const B=localStorage.getItem(nt);if(B){const X=JSON.parse(B);y.info("RECONNECTION_DATA_KEY:",X==null?void 0:X.gameId,C.gameId),X!=null&&X.playerToken&&($=X.playerToken,g.current=$,y.info("Using playerToken from RECONNECTION_DATA_KEY"))}}catch(B){console.warn("Failed to parse reconnection data:",B instanceof Error?B.message:String(B))}if(!$&&C.players&&r.current){const B=C.players.find(X=>X.id===r.current);B!=null&&B.playerToken&&($=B.playerToken,g.current=$)}}y.info("JoinGame: Sending reconnection with token:",$?"YES":"NO","gameId:",C.gameId),E.current.send(JSON.stringify({type:"JOIN_GAME",gameId:C.gameId,playerToken:$}))}},E.current.onmessage=G=>{try{const C=JSON.parse(G.data);if(C.type==="GAMES_LIST")i(C.games);else if(C.type==="JOIN_SUCCESS"){if(C.isSpectator){n(null),y.info("Joined as spectator:",C.message||"Spectator mode"),I.current=null;return}n(C.playerId);const O=I.current||t.current.gameId;O&&C.playerId!==null&&C.playerToken?(g.current=C.playerToken,localStorage.setItem(nt,JSON.stringify({gameId:O,playerId:C.playerId,playerToken:C.playerToken,timestamp:Date.now()})),t.current.gameId===O&&Ia(t.current,C.playerId,C.playerToken)):C.playerId===null&&(pt(),g.current=void 0),I.current=null,C.playerId===1&&setTimeout(()=>{var $;(($=E.current)==null?void 0:$.readyState)===WebSocket.OPEN&&E.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe}))},oe.DECK_SYNC_DELAY)}else if(C.type==="CONNECTION_ESTABLISHED"){y.info("Connection acknowledged by server");const O=sessionStorage.getItem("pending_invite_game"),$=sessionStorage.getItem("pending_invite_name");O&&E.current&&(sessionStorage.removeItem("pending_invite_game"),sessionStorage.removeItem("pending_invite_name"),y.info("Auto-joining invite game:",O),E.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:O,playerName:$||"Player"})))}else if(C.type==="DECK_DATA_UPDATED")y.info("Deck data synced with server");else if(C.type==="ERROR")if(C.message.includes("not found")||C.message.includes("Dummy")){y.info("Game not found error - clearing state");const O=at();a(O),t.current=O,n(null),pt(),I.current=null}else if(C.message.includes("already started")&&D.current){y.info("Game already started - showing alert and returning to menu"),alert("This game has already started.");const O=at();a(O),t.current=O,n(null),pt(),I.current=null,D.current=!1}else console.warn("Server Error:",C.message);else if(C.type==="HIGHLIGHT_TRIGGERED")s(C.highlightData);else if(C.type==="NO_TARGET_TRIGGERED")d({coords:C.coords,timestamp:C.timestamp});else if(C.type==="DECK_SELECTION_TRIGGERED")l(O=>[...O,C.deckSelectionData]),setTimeout(()=>{l(O=>O.filter($=>$.timestamp!==C.deckSelectionData.timestamp))},1e3);else if(C.type==="HAND_CARD_SELECTION_TRIGGERED")c(O=>[...O,C.handCardSelectionData]),setTimeout(()=>{c(O=>O.filter($=>$.timestamp!==C.handCardSelectionData.timestamp))},1e3);else if(C.type==="FLOATING_TEXT_TRIGGERED")a(O=>({...O,floatingTexts:[...O.floatingTexts,C.floatingTextData].filter($=>Date.now()-$.timestamp<oe.FLOATING_TEXT_DURATION)}));else if(C.type==="FLOATING_TEXT_BATCH_TRIGGERED")a(O=>({...O,floatingTexts:[...O.floatingTexts,...C.batch].filter($=>Date.now()-$.timestamp<oe.FLOATING_TEXT_DURATION)}));else if(C.type==="SYNC_VALID_TARGETS")C.playerId,r.current;else if(C.type==="TARGET_SELECTION_TRIGGERED")C.effect&&C.playerId!==r.current&&(A(O=>[...O,C.effect]),setTimeout(()=>{A(O=>O.filter($=>$.timestamp!==C.effect.timestamp))},1e3));else if(C.type==="TARGETING_MODE_SET"){const O=C.targetingMode;O&&(a($=>({...$,targetingMode:O})),t.current.targetingMode=O,y.info("[TargetingMode] Received targeting mode from server",{playerId:O.playerId,mode:O.action.mode}))}else if(C.type==="TARGETING_MODE_CLEARED")a(O=>({...O,targetingMode:null})),t.current.targetingMode=null,y.debug("[TargetingMode] Cleared targeting mode from server");else if(C.type==="ABILITY_MODE_SET")C.abilityMode&&(a(O=>({...O,abilityMode:C.abilityMode})),y.info("[AbilityMode] Received ability mode from host",{playerId:C.abilityMode.playerId,mode:C.abilityMode.mode,sourceCard:C.abilityMode.sourceCardName}));else if(C.type==="ABILITY_TARGET_SELECTED")y.info("[Ability] Target selected",C.data);else if(C.type==="ABILITY_COMPLETED")a(O=>({...O,abilityMode:null})),y.info("[Ability] Ability completed",C.data);else if(C.type==="ABILITY_CANCELLED")a(O=>({...O,abilityMode:null})),y.info("[Ability] Ability cancelled");else if(C.type==="GAME_RESET")y.info("[GameReset] Received GAME_RESET message from server"),a(O=>{const $=C.activeGridSize||8,B=[];for(let q=0;q<$;q++){const K=[];for(let V=0;V<$;V++)K.push({card:null});B.push(K)}const X={...O,players:C.players||[],gameMode:C.gameMode,isPrivate:C.isPrivate,activeGridSize:C.activeGridSize,dummyPlayerCount:C.dummyPlayerCount,autoAbilitiesEnabled:C.autoAbilitiesEnabled,isGameStarted:C.isGameStarted,currentPhase:C.currentPhase,currentRound:C.currentRound,turnNumber:C.turnNumber,activePlayerId:C.activePlayerId,startingPlayerId:C.startingPlayerId,roundWinners:C.roundWinners||{},gameWinner:C.gameWinner,isRoundEndModalOpen:C.isRoundEndModalOpen,isReadyCheckActive:C.isReadyCheckActive,board:B,targetingMode:null,floatingTexts:[]};return t.current=X,X});else if(!C.type&&C.players&&C.board){const O=At(C),$=t.current;if(!$.isScoringStep&&O.isScoringStep&&O.currentPhase!==2){y.debug("Ignoring delayed scoring state update");return}if($.isScoringStep&&(O.currentPhase!==$.currentPhase||O.activePlayerId!==$.activePlayerId||O.currentPhase!==4)&&(O.isScoringStep=!1),a(O),t.current=O,r.current!==null&&O.gameId){let X;try{const q=localStorage.getItem(nt);q&&(X=JSON.parse(q).playerToken)}catch{}if(!X&&O.players){const q=O.players.find(K=>K.id===r.current);q!=null&&q.playerToken&&(X=q.playerToken,g.current=X)}Ia(O,r.current,X)}}else console.warn("Unknown message type:",C.type,"keys:",Object.keys(C),"data:",C)}catch(C){y.error("Failed to parse message from server:",G.data,C)}},E.current.onclose=()=>{o("Disconnected"),R.current||(h.current&&clearTimeout(h.current),h.current=window.setTimeout(w,oe.RECONNECT_DELAY))},E.current.onerror=G=>y.error("WebSocket error event:",G)},[a,o,i,s,d,l,c,A,f,b,n,at,R,t,r,g,u,I]),T=U.useCallback(()=>{E.current&&(E.current.readyState===WebSocket.OPEN||E.current.readyState===WebSocket.CONNECTING)?E.current.close():w()},[E,w]),N=U.useCallback(v=>{var G;if(R.current=!1,((G=E.current)==null?void 0:G.readyState)===WebSocket.OPEN){I.current=v;let C=null;try{const $=localStorage.getItem(nt);$&&(C=JSON.parse($))}catch{pt()}const O={type:"JOIN_GAME",gameId:v};(C==null?void 0:C.gameId)===v&&C.playerToken?(O.playerToken=C.playerToken,y.info(`JoinGame: Sending reconnection with token ${C.playerToken.substring(0,8)}... for player ${C.playerId}`)):y.info(`JoinGame: No reconnection data or gameId mismatch. storedGameId=${C==null?void 0:C.gameId}, requestedGameId=${v}`),E.current.send(JSON.stringify(O))}else w(),I.current=v},[E,R,I,w]),L=U.useCallback((v,G="Player")=>{var C;R.current=!1,((C=E.current)==null?void 0:C.readyState)===WebSocket.OPEN?E.current.send(JSON.stringify({type:"JOIN_AS_INVITE",gameId:v,playerName:G})):(sessionStorage.setItem("pending_invite_game",v),sessionStorage.setItem("pending_invite_name",G),w())},[w]),M=U.useCallback(()=>{R.current=!1,pt();const v=Ha(),G={...at(),gameId:v,players:[Fa(1)]};return u.current=!0,setTimeout(()=>{var C;((C=E.current)==null?void 0:C.readyState)===WebSocket.OPEN&&(E.current.send(JSON.stringify({type:"SUBSCRIBE",gameId:v})),E.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe})))},oe.DECK_SYNC_DELAY),{gameId:v,initialState:G}},[R,u]),_=U.useCallback(()=>{var v;((v=E.current)==null?void 0:v.readyState)===WebSocket.OPEN&&E.current.send(JSON.stringify({type:"GET_GAMES_LIST"}))},[E]),m=U.useCallback((v,G,C,O)=>{var X;if(v.current)return;R.current=!0;const $=t.current.gameId,B=r.current;$&&G.current&&C($);try{O(),sessionStorage.removeItem("webrtc_auto_restore_attempted"),y.info("[exitGame] Cleared WebRTC persistence data")}catch(q){y.warn("[exitGame] Failed to clear WebRTC data:",q)}a(at()),n(null),pt(),E.current&&(E.current.onclose=null),((X=E.current)==null?void 0:X.readyState)===WebSocket.OPEN&&$&&B!==null&&E.current.send(JSON.stringify({type:"EXIT_GAME",gameId:$,playerId:B})),E.current&&E.current.close(),setTimeout(()=>{R.current=!1,w()},oe.RECONNECT_DELAY)},[t,r,R,a,n,E,w]);return{ws:E,reconnectTimeoutRef:h,connectWebSocket:w,forceReconnect:T,createGame:M,joinGame:N,joinAsInvite:L,exitGame:m,requestGamesList:_}}const Xe=new Map,Si=(e={})=>{const{abilityMode:t,setAbilityMode:r}=e,[a,n]=U.useState(at()),o=U.useRef(at()),i=U.useCallback(p=>{n(ae=>{const ee=typeof p=="function"?p(ae):p;return o.current=ae,ve()&&J.current&&setTimeout(()=>{z.current&&(z.current.broadcastGameState(ee),y.debug(`[setGameStateWithDelta] Broadcast state: phase=${ee.currentPhase}, round=${ee.currentRound}`))},0),ee})},[]),[s,d]=U.useState(null),l=U.useRef(a),c=U.useRef(s),[A,f]=U.useState(null),[b,R]=U.useState("Connecting"),[I,g]=U.useState([]),[u,D]=U.useState(null),[E,h]=U.useState(null),[w,T]=U.useState(null),[N,L]=U.useState([]),[M,_]=U.useState([]),[m,v]=U.useState([]),[G,C]=U.useState(null),[O,$]=U.useState(!!Fe),[B,X]=U.useState(!1),[q,K]=U.useState(null),[V,te]=U.useState(!1),J=U.useRef(!1),[ge,Ee]=U.useState(!1),[_e,ke]=U.useState(null),De=U.useRef(!1),be=U.useRef(null),Be=U.useRef(!1),Lt=U.useRef(!1),dt=U.useRef(),Ke=U.useRef(!1),z=U.useRef(null),Oe=U.useRef(()=>{}),xe=Ts({webrtcManagerRef:z,webrtcIsHostRef:J,setWebrtcIsHost:te,setConnectionStatus:R,setWebrtcHostId:K,gameStateRef:l,localPlayerIdRef:c}),{initializeWebrtcHost:Ve,connectAsGuest:Qe,sendWebrtcAction:et,requestDeckView:dr,sendFullDeckToHost:tt}=xe,ct=ws({gameStateRef:l,localPlayerIdRef:c,setGameState:n,setLocalPlayerId:d,setConnectionStatus:R,setGamesList:g,setLatestHighlight:D,setLatestNoTarget:T,setLatestDeckSelections:L,setLatestHandCardSelections:_,setTargetSelectionEffects:v,setLatestFloatingTexts:h,setRemoteValidTargets:C,isManualExitRef:Be,joiningGameIdRef:be,playerTokenRef:dt,receivedServerStateRef:Ke,isJoinAttemptRef:Lt}),{ws:we,reconnectTimeoutRef:lt,connectWebSocket:cr,forceReconnect:Ba,joinGame:lr,joinAsInvite:Wa,requestGamesList:Ya}=ct;U.useEffect(()=>{Oe.current=i},[i]),U.useEffect(()=>{J.current=V},[V]),U.useEffect(()=>{const p=ve();if(X(p),p){z.current=Xo();const ae=z.current.on(ee=>{Ka(ee)});return()=>{ae()}}},[]),U.useEffect(()=>{if(!ve())return;const ae=window.location.hash.slice(1);if(ae&&new URLSearchParams(ae).get("hostId"))return;const ee="webrtc_auto_restore_attempted";if(sessionStorage.getItem(ee))return;sessionStorage.setItem(ee,"true");const re=No();if(re==="none"){sessionStorage.removeItem(ee);return}setTimeout(async()=>{var se,ne;if(!z.current){y.warn("[Auto-restore] WebRTC manager not ready");return}try{if(re==="host"){We.current=!0,y.info("[Auto-restore] Setting restoration flag to prevent premature exit");const le=Da(),Z=pa();if(!le||!Z){y.warn("[Auto-restore] Missing host data or state data"),rt(),We.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}y.info(`[Auto-restore] Restoring host session: old peerId=${le.peerId}`);const Te=await z.current.initializeAsHost();J.current=!0,te(!0),K(Te),R("Connected"),(se=Z.gameState)!=null&&se.gameId&&(Zt(Te,Z.gameState.gameId),y.info(`[Auto-restore] Broadcasted NEW host peerId ${Te} for game ${Z.gameState.gameId}`)),(Z.gameState||Z.localPlayerId!==null)&&(Z.gameState&&(l.current=Z.gameState),Z.localPlayerId!==null&&(c.current=Z.localPlayerId),De.current=!0,setTimeout(()=>{De.current=!1},1e4),setTimeout(()=>{var Se;Z.gameState&&(n(Z.gameState),y.info(`[Auto-restore] Restored game state with ${((Se=Z.gameState.players)==null?void 0:Se.length)||0} players, gameId=${Z.gameState.gameId}`)),Z.localPlayerId!==null&&(d(Z.localPlayerId),y.info(`[Auto-restore] Restored local player ID: ${Z.localPlayerId}`))},0)),setTimeout(()=>{if(We.current=!1,y.info("[Auto-restore] Cleared restoration flag"),z.current&&Z.gameState){const Se=Z.gameState.players.filter(Ne=>!Ne.isDummy&&Ne.id!==Z.localPlayerId);Se.length>0&&(y.info(`[Auto-restore] Requesting deck data from ${Se.length} guest players`),z.current.broadcastToGuests({type:"REQUEST_DECK_DATA",senderId:z.current.getPeerId(),timestamp:Date.now()}))}},500),y.info("[Auto-restore] Host session restoration initiated")}else if(re==="guest"){We.current=!0,y.info("[Auto-restore] Setting restoration flag to prevent premature exit");const le=Pa(),Z=pa();if(!le||!Z){y.warn("[Auto-restore] Missing guest data or state data"),rt(),We.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}y.info(`[Auto-restore] Restoring guest session: old hostPeerId=${le.hostPeerId}, playerId=${le.playerId}`),J.current=!1,te(!1),R("Connecting");let Te=le.hostPeerId;if((ne=Z.gameState)!=null&&ne.gameId){const Se=Bt(Z.gameState.gameId);Se&&Se.peerId&&(Te=Se.peerId,y.info(`[Auto-restore] Found NEW host peerId in localStorage: ${Te}`))}if(K(Te),le.playerId!==null){y.info(`[Auto-restore] Reconnecting as existing player ${le.playerId} to host ${Te}`);try{await z.current.initializeAsReconnectingGuest(Te,le.playerId),R("Connected"),y.info("[Auto-restore] Successfully reconnected to host")}catch(Se){y.error("[Auto-restore] Failed to reconnect to host:",Se),R("Disconnected"),rt(),y.info("[Auto-restore] Cleared stale guest data due to failed reconnection"),We.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted");return}}else y.info("[Auto-restore] Connecting as new player"),await z.current.initializeAsGuest(Te),R("Connected");(Z.gameState||Z.localPlayerId!==null)&&(Z.gameState&&(l.current=Z.gameState),Z.localPlayerId!==null&&(c.current=Z.localPlayerId),De.current=!0,setTimeout(()=>{De.current=!1},1e4),setTimeout(()=>{var Se,Ne;if(Z.gameState&&(n(Z.gameState),y.info(`[Auto-restore] Restored game state with ${((Se=Z.gameState.players)==null?void 0:Se.length)||0} players, gameId=${Z.gameState.gameId}, isGameStarted=${Z.gameState.isGameStarted}`),Z.localPlayerId!==null)){const ue=(Ne=Z.gameState.players)==null?void 0:Ne.some(pe=>pe.id===Z.localPlayerId);y.info(`[Auto-restore] Player ${Z.localPlayerId} exists in restored state: ${ue}`)}Z.localPlayerId!==null&&(d(Z.localPlayerId),y.info(`[Auto-restore] Restored local player ID: ${Z.localPlayerId}`))},0)),setTimeout(()=>{We.current=!1,y.info("[Auto-restore] Cleared restoration flag")},100),y.info("[Auto-restore] Guest session restoration initiated")}}catch(le){y.error("[Auto-restore] Failed to restore session:",le),rt(),We.current=!1,sessionStorage.removeItem("webrtc_auto_restore_attempted")}},100)},[]),U.useEffect(()=>{if(!B||!z.current)return;const p=window.location.hash.slice(1);if(!p)return;const ee=new URLSearchParams(p).get("hostId");ee&&Qe(ee)},[B]),U.useEffect(()=>{l.current=a},[a]),U.useEffect(()=>{c.current=s},[s]);const za=is({ws:we,webrtcManager:z,gameStateRef:l,localPlayerIdRef:c,webrtcIsHostRef:J,setLatestHighlight:D,setLatestFloatingTexts:h,setLatestNoTarget:T,setLatestDeckSelections:L,setLatestHandCardSelections:_,setTargetSelectionEffects:v,setGameState:n}),We=U.useRef(!1);U.useEffect(()=>{if(!B||!J.current||!(a!=null&&a.gameId))return;const p=a.gameId,ae=()=>{var se;const re=(se=z.current)==null?void 0:se.getPeerId();re&&p&&Zt(re,p)};ae();const ee=setInterval(ae,2e3);return()=>clearInterval(ee)},[B,a==null?void 0:a.gameId]),U.useEffect(()=>{if(!B||J.current||!(a!=null&&a.gameId))return;const p=a.gameId,ae=se=>{var ne;K(se),R("Connecting"),(ne=z.current)==null||ne.initializeAsReconnectingGuest(se,c.current||0).then(()=>{R("Connected")}).catch(le=>{y.error("[Guest Auto-Reconnect] Failed to reconnect:",le),R("Disconnected")})},ee=se=>{const ne=`webrtc_host_${p}`;if(!(se.key!==ne||!se.newValue))try{const Z=JSON.parse(se.newValue).peerId;Z&&Z!==q&&ae(Z)}catch(le){y.error("[Guest Auto-Reconnect] Failed to parse storage event:",le)}},re=setInterval(()=>{const se=Bt(p);se&&se.peerId!==q&&(y.info(`[Guest Auto-Reconnect] Periodic check found new host peerId: ${se.peerId}`),ae(se.peerId))},2e3);return window.addEventListener("storage",ee),()=>{window.removeEventListener("storage",ee),clearInterval(re)}},[B,a==null?void 0:a.gameId,q]),U.useEffect(()=>{const p=setInterval(()=>{n(ae=>{const ee=Date.now(),re=ae.floatingTexts||[],se=re.filter(ne=>ee-ne.timestamp<oe.FLOATING_TEXT_DURATION);return se.length!==re.length?{...ae,floatingTexts:se}:ae})},oe.DECK_SYNC_DELAY);return()=>clearInterval(p)},[]);const Ka=U.useCallback(p=>{var ae,ee,re;switch(p.type){case"peer_open":(ae=p.data)!=null&&ae.peerId&&(K(p.data.peerId),y.info(`WebRTC peer opened with ID: ${p.data.peerId}`));break;case"guest_connected":y.info("Guest connected via WebRTC:",(ee=p.data)==null?void 0:ee.peerId);break;case"connected_to_host":(re=p.data)!=null&&re.hostPeerId&&q!==p.data.hostPeerId&&(K(p.data.hostPeerId),y.info(`Updated webrtcHostId to: ${p.data.hostPeerId}`)),R("Connected"),Ee(!1),ke(null),De.current=!1;try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break;case"host_disconnected":case"guest_disconnected":if(y.warn("WebRTC peer disconnected"),R("Disconnected"),Ee(!0),!J.current&&q&&a)try{const se={hostPeerId:q,playerId:s,gameState:a,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(se)),y.info("[Reconnection] Stored reconnection data before disconnect"),Va(q)}catch(se){y.error("[Reconnection] Failed to store data:",se)}break;case"message_received":ja(p.data);break;case"error":y.error("WebRTC error:",p.data);break}},[a,s,q,V]),qa=U.useCallback((p,ae)=>{if(y.info(`[handleWebrtcGuestJoin] Called for guest ${p}, isHost: ${J.current}`),!J.current||!z.current){y.warn("[handleWebrtcGuestJoin] Not a host or manager not initialized");return}const ee=(ae==null?void 0:ae.preferredDeck)||"Random";n(re=>{if(!re)return y.error("[handleWebrtcGuestJoin] No previous state"),re;y.info(`[handleWebrtcGuestJoin] Current state has ${re.players.length} players`);const se=re.players.map(ue=>ue.id);let ne=1;for(;se.includes(ne);)ne++;const le={id:ne,name:`Player ${ne}`,color:Ot[se.length%Ot.length],hand:[],deck:[],discard:[],announcedCard:null,score:0,isDummy:!1,isReady:!1,selectedDeck:ee,boardHistory:[],autoDrawEnabled:!0},Z={...re,players:[...re.players,le]},Te=re.board.map(ue=>ue.map(pe=>({...pe,card:pe.card?{id:pe.card.id,baseId:pe.card.baseId,ownerId:pe.card.ownerId,name:pe.card.name,imageUrl:pe.card.imageUrl,power:pe.card.power,ability:pe.card.ability,isFaceDown:pe.card.isFaceDown,statuses:pe.card.statuses||[]}:null}))),Se=ue=>ue.map(pe=>({id:pe.id,baseId:pe.baseId,name:pe.name,imageUrl:pe.imageUrl,power:pe.power,powerModifier:pe.powerModifier,ability:pe.ability,ownerId:pe.ownerId,color:pe.color,deck:pe.deck,isFaceDown:pe.isFaceDown,types:pe.types,faction:pe.faction,statuses:pe.statuses}));z.current.acceptGuestMinimal(p,{playerId:ne,gameId:re.gameId,isGameStarted:re.isGameStarted,players:Z.players.map(ue=>ue.isDummy?{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,hand:Se(ue.hand||[]),deck:Se(ue.deck||[]),discard:Se(ue.discard||[]),handSize:ue.hand.length,deckSize:ue.deck.length,discardSize:ue.discard.length}:{id:ue.id,name:ue.name,color:ue.color,isDummy:ue.isDummy,isReady:ue.isReady,score:ue.score,selectedDeck:ue.selectedDeck,deckSize:ue.deck.length,handSize:ue.hand.length,discardSize:ue.discard.length}),deckSelections:Z.players.map(ue=>({id:ue.id,selectedDeck:ue.selectedDeck})),gameMode:re.gameMode,currentRound:re.currentRound,currentPhase:re.currentPhase,activePlayerId:re.activePlayerId,startingPlayerId:re.startingPlayerId,activeGridSize:re.activeGridSize,board:Te},ne),z.current.broadcastGameState(Z,p),z.current.broadcastToGuests({type:"SYNC_DECK_SELECTIONS",senderId:z.current.getPeerId(),data:{playerId:ne,selectedDeck:ee},timestamp:Date.now()});const Ne=Z.players.find(ue=>ue.id===c.current);if(Ne&&Ne.deck.length>0){const ue=Ne.deck.map(pe=>({id:pe.id,baseId:pe.baseId,power:pe.power,powerModifier:pe.powerModifier||0,isFaceDown:pe.isFaceDown||!1,statuses:pe.statuses||[]}));z.current.sendToGuest(p,{type:"CHANGE_PLAYER_DECK",senderId:z.current.getPeerId(),playerId:Ne.id,data:{playerId:Ne.id,deckType:Ne.selectedDeck,deck:ue,deckSize:ue.length},timestamp:Date.now()}),y.info(`[handleWebrtcGuestJoin] Sent host deck data to new guest: ${Ne.selectedDeck}, ${ue.length} cards`)}return Z})},[]),Gt=U.useCallback(p=>{const ae=J.current;if(y.info(`[broadcastWebrtcState] Called: webrtcManagerRef.current=${!!z.current}, webrtcIsHostRef.current=${ae}`),!z.current||!ae){y.warn("[broadcastWebrtcState] Skipping broadcast: manager or isHost missing");return}z.current.broadcastGameState(p)},[]),ja=U.useCallback(p=>{var ae,ee,re,se,ne,le,Z,Te,Se,Ne,ue,pe,yr,hr,mr,Ir,Er,Tr,gr,wr,_r,br,Sr,Ar,Cr,Rr,Dr,Pr,kr,Or,vr,Nr,Mr,Lr,Gr,xr,Ur,$r,Hr,Fr,Br,Wr,Yr,zr,Kr,qr,jr,Vr,Jr,Xr,Zr,Qr,ea,ta,ra,aa,na,oa,sa,ia,da,ca,la;if(!(!p||!p.type))switch(y.info(`[handleWebrtcMessage] Received: ${p.type}`),p.type){case"JOIN_ACCEPT_MINIMAL":if(y.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_MINIMAL, playerId: ${p.playerId}`),p.data){const S=p.data;y.info(`[handleWebrtcMessage] Creating minimal state with ${((ae=S.players)==null?void 0:ae.length)||0} players`);const P={gameId:S.gameId||Ha(),isGameStarted:S.isGameStarted||!1,isPrivate:!1,activeGridSize:S.activeGridSize||4,gameMode:S.gameMode||Qt.FreeForAll,dummyPlayerCount:0,players:((ee=S.players)==null?void 0:ee.map(k=>{if((k.isDummy||!1)&&k.hand&&k.deck&&k.discard)return{id:k.id,name:k.name,color:k.color,isDummy:!0,isReady:k.isReady||!1,score:k.score||0,hand:k.hand||[],deck:k.deck||[],discard:k.discard||[],announcedCard:null,selectedDeck:k.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0};const W=[],x=[],Y=[];for(let H=0;H<(k.handSize||0);H++)W.push({id:`placeholder_${k.id}_hand_${H}`,name:"?",isPlaceholder:!0,ownerId:k.id,deck:k.selectedDeck||"Random",color:k.color});for(let H=0;H<(k.deckSize||0);H++)x.push({id:`placeholder_${k.id}_deck_${H}`,name:"?",isPlaceholder:!0,ownerId:k.id,deck:k.selectedDeck||"Random",color:k.color});for(let H=0;H<(k.discardSize||0);H++)Y.push({id:`placeholder_${k.id}_discard_${H}`,name:"?",isPlaceholder:!0,ownerId:k.id,deck:k.selectedDeck||"Random",color:k.color});return{id:k.id,name:k.name,color:k.color,isDummy:!1,isReady:k.isReady||!1,score:k.score||0,hand:W,deck:x,discard:Y,announcedCard:null,selectedDeck:k.selectedDeck||"Random",boardHistory:[],autoDrawEnabled:!0}}))||[],board:S.board||ka(),hostId:1,currentPhase:S.currentPhase??0,isScoringStep:!1,preserveDeployAbilities:!1,autoAbilitiesEnabled:!0,autoDrawEnabled:!0,currentRound:S.currentRound||1,turnNumber:S.turnNumber||1,activePlayerId:S.activePlayerId??null,startingPlayerId:S.startingPlayerId??null,roundEndTriggered:!1,roundWinners:{},gameWinner:null,isRoundEndModalOpen:!1,floatingTexts:[],highlights:[],deckSelections:[],handCardSelections:[],targetingMode:null,spectators:[],revealRequests:[],isReadyCheckActive:!1,localPlayerId:null,isSpectator:!1};n(P),p.playerId!==void 0&&(d(p.playerId),y.info(`[handleWebrtcMessage] Set local player ID to ${p.playerId}`)),n(k=>{const F=k.players.map(W=>{var Y;const x=(Y=S.players)==null?void 0:Y.find(H=>H.id===W.id);if(W.id===p.playerId){const j=W.deck.length===0||W.deck.some(Q=>Q.isPlaceholder)||W.deck.length!==30;if(x!=null&&x.selectedDeck&&j){const Q=Ze(x.selectedDeck,W.id,W.name);y.info(`[JOIN_ACCEPT_MINIMAL] Created local deck with ${Q.length} cards from ${x.selectedDeck}`),z.current&&Q.length>0&&setTimeout(()=>{const ye=Q.map(ie=>({id:ie.id,baseId:ie.baseId,power:ie.power,powerModifier:ie.powerModifier||0,isFaceDown:ie.isFaceDown||!1,statuses:ie.statuses||[]}));z.current.sendAction("DECK_DATA_UPDATE",{playerId:p.playerId,deck:ye,deckSize:ye.length}),y.info(`[JOIN_ACCEPT_MINIMAL] Sent deck data to host: ${x.selectedDeck}, ${ye.length} cards`)},0);const ce=[...W.hand],fe=[...Q];if(S.isGameStarted&&ce.length===0&&fe.length>0){for(let ie=0;ie<6&&ie<fe.length;ie++){const Ae=fe[0];fe.splice(0,1),ce.push(Ae)}y.info(`[JOIN_ACCEPT_MINIMAL] Drew ${ce.length} cards, deck now has ${fe.length} cards`)}return{...W,deck:fe,hand:ce,selectedDeck:x.selectedDeck}}}return W});return{...k,players:F}});try{const k=(re=z.current)==null?void 0:re.getHostPeerId();k&&Ft({hostPeerId:k,playerId:p.playerId,playerName:((se=P.players.find(F=>F.id===p.playerId))==null?void 0:se.name)||null,isHost:!1})}catch(k){y.warn("[JOIN_ACCEPT_MINIMAL] Failed to save guest data:",k)}}break;case"JOIN_ACCEPT":if(y.info(`[handleWebrtcMessage] Received JOIN_ACCEPT, playerId: ${p.playerId}, hasState: ${!!((ne=p.data)!=null&&ne.gameState)}`),(le=p.data)!=null&&le.gameState){const S=p.data.gameState;if(y.info(`[handleWebrtcMessage] Setting game state with ${((Z=S.players)==null?void 0:Z.length)||0} players`),n(S),p.playerId!==void 0){d(p.playerId),y.info(`[handleWebrtcMessage] Set local player ID to ${p.playerId}`);try{const P=(Te=z.current)==null?void 0:Te.getHostPeerId(),k=S.players.find(F=>F.id===p.playerId);P&&Ft({hostPeerId:P,playerId:p.playerId,playerName:(k==null?void 0:k.name)||null,isHost:!1})}catch(P){y.warn("[JOIN_ACCEPT] Failed to save guest data:",P)}}}break;case"JOIN_ACCEPT_BINARY":if(y.info(`[handleWebrtcMessage] Received JOIN_ACCEPT_BINARY, playerId: ${p.playerId}`),p.data instanceof Uint8Array)try{const S=Wo(p.data),P=S;if(y.info(`[handleWebrtcMessage] Expanded binary state with ${((Se=P.players)==null?void 0:Se.length)||0} players`),n(P),p.playerId!==void 0){d(p.playerId),y.info(`[handleWebrtcMessage] Set local player ID to ${p.playerId}`);try{const k=(Ne=z.current)==null?void 0:Ne.getHostPeerId(),F=P.players.find(W=>W.id===p.playerId);k&&Ft({hostPeerId:k,playerId:p.playerId,playerName:(F==null?void 0:F.name)||null,isHost:!1})}catch(k){y.warn("[JOIN_ACCEPT_BINARY] Failed to save guest data:",k)}}y.info(`[handleWebrtcMessage] Received optimized binary game state: ${p.data.byteLength} bytes`)}catch(S){y.error("[handleWebrtcMessage] Failed to deserialize binary game state:",S)}break;case"STATE_UPDATE_COMPACT":if(J.current){if(p.senderId&&p.senderId!==((ue=z.current)==null?void 0:ue.getPeerId())&&(y.info(`[STATE_UPDATE_COMPACT] Host received compact state from guest ${p.senderId}`),(pe=p.data)!=null&&pe.gameState)){const S=p.data.gameState;n(P=>{const k=p.playerId;if(k===void 0)return y.warn("[STATE_UPDATE_COMPACT] Guest state missing playerId"),P;const F=P.players.map(Y=>{if(Y.id===k){const H=S.players.find(j=>j.id===k);if(H){const j=ye=>{const ie=Ye(ye.baseId);return ie?{...ie,id:ye.id,baseId:ye.baseId,ownerId:k,power:ye.power,powerModifier:ye.powerModifier,isFaceDown:ye.isFaceDown,statuses:ye.statuses||[]}:{id:ye.id,baseId:ye.baseId,name:"Unknown",power:0}},Q=(H.handCards||[]).map(j),ce=(H.deckCards||[]).map(j),fe=(H.discardCards||[]).map(j);return y.info(`[STATE_UPDATE_COMPACT] Reconstructed guest ${k}: hand=${Q.length}, deck=${ce.length}, discard=${fe.length}`),{...Y,hand:Q,deck:ce,discard:fe,handSize:Q.length,deckSize:ce.length,discardSize:fe.length}}}return Y}),W=S.board?S.board.map(Y=>Y.map(H=>{if(!H||!H.card)return H;const j=Ye(H.card.baseId||H.card.id);if(j){const Q=H.card.ownerId;return{...H,card:{...j,id:H.card.id,baseId:H.card.baseId||H.card.id,ownerId:Q,ownerName:H.card.ownerName,power:H.card.power,powerModifier:H.card.powerModifier,isFaceDown:H.card.isFaceDown||!1,statuses:H.card.statuses||[],enteredThisTurn:H.card.enteredThisTurn,deck:H.card.deck}}}return H})):P.board,x={...P,...S,players:F,board:W};return z.current&&setTimeout(()=>{z.current.broadcastGameState(x,p.senderId)},0),x})}}else if(!J.current&&((yr=p.data)!=null&&yr.gameState)){const S=p.data.recipientPlayerId??null,P=p.data.gameState;if(De.current){n(k=>({...k,currentPhase:P.currentPhase,activePlayerId:P.activePlayerId,startingPlayerId:P.startingPlayerId,isReadyCheckActive:P.isReadyCheckActive,isGameStarted:P.isGameStarted}));return}n(k=>{const F=S===null||S===c.current;y.info(`[STATE_UPDATE_COMPACT] Processing state for recipient=${S}, local=${c.current}, isForLocal=${F}`);const W=P.players.map(H=>{var Q,ce;const j=k.players.find(fe=>fe.id===H.id);if(H.id===c.current&&j){const fe=ie=>{if(ie.baseId){const Ce=Ye(ie.baseId);if(Ce)return{...Ce,id:ie.id,ownerId:c.current,power:ie.power,powerModifier:ie.powerModifier,isFaceDown:ie.isFaceDown,statuses:ie.statuses||[]}}return j.hand.find(Ce=>Ce.id===ie.id)||j.deck.find(Ce=>Ce.id===ie.id)||j.discard.find(Ce=>Ce.id===ie.id)||{id:ie.id,name:"Unknown",power:0}};if(H.handCards&&H.handCards.length>0||H.deckCards&&H.deckCards.length>0||H.discardCards&&H.discardCards.length>0){const ie=(H.handCards||[]).map(fe),Ae=(H.deckCards||[]).map(fe),Ce=(H.discardCards||[]).map(fe);return ie.forEach((me,he)=>{var de,Me;(Me=(de=H.handCards)==null?void 0:de[he])!=null&&Me.baseId&&!me.baseId&&(me.baseId=H.handCards[he].baseId)}),Ae.forEach((me,he)=>{var de,Me;(Me=(de=H.deckCards)==null?void 0:de[he])!=null&&Me.baseId&&!me.baseId&&(me.baseId=H.deckCards[he].baseId)}),Ce.forEach((me,he)=>{var de,Me;(Me=(de=H.discardCards)==null?void 0:de[he])!=null&&Me.baseId&&!me.baseId&&(me.baseId=H.discardCards[he].baseId)}),y.debug(`[STATE_UPDATE_COMPACT] Reconstructed ${ie.length} hand, ${Ae.length} deck, ${Ce.length} discard`),{...H,hand:ie,deck:Ae,discard:Ce}}else{const ie=(H.handIds||[]).map(me=>j.hand.find(de=>de.id===me)||j.deck.find(de=>de.id===me)||j.discard.find(de=>de.id===me)||{id:me,name:"?",isPlaceholder:!1}),Ae=(H.deckIds||[]).map(me=>j.deck.find(de=>de.id===me)||j.hand.find(de=>de.id===me)||j.discard.find(de=>de.id===me)||{id:me,name:"?",isPlaceholder:!1}),Ce=(H.discardIds||[]).map(me=>j.discard.find(de=>de.id===me)||j.hand.find(de=>de.id===me)||j.deck.find(de=>de.id===me)||{id:me,name:"?",isPlaceholder:!1});return y.debug(`[STATE_UPDATE_COMPACT] Reconstructed from IDs: ${ie.length} hand, ${Ae.length} deck, ${Ce.length} discard`),{...H,hand:ie,deck:Ae,discard:Ce}}}else{const fe=H.deckSize??((Q=H.deck)==null?void 0:Q.length)??0,ye=H.handSize??((ce=H.hand)==null?void 0:ce.length)??0,ie=H.deckCards&&H.deckCards.length>0;let Ae;if(ie){const he=de=>{if(de.baseId){const Me=Ye(de.baseId);if(Me)return{...Me,id:de.id,baseId:de.baseId,ownerId:H.id,power:de.power,powerModifier:de.powerModifier,isFaceDown:de.isFaceDown,statuses:de.statuses||[]}}return{id:de.id,name:"Unknown",power:0}};Ae=H.deckCards.map(he),y.debug(`[STATE_UPDATE_COMPACT] Reconstructed deck for player ${H.id}: ${Ae.length} cards`)}else if(j&&j.deck.length>0&&j.deck.some(de=>!de.isPlaceholder))Ae=j.deck.slice(0,fe),y.debug(`[STATE_UPDATE_COMPACT] Preserved deck for player ${H.id}: ${Ae.length} cards`);else{Ae=[];for(let de=0;de<fe;de++)Ae.push({id:`placeholder_${H.id}_deck_${de}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color})}const Ce=(he,de)=>{if(he.baseId&&!he.isPlaceholder&&!he.isCardBack){const Me=Ye(he.baseId);if(Me)return{...Me,id:he.id,baseId:he.baseId,ownerId:H.id,power:he.power,powerModifier:he.powerModifier||0,isFaceDown:he.isFaceDown||!1,statuses:he.statuses||[]}}return{id:he.id||`placeholder_${H.id}_hand_${de}`,name:"?",isPlaceholder:!0,isCardBack:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color}};let me;if(H.hand&&H.hand.length>0){me=H.hand.map((de,Me)=>Ce(de,Me));const he=me.filter(de=>!de.isPlaceholder).length;he>0&&y.info(`[STATE_UPDATE_COMPACT] Reconstructed ${he}/${me.length} revealed hand cards for player ${H.id}`)}else{me=[];for(let he=0;he<ye;he++)me.push({id:`placeholder_${H.id}_hand_${he}`,name:"?",isPlaceholder:!0,ownerId:H.id,deck:H.selectedDeck||"Random",color:H.color})}return{...H,hand:me,deck:Ae,discard:(j==null?void 0:j.discard)||[]}}}),x=P.board?P.board.map(H=>H.map(j=>{if(!j||!j.card)return j;const Q=Ye(j.card.baseId||j.card.id);return Q?{...j,card:{...Q,id:j.card.id,baseId:j.card.baseId||j.card.id,ownerId:j.card.ownerId,ownerName:j.card.ownerName,power:j.card.power,powerModifier:j.card.powerModifier,isFaceDown:j.card.isFaceDown||!1,statuses:j.card.statuses||[],enteredThisTurn:j.card.enteredThisTurn,deck:j.card.deck}}:j})):k.board,Y=Le({...P,players:W,board:x});return{...P,players:W,board:Y}})}break;case"STATE_UPDATE":if(J.current&&p.senderId&&p.senderId!==((hr=z.current)==null?void 0:hr.getPeerId())){if(y.info(`[STATE_UPDATE] Host received state from guest ${p.senderId}`),(mr=p.data)!=null&&mr.gameState){const S=p.data.gameState;n(P=>{const k=p.playerId;if(k===void 0)return y.warn("[STATE_UPDATE] Guest state missing playerId"),P;const F=P.players.map(Y=>{if(Y.id===k){const H=S.players.find(j=>j.id===k);if(H){const j=ie=>({...ie,ownerId:k}),Q=(H.hand||[]).map(j),ce=(H.deck||[]).map(j),fe=(H.discard||[]).map(j);y.info(`[STATE_UPDATE] Merging guest ${k} state: hand=${Q.length}, deck=${ce.length}, discard=${fe.length}`);const ye={...Y,hand:Q,deck:ce,discard:fe,handSize:Q.length,deckSize:ce.length,discardSize:fe.length};return y.info(`[STATE_UPDATE] After merge - player ${k}: deckSize=${ye.deckSize}, handSize=${ye.handSize}`),ye}}return Y}),W=S.board?S.board.map(Y=>Y.map(H=>!H||!H.card?H:{...H,card:{...H.card,ownerId:H.card.ownerId}})):P.board,x={...P,players:F,board:W};return z.current&&setTimeout(()=>{z.current.broadcastGameState(x,p.senderId)},0),x})}break}if(Ke.current=!0,(Ir=p.data)!=null&&Ir.gameState){const S=p.data.gameState;if(De.current){n(P=>({...P,currentPhase:S.currentPhase,activePlayerId:S.activePlayerId,startingPlayerId:S.startingPlayerId,isReadyCheckActive:S.isReadyCheckActive,isGameStarted:S.isGameStarted}));return}n(P=>{var W;const k=S.players.map(x=>{var H,j,Q;const Y=P.players.find(ce=>ce.id===x.id);if(x.id===c.current&&Y){const ce=Y.hand.every(ye=>ye.isPlaceholder)||Y.hand.length===0,fe=x.handSize??((H=x.hand)==null?void 0:H.length)??0;if(ce&&x.hand&&x.hand.length>0)return{...x,hand:x.hand,deck:x.deck||Y.deck,discard:x.discard||Y.discard};{let ye=Y.hand,ie=Y.deck;if(fe>Y.hand.length&&ie.length>0){const Ae=fe-Y.hand.length,Ce=[...Y.hand],me=[...Y.deck];for(let he=0;he<Ae&&he<me.length;he++){const de=me[0];me.splice(0,1),Ce.push(de)}ye=Ce,ie=me}return{...x,hand:ye,deck:ie,discard:x.discard||Y.discard}}}else{if(x.isDummy||!1)return y.info(`[STATE_UPDATE] Using real cards for dummy player ${x.id}`),{...x,hand:x.hand||[],deck:x.deck||[],discard:x.discard||[]};const fe=x.deckSize??((j=x.deck)==null?void 0:j.length)??0,ye=x.handSize??((Q=x.hand)==null?void 0:Q.length)??0;y.info(`[STATE_UPDATE] Player ${x.id}: deckSize=${fe}, handSize=${ye}`);const ie=[];for(let Ce=0;Ce<fe;Ce++)ie.push({id:`placeholder_${x.id}_deck_${Ce}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const Ae=[];for(let Ce=0;Ce<ye;Ce++)Ae.push({id:`placeholder_${x.id}_hand_${Ce}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});return y.info(`[STATE_UPDATE] Created ${ie.length} deck placeholders and ${Ae.length} hand placeholders for player ${x.id}`),{...x,hand:Ae,deck:ie,discard:x.discard||[]}}}),F={...S,players:k};if(!J.current)try{((W=z.current)==null?void 0:W.getHostPeerId())&&c.current!==null&&(mt({gameState:F,localPlayerId:c.current,isHost:!1}),y.debug("[STATE_UPDATE] Saved merged state for guest auto-restore"))}catch(x){y.warn("[STATE_UPDATE] Failed to persist guest state:",x)}return F})}break;case"RECONNECT_SNAPSHOT":if(Ke.current=!0,p.data){const S=p.data;n(P=>{const k=c.current,F=S.players.map(x=>{const Y=P.players.find(ce=>ce.id===x.id);if(x.id===k&&Y&&Y.hand.some(fe=>!fe.isPlaceholder)){let fe=[...Y.hand];const ye=[...Y.deck];if(x.handSize>fe.length){const ie=x.handSize-fe.length;for(let Ae=0;Ae<ie&&ye.length>0;Ae++)fe.push(ye.shift())}else x.handSize<fe.length&&(fe=fe.slice(0,x.handSize));return{...x,hand:fe,deck:ye,discard:Y.discard}}const H=[];for(let ce=0;ce<x.handSize;ce++)H.push({id:`placeholder_${x.id}_hand_${ce}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const j=[];for(let ce=0;ce<x.deckSize;ce++)j.push({id:`placeholder_${x.id}_deck_${ce}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});const Q=[];for(let ce=0;ce<x.discardSize;ce++)Q.push({id:`placeholder_${x.id}_discard_${ce}`,name:"?",isPlaceholder:!0,ownerId:x.id,deck:x.selectedDeck||"Random",color:x.color});return{...x,hand:H,deck:j,discard:Q}}),W={gameId:S.gameId,gameMode:S.gameMode,isPrivate:S.isPrivate,isGameStarted:S.isGameStarted,isReadyCheckActive:S.isReadyCheckActive,activeGridSize:S.activeGridSize,currentPhase:S.currentPhase,isScoringStep:S.isScoringStep,activePlayerId:S.activePlayerId,startingPlayerId:S.startingPlayerId,currentRound:S.currentRound,turnNumber:S.turnNumber,roundWinners:S.roundWinners||{},gameWinner:S.gameWinner,isRoundEndModalOpen:S.isRoundEndModalOpen,dummyPlayerCount:S.dummyPlayerCount,players:F,board:S.board,spectators:P.spectators,hostId:P.hostId,revealRequests:P.revealRequests,preserveDeployAbilities:P.preserveDeployAbilities,highlights:P.highlights,floatingTexts:P.floatingTexts,targetingMode:P.targetingMode,abilityMode:P.abilityMode};if(!J.current&&k!==null)try{mt({gameState:W,localPlayerId:k,isHost:!1}),y.debug("[RECONNECT_SNAPSHOT] Saved state for guest auto-restore")}catch(x){y.warn("[RECONNECT_SNAPSHOT] Failed to save state:",x)}return y.info(`[RECONNECT_SNAPSHOT] Restored game state: phase=${W.currentPhase}, players=${W.players.length}`),W})}break;case"STATE_DELTA":if(J.current||(Ke.current=!0),y.info(`[STATE_DELTA] Received STATE_DELTA message, isHost: ${J.current}, senderId: ${p.senderId}`),(Er=p.data)!=null&&Er.delta){const S=p.data.delta;y.info(`[STATE_DELTA] Delta: playerDeltas=${Object.keys(S.playerDeltas||{}).length}, boardCells=${((Tr=S.boardCells)==null?void 0:Tr.length)||0}, phaseDelta=${!!S.phaseDelta}`),S.boardCells&&S.boardCells.length>0&&S.boardCells.forEach(P=>{var k,F;y.info(`[STATE_DELTA] Board cell [${P.row},${P.col}]: card=${((k=P.card)==null?void 0:k.name)||"(empty)"}, owner=${(F=P.card)==null?void 0:F.ownerId}`)}),J.current&&p.senderId&&z.current&&(y.info(`[STATE_DELTA] Host rebroadcasting delta from guest ${p.senderId} to other guests`),z.current.broadcastStateDelta(S,p.senderId)),S.phaseDelta&&y.info("[STATE_DELTA] phaseDelta:",JSON.stringify(S.phaseDelta)),S.playerDeltas&&Object.entries(S.playerDeltas).forEach(([P,k])=>{y.info(`[STATE_DELTA] Player ${P} delta: handSizeDelta=${k.handSizeDelta}, deckSizeDelta=${k.deckSizeDelta}`)}),n(P=>{const k=c.current||P.localPlayerId;y.info(`[STATE_DELTA] Applying delta with localPlayerId=${k}, currentPhase before=${P.currentPhase}`);const F=jt(P);y.info(`[STATE_DELTA] Applying delta with localPlayerId=${k}, currentPhase after=${F.currentPhase}`);try{F.gameId&&k!==null&&(mt({gameState:F,localPlayerId:k,isHost:J.current}),y.debug(`[STATE_DELTA] Saved state for ${J.current?"host":"guest"} auto-restore`))}catch(W){y.warn("[STATE_DELTA] Failed to persist state:",W)}return F})}break;case"STATE_DELTA_BINARY":{J.current||(Ke.current=!0),y.info(`[STATE_DELTA_BINARY] Received binary delta, isHost: ${J.current}, senderId: ${p.senderId}, dataType=${(wr=(gr=p.data)==null?void 0:gr.constructor)==null?void 0:wr.name}, typeof=${typeof p.data}`);let S=null;if(p.data instanceof Uint8Array)try{S=Ga(p.data),S&&y.info(`[STATE_DELTA_BINARY] Deserialized from Uint8Array: playerDeltas=${Object.keys(S.playerDeltas||{}).length}, boardCells=${((_r=S.boardCells)==null?void 0:_r.length)||0}`)}catch(P){y.error("[STATE_DELTA_BINARY] Failed to deserialize Uint8Array:",P)}else if(typeof p.data=="string")try{S=zo(p.data),S&&y.info(`[STATE_DELTA_BINARY] Deserialized from base64 (${p.data.length} chars): playerDeltas=${Object.keys(S.playerDeltas||{}).length}, boardCells=${((br=S.boardCells)==null?void 0:br.length)||0}, phaseDelta=${!!S.phaseDelta}`)}catch(P){y.error("[STATE_DELTA_BINARY] Failed to deserialize base64 string:",P)}else y.error(`[STATE_DELTA_BINARY] Unexpected data type: ${typeof p.data}, constructor: ${(Ar=(Sr=p.data)==null?void 0:Sr.constructor)==null?void 0:Ar.name}`);S&&(J.current&&p.senderId&&z.current&&(y.info(`[STATE_DELTA_BINARY] Host rebroadcasting binary delta from guest ${p.senderId} to other guests`),z.current.broadcastStateDelta(S,p.senderId)),n(P=>{const k=c.current||P.localPlayerId;y.info(`[STATE_DELTA_BINARY] Applying delta with localPlayerId=${k}, currentPhase before=${P.currentPhase}`);const F=jt(P);y.info(`[STATE_DELTA_BINARY] Applied delta - phase after=${F.currentPhase}, board has ${F.board.flat().filter(W=>W==null?void 0:W.card).length} cards`);try{F.gameId&&k!==null&&(mt({gameState:F,localPlayerId:k,isHost:J.current}),y.debug(`[STATE_DELTA_BINARY] Saved state for ${J.current?"host":"guest"} auto-restore`))}catch(W){y.warn("[STATE_DELTA_BINARY] Failed to persist state:",W)}return F}));break}case"CARD_STATE":if(typeof p.data=="string")try{const S=atob(p.data),P=new Uint8Array(S.length);for(let k=0;k<S.length;k++)P[k]=S.charCodeAt(k);n(k=>ft(2,P,k,c.current||k.localPlayerId).gameState)}catch(S){y.error("[handleWebrtcMessage] Failed to decode CARD_STATE:",S)}else p.data instanceof Uint8Array&&n(S=>ft(2,p.data,S,c.current||S.localPlayerId).gameState);break;case"ABILITY_EFFECT":if(typeof p.data=="string")try{const S=atob(p.data),P=new Uint8Array(S.length);for(let k=0;k<S.length;k++)P[k]=S.charCodeAt(k);n(k=>{const{gameState:F}=ft(3,P,k,c.current||k.localPlayerId);return F})}catch(S){y.error("[handleWebrtcMessage] Failed to decode ABILITY_EFFECT:",S)}else p.data instanceof Uint8Array&&n(S=>{const{gameState:P}=ft(3,p.data,S,c.current||S.localPlayerId);return P});break;case"SESSION_EVENT":if(typeof p.data=="string")try{const S=atob(p.data),P=new Uint8Array(S.length);for(let k=0;k<S.length;k++)P[k]=S.charCodeAt(k);n(k=>ft(4,P,k,c.current||k.localPlayerId).gameState)}catch(S){y.error("[handleWebrtcMessage] Failed to decode SESSION_EVENT:",S)}else p.data instanceof Uint8Array&&n(S=>ft(4,p.data,S,c.current||S.localPlayerId).gameState);break;case"JOIN_REQUEST":y.info(`[handleWebrtcMessage] Received JOIN_REQUEST, senderId: ${p.senderId}, isHost: ${J.current}`),J.current&&p.senderId?(y.info(`Host received JOIN_REQUEST from ${p.senderId}, data:`,p.data),qa(p.senderId,p.data)):y.warn(`[handleWebrtcMessage] Cannot process JOIN_REQUEST - isHost: ${J.current}, senderId: ${p.senderId}`);break;case"ACTION":if(J.current&&p.data){const{actionType:S,actionData:P}=p.data;if(S==="STATE_UPDATE"&&(P!=null&&P.gameState)){if(De.current){z.current&&p.senderId&&z.current.sendToGuest(p.senderId,{type:"STATE_UPDATE",senderId:z.current.getPeerId(),data:{gameState:l.current},timestamp:Date.now()});break}n(k=>{const F=P.gameState,W=F.players.map(Y=>{const H=k.players.find(j=>j.id===Y.id);return H&&Y.id!==c.current?{...Y,deck:H.deck||Y.deck,discard:H.discard||Y.discard,score:H.score}:Y}),x={...F,players:W};return z.current&&z.current.broadcastToGuests({type:"STATE_UPDATE",senderId:z.current.getPeerId(),data:{gameState:x},timestamp:Date.now()}),x})}else if(S==="STATE_DELTA"&&(P!=null&&P.delta))n(k=>{const F=P.delta;let W=F;De.current&&F.playerDeltas&&(W={...F,playerDeltas:Object.fromEntries(Object.entries(F.playerDeltas).map(([Y,H])=>{const j={...H};return delete j.scoreDelta,[Y,j]}))}),c.current||k.localPlayerId;const x=jt(k);return z.current&&z.current.broadcastStateDelta(W),x});else if(S==="NEXT_PHASE")n(k=>{const F=k,W=F.currentPhase,x=W===2&&!F.isScoringStep,Y=W+1;return{...F,currentPhase:Y,...x&&{isScoringStep:!0}}});else if(S==="PREV_PHASE")n(k=>{const F=k;return F.isScoringStep?{...F,isScoringStep:!1,currentPhase:Math.max(1,F.currentPhase-1)}:{...F,currentPhase:Math.max(1,F.currentPhase-1)}});else if(S==="SET_PHASE"&&(P==null?void 0:P.phaseIndex)!==void 0)n(k=>({...k,currentPhase:P.phaseIndex}));else if(S==="UPDATE_PLAYER_NAME"&&(P==null?void 0:P.playerId)!==void 0&&(P==null?void 0:P.name)!==void 0)n(k=>({...k,players:k.players.map(F=>F.id===P.playerId?{...F,name:P.name}:F)}));else if(S==="CHANGE_PLAYER_COLOR"&&(P==null?void 0:P.playerId)!==void 0&&(P==null?void 0:P.color)!==void 0){const k=P.playerId,F=P.color;n(W=>{const x={...W,players:W.players.map(Y=>Y.id===k?{...Y,color:F}:Y)};return z.current&&z.current.broadcastToGuests({type:"CHANGE_PLAYER_COLOR",senderId:z.current.getPeerId(),data:{playerId:k,color:F},timestamp:Date.now()}),x})}else if(S==="UPDATE_PLAYER_SCORE"&&(P==null?void 0:P.playerId)!==void 0&&(P==null?void 0:P.delta)!==void 0){const k=P.playerId,F=P.delta;n(W=>{const x={...W,players:W.players.map(Y=>Y.id===k?{...Y,score:Math.max(0,Y.score+F)}:Y)};return z.current&&z.current.broadcastToGuests({type:"UPDATE_PLAYER_SCORE",senderId:z.current.getPeerId(),data:{playerId:k,delta:F},timestamp:Date.now()}),x})}else if(S==="CHANGE_PLAYER_DECK"&&(P==null?void 0:P.playerId)!==void 0){const k=P.playerId,F=P.deckType,W=P.deck;n(x=>{const Y=x.players.find(Q=>Q.id===k);if(!Y)return x;let H;W&&W.length>0?(y.info(`[CHANGE_PLAYER_DECK] Host received ${W.length} cards for player ${k}`),H=W.map(Q=>{if(Q.baseId){const ce=Ye(Q.baseId);if(ce)return{...ce,id:Q.id,baseId:Q.baseId,deck:F,ownerId:k,ownerName:Y.name,power:Q.power,powerModifier:Q.powerModifier||0,isFaceDown:Q.isFaceDown||!1,statuses:Q.statuses||[]}}return{id:Q.id,baseId:Q.id,name:"Unknown",deck:F,ownerId:k,ownerName:Y.name,power:Q.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}})):(H=Ze(F,k,Y.name),y.info(`[CHANGE_PLAYER_DECK] Host created deck for player ${k} with ${H.length} cards from ${F}`));const j={...x,players:x.players.map(Q=>Q.id===k?{...Q,selectedDeck:F,deck:H,hand:[],discard:[],announcedCard:null,boardHistory:[]}:Q)};if(z.current){const Q=H.map(ce=>({id:ce.id,baseId:ce.baseId,power:ce.power,powerModifier:ce.powerModifier||0,isFaceDown:ce.isFaceDown||!1,statuses:ce.statuses||[]}));z.current.broadcastToGuests({type:"CHANGE_PLAYER_DECK",senderId:z.current.getPeerId(),playerId:k,data:{playerId:k,deckType:F,deck:Q,deckSize:Q.length},timestamp:Date.now()})}return j})}else if(S==="TOGGLE_ACTIVE_PLAYER"&&(P==null?void 0:P.playerId)!==void 0)n(k=>{if(!k.players.find(x=>x.id===P.playerId))return k;const W=Ua(k,P.playerId);return z.current&&z.current.broadcastGameState(W),W});else if(S==="TOGGLE_AUTO_DRAW"&&(P==null?void 0:P.playerId)!==void 0)n(k=>({...k,players:k.players.map(F=>F.id===P.playerId?{...F,autoDrawEnabled:!F.autoDrawEnabled}:F)}));else if(S==="START_NEXT_ROUND")n(k=>({...k,isRoundEndModalOpen:!1,currentRound:(k.currentRound||1)+1,players:k.players.map(F=>({...F,score:0}))}));else if(S==="RESET_DEPLOY_STATUS")n(k=>{const F=k.board.map(W=>W.map(x=>{var Y;return(Y=x.card)!=null&&Y.statuses?{...x,card:{...x.card,statuses:x.card.statuses.filter(H=>H.type!=="DeployAbilityUsed")}}:x}));return{...k,board:F,preserveDeployAbilities:!1}});else if(S==="DECK_DATA_UPDATE"&&(P==null?void 0:P.playerId)!==void 0&&(P!=null&&P.deck)){const k=P.playerId,F=P.deck,W=P.deckSize;y.info(`[ACTION] DECK_DATA_UPDATE: Received ${F.length} cards for guest ${k}`),n(x=>({...x,players:x.players.map(Y=>Y.id===k?{...Y,deck:[...F],deckSize:W||F.length}:Y)}))}else y.warn(`[ACTION] Unknown action type: ${S}`)}break;case"PLAYER_LEAVE":break;case"PLAYER_RECONNECT":if(y.info(`[PLAYER_RECONNECT] Guest ${p.playerId} reconnecting from ${p.senderId}`),J.current&&p.playerId!==void 0&&p.senderId){const S=l.current;if(y.info(`[PLAYER_RECONNECT] Current state: hasGameId=${!!(S!=null&&S.gameId)}, gameId=${S==null?void 0:S.gameId}, hasPlayers=${((Cr=S==null?void 0:S.players)==null?void 0:Cr.length)||0}`),S&&S.gameId){y.info(`[PLAYER_RECONNECT] Sending compact reconnect snapshot to player ${p.playerId}`);const P=ts(S,p.playerId);(Rr=z.current)==null||Rr.sendToGuest(p.senderId,{type:"RECONNECT_SNAPSHOT",senderId:z.current.getPeerId(),data:P.data,timestamp:Date.now()}),y.info(`[PLAYER_RECONNECT] Sent compact snapshot to player ${p.playerId}`)}else y.warn("[PLAYER_RECONNECT] No valid game state to send")}break;case"START_READY_CHECK":(((Dr=p.data)==null?void 0:Dr.isReadyCheckActive)!==void 0||((Pr=p.data)==null?void 0:Pr.isPrivate)!==void 0)&&n(S=>({...S,isReadyCheckActive:p.data.isReadyCheckActive??!0,isPrivate:p.data.isPrivate??!0}));break;case"CANCEL_READY_CHECK":((kr=p.data)==null?void 0:kr.isReadyCheckActive)!==void 0&&n(S=>({...S,isReadyCheckActive:p.data.isReadyCheckActive}));break;case"PLAYER_READY":J.current&&p.playerId!==void 0?n(S=>{const P=S.players.map(x=>x.id===p.playerId?{...x,isReady:!0}:x),k={...S,players:P};y.info(`Player ${p.playerId} is ready via WebRTC`),z.current&&(z.current.broadcastGameState(k),y.info(`[PLAYER_READY] Broadcasted ready status for player ${p.playerId}`));const F=k.players.filter(x=>!x.isDummy&&!x.isDisconnected);if(F.length>0&&F.every(x=>x.isReady)&&!k.isGameStarted){const x=k.players.filter(Q=>!Q.isDisconnected),Y=Math.floor(Math.random()*x.length),H=x[Y].id;let j={...k};return j.isReadyCheckActive=!1,j.isGameStarted=!0,j.startingPlayerId=H,j.activePlayerId=H,j.currentPhase=0,j.players=j.players.map(Q=>{if(Q.hand.length===0&&Q.deck.length>0){const fe=[...Q.hand],ye=[...Q.deck];for(let ie=0;ie<6&&ie<ye.length;ie++){const Ae=ye[0];ye.splice(0,1),fe.push(Ae)}return y.info(`[PLAYER_READY] Drew ${fe.length} cards for player ${Q.id}`),{...Q,hand:fe,deck:ye}}return Q}),j=sr(j,H),y.info(`[PLAYER_READY] Preparation phase completed, currentPhase=${j.currentPhase}`),z.current&&(z.current.broadcastToGuests({type:"GAME_START",senderId:z.current.getPeerId(),data:{startingPlayerId:H,activePlayerId:H,isGameStarted:!0,isReadyCheckActive:!1},timestamp:Date.now()}),setTimeout(()=>{var Q,ce;y.info(`[PLAYER_READY] Broadcasting state, player sizes: P1 deck=${(Q=j.players[0])==null?void 0:Q.deck.length}, hand=${(ce=j.players[0])==null?void 0:ce.hand.length}`),y.info(`[PLAYER_READY] Broadcasting state with currentPhase=${j.currentPhase}`),Gt(j)},100)),j}return k}):J.current;break;case"ASSIGN_TEAMS":(Or=p.data)!=null&&Or.assignments&&n(S=>{const P=S.players.map(k=>{let F=k.teamId||1;for(const[W,x]of Object.entries(p.data.assignments))if(x.includes(k.id)){F=parseInt(W);break}return{...k,teamId:F}});return{...S,players:P}});break;case"SET_GAME_MODE":((vr=p.data)==null?void 0:vr.mode)!==void 0&&n(S=>({...S,gameMode:p.data.mode}));break;case"SET_GAME_PRIVACY":((Nr=p.data)==null?void 0:Nr.isPrivate)!==void 0&&n(S=>({...S,isPrivate:p.data.isPrivate}));break;case"SET_GRID_SIZE":((Mr=p.data)==null?void 0:Mr.size)!==void 0&&n(S=>{const P=p.data.size,k=[];for(let F=0;F<P;F++){const W=[];for(let x=0;x<P;x++)W.push({card:null});k.push(W)}return{...S,activeGridSize:P,board:k}});break;case"SET_DUMMY_PLAYER_COUNT":((Lr=p.data)==null?void 0:Lr.count)!==void 0&&n(S=>({...S,dummyPlayerCount:p.data.count}));break;case"HOST_READY":p.playerId!==void 0&&(y.info(`[handleWebrtcMessage] Host (player ${p.playerId}) is ready`),n(S=>{const P=S.players.map(k=>k.id===p.playerId?{...k,isReady:!0}:k);return{...S,players:P}}));break;case"GAME_START":Ke.current=!0,y.info("[handleWebrtcMessage] Game starting!",p.data),l.current&&(y.info(`[GAME_START] Current phase before: ${l.current.currentPhase}`),l.current.players.forEach(S=>{y.info(`[GAME_START] Before: Player ${S.id} - deck: ${S.deck.length}, hand: ${S.hand.length}`)})),p.data&&n(S=>{y.info(`[GAME_START] Processing for localPlayerId=${c.current}`),S.players.forEach(W=>{y.info(`[GAME_START] Player ${W.id} before: deck=${W.deck.length}, hand=${W.hand.length}`)});const P=p.data.startingPlayerId??p.data.activePlayerId,k={...S,isGameStarted:p.data.isGameStarted??!0,isReadyCheckActive:!1,startingPlayerId:P,activePlayerId:p.data.activePlayerId,currentPhase:S.currentPhase},F=k.players.find(W=>W.id===c.current);if(F&&F.hand.length===0&&F.deck.length>0){const x=[...F.hand],Y=[...F.deck];for(let H=0;H<6&&H<Y.length;H++){const j=Y[0];Y.splice(0,1),x.push(j)}k.players=k.players.map(H=>H.id===c.current?{...H,hand:x,deck:Y}:H),y.info(`[GAME_START] Drew ${x.length} cards for local player ${c.current}, deck now has ${Y.length} cards`)}return k.players.forEach(W=>{y.info(`[GAME_START] Player ${W.id} after: deck=${W.deck.length}, hand=${W.hand.length}`)}),y.info(`[GAME_START] Final state: currentPhase=${k.currentPhase}, activePlayerId=${k.activePlayerId}, startingPlayerId=${k.startingPlayerId}`),k});break;case"ACTIVE_PLAYER_CHANGED":y.info("[handleWebrtcMessage] Active player changed!",p.data),p.data&&n(S=>{const P={...S,activePlayerId:p.data.activePlayerId};if(p.data.currentPhase!==void 0&&(P.currentPhase=p.data.currentPhase),p.data.turnNumber!==void 0&&(P.turnNumber=p.data.turnNumber),P.currentPhase===0&&P.activePlayerId===c.current){const k=P.players.find(F=>F.id===c.current);if(k&&k.deck.length>0){const F=k.deck[0],W=[...k.deck.slice(1)],x=[...k.hand,F];P.players=P.players.map(Y=>Y.id===c.current?{...Y,deck:W,hand:x}:Y)}P.currentPhase=1}return P});break;case"SYNC_DECK_SELECTIONS":y.info("[SYNC_DECK_SELECTIONS] Received deck selection sync",p.data),p.data&&n(S=>p.data.playerId!==void 0&&p.data.selectedDeck!==void 0?p.data.playerId===c.current?(y.info(`[SYNC_DECK_SELECTIONS] Skipping update for local player ${p.data.playerId}`),S):{...S,players:S.players.map(P=>P.id===p.data.playerId?{...P,selectedDeck:p.data.selectedDeck}:P)}:p.data.deckSelections&&Array.isArray(p.data.deckSelections)?{...S,players:S.players.map(P=>{if(P.id===c.current)return P;const k=p.data.deckSelections.find(F=>F.id===P.id);return k?{...P,selectedDeck:k.selectedDeck}:P})}:S);break;case"CHANGE_PLAYER_DECK":if(y.info("[CHANGE_PLAYER_DECK] Received deck change broadcast",p.data),!p.data||p.data.playerId===void 0)break;{const S=p.data.playerId,P=p.data.deckType,k=p.data.deck;if(S===c.current)break;n(F=>{const W=F.players.find(Y=>Y.id===S);if(!W)return F;let x;return k&&k.length>0?x=k.map(Y=>{if(Y.baseId){const H=Ye(Y.baseId);return H?{...H,id:Y.id,baseId:Y.baseId,deck:P,ownerId:S,ownerName:W.name,power:Y.power,powerModifier:Y.powerModifier||0,isFaceDown:Y.isFaceDown||!1,statuses:Y.statuses||[]}:{id:Y.id,baseId:Y.baseId,name:"Unknown",deck:P,ownerId:S,ownerName:W.name,power:Y.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}return{id:Y.id,baseId:Y.id,name:"Unknown",deck:P,ownerId:S,ownerName:W.name,power:Y.power||0,powerModifier:0,isFaceDown:!1,statuses:[],imageUrl:"",ability:""}}):x=Ze(P,S,W.name),{...F,players:F.players.map(Y=>Y.id===S?{...Y,selectedDeck:P,deck:x,hand:[],discard:[],announcedCard:null,boardHistory:[]}:Y)}})}break;case"GAME_RESET":n(S=>{const P=p.data.activeGridSize||8,k=[];for(let x=0;x<P;x++){const Y=[];for(let H=0;H<P;H++)Y.push({card:null});k.push(Y)}const F=(p.data.players||[]).map(x=>{if(x.isDummy&&x.hand&&x.deck&&x.discard)return{...x,boardHistory:[]};{const Y=x.selectedDeck||"SynchroTech";return{...x,hand:[],deck:Ze(Y,x.id,x.name),discard:[],boardHistory:[]}}}),W={...S,players:F,gameMode:p.data.gameMode,isPrivate:p.data.isPrivate,activeGridSize:p.data.activeGridSize,dummyPlayerCount:p.data.dummyPlayerCount,autoAbilitiesEnabled:p.data.autoAbilitiesEnabled,isGameStarted:p.data.isGameStarted,currentPhase:p.data.currentPhase,currentRound:p.data.currentRound,turnNumber:p.data.turnNumber,activePlayerId:p.data.activePlayerId,startingPlayerId:p.data.startingPlayerId,roundWinners:p.data.roundWinners||{},gameWinner:p.data.gameWinner,isRoundEndModalOpen:p.data.isRoundEndModalOpen,isReadyCheckActive:p.data.isReadyCheckActive,board:k,targetingMode:null,floatingTexts:[]};return l.current=W,W});break;case"ABILITY_MODE_SET":(Gr=p.data)!=null&&Gr.abilityMode&&(n(S=>({...S,abilityMode:p.data.abilityMode})),y.info("[AbilityMode] Received ability mode from host",{playerId:p.data.abilityMode.playerId,mode:p.data.abilityMode.mode}));break;case"ABILITY_TARGET_SELECTED":y.info("[Ability] Target selected",p.data);break;case"ABILITY_COMPLETED":n(S=>({...S,abilityMode:null})),y.info("[Ability] Ability completed",p.data);break;case"ABILITY_CANCELLED":n(S=>({...S,abilityMode:null}));break;case"CHANGE_PLAYER_COLOR":if(y.info("[CHANGE_PLAYER_COLOR] Received color change broadcast",p.data),!p.data||p.data.playerId===void 0)break;{const S=p.data.playerId,P=p.data.color;if(S===c.current)break;n(k=>({...k,players:k.players.map(F=>F.id===S?{...F,color:P}:F)}))}break;case"UPDATE_PLAYER_SCORE":if(y.info("[UPDATE_PLAYER_SCORE] Received score update broadcast",p.data),!p.data||p.data.playerId===void 0)break;{const S=p.data.playerId,P=p.data.delta;if(S===c.current)break;n(k=>({...k,players:k.players.map(F=>F.id===S?{...F,score:Math.max(0,F.score+P)}:F)}))}break;case"TRIGGER_HIGHLIGHT":if((xr=p.data)!=null&&xr.highlightData){const S=p.data.highlightData;D(S),J.current&&z.current&&p.senderId&&z.current.broadcastToGuests({type:"HIGHLIGHT_TRIGGERED",senderId:p.senderId,data:S,timestamp:Date.now()},p.senderId)}break;case"HIGHLIGHT_TRIGGERED":if(p.data){const S=(Ur=z.current)==null?void 0:Ur.getPeerId();p.senderId!==S&&D(p.data)}break;case"TRIGGER_FLOATING_TEXT":if(($r=p.data)!=null&&$r.textData){const S=p.data.textData;n(P=>({...P,floatingTexts:[...P.floatingTexts,S].filter(k=>Date.now()-k.timestamp<oe.FLOATING_TEXT_DURATION)})),J.current&&z.current&&p.senderId&&z.current.broadcastToGuests({type:"FLOATING_TEXT_TRIGGERED",senderId:p.senderId,data:S,timestamp:Date.now()},p.senderId)}break;case"TRIGGER_FLOATING_TEXT_BATCH":if((Hr=p.data)!=null&&Hr.batch){const S=p.data.batch;n(P=>({...P,floatingTexts:[...P.floatingTexts,...S].filter(k=>Date.now()-k.timestamp<oe.FLOATING_TEXT_DURATION)})),J.current&&z.current&&p.senderId&&z.current.broadcastToGuests({type:"FLOATING_TEXT_BATCH_TRIGGERED",senderId:p.senderId,data:{batch:S},timestamp:Date.now()},p.senderId)}break;case"FLOATING_TEXT_TRIGGERED":case"FLOATING_TEXT_BATCH_TRIGGERED":{const S=(Fr=z.current)==null?void 0:Fr.getPeerId();(Br=p.data)!=null&&Br.batch&&p.senderId!==S?n(P=>({...P,floatingTexts:[...P.floatingTexts,...p.data.batch].filter(k=>Date.now()-k.timestamp<oe.FLOATING_TEXT_DURATION)})):(Wr=p.data)!=null&&Wr.textData&&p.senderId!==S&&n(P=>({...P,floatingTexts:[...P.floatingTexts,p.data.textData].filter(k=>Date.now()-k.timestamp<oe.FLOATING_TEXT_DURATION)}));break}case"TRIGGER_NO_TARGET":if((Yr=p.data)!=null&&Yr.coords){const S=p.data.coords,P=p.data.timestamp;T({coords:S,timestamp:P}),J.current&&z.current&&p.senderId&&z.current.broadcastToGuests({type:"NO_TARGET_TRIGGERED",senderId:p.senderId,data:{coords:S,timestamp:P},timestamp:Date.now()},p.senderId)}break;case"NO_TARGET_TRIGGERED":if((zr=p.data)!=null&&zr.coords){const S=(Kr=z.current)==null?void 0:Kr.getPeerId();p.senderId!==S&&T({coords:p.data.coords,timestamp:p.data.timestamp})}break;case"TRIGGER_DECK_SELECTION":if(p.data){const S=p.data;L(P=>[...P,S]),setTimeout(()=>{L(P=>P.filter(k=>k.timestamp!==S.timestamp))},1e3),J.current&&z.current&&p.senderId&&z.current.broadcastToGuests({type:"DECK_SELECTION_TRIGGERED",senderId:p.senderId,data:S,timestamp:Date.now()},p.senderId)}break;case"TRIGGER_HAND_CARD_SELECTION":if(p.data){const S=p.data;_(P=>[...P,S]),setTimeout(()=>{_(P=>P.filter(k=>k.timestamp!==S.timestamp))},1e3),J.current&&z.current&&p.senderId&&z.current.broadcastToGuests({type:"HAND_CARD_SELECTION_TRIGGERED",senderId:p.senderId,data:S,timestamp:Date.now()},p.senderId)}break;case"TRIGGER_TARGET_SELECTION":if(p.data){const S=p.data;v(P=>[...P,S]),setTimeout(()=>{v(P=>P.filter(k=>k.timestamp!==S.timestamp))},1e3),J.current&&z.current&&p.senderId&&z.current.broadcastToGuests({type:"TARGET_SELECTION_TRIGGERED",senderId:p.senderId,data:S,timestamp:Date.now()},p.senderId)}break;case"TARGET_SELECTION_TRIGGERED":p.data&&p.senderId!==((qr=z.current)==null?void 0:qr.getPeerId())&&(v(S=>[...S,p.data]),setTimeout(()=>{v(S=>S.filter(P=>P.timestamp!==p.data.timestamp))},1e3));break;case"DECK_SELECTION_TRIGGERED":p.data&&p.senderId!==((jr=z.current)==null?void 0:jr.getPeerId())&&(L(S=>[...S,p.data]),setTimeout(()=>{L(S=>S.filter(P=>P.timestamp!==p.data.timestamp))},1e3));break;case"HAND_CARD_SELECTION_TRIGGERED":p.data&&p.senderId!==((Vr=z.current)==null?void 0:Vr.getPeerId())&&(_(S=>[...S,p.data]),setTimeout(()=>{_(S=>S.filter(P=>P.timestamp!==p.data.timestamp))},1e3));break;case"SET_TARGETING_MODE":if((Jr=p.data)!=null&&Jr.targetingMode){const S=p.data.targetingMode;y.info("[TargetingMode] Received SET_TARGETING_MODE via WebRTC",{playerId:S.playerId,mode:S.action.mode,boardTargetsCount:((Xr=S.boardTargets)==null?void 0:Xr.length)||0,handTargetsCount:((Zr=S.handTargets)==null?void 0:Zr.length)||0,isDeckSelectable:S.isDeckSelectable||!1,timestamp:S.timestamp}),n(P=>({...P,targetingMode:S})),l.current.targetingMode=S}break;case"CLEAR_TARGETING_MODE":n(S=>({...S,targetingMode:null})),l.current.targetingMode=null;break;case"SYNC_VALID_TARGETS":((Qr=p.data)==null?void 0:Qr.playerId)!==c.current&&(C({playerId:p.data.playerId,validHandTargets:p.data.validHandTargets||[],isDeckSelectable:p.data.isDeckSelectable||!1}),setTimeout(()=>{C(S=>(S==null?void 0:S.playerId)===p.data.playerId?null:S)},1e4));break;case"RECONNECT_ACCEPT":if((ea=p.data)!=null&&ea.gameState){const S=p.data.gameState;n(S),R("Connected"),y.info(`[Reconnection] State restored with ${((ta=S.players)==null?void 0:ta.length)||0} players`);try{localStorage.removeItem("webrtc_reconnection_data")}catch(P){y.warn("[Reconnection] Failed to clear stored data:",P)}}break;case"RECONNECT_REJECT":{const S=((ra=p.data)==null?void 0:ra.reason)||"unknown";y.warn(`[Reconnection] Reconnection rejected: ${S}`),R("Disconnected");try{localStorage.removeItem("webrtc_reconnection_data")}catch{}break}case"PLAYER_DISCONNECTED":((aa=p.data)==null?void 0:aa.playerId)!==void 0&&(y.info(`[Reconnection] Player ${p.data.playerId} disconnected, reconnection window open`),n(S=>({...S,players:S.players.map(P=>P.id===p.data.playerId?{...P,isDisconnected:!0}:P)})));break;case"PLAYER_RECONNECTED":((na=p.data)==null?void 0:na.playerId)!==void 0&&(y.info(`[Reconnection] Player ${p.data.playerId} reconnected`),n(S=>({...S,players:S.players.map(P=>P.id===p.data.playerId?{...P,isDisconnected:!1}:P)})));break;case"PLAYER_CONVERTED_TO_DUMMY":((oa=p.data)==null?void 0:oa.playerId)!==void 0&&(y.info(`[Reconnection] Player ${p.data.playerId} converted to dummy`),n(S=>({...S,players:S.players.map(P=>P.id===p.data.playerId?{...P,isDummy:!0,isDisconnected:!0}:P)})));break;case"REQUEST_DECK_VIEW":if(J.current&&((sa=p.data)==null?void 0:sa.targetPlayerId)!==void 0){const S=p.data.targetPlayerId;p.playerId;const P=a.players.find(k=>k.id===S);if(P&&z.current){let k=[];S===c.current||P.isDummy?(y.info(`[REQUEST_DECK_VIEW] Host/dummy deck has ${P.deck.length} cards, first card baseId: ${(ia=P.deck[0])==null?void 0:ia.baseId}`),k=P.deck.map(x=>({id:x.id,baseId:x.baseId,deck:x.deck,power:x.power,powerModifier:x.powerModifier,isFaceDown:x.isFaceDown,statuses:x.statuses||[]}))):P.deckCards&&P.deckCards.length>0?k=P.deckCards:k=P.deck.map(x=>({id:x.id,baseId:x.baseId,power:x.power,powerModifier:x.powerModifier,isFaceDown:x.isFaceDown,statuses:x.statuses||[]}));const F={targetPlayerId:S,deckCards:k,deckSize:k.length},W={type:"DECK_VIEW_DATA",senderId:z.current.getPeerId(),data:F,timestamp:Date.now()};z.current.sendToGuest(p.senderId||"",W),y.info(`[REQUEST_DECK_VIEW] Sent ${F.deckCards.length} cards for player ${S}`)}}break;case"DECK_VIEW_DATA":if(((da=p.data)==null?void 0:da.targetPlayerId)!==void 0&&((ca=p.data)!=null&&ca.deckCards)){const S=p.data.targetPlayerId,P=p.data.deckCards;y.info(`[DECK_VIEW_DATA] Received ${P.length} deck cards for player ${S}`);const k=W=>{if(W.baseId){const Y=Ye(W.baseId);if(Y)return{...Y,id:W.id,baseId:W.baseId,deck:W.deck||Re.SynchroTech,ownerId:S,power:W.power,powerModifier:W.powerModifier,isFaceDown:W.isFaceDown,statuses:W.statuses||[]};y.warn(`[DECK_VIEW_DATA] Card definition not found for baseId: ${W.baseId}`)}else y.warn(`[DECK_VIEW_DATA] Card missing baseId, id: ${W.id}`);return{id:W.id,baseId:W.baseId||W.id,name:"Unknown",imageUrl:"",fallbackImage:"",power:W.power||0,powerModifier:0,isFaceDown:!1,statuses:[],deck:Re.SynchroTech,color:"Red",ability:"",bonusPower:0,isPlaceholder:!1}},F=P.map(k);n(W=>({...W,players:W.players.map(x=>x.id===S?{...x,deck:F}:x)}))}break;case"DECK_DATA_UPDATE":if(J.current&&p.playerId!==void 0&&((la=p.data)!=null&&la.deck)){const S=p.playerId,P=p.data.deck,k=p.data.deckSize;y.info(`[DECK_DATA_UPDATE] Received ${P.length} cards for guest ${S}, deckSize=${k}`),n(F=>({...F,players:F.players.map(W=>W.id===S?{...W,deck:[...P],deckSize:k}:W)}))}break;case"REQUEST_DECK_DATA":if(!J.current&&z.current){const S=a.players.find(P=>P.id===c.current);if(S&&S.deck.length>0){y.info(`[REQUEST_DECK_DATA] Host requested deck data, sending ${S.deck.length} cards`);const P=S.deck.map(k=>({id:k.id,baseId:k.baseId,power:k.power,powerModifier:k.powerModifier||0,isFaceDown:k.isFaceDown||!1,statuses:k.statuses||[]}));z.current.sendAction("DECK_DATA_UPDATE",{playerId:c.current,deck:P,deckSize:P.length})}}break;default:y.warn(`[handleWebrtcMessage] Unknown message type: ${p.type}`,p);break}},[V,Ze,Gt,a,s]),Va=U.useCallback(p=>{if(!z.current||ge)return;Ee(!0),R("Connecting");const ae=3e4,ee=1e3;let re=0;const se=ae/ee;try{const le={hostPeerId:p,playerId:s,gameState:a,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(le))}catch(le){y.error("[Reconnection] Failed to store data:",le)}const ne=async()=>{re++;const le=Math.max(0,ae-re*ee);if(ke({attempt:re,maxAttempts:se,timeRemaining:le}),le<=0){y.warn("[Reconnection] Reconnection timeout expired - clearing stale data"),Ee(!1),ke(null),rt();return}let Z=p;if(a!=null&&a.gameId){const Te=Bt(a.gameId);if(Te&&Te.peerId!==p){Z=Te.peerId;try{const Se={hostPeerId:Z,playerId:s,gameState:a,timestamp:Date.now(),isHost:!1};localStorage.setItem("webrtc_reconnection_data",JSON.stringify(Se))}catch(Se){y.error("[Reconnection] Failed to update reconnection data:",Se)}}}try{const Te=s||c.current;Te!==null?(y.info(`[Reconnection] Reconnecting as existing player ${Te} to host ${Z}`),await z.current.initializeAsReconnectingGuest(Z,Te)):(y.info("[Reconnection] No playerId, connecting as new player"),await z.current.initializeAsGuest(Z)),y.info("[Reconnection] Successfully reconnected!"),Ee(!1),ke(null)}catch(Te){y.warn("[Reconnection] Reconnection attempt failed:",Te),setTimeout(ne,ee)}};ne()},[ge,a,s]),Ue=U.useCallback(p=>{n(ae=>{if(!ae)return y.error("[updateState] prevState is undefined, skipping update"),ae;const ee=typeof p=="function"?p(ae):p;if(!ee)return y.error("[updateState] newState is undefined, skipping update"),ae;const re=!ae.gameId&&ee.gameId;if(!Ke.current&&!re)return ee;if(B&&z.current){if(J.current){if(z.current.broadcastGameState(ee),y.info(`[updateState] Host broadcast state: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`),ee.gameId&&c.current!==null)try{mt({gameState:ee,localPlayerId:c.current,isHost:!0}),y.debug("[updateState] Saved game state for host auto-restore")}catch(se){y.warn("[updateState] Failed to save game state:",se)}}else z.current&&(z.current.sendStateToHost(ee,c.current),y.info(`[updateState] Guest sent state to host: phase=${ee.currentPhase}, activePlayer=${ee.activePlayerId}`));return ee}if(we.current&&we.current.readyState===WebSocket.OPEN){const se={type:"UPDATE_STATE",gameState:ee};dt.current&&(se.playerToken=dt.current),we.current.send(JSON.stringify(se))}return ee})},[B,V,Gt]),Ja=U.useCallback(()=>{const{initialState:p}=ct.createGame();Ue(p)},[ct,Ue]),Xa=U.useCallback(()=>{ct.exitGame(We,J,ya,rt)},[ct,We,J,ya,rt]),Za=ds({ws:we,webrtcManager:z,gameStateRef:l,webrtcIsHostRef:J,setGameState:n,updateState:Ue}),Qa=cs({ws:we,webrtcManager:z,gameStateRef:l,localPlayerIdRef:c,webrtcIsHostRef:J,setGameState:n}),en=ls({updateState:Ue,sendWebrtcAction:et,webrtcIsHostRef:J,webrtcManagerRef:z}),tn=us({updateState:Ue}),rn=fs({localPlayerIdRef:c,updateState:Ue}),{addBoardCardStatus:an,removeBoardCardStatus:nn,removeBoardCardStatusByOwner:on,modifyBoardCardPower:sn,addAnnouncedCardStatus:dn,removeAnnouncedCardStatus:cn,modifyAnnouncedCardPower:ln,addHandCardStatus:un,removeHandCardStatus:fn,revealHandCard:pn,revealBoardCard:yn,requestCardReveal:hn,respondToRevealRequest:mn,removeRevealedStatus:In}=rn,En=ps({webrtcIsHostRef:J,sendWebrtcAction:et,webrtcManagerRef:z,localPlayerIdRef:c,getCardDefinition:Ye,commandCardIds:To,createDeck:Ze,updateState:Ue}),{changePlayerDeck:Tn,loadCustomDeck:gn,resurrectDiscardedCard:wn,reorderTopDeck:_n,reorderCards:bn,recoverDiscardedCard:Sn}=En,An=ys({ws:we,webrtcManagerRef:z,webrtcIsHostRef:J,gameStateRef:l,scoreDeltaAccumulator:Xe,setGameState:n,updateState:Ue,abilityMode:t,setAbilityMode:r,createDeck:Ze}),{toggleActivePlayer:Cn,toggleAutoDraw:Rn,setPhase:Dn,nextPhase:Pn,prevPhase:kn,closeRoundEndModal:On,closeRoundEndModalOnly:vn,resetGame:Nn}=An;U.useEffect(()=>{Be.current=!1;const p=sessionStorage.getItem("invite_game_id"),ae=sessionStorage.getItem("invite_host_id");if(p&&!ae)return cr(),()=>{Be.current=!0,lt.current&&clearTimeout(lt.current),we.current&&(we.current.onclose=null,we.current.close())};if(p&&ae)return()=>{Be.current=!0,lt.current&&clearTimeout(lt.current),we.current&&(we.current.onclose=null,we.current.close())};const ee=performance.getEntriesByType("navigation"),re=ee.length>0?ee[0]:null,se=(re==null?void 0:re.type)??0,ne=os();return ne&&(y.info(`Restoring saved game state (nav type: ${se}):`,ne.gameState.gameId),n(ne.gameState),d(ne.localPlayerId),l.current=ne.gameState,c.current=ne.localPlayerId,dt.current=ne.playerToken),cr(),()=>{Be.current=!0,lt.current&&clearTimeout(lt.current),we.current&&(we.current.onclose=null,we.current.close())}},[]),U.useEffect(()=>{if(Fe&&l.current&&l.current.gameId){const p=At(l.current);p!==l.current&&(n(p),l.current=p)}},[]),U.useEffect(()=>{if(O)return;const p=setInterval(()=>{if(Fe&&l.current&&l.current.gameId){const ae=At(l.current);n({...ae}),l.current=ae,$(!0),clearInterval(p)}},100);return()=>clearInterval(p)},[O]);const{startReadyCheck:Mn,cancelReadyCheck:Ln,playerReady:Gn}=Qa,{updatePlayerName:xn,changePlayerColor:Un}=en,{drawCard:$n,drawCardsBatch:Hn,shufflePlayerDeck:Fn,flipBoardCard:Bn,flipBoardCardFaceDown:Wn}=tn,{assignTeams:Yn,setGameMode:zn,setGamePrivacy:Kn,setActiveGridSize:qn,setDummyPlayerCount:jn}=Za,Vn=U.useCallback(()=>{var p;if(((p=we.current)==null?void 0:p.readyState)===WebSocket.OPEN&&l.current.gameId&&c.current===1){we.current.send(JSON.stringify({type:"UPDATE_DECK_DATA",deckData:Fe}));const ae=l.current,ee=Ie(ae);ee.players.forEach(re=>{if(["hand","deck","discard"].forEach(ne=>{re[ne]&&(re[ne]=re[ne].map(le=>{const Z=$t(le.name);return Z?{...le,...Z}:le}))}),re.announcedCard){const ne=$t(re.announcedCard.name);ne&&(re.announcedCard={...re.announcedCard,...ne})}}),ee.board.forEach(re=>{re.forEach(se=>{if(se.card){const ne=$t(se.card.name);ne&&(se.card={...se.card,...ne})}})}),we.current.send(JSON.stringify({type:"FORCE_SYNC",gameState:ee})),n(ee)}},[]),xt=U.useCallback((p,ae)=>{var se;const ee=l.current;if(!ee.isGameStarted){y.warn("[ScoreUpdate] Blocked: game not started");return}if(ee.isRoundEndModalOpen){y.warn("[ScoreUpdate] Blocked: round end modal is open");return}if(ae===0)return;const re=ve();if(re?Ue(ne=>({...ne,players:ne.players.map(le=>le.id===p?{...le,score:Math.max(0,(le.score||0)+ae)}:le)})):n(ne=>({...ne,players:ne.players.map(le=>le.id===p?{...le,score:Math.max(0,(le.score||0)+ae)}:le)})),!re){if(((se=we.current)==null?void 0:se.readyState)!==WebSocket.OPEN){y.warn("[ScoreUpdate] Blocked: WebSocket not open");return}const ne=Xe.get(p);if(ne){clearTimeout(ne.timerId);const le=ne.delta+ae,Z=setTimeout(()=>{var Se;const Te=Xe.get(p);Te&&((Se=we.current)==null?void 0:Se.readyState)===WebSocket.OPEN&&(y.info(`[ScoreUpdate] Sending accumulated delta: player=${p}, delta=${Te.delta}`),we.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:l.current.gameId,playerId:p,delta:Te.delta}))),Xe.delete(p)},500);Xe.set(p,{delta:le,timerId:Z})}else{const le=setTimeout(()=>{var Te;const Z=Xe.get(p);Z&&((Te=we.current)==null?void 0:Te.readyState)===WebSocket.OPEN&&(y.info(`[ScoreUpdate] Sending delta: player=${p}, delta=${Z.delta}`),we.current.send(JSON.stringify({type:"UPDATE_PLAYER_SCORE",gameId:l.current.gameId,playerId:p,delta:Z.delta}))),Xe.delete(p)},500);Xe.set(p,{delta:ae,timerId:le})}}},[n,Ue]),{triggerHighlight:Jn,triggerFloatingText:ur,triggerNoTarget:Xn,triggerDeckSelection:Zn,triggerHandCardSelection:Qn,syncValidTargets:eo,triggerTargetSelection:to}=za,ro=Es({ws:we,webrtcManager:z,gameStateRef:l,webrtcIsHostRef:J,setGameState:n}),{setTargetingMode:ao,clearTargetingMode:fr}=ro,no=hs({ws:we,gameStateRef:l,updateState:Ue,updatePlayerScore:xt,triggerFloatingText:ur,clearTargetingMode:fr}),{scoreLine:oo,scoreDiagonal:so}=no,Je=ms({updateState:Ue,rawJsonData:Fe}),io=Is({updateState:Ue,localPlayerIdRef:c,updatePlayerScore:xt}),{moveItem:pr}=io;return{gameState:a,localPlayerId:s,setLocalPlayerId:d,draggedItem:A,setDraggedItem:f,connectionStatus:b,gamesList:I,latestHighlight:u,latestFloatingTexts:E,latestNoTarget:w,latestDeckSelections:N,latestHandCardSelections:M,joinAsInvite:Wa,startReadyCheck:Mn,cancelReadyCheck:Ln,playerReady:Gn,assignTeams:Yn,setGameMode:zn,setGamePrivacy:Kn,setActiveGridSize:qn,setDummyPlayerCount:jn,updatePlayerName:xn,changePlayerColor:Un,updatePlayerScore:xt,changePlayerDeck:Tn,loadCustomDeck:gn,drawCard:$n,drawCardsBatch:Hn,shufflePlayerDeck:Fn,moveItem:pr,handleDrop:pr,addBoardCardStatus:an,removeBoardCardStatus:nn,removeBoardCardStatusByOwner:on,modifyBoardCardPower:sn,addAnnouncedCardStatus:dn,removeAnnouncedCardStatus:cn,modifyAnnouncedCardPower:ln,addHandCardStatus:un,removeHandCardStatus:fn,flipBoardCard:Bn,flipBoardCardFaceDown:Wn,revealHandCard:pn,revealBoardCard:yn,requestCardReveal:hn,respondToRevealRequest:mn,syncGame:Vn,removeRevealedStatus:In,toggleActivePlayer:Cn,toggleAutoDraw:Rn,triggerHighlight:Jn,triggerFloatingText:ur,triggerNoTarget:Xn,triggerDeckSelection:Zn,triggerHandCardSelection:Qn,triggerTargetSelection:to,targetSelectionEffects:m,syncValidTargets:eo,remoteValidTargets:G,setTargetingMode:ao,clearTargetingMode:fr,nextPhase:Pn,prevPhase:kn,setPhase:Dn,markAbilityUsed:Je.markAbilityUsed,applyGlobalEffect:Je.applyGlobalEffect,swapCards:Je.swapCards,transferStatus:Je.transferStatus,transferAllCounters:Je.transferAllCounters,spawnToken:Je.spawnToken,resetDeployStatus:Je.resetDeployStatus,removeStatusByType:Je.removeStatusByType,recoverDiscardedCard:Sn,resurrectDiscardedCard:wn,scoreLine:oo,closeRoundEndModal:On,closeRoundEndModalOnly:vn,resetGame:Nn,scoreDiagonal:so,reorderTopDeck:_n,reorderCards:bn,updateState:Ue,requestDeckView:dr,sendFullDeckToHost:tt,createGame:Ja,joinGame:lr,joinGameViaModal:lr,exitGame:Xa,requestGamesList:Ya,forceReconnect:Ba,webrtcHostId:q,webrtcIsHost:V,initializeWebrtcHost:Ve,connectAsGuest:Qe,sendWebrtcAction:et,isReconnecting:ge,reconnectProgress:_e}};function Ta(e,t,r){const{gameState:a,localPlayerId:n,abilityMode:o,cursorStack:i,handleActionExecution:s,markAbilityUsed:d}=r;if(o||i||!a.isGameStarted||n===null)return null;const l=a.players.find(f=>f.id===e.ownerId),c=n===e.ownerId||(l==null?void 0:l.isDummy)&&n===1;if(a.activePlayerId!==e.ownerId||!c||!Ca(e,a)||!Aa(e,a.currentPhase,a.activePlayerId,a))return null;const A=Ro(e,a,e.ownerId,t);if(A){A.readyStatusToRemove&&d(t,!!A.isDeployAbility,!1,A.readyStatusToRemove);const f={...A,chainedAction:A.chainedAction?{...A.chainedAction,chainedAction:{type:"ABILITY_COMPLETE"}}:{type:"ABILITY_COMPLETE"}};return s(f,t),f}return null}function qe(e,t){var a;const r=(a=e.sourceCard)==null?void 0:a.ownerId;return typeof r=="number"?r:typeof t=="number"?t:0}function _s(e,t,r){var c;const{gameState:a,localPlayerId:n,commandContext:o,triggerNoTarget:i,onAbilityComplete:s,handleActionExecution:d}=r;if(e.type==="ABILITY_COMPLETE"){s==null||s();return}if(e.type==="REVEREND_SETUP_SCORE"){bs(e,t,r);return}if(e.type==="GLOBAL_AUTO_APPLY"){Ss(e,t,r);return}if(!bt(e,a,((c=e.sourceCard)==null?void 0:c.ownerId)||n,o)){i(t),e.chainedAction&&setTimeout(()=>{d(e.chainedAction,t)},500);return}if(e.type==="CREATE_STACK"){As(e,t,r);return}if(e.type==="OPEN_MODAL"){Cs(e,t,r);return}if(e.type==="ENTER_MODE"){Rs(e,t,r);return}y.warn("[handleActionExecution] Unknown action type:",e.type)}function bs(e,t,r){var l,c;const{gameState:a,updatePlayerScore:n,triggerFloatingText:o,markAbilityUsed:i}=r,s=((l=e.sourceCard)==null?void 0:l.ownerId)??0;let d=0;for(let A=0;A<a.board.length;A++)for(let f=0;f<a.board[A].length;f++){const b=(c=a.board[A][f])==null?void 0:c.card;if(b!=null&&b.statuses){const R=b.statuses.filter(I=>I.type==="Exploit"&&I.addedByPlayerId===s);d+=R.length}}d>0&&n(s,d),o([{row:t.row,col:t.col,text:`+${d}`,playerId:s}]),i(t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Ss(e,t,r){var R,I,g,u,D,E;const{gameState:a,localPlayerId:n,commandContext:o,markAbilityUsed:i,triggerNoTarget:s,triggerFloatingText:d,updatePlayerScore:l,applyGlobalEffect:c,addBoardCardStatus:A,removeStatusByType:f,handleActionExecution:b}=r;if(((R=e.payload)==null?void 0:R.customAction)==="FINN_SCORING"){const h=(I=e.sourceCard)==null?void 0:I.ownerId;if(h===void 0){y.warn("[FINN_SCORING] Source card missing ownerId"),i(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}let w=0;if(a.players.forEach(T=>{T.id!==h&&T.hand.forEach(N=>{var L;(L=N.statuses)!=null&&L.some(M=>M.type==="Revealed"&&M.addedByPlayerId===h)&&w++})}),a.board.forEach(T=>{T.forEach(N=>{var M;const L=N.card;if(L&&L.ownerId!==h){const _=((M=L.statuses)==null?void 0:M.filter(m=>m.type==="Revealed"&&m.addedByPlayerId===h).length)||0;w+=_}})}),w>0){const T=e.sourceCoords||t;d({row:T.row,col:T.col,text:`+${w}`,playerId:h}),l(h,w)}i(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(((g=e.payload)==null?void 0:g.customAction)==="REMOVE_ALL_AIM_FROM_CONTEXT"){e.sourceCoords&&e.sourceCoords.row>=0?f(e.sourceCoords,"Aim"):o.lastMovedCardCoords&&f(o.lastMovedCardCoords,"Aim");return}if((u=e.payload)!=null&&u.tokenType&&e.payload.filter){const{tokenType:h,filter:w}=e.payload,T=[],N=a.board.length;for(let L=0;L<N;L++)for(let M=0;M<N;M++){const _=a.board[L][M].card;_&&w(_,L,M)&&T.push({row:L,col:M})}if(T.length===0){s(e.sourceCoords||t),e.chainedAction&&setTimeout(()=>b(e.chainedAction,t),500),i(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}T.forEach(L=>{var M;A(L,h,((M=e.sourceCard)==null?void 0:M.ownerId)||0)}),i(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove),e.chainedAction&&setTimeout(()=>b(e.chainedAction,t),oe.MODE_CLEAR_DELAY);return}if((D=e.payload)!=null&&D.contextReward){ga(e,t,r);return}if(e.payload&&!e.payload.cleanupCommand){const{tokenType:h,filter:w}=e.payload,T=[],N=a.board.length;if(e.payload.contextReward&&e.sourceCard){ga(e,t,r);return}if(w)for(let L=0;L<N;L++)for(let M=0;M<N;M++){const _=a.board[L][M].card;_&&w(_)&&T.push({row:L,col:M})}else e.sourceCoords&&e.sourceCoords.row>=0?T.push(e.sourceCoords):t&&t.row>=0?T.push(t):o.lastMovedCardCoords&&T.push(o.lastMovedCardCoords);if(T.length>0){if(h){const L=e.payload.count||1,M=e.payload.ownerId!==void 0?e.payload.ownerId:((E=e.sourceCard)==null?void 0:E.ownerId)??n??0;for(let _=0;_<L;_++)c(t,T,h,M,!!e.isDeployAbility)}}else s(t),i(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}}function As(e,t,r){const{gameState:a,setAbilityMode:n,setCursorStack:o,triggerNoTarget:i}=r;let s=e.count||0;if(e.dynamicCount){const{factor:d,ownerId:l}=e.dynamicCount;let c=0;a.board.forEach(A=>{A.forEach(f=>{var b;if((b=f.card)!=null&&b.statuses){const R=f.card.statuses.filter(I=>I.type===d&&I.addedByPlayerId===l);c+=R.length}})}),s=c}s>0?(n(null),o({type:e.tokenType||"Aim",count:s,sourceCoords:e.sourceCoords||t,sourceCard:e.sourceCard,isDeployAbility:e.isDeployAbility,readyStatusToRemove:e.readyStatusToRemove,targetOwnerId:e.targetOwnerId,excludeOwnerId:e.excludeOwnerId,onlyOpponents:e.onlyOpponents,onlyFaceDown:e.onlyFaceDown,targetType:e.targetType,requiredTargetStatus:e.requiredTargetStatus,requireStatusFromSourceOwner:e.requireStatusFromSourceOwner,mustBeAdjacentToSource:e.mustBeAdjacentToSource,mustBeInLineWithSource:e.mustBeInLineWithSource,maxDistanceFromSource:e.maxDistanceFromSource,maxOrthogonalDistance:e.maxOrthogonalDistance,placeAllAtOnce:e.placeAllAtOnce,replaceStatus:e.replaceStatus,chainedAction:e.chainedAction,recordContext:e.recordContext})):i(t)}function Cs(e,t,r){var l,c;const{gameState:a,localPlayerId:n,commandContext:o,setViewingDiscard:i,markAbilityUsed:s}=r;if(!bt(e,a,((l=e.sourceCard)==null?void 0:l.ownerId)||n,o)){s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}if(e.mode==="RETRIEVE_DEVICE"){const A=a.players.find(f=>{var b;return f.id===((b=e.sourceCard)==null?void 0:b.ownerId)});A&&(i({player:A,pickConfig:{filterType:"Device",action:"recover"}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}else if(e.mode==="IMMUNIS_RETRIEVE"){const A=a.players.find(f=>{var b;return f.id===((b=e.sourceCard)==null?void 0:b.ownerId)});A&&i({player:A,pickConfig:{filterType:"Optimates",action:"resurrect"}})}else if(e.mode==="SEARCH_DECK"){const A=a.players.find(f=>{var b;return f.id===((b=e.sourceCard)==null?void 0:b.ownerId)});A&&(i({player:A,pickConfig:{filterType:((c=e.payload)==null?void 0:c.filterType)||"Unit",action:"recover",isDeck:!0}}),t.row>=0&&s(t,!!e.isDeployAbility,!1,e.readyStatusToRemove))}s(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Rs(e,t,r){var b,R;const{gameState:a,localPlayerId:n,commandContext:o,triggerNoTarget:i,setAbilityMode:s,markAbilityUsed:d,addBoardCardStatus:l,setTargetingMode:c,handleActionExecution:A}=r,f=e.mode;if(f==="SHIELD_SELF_THEN_RIOT_PUSH"){const I=e.sourceCard.ownerId;if(l(t,"Shield",I),!bt(e,a,I,o)){i(t),d(t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),c(e,qe(e,n),t,void 0,o);return}if(f==="SHIELD_SELF_THEN_SPAWN"){const I=qe(e,n);l(t,"Shield",I),s({...e,payload:{...e.payload,shieldApplied:!0}}),c(e,I,t);return}if(f==="PRINCEPS_SHIELD_THEN_AIM"){const I=qe(e,n);l(t,"Shield",I);const g={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};A(g,t);return}if(f==="GAWAIN_DEPLOY_SHIELD_AIM"){const I=e.sourceCard.ownerId;l(t,"Shield",I);const g={type:"CREATE_STACK",tokenType:"Aim",count:1,mustBeInLineWithSource:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};A(g,t);return}if(f==="ABR_DEPLOY_SHIELD_AIM"){const I=e.sourceCard.ownerId;l(t,"Shield",I);const g={type:"CREATE_STACK",tokenType:"Aim",count:1,requiredTargetStatus:"Threat",requireStatusFromSourceOwner:!0,sourceCard:e.sourceCard,sourceCoords:t,isDeployAbility:e.isDeployAbility};A(g,t);return}if(f==="RIOT_PUSH"){if(e.isDeployAbility){s(e),c(e,qe(e,n),t);return}if(!bt(e,a,((b=e.sourceCard)==null?void 0:b.ownerId)||n,o)){i(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),c(e,qe(e,n),t);return}if(f==="PATROL_MOVE"){s(e),c(e,qe(e,n),t);return}if(f==="SELECT_TARGET"){if(e.isDeployAbility){s(e),c(e,qe(e,n),t,void 0,o);return}if(!bt(e,a,((R=e.sourceCard)==null?void 0:R.ownerId)||n,o)){i(e.sourceCoords||t),d(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove);return}s(e),c(e,qe(e,n),t,void 0,o);return}s(e),c(e,qe(e,n),t)}function ga(e,t,r){var u,D,E,h,w,T,N;const{gameState:a,commandContext:n,updatePlayerScore:o,triggerFloatingText:i,drawCardsBatch:s,removeBoardCardStatus:d,addBoardCardStatus:l,modifyBoardCardPower:c,markAbilityUsed:A}=r,f=(u=e.payload)==null?void 0:u.contextReward,b=n.lastMovedCardCoords||t;if(!b||b.row<0)return;let R=a.board[b.row][b.col].card;const I=((D=e.payload)==null?void 0:D._tempContextId)||n.lastMovedCardId;if((!R||I&&R.id!==I)&&I)for(let L=0;L<a.board.length;L++){for(let M=0;M<a.board[L].length;M++)if(((E=a.board[L][M].card)==null?void 0:E.id)===I){R=a.board[L][M].card;break}if(R)break}if(!R){y.warn("[ContextReward] No card at coords");return}const g=Math.max(0,R.power+(R.powerModifier||0)+(R.bonusPower||0));f==="DRAW_MOVED_POWER"||f==="DRAW_EQUAL_POWER"?s(((h=e.sourceCard)==null?void 0:h.ownerId)||0,g):f==="SCORE_MOVED_POWER"?(i({row:b.row,col:b.col,text:`+${g}`,playerId:((w=e.sourceCard)==null?void 0:w.ownerId)||0}),o(((T=e.sourceCard)==null?void 0:T.ownerId)||0,g)):f==="STUN_MOVED_UNIT"?l(b,"Stun",((N=e.sourceCard)==null?void 0:N.ownerId)||0):f==="REMOVE_AIM"?d(b,"Aim"):f==="WEAKEN"&&c(b,-1),A(e.sourceCoords||t,!!e.isDeployAbility,!1,e.readyStatusToRemove)}function Ds(e,t){var _;const{gameState:r,localPlayerId:a,abilityMode:n,setAbilityMode:o,cursorStack:i,commandContext:s,setCommandContext:d,playMode:l,draggedItem:c,interactionLock:A,handleActionExecution:f,handleDrop:b,moveItem:R,setCursorStack:I,triggerNoTarget:g,markAbilityUsed:u,spawnToken:D,resurrectDiscardedCard:E,updatePlayerScore:h,triggerFloatingText:w,handleLineSelection:T,openContextMenu:N,triggerDeckSelection:L}=t;if(A.current)return!1;const M=r.board.length;if(c)return e.row>=0&&e.row<M&&e.col>=0&&e.col<r.board[e.row].length?(b(c,{location:"board",row:e.row,col:e.col}),!0):!1;if(i&&i.isDragging){if(st({location:"board",row:e.row,col:e.col},{...i.targetOwnerId!==void 0&&{targetOwnerId:i.targetOwnerId},...i.excludeOwnerId!==void 0&&{excludeOwnerId:i.excludeOwnerId},onlyOpponents:i.onlyOpponents,onlyFaceDown:i.onlyFaceDown,...i.targetType&&{targetType:i.targetType},...i.requiredTargetStatus&&{requiredTargetStatus:i.requiredTargetStatus},...i.requireStatusFromSourceOwner!==void 0&&{requireStatusFromSourceOwner:i.requireStatusFromSourceOwner},...i.mustBeAdjacentToSource&&i.sourceCoords&&{mustBeAdjacentTo:i.sourceCoords},...i.mustBeInLineWithSource&&i.sourceCoords&&{mustBeInLineWith:i.sourceCoords},...i.maxDistanceFromSource!==void 0&&{maxDistance:i.maxDistanceFromSource},...i.range&&{range:i.range}},a??0,r.players)){let v=null;if(i.sourceCoords){const{row:G,col:C}=i.sourceCoords;G>=0&&G<M&&C>=0&&C<r.board[G].length&&(v=r.board[G][C].card)}if(v)return f({type:"GLOBAL_AUTO_APPLY",payload:{tokenType:i.type,count:i.count,targetOwnerId:i.targetOwnerId,onlyOpponents:i.onlyOpponents,onlyFaceDown:i.onlyFaceDown,...i.range&&{range:i.range},...i.requiredTargetStatus&&{requiredTargetStatus:i.requiredTargetStatus},cleanupCommand:!0},sourceCard:v,sourceCoords:i.sourceCoords},e),!0}return!1}if(n&&n.mode==="SPAWN_TOKEN"){const{sourceCoords:m,payload:v,sourceCard:G,isDeployAbility:C,readyStatusToRemove:O}=n;if(!m||!(v!=null&&v.tokenName)||!(Math.abs(e.row-m.row)+Math.abs(e.col-m.col)===1))return!1;const B=(G==null?void 0:G.ownerId)??((_=n.sourceCard)==null?void 0:_.ownerId);return D(e,v.tokenName,B),u(m,C,!1,O),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="SELECT_CELL"){const{sourceCoords:m,sourceCard:v,isDeployAbility:G,readyStatusToRemove:C,payload:O}=n,$=(()=>{var q;if(m&&m.row>=0)return m;if(!v)return null;for(let K=0;K<r.board.length;K++)for(let V=0;V<r.board.length;V++)if(((q=r.board[K][V].card)==null?void 0:q.id)===v.id)return{row:K,col:V};return null})();if(!$||!v)return!1;let B=!1;if((O==null?void 0:O.range)==="line")B=e.row===$.row||e.col===$.col;else if((O==null?void 0:O.range)==="global")B=!0;else if((O==null?void 0:O.range)===2){const q=Math.abs(e.row-$.row)+Math.abs(e.col-$.col);if(q===1)B=!0;else if(q===2){const K=$.row,V=$.col,te=e.row,J=e.col;B=[{r:te,c:V},{r:K,c:J},{r:(K+te)/2,c:(V+J)/2}].some(Ee=>{if(!Number.isInteger(Ee.r)||!Number.isInteger(Ee.c))return!1;const _e=Math.floor((r.board.length-r.activeGridSize)/2),ke=_e,De=_e+r.activeGridSize-1;return Ee.r<ke||Ee.r>De||Ee.c<ke||Ee.c>De||Math.abs(Ee.r-K)+Math.abs(Ee.c-V)!==1?!1:!r.board[Ee.r][Ee.c].card})}}else O!=null&&O.filter?B=O.filter(null,e.row,e.col):B=Math.abs(e.row-$.row)+Math.abs(e.col-$.col)===1;if(!B)return!1;if(O!=null&&O.moveFromHand&&s.selectedHandCard){const{playerId:q,cardIndex:K}=s.selectedHandCard,V=r.players.find(J=>J.id===q),te=V==null?void 0:V.hand[K];if(te)return R({card:te,source:"hand",playerId:q,cardIndex:K,isManual:!0},{target:"board",boardCoords:e}),u(m||e,G,!1,C),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}if(!((O==null?void 0:O.allowSelf)&&e.row===$.row&&e.col===$.col)){const q=r.board[$.row][$.col].card;q&&R({card:q,source:"board",boardCoords:$,bypassOwnershipCheck:!0},{target:"board",boardCoords:e})}if(O!=null&&O.recordContext&&d({lastMovedCardCoords:e,lastMovedCardId:v.id}),u(m||e,G,!1,C),O!=null&&O.chainedAction){const q={...O.chainedAction};q.targetOwnerId===-2&&(q.targetOwnerId=v.ownerId),O.recordContext&&(q.payload||(q.payload={}),q.payload._tempContextId=v.id),o(null),setTimeout(()=>{f(q,e)},oe.MODE_CLEAR_DELAY)}else setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY);return!0}if(n&&n.mode==="PATROL_MOVE"){const{sourceCoords:m,sourceCard:v,isDeployAbility:G,readyStatusToRemove:C}=n;if(!m||!v)return!1;if(e.row===m.row&&e.col===m.col)return u(m,G,!1,C),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0;const O=e.row===m.row,$=e.col===m.col;return!O&&!$||r.board[e.row][e.col].card!==null?!1:(R({card:v,source:"board",boardCoords:m},{target:"board",boardCoords:e}),u(e,G,!1,C),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0)}if(n&&n.mode==="RIOT_MOVE"){const{sourceCoords:m,sourceCard:v,isDeployAbility:G,readyStatusToRemove:C,payload:O}=n;return!m||!v||!(O!=null&&O.vacatedCoords)?!1:e.row===O.vacatedCoords.row&&e.col===O.vacatedCoords.col?(R({card:v,source:"board",boardCoords:m},{target:"board",boardCoords:e}),u(e,G,!1,C),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0):(u(m,G,!1,C),o(null),!0)}if(n&&n.mode==="IMMUNIS_RETRIEVE"){const{sourceCoords:m,payload:v,isDeployAbility:G,readyStatusToRemove:C,sourceCard:O}=n;if(!m||!(Math.abs(e.row-m.row)+Math.abs(e.col-m.col)===1))return!1;if((v==null?void 0:v.selectedCardIndex)!==void 0){const B=(O==null?void 0:O.ownerId)||0;return E(B,v.selectedCardIndex,e),u(m,G,!1,C),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}return!1}if(n&&n.mode==="INTEGRATOR_LINE_SELECT"){const{sourceCoords:m,sourceCard:v,isDeployAbility:G,readyStatusToRemove:C}=n;if(!m||m.row<0)return!1;const O=e.row===m.row,$=e.col===m.col;if(!O&&!$)return!1;const B=(v==null?void 0:v.ownerId)||0;let X=0;if(O)for(let q=0;q<M;q++){const K=r.board[e.row][q].card;K!=null&&K.statuses&&(X+=K.statuses.filter(V=>V.type==="Exploit"&&V.addedByPlayerId===B).length)}else for(let q=0;q<M;q++){const K=r.board[q][e.col].card;q!==m.row&&K!=null&&K.statuses&&(X+=K.statuses.filter(V=>V.type==="Exploit"&&V.addedByPlayerId===B).length)}return X>0&&(h(B,X),w({row:m.row,col:m.col,text:`+${X}`,playerId:B})),u(m,G,!1,C),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="IP_AGENT_THREAT_SCORING"){const{sourceCoords:m,sourceCard:v,isDeployAbility:G,readyStatusToRemove:C}=n;if(!m)return!1;const O=e.row===m.row,$=e.col===m.col;if(!O&&!$)return!1;const B=(v==null?void 0:v.ownerId)||0;let X=0;if(O)for(let K=0;K<M;K++){const V=r.board[e.row][K].card;V!=null&&V.statuses&&(X+=V.statuses.filter(te=>te.type==="Threat"&&te.addedByPlayerId===B).length)}else for(let K=0;K<M;K++){const V=r.board[K][e.col].card;K!==m.row&&V!=null&&V.statuses&&(X+=V.statuses.filter(te=>te.type==="Threat"&&te.addedByPlayerId===B).length)}const q=X*2;return q>0&&(h(B,q),w({row:m.row,col:m.col,text:`+${q}`,playerId:B})),u(m,G,!1,C),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}if(n&&n.mode==="ZIUS_LINE_SELECT"){const{sourceCoords:m,sourceCard:v,isDeployAbility:G,readyStatusToRemove:C}=n,O=s.lastMovedCardCoords||m;if(!O)return!1;const $=e.row===O.row,B=e.col===O.col;if(!$&&!B)return!1;const X=(v==null?void 0:v.ownerId)||0;let q=0;const K=[];if($)for(let V=0;V<M;V++){const te=r.board[e.row][V].card;if(te!=null&&te.statuses){const J=te.statuses.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===X);q+=J.length,J.length>0&&K.push({row:e.row,col:V})}}else for(let V=0;V<M;V++){const te=r.board[V][e.col].card;if(V!==O.row&&te!=null&&te.statuses){const J=te.statuses.filter(ge=>ge.type==="Exploit"&&ge.addedByPlayerId===X);q+=J.length,J.length>0&&K.push({row:V,col:e.col})}}return q>0&&(h(X,q),K.forEach(V=>{w({row:V.row,col:V.col,text:"+1",playerId:X})})),u(m||O,G,!1,C),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}return n&&["SCORE_LAST_PLAYED_LINE","SELECT_LINE_END","SELECT_LINE_START","SELECT_DIAGONAL"].includes(n.mode)?(T(e),!0):l!=null&&l.card&&l.sourceCoords?(b({card:l.card,source:"hand",playerId:l.playerId,cardIndex:l.cardIndex},{location:"board",row:e.row,col:e.col}),!0):!1}function Ps(e,t,r,a){var u;const{gameState:n,localPlayerId:o,abilityMode:i,cursorStack:s,interactionLock:d,setCommandContext:l,setAbilityMode:c,moveItem:A,markAbilityUsed:f,handleActionExecution:b,triggerHandCardSelection:R,setCursorStack:I,clearTargetingMode:g}=a;if(!d.current){if(s){if(["Aim","Exploit","Stun","Shield"].includes(s.type))return;const E={targetOwnerId:s.targetOwnerId,excludeOwnerId:s.excludeOwnerId,onlyOpponents:s.onlyOpponents||s.targetOwnerId===-1,onlyFaceDown:s.onlyFaceDown,targetType:s.targetType,requiredTargetStatus:s.requiredTargetStatus,tokenType:s.type};if(st({card:t,ownerId:e.id,location:"hand"},E,n.activePlayerId,n.players)&&s.type==="Revealed"){const w=((u=s.sourceCard)==null?void 0:u.ownerId)??n.activePlayerId??o??1;t.statuses||(t.statuses=[]),t.statuses.some(N=>N.type==="Revealed"&&N.addedByPlayerId===w)||(t.statuses.push({type:"Revealed",addedByPlayerId:w}),A({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:"Revealed",count:1},{target:"hand",playerId:e.id,cardIndex:r}),s.sourceCoords&&s.sourceCoords.row>=0&&f(s.sourceCoords,s.isDeployAbility,!1,s.readyStatusToRemove),s.count>1?I(N=>N?{...N,count:N.count-1}:null):(g(),clearValidTargets==null||clearValidTargets(),s.chainedAction&&b(s.chainedAction,s.sourceCoords||{row:-1,col:-1}),I(null)))}return}if((i==null?void 0:i.type)==="ENTER_MODE"&&i.mode==="SELECT_TARGET"){const{payload:D,sourceCoords:E,isDeployAbility:h,sourceCard:w,readyStatusToRemove:T}=i;if(R(e.id,r,n.activePlayerId??o??1),D.actionType==="SELECT_HAND_FOR_DEPLOY"){if(D.filter&&!D.filter(t))return;l(N=>({...N,selectedHandCard:{playerId:e.id,cardIndex:r}})),c({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:t,payload:{range:"global",moveFromHand:!0}});return}if(D.actionType==="SELECT_HAND_FOR_DISCARD_THEN_SPAWN"){if(D.filter&&!D.filter(t)||e.id!==(w==null?void 0:w.ownerId))return;A({card:t,source:"hand",playerId:e.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),c({type:"ENTER_MODE",mode:"SPAWN_TOKEN",sourceCard:w,sourceCoords:E,isDeployAbility:h,payload:{tokenName:D.tokenName}});return}if(D.actionType==="LUCIUS_SETUP"){if(e.id!==(w==null?void 0:w.ownerId))return;A({card:t,source:"hand",playerId:e.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),b({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:w,sourceCoords:E,isDeployAbility:h,payload:{filterType:"Command"}},E||{row:-1,col:-1}),c(null);return}if(D.actionType==="DESTROY"){if(D.filter&&!D.filter(t))return;A({card:t,source:"hand",playerId:e.id,cardIndex:r,bypassOwnershipCheck:!0},{target:"discard",playerId:e.id}),E&&E.row>=0&&f(E,h,!1,T),setTimeout(()=>c(null),oe.MODE_CLEAR_DELAY)}}}}function ks(e,t,r){const{abilityMode:a,cursorStack:n,interactionLock:o,gameState:i,activateAbility:s}=r;a||n||o.current||i.isGameStarted&&i.activePlayerId===e.id&&bo(t,"setup",i.currentPhase)&&s(t,{row:-1,col:-1})}function Os(e,t){var w,T,N,L,M;const{gameState:r,localPlayerId:a,abilityMode:n,interactionLock:o,setAbilityMode:i,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:l,nextPhase:c,modifyBoardCardPower:A,scoreLine:f,scoreDiagonal:b,commandContext:R}=t;if(!n)return!1;const{mode:I,sourceCard:g,sourceCoords:u,payload:D,isDeployAbility:E,readyStatusToRemove:h}=n;if(I==="SCORE_LAST_PLAYED_LINE"&&n.sourceCoords){if(o.current)return!0;const{row:_,col:m}=n.sourceCoords,{row:v,col:G}=e;if(_!==v&&m!==G)return!0;o.current=!0;const C=r.activePlayerId,O=r.board.length;let $=_,B=_,X=m,q=m;if(_===v)$=_,B=_,X=0,q=O-1;else if(m===G)X=G,q=G,$=0,B=O-1;else return o.current=!1,!0;const K=r.board.some(J=>J.some(ge=>{var Ee,_e;return((Ee=ge.card)==null?void 0:Ee.ownerId)===C&&ge.card.name.toLowerCase().includes("data liberator")&&((_e=ge.card.statuses)==null?void 0:_e.some(ke=>ke.type==="Support"))}));let V=0;const te=[];for(let J=$;J<=B;J++)for(let ge=X;ge<=q;ge++){const _e=r.board[J][ge].card;if(_e&&!((w=_e.statuses)!=null&&w.some(ke=>ke.type==="Stun"))){const ke=_e.ownerId===C,De=(T=_e.statuses)==null?void 0:T.some(be=>be.type==="Exploit"&&be.addedByPlayerId===C);if(ke||K&&De&&_e.ownerId!==C){const be=Math.max(0,_e.power+(_e.powerModifier||0)+(_e.bonusPower||0));be>0&&(V+=be,te.push({row:J,col:ge,text:`+${be}`,playerId:C}))}}}return i(null),te.length>0&&l(te),V>0&&d(C,V),c(),setTimeout(()=>{o.current=!1},200),!0}if(I==="SELECT_LINE_START")return i({type:"ENTER_MODE",mode:"SELECT_LINE_END",sourceCard:g,sourceCoords:u,isDeployAbility:E,payload:{...D,firstCoords:e}}),!0;if(I==="SELECT_LINE_END"&&(D!=null&&D.firstCoords)){const{row:_,col:m}=D.firstCoords,{row:v,col:G}=e;if(_!==v&&m!==G)return!0;const C=D.actionType,O=(g==null?void 0:g.ownerId)??((N=r.players.find($=>$.id===r.activePlayerId))!=null&&N.isDummy?r.activePlayerId:a||r.activePlayerId);if(C==="ZIUS_SCORING"){const $=R.lastMovedCardCoords;if($){const J=_===v&&$.row===_,ge=m===G&&$.col===m;if(!J&&!ge)return!0}const B=r.board.length;let X=0,q=B-1,K=0,V=B-1;if(_===v)X=q=_;else if(m===G)K=V=m;else return!0;let te=0;for(let J=X;J<=q;J++)for(let ge=K;ge<=V;ge++){const Ee=r.board[J][ge];Ee.card&&(te+=((L=Ee.card.statuses)==null?void 0:L.filter(_e=>_e.type==="Exploit"&&_e.addedByPlayerId===O).length)||0)}te>0&&O&&(u&&l({row:u.row,col:u.col,text:`+${te}`,playerId:O}),d(O,te)),u&&u.row>=0&&s(u,E,!1,h)}else if(C==="CENTURION_BUFF"&&g&&u&&O){const $=r.board.length;let B=0,X=$-1,q=0,K=$-1;_===v?B=X=_:q=K=m;for(let V=B;V<=X;V++)for(let te=q;te<=K;te++){const J=r.board[V][te].card;if(J){const ge=J.id===g.id,Ee=J.ownerId===O,_e=r.players.find(be=>be.id===O),ke=r.players.find(be=>be.id===J.ownerId),De=(_e==null?void 0:_e.teamId)!==void 0&&(ke==null?void 0:ke.teamId)!==void 0&&_e.teamId===ke.teamId;!ge&&(Ee||De)&&A({row:V,col:te},1)}}s(u,E,!1,h)}else(C==="SCORE_LINE"||!C)&&(f(_,m,v,G,O),D.skipNextPhase||c());return setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}if(I==="SELECT_DIAGONAL"&&D.actionType==="SCORE_DIAGONAL"){const _=(g==null?void 0:g.ownerId)??((M=r.players.find(m=>m.id===r.activePlayerId))!=null&&M.isDummy?r.activePlayerId:a||r.activePlayerId);if(D.firstCoords){const{row:m,col:v}=D.firstCoords,{row:G,col:C}=e;return Math.abs(m-G)!==Math.abs(v-C)?(i(null),!0):(b(m,v,G,C,_,D.bonusType),D.skipNextPhase||c(),i(null),!0)}else return i({...n,payload:{...D,firstCoords:e}}),!0}return!1}function vs(e,t,r){var V;const{gameState:a,localPlayerId:n,abilityMode:o,commandContext:i,markAbilityUsed:s,triggerNoTarget:d,handleActionExecution:l,interactionLock:c,moveItem:A,swapCards:f,transferStatus:b,transferAllCounters:R,spawnToken:I,modifyBoardCardPower:g,addBoardCardStatus:u,removeBoardCardStatus:D,removeBoardCardStatusByOwner:E,removeStatusByType:h,resetDeployStatus:w,updatePlayerScore:T,triggerFloatingText:N,setCounterSelectionData:L,validTargets:M,handleLineSelection:_,setAbilityMode:m,setCommandContext:v,triggerTargetSelection:G}=r;if(!o||o.type!=="ENTER_MODE"||c.current||o.sourceCard&&o.sourceCard.id===e.id&&o.mode!=="SELECT_LINE_START"&&o.mode!=="INTEGRATOR_LINE_SELECT"&&o.mode!=="ZIUS_LINE_SELECT"&&o.mode!=="IP_AGENT_THREAT_SCORING"&&o.mode!=="SELECT_UNIT_FOR_MOVE"&&o.mode!=="SELECT_TARGET"&&o.mode!=="RIOT_PUSH"&&o.mode!=="RIOT_MOVE"&&o.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{mode:C,payload:O,sourceCard:$,sourceCoords:B,isDeployAbility:X,readyStatusToRemove:q,recordContext:K}=o;return C==="SELECT_LINE_START"||C==="SELECT_LINE_END"?(_(t),!0):(($==null?void 0:$.ownerId)??((V=a.players.find(te=>te.id===a.activePlayerId))!=null&&V.isDummy?a.activePlayerId:n||a.activePlayerId),C==="SELECT_TARGET"&&O.tokenType?Ns(e,t,r):C==="SELECT_TARGET"?Ms(e,t,r):C==="RIOT_PUSH"?Ls(e,t,r):C==="RIOT_MOVE"?Gs(e,t,r):C==="SWAP_POSITIONS"?xs(e,t,r):C==="TRANSFER_STATUS_SELECT"?Us(e,t,r):C==="ZEALOUS_WEAKEN"?$s(e,t,r):C==="REVEREND_DOUBLE_EXPLOIT"?Hs(e,t,r):C==="SELECT_UNIT_FOR_MOVE"?Fs(e,t,r):C==="PATROL_MOVE"?Bs(e,t,r):C==="SPAWN_TOKEN"?Ws(e,t,r):C==="REVEAL_ENEMY"?Ys(e,t,r):C==="SELECT_CELL"?zs(e,t,r):C==="IMMUNIS_RETRIEVE"?Ks(e,t,r):C==="INTEGRATOR_LINE_SELECT"?qs(e,t,r):C==="IP_AGENT_THREAT_SCORING"?js(e,t,r):C==="ZIUS_LINE_SELECT"?Vs(e,t,r):C==="SELECT_DIAGONAL"?Js(e,t,r):C==="SCORE_LAST_PLAYED_LINE"?Xs(e,t,r):C==="SEARCH_DECK"?Zs(e,t,r):C==="RETRIEVE_DEVICE"?Qs(e,t,r):C==="SELECT_DECK"?ei(e,t,r):!1)}function Ns(e,t,r){const{abilityMode:a,triggerTargetSelection:n,moveItem:o,markAbilityUsed:i,setAbilityMode:s,setCommandContext:d,handleActionExecution:l,clearValidTargets:c}=r,{payload:A,sourceCoords:f,isDeployAbility:b,readyStatusToRemove:R}=a;if(A.filter&&!A.filter(e,t.row,t.col))return!1;if(o({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:A.tokenType,count:A.count||1},{target:"board",boardCoords:t}),n("board",t),A.recordContext&&d({lastMovedCardCoords:t,lastMovedCardId:e.id}),A.chainedAction){const I={...A.chainedAction,sourceCard:A.chainedAction.sourceCard??e,sourceCoords:A.chainedAction.sourceCoords??t,isDeployAbility:b,recordContext:!0};l(I,t),setTimeout(()=>n("board",t),100),I.type!=="ENTER_MODE"&&(s(null),c())}else f&&f.row>=0&&i(f,b,!1,R),setTimeout(()=>{s(null),c()},oe.MODE_CLEAR_DELAY);return!0}function Ms(e,t,r){var L,M,_,m;const{abilityMode:a,markAbilityUsed:n,setAbilityMode:o,moveItem:i,modifyBoardCardPower:s,addBoardCardStatus:d,removeBoardCardStatus:l,removeBoardCardStatusByOwner:c,removeStatusByType:A,resetDeployStatus:f,updatePlayerScore:b,triggerFloatingText:R,setCounterSelectionData:I,handleActionExecution:g,gameState:u}=r,{mode:D,payload:E,sourceCoords:h,isDeployAbility:w,readyStatusToRemove:T}=a,N=((L=a.sourceCard)==null?void 0:L.ownerId)??((M=u.players.find(v=>v.id===u.activePlayerId))!=null&&M.isDummy?u.activePlayerId:r.localPlayerId||u.activePlayerId);if(E.actionType==="OPEN_COUNTER_MODAL")return E.filter&&!E.filter(e)?!1:(I({card:e,callbackAction:E.rewardType}),o(null),!0);if(E.actionType==="SACRIFICE_AND_BUFF_LINES"){if(E.filter&&!E.filter(e,t.row,t.col))return!1;i({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"discard",playerId:e.ownerId});const v=u.board.length,{row:G,col:C}=t;for(let O=0;O<v;O++){if(O===C)continue;const B=u.board[G][O].card;B&&wa(u,B.ownerId,N)&&s({row:G,col:O},1)}for(let O=0;O<v;O++){if(O===G)continue;const B=u.board[O][C].card;B&&wa(u,B.ownerId,N)&&s({row:O,col:C},1)}return n(h||t,w,!1,T),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}if(E.actionType==="SHIELD_AND_REMOVE_AIM")return E.filter&&!E.filter(e)?!1:(d(t,"Shield",N),A(t,"Aim"),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0);if(E.actionType==="RESET_DEPLOY")return E.filter&&!E.filter(e)?!1:(f(t),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0);if(E.actionType==="MODIFY_POWER")return E.filter&&!E.filter(e)?!1:(E.amount&&s(t,E.amount),h&&h.row>=0&&n(h,w,!1,T),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0);if(E.actionType==="DESTROY")return E.filter&&!E.filter(e)?!1:(((_=e.statuses)==null?void 0:_.some(G=>G.type==="Shield"))?l(t,"Shield"):i({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),n(h||t,w,!1,T),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0);if(E.actionType==="LUCIUS_SETUP")return E.filter&&!E.filter(e)?!1:(i({card:e,source:"board",boardCoords:t},{target:"discard",playerId:e.ownerId}),E.chainedAction&&g(E.chainedAction,t),!0);if(E.actionType==="CENSOR_SWAP"){if(E.filter&&!E.filter(e))return!1;const v=((m=e.statuses)==null?void 0:m.filter(G=>G.type==="Exploit"&&G.addedByPlayerId===N).length)||0;if(v>0){c(t,"Exploit",N);for(let G=0;G<v;G++)d(t,"Stun",N)}return n(h||t,w,!1,T),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0}return!1}function Ls(e,t,r){const{abilityMode:a,gameState:n,setAbilityMode:o,moveItem:i,markAbilityUsed:s,interactionLock:d}=r;if(d.current)return!1;const{sourceCoords:l,isDeployAbility:c,readyStatusToRemove:A,sourceCard:f}=a;if(!l||l.row<0)return!1;if(t.row===l.row&&t.col===l.col)return s(l,c,!1,A),setTimeout(()=>o(null),oe.MODE_CLEAR_DELAY),!0;const b=Math.abs(t.row-l.row)+Math.abs(t.col-l.col)===1,R=n.players.find(M=>M.id===e.ownerId),I=n.players.find(M=>M.id===(f==null?void 0:f.ownerId)),g=(R==null?void 0:R.teamId)!==void 0&&(I==null?void 0:I.teamId)!==void 0&&R.teamId===I.teamId;if(!b||e.ownerId===(f==null?void 0:f.ownerId)||g)return!1;const u=t.row-l.row,D=t.col-l.col,E=t.row+u,h=t.col+D,w=n.board.length,T=Math.floor((w-n.activeGridSize)/2),N=T,L=T+n.activeGridSize-1;return E<N||E>L||h<N||h>L||n.board[E][h].card!==null?!1:(i({card:e,source:"board",boardCoords:t,bypassOwnershipCheck:!0},{target:"board",boardCoords:{row:E,col:h}}),o({type:"ENTER_MODE",mode:"RIOT_MOVE",sourceCard:f,sourceCoords:l,isDeployAbility:c,payload:{vacatedCoords:t}}),!0)}function Gs(e,t,r){const{abilityMode:a,moveItem:n,markAbilityUsed:o,setAbilityMode:i}=r;if(!a||a.mode!=="RIOT_MOVE")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:l,readyStatusToRemove:c,payload:A}=a;return!s||!d||!(A!=null&&A.vacatedCoords)?!1:t.row===A.vacatedCoords.row&&t.col===A.vacatedCoords.col?(n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),o(t,l,!1,c),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0):(o(s,l,!1,c),i(null),!0)}function xs(e,t,r){const{abilityMode:a,gameState:n,moveItem:o,markAbilityUsed:i,setAbilityMode:s,validTargets:d}=r;if(!a||a.mode!=="SWAP_POSITIONS")return!1;const{sourceCoords:l,sourceCard:c,isDeployAbility:A,readyStatusToRemove:f,payload:b}=a;if(!l||l.row<0)return!1;const R=n.board[l.row][l.col].card;return!R||R.id!==(c==null?void 0:c.id)?(s(null),!1):c&&c.id===e.id||b.filter&&!b.filter(e,t.row,t.col)||!b.filter&&d&&!d.some(g=>g.row===t.row&&g.col===t.col)?!1:(o({card:R,source:"board",boardCoords:l},{target:"board",boardCoords:t}),o({card:e,source:"board",boardCoords:t},{target:"board",boardCoords:l}),i(t,A,!1,f),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0)}function Us(e,t,r){const{abilityMode:a,transferStatus:n,markAbilityUsed:o,setAbilityMode:i}=r;if(!a||a.mode!=="TRANSFER_STATUS_SELECT")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:l,readyStatusToRemove:c}=a;return!s||s.row<0||d&&d.id===e.id||!e.statuses||e.statuses.length===0?!1:(n(t,s,e.statuses[0].type),o(s,l,!1,c),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0)}function $s(e,t,r){const{abilityMode:a,modifyBoardCardPower:n,markAbilityUsed:o,setAbilityMode:i}=r;if(!a||a.mode!=="ZEALOUS_WEAKEN")return!1;const{payload:s,sourceCoords:d,isDeployAbility:l,readyStatusToRemove:c}=a;return s.filter&&!s.filter(e)?!1:(n(t,-1),o(d||t,l,!1,c),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0)}function Hs(e,t,r){const{abilityMode:a,gameState:n,addBoardCardStatus:o,markAbilityUsed:i,triggerFloatingText:s,setAbilityMode:d}=r;if(!a||a.mode!=="REVEREND_DOUBLE_EXPLOIT")return!1;const{sourceCoords:l,sourceCard:c,isDeployAbility:A,readyStatusToRemove:f}=a,b=(c==null?void 0:c.ownerId)||0,R=(e.statuses||[]).filter(I=>I.type==="Exploit"&&I.addedByPlayerId===b).length;if(R>0){for(let I=0;I<R;I++)o(t,"Exploit",b);s([{row:t.row,col:t.col,text:`+${R}`,playerId:b}])}return i(l||t,A,!1,f),setTimeout(()=>d(null),oe.MODE_CLEAR_DELAY),!0}function Fs(e,t,r){const{abilityMode:a,setAbilityMode:n}=r;if(!a||a.mode!=="SELECT_UNIT_FOR_MOVE")return!1;const{sourceCard:o,payload:i,isDeployAbility:s,readyStatusToRemove:d}=a;return o&&o.id===e.id||i.filter&&!i.filter(e,t.row,t.col)?!1:(n({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:e,sourceCoords:t,isDeployAbility:s,readyStatusToRemove:d,payload:{range:i.range||2,moveFromHand:i.moveFromHand||!1,selectedCard:e,allowSelf:!1}}),!0)}function Bs(e,t,r){const{abilityMode:a,gameState:n,moveItem:o,markAbilityUsed:i,setAbilityMode:s}=r;if(!a||a.mode!=="PATROL_MOVE")return!1;const{sourceCoords:d,sourceCard:l,isDeployAbility:c,readyStatusToRemove:A}=a;if(!d||!l)return!1;if(t.row===d.row&&t.col===d.col)return i(d,c,!1,A),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0;const f=t.row===d.row,b=t.col===d.col;return!f&&!b||n.board[t.row][t.col].card!==null?!1:(o({card:l,source:"board",boardCoords:d},{target:"board",boardCoords:t}),i(t,c,!1,A),setTimeout(()=>s(null),oe.MODE_CLEAR_DELAY),!0)}function Ws(e,t,r){var R;const{abilityMode:a,spawnToken:n,markAbilityUsed:o,setAbilityMode:i}=r;if(!a||a.mode!=="SPAWN_TOKEN")return!1;const{sourceCoords:s,payload:d,isDeployAbility:l,readyStatusToRemove:c,sourceCard:A}=a;if(!s||!(d!=null&&d.tokenName)||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1))return!1;const b=(A==null?void 0:A.ownerId)??((R=a.sourceCard)==null?void 0:R.ownerId);return n(t,d.tokenName,b),o(s,l,!1,c),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}function Ys(e,t,r){const{abilityMode:a,setAbilityMode:n,setCursorStack:o,moveItem:i,markAbilityUsed:s,gameState:d}=r;if(!a||a.mode!=="REVEAL_ENEMY")return!1;const{sourceCoords:l,sourceCard:c,isDeployAbility:A,readyStatusToRemove:f,payload:b}=a;if(!l||!c||!(Math.abs(t.row-l.row)+Math.abs(t.col-l.col)===1))return!1;const I=e.ownerId;return o({type:"Revealed",count:1,targetOwnerId:I,onlyFaceDown:!0,onlyOpponents:!0,sourceCoords:t,sourceCard:e,isDeployAbility:A,readyStatusToRemove:f}),s(l,A,!1,f),!0}function zs(e,t,r){const{abilityMode:a,moveItem:n,markAbilityUsed:o,setAbilityMode:i}=r;if(!a||a.mode!=="SELECT_CELL")return!1;const{sourceCoords:s,sourceCard:d,isDeployAbility:l,readyStatusToRemove:c,payload:A}=a;return A!=null&&A.filter&&!A.filter(null,t.row,t.col)?!1:(A!=null&&A.moveFromHand&&(A!=null&&A.selectedCard)?n({card:A.selectedCard,source:"hand"},{target:"board",boardCoords:t}):s&&s.row>=0&&n({card:d,source:"board",boardCoords:s},{target:"board",boardCoords:t}),o(s||t,l,!1,c),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0)}function Ks(e,t,r){const{abilityMode:a,moveItem:n,markAbilityUsed:o,setAbilityMode:i}=r;if(!a||a.mode!=="IMMUNIS_RETRIEVE")return!1;const{sourceCoords:s,payload:d,isDeployAbility:l,readyStatusToRemove:c}=a;return!s||!(Math.abs(t.row-s.row)+Math.abs(t.col-s.col)===1)?!1:d!=null&&d.selectedCard?(n({card:d.selectedCard,source:"discard"},{target:"board",boardCoords:t}),o(s,l,!1,c),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0):!1}function qs(e,t,r){const{abilityMode:a,gameState:n,moveItem:o,markAbilityUsed:i,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:l}=r;if(!a||a.mode!=="INTEGRATOR_LINE_SELECT")return!1;const{sourceCoords:c,sourceCard:A,isDeployAbility:f,readyStatusToRemove:b}=a,R=(A==null?void 0:A.ownerId)||0,I=t.row===c.row,g=t.col===c.col;if(!I&&!g)return!1;let u=0;if(I)for(let D=0;D<n.board.length;D++){const E=n.board[t.row][D].card;E!=null&&E.statuses&&(u+=E.statuses.filter(h=>h.type==="Exploit"&&h.addedByPlayerId===R).length)}else for(let D=0;D<n.board.length;D++){const E=n.board[D][t.col].card;D!==c.row&&E!=null&&E.statuses&&(u+=E.statuses.filter(h=>h.type==="Exploit"&&h.addedByPlayerId===R).length)}return u>0&&(s(R,u),d({row:c.row,col:c.col,text:`+${u}`,playerId:R})),i(c||t,f,!1,b),setTimeout(()=>l(null),oe.MODE_CLEAR_DELAY),!0}function js(e,t,r){const{abilityMode:a,gameState:n,updatePlayerScore:o,triggerFloatingText:i,markAbilityUsed:s,setAbilityMode:d}=r;if(!a||a.mode!=="IP_AGENT_THREAT_SCORING")return!1;const{sourceCoords:l,sourceCard:c,isDeployAbility:A,readyStatusToRemove:f}=a,b=(c==null?void 0:c.ownerId)||0,R=t.row===l.row,I=t.col===l.col;if(!R&&!I)return!1;let g=0;if(R)for(let D=0;D<n.board.length;D++){const E=n.board[t.row][D].card;E!=null&&E.statuses&&(g+=E.statuses.filter(h=>h.type==="Threat"&&h.addedByPlayerId===b).length)}else for(let D=0;D<n.board.length;D++){const E=n.board[D][t.col].card;D!==l.row&&E!=null&&E.statuses&&(g+=E.statuses.filter(h=>h.type==="Threat"&&h.addedByPlayerId===b).length)}const u=g*2;return u>0&&(o(b,u),i({row:l.row,col:l.col,text:`+${u}`,playerId:b})),s(l||t,A,!1,f),setTimeout(()=>d(null),oe.MODE_CLEAR_DELAY),!0}function Vs(e,t,r){const{abilityMode:a,gameState:n,commandContext:o,updatePlayerScore:i,triggerFloatingText:s,markAbilityUsed:d,setAbilityMode:l}=r;if(!a||a.mode!=="ZIUS_LINE_SELECT")return!1;const{sourceCoords:c,sourceCard:A,isDeployAbility:f,readyStatusToRemove:b}=a,R=(A==null?void 0:A.ownerId)||0,I=o.lastMovedCardCoords||c,g=t.row===I.row,u=t.col===I.col;if(!g&&!u)return!1;let D=0;const E=[];if(g)for(let h=0;h<n.board.length;h++){const w=n.board[t.row][h].card;if(w!=null&&w.statuses){const T=w.statuses.filter(N=>N.type==="Exploit"&&N.addedByPlayerId===R);D+=T.length,T.length>0&&E.push({row:t.row,col:h})}}else for(let h=0;h<n.board.length;h++){const w=n.board[h][t.col].card;if(h!==I.row&&w!=null&&w.statuses){const T=w.statuses.filter(N=>N.type==="Exploit"&&N.addedByPlayerId===R);D+=T.length,T.length>0&&E.push({row:h,col:t.col})}}return D>0&&(i(R,D),E.forEach(h=>{s({row:h.row,col:h.col,text:"+1",playerId:R})})),d(c||t,f,!1,b),setTimeout(()=>l(null),oe.MODE_CLEAR_DELAY),!0}function Js(e,t,r){var L;const{abilityMode:a,gameState:n,moveItem:o,markAbilityUsed:i,updatePlayerScore:s,triggerFloatingText:d,setAbilityMode:l,payload:c}=r;if(!a||a.mode!=="SELECT_DIAGONAL")return!1;const{sourceCoords:A,sourceCard:f,isDeployAbility:b,readyStatusToRemove:R}=a,I=(f==null?void 0:f.ownerId)||0,{row:g,col:u}=t,{row:D,col:E}=A||{row:0,col:0},h=g-u===D-E,w=g+u===D+E;if(!h&&!w)return!1;if(c!=null&&c.selectForMove&&e)return c.chainedAction&&r.handleActionExecution(c.chainedAction,t),!0;let T=0;const N=n.board.length;if(h){const M=D-E;for(let _=0;_<N;_++){const m=M+_,v=_;if(m>=0&&m<N&&v>=0&&v<N){const G=n.board[m][v].card;G!=null&&G.statuses&&(T+=G.statuses.filter(C=>C.type==="Exploit"&&C.addedByPlayerId===I).length)}}}if(w){const M=D+E;for(let _=0;_<N;_++){const m=_,v=M-m;if(m>=0&&m<N&&v>=0&&v<N){const G=n.board[m][v].card;G!=null&&G.statuses&&(T+=G.statuses.filter(C=>C.type==="Exploit"&&C.addedByPlayerId===I).length)}}}return c!=null&&c.bonusForSupport&&((L=f==null?void 0:f.statuses)!=null&&L.some(M=>M.type==="Support"))&&(T+=c.bonusForSupport),T>0&&(s(I,T),d({row:(A==null?void 0:A.row)||t.row,col:(A==null?void 0:A.col)||t.col,text:`+${T}`,playerId:I})),i(A||t,b,!1,R),setTimeout(()=>l(null),oe.MODE_CLEAR_DELAY),!0}function Xs(e,t,r){const{abilityMode:a,gameState:n,commandContext:o,moveItem:i,markAbilityUsed:s,updatePlayerScore:d,triggerFloatingText:l,setAbilityMode:c}=r;if(!a||a.mode!=="SCORE_LAST_PLAYED_LINE")return!1;const{sourceCoords:A,sourceCard:f,isDeployAbility:b,readyStatusToRemove:R,payload:I}=a,g=(f==null?void 0:f.ownerId)||0,u=o.lastMovedCardCoords;if(!u)return!1;const D=n.board[u.row][u.col].card;if(!D)return!1;const E=t.row===u.row,h=t.col===u.col;if(!E&&!h)return!1;const w=Math.max(0,D.power+(D.powerModifier||0));return(I==null?void 0:I.rewardType)==="SCORE"?(d(g,w),l({row:u.row,col:u.col,text:`+${w}`,playerId:g})):I==null||I.rewardType,s(A||t,b,!1,R),setTimeout(()=>c(null),oe.MODE_CLEAR_DELAY),!0}function Zs(e,t,r){const{abilityMode:a,setViewingDiscard:n,markAbilityUsed:o,setAbilityMode:i}=r;if(!a||a.mode!=="SEARCH_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:l}=a;return n(!0),o(s||t,d,!1,l),i(null),!0}function Qs(e,t,r){const{abilityMode:a,setViewingDiscard:n,markAbilityUsed:o,setAbilityMode:i}=r;if(!a||a.mode!=="RETRIEVE_DEVICE")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:l}=a;return n(!0),o(s||t,d,!1,l),i(null),!0}function ei(e,t,r){const{abilityMode:a,triggerDeckSelection:n,markAbilityUsed:o,setAbilityMode:i}=r;if(!a||a.mode!=="SELECT_DECK")return!1;const{sourceCoords:s,isDeployAbility:d,readyStatusToRemove:l}=a;return n(e.ownerId),o(s||t,d,!1,l),setTimeout(()=>i(null),oe.MODE_CLEAR_DELAY),!0}function wa(e,t,r){const a=e.players.find(o=>o.id===t),n=e.players.find(o=>o.id===r);return!a||!n?!1:a.teamId!==void 0&&n.teamId!==void 0&&a.teamId===n.teamId}const Ai=({gameState:e,localPlayerId:t,abilityMode:r,setAbilityMode:a,cursorStack:n,setCursorStack:o,commandContext:i,setCommandContext:s,setViewingDiscard:d,triggerNoTarget:l,triggerTargetSelection:c,playMode:A,setPlayMode:f,setCounterSelectionData:b,interactionLock:R,onAbilityComplete:I,updateState:g,moveItem:u,drawCard:D,drawCardsBatch:E,updatePlayerScore:h,markAbilityUsed:w,applyGlobalEffect:T,swapCards:N,transferStatus:L,transferAllCounters:M,resurrectDiscardedCard:_,spawnToken:m,scoreLine:v,nextPhase:G,modifyBoardCardPower:C,addBoardCardStatus:O,removeBoardCardStatus:$,removeBoardCardStatusByOwner:B,resetDeployStatus:X,scoreDiagonal:q,removeStatusByType:K,triggerFloatingText:V,triggerHandCardSelection:te,clearValidTargets:J,setTargetingMode:ge,clearTargetingMode:Ee,validTargets:_e})=>{const ke=U.useRef(()=>{}),De=U.useCallback(Oe=>{Os(Oe,{gameState:e,localPlayerId:t,abilityMode:r,interactionLock:R,setAbilityMode:a,markAbilityUsed:w,updatePlayerScore:h,triggerFloatingText:V,nextPhase:G,modifyBoardCardPower:C,scoreLine:v,scoreDiagonal:q,commandContext:i})},[r,e,t,R,a,w,h,V,G,C,v,q,i]);ke.current=De;const be=U.useCallback((Oe,xe)=>{_s(Oe,xe,{gameState:e,localPlayerId:t,setAbilityMode:a,setCursorStack:o,commandContext:i,markAbilityUsed:w,triggerNoTarget:l,handleActionExecution:be,modifyBoardCardPower:C,addBoardCardStatus:O,removeBoardCardStatus:$,removeStatusByType:K,updatePlayerScore:h,triggerFloatingText:V,setViewingDiscard:d,handleLineSelection:ke.current,onAbilityComplete:I,applyGlobalEffect:T,drawCardsBatch:E,setTargetingMode:ge})},[e,t,r,a,n,o,i,s,f,w,l,R,u,N,L,M,m,C,O,$,B,K,X,h,V,b,d,_e,I,T,E,ge]);U.useEffect(()=>{(r==null?void 0:r.type)==="GLOBAL_AUTO_APPLY"&&(be(r,r.sourceCoords||{row:-1,col:-1}),a(null))},[r,be,a]),U.useEffect(()=>{r||Ee()},[r,Ee]);const Be=U.useCallback((Oe,xe)=>{Ta(Oe,xe,{gameState:e,localPlayerId:t,abilityMode:r,cursorStack:n,handleActionExecution:be,markAbilityUsed:w})},[e,t,r,n,be,w]),Lt=U.useCallback((Oe,xe)=>{var Ve,Qe;if(n&&f!==null&&f!==void 0){const et={targetOwnerId:n.targetOwnerId,excludeOwnerId:n.excludeOwnerId,onlyOpponents:n.onlyOpponents||n.targetOwnerId===-1,onlyFaceDown:n.onlyFaceDown,targetType:n.targetType,requiredTargetStatus:n.requiredTargetStatus,tokenType:n.type};if(st({card:Oe,ownerId:Oe.ownerId??0,location:"board"},et,e.activePlayerId,e.players)){if(n.type==="Revealed"){const tt=((Ve=n.sourceCard)==null?void 0:Ve.ownerId)??e.activePlayerId??t??1;if((Qe=Oe.statuses)==null?void 0:Qe.some(we=>we.type==="Revealed"&&we.addedByPlayerId===tt))return}u({card:{id:"dummy",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",statusType:n.type,count:1},{target:"board",boardCoords:xe}),n.sourceCoords&&n.sourceCoords.row>=0&&w(n.sourceCoords,n.isDeployAbility,!1,n.readyStatusToRemove),n.count>1?o(tt=>tt?{...tt,count:tt.count-1}:null):(Ee(),J(),n.chainedAction&&be(n.chainedAction,n.sourceCoords||{row:-1,col:-1}),o(null))}return}if(!R.current){if(!r&&!n&&e.isGameStarted&&Ca(Oe,e)){Be(Oe,xe);return}if(r&&(r.mode==="SCORE_LAST_PLAYED_LINE"||r.mode==="SELECT_LINE_END")){De(xe);return}(r==null?void 0:r.type)==="ENTER_MODE"&&vs(Oe,xe,{gameState:e,localPlayerId:t,abilityMode:r,setAbilityMode:a,cursorStack:n,setCursorStack:o,commandContext:i,setCommandContext:s,playMode:null,setPlayMode:f,draggedItem:null,setDraggedItem:()=>{},openContextMenu:()=>{},markAbilityUsed:w,triggerNoTarget:l,triggerTargetSelection:c,handleActionExecution:be,interactionLock:R,moveItem:u,swapCards:N,transferStatus:L,transferAllCounters:M,spawnToken:m,modifyBoardCardPower:C,addBoardCardStatus:O,removeBoardCardStatus:$,removeBoardCardStatusByOwner:B,removeStatusByType:K,resetDeployStatus:X,updatePlayerScore:h,triggerFloatingText:V,setCounterSelectionData:b,setViewingDiscard:d,clearValidTargets:J,validTargets:_e,handleLineSelection:De})||!r&&!n&&Be(Oe,xe)}},[n,f,e,t,R,r,De,u,w,o,be,a,s,b,d,m,N,L,M,C,O,$,B,K,X,h,V,l,c,_e,Ee,Be]),dt=U.useCallback(Oe=>{Ds(Oe,{gameState:e,localPlayerId:t,abilityMode:r,setAbilityMode:a,cursorStack:n,commandContext:i,setCommandContext:s,playMode:A,draggedItem:null,interactionLock:R,handleActionExecution:be,handleDrop:u,moveItem:u,setCursorStack:o,triggerNoTarget:l,markAbilityUsed:w,spawnToken:m,resurrectDiscardedCard:_,updatePlayerScore:h,triggerFloatingText:V,handleLineSelection:De,openContextMenu:()=>{},triggerDeckSelection:()=>{}})},[e,t,r,a,n,i,s,A,R,be,u,o,l,w,m,_,h,V,De]),Ke=U.useCallback((Oe,xe,Ve)=>{Ps(Oe,xe,Ve,{gameState:e,localPlayerId:t,abilityMode:r,cursorStack:n,interactionLock:R,setCommandContext:s,setAbilityMode:a,moveItem:u,markAbilityUsed:w,handleActionExecution:be,triggerHandCardSelection:te,setCursorStack:o,clearTargetingMode:Ee})},[r,n,e,t,be,w,a,s,te,u,o,Ee,J,R]),z=U.useCallback((Oe,xe)=>{ks(Oe,xe,{abilityMode:r,cursorStack:n,gameState:e,activateAbility:(Ve,Qe)=>Ta(Ve,Qe,{gameState:e,localPlayerId:t,abilityMode:r,cursorStack:n,handleActionExecution:be,markAbilityUsed:w})})},[r,n,e,t,be,w]);return{activateAbility:Be,executeAction:be,handleLineSelection:De,handleBoardCardClick:Lt,handleEmptyCellClick:dt,handleHandCardClick:Ke,handleAnnouncedCardDoubleClick:z}},Vt=(e,t,r,a,n)=>{const o=(r.baseId||e.split("_")[1]||e).toLowerCase(),i=t===-1,s=[];o==="overwatch"?i?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},targetOwnerId:-1,onlyOpponents:!0,sourceCard:r}):t===1&&s.push({type:"GLOBAL_AUTO_APPLY",payload:{dynamicResource:{type:"draw",factor:"Aim",ownerId:n,baseCount:0}},sourceCard:r}):o==="tacticalmaneuver"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:l=>l.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"DRAW_MOVED_POWER"},sourceCard:r}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",recordContext:!0,sourceCard:r,payload:{range:"line",filter:l=>l.ownerId===n,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{contextReward:"SCORE_MOVED_POWER"},sourceCard:r}}}):o==="inspiration"?i&&s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"OPEN_COUNTER_MODAL",filter:l=>l.ownerId===n}}):o==="datainterception"?i?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Exploit",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:l=>{var c;return((c=l.statuses)==null?void 0:c.some(A=>A.type==="Exploit"&&A.addedByPlayerId===n))||!1}}}):o==="falseorders"?i?s.push({type:"CREATE_STACK",tokenType:"Exploit",count:1,sourceCard:r,targetType:"Unit",onlyOpponents:!0,recordContext:!0}):t===0?s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"CREATE_STACK",tokenType:"Revealed",count:2,onlyOpponents:!0,onlyFaceDown:!0,excludeOwnerId:n,sourceCard:r,originalOwnerId:r.ownerId}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_CELL",sourceCard:r,recordContext:!0,payload:{range:2,useContextCard:!0,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{tokenType:"Stun",count:2,ownerId:n}}}}):o==="experimentalstimulants"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"RESET_DEPLOY",filter:l=>{var c;return l.ownerId===n&&((c=l.types)==null?void 0:c.includes("Unit"))}}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:"line",filter:l=>l.ownerId===n}}):o==="logisticschain"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"point_per_support",skipNextPhase:!0}}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_DIAGONAL",sourceCard:r,payload:{actionType:"SCORE_DIAGONAL",bonusType:"draw_per_support",skipNextPhase:!0}}):o==="quickresponseteam"?t===0?s.push({type:"ENTER_MODE",mode:"SELECT_TARGET",sourceCard:r,payload:{actionType:"SELECT_HAND_FOR_DEPLOY",filter:l=>{var c;return l.ownerId===n&&((c=l.types)==null?void 0:c.includes("Unit"))}}}):t===1&&s.push({type:"OPEN_MODAL",mode:"SEARCH_DECK",sourceCard:r,payload:{filterType:"Unit"}}):o==="temporaryshelter"?t===0?s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:r,chainedAction:{type:"GLOBAL_AUTO_APPLY",payload:{customAction:"REMOVE_ALL_AIM_FROM_CONTEXT"}}}):t===1&&s.push({type:"CREATE_STACK",tokenType:"Shield",count:1,targetOwnerId:n,recordContext:!0,sourceCard:r,chainedAction:{type:"ENTER_MODE",mode:"SELECT_CELL",payload:{range:2,useContextCard:!0}}}):o==="enhancedinterrogation"?i?s.push({type:"CREATE_STACK",tokenType:"Aim",count:1,sourceCard:r}):t===0?s.push({type:"CREATE_STACK",tokenType:"Revealed",dynamicCount:{factor:"Aim",ownerId:n},onlyFaceDown:!0,onlyOpponents:!0,targetOwnerId:-1,sourceCard:r}):t===1&&s.push({type:"ENTER_MODE",mode:"SELECT_UNIT_FOR_MOVE",sourceCard:r,payload:{range:2,filter:l=>{var c;return((c=l.statuses)==null?void 0:c.some(A=>A.type==="Aim"&&A.addedByPlayerId===n))||!1}}}):(o==="mobilization1"||o==="linebreach")&&i&&s.push({type:"ENTER_MODE",mode:"SELECT_LINE_START",sourceCard:r,payload:{actionType:"SCORE_LINE"}});const d=r.ownerId||n;return s.forEach(l=>{l.originalOwnerId=d,l.sourceCard&&!l.sourceCard.ownerId&&(l.sourceCard.ownerId=d)}),s},Ci=({gameState:e,localPlayerId:t,setActionQueue:r,setCommandContext:a,setCommandModalCard:n,setCounterSelectionData:o,moveItem:i,updatePlayerScore:s,updateState:d})=>{const l=U.useCallback((f,b)=>{if(t===null)return;const R=e.players.find(D=>D.id===b.playerId);if(!(b.playerId===t||(R==null?void 0:R.isDummy)))return;i(b,{target:"announced",playerId:b.playerId}),a({});const g=(f.baseId||f.id.split("_")[1]||f.id).toLowerCase();if(["overwatch","tacticalmaneuver","repositioning","inspiration","datainterception","falseorders","experimentalstimulants","logisticschain","quickresponseteam","temporaryshelter","enhancedinterrogation"].some(D=>g.includes(D)))n(f);else{const D=Vt(f.id,-1,f,e,b.playerId);D.length>0?r([...D,{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:f,ownerId:b.playerId},sourceCard:f}]):r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:f,ownerId:b.playerId},sourceCard:f}])}},[e,t,i,r,a,n]),c=U.useCallback((f,b)=>{var E,h;if(!b||t===null)return;const R=b.ownerId||t,I=[],g=Vt(b.id,-1,b,e,R);let u;(E=b.baseId)!=null&&E.toLowerCase().includes("inspiration")&&(u=f===0?"DRAW_REMOVED":"SCORE_REMOVED",g.length>0&&g[0].type==="ENTER_MODE"&&(g[0]={...g[0],payload:{...g[0].payload,rewardType:u}})),g.forEach(w=>{I.push(w)}),Vt(b.id,f,b,e,R).forEach(w=>{I.push(w)}),(h=b.baseId)!=null&&h.toLowerCase().includes("inspiration")||I.push({type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:b,ownerId:R},sourceCard:b}),r(I),n(null)},[e,t,r,n]),A=U.useCallback((f,b)=>{var u;if(t===null)return;const R=b.card.ownerId||t;let I=null;for(let D=0;D<e.board.length;D++){for(let E=0;E<e.board[D].length;E++)if(((u=e.board[D][E].card)==null?void 0:u.id)===b.card.id){I={row:D,col:E};break}if(I)break}if(!I){y.warn(`Card ${b.card.id} not found on board during counter removal`),o(null);return}if(d(D=>{if(!D.isGameStarted)return D;const E=Ie(D),h=E.board[I.row][I.col].card;let w=0;const T=(h==null?void 0:h.statuses)??[];if(Object.entries(f).forEach(([N,L])=>{for(let M=0;M<L;M++){const _=T.map(m=>m.type).lastIndexOf(N);_>-1&&(h!=null&&h.statuses)&&(h.statuses.splice(_,1),w++)}}),!(h!=null&&h.statuses)&&h&&(h.statuses=[]),E.board=Le(E),w>0&&b.callbackAction==="DRAW_REMOVED"){const N=E.players.find(L=>L.id===R);if(N){const L=Math.min(w,N.deck.length);for(let M=0;M<L;M++){const _=N.deck.shift();_&&N.hand.push(_)}}}return E}),b.callbackAction==="SCORE_REMOVED"){const D=Object.values(f).reduce((E,h)=>E+h,0);D>0&&s(R,D)}const g=e.players.find(D=>D.id===R);g!=null&&g.announcedCard&&r([{type:"GLOBAL_AUTO_APPLY",payload:{cleanupCommand:!0,card:g.announcedCard,ownerId:R},sourceCard:g.announcedCard}]),o(null)},[t,s,r,o,e,d]);return{playCommandCard:l,handleCommandConfirm:c,handleCounterSelectionConfirm:A}},Ri=({gameState:e,localPlayerId:t,handleDrop:r,markAbilityUsed:a,requestCardReveal:n,interactionLock:o,setCommandContext:i,onAction:s,cursorStack:d,setCursorStack:l,setAbilityMode:c,triggerTargetSelection:A})=>{const f=U.useRef(null),b=U.useRef({x:0,y:0});return U.useLayoutEffect(()=>{if(d&&f.current){const{x:I,y:g}=b.current;f.current.style.transform=`translate(${I-24}px, ${g-24}px)`}},[d]),U.useEffect(()=>{const I=g=>{b.current={x:g.clientX,y:g.clientY},f.current&&(f.current.style.transform=`translate(${g.clientX-24}px, ${g.clientY-24}px)`)};return window.addEventListener("mousemove",I),()=>window.removeEventListener("mousemove",I)},[]),U.useEffect(()=>{const I=g=>{var h,w,T,N,L,M,_;if(g.button!==0||!d)return;const u=document.elementFromPoint(g.clientX,g.clientY);let D=t;if(d.originalOwnerId!==void 0)D=d.originalOwnerId;else if((h=d.sourceCard)!=null&&h.ownerId)D=d.sourceCard.ownerId;else if(d.sourceCoords&&d.sourceCoords.row>=0){const{row:m,col:v}=d.sourceCoords;if(m>=0&&m<e.board.length&&v>=0&&v<((w=e.board[m])==null?void 0:w.length)){const G=e.board[m][v].card;G&&(D=G.ownerId||t)}}else if(e.activePlayerId){const m=e.players.find(v=>v.id===e.activePlayerId);m!=null&&m.isDummy&&(D=m.id)}let E=u==null?void 0:u.closest("[data-hand-card]");if(!E&&u)if(u.getAttribute("data-hand-card"))E=u;else{const m=u.querySelectorAll("[data-hand-card]");if(m.length>0){let v=1/0,G=null;const C=g.clientX,O=g.clientY;for(const $ of Array.from(m)){const B=$.getBoundingClientRect();if(C>=B.left&&C<=B.right&&O>=B.top&&O<=B.bottom){const X=B.left+B.width/2,q=B.top+B.height/2,K=Math.hypot(C-X,O-q);K<v&&(v=K,G=$)}}E=G}}if(E){const m=E.getAttribute("data-hand-card");if(m){const[v,G]=m.split(","),C=parseInt(v,10),O=parseInt(G,10),$=e.players.find(X=>X.id===C),B=$==null?void 0:$.hand[O];if($&&B){if(d.type==="Revealed"&&!$.isDummy){if((T=B.statuses)==null?void 0:T.some(te=>te.type==="Revealed"&&te.addedByPlayerId===D))return;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((N=d.sourceCard)==null?void 0:N.ownerId)??D??void 0,statusType:d.type,count:1},{target:"hand",playerId:C,cardIndex:O,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&a(d.sourceCoords,d.isDeployAbility),d.count>1?l(te=>te?{...te,count:te.count-1}:null):(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),l(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}const q={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,tokenType:d.type};if(!st({card:B,ownerId:C,location:"hand"},q,D,e.players))return;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((L=d.sourceCard)==null?void 0:L.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:1},{target:"hand",playerId:C,cardIndex:O,boardCoords:void 0}),d.sourceCoords&&d.sourceCoords.row>=0&&a(d.sourceCoords,d.isDeployAbility),d.count>1?l(V=>V?{...V,count:V.count-1}:null):(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),l(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}}if(!E){const m=u==null?void 0:u.closest("[data-board-coords]");if(m){const v=m.getAttribute("data-board-coords");if(v){const[G,C]=v.split(","),O=parseInt(G,10),$=parseInt(C,10);if(!isNaN(O)&&!isNaN($)&&O>=0&&O<e.board.length&&e.board[O]&&$>=0&&$<e.board[O].length&&e.board[O][$]){const B=e.board[O][$].card;if((B==null?void 0:B.ownerId)!==void 0){const X={targetOwnerId:d.targetOwnerId,excludeOwnerId:d.excludeOwnerId,onlyOpponents:d.onlyOpponents||d.targetOwnerId===-1,onlyFaceDown:d.onlyFaceDown,targetType:d.targetType,requiredTargetStatus:d.requiredTargetStatus,mustBeAdjacentToSource:d.mustBeAdjacentToSource,mustBeInLineWithSource:d.mustBeInLineWithSource,sourceCoords:d.sourceCoords,tokenType:d.type};if(!st({card:B,ownerId:B.ownerId,location:"board",boardCoords:{row:O,col:$}},X,D,e.players))return;const K=e.players.find(V=>V.id===B.ownerId);if(d.type==="Revealed"&&!(K!=null&&K.isDummy)){if(B.ownerId===t||!B.isFaceDown||((M=B.statuses)==null?void 0:M.some(te=>te.type==="Revealed"&&te.addedByPlayerId===D)))return;t!==null&&n({source:"board",ownerId:B.ownerId,boardCoords:{row:O,col:$}},t),d.sourceCoords&&d.sourceCoords.row>=0&&a(d.sourceCoords,d.isDeployAbility),d.count>1?l(te=>te?{...te,count:te.count-1}:null):(d.chainedAction&&s(d.chainedAction,d.sourceCoords||{row:-1,col:-1}),l(null)),o.current=!0,setTimeout(()=>{o.current=!1},300);return}}if(B){const X=d.placeAllAtOnce?d.count:1;r({card:{id:"stack",deck:"counter",name:"",imageUrl:"",fallbackImage:"",power:0,ability:"",types:[]},source:"counter_panel",ownerId:d.originalOwnerId??((_=d.sourceCard)==null?void 0:_.ownerId),statusType:d.type,replaceStatusType:d.replaceStatus?d.requiredTargetStatus:void 0,count:X},{target:"board",boardCoords:{row:O,col:$}}),A("board",{row:O,col:$}),d.recordContext&&i(K=>({...K,lastMovedCardCoords:{row:O,col:$},lastMovedCardId:B.id})),d.sourceCoords&&d.sourceCoords.row>=0&&a(d.sourceCoords,d.isDeployAbility);const q=d.count-X;if(q>0)l(K=>K?{...K,count:q}:null);else{if(d.chainedAction){const K={...d.chainedAction};d.recordContext&&(K.mode==="SELECT_CELL"&&(K.sourceCard=B,K.sourceCoords={row:O,col:$},K.recordContext=!0),K.type==="GLOBAL_AUTO_APPLY"&&(K.sourceCoords={row:O,col:$}),K.type==="CREATE_STACK"&&(K.sourceCoords={row:O,col:$},K.originalOwnerId||(K.sourceCard=B)),K.mode==="ZIUS_LINE_SELECT"&&(K.sourceCoords={row:O,col:$})),K.type==="CREATE_STACK"&&c(null),s(K,{row:O,col:$})}l(null)}o.current=!0,setTimeout(()=>{o.current=!1},300)}}}}else{const v=u==null?void 0:u.closest(".counter-modal-content"),G=(u==null?void 0:u.closest("[data-board-coords]"))!==null,C=(u==null?void 0:u.closest("[data-hand-card]"))!==null;d.isDragging?v?l(O=>O?{...O,isDragging:!1}:null):!G&&!C&&l(null):!v&&!G&&!C&&l(null)}}};return window.addEventListener("mouseup",I),()=>{window.removeEventListener("mouseup",I)}},[d,r,e,t,n,a,o,i,s,l,c,A]),U.useEffect(()=>{const I=g=>{d&&(g.preventDefault(),l(null))};return window.addEventListener("contextmenu",I),()=>{window.removeEventListener("contextmenu",I)}},[d,l]),{cursorFollowerRef:f,handleCounterMouseDown:(I,g)=>{b.current={x:g.clientX,y:g.clientY},l(u=>(u==null?void 0:u.type)===I?{type:I,count:u.count+1,isDragging:!0,sourceCoords:u.sourceCoords}:{type:I,count:1,isDragging:!0})}}};export{Mt as A,Ti as B,Si as C,ci as D,Ci as E,ui as F,di as G,Ai as H,Ri as I,ni as J,Nt as K,Vt as L,go as M,st as N,bt as O,li as P,ir as Q,oi as R,pi as S,oe as T,To as U,ht as a,hi as b,er as c,Re as d,wo as e,mi as f,Ye as g,Ca as h,si as i,Io as j,Ei as k,y as l,Qt as m,ve as n,fi as o,Eo as p,_o as q,Ii as r,ii as s,mo as t,yi as u,_i as v,bi as w,wi as x,gi as y,rt as z};
